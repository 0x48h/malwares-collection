<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>poly_engine2.inc</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;---------------------------------------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                               __         __               ___ __  ___                                   ;</span><span class="sc0">
</span><span class="sc1">;                              /  )_ _ /  /__)_     / _ _/ (_  /  )(_                                     ;</span><span class="sc0">
</span><span class="sc1">;                             /(_/(// /( /   / ()/)/)(- /  /__(__/ /                                      ; </span><span class="sc0">
</span><span class="sc1">;                                               /                                                         ;</span><span class="sc0">
</span><span class="sc1">;                                                     ; </span><span class="sc0">
</span><span class="sc1">;                                           __                                                            ;</span><span class="sc0">
</span><span class="sc1">;                                          /__)_ _  _ _  _/                                               ;</span><span class="sc0">
</span><span class="sc1">;                                         /   / (-_) (-/)/                                                ;    </span><span class="sc0">
</span><span class="sc1">;                                                                                                         ;</span><span class="sc0">
</span><span class="sc1">;                                                         ; </span><span class="sc0">
</span><span class="sc1">;              _____       ___     ___                                                                    ;</span><span class="sc0">
</span><span class="sc1">;             /\  __`\   /'___\  /'___\                          __                                       ; </span><span class="sc0">
</span><span class="sc1">;             \ \ \/\ \ /\ \__/ /\ \__/    __     ___      ____ /\_\   __  __     __                      ;</span><span class="sc0">
</span><span class="sc1">;              \ \ \ \ \\ \ ,__\\ \ ,__\ /'__`\ /' _ `\   /',__\\/\ \ /\ \/\ \  /'__`\                    ;</span><span class="sc0">
</span><span class="sc1">;               \ \ \_\ \\ \ \_/ \ \ \_//\  __/ /\ \/\ \ /\__, `\\ \ \\ \ \_/ |/\  __/                    ;</span><span class="sc0">
</span><span class="sc1">;                \ \_____\\ \_\   \ \_\ \ \____\\ \_\ \_\\/\____/ \ \_\\ \___/ \ \____\                   ;</span><span class="sc0">
</span><span class="sc1">;                 \/_____/ \/_/    \/_/  \/____/ \/_/\/_/ \/___/   \/_/ \/__/   \/____/                   ;</span><span class="sc0">
</span><span class="sc1">;                                                                                                         ; </span><span class="sc0">
</span><span class="sc1">;                                                                                                         ;</span><span class="sc0">
</span><span class="sc1">;  ____         ___                ____                                                    ___            ;</span><span class="sc0">
</span><span class="sc1">; /\  _`\      /\_ \              /\  _`\                     __                         /'___`\          ;</span><span class="sc0">
</span><span class="sc1">; \ \ \L\ \ ___\//\ \    __  __   \ \ \L\_\    ___       __  /\_\     ___       __      /\_\ /\ \         ;</span><span class="sc0">
</span><span class="sc1">;  \ \ ,__// __`\\ \ \  /\ \/\ \   \ \  _\L  /' _ `\   /'_ `\\/\ \  /' _ `\   /'__`\    \/_/// /__        ;</span><span class="sc0">
</span><span class="sc1">;   \ \ \//\ \L\ \\_\ \_\ \ \_\ \   \ \ \L\ \/\ \/\ \ /\ \L\ \\ \ \ /\ \/\ \ /\  __/       // /_\ \       ;</span><span class="sc0">
</span><span class="sc1">;    \ \_\\ \____//\____\\/`____ \   \ \____/\ \_\ \_\\ \____ \\ \_\\ \_\ \_\\ \____\     /\______/       ;</span><span class="sc0">
</span><span class="sc1">;     \/_/ \/___/ \/____/ `/___/&gt; \   \/___/  \/_/\/_/ \/___L\ \\/_/ \/_/\/_/ \/____/     \/_____/        ;</span><span class="sc0">
</span><span class="sc1">;                            /\___/                      /\____/                                          ;</span><span class="sc0">
</span><span class="sc1">;                            \/__/                       \_/__/                                           ;</span><span class="sc0">
</span><span class="sc1">;                                                                                                         ;</span><span class="sc0">
</span><span class="sc1">;                                                                 ; </span><span class="sc0">
</span><span class="sc1">;                                                     ;                 </span><span class="sc0">
</span><span class="sc1">;v0.8 (beta) public version                                       ;     </span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; Ring3/0 Polymorphic Decryptor Creator </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Features </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Generates:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Memory Read/Write </span><span class="sc0">
</span><span class="sc1">;Loops , Predicates</span><span class="sc0">
</span><span class="sc1">;Subroutines</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Realistic Garbage</span><span class="sc0">
</span><span class="sc1">;Position Independent</span><span class="sc0">
</span><span class="sc1">;Sliding Key  </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is not final version. Many improvements are planned. (Apis , PRIDE , SSE/FPU instructions)</span><span class="sc0">
</span><span class="sc1">;Watch eof-project.net or vx.netlux.org for new releases</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;Prophet/EOF(24.8.2009)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">poly_vars</span><span class="sc0"> </span><span class="sc9">struct</span><span class="sc0">
                    </span><span class="sc1">; VARIABLES INITIALIZED BEFORE POLY CALL</span><span class="sc0">
                    </span><span class="sc5">poly_ptr_code_base_va</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   virtual-address of encrypted code </span><span class="sc0">
                    </span><span class="sc5">poly_ptr_code_base_raw</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   raw-address of encrypted code</span><span class="sc0">
                    </span><span class="sc5">poly_ptr_decrypt_buf_va</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   Va of buffer where code will be decrypted (0 if dont move code)</span><span class="sc0">
                    </span><span class="sc5">poly_code_size</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   size of code to crypt</span><span class="sc0">
                    </span><span class="sc5">poly_code_entry_offset</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   ep offset relative to code_base_va  </span><span class="sc0">
                    </span><span class="sc5">poly_decryptor_base</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   ptr to buffer where decrytor will be created</span><span class="sc0">
                    </span><span class="sc5">poly_decryptor_base_va</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   virtual-address of decryptor base   </span><span class="sc0">
                    </span><span class="sc5">poly_decryptor_size</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   size of created decryptor </span><span class="sc0">
                    </span><span class="sc5">poly_options</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   poly options </span><span class="sc0">
                    </span><span class="sc5">poly_garbage_level</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   level of garbage (1-lowest 3-average 5-huge)</span><span class="sc0">
                    </span><span class="sc5">poly_read_mem_base</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   va address of readable memory </span><span class="sc0">
                    </span><span class="sc5">poly_read_mem_size</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   size of readable memory </span><span class="sc0">
    
                    </span><span class="sc1">; VARIABLES USED DURING POLY ENGINE RUN</span><span class="sc0">
                    </span><span class="sc5">poly_algo1</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   crypt algorythm</span><span class="sc0">
                    </span><span class="sc5">poly_algo2</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   key-sliding algorythm </span><span class="sc0">
                    </span><span class="sc5">poly_key</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   encrypt key</span><span class="sc0">
                    </span><span class="sc5">poly_slide_key</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   slide key </span><span class="sc0">
                    </span><span class="sc5">poly_ptr_reg</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   register used as ptr to memory</span><span class="sc0">
                    </span><span class="sc5">poly_key_reg</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   register which is keeping decrypt key </span><span class="sc0">
                    </span><span class="sc5">poly_loop_reg</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   loop counter</span><span class="sc0">
                    </span><span class="sc5">poly_store_reg</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   used in move-data loop </span><span class="sc0">
                    </span><span class="sc5">poly_junk_mem_reg</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   junk mem accesses ptr reg </span><span class="sc0">
                    </span><span class="sc5">poly_junk_mem_pos</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   value to which reg was initialized </span><span class="sc0">
                    </span><span class="sc5">poly_reg_usage</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   watch register usage      </span><span class="sc0">
                    </span><span class="sc5">poly_random_seed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   random seed</span><span class="sc0">
                    </span><span class="sc5">poly_garbler_flags</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   keep garbler state</span><span class="sc0">
                    </span><span class="sc5">poly_entry_offset</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   offset of poly entry-point relative to poly base </span><span class="sc0">
                    
                    </span><span class="sc5">poly_subroutines_count</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">;   number of poly subs generated </span><span class="sc0">
                    </span><span class="sc5">poly_subroutines_table</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">poly_vars</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Poly Options Flags </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                    
                    </span><span class="sc5">POLY_OPT_POS_INDEPENDENT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">;   use/dont use delta offset in decryptor </span><span class="sc0">
                    </span><span class="sc5">POLY_OPT_STACK_WRITES</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">;   (not implemented)</span><span class="sc0">
                    </span><span class="sc5">POLY_OPT_MEM_WRITES</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">      </span><span class="sc1">;   ( buggy ) </span><span class="sc0">
                    </span><span class="sc5">POLY_OPT_USE_SUBROUTINES</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">;   generate junk subroutines </span><span class="sc0">
                    </span><span class="sc5">POLY_OPT_MEM_ACC_DIRECT</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">16</span><span class="sc0">     </span><span class="sc1">;   do direct mem accesses (dont use if pe is reloc-able)</span><span class="sc0">
                    </span><span class="sc5">POLY_OPT_MINIMAL_GARBAGE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">32</span><span class="sc0">     </span><span class="sc1">;   generate minimal amount of garbage </span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Poly configuration  </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                   POLY_DEBUG              equ     1      ;   poly-debugging regime (comment out to disable) </span><span class="sc0">
</span><span class="sc1">;                               POLY_DISABLE_GARBAGE    equ     1      ;   disable garbage generator (comment out to enable) </span><span class="sc0">
                    </span><span class="sc5">POLY_SUBROUTINES_MAX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0">      </span><span class="sc1">;   max count of poly subroutines </span><span class="sc0">
                    </span><span class="sc5">POLY_SUBR_PARAMS_MAX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">6</span><span class="sc0">      </span><span class="sc1">;   max count of sub arguments </span><span class="sc0">
</span><span class="sc1">;                   POLY_ALIGN_SUBR         equ     1      ;   align subroutines to 0fh (comment out to disable)</span><span class="sc0">
                    </span><span class="sc5">POLY_ALIGN_BYTE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0cch</span><span class="sc0">   </span><span class="sc1">;   alignment byte </span><span class="sc0">
                    </span><span class="sc5">POLY_ESP_ACC_RNG_MAX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">     </span><span class="sc1">;   max stack access displacement [esp +- random(max) * 4]</span><span class="sc0">
                    </span><span class="sc5">POLY_LOOP_ITERATION_MAX</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10000h</span><span class="sc0"> </span><span class="sc1">;   max loop iterations</span><span class="sc0">
                    </span><span class="sc5">POLY_LOOP_ITERATION_MIN</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1000h</span><span class="sc0">  </span><span class="sc1">;   min loop iterations </span><span class="sc0">
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Occurence of garbage </span><span class="sc0">
</span><span class="sc1">;               </span><span class="sc0">
                    </span><span class="sc5">POLY_OCCUR_LOOP</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc5">POLY_OCCUR_PREDICATE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0">
                    </span><span class="sc5">POLY_OCCUR_PUSH_POP</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">7</span><span class="sc0">
                    </span><span class="sc5">POLY_OCCUR_CALL</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc5">POLY_OCCUR_API</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;   not implemented</span><span class="sc0">
                    </span><span class="sc5">POLY_OCCUR_IMM</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0"> 
                    </span><span class="sc5">POLY_OCCUR_MODRM</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">
                    
                    </span><span class="sc5">POLY_OCCUR_COUNT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc0"> </span><span class="sc5">POLY_OCCUR_LOOP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">POLY_OCCUR_PREDICATE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">POLY_OCCUR_PUSH_POP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">POLY_OCCUR_CALL</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">POLY_OCCUR_API</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">POLY_OCCUR_IMM</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">POLY_OCCUR_MODRM</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0">
                    
                    </span><span class="sc5">POLY_MODRM_OCCUR_REG_REG</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc5">POLY_MODRM_OCCUR_MEM</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc5">POLY_MODRM_OCCUR_STACK</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                                        
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Garbler state flags</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

                    </span><span class="sc5">POLY_FLAG_IN_LOOP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; in loop </span><span class="sc0">
                    </span><span class="sc5">POLY_FLAG_IN_SUBR</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; in subroutine </span><span class="sc0">
                    </span><span class="sc5">POLY_FLAG_IN_PRED</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; in predicate </span><span class="sc0">

                    </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">:</span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">poly_vars</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">PolyEngineEntry</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">PolyEngine</span><span class="sc0">
                    
</span><span class="sc5">PolyGarbleInit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pushad</span><span class="sc0">
                    
                    </span><span class="sc1">; check if subroutines flag is set </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OPT_USE_SUBROUTINES</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Garble_Init_No_Sub</span><span class="sc0">
                                        
                    </span><span class="sc1">; create junk subroutines </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_SUBROUTINES_MAX</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">PolyGarbleInitEnd</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
</span><span class="sc5">Garble_Init_Loop1</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_funct</span><span class="sc0">                    
                    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Garble_Init_Loop1</span><span class="sc0">
                    
</span><span class="sc5">Garble_Init_No_Sub</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">PolyGarbleInitEnd</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">popad</span><span class="sc0"> 
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Garbage creator for use in poly engine </span><span class="sc0">
</span><span class="sc1">;                        </span><span class="sc0">
</span><span class="sc1">; ESP,EBP must be set as used before calling PolyGarbler </span><span class="sc0">

</span><span class="sc1">; ebp = ptr to poly struct</span><span class="sc0">
</span><span class="sc1">; edi = buffer  </span><span class="sc0">
</span><span class="sc5">PolyGarble</span><span class="sc4">:</span><span class="sc0">     
</span><span class="sc9">ifndef</span><span class="sc0"> </span><span class="sc5">POLY_DISABLE_GARBAGE</span><span class="sc0">
                    </span><span class="sc6">pushad</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OPT_MINIMAL_GARBAGE</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">PolyGarbleNormal</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">PolyGarbleCont1</span><span class="sc0">  

</span><span class="sc5">PolyGarbleNormal</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_garbage_level</span><span class="sc0"> </span><span class="sc1">; deepness of recursivity</span><span class="sc0">
                    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    
</span><span class="sc5">PolyGarbleCont1</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble</span><span class="sc0"> 
    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0"> </span><span class="sc1">;POLY_DISABLE_GARBAGE                   </span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Recursive Garbler </span><span class="sc0">
</span><span class="sc1">;                   </span><span class="sc0">

</span><span class="sc5">Garble</span><span class="sc4">:</span><span class="sc0">             
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_COUNT</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_PUSH_POP</span><span class="sc0">
                    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">G_Push_Pop</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_PUSH_POP</span><span class="sc0"> 
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_PREDICATE</span><span class="sc0">
                    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">G_Predicate</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_PREDICATE</span><span class="sc0"> 
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_LOOP</span><span class="sc0">
                    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">G_Loop</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_LOOP</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_CALL</span><span class="sc0">
                    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">G_Call</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_CALL</span><span class="sc0"> 
                    
</span><span class="sc1">;                   cmp eax,POLY_OCCUR_MODRM</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_IMM</span><span class="sc0">
                    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">G_Imm</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OCCUR_IMM</span><span class="sc0">  
                    
</span><span class="sc1">;                   cmp eax,POLY_OCCUR_API</span><span class="sc0">

                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Modrm</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_cont</span><span class="sc0">
                    
</span><span class="sc1">; loop </span><span class="sc0">
</span><span class="sc5">G_Loop</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Loop</span><span class="sc0">    
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_cont</span><span class="sc0">
                    
</span><span class="sc1">; opaque predicate                  </span><span class="sc0">
</span><span class="sc5">G_Predicate</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Predicate</span><span class="sc0">                   
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_cont</span><span class="sc0">

</span><span class="sc1">; push pop                  </span><span class="sc0">
</span><span class="sc5">G_Push_Pop</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Push_Pop</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_cont</span><span class="sc0">

</span><span class="sc5">G_Modrm</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_cont</span><span class="sc0">

</span><span class="sc1">; immediate</span><span class="sc0">
</span><span class="sc5">G_Imm</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Imm</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_cont</span><span class="sc0">
</span><span class="sc1">; call to junk proc </span><span class="sc0">
</span><span class="sc5">G_Call</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Sub_Call</span><span class="sc0">

</span><span class="sc5">Garble_cont</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">GarbleEnd</span><span class="sc0">
                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                     
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble</span><span class="sc0">  
</span><span class="sc5">GarbleEnd</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Create Opaque predicate </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Garble_Predicate</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Garble_Predict_End</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">Garble_Predict_End</span><span class="sc0"> </span><span class="sc1">; just temporal solution to short-near problem </span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Is_In_Pred</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Predict_End</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Predict_Jcc</span><span class="sc0">
                    
</span><span class="sc1">; JMP                                   </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                    
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_Predict_C</span><span class="sc0"> 
</span><span class="sc5">Garble_Predict_Jcc</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Cmp</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                
</span><span class="sc5">Garble_Predict_C</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Pred</span><span class="sc0">

                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble</span><span class="sc0"> </span><span class="sc1">; recursive call</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Pred</span><span class="sc0">
                
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    
    
</span><span class="sc5">Garble_Predict_End</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Create push/pop</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Garble_Push_Pop</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Garble_Push_Pop_End</span><span class="sc0">
                     
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Push</span><span class="sc0">
                    
                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble</span><span class="sc0"> </span><span class="sc1">; recursive call </span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32_no_set</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Garble_Push_Pop_c</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0004c483h</span><span class="sc0"> </span><span class="sc1">; no free reg , create add esp,4</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">
                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_Push_Pop_End</span><span class="sc0">
                    
</span><span class="sc5">Garble_Push_Pop_c</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0"> </span><span class="sc1">; pop free reg</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">               
                     
</span><span class="sc5">Garble_Push_Pop_End</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Generate Loop </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">

</span><span class="sc5">Garble_Loop</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Is_In_Loop</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Loop_End</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Garble_Loop_End</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Loop_End</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Loop</span><span class="sc0"> </span><span class="sc1">; set that we are in loop </span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_LOOP_ITERATION_MAX</span><span class="sc0"> </span><span class="sc1">; max number of loop iterations</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_LOOP_ITERATION_MIN</span><span class="sc0">   </span><span class="sc1">; minimal iterations count</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                      
                    </span><span class="sc1">; initialize loop counter register</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Mov_Reg_Imm_32</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    
                    </span><span class="sc1">; save loop start</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc1">; save counter register </span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    
                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unset_reg_32</span><span class="sc0">
                    </span><span class="sc1">; dec loop counter</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
                    </span><span class="sc1">; test counter reg </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">085h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    
                    </span><span class="sc1">; jcc loop</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Garble_Loop_Short</span><span class="sc0"> 
                    
                    </span><span class="sc1">; near jcc      </span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0850fh</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0"> 
                    
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_Loop_Cont</span><span class="sc0">
                    </span><span class="sc1">; short jcc                 </span><span class="sc0">
</span><span class="sc5">Garble_Loop_Short</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">75h</span><span class="sc0"> </span><span class="sc1">; jnz</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    
</span><span class="sc5">Garble_Loop_Cont</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Loop</span><span class="sc0"> </span><span class="sc1">; unset in-loop garbler state                  </span><span class="sc0">
                    
</span><span class="sc5">Garble_Loop_End</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Generate call to poly subroutine </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Garble_Sub_Call</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_subroutines_count</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Sub_Call_End</span><span class="sc0"> 
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Is_In_Subr</span><span class="sc0"> </span><span class="sc1">; dont make subroutine call inside subroutine </span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Sub_Call_End</span><span class="sc0">
                    
                    </span><span class="sc1">; pick random  subroutine from table</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_subroutines_count</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> 
                    
                    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_subroutines_table</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc1">; if junk mem ptr is initialized store it before subroutine call</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_pos</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Sub_No_Save1</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0"> </span><span class="sc1">; push ptr reg </span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> 
                    
</span><span class="sc5">Garble_Sub_No_Save1</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; number of arguments</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Garble_Sub_No_Arg</span><span class="sc0">
                    
                    </span><span class="sc1">; create fake argument passing </span><span class="sc0">
</span><span class="sc5">Garble_Sub_Arg</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Push</span><span class="sc0">
                    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Garble_Sub_Arg</span><span class="sc0">
                    
                    </span><span class="sc1">; create call to function</span><span class="sc0">
</span><span class="sc5">Garble_Sub_No_Arg</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0e8h</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">   
                    
                    </span><span class="sc1">; clean stack from arguments (__cdecl)</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; number of function arguments</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Garble_Sub_No_Save2</span><span class="sc0">
                    
                    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9000c483h</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">
                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> 
                    
                    </span><span class="sc1">; if junk mem ptr is initialized store it before subroutine call</span><span class="sc0">
</span><span class="sc5">Garble_Sub_No_Save2</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_pos</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Sub_Call_End</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> </span><span class="sc1">; pop ptr reg </span><span class="sc0">
                    
</span><span class="sc5">Garble_Sub_Call_End</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Generate Modrm Byte</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Garble_Create_Modrm_Byte</span><span class="sc4">:</span><span class="sc0"> 
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32_no_set</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Modrm_reg1_reg1</span><span class="sc0"> </span><span class="sc1">; no free reg</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Modrm_Reg_Reg</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Modrm_Stack_Read</span><span class="sc0">  
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Mem Access</span><span class="sc0">
</span><span class="sc5">Modrm_Mem_Acc</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; 1:2 to do direct mem32 access </span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Modrm_Mem_Direct</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_pos</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Modrm_Mem_Direct</span><span class="sc0"> </span><span class="sc1">; junk mem ptr wasnt initialized , do direct mem32 acc anyway                    </span><span class="sc0">
                    
</span><span class="sc5">Modrm_Mem_AccNoDisp</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_size</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_base</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_pos</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Modrm_Mem_Disp32</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Modrm_Mem_Disp8</span><span class="sc0">
                    
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 
                    
</span><span class="sc5">Modrm_Mem_Disp8</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                    
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc5">Modrm_Mem_Disp32</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  

                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Direct memory access (mov reg,[mem32]) </span><span class="sc0">
</span><span class="sc1">; only if poly is position independent </span><span class="sc0">
</span><span class="sc5">Modrm_Mem_Direct</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OPT_MEM_ACC_DIRECT</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Modrm_Stack_Read</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_base</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Modrm_Stack_Read</span><span class="sc0">

                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_size</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_base</span><span class="sc0">
                    
                    </span><span class="sc6">stosd</span><span class="sc0"> 
                    
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Modrm_End</span><span class="sc0">
                    
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Stack Access ( reg,[esp/ebp +- x] )                   </span><span class="sc0">
</span><span class="sc5">Modrm_Stack_Read</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Modrm_Stack_Ebp</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">24h</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">Modrm_Stack_Ebp</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_ESP_ACC_RNG_MAX</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; +/- disp</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Modrm_Stack_DispPos</span><span class="sc0">
                    
                    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">Modrm_Stack_DispPos</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> 
                     
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Modrm_End</span><span class="sc0">

</span><span class="sc5">Modrm_Reg_Reg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg_32_no_stack</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; free reg </span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Modrm_End</span><span class="sc0"> 

</span><span class="sc1">; in case when no reg is free to use                    </span><span class="sc0">
</span><span class="sc5">Modrm_reg1_reg1</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg_32</span><span class="sc0"> </span><span class="sc1">; mov eax/eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">                   
                    
</span><span class="sc5">Modrm_End</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Generate CMP/TEST</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Garble_Create_Cmp</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Cmp_Imm</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Cmp_Test</span><span class="sc0">   

</span><span class="sc5">Garble_Cmp_Cmp</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Modrm_Byte</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 
                    
</span><span class="sc5">Garble_Cmp_Test</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">84h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">                   
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Modrm_Byte</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc5">Garble_Cmp_Imm</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Modrm_Byte</span><span class="sc0">
                    
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc2">11000111b</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc2">7</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Cmp_Imm8</span><span class="sc0">
                    
                    </span><span class="sc6">stosd</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Garble_Cmp_ImmC</span><span class="sc0">
                    
</span><span class="sc5">Garble_Cmp_Imm8</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">Garble_Cmp_ImmC</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  
                    
                    </span><span class="sc6">retn</span><span class="sc0"> 

                
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Generate Push </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Garble_Create_Push</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Garble_Push_Reg32</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Push_Modrm</span><span class="sc0">
                    
</span><span class="sc5">Garble_Push_Imm</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">  

                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">

                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Push_Imm8</span><span class="sc0">  
                    </span><span class="sc1">;imm32 </span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">Garble_Push_Imm8</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">Garble_Push_Reg32</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg_32</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">Garble_Push_Modrm</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 

                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Modrm_Byte</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">11000111b</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">6</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    
                    </span><span class="sc6">retn</span><span class="sc0"> 
</span><span class="sc1">;                   </span><span class="sc0">
</span><span class="sc1">;   Generate Modrm instruction </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;00 ADD</span><span class="sc0">
</span><span class="sc1">;08 OR</span><span class="sc0">
</span><span class="sc1">;20 AND</span><span class="sc0">
</span><span class="sc1">;28 SUB</span><span class="sc0">
</span><span class="sc1">;30 XOR</span><span class="sc0">
</span><span class="sc1">;88 MOV</span><span class="sc0">
</span><span class="sc5">Garble_Create_Modrm</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; 66h prefix ?</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Modrm_No_66</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">66h</span><span class="sc0"> </span><span class="sc1">; WORD PTR </span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">Garble_Modrm_No_66</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">is_any_free_32</span><span class="sc0"> </span><span class="sc1">; do we have any free reg ?</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Garble_ModrmNo_Regs</span><span class="sc0">  
                    
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">08202828h</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">30300000h</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">88888888h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0"> 
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
                    
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                    
                    </span><span class="sc1">; create mov reg1,reg1 as no regs are free</span><span class="sc0">
</span><span class="sc5">Garble_ModrmNo_Regs</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">89h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Modrm_Byte</span><span class="sc0">
                    
                    </span><span class="sc1">; test if mem writes are allowed </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OPT_MEM_WRITES</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Garble_Modrm_Read</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Modrm_Read</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">8dh</span><span class="sc0"> </span><span class="sc1">; lea </span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Modrm_Read</span><span class="sc0">
    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0"> </span><span class="sc1">; mod reg/reg ?</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Modrm_Read</span><span class="sc0"> 

                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">100b</span><span class="sc0"> </span><span class="sc1">; sib  </span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Modrm_Read</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">101b</span><span class="sc0">
                    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Garble_Modrm_Write</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Modrm_Read</span><span class="sc0">
</span><span class="sc1">; do mem write now                    </span><span class="sc0">
</span><span class="sc5">Garble_Modrm_Write</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">2h</span><span class="sc0">
                    
</span><span class="sc5">Garble_Modrm_Read</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">     
                    </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Generate imm instruction </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Garble_Create_Imm</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32_no_set</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0"> 
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Create_Imm_E</span><span class="sc0"> 
 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Garble_Imm_Init_Ptr</span><span class="sc0">

                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Garble_Imm_Inc_Dec</span><span class="sc0">              
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">stosd</span><span class="sc0">
                    
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 
                    
</span><span class="sc1">; c1 group </span><span class="sc0">
</span><span class="sc1">; 81 83 group </span><span class="sc0">
</span><span class="sc5">Garble_Imm_Groups</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">818383c1h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                     
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Garble_Create_Modrm_Byte</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 
</span><span class="sc1">; inc/dec reg </span><span class="sc0">
</span><span class="sc5">Garble_Imm_Inc_Dec</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">                    
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Initialize pointer </span><span class="sc0">
</span><span class="sc5">Garble_Imm_Init_Ptr</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Is_In_Pred</span><span class="sc0"> </span><span class="sc1">; dont setup ptr in predicate  </span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Create_ImmE1</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Is_In_Loop</span><span class="sc0"> 
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Garble_Create_ImmE1</span><span class="sc0"> </span><span class="sc1">; dont setup ptr in loop </span><span class="sc0">

                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_base</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Create_ImmE1</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_size</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Garble_Create_ImmE1</span><span class="sc0">
                    
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_base</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_pos</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Garble_Imm_No_Unset</span><span class="sc0"> </span><span class="sc1">; reg wasnt set , no need to unset </span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_reg</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unset_reg_32</span><span class="sc0"> </span><span class="sc1">; release old ptr register</span><span class="sc0">
                    
</span><span class="sc5">Garble_Imm_No_Unset</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_reg</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_pos</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OPT_MEM_ACC_DIRECT</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Grable_Imm_indir</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Mov_Reg_Imm_32</span><span class="sc0"> </span><span class="sc1">; FIX HERE call Asm_Init_Ptr</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
</span><span class="sc5">Grable_Imm_indir</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Init_Ptr</span><span class="sc0">
                    
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_reg_32</span><span class="sc0"> 
                    
</span><span class="sc5">Garble_Create_ImmE1</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
</span><span class="sc5">Garble_Create_Imm_E</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Create Junk Function </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Garble_Create_funct</span><span class="sc4">:</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_subroutines_count</span><span class="sc0">
                    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0"> 
                    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_subroutines_table</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; store subroutine entry to table</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_SUBR_PARAMS_MAX</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; number of sub params</span><span class="sc0">
                    
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_subroutines_count</span><span class="sc0"> 

                    </span><span class="sc1">; init stack frame </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">55h</span><span class="sc0">          </span><span class="sc1">; push ebp </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0ec8bh</span><span class="sc0">   </span><span class="sc1">; mov ebp,esp</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_garbage_level</span><span class="sc0"> 
                    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Subr</span><span class="sc0"> </span><span class="sc1">; set in subroutine flag </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_reg_usage</span><span class="sc0">  </span><span class="sc1">; store reg usage </span><span class="sc0">
                    
</span><span class="sc5">Create_Funct_Loop</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Create_Funct_Loop</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Subr</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_reg_usage</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; restore reg usage </span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">5dh</span><span class="sc0">          </span><span class="sc1">; pop ebp</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0c3h</span><span class="sc0">     </span><span class="sc1">; retn </span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> 
                    
</span><span class="sc9">ifdef</span><span class="sc0"> </span><span class="sc5">POLY_ALIGN_SUBR</span><span class="sc0">                   
                    </span><span class="sc1">; now do the compiler-like 16 align </span><span class="sc0">
                    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">POLY_ALIGN_BYTE</span><span class="sc0">
                    
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Create_align_End</span><span class="sc0">
                    
                    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                   
                     
</span><span class="sc9">endif</span><span class="sc0"> </span><span class="sc1">; POLY_ALIGN_SUBR ;                   </span><span class="sc0">
                    
</span><span class="sc5">Create_align_End</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_reg</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; clear initialized junk mem ptr </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_junk_mem_pos</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  
                    </span><span class="sc6">retn</span><span class="sc0"> 
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Standalone Garbage Creator </span><span class="sc0">
</span><span class="sc1">;                   </span><span class="sc0">
</span><span class="sc1">;  for external use</span><span class="sc0">
</span><span class="sc1">;  eax = ptr poly_vars</span><span class="sc0">
</span><span class="sc1">;  ecx = amount of garbage</span><span class="sc0">
</span><span class="sc5">PolyCreateGarbage</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">pushad</span><span class="sc0">

                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyInit</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarbleInit</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">@end</span><span class="sc0"> 
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0"> </span><span class="sc1">; Internal poly garbler                     </span><span class="sc0">
                    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">
                    
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_size</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;save size to eax  </span><span class="sc0">
</span><span class="sc5">@end</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">popad</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">                    

</span><span class="sc1">;                   </span><span class="sc0">
</span><span class="sc1">; Poly initialization routine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ebp = ptr poly_vars                   </span><span class="sc0">
</span><span class="sc5">PolyInit</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pushad</span><span class="sc0">
                    
                    </span><span class="sc1">; fill poly state memory with zeroes </span><span class="sc0">
                    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
                    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo1</span><span class="sc0">
                    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
                    
                    </span><span class="sc1">; set esp,ebp as used regs </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_reg_32</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_reg_32</span><span class="sc0"> 
                    
                    </span><span class="sc1">; init random  seed </span><span class="sc0">
                    </span><span class="sc6">rdtsc</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_random_seed</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                    </span><span class="sc6">popad</span><span class="sc0"> 
                    </span><span class="sc6">retn</span><span class="sc0">                
                
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   PolyEngine</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   *Create linear decryptor with slide key </span><span class="sc0">
</span><span class="sc1">;                   </span><span class="sc0">

</span><span class="sc1">; _in   eax = ptr to poly struct</span><span class="sc0">
</span><span class="sc1">; _out  eax = size of decryptor </span><span class="sc0">
</span><span class="sc5">PolyEngine</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">pushad</span><span class="sc0">

                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">:</span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">poly_vars</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyInit</span><span class="sc0"> 
                    
                    </span><span class="sc1">; choose operations which will be used (xor,add,sub)</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo1</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; crypt algo </span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; add/sub only</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo2</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; slide algo </span><span class="sc0">
                    
                    </span><span class="sc1">; choose registers</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_reg</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key_reg</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">generate_key_32</span><span class="sc0">  
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_slide_key</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc1">; apply encryption to data</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">generate_key_32</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt_data</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc1">; start generating decryptor code </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc0">
                    
                    </span><span class="sc1">; intialize poly garbler</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarbleInit</span><span class="sc0">
                    
                    </span><span class="sc1">; save poly entry </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_entry_offset</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc1">; CREATE STACK FRAME FOR DECRYPTOR</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">55h</span><span class="sc0">          </span><span class="sc1">; push ebp </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0ec8bh</span><span class="sc0">   </span><span class="sc1">; mov ebp,esp</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                                        
                    </span><span class="sc1">; GARBLE</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc1">;</span><span class="sc0">
                    </span><span class="sc1">; ASSEMBLE MOVE DATA LOOP </span><span class="sc0">
                    </span><span class="sc1">;</span><span class="sc0">
                    </span><span class="sc1">;  this loop is used when data are decrypted </span><span class="sc0">
                    </span><span class="sc1">;  to different location in memory than their initial position is</span><span class="sc0">
                    </span><span class="sc1">;  to activate this behaviour , set poly_vars.poly_ptr_decrypt_buf_va  </span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Move_Data_Loop</span><span class="sc0">
                     
                    </span><span class="sc1">;</span><span class="sc0">
                    </span><span class="sc1">; INIT VALUES FOR DECRYPTOR</span><span class="sc0">
                    </span><span class="sc1">;</span><span class="sc0">
                    
                    </span><span class="sc1">; init decrypt key in reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key_reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Mov_Reg_Imm_32</span><span class="sc0">
                    
                    </span><span class="sc1">; GARBLE</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc1">; init decrypt buffer ptr</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_decrypt_buf_va</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_code_base_va</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_reg</span><span class="sc0"> 
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_code_size</span><span class="sc0">
                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Init_Ptr</span><span class="sc0">
                    
                    
                    </span><span class="sc1">; GARBLE</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc1">; init loop counter </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_code_size</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Mov_Reg_Imm_32</span><span class="sc0">
                    
                    </span><span class="sc1">; GARBLE</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Loop</span><span class="sc0"> </span><span class="sc1">; set in-loop garbler state </span><span class="sc0">
                    
                    </span><span class="sc1">; GENERATE POLY DECRYPTION LOOP</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">; loop_base</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0"> 
                     
                    </span><span class="sc1">; OPERATION (xor/add/sub [ptr_reg],key_reg )</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">290131h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo1</span><span class="sc0">
                    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                 
                    </span><span class="sc1">; (key_reg &lt;&lt; 3) + ptr_reg;</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key_reg</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    
                    </span><span class="sc1">; GARBLE</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc1">; KEY SLIDE (xor/add/sub key_reg,slide_key)</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">081h</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">050006h</span><span class="sc0"> </span><span class="sc1">; ( xor/add/sub )</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo2</span><span class="sc0">
                    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
            
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_slide_key</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                    
                    </span><span class="sc1">; GARBLE</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc1">; dec ptr </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_reg</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
                    </span><span class="sc1">; GARBLE</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc1">; ASSEMBLE LOOP</span><span class="sc0">
                     
                    </span><span class="sc1">; dec counter reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc1">;   Decrypt Loop </span><span class="sc0">
    </span><span class="sc1">;               </span><span class="sc0">
                    </span><span class="sc1">; test counter reg </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">085h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    
                    </span><span class="sc1">; jcc loop</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; esi = loop start </span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Poly_Loop_Short</span><span class="sc0"> 
    </span><span class="sc1">; near jcc      </span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0850fh</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0"> 
                    
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Poly_Loop_Cont</span><span class="sc0">
    </span><span class="sc1">; short jcc                 </span><span class="sc0">
</span><span class="sc5">Poly_Loop_Short</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">75h</span><span class="sc0"> </span><span class="sc1">; jnz</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    
</span><span class="sc5">Poly_Loop_Cont</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Loop</span><span class="sc0"> </span><span class="sc1">; unset in-loop garbler state </span><span class="sc0">
                    
                    </span><span class="sc1">; free regs used in decrypt loop</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key_reg</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unset_reg_32</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_reg</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unset_reg_32</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unset_reg_32</span><span class="sc0">
                    
                    </span><span class="sc1">; GARBLE</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">

</span><span class="sc9">ifndef</span><span class="sc0"> </span><span class="sc5">POLY_DEBUG</span><span class="sc0">                   
                    </span><span class="sc1">; GENERATE JUMP TO NEXT LAYER </span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Jmp_Next_Layer</span><span class="sc0">

</span><span class="sc9">else</span><span class="sc0">                
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c35dh</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0"> </span><span class="sc1">; POLY_DEBUG                  </span><span class="sc0">
                    
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">popad</span><span class="sc0"> 
                    </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Assemble Mov Reg,Imm32 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; in:</span><span class="sc0">
</span><span class="sc1">;   ebx = reg</span><span class="sc0">
</span><span class="sc1">;   ecx = value </span><span class="sc0">
</span><span class="sc1">;   edi = buffer</span><span class="sc0">
</span><span class="sc5">Asm_Mov_Reg_Imm_32</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mov_lea</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mov_push_pop</span><span class="sc0">   

                    </span><span class="sc1">; mov reg imm32 </span><span class="sc0">
</span><span class="sc5">mov_reg_imm32</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0b8h</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc5">mov_push_pop</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">                                           
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc5">mov_lea</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">058dh</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">                    
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Create Poly Delta Routine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; eax = register</span><span class="sc0">
</span><span class="sc1">; edi = buffer</span><span class="sc0">
 
</span><span class="sc5">Asm_Poly_Delta</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0e8h</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Pred</span><span class="sc0"> </span><span class="sc1">; avoid ptr init in delta call </span><span class="sc0">
                     
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Pred</span><span class="sc0"> 
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; not 4   </span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">  
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0"> 
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; ebx = call delta + 5 </span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base_va</span><span class="sc0">
                    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">
                    
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Initialize Pointer Register </span><span class="sc0">
</span><span class="sc1">;                   </span><span class="sc0">

</span><span class="sc1">;ebx = reg </span><span class="sc0">
</span><span class="sc1">;ecx = value </span><span class="sc0">
</span><span class="sc1">;edi = buffer </span><span class="sc0">

</span><span class="sc5">Asm_Init_Ptr</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OPT_POS_INDEPENDENT</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Asm_Init_No_Delta</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;                   push edx</span><span class="sc0">
</span><span class="sc1">;                   mov edx,dword ptr [ebp].poly_decryptor_base_va</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Poly_Delta</span><span class="sc0"> 
</span><span class="sc1">;                   pop edx </span><span class="sc0">
                    
                    </span><span class="sc1">; add reg val</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0">
                    
                    </span><span class="sc6">retn</span><span class="sc0">  
        
</span><span class="sc5">Asm_Init_No_Delta</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Mov_Reg_Imm_32</span><span class="sc0">             
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;edi = buffer                   </span><span class="sc0">
</span><span class="sc5">Asm_Jmp_Next_Layer</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                    
                    </span><span class="sc1">; if poly_decryptor_base_va isnt set </span><span class="sc0">
                    </span><span class="sc1">; make the transfer instruction relative (call/jmp... rel32)</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_decrypt_buf_va</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Asm_Relative</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32</span><span class="sc0">    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_decrypt_buf_va</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_code_base_va</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_code_entry_offset</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_OPT_POS_INDEPENDENT</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Asm_Jmp_Layer_Delta</span><span class="sc0"> 
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Mov_Reg_Imm_32</span><span class="sc0">
                    
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Asm_Jmp_C</span><span class="sc0">
                    
</span><span class="sc5">Asm_Jmp_Layer_Delta</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;                   mov edx,dword ptr [ebp].poly_ptr_code_base_va</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Poly_Delta</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> 
                    </span><span class="sc6">stosd</span><span class="sc0"> 
                    
</span><span class="sc5">Asm_Jmp_C</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0"> 
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
                    </span><span class="sc6">retn</span><span class="sc0">

                    </span><span class="sc1">; call rel32                    </span><span class="sc0">
</span><span class="sc5">Asm_Relative</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_code_base_raw</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_code_entry_offset</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">stosd</span><span class="sc0"> 
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">
                     
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Assemble Move Data Loop </span><span class="sc0">
</span><span class="sc1">;                   </span><span class="sc0">
</span><span class="sc5">Asm_Move_Data_Loop</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pushad</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_decrypt_buf_va</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Asm_Move_Data_End</span><span class="sc0">
                    
                    </span><span class="sc1">; init store reg</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Asm_Move_Data_End</span><span class="sc0"> </span><span class="sc1">; we got problem here</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_store_reg</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc1">; init src ptr</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_code_base_va</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Init_Ptr</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                    
                    </span><span class="sc1">; init dest ptr</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key_reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_decrypt_buf_va</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Init_Ptr</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0"> 
                    
                    </span><span class="sc1">; init counter </span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_code_size</span><span class="sc0">
                    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> 
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Asm_Mov_Reg_Imm_32</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Loop</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; loop start</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">  
                    
                    </span><span class="sc1">; mov store_reg/[scr]</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_store_reg</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_reg</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8bh</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0">
                    
                    </span><span class="sc1">; mov [dest]/store_reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_store_reg</span><span class="sc0"> 
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key_reg</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0"> 
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">  
                    
                    </span><span class="sc1">; inc store_reg</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0">
                     
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_key_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0"> 
                    
                    </span><span class="sc1">; dec loop_counter</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                    </span><span class="sc6">stosb</span><span class="sc0"> 
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyGarble</span><span class="sc0"> 
                    
                    </span><span class="sc1">; test loop_counter/loop_counter</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_loop_reg</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">085h</span><span class="sc0">
                    </span><span class="sc6">stosw</span><span class="sc0"> 
                    
                    </span><span class="sc1">; jcc loop</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Move_Loop_Short</span><span class="sc0"> 
                    
                    </span><span class="sc1">; near jcc      </span><span class="sc0">
                    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">           
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0850fh</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0"> 
                    
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                    
                    </span><span class="sc1">; short jcc                 </span><span class="sc0">
</span><span class="sc5">Move_Loop_Short</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">75h</span><span class="sc0"> </span><span class="sc1">; jnz</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">                 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Set_In_Loop</span><span class="sc0"> </span><span class="sc1">; unset loop state flag  </span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_store_reg</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unset_reg_32</span><span class="sc0"> </span><span class="sc1">; free store reg </span><span class="sc0">
                    
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; store edi</span><span class="sc0">
                    
</span><span class="sc1">;                   mov eax,dword ptr [ebp].poly_ptr_decrypt_buf_va</span><span class="sc0">
</span><span class="sc1">;                   mov dword ptr [ebp].poly_ptr_code_base_va,eax  </span><span class="sc0">
</span><span class="sc5">Asm_Move_Data_End</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">popad</span><span class="sc0"> 
                    </span><span class="sc6">retn</span><span class="sc0">                    
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Auxiliary routines</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">

</span><span class="sc5">generate_key_32</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    
</span><span class="sc5">generate_key_loop</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> 
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; to avoid permutation errors</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">generate_key_loop</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Test Flag </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; eax &gt; 0 =&gt; we are in loop already</span><span class="sc0">
</span><span class="sc5">Is_In_Loop</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_FLAG_IN_LOOP</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Test_Flag</span><span class="sc0"> 
                     
</span><span class="sc5">Set_In_Loop</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_FLAG_IN_LOOP</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Set_Flag</span><span class="sc0">
                    
</span><span class="sc5">Is_In_Subr</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_FLAG_IN_SUBR</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Test_Flag</span><span class="sc0"> 
                    
</span><span class="sc5">Set_In_Subr</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_FLAG_IN_SUBR</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Set_Flag</span><span class="sc0">
                
</span><span class="sc5">Is_In_Pred</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_FLAG_IN_PRED</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Test_Flag</span><span class="sc0"> 

</span><span class="sc5">Set_In_Pred</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">POLY_FLAG_IN_PRED</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Set_Flag</span><span class="sc0">            
                    
</span><span class="sc5">Test_Flag</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_garbler_flags</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">Set_Flag</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_garbler_flags</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Registers handling functions </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; eax = reg</span><span class="sc0">
</span><span class="sc5">convert_32</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">set_reg_32</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">convert_32</span><span class="sc0">
                    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_reg_usage</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc5">unset_reg_32</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">convert_32</span><span class="sc0">
                    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_reg_usage</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; if eax != 0 , reg is used already                 </span><span class="sc0">
</span><span class="sc5">is_used_32</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">convert_32</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_reg_usage</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; if eax after ret is zero , no regs are avaiable                   </span><span class="sc0">
</span><span class="sc5">is_any_free_32</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_reg_usage</span><span class="sc0">
                    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">get_reg_32</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc5">get_reg_32_no_stack</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_reg_32_add</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_reg_32_add</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">get_reg_32_add</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; return unused reg32 or -1 if no regs are avaiable</span><span class="sc0">
</span><span class="sc5">get_free_reg_32</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">is_any_free_32</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_reg_avaiable_32</span><span class="sc0">
                    
</span><span class="sc5">get_another_reg_32</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg_32</span><span class="sc0">
                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">is_used_32</span><span class="sc0">
                    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">get_another_reg_32</span><span class="sc0">
                    
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_reg_32</span><span class="sc0"> </span><span class="sc1">; set reg as used </span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 

</span><span class="sc5">no_reg_avaiable_32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">get_free_reg_32_no_set</span><span class="sc4">:</span><span class="sc0">
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_free_reg_32</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_free_reg_32_no_set_exit</span><span class="sc0"> 
                    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unset_reg_32</span><span class="sc0">
</span><span class="sc5">get_free_reg_32_no_set_exit</span><span class="sc4">:</span><span class="sc0">                    
                    </span><span class="sc6">retn</span><span class="sc0">                    


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Crypt Data</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; add/sub must occur in reversed order according to decryption order</span><span class="sc0">
</span><span class="sc1">; eax = key</span><span class="sc0">
</span><span class="sc5">crypt_data</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">pushad</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_ptr_code_base_raw</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_code_size</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_slide_key</span><span class="sc0">
                    
</span><span class="sc5">crypt_loop</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">crypt_algo1</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">crypt_algo2</span><span class="sc0">

                    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">crypt_algo_c</span><span class="sc0">
                    
</span><span class="sc5">crypt_algo1</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> 
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">crypt_algo_c</span><span class="sc0">
                    
</span><span class="sc5">crypt_algo2</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
 
                    </span><span class="sc1">; now apply slide key </span><span class="sc0">
</span><span class="sc5">crypt_algo_c</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; save eax</span><span class="sc0">
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">crypt_slide1</span><span class="sc0">
                    
                    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_algo2</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">crypt_slide2</span><span class="sc0">     
                    
                    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">crypt_slide_c</span><span class="sc0">
                    
</span><span class="sc5">crypt_slide1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">crypt_slide_c</span><span class="sc0">
                    
</span><span class="sc5">crypt_slide2</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">crypt_slide_c</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">crypt_loop</span><span class="sc0">

</span><span class="sc1">;                   mov dword ptr [esp+1Ch],eax ; save eax </span><span class="sc0">
                    </span><span class="sc6">popad</span><span class="sc0"> 
                    </span><span class="sc6">retn</span><span class="sc0">
                    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   random Routine </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; Entry: EAX == Max_Val.</span><span class="sc0">
</span><span class="sc1">; Return: EAX == random  number between 0..Max_Val-1.</span><span class="sc0">
</span><span class="sc1">; routine by T-2000</span><span class="sc0">
        
</span><span class="sc5">random</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                    </span><span class="sc6">rdtsc</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_random_seed</span><span class="sc0"> </span><span class="sc1">; random  seed </span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

                    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">666h</span><span class="sc0">
                    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.poly_random_seed</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; random  seed </span><span class="sc0">

                    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">CRC_Bit_1</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">Loop_CRC_Bit_1</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0EDB88320h</span><span class="sc0">

</span><span class="sc5">Loop_CRC_Bit_1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CRC_Bit_1</span><span class="sc0">                
                        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    </span><span class="sc6">retn</span><span class="sc0"> 


                    </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0"> 
</span></div></body>
</html>
