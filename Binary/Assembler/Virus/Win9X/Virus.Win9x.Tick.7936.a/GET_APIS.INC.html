<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>GET_APIS.INC</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€</span><span class="sc0">
</span><span class="sc1">;€ Locate Kernel32 base address                       €</span><span class="sc0">
</span><span class="sc1">;€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EAX = dword on stack at startup</span><span class="sc0">
</span><span class="sc1">;     EDX = pointer to kernel32 name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: EAX = base address of kernel32 if success</span><span class="sc0">
</span><span class="sc1">;     EAX = 0, CF set if fail</span><span class="sc0">

</span><span class="sc5">LocateKernel32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">; save all registers</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@800</span><span class="sc0">                   </span><span class="sc1">; ...I don't know why I</span><span class="sc0">
</span><span class="sc5">@800</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; had to do this this way,</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">delta3</span><span class="sc4">-</span><span class="sc5">@800</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; but it wouldn't work</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">; otherwise...</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">try_method_2_error</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; first set up a seh</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; frame so that if our</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; first method crashes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                 </span><span class="sc1">; we will find ourselves</span><span class="sc0">
                           </span><span class="sc1">; in the second method</span><span class="sc0">
</span><span class="sc5">locateloop</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0b4h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; first method looks for</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_k32_kill_seh</span><span class="sc0">               </span><span class="sc1">; the k32 by checking for</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; the equal dword at 0b4</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">try_method_2</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locateloop</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_k32_kill_seh</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; if we found it, then we</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; must destroy the temp</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; seh frame</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@900</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; save k32 base</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">found_k32</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">try_method_2_error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; if the first method gave</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; and exception error we</span><span class="sc0">
</span><span class="sc5">delta3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">             </span><span class="sc1">; restore the stack and</span><span class="sc0">
                           </span><span class="sc1">; the delta handle</span><span class="sc0">
</span><span class="sc5">try_method_2</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; restore the seh state</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">; restore registers and</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">; save them again</span><span class="sc0">
                           </span><span class="sc1">; and go on w/ method two</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; now put imagebase in ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">            </span><span class="sc1">; check if it is an EXE</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get pointer to PE</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                  </span><span class="sc1">; too far away?</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">            </span><span class="sc1">; is it a PE?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">         </span><span class="sc1">; skip header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; and get import RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Import.DD_Size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; and import size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; save RVA</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">locateloop2</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_Name</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get the name</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'NREK'</span><span class="sc0">         </span><span class="sc1">; and compare to KERN</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_the_kernel_import</span><span class="sc0">          </span><span class="sc1">; if it is not that one</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR_SIZE</span><span class="sc0">       </span><span class="sc1">; skip to the next desc.</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; but not beyond the size</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                </span><span class="sc1">; of the descriptor</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locateloop2</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_the_kernel_import</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; if we found the kernel</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; import descriptor</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; take the pointer to</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; addresses</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_Characteristics</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; and the pointer to</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; names</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gha_locate_loop</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; save pointer to names</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.TD_AddressOfData</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; go to the actual thunk</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; and skip the hint</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; save these</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">getmodulehandle</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; and point the name of</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">getmodulehandlelen</span><span class="sc0">         </span><span class="sc1">; GetModuleHandleA</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                   </span><span class="sc1">; see if it is that one</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_getmodulehandle</span><span class="sc0">            </span><span class="sc1">; if so...</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; otherwise restore</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; restore arrays indexes</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; and skip to next</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; 0? -&gt; end of import</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gha_locate_loop</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_getmodulehandle</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; restore stack</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; push kernel32 name</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; esi = GetModuleHandleA</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; address...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@900</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; hold k32 base!!</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_k32</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">; restore all regs and</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@900</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; put k32 in EAX</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">; and mark success</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notfound_k32</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">; restore all regs</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; and mark the failure...</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateKernel32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@900</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€</span><span class="sc0">
</span><span class="sc1">;€ Locate GetProcAddress                          €</span><span class="sc0">
</span><span class="sc1">;€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EAX = base of kernel32</span><span class="sc0">
</span><span class="sc1">;     EDX = pointer to GetProcAddress name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: EAX = address of GetProcAddress if success</span><span class="sc0">
</span><span class="sc1">;     EAX = 0, CF set if fail</span><span class="sc0">

</span><span class="sc5">LocateGetProcAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; save the kernel base</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">            </span><span class="sc1">; is it an exe?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">            </span><span class="sc1">; is it a PE?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">         </span><span class="sc1">; skip file header</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.OH_DataDirectory.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; and get export RVA</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; save number of names</span><span class="sc0">
                           </span><span class="sc1">; to look into</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; get address of names</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; align to base rva</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; save pointer to export</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gpa_locate_loop</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; get one name address</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; and align it</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; save counter and addr.</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; compare to GetProcAddress</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">getprocaddresslen</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">foundgpa</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; restore them</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; and get next name</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">gpa_locate_loop</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notfoundgpa</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; we didn't find it...</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; mark failure</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">foundgpa</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; ecx = how many did we</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; check from total, but</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; we need the reminder</span><span class="sc0">
       </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; of the search</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc1">; get address of ordinals</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; and look using the index</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; take the ordinal</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc1">; take address of funcs.</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; we look in a dword array</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; go to the function addr</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; take it's address</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; and align it to k32 base</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@901</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; save it</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">; restore all regs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@901</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; and mark success</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateGetProcAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@901</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€</span><span class="sc0">
</span><span class="sc1">;€ General module handle retriving routine                €</span><span class="sc0">
</span><span class="sc1">;€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EDI = pointer to module name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: EAX = module base address if success</span><span class="sc0">
</span><span class="sc1">;     EAX = 0, CF set if fail</span><span class="sc0">

</span><span class="sc5">LocateModuleBase</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">; save regs</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; push name</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetModuleHandleA</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; call GetModuleHandleA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@902</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@902</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">notfoundmodule</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">; success</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notfoundmodule</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">; fail</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateModuleBase</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@902</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;€ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€</span><span class="sc0">
</span><span class="sc1">;€ General API address retriving routine                  €</span><span class="sc0">
</span><span class="sc1">;€‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹€</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EAX = base address of the module</span><span class="sc0">
</span><span class="sc1">;     EBX = address of GetProcAddress</span><span class="sc0">
</span><span class="sc1">;     EDI = pointer to api names list (each item null terminated,</span><span class="sc0">
</span><span class="sc1">;                      list terminated with 0FFh)</span><span class="sc0">
</span><span class="sc1">;     ESI = pointer to api addresses list</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: CF clear if success and list at ESI filled with API addresses</span><span class="sc0">
</span><span class="sc1">;     CF set if fail</span><span class="sc0">

</span><span class="sc5">LocateApiAddresses</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">; save all regs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; save module base</span><span class="sc0">
</span><span class="sc5">locate_apis_loop</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">            </span><span class="sc1">; is it the end?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ready_apis</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; save base</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                    </span><span class="sc1">; push api name</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; push module base</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; call GetProcAddress</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; restore module base</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; error?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">error_finding_apis</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; save api address</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                   </span><span class="sc1">; look for the next</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; api name</span><span class="sc0">
       </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; increment array</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locate_apis_loop</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ready_apis</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">; all ok!</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">error_finding_apis</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">; error here...</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateApiAddresses</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span></div></body>
</html>
